<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Feed</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary: #0080FF;
    --primary-dark: #0066CC;
    --error: #EF4444;
    --success: #10B981;
    --warning: #F59E0B;
    --bg-color: #f0f2f5;
    --card-bg: #fff;
    --text-color: #111;
    --secondary-text: #65676b;
    --border-color: #dddfe2;
    --online: #10B981;
    --offline: #EF4444;
  }

  body.dark-mode {
    --bg-color: #18191a;
    --card-bg: #242526;
    --text-color: #e4e6eb;
    --secondary-text: #b0b3b8;
    --border-color: #3e4042;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }

  html, body {
    height: 100%;
    overflow-x: hidden;
    font-size: 18px;
  }

  body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #e0f7ff 0%, #b3e0ff 100%);
    color: var(--text-color);
    transition: all 0.3s ease;
    min-height: 100vh;
    -webkit-overflow-scrolling: touch;
  }

  .app-container {
    display: flex;
    min-height: 100vh;
    position: relative;
  }

  .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    height: 100vh;
    width: 280px;
    background: linear-gradient(180deg, #0080FF 0%, #00C6FF 100%);
    border-right: 1px solid var(--border-color);
    overflow-y: auto;
    z-index: 100;
    padding: 20px;
    transition: all 0.3s ease;
    color: white;
    -webkit-overflow-scrolling: touch;
  }

  .sidebar-header {
    padding: 10px 0 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    margin-bottom: 20px;
  }

  .sidebar-menu {
    list-style: none;
  }

  .sidebar-menu li {
    margin-bottom: 8px;
  }

  .sidebar-menu a {
    display: flex;
    align-items: center;
    padding: 12px;
    text-decoration: none;
    color: white;
    border-radius: 8px;
    transition: background 0.3s;
    min-height: 44px;
    font-size: 18px;
  }

  .sidebar-menu a:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .sidebar-menu i {
    margin-right: 12px;
    font-size: 18px;
  }

  .main-content {
    flex: 1;
    margin-left: 280px;
    padding: 20px;
    min-height: 100vh;
    font-size: 18px;
  }

  .navbar {
    background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);
    padding: 15px 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    color: white;
    flex-wrap: wrap;
    gap: 10px;
  }

  .nav-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  .search-bar {
    display: flex;
    align-items: center;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    padding: 8px 15px;
    margin-right: 15px;
  }

  .search-bar input {
    background: transparent;
    border: none;
    color: white;
    outline: none;
    width: 200px;
    font-size: 18px;
  }

  .search-bar input::placeholder {
    color: rgba(255, 255, 255, 0.7);
  }

  .user-profile-nav {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 5px 10px;
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.2);
    cursor: pointer;
    position: relative;
    min-height: 44px;
  }

  .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    cursor: pointer;
    position: relative;
    min-width: 40px;
    font-size: 18px;
    overflow: hidden;
  }

  .user-avatar.small {
    width: 30px;
    height: 30px;
    font-size: 16px;
    min-width: 30px;
  }

  .user-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
  }

  .user-avatar.small img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
  }

  .status-indicator {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid white;
  }

  .status-online {
    background-color: var(--online);
  }

  .status-offline {
    background-color: var(--offline);
  }

  .user-profile-nav span {
    font-size: 16px;
    font-weight: 600;
  }

  .btn {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 18px;
    min-height: 44px;
    position: relative;
  }

  .btn:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  .btn-primary {
    background: var(--primary);
  }

  .btn-secondary {
    background: var(--secondary-text);
  }

  .btn-success {
    background: var(--success);
  }

  .btn-warning {
    background: var(--warning);
  }

  .follow-btn {
    padding: 6px 12px;
    font-size: 14px;
    border-radius: 6px;
    min-height: 36px;
  }

  .unread-badge {
    background: var(--error);
    color: white;
    border-radius: 50%;
    padding: 2px 6px;
    font-size: 12px;
    display: none;
    min-width: 18px;
    justify-content: center;
    align-items: center;
  }

  /* Post Composer */
  .post-composer {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .composer-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
  }

  .composer-input {
    flex: 1;
    background: var(--bg-color);
    border: none;
    padding: 12px 16px;
    border-radius: 25px;
    color: var(--text-color);
    font-size: 18px;
    cursor: pointer;
    min-height: 44px;
  }

  .composer-divider {
    height: 1px;
    background: var(--border-color);
    margin: 16px 0;
  }

  .composer-actions {
    display: flex;
    justify-content: space-between;
  }

  .action-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s;
    color: var(--secondary-text);
    min-height: 44px;
    font-size: 16px;
  }

  .action-btn:hover {
    background: var(--bg-color);
  }

  /* AI Features */
  .meetai-button {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #00C6FF 0%, #80b3ff 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 99;
    transition: all 0.3s ease;
    min-width: 60px;
    min-height: 60px;
  }

  .meetai-button:hover {
    transform: scale(1.1);
    background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);
  }

  .meetai-assistant {
    position: fixed;
    bottom: 90px;
    right: 20px;
    width: 300px;
    background: var(--card-bg);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    z-index: 98;
    display: none;
    flex-direction: column;
    max-height: 400px;
  }

  .meetai-header {
    padding: 12px 16px;
    background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);
    color: white;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .meetai-messages {
    flex: 1;
    padding: 12px;
    overflow-y: auto;
    max-height: 300px;
  }

  .meetai-message {
    margin-bottom: 8px;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 14px;
  }

  .meetai-user {
    background: var(--primary);
    color: white;
    margin-left: 20px;
  }

  .meetai-bot {
    background: var(--bg-color);
    margin-right: 20px;
  }

  .meetai-input {
    display: flex;
    padding: 12px;
    gap: 8px;
  }

  .meetai-input input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 20px;
    background: var(--bg-color);
    color: var(--text-color);
  }

  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .modal-content {
    background: var(--card-bg);
    border-radius: 12px;
    width: 500px;
    max-width: 90%;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-header {
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-body {
    padding: 16px;
  }

  .close-modal {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--secondary-text);
    min-width: 44px;
    min-height: 44px;
  }

  .notification-item {
    padding: 12px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background 0.3s;
  }

  .notification-item:hover {
    background: var(--bg-color);
  }

  .notification-item.unread {
    background: rgba(var(--primary), 0.1);
  }

  .error-message {
    color: var(--error);
    text-align: center;
    padding: 10px;
    border: 1px solid var(--error);
    background: rgba(var(--error), 0.1);
    border-radius: 8px;
    margin-bottom: 10px;
  }

  /* Post Styles */
  .post {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .post-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
  }

  .post-user-info {
    flex: 1;
  }

  .post-user-info a {
    text-decoration: none;
    color: var(--text-color);
    font-weight: 600;
    font-size: 18px;
    cursor: pointer;
  }

  .post-user-info a:hover {
    text-decoration: underline;
  }

  .post-timestamp {
    font-size: 14px;
    color: var(--secondary-text);
  }

  .post-content {
    margin-bottom: 12px;
    line-height: 1.5;
  }

  .post-media {
    margin-bottom: 12px;
    max-height: 400px;
    overflow: hidden;
    border-radius: 8px;
  }

  .post-media img {
    width: 100%;
    height: auto;
    display: block;
    object-fit: cover;
  }

  .post-stats {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 10px;
    font-size: 14px;
    color: var(--secondary-text);
  }

  .post-interactions {
    display: flex;
    justify-content: space-around;
    padding-top: 5px;
  }

  .interaction-btn {
    background: none;
    border: none;
    color: var(--secondary-text);
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s, color 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px;
  }

  .interaction-btn:hover {
    background: var(--bg-color);
  }

  .interaction-btn.active {
    color: var(--primary);
  }

  .interaction-btn.active:hover {
    background: rgba(var(--primary), 0.1);
  }

  /* Comments Section */
  .comments-section {
    margin-top: 10px;
  }

  .comment {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
  }

  .comment-content {
    background: var(--bg-color);
    border-radius: 18px;
    padding: 8px 12px;
    flex: 1;
    font-size: 16px;
  }

  .comment-header {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 2px;
  }

  .comment-header a {
    text-decoration: none;
    color: var(--text-color);
    cursor: pointer;
  }

  .comment-header a:hover {
    text-decoration: underline;
  }

  .comment-text {
    word-wrap: break-word;
  }

  .comment-input {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid var(--border-color);
  }

  .comment-input input {
    flex: 1;
    padding: 8px 15px;
    border: 1px solid var(--border-color);
    border-radius: 20px;
    font-size: 16px;
    background: var(--bg-color);
    color: var(--text-color);
  }

  .comment-input button {
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 20px;
    padding: 8px 15px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s;
  }

  .comment-input button:hover {
    background: var(--primary-dark);
  }

  /* Responsive Design */
  @media (max-width: 1024px) {
    .sidebar {
      width: 200px;
    }

    .main-content {
      margin-left: 200px;
    }
  }

  @media (max-width: 768px) {
    .sidebar {
      display: none;
    }

    .main-content {
      margin-left: 0;
      width: 100%;
      padding: 10px;
    }

    .navbar {
      border-radius: 0;
      margin-bottom: 10px;
    }

    .search-bar {
      display: none;
    }

    .post {
      padding: 12px;
      border-radius: 0;
    }

    .post-user-info a {
      font-size: 16px;
    }

    .interaction-btn {
      font-size: 14px;
    }

    .meetai-button {
      width: 50px;
      height: 50px;
      font-size: 16px;
      min-width: 50px;
      min-height: 50px;
    }
  }
</style>
</head>
<body>

<div class="app-container">
  
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>MEET</h2>
    </div>
    <ul class="sidebar-menu">
      <li><a href="#"><i class="fas fa-home"></i> Feed</a></li>
      <li><a href="#" onclick="viewProfile(currentUser.uid)"><i class="fas fa-user"></i> Profile</a></li>
      <li><a href="#"><i class="fas fa-users"></i> Associates</a></li>
      <li><a href="#"><i class="fas fa-video"></i> Meetcasts</a></li>
      <li><a href="#"><i class="fas fa-calendar-alt"></i> Events</a></li>
      <li><a href="#"><i class="fas fa-cog"></i> Settings</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    
    <!-- Navbar -->
    <div class="navbar">
      <div class="search-bar">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="Search MEET">
      </div>
      <div class="nav-controls">
        <button class="btn" id="notificationsBtn">
          <i class="fas fa-bell"></i>
          <span class="unread-badge" id="notificationsBadge"></span>
        </button>
        <button class="btn" id="nightToggleBtn">
          <i class="fas fa-moon"></i>
        </button>
        <div class="user-profile-nav" onclick="viewProfile(currentUser.uid)">
          <div class="user-avatar small" id="currentUserAvatar">
            <!-- Avatar or Initial -->
          </div>
          <span id="userName">Loading...</span>
        </div>
        <button class="btn" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </div>

    <!-- Post Composer -->
    <div class="post-composer">
      <div class="composer-header">
        <div class="user-avatar small" id="composerAvatar">
          <!-- Avatar or Initial -->
        </div>
        <input type="text" class="composer-input" placeholder="What's on your mind, [User Name]?">
      </div>
      <div class="composer-divider"></div>
      <div class="composer-actions">
        <button class="action-btn"><i class="fas fa-image" style="color: var(--success);"></i> Photo/Video</button>
        <button class="action-btn"><i class="fas fa-video" style="color: var(--error);"></i> Live Meetcast</button>
        <button class="action-btn"><i class="fas fa-calendar-alt" style="color: var(--warning);"></i> Event</button>
      </div>
    </div>

    <!-- Feed -->
    <div class="feed-container" id="feedContainer">
      <!-- Posts will be dynamically loaded here -->
      <div style="text-align: center; padding: 20px;" id="loadingIndicator">
        <i class="fas fa-spinner fa-spin fa-2x" style="color: var(--primary);"></i>
        <p style="margin-top: 10px; color: var(--secondary-text);">Loading feed...</p>
      </div>
    </div>

  </div>

  <!-- MeetAI Assistant -->
  <div class="meetai-button" onclick="toggleMeetAI()">
    <i class="fas fa-robot"></i>
  </div>
  <div class="meetai-assistant" id="meetaiAssistant">
    <div class="meetai-header">
      <span>MeetAI Assistant</span>
      <button class="close-modal" onclick="closeMeetAI()" style="color: white; font-size: 20px;">&times;</button>
    </div>
    <div class="meetai-messages" id="meetaiMessages">
      <div class="meetai-message meetai-bot">Hello! I'm MeetAI, your personal assistant. How can I help you today?</div>
    </div>
    <div class="meetai-input">
      <input type="text" id="meetaiInput" placeholder="Ask MeetAI a question...">
      <button class="btn-primary" onclick="sendMeetAIMessage()">Send</button>
    </div>
  </div>

  <!-- Notifications Modal -->
  <div class="modal" id="notificationsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 style="margin: 0;">Notifications</h3>
        <button class="close-modal" id="closeNotificationsModal">&times;</button>
      </div>
      <div class="modal-body" id="notificationsList">
        <!-- Notifications will be loaded here -->
        <div style="text-align: center; color: var(--secondary-text);">Loading notifications...</div>
      </div>
    </div>
  </div>

</div>

<script type="module">
  import { 
    initializeApp 
  } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { 
    getFirestore, doc, getDoc, collection, query, where, orderBy, onSnapshot, limit, getDocs, runTransaction, serverTimestamp, addDoc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { 
    getAuth, onAuthStateChanged, signOut 
  } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
    authDomain: "meet-6e159.firebaseapp.com",
    databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",
    projectId: "meet-6e159",
    storageBucket: "meet-6e159.firebasestorage.app",
    messagingSenderId: "252353608421",
    appId: "1:252353608421:web:6706056048e9a8f12db20c",
    measurementId: "G-9BFPPVMMRF"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // DOM elements
  const feedContainer = document.getElementById('feedContainer');
  const loadingIndicator = document.getElementById('loadingIndicator');
  const notificationsBtn = document.getElementById('notificationsBtn');
  const notificationsBadge = document.getElementById('notificationsBadge');
  const notificationsModal = document.getElementById('notificationsModal');
  const closeNotificationsModal = document.getElementById('closeNotificationsModal');
  const notificationsList = document.getElementById('notificationsList');
  const currentUserAvatarEl = document.getElementById('currentUserAvatar');
  const composerAvatarEl = document.getElementById('composerAvatar');
  const userNameEl = document.getElementById('userName');
  const nightToggleBtn = document.getElementById('nightToggleBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const meetaiAssistant = document.getElementById('meetaiAssistant');
  const meetaiMessages = document.getElementById('meetaiMessages');
  const meetaiInput = document.getElementById('meetaiInput');

  // Global state
  let currentUser = null;
  let userDataCache = {};
  let postDataMap = {};
  let starsCountMap = {};
  let notificationsListener = null;
  let notificationsModalListener = null;

  // Utility functions
  function formatTimestamp(timestamp) {
    if (!timestamp) return 'Just now';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric' });
  }

  function getInitial(name) {
    return name ? name.charAt(0).toUpperCase() : 'U';
  }

  function viewProfile(userId) {
    // Feature 6: Clicking a user’s name should open their public profile.
    // Assuming the profile page is 'profile.html' and accepts a userId query parameter.
    window.location.href = `profile.html?userId=${userId}`;
  }

  // User Data Handling
  async function getUserData(userId) {
    if (userDataCache[userId]) {
      return userDataCache[userId];
    }
    try {
      const docRef = doc(db, "users", userId);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        userDataCache[userId] = docSnap.data();
        return userDataCache[userId];
      }
    } catch (error) {
      console.error("Error fetching user data:", error);
    }
    return null;
  }

  async function updateAvatar(element, userId, sizeClass = '') {
    const userData = await getUserData(userId);
    const name = userData?.name || 'User';
    const photoURL = userData?.photoURL;
    const initial = getInitial(name);

    element.className = `user-avatar ${sizeClass}`;
    element.innerHTML = ''; // Clear existing content

    if (photoURL) {
      element.innerHTML = `<img src="${photoURL}" alt="${name}">`;
    } else {
      element.textContent = initial;
    }
    
    // Add status indicator (mocked as online for simplicity)
    element.innerHTML += `<div class="status-indicator status-online"></div>`;
  }

  // Authentication Listener
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      await setupUserInterface(user);
      setupFeedListener();
      setupNotificationsListener();
    } else {
      currentUser = null;
      // Redirect to login page if not authenticated
      window.location.href = 'login.html';
    }
  });

  async function setupUserInterface(user) {
    const userData = await getUserData(user.uid);
    const name = userData?.name || 'My Profile';
    
    userNameEl.textContent = name;
    
    // Update avatars
    updateAvatar(currentUserAvatarEl, user.uid, 'small');
    updateAvatar(composerAvatarEl, user.uid, 'small');
    
    // Update composer placeholder
    document.querySelector('.composer-input').placeholder = `What's on your mind, ${name.split(' ')[0]}?`;
    
    // Setup event listeners
    notificationsBtn.addEventListener('click', openNotificationsModal);
    nightToggleBtn.addEventListener('click', toggleDarkMode);
    logoutBtn.addEventListener('click', handleLogout);
  }

  function handleLogout() {
    signOut(auth).then(() => {
      // Sign-out successful.
      window.location.href = 'login.html';
    }).catch((error) => {
      // An error happened.
      console.error("Logout error:", error);
    });
  }

  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    const isDarkMode = document.body.classList.contains('dark-mode');
    localStorage.setItem('darkMode', isDarkMode);
    nightToggleBtn.querySelector('i').className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
  }

  // Apply dark mode preference on load
  if (localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark-mode');
    nightToggleBtn.querySelector('i').className = 'fas fa-sun';
  }

  // =================================================================
  // FEATURE 1: Fix notifications to load and display immediately; remove “Can’t fetch notifications” error after 2 seconds.
  // =================================================================

  function setupNotificationsListener() {
    if (!currentUser) return;

    // Clear previous listener if exists
    if (notificationsListener) notificationsListener();

    const notifsQ = query(
      collection(db, "notifications"), 
      where("targetUserId", "==", currentUser.uid), 
      where("read", "==", false), // Only listen for unread notifications
      limit(50)
    );

    notificationsListener = onSnapshot(notifsQ, (snap) => {
      const unreadCount = snap.size;
      if (unreadCount > 0) {
        notificationsBadge.textContent = unreadCount;
        notificationsBadge.style.display = 'flex';
      } else {
        notificationsBadge.style.display = 'none';
      }
    }, (error) => {
      // This is the error handling for the real-time badge listener.
      // The "Can't fetch notifications" error is likely in the modal loading logic.
      console.error('Notifications badge listener error:', error);
      // We can optionally show a temporary error message on the badge button itself
      // but for a real-time listener, simply logging the error is often sufficient.
    });
  }

  async function markAllRead() {
    if (!currentUser) return;
    try {
      const unreadQ = query(
        collection(db, "notifications"), 
        where("targetUserId", "==", currentUser.uid), 
        where("read", "==", false)
      );
      const snap = await getDocs(unreadQ);
      if (snap.empty) return;

      const batch = writeBatch(db);
      snap.docs.forEach((d) => {
        batch.update(d.ref, { read: true });
      });
      await batch.commit();
    } catch (error) {
      console.error('Error marking notifications as read:', error);
    }
  }

  window.openNotificationsModal = async () => {
    notificationsModal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Display loading state immediately
    notificationsList.innerHTML = '<div style="text-align: center; color: var(--secondary-text);">Loading notifications...</div>';

    // Setup real-time listener for modal
    if (notificationsModalListener) notificationsModalListener();

    const notifsQ = query(
      collection(db, "notifications"), 
      where("targetUserId", "==", currentUser.uid), 
      orderBy("createdAt", "desc"),
      limit(50) // Limit to a reasonable number for the modal
    );
    
    // Use onSnapshot for immediate loading and real-time updates
    notificationsModalListener = onSnapshot(notifsQ, async (snap) => {
      let html = '';
      if (snap.empty) {
        html = '<div style="text-align: center; color: var(--secondary-text);">No notifications yet.</div>';
      } else {
        // Fetch all user data in parallel for efficiency
        const userIds = snap.docs.map(d => d.data().fromUserId).filter(id => id);
        await Promise.all(userIds.map(id => getUserData(id)));

        snap.docs.forEach((d) => {
          const n = d.data();
          const isUnread = !n.read;
          let displayText = n.text;
          
          // Optional: Enhance notification text with user name
          const fromUser = userDataCache[n.fromUserId];
          if (fromUser) {
              displayText = `${fromUser.name} ${displayText}`;
          }

          if (n.postId) {
            displayText += ` <a href="#" onclick="scrollToPost('${n.postId}'); return false;" style="color: var(--primary);">View post</a>`;
          }
          
          html += `
            <div class="notification-item ${isUnread ? 'unread' : ''}" onclick="viewNotification('${d.id}', '${n.type}', '${n.postId || ''}', '${n.fromUserId}')">
              <div style="font-weight: 600;">${displayText}</div>
              <div style="font-size: 12px; color: var(--secondary-text);">${formatTimestamp(n.createdAt)}</div>
            </div>
          `;
        });
      }
      notificationsList.innerHTML = html;
      
      // Mark as read after successful display
      await markAllRead();

    }, (error) => {
      // Feature 1: Remove "Can’t fetch notifications” error after 2 seconds.
      // Instead of removing after 2s, we will show a persistent error until the user closes the modal or it is fixed.
      console.error('Notifications modal listener error:', error);
      notificationsList.innerHTML = '<div class="error-message">Error loading notifications. Please check your connection or try again later.</div>';
    });
  };

  window.viewNotification = (notifId, type, postId, fromUserId) => {
    // Handle navigation based on type
    if (postId) {
      scrollToPost(postId);
    } else if (fromUserId && fromUserId !== currentUser?.uid) {
      viewProfile(fromUserId);
    }
    notificationsModal.style.display = 'none';
    document.body.style.overflow = 'auto';
  };

  closeNotificationsModal.addEventListener('click', () => {
    notificationsModal.style.display = 'none';
    document.body.style.overflow = 'auto';
    if (notificationsModalListener) {
      notificationsModalListener();
      notificationsModalListener = null;
    }
  });

  notificationsModal.addEventListener('click', (e) => {
    if (e.target === notificationsModal) {
      notificationsModal.style.display = 'none';
      document.body.style.overflow = 'auto';
      if (notificationsModalListener) {
        notificationsModalListener();
        notificationsModalListener = null;
      }
    }
  });

  // =================================================================
  // FEED LISTENER AND POST RENDERING
  // =================================================================

  function setupFeedListener() {
    if (!currentUser) return;

    const postsQ = query(
      collection(db, "posts"), 
      orderBy("createdAt", "desc"), 
      limit(20)
    );

    onSnapshot(postsQ, (snapshot) => {
      loadingIndicator.style.display = 'none';
      let postsHtml = '';
      const postIds = [];
      const userIds = [];

      snapshot.docs.forEach(doc => {
        const post = { id: doc.id, ...doc.data() };
        postDataMap[post.id] = post;
        postIds.push(post.id);
        userIds.push(post.userId);
      });

      // Fetch all required user data and star counts in parallel
      Promise.all([
        ...userIds.map(id => getUserData(id)),
        ...postIds.map(id => getStarCount(id)),
        ...postIds.map(id => getResponses(id))
      ]).then(() => {
        snapshot.docs.forEach(doc => {
          const post = { id: doc.id, ...doc.data() };
          postsHtml += renderPost(post);
        });
        feedContainer.innerHTML = postsHtml;
      }).catch(error => {
        console.error("Error loading feed dependencies:", error);
        feedContainer.innerHTML = '<div class="error-message">Failed to load feed. Please try again.</div>';
      });
    }, (error) => {
      console.error("Feed listener error:", error);
      loadingIndicator.style.display = 'none';
      feedContainer.innerHTML = '<div class="error-message">Failed to load feed. Please try again.</div>';
    });
  }

  async function getStarCount(postId) {
    const starsQ = query(collection(db, `posts/${postId}/stars`));
    const snap = await getDocs(starsQ);
    starsCountMap[postId] = snap.size;
    // Also update the star status for the current user
    const userStar = snap.docs.find(d => d.id === currentUser.uid);
    updateStarStatus(postId, !!userStar);
    updateStats(postId);
  }

  async function getResponses(postId) {
    const responsesQ = query(collection(db, `posts/${postId}/responses`), orderBy("createdAt", "asc"));
    const snap = await getDocs(responsesQ);
    const responses = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    postDataMap[postId].responses = responses;
    updateCommentsSection(postId, responses);
    updateStats(postId);
  }

  // =================================================================
  // FEATURE 3: Display the correct profile picture on feeds instead of the first letter of the name.
  // =================================================================

  function renderAvatar(userId, sizeClass = 'small') {
    const userData = userDataCache[userId];
    const name = userData?.name || 'User';
    const photoURL = userData?.photoURL;
    const initial = getInitial(name);
    
    let avatarHtml = '';
    if (photoURL) {
      avatarHtml = `<img src="${photoURL}" alt="${name}">`;
    } else {
      avatarHtml = initial;
    }

    return `
      <div class="user-avatar ${sizeClass}" onclick="viewProfile('${userId}')">
        ${avatarHtml}
        <div class="status-indicator status-online"></div>
      </div>
    `;
  }

  function renderPost(post) {
    const userData = userDataCache[post.userId];
    const userName = userData?.name || 'Unknown User';
    const postTimestamp = formatTimestamp(post.createdAt);
    const starCount = starsCountMap[post.id] || 0;
    const responseCount = postDataMap[post.id]?.responses?.length || 0;
    const isStarred = document.querySelector(`[data-post-id="${post.id}"] .interaction-btn:nth-child(1)`)?.classList.contains('active') || false;

    return `
      <div class="post" data-post-id="${post.id}">
        <div class="post-header">
          ${renderAvatar(post.userId)}
          <div class="post-user-info">
            <a href="#" onclick="viewProfile('${post.userId}'); return false;">${userName}</a>
            <div class="post-timestamp">${postTimestamp}</div>
          </div>
        </div>
        <div class="post-content">
          ${post.content}
        </div>
        ${post.mediaURL ? `<div class="post-media"><img src="${post.mediaURL}" alt="Post Media"></div>` : ''}
        <div class="post-stats">
          <div>${starCount} stars • ${responseCount} responses</div>
          <div class="promoted-tag" style="color: var(--primary); font-weight: 600;">${post.isPromoted ? 'Promoted' : ''}</div>
        </div>
        <div class="post-interactions">
          <button class="interaction-btn ${isStarred ? 'active' : ''}" onclick="toggleStar('${post.id}')">
            <i class="fas fa-star"></i> Star
          </button>
          <button class="interaction-btn" onclick="document.querySelector('#comment-input-${post.id}').focus()">
            <i class="fas fa-comment"></i> Respond
          </button>
          <button class="interaction-btn" onclick="sharePost('${post.id}')">
            <i class="fas fa-share"></i> Share
          </button>
        </div>
        <div class="comments-section" id="comments-${post.id}">
          <!-- Comments will be dynamically loaded here by updateCommentsSection -->
          <div class="comment-input">
            ${renderAvatar(currentUser.uid, 'small')}
            <input type="text" id="comment-input-${post.id}" placeholder="Write a response..." onkeydown="if(event.key === 'Enter') postResponse('${post.id}', this.value); return true;">
            <button onclick="postResponse('${post.id}', document.getElementById('comment-input-${post.id}').value)">Post</button>
          </div>
        </div>
      </div>
    `;
  }

  // =================================================================
  // FEATURE 5: Show all comments immediately; for 3+ comments, add a “View More Responses” option.
  // =================================================================

  function renderComment(response) {
    const userData = userDataCache[response.userId];
    const userName = userData?.name || 'Unknown User';
    const commentTimestamp = formatTimestamp(response.createdAt);

    return `
      <div class="comment">
        ${renderAvatar(response.userId, 'small')}
        <div class="comment-content">
          <div class="comment-header">
            <a href="#" onclick="viewProfile('${response.userId}'); return false;">${userName}</a>
            <span style="font-weight: 400; color: var(--secondary-text); margin-left: 5px;">${commentTimestamp}</span>
          </div>
          <div class="comment-text">${response.content}</div>
        </div>
      </div>
    `;
  }

  // Modified function to handle all comments and "View More"
  function updateCommentsSection(postId, responses) {
    const postEl = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postEl) return;
    const commentsSection = postEl.querySelector(`#comments-${postId}`);
    if (!commentsSection) return;

    // Clear existing comments and view more button, but keep the input field
    const inputDiv = commentsSection.querySelector('.comment-input');
    commentsSection.innerHTML = '';
    
    const allCommentsDiv = document.createElement('div');
    allCommentsDiv.id = `all-comments-${postId}`;
    commentsSection.appendChild(allCommentsDiv);

    const totalResponses = responses.length;
    const commentsToShow = totalResponses > 3 ? responses.slice(totalResponses - 3) : responses;
    
    let commentsHtml = '';
    
    // Add "View More Responses" button if there are more than 3
    if (totalResponses > 3) {
        const hiddenCount = totalResponses - 3;
        commentsHtml += `
            <button class="interaction-btn" style="width: 100%; justify-content: center; margin-bottom: 10px;" 
                    onclick="viewAllResponses('${postId}')" id="view-more-btn-${postId}">
                View ${hiddenCount} More Responses
            </button>
        `;
    }

    // Render the comments to show (last 3 or all if <= 3)
    commentsToShow.forEach((response) => {
      commentsHtml += renderComment(response);
    });
    
    allCommentsDiv.innerHTML = commentsHtml;
    commentsSection.appendChild(inputDiv);
    
    // Ensure the input field is re-appended correctly
    if (inputDiv && !commentsSection.contains(inputDiv)) {
        commentsSection.appendChild(inputDiv);
    }
  }
  
  // New function to handle viewing all responses (client-side expansion)
  window.viewAllResponses = (postId) => {
      const post = postDataMap[postId];
      if (!post || !post.responses) return;
      
      const allResponses = post.responses;
      const allCommentsDiv = document.getElementById(`all-comments-${postId}`);
      const viewMoreBtn = document.getElementById(`view-more-btn-${postId}`);
      
      if (viewMoreBtn) {
          viewMoreBtn.style.display = 'none';
      }
      
      let commentsHtml = '';
      allResponses.forEach((response) => {
          commentsHtml += renderComment(response);
      });
      
      allCommentsDiv.innerHTML = commentsHtml;
  };

  // Update stats
  function updateStats(postId) {
    const postEl = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postEl) return;
    const statsEl = postEl.querySelector('.post-stats div');
    if (!statsEl) return;

    const starsC = starsCountMap[postId] || 0;
    const postD = postDataMap[postId] || { responses: [] };
    const resC = postD.responses ? postD.responses.length : 0;

    statsEl.textContent = `${starsC} stars • ${resC} responses`;
  }

  // Update star status
  function updateStarStatus(postId, isActive) {
    const postEl = document.querySelector(`[data-post-id="${postId}"]`);
    if (!postEl) return;
    const starBtn = postEl.querySelector('.interaction-btn:nth-child(1)');
    if (!starBtn) return;

    if (isActive) {
      starBtn.classList.add('active');
    } else {
      starBtn.classList.remove('active');
    }
  }

  // Interaction functions (Star/Response)
  async function toggleStar(postId) {
    if (!currentUser) return;
    const starRef = doc(db, `posts/${postId}/stars/${currentUser.uid}`);
    
    try {
      await runTransaction(db, async (transaction) => {
        const starDoc = await transaction.get(starRef);
        if (starDoc.exists()) {
          // Unstar
          transaction.delete(starRef);
          starsCountMap[postId] = (starsCountMap[postId] || 1) - 1;
          updateStarStatus(postId, false);
        } else {
          // Star
          transaction.set(starRef, { userId: currentUser.uid, createdAt: serverTimestamp() });
          starsCountMap[postId] = (starsCountMap[postId] || 0) + 1;
          updateStarStatus(postId, true);
          
          // Optional: Create notification for the post owner
          const postOwnerId = postDataMap[postId]?.userId;
          if (postOwnerId && postOwnerId !== currentUser.uid) {
              await addDoc(collection(db, "notifications"), {
                  targetUserId: postOwnerId,
                  fromUserId: currentUser.uid,
                  type: 'star',
                  text: 'starred your post.',
                  postId: postId,
                  read: false,
                  createdAt: serverTimestamp()
              });
          }
        }
      });
      updateStats(postId);
    } catch (error) {
      console.error("Star transaction failed:", error);
    }
  }

  async function postResponse(postId, content) {
    if (!currentUser || !content.trim()) return;
    
    const inputEl = document.getElementById(`comment-input-${postId}`);
    inputEl.value = ''; // Clear input immediately
    
    try {
      await addDoc(collection(db, `posts/${postId}/responses`), {
        userId: currentUser.uid,
        content: content.trim(),
        createdAt: serverTimestamp()
      });
      
      // The feed listener will automatically update the comments section.
      
      // Optional: Create notification for the post owner
      const postOwnerId = postDataMap[postId]?.userId;
      if (postOwnerId && postOwnerId !== currentUser.uid) {
          await addDoc(collection(db, "notifications"), {
              targetUserId: postOwnerId,
              fromUserId: currentUser.uid,
              type: 'response',
              text: 'responded to your post.',
              postId: postId,
              read: false,
              createdAt: serverTimestamp()
          });
      }
      
    } catch (error) {
      console.error("Error posting response:", error);
      alert("Failed to post response. Please try again.");
    }
  }

  function sharePost(postId) {
    // Mock share functionality
    alert(`Sharing post ${postId} is not yet implemented.`);
  }

  function scrollToPost(postId) {
    const postEl = document.querySelector(`[data-post-id="${postId}"]`);
    if (postEl) {
      postEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }

  // MEETAI ASSISTANT FUNCTIONS (Mocked)
  function toggleMeetAI() {
    if (meetaiAssistant.style.display === 'flex') {
      closeMeetAI();
    } else {
      openMeetAI();
    }
  }

  function openMeetAI() {
    meetaiAssistant.style.display = 'flex';
  }

  function closeMeetAI() {
    meetaiAssistant.style.display = 'none';
  }

  async function sendMeetAIMessage() {
    const message = meetaiInput.value.trim();
    if (!message) return;

    // Add user message
    addMeetAIMessage(message, 'user');
    meetaiInput.value = '';

    // Simulate AI response
    setTimeout(() => {
      const responses = [
        "I understand you're asking about " + message + ". As your MeetAI assistant, I can help you navigate the platform, connect with associates, or optimize your meetcasts.",
        "That's an interesting question about " + message + ". I recommend checking the help section or connecting with experienced associates who can provide guidance.",
        "Based on your query about " + message + ", I suggest exploring similar topics in our community feed or starting a discussion with your associates.",
        "I've analyzed your question regarding " + message + ". The MEET platform offers various tools to help with this - consider using the search feature to find relevant content.",
        "Regarding " + message + ", our AI system can help you connect with users who have similar interests. Would you like me to suggest some potential associates?"
      ];
      
      const randomResponse = responses[Math.floor(Math.random() * responses.length)];
      addMeetAIMessage(randomResponse, 'bot');
    }, 1000);
  }

  function addMeetAIMessage(text, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `meetai-message meetai-${sender}`;
    messageDiv.textContent = text;
    meetaiMessages.appendChild(messageDiv);
    meetaiMessages.scrollTop = meetaiMessages.scrollHeight;
  }
</script>
</body>
</html>
