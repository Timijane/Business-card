<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profile Page</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<style>
  body.dark-mode { background: #121212; color: #fff; }
  .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
  .modal-content { background: #fff; padding: 20px; border-radius: 8px; max-width: 600px; width: 90%; position: relative; }
  body.dark-mode .modal-content { background: #1e1e1e; color: #fff; }
  .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 18px; height: 18px; display: inline-block; animation: spin 1s linear infinite; vertical-align: middle; margin-right: 8px; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .privacy-selector .privacy-option.active { font-weight: bold; color: #3498db; }
  .post-thumbnail { position: relative; overflow: hidden; margin-bottom: 10px; border-radius: 8px; }
  .post-stats-overlay { position: absolute; bottom: 5px; left: 5px; color: #fff; font-size: 12px; }
  .private-badge { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); padding: 3px 6px; border-radius: 4px; font-size: 12px; color: #fff; }
</style>
</head>
<body>

<!-- HEADER -->
<div>
  <span id="currentUserAvatar"></span>
  <span id="userName"></span>
  <button id="logoutBtn">Logout</button>
  <button id="nightToggleBtn"><i class="fas fa-moon"></i> Night Mode</button>
</div>

<!-- EDIT PROFILE BUTTON -->
<button id="editProfileBtn">Edit Profile</button>

<!-- PROFILE FORM MODAL -->
<div id="editProfileModal" class="modal">
  <div class="modal-content">
    <span id="closeEditModal" style="cursor:pointer;">&times;</span>
    <h2>Edit Profile</h2>
    <form id="profileForm">
      <input id="fullName" placeholder="Full Name" /><br/>
      <textarea id="bio" placeholder="Bio"></textarea><br/>
      <input id="dob" type="date" placeholder="Date of Birth" /><br/>
      <button type="submit">Save</button>
    </form>

    <div class="privacy-selector" data-field="profilePrivacy">
      <span class="privacy-option" data-privacy="public">Public</span>
      <span class="privacy-option" data-privacy="friends">Friends</span>
      <span class="privacy-option" data-privacy="private">Private</span>
    </div>

    <button id="editProfilePicture">Edit Profile Picture</button>
    <button id="editCoverPhoto">Edit Cover Photo</button>
  </div>
</div>

<!-- IMAGE UPLOAD MODAL -->
<div id="imageUploadModal" class="modal">
  <div class="modal-content">
    <span id="closeImageModal" style="cursor:pointer;">&times;</span>
    <h3 id="imageUploadTitle"></h3>
    <div id="imageUploadArea" style="border:1px dashed #ccc; padding:20px; cursor:pointer;">Click or drag image here</div>
    <input type="file" id="imageUploadInput" style="display:none;" />
    <div id="imagePreview"></div>
    <button id="uploadImageBtn">Upload</button>
  </div>
</div>

<!-- IMAGE VIEW MODAL -->
<div id="imageViewModal" class="modal">
  <div class="modal-content">
    <span id="closeImageViewModal" style="cursor:pointer;">&times;</span>
    <img id="viewedImage" style="max-width:100%;" />
  </div>
</div>

<!-- POSTS GRID -->
<div id="postsGrid"></div>

<!-- SCRIPT -->
<script>
  // ---------- GLOBAL VARIABLES ----------
  let currentUser = null;
  let userProfile = {};
  let privacySettings = {};
  let userSkills = [];
  let currentUploadType = null;
  const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

  const editProfileModal = document.getElementById('editProfileModal');
  const editProfileBtn = document.getElementById('editProfileBtn');
  const closeEditModal = document.getElementById('closeEditModal');

  const imageUploadModal = document.getElementById('imageUploadModal');
  const imageUploadArea = document.getElementById('imageUploadArea');
  const imageUploadInput = document.getElementById('imageUploadInput');
  const imagePreview = document.getElementById('imagePreview');
  const uploadImageBtn = document.getElementById('uploadImageBtn');
  const editCoverPhoto = document.getElementById('editCoverPhoto');
  const editProfilePicture = document.getElementById('editProfilePicture');

  const imageViewModal = document.getElementById('imageViewModal');
  const viewedImage = document.getElementById('viewedImage');
  const closeImageViewModal = document.getElementById('closeImageViewModal');
  const closeImageModal = document.getElementById('closeImageModal');

  const profileForm = document.getElementById('profileForm');
  const postsGrid = document.getElementById('postsGrid');

  const logoutBtn = document.getElementById('logoutBtn');
  const nightToggleBtn = document.getElementById('nightToggleBtn');

  const currentUserAvatar = document.getElementById('currentUserAvatar');
  const userName = document.getElementById('userName');

  // ---------- HELPER FUNCTIONS ----------
  function setLoading(button, isLoading) {
    if (!button) return;
    if (isLoading) {
      button.disabled = true;
      button.dataset.originalText = button.innerHTML;
      button.innerHTML = `<span class="spinner"></span> Please wait...`;
    } else {
      button.disabled = false;
      button.innerHTML = button.dataset.originalText || button.innerHTML;
    }
  }

  function showMessage(message, type = 'error') {
    alert(message);
  }

  // ---------- PRIVACY SELECTORS ----------
  function initPrivacySelectors() {
    document.querySelectorAll('.privacy-selector').forEach(selector => {
      const options = selector.querySelectorAll('.privacy-option');
      const field = selector.getAttribute('data-field');
      if (privacySettings[field]) {
        options.forEach(opt => opt.classList.remove('active'));
        const activeOption = selector.querySelector(`.privacy-option[data-privacy="${privacySettings[field]}"]`);
        if (activeOption) activeOption.classList.add('active');
      }
      options.forEach(option => {
        option.addEventListener('click', () => {
          options.forEach(opt => opt.classList.remove('active'));
          option.classList.add('active');
          privacySettings[field] = option.getAttribute('data-privacy');
        });
      });
    });
  }

  // ---------- IMAGE UPLOAD ----------
  function initImageUploads() {
    function openUploadModal(type, title) {
      currentUploadType = type;
      document.getElementById('imageUploadTitle').textContent = title;
      imageUploadModal.style.display = 'flex';
      imagePreview.innerHTML = '';
      imageUploadInput.value = '';
    }

    editCoverPhoto.addEventListener('click', () => openUploadModal('cover', 'Upload Cover Photo'));
    editProfilePicture.addEventListener('click', () => openUploadModal('profile', 'Upload Profile Picture'));

    imageUploadArea.addEventListener('click', () => imageUploadInput.click());

    imageUploadInput.addEventListener('change', (e) => {
      if (!e.target.files.length) return;
      const file = e.target.files[0];
      if (!file.type.startsWith('image/')) return showMessage('Select an image file.');
      if (file.size > MAX_FILE_SIZE) return showMessage('File too large (10MB max).');

      const reader = new FileReader();
      reader.onload = function(event) {
        imagePreview.innerHTML = `<img src="${event.target.result}" style="max-width:100%; max-height:300px; border-radius:8px;">`;
      };
      reader.readAsDataURL(file);
    });

    uploadImageBtn.addEventListener('click', async () => {
      const file = imageUploadInput.files[0];
      if (!file) return showMessage('Select an image to upload.');
      setLoading(uploadImageBtn, true);

      try {
        const imageUrl = await uploadToCloudinary(file); // implement your upload function
        const updateData = currentUploadType === 'cover' ? {coverPhoto: imageUrl} : {profilePicture: imageUrl};
        await db.collection("profiles").doc(currentUser.uid).update(updateData);
        Object.assign(userProfile, updateData);
        updateProfileDisplay();
        showMessage('Image uploaded successfully!', 'success');
        imageUploadModal.style.display = 'none';
      } catch (err) {
        console.error(err);
        showMessage('Upload failed, try again.');
      } finally { setLoading(uploadImageBtn, false); }
    });
  }

  // ---------- IMAGE VIEW ----------
  function initImageView() {
    profilePicture?.addEventListener('click', () => {
      if (userProfile.profilePicture) {
        viewedImage.src = userProfile.profilePicture;
        imageViewModal.style.display = 'flex';
      }
    });
    coverPhoto?.addEventListener('click', () => {
      if (userProfile.coverPhoto) {
        viewedImage.src = userProfile.coverPhoto;
        imageViewModal.style.display = 'flex';
      }
    });
    closeImageViewModal.addEventListener('click', () => imageViewModal.style.display = 'none');
    closeImageModal.addEventListener('click', () => imageUploadModal.style.display = 'none');
  }

  // ---------- MODALS ----------
  function initModals() {
    editProfileBtn.addEventListener('click', () => {
      editProfileModal.style.display = 'flex';
      populateEditForm(); // implement to fill form with existing data
      initPrivacySelectors();
    });
    closeEditModal.addEventListener('click', () => editProfileModal.style.display = 'none');
    window.addEventListener('click', (e) => {
      if ([editProfileModal, imageUploadModal, imageViewModal].includes(e.target)) e.target.style.display = 'none';
    });
  }

  // ---------- PROFILE FORM ----------
  profileForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) return;
    setLoading(profileForm.querySelector('button[type="submit"]'), true);

    try {
      const profileData = {
        fullName: document.getElementById('fullName').value,
        bio: document.getElementById('bio').value,
        dob: document.getElementById('dob').value,
        skills: userSkills,
        privacySettings: privacySettings,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      await db.collection("profiles").doc(currentUser.uid).update(profileData);
      Object.assign(userProfile, profileData);
      updateProfileDisplay();
      showMessage('Profile updated successfully!', 'success');
      editProfileModal.style.display = 'none';
    } catch (err) { console.error(err); showMessage('Update failed.'); }
    finally { setLoading(profileForm.querySelector('button[type="submit"]'), false); }
  });

  // ---------- INIT ----------
  document.addEventListener('DOMContentLoaded', () => {
    initImageUploads();
    initImageView();
    initModals();
    initTheme(); // implement your theme init
    renderSkills(); // implement your skill rendering
  });
</script>

</body>
</html>
