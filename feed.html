<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>

<style>
  :root {
    --primary: #0080FF;
    --primary-dark: #0066CC;
    --accent: #00C6FF;
    --success: #10B981;
    --error: #EF4444;
    --bg-color: #f0f2f5;
    --card-bg: #fff;
    --text-color: #111;
    --secondary-text: #65676b;
    --border-color: #dddfe2;
    --online: #10B981;
    --offline: #EF4444;
    --radius: 12px;
    --shadow: 0 2px 8px rgba(0,0,0,0.1);
    --outgoing-bg: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);
    --incoming-bg: #fff;
  }

  body.dark-mode {
    --bg-color: #18191a;
    --card-bg: #242526;
    --text-color: #e4e6eb;
    --secondary-text: #b0b3b8;
    --border-color: #3e4042;
    --shadow: 0 2px 8px rgba(0,0,0,0.3);
    --incoming-bg: #242526;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; overflow: hidden; font-family: 'Poppins', sans-serif; font-size: 16px; }
  body { background: var(--bg-color); color: var(--text-color); transition: all 0.3s ease; }

  .app-container { display: flex; height: 100vh; position: relative; }

  /* Sidebar */
  .sidebar {
    width: 280px;
    background: linear-gradient(180deg, #0080FF 0%, #00C6FF 100%);
    display: flex; flex-direction: column; padding: 20px;
    z-index: 100; color: white;
  }
  .sidebar-header h2 { font-size: 24px; font-weight: 700; margin-bottom: 20px; }
  .sidebar-menu { list-style: none; overflow-y: auto; flex: 1; }
  .sidebar-menu a {
    display: flex; align-items: center; padding: 12px;
    color: white; text-decoration: none; border-radius: 8px;
    margin-bottom: 8px; transition: 0.2s; position: relative;
  }
  .sidebar-menu a:hover, .sidebar-menu a.active { background: rgba(255,255,255,0.2); }
  .sidebar-menu i { margin-right: 12px; width: 20px; text-align: center; }

  /* Main Layout */
  .main-content {
    flex: 1; display: flex; flex-direction: column; 
    height: 100%; overflow: hidden; background: var(--bg-color);
  }

  /* Chat Container - The Split View */
  .chat-wrapper {
    display: flex; flex: 1; height: 100%; overflow: hidden;
    position: relative;
  }

  /* Left: Conversation List */
  .chat-sidebar {
    width: 350px; background: var(--card-bg);
    border-right: 1px solid var(--border-color);
    display: flex; flex-direction: column; z-index: 50;
  }

  /* Right: Chat Area */
  .chat-main {
    flex: 1; display: flex; flex-direction: column;
    background: var(--bg-color); position: relative;
    background-image: url('https://i.ibb.co/F8S0tL9/MEET-M-Logo-Pattern.png'); /* Default subtle pattern */
    background-blend-mode: overlay;
  }

  /* Header Components */
  .list-header, .chat-header {
    height: 70px; padding: 0 20px;
    display: flex; align-items: center; justify-content: space-between;
    background: var(--card-bg); border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
  }

  /* Search & Lists */
  .search-box { padding: 15px; border-bottom: 1px solid var(--border-color); }
  .search-box input {
    width: 100%; padding: 10px 15px; border-radius: 20px;
    border: 1px solid var(--border-color); background: var(--bg-color);
    color: var(--text-color); outline: none;
  }
  .conversation-list { overflow-y: auto; flex: 1; }
  .conversation-item {
    display: flex; align-items: center; padding: 15px; cursor: pointer;
    border-bottom: 1px solid var(--border-color); transition: 0.2s;
  }
  .conversation-item:hover, .conversation-item.active { background: rgba(0,128,255,0.05); }
  .user-avatar { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; object-fit: cover; position: relative; }
  
  /* Online Status Dot */
  .status-dot {
    width: 12px; height: 12px; border-radius: 50%;
    position: absolute; bottom: 0; right: 0;
    border: 2px solid var(--card-bg);
  }
  .is-online { background: var(--online); }
  .is-offline { background: var(--offline); }

  .chat-info { flex: 1; min-width: 0; }
  .chat-name { font-weight: 600; margin-bottom: 4px; display: flex; justify-content: space-between; }
  .chat-preview { font-size: 13px; color: var(--secondary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center;}
  
  /* Messages Area */
  .messages-container {
    flex: 1; padding: 20px; overflow-y: auto;
    display: flex; flex-direction: column; gap: 8px;
  }
  .message { max-width: 75%; display: flex; flex-direction: column; position: relative; margin-bottom: 10px;}
  .message.sent { align-self: flex-end; align-items: flex-end; }
  .message.received { align-self: flex-start; align-items: flex-start; }

  .bubble {
    padding: 10px 15px; border-radius: 18px; position: relative;
    font-size: 14px; line-height: 1.4; word-wrap: break-word;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  .sent .bubble { 
    background: var(--outgoing-bg); color: white; 
    border-bottom-right-radius: 4px; 
  }
  .received .bubble { 
    background: var(--incoming-bg); color: var(--text-color); 
    border-bottom-left-radius: 4px; 
  }
  
  /* Media in Chat */
  .chat-media {
    max-width: 100%; border-radius: 8px; margin-bottom: 5px;
    cursor: pointer; max-height: 300px; object-fit: cover;
  }

  /* Reply Context */
  .reply-context-bubble {
    font-size: 11px; opacity: 0.8; padding: 5px; margin-bottom: 5px;
    background: rgba(0,0,0,0.1); border-left: 3px solid var(--accent);
    border-radius: 4px;
  }

  /* Message Meta (Time + Ticks) */
  .msg-meta {
    font-size: 10px; margin-top: 4px; display: flex; align-items: center; gap: 4px; opacity: 0.7;
  }
  .read-ticks { font-size: 10px; }
  .read-ticks.read { color: #00ffea; } /* Cyan ticks for read on blue bg */
  .received .msg-meta { color: var(--secondary-text); }

  /* Message Actions Dropdown */
  .msg-actions-btn {
    opacity: 0; transition: 0.2s; position: absolute; top: 50%; transform: translateY(-50%);
    cursor: pointer; padding: 5px; color: var(--secondary-text);
  }
  .sent .msg-actions-btn { left: -25px; }
  .received .msg-actions-btn { right: -25px; }
  .message:hover .msg-actions-btn { opacity: 1; }

  /* Input Area */
  .input-area {
    padding: 10px 15px; background: var(--card-bg);
    border-top: 1px solid var(--border-color);
  }
  
  /* Reply Preview Bar */
  .reply-preview-bar {
    display: none; align-items: center; justify-content: space-between;
    padding: 8px 15px; background: rgba(0,0,0,0.05); 
    border-left: 4px solid var(--primary); font-size: 12px;
  }

  .input-wrapper { display: flex; align-items: flex-end; gap: 10px; }
  .input-btn {
    background: none; border: none; font-size: 20px; color: var(--secondary-text);
    cursor: pointer; padding: 8px; transition: 0.2s;
  }
  .input-btn:hover { color: var(--primary); }
  .chat-input {
    flex: 1; padding: 12px; border-radius: 20px;
    border: 1px solid var(--border-color); background: var(--bg-color);
    outline: none; max-height: 100px; resize: none; color: var(--text-color);
  }
  .send-btn {
    width: 45px; height: 45px; border-radius: 50%;
    background: var(--outgoing-bg); color: white; border: none;
    display: flex; align-items: center; justify-content: center; cursor: pointer;
  }

  /* Typing Indicator */
  .typing-indicator {
    padding: 5px 20px; font-size: 12px; color: var(--secondary-text);
    font-style: italic; display: none;
  }

  /* Emoji Picker */
  .emoji-picker-container {
    display: none; position: absolute; bottom: 80px; left: 20px;
    z-index: 200; box-shadow: var(--shadow);
  }
  emoji-picker { --num-columns: 8; width: 300px; height: 350px; }

  /* AI Toggle */
  .ai-toggle {
    display: flex; align-items: center; gap: 8px; font-size: 12px;
    margin-right: 10px; color: var(--secondary-text);
  }
  .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: #ccc; transition: .4s; border-radius: 34px;
  }
  .slider:before {
    position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px;
    background-color: white; transition: .4s; border-radius: 50%;
  }
  input:checked + .slider { background-color: var(--primary); }
  input:checked + .slider:before { transform: translateX(16px); }

  /* Modals */
  .overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000;
  }
  .modal { background: var(--card-bg); padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; }
  
  /* Loading Bar */
  .upload-progress { height: 3px; background: var(--success); width: 0%; transition: width 0.3s; }

  /* --- RESPONSIVE FIXES (Key Request 1) --- */
  @media (max-width: 768px) {
    .app-container { flex-direction: column; }
    .sidebar { display: none; } /* Hide main nav on mobile for more space */
    
    /* Mobile Toggle Logic */
    .chat-wrapper { position: relative; width: 100vw; }
    
    .chat-sidebar {
      width: 100%; position: absolute; height: 100%;
      transform: translateX(0); transition: transform 0.3s ease;
    }
    
    .chat-main {
      width: 100%; position: absolute; height: 100%;
      transform: translateX(100%); transition: transform 0.3s ease; z-index: 60;
    }
    
    /* Classes to toggle views */
    .view-chat .chat-sidebar { transform: translateX(-100%); }
    .view-chat .chat-main { transform: translateX(0); }
    
    .mobile-back-btn { display: block !important; margin-right: 10px; font-size: 20px; cursor: pointer;}
  }

  @media (min-width: 769px) {
    .mobile-back-btn { display: none; }
    .chat-sidebar { position: relative; transform: none; }
    .chat-main { position: relative; transform: none; }
  }
</style>
</head>
<body>

<div class="app-container">
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>MEET</h2>
    </div>
    <ul class="sidebar-menu">
      <li><a href="#"><i class="fas fa-home"></i> Feed</a></li>
      <li><a href="#" class="active"><i class="fas fa-comment"></i> Chat</a></li>
      <li><a href="#"><i class="fas fa-user"></i> Profile</a></li>
      <li style="margin-top: auto;"><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
    </ul>
  </div>

  <div class="main-content">
    <div class="chat-wrapper" id="chatWrapper">
      
      <div class="chat-sidebar">
        <div class="list-header">
          <h3>Chats</h3>
          <button class="input-btn" onclick="openNewChatModal()"><i class="fas fa-plus"></i></button>
        </div>
        <div class="search-box">
          <input type="text" id="chatSearch" placeholder="Search conversations...">
        </div>
        <div class="conversation-list" id="conversationsList">
          <div style="padding: 20px; text-align: center; color: #888;">Loading chats...</div>
        </div>
      </div>

      <div class="chat-main">
        <div class="chat-header" id="chatHeader" style="display: none;">
          <div style="display: flex; align-items: center;">
            <i class="fas fa-arrow-left mobile-back-btn" onclick="showListView()"></i>
            <img src="" class="user-avatar" id="currentChatAvatar">
            <div>
              <div class="chat-name" id="currentChatName">User</div>
              <div class="chat-preview" id="currentChatStatus">Offline</div>
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
             <div class="ai-toggle">
              <span>AI Reply</span>
              <label class="switch">
                <input type="checkbox" id="aiToggle">
                <span class="slider"></span>
              </label>
            </div>
          </div>
        </div>

        <div class="messages-container" id="messagesContainer">
          <div style="margin: auto; text-align: center; opacity: 0.5;">
            <i class="fas fa-comments" style="font-size: 40px; margin-bottom: 10px;"></i>
            <p>Select a chat to start messaging</p>
          </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">Someone is typing...</div>

        <div class="input-area" id="inputArea" style="display: none;">
          <div class="reply-preview-bar" id="replyPreviewBar">
            <span id="replyTextPreview">Replying to...</span>
            <i class="fas fa-times" style="cursor: pointer;" onclick="cancelReply()"></i>
          </div>
          <div class="upload-progress" id="uploadProgress"></div>
          
          <div class="input-wrapper">
            <div class="emoji-picker-container" id="emojiPickerContainer">
              <emoji-picker id="emojiPicker"></emoji-picker>
            </div>
            
            <button class="input-btn" onclick="toggleEmojiPicker()"><i class="far fa-smile"></i></button>
            <button class="input-btn" onclick="document.getElementById('mediaInput').click()"><i class="fas fa-paperclip"></i></button>
            
            <textarea id="messageInput" class="chat-input" rows="1" placeholder="Type a message..."></textarea>
            
            <button class="send-btn" id="sendBtn"><i class="fas fa-paper-plane"></i></button>
          </div>
          
          <input type="file" id="mediaInput" hidden accept="image/*,video/*">
        </div>
      </div>

    </div>
  </div>
</div>

<div class="overlay" id="newChatModal">
  <div class="modal">
    <h3>Start New Chat</h3>
    <input type="text" id="newChatEmail" placeholder="Enter user email..." style="width: 100%; padding: 10px; margin: 15px 0; border: 1px solid #ddd; border-radius: 8px;">
    <div style="display: flex; justify-content: flex-end; gap: 10px;">
      <button onclick="closeNewChatModal()" style="padding: 8px 15px; background: #ddd; border: none; border-radius: 8px;">Cancel</button>
      <button onclick="startNewChat()" style="padding: 8px 15px; background: var(--primary); color: white; border: none; border-radius: 8px;">Start</button>
    </div>
  </div>
</div>

<script type="module">
  // --- Firebase Imports ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  import { 
    getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDoc, getDocs, 
    onSnapshot, serverTimestamp, query, orderBy, where, setDoc 
  } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

  // --- Configuration ---
  const firebaseConfig = {
    apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
    authDomain: "meet-6e159.firebaseapp.com",
    databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",
    projectId: "meet-6e159",
    storageBucket: "meet-6e159.firebasestorage.app",
    messagingSenderId: "252353608421",
    appId: "1:252353608421:web:6706056048e9a8f12db20c"
  };

  // Cloudinary Config
  const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dcwof2ngn/upload";
  const CLOUDINARY_PRESET = "Meet_video"; // Ensure this preset exists and allows unsigned uploads

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- State Variables ---
  let currentUser = null;
  let currentChatId = null;
  let currentChatUser = null; // Object {uid, name, avatar}
  let typingTimeout = null;
  let replyToMessageId = null;
  let replyToContent = null;
  let isAiEnabled = false;

  // --- DOM Elements ---
  const messagesContainer = document.getElementById('messagesContainer');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const chatWrapper = document.getElementById('chatWrapper');
  const conversationsList = document.getElementById('conversationsList');
  const aiToggle = document.getElementById('aiToggle');
  const mediaInput = document.getElementById('mediaInput');
  const uploadProgress = document.getElementById('uploadProgress');

  // --- Initialization ---
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = 'login.html'; // Redirect if not logged in
    } else {
      currentUser = user;
      // Ensure user profile exists
      await setDoc(doc(db, "users", user.uid), {
        uid: user.uid,
        email: user.email,
        name: user.displayName || user.email.split('@')[0],
        avatar: user.photoURL || `https://ui-avatars.com/api/?name=${user.email}&background=0080FF&color=fff`,
        isOnline: true,
        lastSeen: serverTimestamp()
      }, { merge: true });
      
      loadConversations();
      
      // Update online status on unload
      window.addEventListener('beforeunload', () => updateStatus(false));
      updateStatus(true);
    }
  });

  // --- Mobile Navigation ---
  window.showListView = () => {
    chatWrapper.classList.remove('view-chat');
    currentChatId = null;
  };

  function showChatViewMobile() {
    chatWrapper.classList.add('view-chat');
  }

  // --- Core Chat Functions ---
  
  async function loadConversations() {
    const q = query(collection(db, "conversations"), where("participants", "array-contains", currentUser.uid));
    
    onSnapshot(q, (snapshot) => {
      conversationsList.innerHTML = '';
      const chats = [];
      snapshot.forEach(doc => chats.push({id: doc.id, ...doc.data()}));
      
      // Sort client-side by updatedAt
      chats.sort((a,b) => (b.updatedAt?.toMillis() || 0) - (a.updatedAt?.toMillis() || 0));

      chats.forEach(chat => {
        const otherId = chat.participants.find(id => id !== currentUser.uid);
        const name = chat.participantNames[otherId] || 'User';
        const avatar = chat.participantAvatars[otherId] || 'default.png';
        const lastMsg = chat.lastMessage || 'No messages yet';
        
        // Fetch real-time online status of other user
        const div = document.createElement('div');
        div.className = 'conversation-item';
        div.innerHTML = `
          <div style="position:relative">
            <img src="${avatar}" class="user-avatar">
            <div class="status-dot" id="status-${otherId}"></div>
          </div>
          <div class="chat-info">
            <div class="chat-name">${name}</div>
            <div class="chat-preview">${lastMsg}</div>
          </div>
        `;
        div.onclick = () => openChat(chat.id, {uid: otherId, name, avatar});
        conversationsList.appendChild(div);
        
        // Listener for online status
        onSnapshot(doc(db, "users", otherId), (docSnap) => {
          if(docSnap.exists()) {
             const dot = document.getElementById(`status-${otherId}`);
             if(dot) {
               dot.className = `status-dot ${docSnap.data().isOnline ? 'is-online' : 'is-offline'}`;
             }
          }
        });
      });
    });
  }

  async function openChat(chatId, userDetails) {
    currentChatId = chatId;
    currentChatUser = userDetails;
    
    // UI Updates
    document.getElementById('chatHeader').style.display = 'flex';
    document.getElementById('inputArea').style.display = 'block';
    document.getElementById('currentChatName').textContent = userDetails.name;
    document.getElementById('currentChatAvatar').src = userDetails.avatar;
    messagesContainer.innerHTML = '';
    
    showChatViewMobile(); // Slide to chat on mobile

    // Load Messages
    const q = query(collection(db, `conversations/${chatId}/messages`), orderBy('timestamp', 'asc'));
    onSnapshot(q, (snapshot) => {
      messagesContainer.innerHTML = '';
      snapshot.forEach(docSnap => {
        renderMessage(docSnap.id, docSnap.data());
      });
      // Scroll to bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      // Mark visible messages as read
      markMessagesAsRead(chatId, snapshot.docs);
    });

    // Listen for typing indicator
    onSnapshot(doc(db, "conversations", chatId), (docSnap) => {
      const data = docSnap.data();
      const isTyping = data?.typing?.[userDetails.uid];
      const indicator = document.getElementById('typingIndicator');
      const statusText = document.getElementById('currentChatStatus');
      
      if(isTyping) {
        indicator.style.display = 'block';
        statusText.textContent = 'Typing...';
      } else {
        indicator.style.display = 'none';
        // Fallback to online status check (simplified)
        statusText.textContent = 'Active'; 
      }
    });
  }

  // --- Rendering Messages ---
  function renderMessage(id, msg) {
    const isMe = msg.senderId === currentUser.uid;
    const div = document.createElement('div');
    div.className = `message ${isMe ? 'sent' : 'received'}`;
    
    // Render Reply Context
    let replyHtml = '';
    if (msg.replyToContent) {
      replyHtml = `<div class="reply-context-bubble"><i class="fas fa-reply"></i> ${msg.replyToContent}</div>`;
    }

    // Render Content (Text, Image, Video)
    let contentHtml = '';
    if (msg.type === 'image') {
      contentHtml = `<img src="${msg.mediaUrl}" class="chat-media" onclick="window.open(this.src)">`;
    } else if (msg.type === 'video') {
      contentHtml = `<video src="${msg.mediaUrl}" class="chat-media" controls></video>`;
    }
    
    // Text can accompany media
    if (msg.text) {
      contentHtml += `<div>${msg.text}</div>`;
    }

    // Read Receipts
    const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...';
    let ticks = '';
    if(isMe) {
      const readClass = msg.read ? 'read' : '';
      ticks = `<span class="read-ticks ${readClass}"><i class="fas fa-check-double"></i></span>`;
    }

    div.innerHTML = `
      <div class="bubble">
        ${replyHtml}
        ${contentHtml}
        <div class="msg-meta">
          ${time} ${ticks} 
          ${msg.isAi ? 'ðŸ¤–' : ''}
        </div>
      </div>
      <div class="msg-actions-btn" onclick="showMessageOptions('${id}', '${msg.text}', ${isMe})">
        <i class="fas fa-ellipsis-v"></i>
      </div>
    `;
    messagesContainer.appendChild(div);
  }

  // --- Sending Messages & Cloudinary ---
  
  // 1. Upload to Cloudinary (Optimize size with q_auto)
  async function uploadToCloudinary(file) {
    uploadProgress.style.width = '20%';
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", CLOUDINARY_PRESET);
    
    try {
      const res = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
      uploadProgress.style.width = '70%';
      const data = await res.json();
      uploadProgress.style.width = '0%';
      // Add formatting for better delivery (f_auto, q_auto) handled by Cloudinary URL params usually,
      // but data.secure_url is good.
      return { url: data.secure_url, type: data.resource_type };
    } catch (e) {
      console.error("Upload failed", e);
      alert("Upload failed");
      uploadProgress.style.width = '0%';
      return null;
    }
  }

  // 2. Main Send Logic
  async function sendMessage(text = '', media = null) {
    if (!text && !media) return;
    
    const payload = {
      senderId: currentUser.uid,
      timestamp: serverTimestamp(),
      read: false,
      replyToId: replyToMessageId,
      replyToContent: replyToContent,
      type: media ? media.type : 'text',
      mediaUrl: media ? media.url : null,
      text: text
    };

    try {
      // Add message
      await addDoc(collection(db, `conversations/${currentChatId}/messages`), payload);
      
      // Update Conversation Last Message
      await updateDoc(doc(db, "conversations", currentChatId), {
        lastMessage: media ? `[${media.type}]` : text,
        updatedAt: serverTimestamp(),
        [`typing.${currentUser.uid}`]: false // Stop typing
      });

      // Clear Inputs
      messageInput.value = '';
      cancelReply();

      // --- AI Auto Reply Logic (Item 7) ---
      if (aiToggle.checked && !media) {
         simulateAiReply(text);
      }

    } catch (e) {
      console.error(e);
    }
  }

  // Media Trigger
  mediaInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
      const mediaData = await uploadToCloudinary(file);
      if (mediaData) {
        sendMessage(messageInput.value, mediaData); // Send text caption + media
      }
    }
  });

  // Text Trigger
  sendBtn.addEventListener('click', () => sendMessage(messageInput.value.trim()));
  messageInput.addEventListener('keydown', (e) => {
    handleTyping();
    if(e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage(messageInput.value.trim());
    }
  });

  // --- Features Implementation ---

  // 1. Typing Indicator
  function handleTyping() {
    clearTimeout(typingTimeout);
    updateDoc(doc(db, "conversations", currentChatId), { [`typing.${currentUser.uid}`]: true });
    
    typingTimeout = setTimeout(() => {
       updateDoc(doc(db, "conversations", currentChatId), { [`typing.${currentUser.uid}`]: false });
    }, 2000);
  }

  // 2. Read Receipts
  function markMessagesAsRead(chatId, docs) {
    docs.forEach(d => {
      const data = d.data();
      if (!data.read && data.senderId !== currentUser.uid) {
        updateDoc(doc(db, `conversations/${chatId}/messages`, d.id), { read: true });
      }
    });
  }

  // 3. Message Options (Edit/Delete/Reply)
  window.showMessageOptions = (msgId, text, isMe) => {
    const action = prompt(`Choose action:\n1. Reply\n${isMe ? '2. Edit\n3. Delete' : ''}`, "1");
    if (action === '1') {
      // Reply
      document.getElementById('replyPreviewBar').style.display = 'flex';
      document.getElementById('replyTextPreview').textContent = `Replying to: ${text.substring(0, 20)}...`;
      replyToMessageId = msgId;
      replyToContent = text;
      messageInput.focus();
    } else if (action === '2' && isMe) {
      // Edit
      const newText = prompt("Edit message:", text);
      if(newText) updateDoc(doc(db, `conversations/${currentChatId}/messages`, msgId), { text: newText });
    } else if (action === '3' && isMe) {
      // Delete
      if(confirm("Delete this message?")) deleteDoc(doc(db, `conversations/${currentChatId}/messages`, msgId));
    }
  };

  window.cancelReply = () => {
    replyToMessageId = null;
    replyToContent = null;
    document.getElementById('replyPreviewBar').style.display = 'none';
  };

  // 4. Emoji Picker
  const picker = document.querySelector('emoji-picker');
  picker.addEventListener('emoji-click', event => {
    messageInput.value += event.detail.unicode;
    document.getElementById('emojiPickerContainer').style.display = 'none';
    messageInput.focus();
  });
  window.toggleEmojiPicker = () => {
    const el = document.getElementById('emojiPickerContainer');
    el.style.display = el.style.display === 'block' ? 'none' : 'block';
  };

  // 5. AI Auto Reply (Simulated)
  function simulateAiReply(userText) {
    setTimeout(async () => {
       await addDoc(collection(db, `conversations/${currentChatId}/messages`), {
          senderId: currentUser.uid, // Sent as "me" automatically
          text: `[AI Auto-Reply]: I received "${userText}". I am currently away.`,
          timestamp: serverTimestamp(),
          read: false,
          isAi: true
       });
    }, 2000); // 2 second delay
  }

  // --- Helpers ---
  async function updateStatus(isOnline) {
    if(currentUser) {
      await updateDoc(doc(db, "users", currentUser.uid), {
        isOnline: isOnline,
        lastSeen: serverTimestamp()
      });
    }
  }

  // Start Chat Modal Logic
  window.openNewChatModal = () => document.getElementById('newChatModal').style.display = 'flex';
  window.closeNewChatModal = () => document.getElementById('newChatModal').style.display = 'none';
  
  window.startNewChat = async () => {
    const email = document.getElementById('newChatEmail').value;
    // (Simplified) Search for user by email -> Create ID -> Add to list
    // In production, query 'users' collection where email == input
    alert("In a real app, this would query the user database for: " + email);
    closeNewChatModal();
  };

  window.logoutBtn = document.getElementById('logoutBtn');
  window.logoutBtn.addEventListener('click', () => signOut(auth));

</script>
</body>
</html>
