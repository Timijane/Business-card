<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>MEET | Feed — MeetCasts</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
  :root{
    --primary:#0080FF; --primary-dark:#0066CC; --bg:#f0f2f5; --card:#fff;
    --text:#111; --muted:#65676b; --border:#dddfe2; --success:#10B981; --error:#EF4444;
  }
  body.dark-mode { --bg:#18191a; --card:#242526; --text:#e4e6eb; --muted:#b0b3b8; --border:#3e4042;}
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;font-family:'Poppins',sans-serif;font-size:18px;background:linear-gradient(135deg,#e0f7ff 0%,#b3e0ff 100%);color:var(--text)}
  .app-container{display:flex;min-height:100vh}
  .sidebar{position:fixed;left:0;top:0;height:100vh;width:280px;background:linear-gradient(180deg,#0080FF 0%,#00C6FF 100%);padding:20px;color:white;border-right:1px solid rgba(255,255,255,.06)}
  .sidebar h2{margin-bottom:12px}
  .sidebar-menu{list-style:none;margin-top:12px}
  .sidebar-menu a{display:flex;align-items:center;padding:12px;color:white;text-decoration:none;border-radius:8px;font-size:18px}
  .main-content{flex:1;margin-left:280px;padding:20px;min-height:100vh}
  .navbar{background:linear-gradient(135deg,#0080FF 0%,#00C6FF 100%);padding:15px;border-radius:12px;color:white;display:flex;justify-content:space-between;align-items:center}
  .user-profile-nav{display:flex;align-items:center;gap:10px}
  .user-avatar{width:40px;height:40px;border-radius:50%;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-weight:700;overflow:hidden}
  .btn{background:rgba(255,255,255,.15);color:white;border:none;padding:8px 14px;border-radius:8px;cursor:pointer;font-weight:600}
  .post-composer{background:var(--card);border-radius:12px;padding:16px;margin-top:16px;box-shadow:0 2px 8px rgba(0,0,0,.07)}
  .composer-input{padding:12px;border-radius:25px;border:1px solid var(--border);cursor:pointer;color:var(--muted)}
  .ai-button{position:fixed;right:20px;bottom:20px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#00C6FF 0%,#80b3ff 100%);display:flex;align-items:center;justify-content:center;color:white;font-size:22px;z-index:99}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:1000;padding:20px}
  .modal-content{background:var(--card);border-radius:12px;padding:16px;width:680px;max-width:100%;max-height:90vh;overflow:auto}
  .posts{display:flex;flex-direction:column;gap:16px;margin-top:18px}
  .post{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  .post-header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .post-user{display:flex;align-items:center;gap:12px;cursor:pointer}
  .post-content{margin-top:12px;font-size:18px;line-height:1.4}
  .post-media img, .post-media video{width:100%;height:auto;border-radius:8px;margin-top:12px;object-fit:contain}
  .post-stats{display:flex;justify-content:space-between;padding:12px 0;border-top:1px solid var(--border);color:var(--muted)}
  .post-actions{display:flex;gap:8px;margin-top:8px}
  .action-btn{padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:transparent;cursor:pointer;font-weight:600;color:var(--muted)}
  .action-btn.active{color:var(--primary);border-color:var(--primary)}
  .comments-section{margin-top:12px;border-top:1px solid var(--border);padding-top:12px}
  .comment{display:flex;gap:12px;margin-bottom:12px}
  .comment .user-avatar{width:32px;height:32px;font-size:14px}
  .comment-input{display:flex;gap:8px;align-items:center}
  .send-comment-btn{background:var(--primary);color:white;border:none;border-radius:50%;width:34px;height:34px;cursor:pointer}
  .loading{text-align:center;color:var(--muted);padding:20px}
  @media(max-width:768px){.sidebar{width:70px}.main-content{margin-left:70px;padding:10px}}
</style>
</head>
<body>
<div class="app-container">
  <div class="sidebar">
    <h2>MEET</h2>
    <ul class="sidebar-menu">
      <li><a href="#"><i class="fas fa-compass"></i>&nbsp; <span>Feed</span></a></li>
      <li><a href="#" onclick="goToMyProfile()"><i class="fas fa-user"></i>&nbsp;<span>Profile</span></a></li>
      <li><a href="#"><i class="fas fa-comments"></i>&nbsp;<span>Chat</span></a></li>
    </ul>
  </div>

  <div class="main-content">
    <div class="navbar">
      <div style="display:flex;align-items:center;gap:12px">
        <h3 style="margin:0">MEETCasts</h3>
        <div style="color:rgba(255,255,255,.9);font-size:14px">Share your MeetCast — promote what matters</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="user-profile-nav" title="Open profile">
          <div class="user-avatar" id="currentUserAvatar">U</div>
          <div id="userName" style="color:white;font-weight:600">Guest</div>
        </div>
        <button class="btn" id="nightToggleBtn"><i class="fas fa-moon"></i>&nbsp;<span>Night Mode</span></button>
        <button class="btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i>&nbsp;<span>Logout</span></button>
      </div>
    </div>

    <!-- Composer -->
    <div class="post-composer">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="user-avatar" id="composerAvatar">U</div>
        <div class="composer-input" id="openComposer" role="button" tabindex="0">Create a MeetCast — share something special</div>
        <button class="btn" id="newMeetCastBtn" style="margin-left:auto">New MeetCast</button>
      </div>
    </div>

    <div class="posts" id="postsContainer">
      <div class="loading">Loading MeetCasts…</div>
    </div>
  </div>
</div>

<!-- MeetCast Modal -->
<div class="modal" id="meetcastModal">
  <div class="modal-content">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0">Create MeetCast</h3>
      <button class="btn" id="closeMeetcastModal">&times;</button>
    </div>

    <div style="display:flex;gap:12px;align-items:flex-start">
      <div class="user-avatar" id="modalAvatar">U</div>
      <div style="flex:1">
        <input id="meetcastText" placeholder="Write your MeetCast..." style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:16px" maxlength="800"/>
        <div id="mediaPreview" style="margin-top:10px"></div>
        <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
          <input type="file" id="meetcastMedia" accept="image/*,video/*" multiple style="display:none"/>
          <button class="action-btn" onclick="document.getElementById('meetcastMedia').click()"><i class="fas fa-image"></i>&nbsp;Add Media</button>
          <select id="meetcastPrivacy" style="padding:8px;border-radius:8px;border:1px solid var(--border)">
            <option value="public">Public</option>
            <option value="associates">Associates</option>
            <option value="private">Only me</option>
          </select>
          <button class="btn" id="publishMeetcastBtn" style="margin-left:auto;background:linear-gradient(135deg,#0080FF 0%,#00C6FF 100%);color:white">Publish MeetCast</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- AI Modal (placeholder) -->
<div class="modal" id="aiModal">
  <div class="modal-content">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">MEET AI — Suggestions</h3>
      <button class="btn" id="closeAiModal">&times;</button>
    </div>
    <div style="margin-top:12px">
      <div style="margin-bottom:8px;color:var(--muted)">Ask MEET AI to suggest captions, hashtags or summarize a MeetCast.</div>
      <textarea id="aiPrompt" placeholder="Describe what you want..." style="width:100%;min-height:120px;padding:10px;border:1px solid var(--border);border-radius:8px"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="askAiBtn" style="background:var(--primary);color:white">Ask AI</button>
        <div id="aiResult" style="flex:1"></div>
      </div>
    </div>
  </div>
</div>

<button class="ai-button" id="openAiBtn" title="MEET AI"><i class="fas fa-robot"></i></button>

<script type="module">
/* ===========================================================
   MEET Feed — Full script (MeetCast, Star, Associates)
   Uses Firebase modular SDK v10 (Firestore + Auth)
   Cloudinary unsigned preset uploads (no secret in client)
   =========================================================== */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import {
  getFirestore, collection, doc, addDoc, setDoc, deleteDoc, getDoc, getDocs,
  onSnapshot, query, orderBy, where, serverTimestamp, runTransaction, limit
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

/* -------------------------
   YOUR FIREBASE CONFIG
   ------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
  authDomain: "meet-6e159.firebaseapp.com",
  databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",
  projectId: "meet-6e159",
  storageBucket: "meet-6e159.appspot.com",
  messagingSenderId: "252353608421",
  appId: "1:252353608421:web:6706056048e9a8f12db20c",
  measurementId: "G-9BFPPVMMRF"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* -------------------------
   CLOUDINARY (unsigned preset)
   Make sure you created an unsigned upload preset in Cloudinary
   ------------------------- */
const CLOUDINARY_CLOUD_NAME = 'dcwof2ngn';
const CLOUDINARY_UPLOAD_PRESET = 'Meet_video'; // unsigned preset
const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`;

/* -------------------------
   DOM refs
   ------------------------- */
const postsContainer = document.getElementById('postsContainer');
const openComposer = document.getElementById('openComposer');
const meetcastModal = document.getElementById('meetcastModal');
const closeMeetcastModal = document.getElementById('closeMeetcastModal');
const newMeetCastBtn = document.getElementById('newMeetCastBtn');
const publishMeetcastBtn = document.getElementById('publishMeetcastBtn');
const meetcastText = document.getElementById('meetcastText');
const meetcastMedia = document.getElementById('meetcastMedia');
const mediaPreview = document.getElementById('mediaPreview');
const modalAvatar = document.getElementById('modalAvatar');
const modalUserName = document.getElementById('userName');
const currentUserAvatar = document.getElementById('currentUserAvatar');
const composerAvatar = document.getElementById('composerAvatar');
const nightToggleBtn = document.getElementById('nightToggleBtn');
const logoutBtn = document.getElementById('logoutBtn');
const openAiBtn = document.getElementById('openAiBtn');
const aiModal = document.getElementById('aiModal');
const closeAiModal = document.getElementById('closeAiModal');
const askAiBtn = document.getElementById('askAiBtn');
const aiPrompt = document.getElementById('aiPrompt');
const aiResult = document.getElementById('aiResult');

let currentUser = null;
let postUnsubs = {};

/* -------------------------
   THEME
   ------------------------- */
function initTheme(){
  const t = localStorage.getItem('meet_theme');
  if(t==='dark'){ document.body.classList.add('dark-mode'); nightToggleBtn.innerHTML = '<i class="fas fa-sun"></i>&nbsp;<span>Day Mode</span>'; }
  else { document.body.classList.remove('dark-mode'); nightToggleBtn.innerHTML = '<i class="fas fa-moon"></i>&nbsp;<span>Night Mode</span>'; }
}
initTheme();
nightToggleBtn.addEventListener('click', ()=> {
  if(document.body.classList.contains('dark-mode')){ document.body.classList.remove('dark-mode'); localStorage.setItem('meet_theme','light'); nightToggleBtn.innerHTML = '<i class="fas fa-moon"></i>&nbsp;<span>Night Mode</span>' }
  else { document.body.classList.add('dark-mode'); localStorage.setItem('meet_theme','dark'); nightToggleBtn.innerHTML = '<i class="fas fa-sun"></i>&nbsp;<span>Day Mode</span>' }
});

/* -------------------------
   UTIL: show message
   ------------------------- */
function showMessage(msg, type='error'){
  const el = document.createElement('div');
  el.className = type === 'success' ? 'success-message' : 'error-message';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(()=> el.remove(), 4500);
}

/* -------------------------
   CLOUDINARY UPLOAD
   ------------------------- */
async function uploadToCloudinary(file){
  if(!file) return null;
  if(file.size > 20 * 1024 * 1024) throw new Error('File too large; max 20MB');
  const fd = new FormData();
  fd.append('file', file);
  fd.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
  const res = await fetch(CLOUDINARY_URL, { method: 'POST', body: fd });
  if(!res.ok){ const err = await res.json().catch(()=>null); throw new Error(err?.error?.message || 'Upload failed'); }
  const data = await res.json();
  return data.secure_url;
}

/* -------------------------
   CREATE MeetCast (post)
   - Stores author info inside the post for fast reads
   - Adds starCount: 0
   ------------------------- */
async function createMeetCast(text, files, privacy='public'){
  const user = auth.currentUser;
  if(!user) throw new Error('Sign in to publish');

  // upload media sequentially (you can parallelize as needed)
  const mediaUrls = [];
  if(files && files.length){
    for(const f of files){
      mediaUrls.push(await uploadToCloudinary(f));
    }
  }

  await addDoc(collection(db,'posts'), {
    userId: user.uid,
    userName: user.displayName || 'Anonymous',
    userPhotoURL: user.photoURL || null,
    userInitial: (user.displayName && user.displayName.charAt(0)) ? user.displayName.charAt(0).toUpperCase() : 'U',
    text: text || '',
    media: mediaUrls,
    privacy: privacy,
    starCount: 0,
    timestamp: serverTimestamp()
  });
}

/* -------------------------
   STAR (like) toggle
   ensures atomic update of starCount + star doc
   path: posts/{postId}/stars/{uid}
   ------------------------- */
async function toggleStar(postId){
  const user = auth.currentUser;
  if(!user) { showMessage('Please sign in to vibe', 'error'); return; }
  const postRef = doc(db,'posts',postId);
  const starRef = doc(db,'posts',postId,'stars',user.uid);

  try{
    await runTransaction(db, async (tx) => {
      const postSnap = await tx.get(postRef);
      if(!postSnap.exists()) throw new Error('MeetCast no longer exists');

      const starSnap = await tx.get(starRef);
      const currentCount = postSnap.data().starCount || 0;

      if(starSnap.exists()){
        // user already starred -> remove
        tx.delete(starRef);
        tx.update(postRef, { starCount: Math.max(0, currentCount - 1) });
      } else {
        // add star doc
        tx.set(starRef, { userId: user.uid, userName: user.displayName || 'Anonymous', userPhotoURL: user.photoURL || null, timestamp: serverTimestamp() });
        tx.update(postRef, { starCount: currentCount + 1 });
      }
    });
  } catch(err){
    console.error('toggleStar error', err);
    showMessage('Failed to update star. Try again.');
  }
}

/* -------------------------
   Comments -> Responses
   path: posts/{postId}/responses/{id}
   ------------------------- */
async function addResponse(postId, text){
  const user = auth.currentUser;
  if(!user) return;
  if(!text || !text.trim()) return;
  await addDoc(collection(db,'posts',postId,'responses'), {
    userId: user.uid,
    userName: user.displayName || 'Anonymous',
    userPhotoURL: user.photoURL || null,
    text: text.trim(),
    timestamp: serverTimestamp()
  });
}

/* -------------------------
   Associates (follow/unfollow) — a simple unidirectional associate:
   - users/{uid}/associates/{otherUid}
   - users/{otherUid}/associatesFollowers/{uid}
   ------------------------- */
async function addAssociate(targetUid){
  const user = auth.currentUser;
  if(!user) return;
  try{
    await setDoc(doc(db,'users',user.uid,'associates',targetUid), { createdAt: serverTimestamp() });
    await setDoc(doc(db,'users',targetUid,'associatesFollowers',user.uid), { createdAt: serverTimestamp() });
    showMessage('Associated successfully', 'success');
  } catch(e){ console.error(e); showMessage('Failed to associate'); }
}

async function removeAssociate(targetUid){
  const user = auth.currentUser;
  if(!user) return;
  try{
    await deleteDoc(doc(db,'users',user.uid,'associates',targetUid));
    await deleteDoc(doc(db,'users',targetUid,'associatesFollowers',user.uid));
    showMessage('No longer associated', 'success');
  } catch(e){ console.error(e); showMessage('Failed to remove association'); }
}

/* -------------------------
   Real-time feed (MeetCasts)
   - listens to posts collection ordered by timestamp desc
   - for each post we subscribe to stars & responses subcollections
   - we render using renderMeetCast()
   ------------------------- */

function clearPostListeners(){
  Object.values(postUnsubs).forEach(fn => fn && fn());
  postUnsubs = {};
}

function setupRealtimeFeed(){
  const q = query(collection(db,'posts'), orderBy('timestamp','desc'));
  // top-level listener
  onSnapshot(q, snapshot => {
    clearPostListeners();
    postsContainer.innerHTML = '';
    if(snapshot.empty){ postsContainer.innerHTML = '<div class="loading">No MeetCasts yet — be first to publish!</div>'; return; }

    snapshot.docs.forEach(docSnap => {
      const postId = docSnap.id;
      const postData = docSnap.data();
      // Only render if viewable according to privacy (simple rules)
      if(!canViewMeetCast(postData)) return;
      // subscribe to stars and responses counts
      const starsQ = query(collection(db,'posts',postId,'stars'));
      const starsUnsub = onSnapshot(starsQ, starsSnap => {
        const starCount = starsSnap.size;
        // check if current user starred
        const userStarred = !!starsSnap.docs.find(d => d.id === (currentUser?.uid || ''));
        // For responses
        const responsesQ = query(collection(db,'posts',postId,'responses'), orderBy('timestamp','asc'), limit(100));
        const responsesUnsub = onSnapshot(responsesQ, resSnap => {
          const responses = resSnap.docs.map(d => ({ id: d.id, ...d.data() }));
          // initial render or update existing post DOM
          renderMeetCast(postId, postData, starCount, userStarred, responses);
        });
        // store nested unsub
        postUnsubs[postId] = () => { starsUnsub(); responsesUnsub(); };
      });
    });
  }, err => {
    console.error('feed listener error', err);
    postsContainer.innerHTML = '<div class="error-message">Failed loading feed — refresh the page.</div>';
  });
}

/* -------------------------
   Privacy check (simple)
   - public: anyone signed in sees
   - associates: only users who are associated (or post owner) sees
   - private: owner only
   ------------------------- */
async function isAssociatedWith(viewerUid, ownerUid){
  if(!viewerUid || !ownerUid) return false;
  const ref = doc(db,'users',ownerUid,'associatesFollowers',viewerUid);
  const snap = await getDoc(ref);
  return snap.exists();
}

function canViewMeetCast(post){
  // if no auth, don't show (your previous rules required auth)
  if(!currentUser) return false;
  if(!post.privacy || post.privacy === 'public') return true;
  if(post.privacy === 'private' && post.userId === currentUser.uid) return true;
  // associates: show if viewer is associate follower of author OR author is viewer
  if(post.privacy === 'associates'){
    if(post.userId === currentUser.uid) return true;
    // we cannot await here in the top-level listener; assume true and filter later in render, or do a synchronous check above.
    // For simplicity, allow for now and double-check in renderMeetCast with a quick isAssociatedWith call.
    return true;
  }
  return false;
}

/* -------------------------
   Helper: fetch user profile fallback
   used when post doesn't include userPhotoURL
   ------------------------- */
const userCache = {};
async function getUserProfile(uid){
  if(!uid) return null;
  if(userCache[uid]) return userCache[uid];
  try{
    const snap = await getDoc(doc(db,'users',uid));
    if(snap.exists()){ userCache[uid] = snap.data(); return userCache[uid]; }
    return null;
  }catch(e){ console.error(e); return null; }
}

/* -------------------------
   RENDER MeetCast
   - creates or updates DOM for each post id
   ------------------------- */
function renderMeetCast(id, data, starCount=0, userStarred=false, responses=[]){
  // If privacy is 'associates', ensure viewer is associate (async check)
  if(data.privacy === 'associates' && data.userId !== (currentUser && currentUser.uid)){
    isAssociatedWith(currentUser?.uid, data.userId).then(isAssoc => {
      if(!isAssoc) {
        // remove existing DOM if present
        const dom = document.querySelector(`[data-post-id="${id}"]`);
        if(dom) dom.remove();
        return;
      }
      // if associated show the post by calling render again but now allowed
      actuallyRender();
    }).catch(err => { console.error(err); });
  } else {
    actuallyRender();
  }

  async function actuallyRender(){
    // ensure we show author photo (use post's userPhotoURL or fallback to user profile)
    let authorPhoto = data.userPhotoURL || null;
    if(!authorPhoto){
      const profile = await getUserProfile(data.userId);
      authorPhoto = profile?.photoURL || null;
    }

    // find existing element
    let postEl = document.querySelector(`[data-post-id="${id}"]`);
    const isOwner = currentUser && data.userId === currentUser.uid;

    // compose user avatar html
    const avatarHtml = authorPhoto ? `<img src="${authorPhoto}" alt="${data.userName || 'User'}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : (data.userInitial || 'U');

    const truncated = (data.text && data.text.length > 300) ? (data.text.substring(0,300) + '...') : (data.text || '');

    // media html
    let mediaHtml = '';
    if(Array.isArray(data.media) && data.media.length){
      if(data.media.length === 1){
        const m = data.media[0];
        const isVideo = /\.(mp4|webm|mov|avi)$/i.test(m);
        mediaHtml = `<div class="post-media" onclick="openMediaModal('${m}', ${isVideo})">${ isVideo ? `<video controls src="${m}"></video>` : `<img src="${m}" loading="lazy">` }</div>`;
      } else {
        mediaHtml = '<div class="post-media" style="display:grid;grid-template-columns:1fr 1fr;gap:6px">';
        data.media.forEach(m => {
          const isVideo = /\.(mp4|webm|mov|avi)$/i.test(m);
          mediaHtml += `<div onclick="openMediaModal('${m}', ${isVideo})" style="cursor:pointer">${ isVideo ? `<video style="width:100%;height:150px;object-fit:cover" src="${m}"></video>` : `<img style="width:100%;height:150px;object-fit:cover" src="${m}" loading="lazy">` }</div>`;
        });
        mediaHtml += '</div>';
      }
    }

    const responsesHtml = responses.slice(-2).map(r => {
      const rAvatar = r.userPhotoURL ? `<img src="${r.userPhotoURL}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : (r.userInitial || 'U');
      return `<div class="comment"><div class="user-avatar">${rAvatar}</div><div class="comment-content"><div style="font-weight:600;color:var(--primary)">${escapeHtml(r.userName||'User')}</div><div>${escapeHtml(r.text)}</div></div></div>`;
    }).join('');

    const inner = `
      <div class="post-header">
        <div class="post-user" onclick="viewProfile('${data.userId}')">
          <div class="user-avatar">${avatarHtml}</div>
          <div>
            <div style="font-weight:700;color:var(--primary)">${escapeHtml(data.userName||'Anonymous')}</div>
            <div style="color:var(--muted);font-size:13px">${formatTimestamp(data.timestamp)} • ${data.privacy === 'public' ? 'Public' : data.privacy === 'associates' ? 'Associates' : 'Only me'}</div>
          </div>
        </div>
        ${isOwner ? `<div style="display:flex;gap:8px"><button class="action-btn" onclick="editMeetCast('${id}')">Edit</button><button class="action-btn" onclick="deleteMeetCast('${id}')">Delete</button></div>` : ''}
      </div>

      <div class="post-content">${escapeHtml(truncated)}</div>
      ${mediaHtml}
      <div class="post-stats"><div>${starCount} ⭐ • ${responses.length} responses</div></div>

      <div class="post-actions">
        <button class="action-btn ${userStarred?'active':''}" data-action="star" onclick="window.toggleStar('${id}')"><i class="fas fa-star"></i>&nbsp;Star</button>
        <button class="action-btn" onclick="focusRespond('${id}')"><i class="fas fa-comment"></i>&nbsp;Respond</button>
        <button class="action-btn" onclick="promoteMeetCast('${id}')"><i class="fas fa-bullhorn"></i>&nbsp;Promote</button>
      </div>

      <div class="comments-section">
        ${responsesHtml}
        ${responses.length > 2 ? `<div class="view-more-comments" onclick="openResponsesModal('${id}')">View ${responses.length - 2} more responses</div>` : ''}
        <div class="comment-input"><div class="user-avatar">${(currentUser && currentUser.displayName) ? currentUser.displayName.charAt(0).toUpperCase() : 'U'}</div>
          <input type="text" id="respond-${id}" placeholder="Write a response..." onkeypress="handleRespondKeypress(event,'${id}')">
          <button class="send-comment-btn" onclick="sendResponseBtn('${id}')"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    `;

    if(postEl){
      postEl.innerHTML = inner;
    } else {
      postEl = document.createElement('div');
      postEl.className = 'post';
      postEl.setAttribute('data-post-id', id);
      postEl.innerHTML = inner;
      // insert at end (feed already ordered by timestamp)
      postsContainer.appendChild(postEl);
    }
  }
}

/* -------------------------
   Helpers: UI small features
   ------------------------- */
function escapeHtml(text){ if(!text) return ''; const d = document.createElement('div'); d.textContent = text; return d.innerHTML; }
function formatTimestamp(ts){ if(!ts) return 'Just now'; try{ const d = ts.toDate(); const diff = Date.now() - d.getTime(); const mins = Math.floor(diff/60000); if(mins<1) return 'Just now'; if(mins<60) return mins+'m ago'; const hrs = Math.floor(mins/60); if(hrs<24) return hrs+'h ago'; const days = Math.floor(hrs/24); if(days<7) return days+'d ago'; return d.toLocaleDateString(); } catch(e){ return 'Just now'; } }

/* -------------------------
   Inline actions wired to window for onclick usage
   ------------------------- */
window.toggleStar = (id) => toggleStar(id);
window.handleRespondKeypress = (e,postId) => { if(e.key === 'Enter') sendResponseBtn(postId); };
window.sendResponseBtn = async (postId) => {
  const el = document.getElementById(`respond-${postId}`);
  if(!el) return;
  const txt = el.value.trim();
  if(!txt) return;
  await addResponse(postId, txt);
  el.value = '';
};
window.promoteMeetCast = (id) => {
  // simple native share or fallback
  if(navigator.share){ navigator.share({ title:'Check this MeetCast on MEET', text:'See this MeetCast', url:window.location.href }); }
  else { showMessage('Promoted!', 'success'); }
};
window.viewProfile = (uid) => { sessionStorage.setItem('targetUserId', uid); window.location.href = 'profile.html'; };
window.openResponsesModal = async (postId) => {
  // load responses and show modal (simple alert for now)
  const snaps = await getDocs(query(collection(db,'posts',postId,'responses'), orderBy('timestamp','asc')));
  const r = snaps.docs.map(d => d.data()).map(x => `${x.userName||'User'}: ${x.text}`).join('\n\n');
  alert('Responses:\\n\\n' + r);
};
window.editMeetCast = (id) => showMessage('Edit MeetCast coming soon', 'success');
window.deleteMeetCast = async (id) => {
  if(!confirm('Delete this MeetCast?')) return;
  try{ await deleteDoc(doc(db,'posts',id)); showMessage('MeetCast deleted','success'); } catch(e){ console.error(e); showMessage('Delete failed'); }
};
window.openMediaModal = (url,isVideo=false) => {
  const mediaModal = document.getElementById('mediaModal');
  if(!mediaModal) {
    // create simple modal on-the-fly
    const modal = document.createElement('div'); modal.className='modal'; modal.style.display='flex';
    const content = document.createElement('div'); content.className='modal-content';
    content.innerHTML = isVideo ? `<video controls src="${url}" style="width:100%"></video>` : `<img src="${url}" style="width:100%"/>`;
    modal.appendChild(content);
    modal.addEventListener('click', (e)=> { if(e.target===modal) modal.remove(); });
    document.body.appendChild(modal);
  }
};

/* -------------------------
   Composer UI wiring
   ------------------------- */
openComposer.addEventListener('click', ()=> { meetcastModal.style.display='flex'; document.body.style.overflow='hidden'; });
newMeetCastBtn.addEventListener('click', ()=> { meetcastModal.style.display='flex'; document.body.style.overflow='hidden'; });
closeMeetcastModal.addEventListener('click', ()=> { meetcastModal.style.display='none'; document.body.style.overflow='auto'; resetMeetcastForm(); });

meetcastMedia.addEventListener('change', (e) => {
  // preview
  const files = [...e.target.files];
  mediaPreview.innerHTML = '';
  for(const file of files){
    const reader = new FileReader();
    reader.onload = (ev) => {
      const isVideo = file.type.startsWith('video/');
      const wrapper = document.createElement('div');
      wrapper.style.marginBottom = '8px';
      wrapper.innerHTML = isVideo ? `<video controls style="max-width:100%;height:160px;object-fit:cover" src="${ev.target.result}"></video>` : `<img src="${ev.target.result}" style="max-width:100%;height:160px;object-fit:cover"/>`;
      mediaPreview.appendChild(wrapper);
    };
    reader.readAsDataURL(file);
  }
});

publishMeetcastBtn.addEventListener('click', async () => {
  const text = meetcastText.value.trim();
  const files = Array.from(meetcastMedia.files || []);
  const privacy = document.getElementById('meetcastPrivacy').value;
  if(!text && files.length === 0){ showMessage('Add text or media to your MeetCast'); return; }
  publishMeetcastBtn.disabled = true;
  publishMeetcastBtn.textContent = 'Publishing...';
  try{
    await createMeetCast(text, files, privacy);
    showMessage('MeetCast published', 'success');
    meetcastModal.style.display='none';
    resetMeetcastForm();
  } catch(e){
    console.error(e);
    showMessage('Failed to publish MeetCast');
  } finally {
    publishMeetcastBtn.disabled = false;
    publishMeetcastBtn.textContent = 'Publish MeetCast';
  }
});

function resetMeetcastForm(){ meetcastText.value=''; meetcastMedia.value=''; mediaPreview.innerHTML=''; }

/* -------------------------
   AI widget wiring (client -> server)
   - This calls a backend route /api/ai/suggest (implement server-side securely)
   ------------------------- */
openAiBtn.addEventListener('click', ()=>{ aiModal.style.display='flex'; document.body.style.overflow='hidden'; });
closeAiModal.addEventListener('click', ()=>{ aiModal.style.display='none'; document.body.style.overflow='auto'; aiResult.innerHTML=''; aiPrompt.value=''; });

askAiBtn.addEventListener('click', async ()=> {
  const prompt = aiPrompt.value.trim();
  if(!prompt) return showMessage('Type something for AI to help with');
  askAiBtn.disabled = true; askAiBtn.textContent='Thinking...';
  try{
    // Replace '/api/ai/suggest' with your serverless function endpoint
    const resp = await fetch('/api/ai/suggest', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ prompt })});
    if(!resp.ok) throw new Error('AI request failed');
    const json = await resp.json();
    aiResult.innerHTML = `<div style="white-space:pre-wrap">${escapeHtml(json.result || JSON.stringify(json))}</div>`;
  } catch(err){ console.error(err); showMessage('AI request failed'); }
  finally{ askAiBtn.disabled=false; askAiBtn.textContent='Ask AI'; }
});

/* -------------------------
   Auth listener
   ------------------------- */
onAuthStateChanged(auth, user => {
  if(!user){ window.location.href = 'login.html'; return; }
  currentUser = user;
  // update avatars
  const setAvatar = (el, u) => {
    if(!el) return;
    if(u.photoURL) el.innerHTML = `<img src="${u.photoURL}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
    else el.textContent = (u.displayName && u.displayName.charAt(0)) ? u.displayName.charAt(0).toUpperCase() : 'U';
  };
  setAvatar(currentUserAvatar, user);
  setAvatar(modalAvatar, user);
  setAvatar(composerAvatar, user);
  document.getElementById('userName').textContent = user.displayName || 'User';
  // start feed
  setupRealtimeFeed();
});

logoutBtn.addEventListener('click', async ()=> { try{ await signOut(auth); window.location.href='login.html'; } catch(e){ console.error(e); showMessage('Logout failed'); } });

/* -------------------------
   Init
   ------------------------- */
document.addEventListener('DOMContentLoaded', ()=> {
  initTheme();
});
</script>
</body>
</html>
