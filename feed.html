<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MEET Feed</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<style>
  :root {
    --primary: #007bff;
    --secondary-text: #666;
    --bg: #f9f9f9;
    --post-bg: #fff;
  }
  body { font-family: Arial, sans-serif; background: var(--bg); margin:0; padding:0; }
  .posts-container { max-width: 700px; margin: 0 auto; padding: 20px; }
  .post { background: var(--post-bg); margin-bottom: 20px; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
  .post-header { display: flex; justify-content: space-between; }
  .post-user { display: flex; gap:10px; }
  .user-avatar { width: 50px; height: 50px; border-radius: 50%; overflow: hidden; flex-shrink:0; display:flex; align-items:center; justify-content:center; background:#ddd; font-weight:600; color:#555; cursor:pointer; }
  .post-content { margin-top: 10px; font-size:16px; }
  .post-media { margin-top:10px; cursor:pointer; }
  .post-media img, .post-media video { width:100%; border-radius:10px; object-fit:cover; }
  .post-interactions { display:flex; gap:10px; margin-top:10px; }
  .interaction-btn { cursor:pointer; display:flex; align-items:center; gap:5px; color:var(--secondary-text); }
  .interaction-btn.active { color:var(--primary); font-weight:600; }
  .comments-section { margin-top:10px; }
  .comment { display:flex; gap:10px; margin-bottom:8px; }
  .comment-content { flex:1; font-size:14px; }
  .comment-input { display:flex; gap:5px; margin-top:10px; }
  .comment-input input { flex:1; padding:5px 10px; border-radius:20px; border:1px solid #ccc; }
  .comment-input button { border:none; background:var(--primary); color:#fff; border-radius:50%; width:32px; height:32px; cursor:pointer; display:flex; align-items:center; justify-content:center;}
  .read-more, .read-less { color: var(--primary); cursor:pointer; font-weight:600; }
  .view-more-comments { font-size:13px; color:var(--primary); cursor:pointer; }
  /* Modal */
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:1000; }
  .modal-content { background:#fff; padding:20px; border-radius:10px; max-width:90%; max-height:90%; overflow:auto; }
  .post-menu { display:none; position:absolute; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.2); border-radius:8px; top:30px; right:0; z-index:10; }
  .post-menu-item { padding:8px 12px; cursor:pointer; display:flex; gap:5px; align-items:center; }
  .post-menu-item.delete { color:red; }
</style>
</head>
<body>
<div class="posts-container" id="postsContainer"></div>

<!-- Comments Modal -->
<div class="modal" id="commentsModal">
  <div class="modal-content" id="commentsModalBody"></div>
</div>

<!-- Media Modal -->
<div class="modal" id="mediaModal" onclick="closeMediaModal()">
  <img id="mediaModalImage" style="display:none; max-width:100%; max-height:100%; border-radius:10px;" />
  <video id="mediaModalVideo" style="display:none; max-width:100%; max-height:100%;" controls></video>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, getDocs, query, orderBy, onSnapshot, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

  // Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
    authDomain: "meet-6e159.firebaseapp.com",
    databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",
    projectId: "meet-6e159",
    storageBucket: "meet-6e159.firebasestorage.app",
    messagingSenderId: "252353608421",
    appId: "1:252353608421:web:6706056048e9a8f12db20c",
    measurementId: "G-9BFPPVMMRF"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const rtdb = getDatabase(app);

  // Cloudinary
  const CLOUDINARY_CLOUD_NAME = 'dcwof2ngn';
  const CLOUDINARY_UPLOAD_PRESET = 'Meet_video';
  const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`;

  const postsContainer = document.getElementById('postsContainer');
  const commentsModal = document.getElementById('commentsModal');
  const commentsModalBody = document.getElementById('commentsModalBody');
  const mediaModal = document.getElementById('mediaModal');
  const mediaModalImage = document.getElementById('mediaModalImage');
  const mediaModalVideo = document.getElementById('mediaModalVideo');

  let currentUser = null;

  onAuthStateChanged(auth, user => {
    if(user) currentUser = user;
    initFeed();
    initAssociates();
  });

  // Escape HTML
  function escapeHtml(text){ if(!text) return ''; const div=document.createElement('div'); div.textContent=text; return div.innerHTML; }

  // Timestamp
  function formatTimestamp(ts){
    if(!ts) return 'Just now';
    const date = ts.toDate();
    const now = new Date();
    const diff = now-date;
    const minutes = Math.floor(diff/60000), hours=Math.floor(diff/3600000), days=Math.floor(diff/86400000);
    if(minutes<1) return 'Just now';
    if(minutes<60) return `${minutes}m ago`;
    if(hours<24) return `${hours}h ago`;
    if(days<7) return `${days}d ago`;
    return date.toLocaleDateString();
  }

  // Feed
  async function initFeed(){
    const postsRef = collection(db,'posts');
    const q = query(postsRef, orderBy('timestamp','desc'));
    onSnapshot(q, snapshot=>{
      postsContainer.innerHTML='';
      snapshot.docs.forEach(docSnap=>{
        const data=docSnap.data();
        const id=docSnap.id;
        renderPost(id,data);
      });
    });
  }

  async function toggleStar(postId){
    if(!currentUser) return;
    const starRef = doc(db,'posts',postId,'stars',currentUser.uid);
    const starSnap = await getDocs(starRef);
    try{
      const docRef = doc(db,'posts',postId,'stars',currentUser.uid);
      const docSnap = await getDocs(docRef);
      if(docSnap.exists()) await deleteDoc(docRef);
      else await setDoc(docRef,{userId:currentUser.uid,timestamp:serverTimestamp()});
    }catch(e){console.error(e);}
  }

  async function addComment(postId,text){
    if(!currentUser || !text) return;
    await addDoc(collection(db,'posts',postId,'comments'),{
      text,text,
      userId:currentUser.uid,
      userName:currentUser.displayName || 'User',
      userPhotoURL:currentUser.photoURL || '',
      timestamp:serverTimestamp()
    });
  }

  function openCommentsModal(postId){
    const commentsRef = collection(db,'posts',postId,'comments');
    const q = query(commentsRef, orderBy('timestamp','asc'));
    onSnapshot(q,snapshot=>{
      let html='';
      snapshot.docs.forEach(docSnap=>{
        const c = docSnap.data();
        html+=`<div class="comment">
          <div class="user-avatar" style="width:32px;height:32px;font-size:14px;" onclick="viewProfile('${c.userId}')">
            ${c.userPhotoURL?`<img src="${c.userPhotoURL}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`:c.userName.charAt(0)}
          </div>
          <div class="comment-content"><b>${c.userName}</b>: ${escapeHtml(c.text)}</div>
        </div>`;
      });
      commentsModalBody.innerHTML=html;
      commentsModal.style.display='flex';
    });
  }

  function closeMediaModal(){ mediaModal.style.display='none'; mediaModalVideo.pause(); }

  function openMediaModal(url,isVideo=false){
    if(isVideo){ mediaModalImage.style.display='none'; mediaModalVideo.style.display='block'; mediaModalVideo.src=url; }
    else{ mediaModalVideo.style.display='none'; mediaModalImage.style.display='block'; mediaModalImage.src=url; }
    mediaModal.style.display='flex';
  }

  function renderPost(id,data){
    const postEl=document.createElement('div'); postEl.classList.add('post');
    const userAvatar = data.userPhotoURL?`<img src="${data.userPhotoURL}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`:data.userName.charAt(0);
    let postContentHtml='';
    const maxLength=200;
    if(data.text && data.text.length>maxLength){
      postContentHtml=`<div class="post-text-truncated">${escapeHtml(data.text.substring(0,maxLength))}... <span class="read-more" onclick="toggleReadMore(this)">Read more</span></div>
      <div class="post-text-full" style="display:none;">${escapeHtml(data.text)} <span class="read-less" onclick="toggleReadLess(this)"> Read less</span></div>`;
    } else postContentHtml=escapeHtml(data.text||'');
    
    let mediaHtml='';
    if(data.media && data.media.length>0){
      if(data.media.length===1){
        const isVideo = data.media[0].match(/\.(mp4|mov|avi|webm)$/i);
        mediaHtml=`<div class="post-media" onclick="openMediaModal('${data.media[0]}',${isVideo})">${isVideo?`<video controls src="${data.media[0]}"></video>`:`<img src="${data.media[0]}">`}</div>`;
      } else {
        mediaHtml='<div class="post-media" style="display:grid;grid-template-columns:1fr 1fr;gap:5px;">';
        data.media.forEach(m=>{
          const isVideo = m.match(/\.(mp4|mov|avi|webm)$/i);
          mediaHtml+=`<div onclick="openMediaModal('${m}',${isVideo})" style="cursor:pointer;">${isVideo?`<video style="width:100%;height:200px;object-fit:cover;" src="${m}"></video>`:`<img style="width:100%;height:200px;object-fit:cover;" src="${m}">`}</div>`;
        });
        mediaHtml+='</div>';
      }
    }

    const postInnerHTML=`<div class="post-header">
      <div class="post-user" onclick="viewProfile('${data.userId}')">
        <div class="user-avatar">${userAvatar}</div>
        <div><div class="user-name" style="color:var(--primary); cursor:pointer;">${data.userName||'Anonymous'}</div>
        <div class="post-meta">${formatTimestamp(data.timestamp)} ‚Ä¢ ${data.privacy==='public'?'üåç Public':data.privacy==='friends'?'üë• Associates':'üîí Only Me'}</div></div>
      </div>
    </div>
    <div class="post-content">${postContentHtml}</div>
    ${mediaHtml}
    <div class="post-interactions">
      <div class="interaction-btn" onclick="toggleStar('${id}')"><i class="fas fa-star"></i> Star</div>
      <div class="interaction-btn" onclick="focusComment('${id}')"><i class="fas fa-comment"></i> Comment</div>
      <div class="interaction-btn" onclick="promotePost('${id}')"><i class="fas fa-share"></i> Promote</div>
    </div>
    <div class="comments-section">
      <div class="view-more-comments" onclick="openCommentsModal('${id}')">View Comments</div>
      <div class="comment-input">
        <div class="user-avatar">${currentUser?currentUser.displayName.charAt(0):'U'}</div>
        <input type="text" placeholder="Write a comment..." onkeypress="handleCommentKeypress(event,'${id}')">
        <button onclick="addCommentFromInput('${id}')"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>`;
    postEl.innerHTML=postInnerHTML;
    postsContainer.appendChild(postEl);
  }

  window.toggleReadMore=(el)=>{ el.parentElement.style.display='none'; el.parentElement.nextElementSibling.style.display='block'; }
  window.toggleReadLess=(el)=>{ el.parentElement.style.display='none'; el.parentElement.previousElementSibling.style.display='block'; }

  window.focusComment=(postId)=>{ const inp=document.querySelector(`#postsContainer input[onkeypress*='${postId}']`); if(inp) inp.focus(); }
  window.handleCommentKeypress=async (e,postId)=>{ if(e.key==='Enter') await addCommentFromInput(postId); }
  window.addCommentFromInput=async(postId)=>{
    const input=document.querySelector(`#postsContainer input[onkeypress*='${postId}']`);
    if(!input || !input.value.trim()) return;
    await addComment(postId,input.value.trim());
    input.value='';
  }

  function viewProfile(uid){ sessionStorage.setItem('targetUserId',uid); window.location.href='profile.html'; }
  function promotePost(id){ alert('Post promoted!'); }

  // --- ASSOCIATES (FOLLOW/FOLLOWING) ---
  async function initAssociates(){
    const associatesRef = collection(db,'associates');
    onSnapshot(associatesRef, snapshot=>{
      snapshot.docs.forEach(doc=>{ /* handle follow/unfollow updates */ });
    });
  }

  // Placeholder AI integration
  function initAI(){ console.log('AI module placeholder'); }
</script>
</body>
</html>
