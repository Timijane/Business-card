<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MEET | Feed</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Your existing CSS styles ... */
        /* (The CSS styles remain the same) */
    </style>
</head>
<body>

<div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2 style="color: white;">MEET</h2>
        </div>
        <ul class="sidebar-menu">
            <li><a href="feed.html" onclick="loadPage('feed')"><i class="fas fa-home"></i> <span>Feed</span></a></li>
            <li><a href="profile.html" onclick="goToMyProfile()"><i class="fas fa-user"></i> <span>Profile</span></a></li>
            <li><a href="chat.html" onclick="goToChat()"><i class="fas fa-comment"></i> <span>Chat</span></a></li>
            <li><a href="meetrader.html"><i class="fas fa-chart-line"></i> <span>Meetrader</span></a></li>
            <li><a href="meetversity.html"><i class="fas fa-graduation-cap"></i> <span>Meetversity</span></a></li>
            <li><a href="organization.html"><i class="fas fa-sitemap"></i> <span>Organization</span></a></li>
            <li><a href="#" onclick="openUsersModal()"><i class="fas fa-users"></i> <span>Find Associates</span></a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Navbar -->
        <div class="navbar">
            <h2 style="color: white;">MEET Feed</h2>
            <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search..." id="searchInput">
                </div>
                <div class="nav-controls">
                    <div class="user-profile-nav">
                        <div class="user-avatar small" id="currentUserAvatar">
                            U
                            <div class="status-indicator status-online"></div>
                        </div>
                        <span id="userName">User</span>
                    </div>
                    <button class="btn" id="nightToggleBtn">
                        <i class="fas fa-moon"></i> <span>Night Mode</span>
                    </button>
                    <button class="btn" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Post Composer -->
        <div class="post-composer">
            <div class="composer-header">
                <div class="user-avatar" id="currentUserAvatarComposer">
                    U
                    <div class="status-indicator status-online"></div>
                </div>
                <div class="composer-input" id="openComposer">
                    What's on your mind?
                </div>
            </div>
            <div class="composer-divider"></div>
            <div class="composer-actions">
                <!-- Removed all action buttons as requested -->
            </div>
        </div>

        <!-- MeetAI Assistant -->
        <div class="meetai-assistant" id="meetaiAssistant">
            <div class="meetai-header">
                <h4>MeetAI Assistant</h4>
                <button class="close-modal" onclick="closeMeetAI()">&times;</button>
            </div>
            <div class="meetai-messages" id="meetaiMessages">
                <div class="meetai-message meetai-bot">
                    Hello! I'm your MeetAI assistant. How can I help you today?
                </div>
            </div>
            <div class="meetai-input">
                <input type="text" id="meetaiInput" placeholder="Ask me anything...">
                <button class="send-comment-btn" onclick="sendMeetAIMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <!-- MeetAI Button -->
        <div class="meetai-button" onclick="toggleMeetAI()">
            <span>M</span>
        </div>

        <!-- Messages -->
        <div id="messageContainer"></div>

        <!-- Posts Container -->
        <div class="posts" id="postsContainer">
            <div class="loading">Loading posts...</div>
        </div>
    </div>
</div>

<!-- Post Modal -->
<div class="modal" id="postModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create Meetcast</h3>
            <button class="close-modal" id="closeModal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="post-form">
                <div class="post-user-info">
                    <div class="user-avatar" id="modalUserAvatar">
                        U
                        <div class="status-indicator status-online"></div>
                    </div>
                    <div>
                        <div class="user-name" id="modalUserName">User Name</div>
                        <select id="privacy" style="border: none; background: var(--bg-color); color: var(--text-color); padding: 4px 8px; border-radius: 4px; font-size: 14px;">
                            <option value="public">üåç Public</option>
                            <option value="friends">üë• Friends</option>
                            <option value="private">üîí Only Me</option>
                        </select>
                    </div>
                </div>
                <textarea class="post-textarea" id="postText" placeholder="What's on your mind?"></textarea>
                <div class="media-preview" id="mediaPreview"></div>
                <div class="post-options">
                    <div style="color: var(--secondary-text);">Add to your meetcast</div>
                    <div style="display: flex; gap: 8px;">
                        <input type="file" id="postMedia" accept="image/*,video/*" style="display: none;" multiple>
                        <div class="action-btn" onclick="document.getElementById('postMedia').click()">
                            <i class="fas fa-images" style="color: #45bd62;"></i>
                        </div>
                        <div class="action-btn">
                            <i class="fas fa-user-tag" style="color: #1877f2;"></i>
                        </div>
                        <div class="action-btn">
                            <i class="fas fa-laugh" style="color: #f7b928;"></i>
                        </div>
                        <div class="action-btn">
                            <i class="fas fa-map-marker-alt" style="color: #f5533d;"></i>
                        </div>
                    </div>
                </div>
                <button class="btn" id="postBtn" style="background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);">
                    <span id="postBtnText">Meetcast</span>
                    <span id="postBtnSpinner" class="spinner" style="display: none;"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Users Modal -->
<div class="modal" id="usersModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Find Associates</h3>
            <button class="close-modal" id="closeUsersModal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="users-list" id="usersList">
                <div class="loading">Loading users...</div>
            </div>
        </div>
    </div>
</div>

<!-- Comments Modal -->
<div class="comments-modal" id="commentsModal">
    <div class="comments-modal-content">
        <div class="comments-modal-header">
            <h3>Responses</h3>
            <button class="close-modal" id="closeCommentsModal">&times;</button>
        </div>
        <div class="comments-modal-body" id="commentsModalBody">
            <!-- Comments will be loaded here -->
        </div>
    </div>
</div>

<!-- Media Modal -->
<div class="media-modal" id="mediaModal">
    <div class="media-modal-content">
        <button class="close-media-modal" id="closeMediaModal">&times;</button>
        <img id="mediaModalImage" src="" alt="Enlarged media">
        <video id="mediaModalVideo" controls style="display: none;">
            Your browser does not support the video tag.
        </video>
    </div>
</div>

<script type="module">
    // Firebase imports
    import { 
        getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDoc, getDocs, onSnapshot, serverTimestamp, 
        query, orderBy, where, setDoc, arrayUnion, arrayRemove
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
        authDomain: "meet-6e159.firebaseapp.com",
        databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",
        projectId: "meet-6e159",
        storageBucket: "meet-6e159.firebasestorage.app",
        messagingSenderId: "252353608421",
        appId: "1:252353608421:web:6706056048e9a8f12db20c",
        measurementId: "G-9BFPPVMMRF"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Cloudinary configuration for media uploads
    const CLOUDINARY_CLOUD_NAME = 'dcwof2ngn';
    const CLOUDINARY_API_KEY = '767477973776429';
    const CLOUDINARY_API_SECRET = '3n8OO8MaqD6SZN-AGnLaIIulGW0';
    const CLOUDINARY_UPLOAD_PRESET = 'Meet_video';
    const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`;

    // File size limits
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

    // DOM elements
    const postsContainer = document.getElementById('postsContainer');
    const postBtn = document.getElementById('postBtn');
    const postText = document.getElementById('postText');
    const postMedia = document.getElementById('postMedia');
    const privacySelect = document.getElementById('privacy');
    const logoutBtn = document.getElementById('logoutBtn');
    const messageContainer = document.getElementById('messageContainer');
    const nightToggleBtn = document.getElementById('nightToggleBtn');
    const postModal = document.getElementById('postModal');
    const openComposer = document.getElementById('openComposer');
    const closeModal = document.getElementById('closeModal');
    const mediaPreview = document.getElementById('mediaPreview');
    const currentUserAvatar = document.getElementById('currentUserAvatar');
    const currentUserAvatarComposer = document.getElementById('currentUserAvatarComposer');
    const modalUserAvatar = document.getElementById('modalUserAvatar');
    const modalUserName = document.getElementById('modalUserName');
    const userName = document.getElementById('userName');
    const usersModal = document.getElementById('usersModal');
    const usersList = document.getElementById('usersList');
    const closeUsersModal = document.getElementById('closeUsersModal');
    const searchInput = document.getElementById('searchInput');

    // MeetAI Assistant elements
    const meetaiAssistant = document.getElementById('meetaiAssistant');
    const meetaiMessages = document.getElementById('meetaiMessages');
    const meetaiInput = document.getElementById('meetaiInput');

    // Modal elements
    const commentsModal = document.getElementById('commentsModal');
    const closeCommentsModal = document.getElementById('closeCommentsModal');
    const commentsModalBody = document.getElementById('commentsModalBody');
    const mediaModal = document.getElementById('mediaModal');
    const closeMediaModal = document.getElementById('closeMediaModal');
    const mediaModalImage = document.getElementById('mediaModalImage');
    const mediaModalVideo = document.getElementById('mediaModalVideo');

    // Global variables
    let currentUser = null;
    let postListeners = {};
    let allUsers = [];

    // Theme management
    function initTheme() {
        const savedTheme = localStorage.getItem('meet_theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            nightToggleBtn.innerHTML = '<i class="fas fa-sun"></i> <span>Day Mode</span>';
        } else {
            document.body.classList.remove('dark-mode');
            nightToggleBtn.innerHTML = '<i class="fas fa-moon"></i> <span>Night Mode</span>';
        }
    }

    // Message display
    function showMessage(message, type = 'error') {
        messageContainer.innerHTML = `<div class="${type === 'success' ? 'success-message' : 'error-message'}">${message}</div>`;
        setTimeout(() => { messageContainer.innerHTML = ''; }, 5000);
    }

    // Loading state
    function setLoading(buttonId, isLoading) {
        const button = document.getElementById(buttonId);
        const text = button.querySelector('span:first-child');
        const spinner = button.querySelector('.spinner');

        if (isLoading) {
            button.disabled = true;
            text.style.display = 'none';
            spinner.style.display = 'inline-block';
        } else {
            button.disabled = false;
            text.style.display = 'inline-block';
            spinner.style.display = 'none';
        }
    }

    // Upload media to Cloudinary
    async function uploadMedia(file) {
        if (file.size > MAX_FILE_SIZE) {
            throw new Error('File size too large. Maximum 10MB.');
        }

        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
        formData.append("api_key", CLOUDINARY_API_KEY);

        try {
            const response = await fetch(CLOUDINARY_URL, {
                method: "POST",
                body: formData,
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'Upload failed. Please try again.');
            }

            const data = await response.json();
            return data.secure_url;
        } catch (error) {
            console.error('Cloudinary upload error:', error);
            throw new Error('Failed to upload media. Please try again.');
        }
    }

    // CREATE POST (Now called Meetcast)
    async function createPost(text, files, privacy) {
        const user = auth.currentUser;
        if (!user) throw new Error("Please login first!");

        // Get user data from Firestore to ensure we have profile picture
        const userDoc = await getDoc(doc(db, "users", user.uid));
        const userData = userDoc.exists() ? userDoc.data() : {};

        let mediaUrls = [];
        if (files && files.length > 0) {
            for (let file of files) {
                const mediaUrl = await uploadMedia(file);
                mediaUrls.push(mediaUrl);
            }
        }

        await addDoc(collection(db, "posts"), {
            userId: user.uid,
            userName: user.displayName || "Anonymous",
            userInitial: user.displayName?.charAt(0).toUpperCase() || "U",
            userPhotoURL: userData.photoURL || user.photoURL || null,
            text: text,
            media: mediaUrls,
            privacy: privacy,
            timestamp: serverTimestamp(),
        });
    }

    // TOGGLE STAR - COMPLETELY FIXED
    async function toggleStar(postId) {
        try {
            const user = auth.currentUser;
            if (!user) {
                throw new Error("Please login to star posts.");
            }

            const starRef = doc(db, "posts", postId, "likes", user.uid);
            const starSnap = await getDoc(starRef);

            if (starSnap.exists()) {
                // Unstar: remove the star document
                await deleteDoc(starRef);
                return false;
            } else {
                // Star: create a star document
                await setDoc(starRef, {
                    userId: user.uid,
                    userName: user.displayName || "Anonymous",
                    userPhotoURL: user.photoURL || null,
                    timestamp: serverTimestamp()
                });
                return true;
            }
        } catch (error) {
            console.error("Error in toggleStar:", error);
            throw error;
        }
    }

    // ADD RESPONSE (formerly comment)
    async function addResponse(postId, responseText) {
        const user = auth.currentUser;
        if (!user || !responseText.trim()) return;

        // Get user data from Firestore to ensure we have profile picture
        const userDoc = await getDoc(doc(db, "users", user.uid));
        const userData = userDoc.exists() ? userDoc.data() : {};

        const responsesRef = collection(db, "posts", postId, "comments");

        await addDoc(responsesRef, {
            userId: user.uid,
            userName: user.displayName || "Anonymous",
            userInitial: user.displayName?.charAt(0).toUpperCase() || "U",
            userPhotoURL: userData.photoURL || user.photoURL || null,
            text: responseText,
            timestamp: serverTimestamp()
        });
    }

    // DELETE POST
    async function deletePost(postId) {
        if (!confirm('Are you sure you want to delete this meetcast?')) return;

        try {
            await deleteDoc(doc(db, "posts", postId));
            showMessage('Meetcast deleted successfully!', 'success');
        } catch (error) {
            console.error('Error deleting meetcast:', error);
            showMessage('Failed to delete meetcast. Please try again.');
        }
    }

    // ASSOCIATION SYSTEM - COMPLETELY FIXED
    async function associateWithUser(userIdToAssociate) {
        const user = auth.currentUser;
        if (!user || user.uid === userIdToAssociate) return;

        try {
            // Ensure both users have documents in Firestore
            await ensureUserDocument(user.uid);
            await ensureUserDocument(userIdToAssociate);

            // Add to current user's associates
            const associateRef = doc(db, "users", user.uid, "associates", userIdToAssociate);
            await setDoc(associateRef, {
                timestamp: serverTimestamp()
            });

            // Add to target user's associatedWith
            const associatedWithRef = doc(db, "users", userIdToAssociate, "associatedWith", user.uid);
            await setDoc(associatedWithRef, {
                timestamp: serverTimestamp()
            });

            showMessage('You are now associates!', 'success');
            return true;
        } catch (error) {
            console.error('Error associating with user:', error);
            showMessage('Failed to associate with user. Please try again.');
            return false;
        }
    }

    async function removeAssociation(userIdToRemove) {
        const user = auth.currentUser;
        if (!user) return;

        try {
            // Remove from current user's associates
            const associateRef = doc(db, "users", user.uid, "associates", userIdToRemove);
            await deleteDoc(associateRef);

            // Remove from target user's associatedWith
            const associatedWithRef = doc(db, "users", userIdToRemove, "associatedWith", user.uid);
            await deleteDoc(associatedWithRef);

            showMessage('Association removed.', 'success');
            return true;
        } catch (error) {
            console.error('Error removing association:', error);
            showMessage('Failed to remove association. Please try again.');
            return false;
        }
    }

    async function checkIfAssociated(userId) {
        const user = auth.currentUser;
        if (!user || user.uid === userId) return false;

        try {
            const associateRef = doc(db, "users", user.uid, "associates", userId);
            const associateSnap = await getDoc(associateRef);
            return associateSnap.exists();
        } catch (error) {
            console.error('Error checking association:', error);
            return false;
        }
    }

    // Ensure user document exists in Firestore
    async function ensureUserDocument(userId) {
        try {
            const userDocRef = doc(db, "users", userId);
            const userDocSnap = await getDoc(userDocRef);

            if (!userDocSnap.exists()) {
                // Get user data from auth if available
                const authUser = auth.currentUser;
                let userData = {
                    displayName: "User",
                    email: "",
                    photoURL: null,
                    createdAt: serverTimestamp()
                };

                if (authUser && authUser.uid === userId) {
                    userData = {
                        displayName: authUser.displayName || "User",
                        email: authUser.email || "",
                        photoURL: authUser.photoURL || null,
                        createdAt: serverTimestamp()
                    };
                }

                await setDoc(userDocRef, userData);
                console.log("Created user document for:", userId);
            }

            return true;
        } catch (error) {
            console.error("Error ensuring user document:", error);
            return false;
        }
    }

    // GET ALL USERS FOR ASSOCIATION - FIXED
    async function getAllUsers() {
        try {
            const usersRef = collection(db, "users");
            const usersSnap = await getDocs(usersRef);
            const users = [];

            usersSnap.forEach(doc => {
                if (doc.id !== currentUser.uid) {
                    users.push({ id: doc.id, ...doc.data() });
                }
            });

            return users;
        } catch (error) {
            console.error('Error getting users:', error);
            showMessage('Failed to load users. Please try again.');
            return [];
        }
    }

    // CREATE USER DOCUMENT IF NOT EXISTS
    async function createUserDocument(user) {
        try {
            const userDocRef = doc(db, "users", user.uid);
            const userDocSnap = await getDoc(userDocRef);

            if (!userDocSnap.exists()) {
                await setDoc(userDocRef, {
                    displayName: user.displayName || "User",
                    email: user.email || "",
                    photoURL: user.photoURL || null,
                    createdAt: serverTimestamp()
                });
                console.log("User document created for:", user.uid);
            } else {
                // Update user document if profile has changed
                const existingData = userDocSnap.data();
                if (existingData.displayName !== user.displayName || existingData.photoURL !== user.photoURL) {
                    await updateDoc(userDocRef, {
                        displayName: user.displayName || "User",
                        photoURL: user.photoURL || null
                    });
                }
            }
        } catch (error) {
            console.error("Error handling user document:", error);
        }
    }

    // GET USER DATA FOR DISPLAY
    async function getUserData(userId) {
        try {
            const userDoc = await getDoc(doc(db, "users", userId));
            if (userDoc.exists()) {
                return userDoc.data();
            }
            return null;
        } catch (error) {
            console.error("Error getting user data:", error);
            return null;
        }
    }

    // MEETAI ASSISTANT FUNCTIONS
    function toggleMeetAI() {
        if (meetaiAssistant.style.display === 'flex') {
            closeMeetAI();
        } else {
            openMeetAI();
        }
    }

    function openMeetAI() {
        meetaiAssistant.style.display = 'flex';
    }

    function closeMeetAI() {
        meetaiAssistant.style.display = 'none';
    }

    async function sendMeetAIMessage() {
        const message = meetaiInput.value.trim();
        if (!message) return;

        // Add user message
        addMeetAIMessage(message, 'user');
        meetaiInput.value = '';

        // Simulate AI response
        setTimeout(() => {
            const responses = [
                "I understand you're asking about " + message + ". As your MeetAI assistant, I can help you navigate the platform, connect with associates, or optimize your meetcasts.",
                "That's an interesting question about " + message + ". I recommend checking the help section or connecting with experienced associates who can provide guidance.",
                "Based on your query about " + message + ", I suggest exploring similar topics in our community feed or starting a discussion with your associates.",
                "I've analyzed your question regarding " + message + ". The MEET platform offers various tools to help with this - consider using the search feature to find relevant content.",
                "Regarding " + message + ", our AI system can help you connect with users who have similar interests. Would you like me to suggest some potential associates?"
            ];

            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            addMeetAIMessage(randomResponse, 'bot');
        }, 1000);
    }

    function addMeetAIMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `meetai-message meetai-${sender}`;
        messageDiv.textContent = text;
        meetaiMessages.appendChild(messageDiv);
        meetaiMessages.scrollTop = meetaiMessages.scrollHeight;
    }

    // Authentication state listener
    onAuthStateChanged(auth, async user => {
        if (!user) {
            window.location.href = 'login.html';
        } else {
            currentUser = user;

            // Create or update user document in Firestore
            await createUserDocument(user);

            // Update user info in UI with actual profile pictures
            const userData = await getUserData(user.uid);
            const userNameText = userData?.displayName || user.displayName || 'User';
            const userProfilePicture = userData?.photoURL || user.photoURL;
            const userInitial = userNameText.charAt(0).toUpperCase();

            // Function to update avatar with profile picture
            const updateAvatar = (element, initial) => {
                if (userProfilePicture) {
                    element.innerHTML = `<img src="${userProfilePicture}" alt="${userNameText}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;"><div class="status-indicator status-online"></div>`;
                } else {
                    element.innerHTML = `${initial}<div class="status-indicator status-online"></div>`;
                }
            };

            updateAvatar(currentUserAvatar, userInitial);
            updateAvatar(currentUserAvatarComposer, userInitial);
            updateAvatar(modalUserAvatar, userInitial);

            modalUserName.textContent = userNameText;
            userName.textContent = userNameText;

            // Load all users for association
            allUsers = await getAllUsers();

            setupRealTimeListener();
        }
    });

    // Logout functionality
    logoutBtn.addEventListener('click', async () => {
        try {
            await signOut(auth);
            window.location.href = 'login.html';
        } catch (error) {
            console.error('Logout error:', error);
            showMessage('Failed to logout. Please try again.');
        }
    });

    // Theme toggle
    nightToggleBtn.addEventListener('click', () => {
        if (document.body.classList.contains('dark-mode')) {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('meet_theme', 'light');
            nightToggleBtn.innerHTML = '<i class="fas fa-moon"></i> <span>Night Mode</span>';
        } else {
            document.body.classList.add('dark-mode');
            localStorage.setItem('meet_theme', 'dark');
            nightToggleBtn.innerHTML = '<i class="fas fa-sun"></i> <span>Day Mode</span>';
        }
    });

    // Modal controls
    openComposer.addEventListener('click', () => {
        postModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    });

    closeModal.addEventListener('click', () => {
        postModal.style.display = 'none';
        document.body.style.overflow = 'auto';
        resetPostForm();
    });

    // Users modal controls
    window.openUsersModal = async () => {
        usersModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';

        // Load users with association status
        usersList.innerHTML = '<div class="loading">Loading users...</div>';

        try {
            // Refresh users list
            allUsers = await getAllUsers();

            if (allUsers.length === 0) {
                usersList.innerHTML = '<div class="loading">No users found.</div>';
                return;
            }

            const usersHtml = await Promise.all(allUsers.map(async (user) => {
                const isAssociated = await checkIfAssociated(user.id);
                const userAvatar = user.photoURL ?
                    `<img src="${user.photoURL}" alt="${user.displayName || 'User'}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">` :
                    (user.displayName ? user.displayName.charAt(0).toUpperCase() : 'U');

                return `
                    <div class="user-item">
                        <div class="user-info">
                            <div class="user-avatar small">${userAvatar}</div>
                            <div>
                                <div style="font-weight: 600;">${user.displayName || 'User'}</div>
                                <div style="font-size: 14px; color: var(--secondary-text);">${user.email || ''}</div>
                            </div>
                        </div>
                        <button class="association-btn ${isAssociated ? 'associated-btn' : 'associate-btn'}"
                                onclick="${isAssociated ? `removeAssociation('${user.id}')` : `associateWithUser('${user.id}')`}">
                            ${isAssociated ? 'Associated' : 'Associate'}
                        </button>
                    </div>
                `;
            }));

            usersList.innerHTML = usersHtml.join('');
        } catch (error) {
            console.error('Error loading users:', error);
            usersList.innerHTML = '<div class="error-message">Failed to load users. Please try again.</div>';
        }
    };

    closeUsersModal.addEventListener('click', () => {
        usersModal.style.display = 'none';
        document.body.style.overflow = 'auto';
    });

    // Close modal when clicking outside
    postModal.addEventListener('click', (e) => {
        if (e.target === postModal) {
            postModal.style.display = 'none';
            document.body.style.overflow = 'auto';
            resetPostForm();
        }
    });

    usersModal.addEventListener('click', (e) => {
        if (e.target === usersModal) {
            usersModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    });

    // Comments modal controls
    closeCommentsModal.addEventListener('click', () => {
        commentsModal.style.display = 'none';
        document.body.style.overflow = 'auto';
    });

    commentsModal.addEventListener('click', (e) => {
        if (e.target === commentsModal) {
            commentsModal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    });

    // Media modal controls
    closeMediaModal.addEventListener('click', () => {
        mediaModal.style.display = 'none';
        document.body.style.overflow = 'auto';
        mediaModalVideo.pause();
    });

    mediaModal.addEventListener('click', (e) => {
        if (e.target === mediaModal) {
            mediaModal.style.display = 'none';
            document.body.style.overflow = 'auto';
            mediaModalVideo.pause();
        }
    });

    // MeetAI input enter key
    meetaiInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMeetAIMessage();
        }
    });

    // Media preview
    postMedia.addEventListener('change', function(e) {
        const files = e.target.files;
        if (!files || files.length === 0) return;

        mediaPreview.innerHTML = '';

        for (let file of files) {
            if (file.size > MAX_FILE_SIZE) {
                showMessage('File size too large. Maximum 10MB.');
                postMedia.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const isVideo = file.type.startsWith('video/');
                const mediaElement = document.createElement('div');
                mediaElement.style.position = 'relative';
                mediaElement.style.marginBottom = '10px';
                mediaElement.innerHTML = `
                    ${isVideo ? 
                    `<video controls style="width: 100%; max-height: 300px; object-fit: contain; background: var(--bg-color);"><source src="${e.target.result}" type="${file.type}"></video>` : 
                    `<img src="${e.target.result}" alt="Preview" style="width: 100%; max-height: 300px; object-fit: contain; background: var(--bg-color);">`
                    }
                    <button class="remove-media" onclick="this.parentElement.remove()">&times;</button>
                `;
                mediaPreview.appendChild(mediaElement);
            };
            reader.readAsDataURL(file);
        }
    });
    
    function resetPostForm() {
        postText.value = '';
        mediaPreview.innerHTML = '';
        postMedia.value = '';
    }

    // Create post (meetcast)
    postBtn.addEventListener('click', async () => {
        const text = postText.value.trim();
        const mediaFiles = postMedia.files;
        const privacy = privacySelect.value;

        if (!text && (!mediaFiles || mediaFiles.length === 0)) {
            showMessage('Please add some text or media to your meetcast!');
            return;
        }

        if (text.length > 500) {
            showMessage('Meetcast text is too long. Maximum 500 characters.');
            return;
        }

        setLoading('postBtn', true);

        try {
            await createPost(text, mediaFiles, privacy);
            resetPostForm();
            postModal.style.display = 'none';
            document.body.style.overflow = 'auto';
            showMessage('Meetcast created successfully!', 'success');
        } catch (error) {
            console.error('Meetcast creation error:', error);
            showMessage('Failed to create meetcast. Please try again.');
        } finally {
            setLoading('postBtn', false);
        }
    });

    // Setup real-time listener for all posts (sorted by recent)
    const setupRealTimeListener = () => {
        const postsQuery = query(collection(db, "posts"), orderBy("timestamp", "desc"));

        onSnapshot(postsQuery, (snapshot) => {
            // Clean up previous listeners
            Object.values(postListeners).forEach(unsubscribe => unsubscribe());
            postListeners = {};

            postsContainer.innerHTML = "";
            snapshot.docs.forEach((doc) => {
                const post = doc.data();
                setupPostWithRealtimeData(doc.id, post);
            });

            if (snapshot.empty) {
                postsContainer.innerHTML = '<div class="loading">No meetcasts yet. Be the first to post!</div>';
            }
        }, error => {
            console.error('Real-time listener error:', error);
            postsContainer.innerHTML = '<div class="error-message">Failed to load meetcasts. Please refresh the page.</div>';
        });
    };

    // Setup individual post with real-time stars and responses
    async function setupPostWithRealtimeData(postId, postData) {
        const user = auth.currentUser;

        // Set up real-time listener for stars
        const starsQuery = query(collection(db, "posts", postId, "likes"));
        const unsubscribeStars = onSnapshot(starsQuery, (starsSnapshot) => {
            const starCount = starsSnapshot.size;
            const isStarred = starsSnapshot.docs.some(doc => doc.id === user.uid);
            updatePostStarUI(postId, starCount, isStarred);
        });

        // Set up real-time listener for responses
        const responsesQuery = query(collection(db, "posts", postId, "comments"), orderBy("timestamp", "asc"));
        const unsubscribeResponses = onSnapshot(responsesQuery, (responsesSnapshot) => {
            const responses = responsesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updatePostResponsesUI(postId, responses);
        });

        // Store unsubscribe functions
        postListeners[postId] = () => {
            unsubscribeStars();
            unsubscribeResponses();
        };

        // Initial render
        renderPost(postId, postData, 0, false, []);
    }

    // Update post star UI
    function updatePostStarUI(postId, starCount, isStarred) {
        const starBtn = document.querySelector(`[data-post-id="${postId}"] .interaction-btn`);
        const starStats = document.querySelector(`[data-post-id="${postId}"] .post-stats div`);

        if (starBtn) {
            if (isStarred) {
                starBtn.classList.add('active');
            } else {
                starBtn.classList.remove('active');
            }
        }

        if (starStats) {
            const responseCount = document.querySelectorAll(`[data-post-id="${postId}"] .comments-section .comment`).length;
            starStats.textContent = `${starCount} stars ‚Ä¢ ${responseCount} responses`;
        }
    }

    // Update post responses UI
    function updatePostResponsesUI(postId, responses) {
        const commentsSection = document.querySelector(`[data-post-id="${postId}"] .comments-section`);
        if (!commentsSection) return;

        // Show only the last 2 responses
        const displayedResponses = responses.slice(-2);
        const totalResponses = responses.length;

        let responsesHtml = displayedResponses.map(response => {
            const responseAvatar = response.userPhotoURL ? 
                `<img src="${response.userPhotoURL}" alt="${response.userName}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">` : 
                response.userInitial || 'U';
            
            return `
                <div class="comment">
                    <div class="user-avatar" style="width: 32px; height: 32px; font-size: 14px; cursor: pointer;" onclick="viewProfile('${response.userId}')">${responseAvatar}</div>
                    <div class="comment-content">
                        <div style="font-weight: 600; font-size: 14px; cursor: pointer; color: var(--primary);" onclick="viewProfile('${response.userId}')">${response.userName || 'User'}</div>
                        <div>${escapeHtml(response.text)}</div>
                    </div>
                </div>
            `;
        }).join('');

        // Add "View more" button if there are more than 2 responses
        if (totalResponses > 2) {
            responsesHtml += `
                <div class="view-more-comments" onclick="openCommentsModal('${postId}')">
                    View ${totalResponses - 2} more responses
                </div>
            `;
        }

        const existingResponses = commentsSection.querySelectorAll('.comment:not(.comment-input), .view-more-comments');
        existingResponses.forEach(response => response.remove());
        
        const responseInput = commentsSection.querySelector('.comment-input');
        if (responseInput) {
            commentsSection.insertAdjacentHTML('afterbegin', responsesHtml);
        }

        // Update response count in stats
        const statsElement = document.querySelector(`[data-post-id="${postId}"] .post-stats div`);
        if (statsElement) {
            const starCount = document.querySelector(`[data-post-id="${postId}"] .interaction-btn.active`) ? 1 : 0;
            statsElement.textContent = `${starCount} stars ‚Ä¢ ${totalResponses} responses`;
        }
    }

    // Open responses modal
    window.openCommentsModal = async (postId) => {
        const responsesQuery = query(collection(db, "posts", postId, "comments"), orderBy("timestamp", "asc"));
        const responsesSnapshot = await getDocs(responsesQuery);
        const responses = responsesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        let responsesHtml = responses.map(response => {
            const responseAvatar = response.userPhotoURL ? 
                `<img src="${response.userPhotoURL}" alt="${response.userName}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">` : 
                response.userInitial || 'U';
            
            return `
                <div class="comment" style="margin-bottom: 16px;">
                    <div class="user-avatar" style="width: 40px; height: 40px; font-size: 16px; cursor: pointer;" onclick="viewProfile('${response.userId}')">${responseAvatar}</div>
                    <div class="comment-content" style="flex: 1;">
                        <div style="font-weight: 600; font-size: 16px; cursor: pointer; color: var(--primary);" onclick="viewProfile('${response.userId}')">${response.userName || 'User'}</div>
                        <div style="font-size: 16px;">${escapeHtml(response.text)}</div>
                        <div style="font-size: 12px; color: var(--secondary-text); margin-top: 4px;">${formatTimestamp(response.timestamp)}</div>
                    </div>
                </div>
            `;
        }).join('');
        
        commentsModalBody.innerHTML = responsesHtml;
        commentsModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    };

    // Open media modal
    window.openMediaModal = (mediaUrl, isVideo = false) => {
        if (isVideo) {
            mediaModalImage.style.display = 'none';
            mediaModalVideo.style.display = 'block';
            mediaModalVideo.src = mediaUrl;
        } else {
            mediaModalImage.style.display = 'block';
            mediaModalVideo.style.display = 'none';
            mediaModalImage.src = mediaUrl;
        }

        mediaModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    };

    // Check post privacy
    const canViewPost = (post) => {
        const user = auth.currentUser;
        if (!user) return false;

        if (post.privacy === 'public') return true;
        if (post.privacy === 'friends') {
            return true; 
        }
        if (post.privacy === 'private' && post.userId === user.uid) return true;
        return false;
    };

    // Render post with all features
    const renderPost = (id, data, starCount = 0, isStarred = false, responses = []) => {
        const postEl = document.createElement('div');
        postEl.classList.add('post');
        postEl.setAttribute('data-post-id', id);

        const user = auth.currentUser;
        const isOwner = data.userId === user.uid;

        // Use profile picture if available, otherwise fallback to initial
        const userAvatar = data.userPhotoURL ? 
            `<img src="${data.userPhotoURL}" alt="${data.userName}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">` : 
            data.userInitial || 'U';

        // Truncate long posts
        const maxLength = 200;
        let postContentHtml = '';
        if (data.text && data.text.length > maxLength) {
            postContentHtml = `
                <div class="post-text-truncated">
                    ${escapeHtml(data.text.substring(0, maxLength))}...
                    <span class="read-more" onclick="toggleReadMore(this)">Read more</span>
                </div>
                <div class="post-text-full" style="display: none;">
                    ${escapeHtml(data.text)}
                    <span class="read-less" onclick="toggleReadLess(this)" style="color: var(--primary); cursor: pointer; font-weight: 600;"> Read less</span>
                </div>
            `;
        } else {
            postContentHtml = escapeHtml(data.text || '');
        }

        // Media HTML
        let mediaHtml = '';
        if (data.media && data.media.length > 0) {
            if (data.media.length === 1) {
                const media = data.media[0];
                const isVideo = media.match(/\.(mp4|mov|avi|webm)$/i);
                mediaHtml = `
                    <div class="post-media" onclick="openMediaModal('${media}', ${isVideo})">
                        ${isVideo ? 
                            `<video controls><source src="${media}"></video>` : 
                            `<img src="${media}" loading="lazy">`
                        }
                    </div>
                `;
            } else {
                // Multiple media
                mediaHtml = '<div class="post-media" style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">';
                data.media.forEach(media => {
                    const isVideo = media.match(/\.(mp4|mov|avi|webm)$/i);
                    mediaHtml += `
                        <div onclick="openMediaModal('${media}', ${isVideo})" style="cursor: pointer;">
                            ${isVideo ? 
                                `<video style="width: 100%; height: 200px; object-fit: cover;"><source src="${media}"></video>` : 
                                `<img src="${media}" style="width: 100%; height: 200px; object-fit: cover;" loading="lazy">`
                            }
                        </div>
                    `;
                });
                mediaHtml += '</div>';
            }
        }

        postEl.innerHTML = `
            <div class="post-header">
                <div class="post-user" onclick="viewProfile('${data.userId}')">
                    <div class="user-avatar">${userAvatar}</div>
                    <div>
                        <div class="user-name" style="cursor: pointer; color: var(--primary);">${data.userName || 'Anonymous'}</div>
                        <div class="post-meta">
                            ${formatTimestamp(data.timestamp)} ‚Ä¢ 
                            ${data.privacy === 'public' ? 'üåç Public' : data.privacy === 'friends' ? 'üë• Friends' : 'üîí Only Me'}
                        </div>
                    </div>
                </div>
                ${isOwner ? `
                <div class="post-actions">
                    <i class="fas fa-ellipsis-h" style="cursor: pointer;" onclick="togglePostMenu('${id}')"></i>
                    <div class="post-menu" id="menu-${id}">
                        <div class="post-menu-item" onclick="editPost('${id}')">
                            <i class="fas fa-edit"></i> Edit
                        </div>
                        <div class="post-menu-item delete" onclick="deletePost('${id}')">
                            <i class="fas fa-trash"></i> Delete
                        </div>
                    </div>
                </div>
                ` : ''}
            </div>
            <div class="post-content">${postContentHtml}</div>
            ${mediaHtml}
            <div class="post-stats">
                <div>${starCount} stars ‚Ä¢ ${responses.length} responses</div>
            </div>
            <div class="post-interactions">
                <div class="interaction-btn ${isStarred ? 'active' : ''}" onclick="window.toggleStar('${id}')">
                    <i class="fas fa-star"></i> Star
                </div>
                <div class="interaction-btn" onclick="focusResponse('${id}')">
                    <i class="fas fa-comment"></i> Respond
                </div>
                <div class="interaction-btn" onclick="promotePost('${id}')">
                    <i class="fas fa-share"></i> Promote
                </div>
            </div>
            <div class="comments-section">
                ${responses.slice(-2).map(response => {
                    const responseAvatar = response.userPhotoURL ? 
                        `<img src="${response.userPhotoURL}" alt="${response.userName}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">` : 
                        response.userInitial || 'U';

                    return `
                        <div class="comment">
                            <div class="user-avatar" style="width: 32px; height: 32px; font-size: 14px; cursor: pointer;" onclick="viewProfile('${response.userId}')">${responseAvatar}</div>
                            <div class="comment-content">
                                <div style="font-weight: 600; font-size: 14px; cursor: pointer; color: var(--primary);" onclick="viewProfile('${response.userId}')">${response.userName || 'User'}</div>
                                <div>${escapeHtml(response.text)}</div>
                            </div>
                        </div>
                    `;
                }).join('')}
                ${responses.length > 2 ? `
                    <div class="view-more-comments" onclick="openCommentsModal('${id}')">
                        View ${responses.length - 2} more responses
                    </div>
                ` : ''}
                <div class="comment-input">
                    <div class="user-avatar" style="width: 32px; height: 32px; font-size: 14px;">
                        ${user.photoURL ? 
                            `<img src="${user.photoURL}" alt="${user.displayName}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">` : 
                            (user.displayName ? user.displayName.charAt(0).toUpperCase() : 'U')
                        }
                    </div>
                    <input type="text" id="response-${id}" placeholder="Write a response..." onkeypress="handleResponseKeypress(event, '${id}')">
                    <button class="send-comment-btn" onclick="addResponseViaButton('${id}')">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        `;

        postsContainer.appendChild(postEl);
    };

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatTimestamp(timestamp) {
        if (!timestamp) return 'Just now';

        const date = timestamp.toDate();
        const now = new Date();
        const diff = now - date;

        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return 'Just now';
        if (minutes < 60) return `${minutes}m ago`;
        if (hours < 24) return `${hours}h ago`;
        if (days < 7) return `${days}d ago`;

        return date.toLocaleDateString();
    }

    // Toggle read more/less
    window.toggleReadMore = (element) => {
        const truncated = element.parentElement;
        const full = truncated.nextElementSibling;

        truncated.style.display = 'none';
        full.style.display = 'block';
    };

    window.toggleReadLess = (element) => {
        const full = element.parentElement;
        const truncated = full.previousElementSibling;

        full.style.display = 'none';
        truncated.style.display = 'block';
    };

    // Post interactions
    window.toggleStar = async (id) => {
        try {
            await toggleStar(id);
        } catch (error) {
            console.error('Error toggling star:', error);
            showMessage('Failed to update star. Please try again.');
        }
    };

    window.promotePost = async (id) => {
        try {
            if (navigator.share) {
                navigator.share({
                    title: 'Check out this meetcast on MEET',
                    text: 'I found this interesting meetcast on MEET',
                    url: window.location.href
                });
            } else {
                showMessage('Meetcast promoted!', 'success');
            }
        } catch (error) {
            console.error('Error promoting meetcast:', error);
            showMessage('Failed to promote meetcast. Please try again.');
        }
    };

    window.focusResponse = (postId) => {
        const responseInput = document.getElementById(`response-${postId}`);
        if (responseInput) {
            responseInput.focus();
        }
    };

    window.handleResponseKeypress = async (event, postId) => {
        if (event.key === 'Enter') {
            await addResponseFromInput(postId);
        }
    };

    window.addResponseViaButton = async (postId) => {
        await addResponseFromInput(postId);
    };

    async function addResponseFromInput(postId) {
        const input = document.getElementById(`response-${postId}`);
        const text = input.value.trim();

        if (!text) return;

        try {
            await addResponse(postId, text);
            input.value = '';
        } catch (error) {
            console.error('Error adding response:', error);
            showMessage('Failed to add response. Please try again.');
        }
    }

    // Post management
    window.togglePostMenu = (postId) => {
        const menu = document.getElementById(`menu-${postId}`);
        const isVisible = menu.style.display === 'block';

        document.querySelectorAll('.post-menu').forEach(m => {
            m.style.display = 'none';
        });

        menu.style.display = isVisible ? 'none' : 'block';
    };

    window.editPost = async (postId) => {
        showMessage('Edit feature coming soon!', 'success');
        document.getElementById(`menu-${postId}`).style.display = 'none';
    };

    window.deletePost = async (postId) => {
        try {
            await deletePost(postId);
        } catch (error) {
            console.error('Error deleting meetcast:', error);
        }
        document.getElementById(`menu-${postId}`).style.display = 'none';
    };

    // Association functions
    window.associateWithUser = async (userId) => {
        try {
            await associateWithUser(userId);
            // Refresh users modal
            openUsersModal();
        } catch (error) {
            console.error('Error associating with user:', error);
        }
    };

    window.removeAssociation = async (userId) => {
        try {
            await removeAssociation(userId);
            // Refresh users modal
            openUsersModal();
        } catch (error) {
            console.error('Error removing association:', error);
        }
    };

    // Profile navigation
    window.viewProfile = (userId) => {
        sessionStorage.setItem('targetUserId', userId);
        window.location.href = 'profile.html';
    };

    // Function to navigate to current user's profile
    function goToMyProfile() {
        const user = auth.currentUser;
        if (user) {
            sessionStorage.removeItem('targetUserId');
            window.location.href = 'profile.html';
        }
    }

    // Function to navigate to chat
    function goToChat() {
        window.location.href = 'chat.html';
    }

    // Close menus when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.post-actions')) {
            document.querySelectorAll('.post-menu').forEach(menu => {
                menu.style.display = 'none';
            });
        }
    });

    // Search functionality
    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        // Implement search functionality here
        if (searchTerm.length > 2) {
            showMessage(`Searching for: ${searchTerm}`, 'success');
        }
    });

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
        initTheme();

        // Prevent zoom on double-tap (iOS)
        document.addEventListener('touchstart', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(e) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    });
</script>
</body>
</html>
