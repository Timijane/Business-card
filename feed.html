<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MEET | Feed</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #0061FF;
  --primary-dark: #0050d4;
  --bg-light: #f2f2f2;
  --bg-dark: #18191A;
  --card-light: #fff;
  --card-dark: #242526;
  --text-light: #000;
  --text-dark: #E4E6EB;
  --error: #EF4444;
  --success: #10B981;
}

* { box-sizing: border-box; margin:0; padding:0; font-family: 'Poppins', sans-serif; }

body {
  display: flex;
  background: var(--bg-light);
  color: var(--text-light);
  min-height: 100vh;
}

body.dark-mode { background: var(--bg-dark); color: var(--text-dark); }

/* Sidebar */
.sidebar {
  width: 220px;
  background: var(--card-light);
  height: 100vh;
  position: fixed;
  top:0; left:0;
  padding:20px;
  display: flex;
  flex-direction: column;
  gap:15px;
  box-shadow: 2px 0 5px rgba(0,0,0,0.1);
}

body.dark-mode .sidebar { background: var(--card-dark); }

.sidebar h2 { margin-bottom:20px; color: var(--primary); }
.sidebar a {
  text-decoration:none; color:inherit; font-weight:600;
  padding:8px; border-radius:5px; transition: background 0.2s;
}
.sidebar a:hover { background: rgba(0,97,255,0.1); }

/* Feed wrapper */
.feed-wrapper { margin-left:240px; flex:1; padding:20px; max-width: 650px; }

/* Navbar */
.navbar {
  background: var(--card-light); padding:15px 20px;
  display: flex; justify-content: space-between; align-items:center;
  box-shadow:0 2px 4px rgba(0,0,0,0.1); position: sticky; top:0; z-index:100;
}
body.dark-mode .navbar { background: var(--card-dark); }

.logout-btn, .theme-btn {
  background: var(--primary); color: #fff;
  border:none; padding:8px 16px; border-radius:5px; cursor:pointer;
  font-weight:600;
}
.logout-btn:hover, .theme-btn:hover { background: var(--primary-dark); }

/* Post Form */
.post-form {
  background: var(--card-light); padding:15px; border-radius:12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08); display:flex; flex-direction:column; gap:12px;
  transition: transform 0.2s, box-shadow 0.2s;
}
body.dark-mode .post-form { background: var(--card-dark); }
.post-form:hover { transform: translateY(-2px); box-shadow:0 6px 16px rgba(0,0,0,0.12); }

.post-form textarea {
  width: 100%; min-height:90px; border-radius:20px;
  border:1px solid #ccc; padding:12px 16px; font-size:1rem;
  background:inherit; color:inherit; resize: vertical;
}

.post-form input[type="file"] { display:none; }
.upload-label {
  display:inline-block; cursor:pointer; padding:8px 14px;
  background: rgba(0,97,255,0.1); color: var(--primary); border-radius:20px;
  font-weight:600; transition: background 0.2s;
}
.upload-label:hover { background: rgba(0,97,255,0.2); }

.media-preview { margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; }
.media-preview img, .media-preview video {
  max-width:120px; max-height:120px; border-radius:10px; object-fit:cover;
  cursor:pointer; transition: transform 0.2s;
}
.media-preview img:hover, .media-preview video:hover { transform: scale(1.05); }

.post-form button {
  padding:10px 25px; border-radius:25px; font-weight:600; border:none;
  background: var(--primary); color:#fff; cursor:pointer; transition: background 0.2s, transform 0.2s;
}
.post-form button:hover { background: var(--primary-dark); transform:translateY(-1px); }
.post-form button:disabled { background:#9CA3AF; cursor:not-allowed; }

/* Posts */
.posts { display:flex; flex-direction:column; gap:20px; margin-top:20px; }
.post {
  background: var(--card-light); padding:15px; border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08); transition: transform 0.2s, box-shadow 0.2s;
}
.post:hover { transform: translateY(-2px); box-shadow:0 6px 16px rgba(0,0,0,0.12); }
body.dark-mode .post { background: var(--card-dark); }

.post-header { display:flex; align-items:center; margin-bottom:10px; gap:10px; }
.user-avatar {
  width:40px; height:40px; border-radius:50%; background: var(--primary);
  color:#fff; display:flex; align-items:center; justify-content:center; font-weight:bold;
  cursor:pointer; flex-shrink:0;
}

.post img, .post video { max-width:100%; border-radius:10px; margin-top:10px; }

.post-actions {
  display:flex; gap:15px; margin-top:10px; border-top:1px solid #eee; padding-top:10px;
}
.post-actions span { cursor:pointer; color: var(--primary); font-weight:600; transition: color 0.2s; }
.post-actions span:hover { color: var(--primary-dark); }

.comment-section { margin-top:10px; display:flex; flex-direction:column; gap:10px; }
.comment-input { display:flex; gap:10px; }
.comment-input input { flex:1; padding:5px 12px; border-radius:20px; border:1px solid #ccc; background:inherit; color:inherit; }
.comment-input button { border-radius:20px; padding:5px 12px; background: var(--primary); color:#fff; border:none; cursor:pointer; font-weight:600; }
.comment-input button:hover { background: var(--primary-dark); }

.loading { text-align:center; padding:20px; color:#666; }
.error-message { background: rgba(239,68,68,0.1); color: var(--error); padding:10px; border-radius:5px; text-align:center; }
.success-message { background: rgba(16,185,129,0.1); color: var(--success); padding:10px; border-radius:5px; text-align:center; }

.spinner { display:inline-block; width:16px; height:16px; border:2px solid rgba(255,255,255,.3); border-radius:50%; border-top-color:#fff; animation:spin 1s ease-in-out infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

@media screen and (max-width:768px) {
  .sidebar { display:none; }
  .feed-wrapper { margin-left:0; padding:15px; }
}
</style>
</head>
<body>

<!-- Sidebar Menu -->
<div class="sidebar">
  <h2>MEET</h2>
  <a href="#">Feed</a>
  <a href="#">Profile</a>
  <a href="#">Messages</a>
  <a href="#">Notifications</a>
  <a href="#">Settings</a>
</div>

<!-- Main Feed -->
<div class="feed-wrapper">
  <div class="navbar">
    <h2>MEET Feed</h2>
    <div>
      <button class="theme-btn" id="themeBtn">üåô</button>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>
  </div>

  <!-- Post Form -->
  <div class="post-form">
    <textarea id="postText" placeholder="What's on your mind, User?"></textarea>
    <div style="display:flex;gap:10px;align-items:center;">
      <label class="upload-label" for="postMedia">üì∑ Photo/Video</label>
      <input type="file" id="postMedia" accept="image/*,video/*">
      <select id="privacy">
        <option value="public">Public üåç</option>
        <option value="friends">Friends üë•</option>
        <option value="private">Only Me üîí</option>
      </select>
      <button id="postBtn">
        <span id="postBtnText">Post</span>
        <span id="postBtnSpinner" class="spinner" style="display:none;"></span>
      </button>
    </div>
    <div class="media-preview" id="mediaPreview"></div>
  </div>

  <div id="messageContainer"></div>
  <div class="posts" id="postsContainer">
    <div class="loading">Loading posts...</div>
  </div>
</div>

<!-- Firebase + Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.2/axios.min.js"></script>
<script>
// Firebase config
const firebaseConfig = { /* your firebase config */ };
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Cloudinary
const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/dcwof2ngn/upload';
const CLOUDINARY_UPLOAD_PRESET = 'ml_default';

// DOM
const postsContainer = document.getElementById('postsContainer');
const postBtn = document.getElementById('postBtn');
const postText = document.getElementById('postText');
const postMedia = document.getElementById('postMedia');
const privacySelect = document.getElementById('privacy');
const logoutBtn = document.getElementById('logoutBtn');
const themeBtn = document.getElementById('themeBtn');
const messageContainer = document.getElementById('messageContainer');
const mediaPreview = document.getElementById('mediaPreview');

let lastVisible = null, isLoading = false, hasMore = true, PAGE_SIZE = 5;

// Theme
if(sessionStorage.getItem('theme')==='dark') document.body.classList.add('dark-mode');
themeBtn.addEventListener('click', ()=>{
  document.body.classList.toggle('dark-mode');
  sessionStorage.setItem('theme',document.body.classList.contains('dark-mode')?'dark':'light');
});

// Messages
function showMessage(message,type='error'){
  messageContainer.innerHTML = `<div class="${type==='error'?'error-message':'success-message'}">${message}</div>`;
  setTimeout(()=>{messageContainer.innerHTML='';},5000);
}

// Loading button
function setLoading(buttonId,loading){
  const btn=document.getElementById(buttonId);
  const text=btn.querySelector('span:first-child');
  const spinner=btn.querySelector('.spinner');
  if(loading){btn.disabled=true;text.style.display='none';spinner.style.display='inline-block';}
  else{btn.disabled=false;text.style.display='inline-block';spinner.style.display='none';}
}

// Media preview
postMedia.addEventListener('change', ()=>{
  mediaPreview.innerHTML='';
  const file = postMedia.files[0];
  if(!file) return;
  const url = URL.createObjectURL(file);
  if(file.type.startsWith('image/')){
    const img = document.createElement('img'); img.src=url; mediaPreview.appendChild(img);
  } else if(file.type.startsWith('video/')){
    const video = document.createElement('video'); video.src=url; video.controls=true; mediaPreview.appendChild(video);
  }
});

// Auth
auth.onAuthStateChanged(user=>{
  if(!user) window.location.href='login.html';
  else { loadPosts(); setupRealTimeListener(); }
});

// Logout
logoutBtn.addEventListener('click',async()=>{
  try{await auth.signOut(); window.location.href='login.html';} catch(e){showMessage('Failed to logout');}
});

// Post
postBtn.addEventListener('click',async ()=>{
  const text=postText.value.trim();
  const mediaFile=postMedia.files[0];
  const privacy=privacySelect.value;
  if(!text&&!mediaFile){showMessage('Add text or media!'); return;}
  if(text.length>500){showMessage('Text too long (500 chars)'); return;}
  setLoading('postBtn',true);

  try{
    let mediaUrl='';
    if(mediaFile){
      if(mediaFile.size>10*1024*1024) throw new Error('File too large');
      const formData=new FormData();
      formData.append('file',mediaFile);
      formData.append('upload_preset',CLOUDINARY_UPLOAD_PRESET);
      const res=await axios.post(CLOUDINARY_URL,formData);
      mediaUrl=res.data.secure_url;
    }

    const user=auth.currentUser;
    const userName=user.displayName||'Anonymous';
    const userInitial=userName.charAt(0).toUpperCase();

    await db.collection('posts').add({
      userId:user.uid, userName, userInitial,
      text, media:mediaUrl,
      likes:0, likedBy:[], comments:[], shares:0,
      privacy, timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });

    postText.value=''; postMedia.value=''; mediaPreview.innerHTML='';
    showMessage('Post published','success');
    lastVisible=null; hasMore=true; postsContainer.innerHTML='<div class="loading">Loading posts...</div>';
    loadPosts();
  } catch(e){console.error(e); showMessage('Failed to post');}
  finally{setLoading('postBtn',false);}
});

// Load posts
async function loadPosts(){
  if(isLoading||!hasMore) return; isLoading=true;
  try{
    let query=db.collection('posts').orderBy('timestamp','desc').limit(PAGE_SIZE);
    if(lastVisible) query=query.startAfter(lastVisible);
    const snapshot=await query.get();
    if(snapshot.empty&&lastVisible===null){postsContainer.innerHTML='<div class="loading">No posts yet!</div>'; return;}
    if(snapshot.docs.length>0) lastVisible=snapshot.docs[snapshot.docs.length-1]; else{hasMore=false; return;}
    if(lastVisible===null||postsContainer.querySelector('.loading')) postsContainer.innerHTML='';
    snapshot.docs.forEach(doc=>{const data=doc.data(); if(canViewPost(data)) renderPost(doc.id,data);});
  } catch(e){console.error(e); showMessage('Failed to load posts');} finally{isLoading=false;}
}

// Real-time
function setupRealTimeListener(){
  db.collection('posts').orderBy('timestamp','desc').limit(10).onSnapshot(snapshot=>{
    snapshot.docChanges().forEach(change=>{
      if(change.type==='added'&&!lastVisible){
        const data=change.doc.data();
        if(canViewPost(data)){
          if(!document.querySelector(`[data-post-id="${change.doc.id}"]`)) renderPost(change.doc.id,data,true);
        }
      }
    });
  });
}

// Privacy
function canViewPost(post){
  const user=auth.currentUser;
  if(!user) return false;
  if(post.privacy==='public') return true;
  if(post.privacy==='friends') return true;
  if(post.privacy==='private'&&post.userId===user.uid) return true;
  return false;
}

// Render post
function renderPost(id,data,prepend=false){
  const postEl=document.createElement('div'); postEl.classList.add('post'); postEl.setAttribute('data-post-id',id);
  const user=auth.currentUser;
  const isLiked=data.likedBy?.includes(user.uid);
  const isOwner=user.uid===data.userId;

  postEl.innerHTML=`
  <div class="post-header">
    <div class="user-avatar" onclick="openProfile('${data.userId}')">${data.userInitial||'U'}</div>
    <div>
      <strong onclick="openProfile('${data.userId}')" style="cursor:pointer;">${data.userName||'Anonymous'}</strong>
      <div style="font-size:0.8rem;color:#666;">${formatTimestamp(data.timestamp)} ‚Ä¢ ${data.privacy==='public'?'üåç Public':data.privacy==='friends'?'üë• Friends':'üîí Private'}</div>
    </div>
  </div>
  <div>${escapeHtml(data.text||'')}</div>
  ${data.media ? (data.media.match(/\.(mp4|mov|avi|webm)$/i) ? `<video controls src="${data.media}" style="max-width:100%;border-radius:10px;margin-top:10px;"></video>` : `<img src="${data.media}" style="max-width:100%;border-radius:10px;margin-top:10px;" loading="lazy">`) : ''}
  <div class="post-actions">
    <span onclick="likePost('${id}')" style="color:${isLiked?'#E74C3C':'var(--primary)'}">${isLiked?'‚ù§Ô∏è':'ü§ç'} Like (${data.likes||0})</span>
    <span onclick="sharePost('${id}')">üîÑ Share (${data.shares||0})</span>
    ${isOwner?`<span onclick="editPost('${id}')">‚úèÔ∏è Edit</span><span onclick="deletePost('${id}')">üóëÔ∏è Delete</span>`:''}
  </div>
  <div class="comment-section" id="comments-${id}">
    ${data.comments && data.comments.length > 0
      ? data.comments.map(c => `<div><strong>${escapeHtml(c.userName)}</strong>: ${escapeHtml(c.text)}</div>`).join('')
      : '<div style="color:#888; font-size:0.9rem;">No comments yet</div>'}
    <div class="comment-input">
      <input type="text" placeholder="Write a comment..." id="commentInput-${id}">
      <button onclick="addComment('${id}')">Post</button>
    </div>
  </div>
  `;

  if(prepend) postsContainer.prepend(postEl);
  else postsContainer.appendChild(postEl);
}

// Like post
async function likePost(postId){
  const user=auth.currentUser;
  const postRef=db.collection('posts').doc(postId);
  try{
    await db.runTransaction(async t=>{
      const doc = await t.get(postRef);
      if(!doc.exists) return;
      const likedBy = doc.data().likedBy || [];
      let likes = doc.data().likes || 0;
      if(likedBy.includes(user.uid)){
        likes--; likedBy.splice(likedBy.indexOf(user.uid),1);
      } else { likes++; likedBy.push(user.uid); }
      t.update(postRef,{likes, likedBy});
    });
  }catch(e){console.error(e);}
}

// Share post
async function sharePost(postId){
  const postRef=db.collection('posts').doc(postId);
  try{
    await postRef.update({shares: firebase.firestore.FieldValue.increment(1)});
    showMessage('Post shared','success');
  }catch(e){console.error(e);}
}

// Add comment
async function addComment(postId){
  const user=auth.currentUser;
  const input = document.getElementById(`commentInput-${postId}`);
  const text=input.value.trim();
  if(!text) return;
  const postRef=db.collection('posts').doc(postId);
  try{
    await postRef.update({
      comments: firebase.firestore.FieldValue.arrayUnion({
        userId:user.uid,
        userName:user.displayName||'Anonymous',
        text,
        timestamp:firebase.firestore.FieldValue.serverTimestamp()
      })
    });
    input.value='';
  }catch(e){console.error(e);}
}

// Edit post
function editPost(postId){
  const postEl=document.querySelector(`[data-post-id="${postId}"]`);
  const textDiv=postEl.querySelector('div:nth-child(2)');
  const originalText=textDiv.innerText;
  textDiv.innerHTML=`<textarea style="width:100%;border-radius:10px;">${originalText}</textarea>
    <button onclick="saveEdit('${postId}', this)">Save</button> <button onclick="cancelEdit(this,'${originalText}')">Cancel</button>`;
}

// Save edit
async function saveEdit(postId, btn){
  const postEl=document.querySelector(`[data-post-id="${postId}"]`);
  const textArea=postEl.querySelector('textarea');
  const newText=textArea.value.trim();
  try{
    await db.collection('posts').doc(postId).update({text:newText});
  }catch(e){console.error(e);}
}

// Cancel edit
function cancelEdit(btn, originalText){
  const postEl=btn.closest('.post');
  const textDiv=postEl.querySelector('div:nth-child(2)');
  textDiv.innerText=originalText;
}

// Escape HTML
function escapeHtml(text) {
  if(!text) return '';
  return text.replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
}

// Format timestamp
function formatTimestamp(ts){
  if(!ts) return '';
  const date = ts.toDate ? ts.toDate() : new Date(ts);
  return date.toLocaleString();
}

// Profile navigation
function openProfile(uid){ window.location.href=`profile.html?uid=${uid}`; }

// Infinite scroll
window.addEventListener('scroll', ()=>{
  if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 100){
    loadPosts();
  }
});
</script>
</body>
</html>
