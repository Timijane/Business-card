<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>

<style>
  :root {
    --primary: #0080FF;
    --bg-color: #f0f2f5;
    --card-bg: #fff;
    --text-color: #111;
    --secondary-text: #65676b;
    --border-color: #dddfe2;
    --outgoing-bg: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);
    --incoming-bg: #fff;
    --shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  body.dark-mode {
    --bg-color: #18191a;
    --card-bg: #242526;
    --text-color: #e4e6eb;
    --secondary-text: #b0b3b8;
    --border-color: #3e4042;
    --incoming-bg: #3e4042;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  html, body { 
    height: 100%; 
    overflow: hidden; /* Prevents scroll on body */
    font-family: 'Poppins', sans-serif; 
  }
  
  body { background: var(--bg-color); color: var(--text-color); }

  .app-container { display: flex; height: 100%; width: 100%; }

  /* --- Sidebar (Navigation) --- */
  .sidebar {
    width: 280px;
    background: linear-gradient(180deg, #0080FF 0%, #00C6FF 100%);
    display: flex; flex-direction: column; padding: 20px;
    flex-shrink: 0; color: white;
  }
  .sidebar-header h2 { font-size: 24px; font-weight: 700; margin-bottom: 20px; }
  .sidebar-menu a {
    display: flex; align-items: center; padding: 12px;
    color: white; text-decoration: none; border-radius: 8px;
    margin-bottom: 8px; transition: 0.2s;
  }
  .sidebar-menu a:hover, .sidebar-menu a.active { background: rgba(255,255,255,0.2); }
  .sidebar-menu i { margin-right: 12px; width: 20px; text-align: center; }

  /* --- Main Chat Layout --- */
  .main-content { flex: 1; display: flex; height: 100%; position: relative; overflow: hidden; }

  /* The Container holding List and Chat */
  .chat-wrapper {
    display: flex; width: 100%; height: 100%;
    background: var(--bg-color);
  }

  /* Left Side: Conversation List */
  .chat-list-panel {
    width: 350px; background: var(--card-bg);
    border-right: 1px solid var(--border-color);
    display: flex; flex-direction: column;
    flex-shrink: 0; z-index: 10;
  }

  /* Right Side: Message Area */
  .chat-message-panel {
    flex: 1; display: flex; flex-direction: column;
    background-color: #e5ddd5; /* WhatsApp default base */
    background-size: cover;
    background-position: center;
    position: relative;
    z-index: 5;
  }

  /* Headers */
  .panel-header {
    height: 60px; padding: 0 15px; display: flex; align-items: center;
    background: var(--card-bg); border-bottom: 1px solid var(--border-color);
    justify-content: space-between; flex-shrink: 0;
  }
  
  .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; }
  
  /* Conversation Items */
  .conversation-items { overflow-y: auto; flex: 1; }
  .convo-item {
    display: flex; align-items: center; padding: 15px; cursor: pointer;
    border-bottom: 1px solid var(--border-color);
  }
  .convo-item:hover { background: rgba(0,0,0,0.05); }
  .convo-info h4 { font-size: 15px; margin-bottom: 3px; }
  .convo-info p { font-size: 13px; color: var(--secondary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }

  /* Messages */
  .messages-area {
    flex: 1; padding: 20px; overflow-y: auto;
    display: flex; flex-direction: column; gap: 8px;
    background: rgba(255, 255, 255, 0.4); /* Subtle overlay for readability */
    backdrop-filter: blur(2px);
  }
  
  .message { max-width: 70%; display: flex; flex-direction: column; position: relative; margin-bottom: 5px; }
  .message.sent { align-self: flex-end; align-items: flex-end; }
  .message.received { align-self: flex-start; align-items: flex-start; }
  
  .bubble {
    padding: 8px 12px; border-radius: 8px; position: relative;
    font-size: 14.2px; line-height: 19px;
    box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
  }
  .sent .bubble { background: #d9fdd3; color: #111; }
  .received .bubble { background: var(--card-bg); color: #111; }

  .msg-time { font-size: 11px; color: rgba(0,0,0,0.45); text-align: right; margin-top: 2px; }

  /* Input Area */
  .input-panel {
    min-height: 60px; background: var(--card-bg); padding: 5px 10px;
    display: flex; align-items: center; gap: 10px;
    border-top: 1px solid var(--border-color);
    position: relative; z-index: 20;
  }
  
  .chat-input {
    flex: 1; padding: 10px 15px; border-radius: 20px; border: 1px solid var(--border-color);
    background: var(--bg-color); outline: none; max-height: 100px; resize: none;
    font-family: inherit;
  }
  .icon-btn { 
    font-size: 20px; color: var(--secondary-text); padding: 8px; 
    cursor: pointer; background: none; border: none; 
  }
  .icon-btn:hover { color: var(--primary); }
  
  /* AI Toggle (Bottom) */
  .ai-wrapper {
    display: flex; align-items: center; gap: 5px; margin-right: 5px;
  }
  .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
  .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: var(--primary); }
  input:checked + .slider:before { transform: translateX(16px); }

  /* Emoji Picker */
  .emoji-container {
    display: none; position: absolute; bottom: 70px; left: 10px;
    z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border-radius: 8px;
  }
  emoji-picker { width: 320px; height: 350px; }

  /* Media Preview in Chat */
  .chat-media { max-width: 100%; border-radius: 6px; margin-bottom: 5px; display: block;}

  /* Wallpaper Modal */
  .wallpaper-modal {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;
  }
  .wp-content {
    background: white; width: 90%; max-width: 600px; height: 80vh;
    border-radius: 12px; padding: 20px; display: flex; flex-direction: column;
  }
  .wp-grid {
    flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 15px;
  }
  .wp-item {
    height: 150px; border-radius: 8px; background-size: cover; cursor: pointer;
    border: 3px solid transparent; transition: 0.2s;
  }
  .wp-item:hover { border-color: var(--primary); transform: scale(1.05); }

  /* --- MOBILE RESPONSIVENESS (CRITICAL FIX) --- */
  @media (max-width: 768px) {
    .sidebar { display: none; } /* Hide Sidebar */
    
    .chat-wrapper { position: relative; overflow: hidden; }

    /* Make both panels full width/height absolute */
    .chat-list-panel, .chat-message-panel {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      transition: transform 0.3s ease-in-out;
    }

    /* Default State: List is visible, Chat is off-screen right */
    .chat-list-panel { transform: translateX(0); z-index: 20; }
    .chat-message-panel { transform: translateX(100%); z-index: 30; }

    /* Active Chat State: Chat slides in, List stays behind */
    .app-container.chat-active .chat-list-panel { transform: translateX(-20%); } /* Parallax effect */
    .app-container.chat-active .chat-message-panel { transform: translateX(0); }
    
    .back-btn { display: block !important; margin-right: 15px; font-size: 18px; }
    
    emoji-picker { width: 100%; max-width: 350px; }
  }
  
  /* Desktop tweaks */
  @media (min-width: 769px) {
    .back-btn { display: none; }
    .chat-message-panel { display: flex !important; } /* Always show on desktop */
    .chat-list-panel { display: flex !important; }
  }

</style>
</head>
<body>

<div class="app-container" id="appContainer">
  
  <div class="sidebar">
    <div class="sidebar-header"><h2>MEET</h2></div>
    <div class="sidebar-menu">
      <a href="#"><i class="fas fa-home"></i> Feed</a>
      <a href="#" class="active"><i class="fas fa-comment"></i> Chat</a>
      <a href="#"><i class="fas fa-user"></i> Profile</a>
      <a href="#" id="logoutBtn" style="margin-top: auto;"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>
  </div>

  <div class="main-content">
    <div class="chat-wrapper">
      
      <div class="chat-list-panel">
        <div class="panel-header">
          <h3>Chats</h3>
          <button class="icon-btn" onclick="openNewChatModal()"><i class="fas fa-plus-circle"></i></button>
        </div>
        <div style="padding: 10px;">
          <input type="text" placeholder="Search..." style="width:100%; padding:8px; border-radius:8px; border:1px solid #ddd;">
        </div>
        <div class="conversation-items" id="conversationList">
          <div style="padding:20px; text-align:center; color:#888;">Loading...</div>
        </div>
      </div>

      <div class="chat-message-panel" id="messagePanel">
        <div class="panel-header" id="chatHeader" style="display:none;">
          <div style="display:flex; align-items:center;">
            <i class="fas fa-arrow-left icon-btn back-btn" onclick="closeChat()"></i>
            <img src="" class="user-avatar" id="headerAvatar">
            <div>
              <h4 id="headerName" style="margin:0;">User</h4>
              <span id="headerStatus" style="font-size:12px; color:green;">Online</span>
            </div>
          </div>
          <div style="display:flex; gap:10px;">
            <button class="icon-btn" onclick="openWallpaperModal()" title="Change Wallpaper"><i class="fas fa-paint-brush"></i></button>
            <button class="icon-btn"><i class="fas fa-phone"></i></button>
            <button class="icon-btn"><i class="fas fa-video"></i></button>
          </div>
        </div>

        <div class="messages-area" id="messagesArea">
          <div style="margin:auto; text-align:center; background:rgba(255,255,255,0.8); padding:20px; border-radius:10px;">
            <i class="fas fa-comments" style="font-size:40px; color:var(--primary);"></i>
            <p style="margin-top:10px;">Select a conversation to start chatting</p>
          </div>
        </div>

        <div class="input-panel" id="inputPanel" style="display:none;">
          <div class="ai-wrapper">
             <small style="font-size:10px; font-weight:bold; color:var(--secondary-text);">AI</small>
             <label class="switch">
                <input type="checkbox" id="aiToggle">
                <span class="slider"></span>
             </label>
          </div>

          <button class="icon-btn" onclick="toggleEmoji()"><i class="far fa-smile"></i></button>
          
          <button class="icon-btn" onclick="document.getElementById('fileInput').click()"><i class="fas fa-paperclip"></i></button>
          <input type="file" id="fileInput" hidden accept="image/*,video/*">

          <textarea id="msgInput" class="chat-input" rows="1" placeholder="Type a message..."></textarea>
          
          <button class="icon-btn" style="color:var(--primary); background:#e6f2ff; border-radius:50%; width:40px; height:40px;" id="sendBtn">
            <i class="fas fa-paper-plane"></i>
          </button>

          <div class="emoji-container" id="emojiContainer">
            <emoji-picker></emoji-picker>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="wallpaper-modal" id="wpModal">
  <div class="wp-content">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
      <h3>Select Wallpaper</h3>
      <button onclick="document.getElementById('wpModal').style.display='none'" class="icon-btn"><i class="fas fa-times"></i></button>
    </div>
    <div class="wp-grid" id="wpGrid">
      </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  import { 
    getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, serverTimestamp, query, orderBy, where, setDoc 
  } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

  // --- Firebase Config ---
  const firebaseConfig = {
    apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
    authDomain: "meet-6e159.firebaseapp.com",
    projectId: "meet-6e159",
    storageBucket: "meet-6e159.firebasestorage.app",
    messagingSenderId: "252353608421",
    appId: "1:252353608421:web:6706056048e9a8f12db20c"
  };

  const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dcwof2ngn/upload";
  const CLOUDINARY_PRESET = "Meet_video"; 

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- State ---
  let currentUser = null;
  let currentChatId = null;
  let currentMessageUnsubscribe = null; // KEY FIX: To stop old listeners
  
  // --- Backgrounds Data (Issue 5) ---
  const backgrounds = [
    // AI Themes (Simulated via specific Unsplash IDs)
    { name: "Cyberpunk", url: "https://images.unsplash.com/photo-1555680202-c86f0e12f086?w=600&q=80" },
    { name: "Neon City", url: "https://images.unsplash.com/photo-1565626424178-c699f660d2e5?w=600&q=80" },
    { name: "Abstract Blue", url: "https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=600&q=80" },
    { name: "Dark Forest", url: "https://images.unsplash.com/photo-1448375240586-dfd8d3f5d891?w=600&q=80" },
    { name: "Minimal Geo", url: "https://images.unsplash.com/photo-1550100136-e074fa43d8d8?w=600&q=80" },
    { name: "Sunset", url: "https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=600&q=80" },
    { name: "Tech Board", url: "https://images.unsplash.com/photo-1518770660439-4636190af475?w=600&q=80" },
    { name: "Space", url: "https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=600&q=80" },
    // WhatsApp Classics
    { name: "Default", url: "https://i.ibb.co/F8S0tL9/MEET-M-Logo-Pattern.png" },
    { name: "Clean White", url: "" }, // Empty string = plain color
    // ... Add more valid URLs here ... 
  ];
  // Add 20 more AI-like placeholders programmatically
  for(let i=0; i<20; i++) {
     backgrounds.push({ name: `AI Theme ${i+1}`, url: `https://source.unsplash.com/random/600x800?abstract,art&sig=${i}` });
  }

  // --- Auth & Init ---
  onAuthStateChanged(auth, (user) => {
    if(!user) return window.location.href = 'login.html';
    currentUser = user;
    loadConversations();
    
    // Load saved wallpaper
    const savedBg = localStorage.getItem('chatWallpaper');
    if(savedBg) document.getElementById('messagePanel').style.backgroundImage = `url('${savedBg}')`;
  });

  // --- UI Functions ---
  window.closeChat = () => {
    document.getElementById('appContainer').classList.remove('chat-active');
    currentChatId = null;
    // Unsubscribe to save memory
    if(currentMessageUnsubscribe) {
        currentMessageUnsubscribe();
        currentMessageUnsubscribe = null;
    }
  };

  window.toggleEmoji = () => {
    const el = document.getElementById('emojiContainer');
    el.style.display = el.style.display === 'block' ? 'none' : 'block';
  };

  // --- Wallpaper Logic ---
  window.openWallpaperModal = () => {
    const grid = document.getElementById('wpGrid');
    grid.innerHTML = '';
    backgrounds.forEach(bg => {
       const div = document.createElement('div');
       div.className = 'wp-item';
       if(bg.url) div.style.backgroundImage = `url(${bg.url})`;
       else div.style.backgroundColor = '#e5ddd5';
       
       div.onclick = () => {
         const url = bg.url ? bg.url : '';
         document.getElementById('messagePanel').style.backgroundImage = url ? `url(${url})` : 'none';
         if(!url) document.getElementById('messagePanel').style.backgroundColor = '#e5ddd5';
         
         localStorage.setItem('chatWallpaper', url);
         document.getElementById('wpModal').style.display = 'none';
       };
       grid.appendChild(div);
    });
    document.getElementById('wpModal').style.display = 'flex';
  }

  // --- Chat Logic ---
  function loadConversations() {
    const list = document.getElementById('conversationList');
    const q = query(collection(db, "conversations"), where("participants", "array-contains", currentUser.uid));
    
    onSnapshot(q, (snap) => {
      list.innerHTML = '';
      const chats = [];
      snap.forEach(d => chats.push({id: d.id, ...d.data()}));
      chats.sort((a,b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));

      chats.forEach(chat => {
        const otherId = chat.participants.find(id => id !== currentUser.uid);
        const name = chat.participantNames[otherId];
        const avatar = chat.participantAvatars[otherId];
        
        const div = document.createElement('div');
        div.className = 'convo-item';
        div.innerHTML = `
           <img src="${avatar || 'https://via.placeholder.com/40'}" class="user-avatar">
           <div class="convo-info">
             <h4>${name}</h4>
             <p>${chat.lastMessage}</p>
           </div>
        `;
        div.onclick = () => openChat(chat.id, {uid: otherId, name, avatar});
        list.appendChild(div);
      });
    });
  }

  async function openChat(chatId, user) {
    // 1. Unsubscribe from previous chat listener (Fixes #2 Fluctuation)
    if(currentMessageUnsubscribe) {
        currentMessageUnsubscribe();
    }

    currentChatId = chatId;
    
    // 2. Update UI
    document.getElementById('headerName').innerText = user.name;
    document.getElementById('headerAvatar').src = user.avatar;
    document.getElementById('chatHeader').style.display = 'flex';
    document.getElementById('inputPanel').style.display = 'flex';
    document.getElementById('appContainer').classList.add('chat-active'); // Triggers mobile slide

    const msgArea = document.getElementById('messagesArea');
    msgArea.innerHTML = ''; // Clear old messages immediately

    // 3. Start New Listener
    const q = query(collection(db, `conversations/${chatId}/messages`), orderBy('timestamp', 'asc'));
    
    currentMessageUnsubscribe = onSnapshot(q, (snap) => {
        msgArea.innerHTML = ''; // Re-render logic (optimized in React, simple here)
        snap.forEach(d => {
            renderMessage(d.data());
        });
        msgArea.scrollTop = msgArea.scrollHeight; // Auto scroll to bottom
    });
  }

  function renderMessage(msg) {
    const isMe = msg.senderId === currentUser.uid;
    const div = document.createElement('div');
    div.className = `message ${isMe ? 'sent' : 'received'}`;
    
    let content = '';
    if(msg.type === 'image') content = `<img src="${msg.mediaUrl}" class="chat-media" onclick="window.open(this.src)">`;
    if(msg.type === 'video') content = `<video src="${msg.mediaUrl}" class="chat-media" controls></video>`;
    if(msg.text) content += `<span>${msg.text}</span>`;
    
    const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...';

    div.innerHTML = `
      <div class="bubble">
        ${content}
        <div class="msg-time">${time}</div>
      </div>
    `;
    document.getElementById('messagesArea').appendChild(div);
  }

  // --- Sending ---
  async function sendMessage(text = '', media = null) {
     if(!text && !media) return;
     const payload = {
         senderId: currentUser.uid,
         text: text,
         type: media ? media.type : 'text',
         mediaUrl: media ? media.url : null,
         timestamp: serverTimestamp(),
         read: false
     };
     
     document.getElementById('msgInput').value = '';
     
     try {
         await addDoc(collection(db, `conversations/${currentChatId}/messages`), payload);
         await updateDoc(doc(db, "conversations", currentChatId), {
             lastMessage: media ? `[${media.type}]` : text,
             updatedAt: serverTimestamp()
         });
         
         // AI Reply Logic
         if(document.getElementById('aiToggle').checked && !media) {
             setTimeout(() => {
                 addDoc(collection(db, `conversations/${currentChatId}/messages`), {
                     senderId: "AI",
                     text: "I am an AI Auto-Reply. The user is currently away.",
                     timestamp: serverTimestamp(),
                     type: 'text'
                 });
             }, 2000);
         }
     } catch(e) { console.error(e); }
  }

  // Event Listeners
  document.getElementById('sendBtn').onclick = () => sendMessage(document.getElementById('msgInput').value);
  
  // Emoji Picker Logic
  document.querySelector('emoji-picker').addEventListener('emoji-click', event => {
      document.getElementById('msgInput').value += event.detail.unicode;
  });

  // File Upload Logic
  document.getElementById('fileInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if(!file) return;
      
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", CLOUDINARY_PRESET);
      
      try {
          // Simple loading indicator
          document.getElementById('msgInput').placeholder = "Uploading...";
          const res = await fetch(CLOUDINARY_URL, {method: "POST", body: formData});
          const data = await res.json();
          await sendMessage(document.getElementById('msgInput').value, { url: data.secure_url, type: data.resource_type });
          document.getElementById('msgInput').placeholder = "Type a message...";
      } catch(err) { alert("Upload failed"); }
  });

</script>
</body>
</html>
