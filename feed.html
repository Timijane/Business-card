<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!-- FIXED VIEWPORT TAG - PREVENTS ZOOMING -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Feed</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary: #0080FF;
    --primary-dark: #0066CC;
    --error: #EF4444;
    --success: #10B981;
    --bg-color: #f0f2f5;
    --card-bg: #fff;
    --text-color: #111;
    --secondary-text: #65676b;
    --border-color: #dddfe2;
    --online: #10B981;
    --offline: #EF4444;
  }

  body.dark-mode {
    --bg-color: #18191a;
    --card-bg: #242526;
    --text-color: #e4e6eb;
    --secondary-text: #b0b3b8;
    --border-color: #3e4042;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent; /* Better mobile tapping */
  }

  /* FIXED HTML AND BODY HEIGHT FOR MOBILE */
  html, body {
    height: 100%;
    overflow-x: hidden; /* Prevent horizontal scroll */
    font-size: 18px; /* Increased default font size */
  }

  body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #e0f7ff 0%, #b3e0ff 100%);
    color: var(--text-color);
    transition: all 0.3s ease;
    min-height: 100vh;
    /* Improved mobile scrolling */
    -webkit-overflow-scrolling: touch;
  }

  .app-container {
    display: flex;
    min-height: 100vh;
    position: relative;
  }

  /* FIXED SIDEBAR - FULL HEIGHT ON MOBILE */
  .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    height: 100vh;
    width: 280px;
    background: linear-gradient(180deg, #0080FF 0%, #00C6FF 100%);
    border-right: 1px solid var(--border-color);
    overflow-y: auto;
    z-index: 100;
    padding: 20px;
    transition: all 0.3s ease;
    color: white;
    /* Improved mobile scrolling */
    -webkit-overflow-scrolling: touch;
  }

  .sidebar-header {
    padding: 10px 0 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    margin-bottom: 20px;
  }

  .sidebar-menu {
    list-style: none;
  }

  .sidebar-menu li {
    margin-bottom: 8px;
  }

  .sidebar-menu a {
    display: flex;
    align-items: center;
    padding: 12px;
    text-decoration: none;
    color: white;
    border-radius: 8px;
    transition: background 0.3s;
    /* Better touch targets on mobile */
    min-height: 44px;
    font-size: 18px; /* Increased font size */
  }

  .sidebar-menu a:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .sidebar-menu i {
    margin-right: 12px;
    font-size: 22px; /* Increased icon size */
  }

  /* Main Content */
  .main-content {
    flex: 1;
    margin-left: 280px;
    padding: 20px;
    /* Ensure content doesn't get cut off on mobile */
    min-height: 100vh;
    font-size: 18px; /* Increased font size */
  }

  /* Navbar */
  .navbar {
    background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);
    padding: 15px 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    color: white;
    /* Better mobile layout */
    flex-wrap: wrap;
    gap: 10px;
  }

  .nav-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  .search-bar {
    display: flex;
    align-items: center;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    padding: 8px 15px;
    margin-right: 15px;
  }

  .search-bar input {
    background: transparent;
    border: none;
    color: white;
    outline: none;
    width: 200px;
    /* Better mobile input */
    font-size: 18px; /* Increased font size */
  }

  .search-bar input::placeholder {
    color: rgba(255, 255, 255, 0.7);
  }

  .user-profile-nav {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 5px 10px;
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.2);
    cursor: pointer;
    position: relative;
    /* Better touch target */
    min-height: 44px;
  }

  .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    cursor: pointer;
    position: relative;
    /* Better touch target */
    min-width: 40px;
    font-size: 18px; /* Increased font size */
    overflow: hidden;
  }

  .user-avatar.small {
    width: 30px;
    height: 30px;
    font-size: 16px; /* Increased font size */
    min-width: 30px;
  }

  .user-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
  }

  .user-avatar.small img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
  }

  .status-indicator {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid white;
  }

  .status-online {
    background-color: var(--online);
  }

  .status-offline {
    background-color: var(--offline);
  }

  .user-profile-nav span {
    font-size: 16px; /* Increased font size */
    font-weight: 600;
  }

  .btn {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px; /* Increased font size */
    /* Better touch target */
    min-height: 44px;
  }

  .btn:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  .btn-secondary {
    background: var(--secondary-text);
  }

  /* Post Form - Facebook Style */
  .post-composer {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .composer-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
  }

  .composer-input {
    flex: 1;
    background: var(--bg-color);
    border: none;
    padding: 12px 16px;
    border-radius: 25px;
    color: var(--text-color);
    font-size: 18px; /* Increased font size */
    cursor: pointer;
    /* Better touch target */
    min-height: 44px;
  }

  .composer-divider {
    height: 1px;
    background: var(--border-color);
    margin: 16px 0;
  }

  .composer-actions {
    display: flex;
    justify-content: space-between;
  }

  .action-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s;
    color: var(--secondary-text);
    /* Better touch target */
    min-height: 44px;
    font-size: 16px; /* Increased font size */
  }

  .action-btn:hover {
    background: var(--bg-color);
  }

  /* AI Button */
  .ai-button {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #00C6FF 0%, #80b3ff 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 99;
    transition: all 0.3s ease;
    /* Better touch target */
    min-width: 60px;
    min-height: 60px;
  }

  .ai-button:hover {
    transform: scale(1.1);
    background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);
  }

  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px; /* Added padding for mobile */
  }

  .modal-content {
    background: var(--card-bg);
    border-radius: 12px;
    width: 500px;
    max-width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    /* Better mobile modal */
    width: 100%;
  }

  .modal-header {
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-body {
    padding: 16px;
  }

  .close-modal {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--secondary-text);
    /* Better touch target */
    min-width: 44px;
    min-height: 44px;
  }

  /* Enhanced Post Form */
  .post-form {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .post-user-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .post-textarea {
    width: 100%;
    min-height: 120px;
    border: 2px solid #0080FF;
    background: transparent;
    color: var(--text-color);
    font-size: 18px; /* Increased font size */
    resize: none;
    outline: none;
    padding: 12px;
    border-radius: 8px;
  }

  .media-preview {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
  }

  .media-preview img,
  .media-preview video {
    width: 100%;
    max-height: 400px; /* Increased size */
    object-fit: contain;
    background: var(--bg-color);
  }

  .remove-media {
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(0,0,0,0.7);
    color: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    cursor: pointer;
    /* Better touch target */
    min-width: 32px;
    min-height: 32px;
  }

  .post-options {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    /* Better mobile layout */
    flex-wrap: wrap;
    gap: 10px;
  }

  /* Posts */
  .posts {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .post {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .post-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .post-user {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
  }

  .post-user:hover .user-name {
    text-decoration: underline;
  }

  .post-meta {
    font-size: 15px; /* Increased font size */
    color: var(--secondary-text);
  }

  .post-actions {
    position: relative;
  }

  .post-menu {
    position: absolute;
    top: 100%;
    right: 0;
    background: var(--card-bg);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    padding: 8px;
    min-width: 150px;
    z-index: 10;
    display: none;
  }

  .post-menu-item {
    padding: 8px 12px;
    cursor: pointer;
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 8px;
    /* Better touch target */
    min-height: 44px;
    font-size: 16px; /* Increased font size */
  }

  .post-menu-item:hover {
    background: var(--bg-color);
  }

  .post-menu-item.delete {
    color: var(--error);
  }

  .post-content {
    margin-bottom: 12px;
    font-size: 18px; /* Increased font size */
    line-height: 1.5;
  }

  .post-text-truncated {
    margin-bottom: 8px;
  }

  .read-more {
    color: var(--primary);
    cursor: pointer;
    font-weight: 600;
  }

  .post-media {
    margin-top: 12px;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
  }

  .post-media img,
  .post-media video {
    width: 100%;
    max-height: 600px; /* Increased size */
    object-fit: contain;
    transition: transform 0.3s ease;
  }

  .post-media img:hover,
  .post-media video:hover {
    transform: scale(1.02);
  }

  .post-stats {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-color);
    color: var(--secondary-text);
    font-size: 16px; /* Increased font size */
  }

  .post-interactions {
    display: flex;
    justify-content: space-around;
    padding: 8px 0;
  }

  .interaction-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.3s;
    color: var(--secondary-text);
    font-weight: 600;
    /* Better touch target */
    min-height: 44px;
    font-size: 16px; /* Increased font size */
  }

  .interaction-btn:hover {
    background: var(--bg-color);
  }

  .interaction-btn.active {
    color: var(--primary);
  }

  .comments-section {
    margin-top: 12px;
    border-top: 1px solid var(--border-color);
    padding-top: 12px;
  }

  .comment {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
  }

  .comment-content {
    flex: 1;
    background: var(--bg-color);
    padding: 8px 12px;
    border-radius: 18px;
  }

  .comment-input {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    align-items: center;
  }

  .comment-input input {
    flex: 1;
    background: var(--bg-color);
    border: none;
    padding: 8px 12px;
    border-radius: 18px;
    color: var(--text-color);
    font-size: 16px; /* Increased font size */
  }

  .send-comment-btn {
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.3s;
    /* Better touch target */
    min-width: 32px;
    min-height: 32px;
  }

  .send-comment-btn:hover {
    background: var(--primary-dark);
  }

  .send-comment-btn:disabled {
    background: var(--secondary-text);
    cursor: not-allowed;
  }

  .view-more-comments {
    color: var(--primary);
    cursor: pointer;
    font-weight: 600;
    text-align: center;
    padding: 8px 0;
    margin-top: 8px;
  }

  .comments-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .comments-modal-content {
    background: var(--card-bg);
    border-radius: 12px;
    width: 500px;
    max-width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    padding: 20px;
  }

  .comments-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border-color);
  }

  .comments-modal-body {
    max-height: 60vh;
    overflow-y: auto;
  }

  .media-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .media-modal-content {
    max-width: 90%;
    max-height: 90vh;
    position: relative;
  }

  .media-modal-content img,
  .media-modal-content video {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
  }

  .close-media-modal {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.7);
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .loading {
    text-align: center;
    padding: 20px;
    color: var(--secondary-text);
  }

  .error-message {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error);
    padding: 10px;
    border-radius: 5px;
    margin: 10px 0;
    text-align: center;
  }

  .success-message {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
    padding: 10px;
    border-radius: 5px;
    margin: 10px 0;
    text-align: center;
  }

  .spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Post Button in Modal - Reduced length */
  #postBtn {
    width: 120px; /* Reduced width */
    margin: 0 auto; /* Center it */
  }

  /* IMPROVED RESPONSIVE DESIGN */
  @media (max-width: 1200px) {
    .sidebar {
      width: 80px;
    }
    .sidebar span {
      display: none;
    }
    .main-content {
      margin-left: 80px;
    }
  }

  @media (max-width: 768px) {
    /* FIXED MOBILE SIDEBAR */
    .sidebar {
      width: 70px;
      padding: 10px 5px;
      height: 100vh; /* Ensure full height */
    }
    
    .sidebar-header {
      display: none;
    }
    
    .sidebar-menu a {
      flex-direction: column;
      padding: 10px 5px;
      font-size: 12px;
      justify-content: center;
      text-align: center;
    }
    
    .sidebar-menu i {
      margin-right: 0;
      margin-bottom: 5px;
      font-size: 18px;
    }
    
    .main-content {
      margin-left: 70px;
      padding: 10px;
      width: calc(100% - 70px); /* Ensure proper width calculation */
    }
    
    .navbar {
      padding: 12px;
      flex-direction: column;
      align-items: flex-start;
      gap: 15px;
    }
    
    .search-bar {
      display: none;
    }
    
    .user-profile-nav span {
      display: none;
    }
    
    .nav-controls {
      gap: 5px;
      width: 100%;
      justify-content: space-between;
    }
    
    .btn span {
      display: none;
    }
    
    .btn {
      padding: 8px;
      flex: 1;
      justify-content: center;
    }

    /* Better mobile post composer */
    .composer-actions {
      flex-direction: column;
      gap: 10px;
    }

    .action-btn {
      justify-content: center;
    }

    /* Better mobile posts */
    .post-interactions {
      flex-direction: column;
      gap: 5px;
    }

    .interaction-btn {
      justify-content: center;
    }

    /* Fix modal for mobile */
    .modal {
      padding: 10px;
    }

    .modal-content {
      width: 100%;
      max-width: 100%;
      margin: 0;
    }
  }

  /* Extra small devices */
  @media (max-width: 480px) {
    .sidebar {
      width: 60px;
    }
    
    .main-content {
      margin-left: 60px;
      padding: 8px;
    }

    .navbar h2 {
      font-size: 18px;
    }

    .post-composer {
      padding: 12px;
    }

    .post {
      padding: 12px;
    }
  }

  /* Fix for very tall screens */
  @media (min-height: 1000px) {
    .sidebar {
      height: 100vh;
      position: fixed;
    }
  }
</style>
</head>
<body>

<div class="app-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2 style="color: white;">MEET</h2>
    </div>
    <ul class="sidebar-menu">
      <li><a href="#"><i class="fas fa-home"></i> <span>Feed</span></a></li>
      <li><a href="#" onclick="goToMyProfile()"><i class="fas fa-user"></i> <span>Profile</span></a></li>
      <li><a href="#"><i class="fas fa-comment"></i> <span>Chat</span></a></li>
      <li><a href="#"><i class="fas fa-chart-line"></i> <span>Meetrader</span></a></li>
      <li><a href="#"><i class="fas fa-graduation-cap"></i> <span>Meetversity</span></a></li>
      <li><a href="#"><i class="fas fa-sitemap"></i> <span>Organization</span></a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Navbar -->
    <div class="navbar">
      <h2 style="color: white;">MEET Feed</h2>
      <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
        <div class="search-bar">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Search...">
        </div>
        <div class="nav-controls">
          <div class="user-profile-nav">
            <div class="user-avatar small" id="currentUserAvatar">
              U
              <div class="status-indicator status-online"></div>
            </div>
            <span id="userName">User</span>
          </div>
          <button class="btn" id="nightToggleBtn">
            <i class="fas fa-moon"></i> <span>Night Mode</span>
          </button>
          <button class="btn" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Post Composer -->
    <div class="post-composer">
      <div class="composer-header">
        <div class="user-avatar" id="currentUserAvatarComposer">
          U
          <div class="status-indicator status-online"></div>
        </div>
        <div class="composer-input" id="openComposer">
          Surprise the world now
        </div>
      </div>
      <div class="composer-divider"></div>
      <div class="composer-actions">
        <div class="action-btn">
          <i class="fas fa-video" style="color: #f02849;"></i>
          <span>Live Video</span>
        </div>
        <div class="action-btn">
          <i class="fas fa-images" style="color: #45bd62;"></i>
          <span>Photo/Video</span>
        </div>
        <div class="action-btn">
          <i class="fas fa-laugh" style="color: #f7b928;"></i>
          <span>Feeling/Activity</span>
        </div>
      </div>
    </div>

    <!-- AI Button -->
    <div class="ai-button">
      <i class="fas fa-robot"></i>
    </div>

    <!-- Messages -->
    <div id="messageContainer"></div>

    <!-- Posts Container -->
    <div class="posts" id="postsContainer">
      <div class="loading">Loading posts...</div>
    </div>
  </div>
</div>

<!-- Post Modal -->
<div class="modal" id="postModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Create Post</h3>
      <button class="close-modal" id="closeModal">&times;</button>
    </div>
    <div class="modal-body">
      <div class="post-form">
        <div class="post-user-info">
          <div class="user-avatar" id="modalUserAvatar">
            U
            <div class="status-indicator status-online"></div>
          </div>
          <div>
            <div class="user-name" id="modalUserName">User Name</div>
            <select id="privacy" style="border: none; background: var(--bg-color); color: var(--text-color); padding: 4px 8px; border-radius: 4px; font-size: 14px;">
              <option value="public">üåç Public</option>
              <option value="friends">üë• Friends</option>
              <option value="private">üîí Only Me</option>
            </select>
          </div>
        </div>
        <textarea class="post-textarea" id="postText" placeholder="Surprise the world now"></textarea>
        <div class="media-preview" id="mediaPreview"></div>
        <div class="post-options">
          <div style="color: var(--secondary-text);">Add to your post</div>
          <div style="display: flex; gap: 8px;">
            <input type="file" id="postMedia" accept="image/*,video/*" style="display: none;" multiple>
            <div class="action-btn" onclick="document.getElementById('postMedia').click()">
              <i class="fas fa-images" style="color: #45bd62;"></i>
            </div>
            <div class="action-btn">
              <i class="fas fa-user-tag" style="color: #1877f2;"></i>
            </div>
            <div class="action-btn">
              <i class="fas fa-laugh" style="color: #f7b928;"></i>
            </div>
            <div class="action-btn">
              <i class="fas fa-map-marker-alt" style="color: #f5533d;"></i>
            </div>
          </div>
        </div>
        <button class="btn" id="postBtn" style="background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);">
          <span id="postBtnText">Post</span>
          <span id="postBtnSpinner" class="spinner" style="display: none;"></span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Comments Modal -->
<div class="comments-modal" id="commentsModal">
  <div class="comments-modal-content">
    <div class="comments-modal-header">
      <h3>Comments</h3>
      <button class="close-modal" id="closeCommentsModal">&times;</button>
    </div>
    <div class="comments-modal-body" id="commentsModalBody">
      <!-- Comments will be loaded here -->
    </div>
  </div>
</div>

<!-- Media Modal -->
<div class="media-modal" id="mediaModal">
  <div class="media-modal-content">
    <button class="close-media-modal" id="closeMediaModal">&times;</button>
    <img id="mediaModalImage" src="" alt="Enlarged media">
    <video id="mediaModalVideo" controls style="display: none;">
      Your browser does not support the video tag.
    </video>
  </div>
</div>

<script type="module">
import {   
  getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDoc, getDocs, onSnapshot, serverTimestamp,   
  query, orderBy, where, setDoc, runTransaction, limit  
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";  
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";  
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";  

// --- Firebase config ---  
const firebaseConfig = {  
  apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",  
  authDomain: "meet-6e159.firebaseapp.com",  
  databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",  
  projectId: "meet-6e159",  
  storageBucket: "meet-6e159.storage.googleapis.com",  
  messagingSenderId: "252353608421",  
  appId: "1:252353608421:web:6706056048e9a8f12db20c",  
  measurementId: "G-9BFPPVMMRF"  
};  

// initialize  
const app = initializeApp(firebaseConfig);  
const db = getFirestore(app);  
const auth = getAuth(app);  

// --- Cloudinary setup ---  
const CLOUDINARY_CLOUD_NAME = 'dcwof2ngn';  
const CLOUDINARY_UPLOAD_PRESET = 'Meet_video';  
const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`;  
const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB  

// --- DOM refs ---  
const postsContainer = document.getElementById('postsContainer');  
const postBtn = document.getElementById('postBtn');  
const postText = document.getElementById('postText');  
const postMedia = document.getElementById('postMedia');  
const privacySelect = document.getElementById('privacy');  
const logoutBtn = document.getElementById('logoutBtn');  
const messageContainer = document.getElementById('messageContainer');  
const nightToggleBtn = document.getElementById('nightToggleBtn');  
const postModal = document.getElementById('postModal');  
const openComposer = document.getElementById('openComposer');  
const closeModal = document.getElementById('closeModal');  
const mediaPreview = document.getElementById('mediaPreview');  
const currentUserAvatar = document.getElementById('currentUserAvatar');  
const currentUserAvatarComposer = document.getElementById('currentUserAvatarComposer');  
const modalUserAvatar = document.getElementById('modalUserAvatar');  
const modalUserName = document.getElementById('modalUserName');  
const userName = document.getElementById('userName');  

const commentsModal = document.getElementById('commentsModal');  
const closeCommentsModal = document.getElementById('closeCommentsModal');  
const commentsModalBody = document.getElementById('commentsModalBody');  
const mediaModal = document.getElementById('mediaModal');  
const closeMediaModal = document.getElementById('closeMediaModal');  
const mediaModalImage = document.getElementById('mediaModalImage');  
const mediaModalVideo = document.getElementById('mediaModalVideo');  

// --- global state ---  
let currentUser = null;  
let postListeners = {};  
const userCache = {}; // in-memory user profile cache  
const associateListeners = {}; // new: tracks real-time associates  

// -----------------------
// THEME & MESSAGE UTILS
// -----------------------
function initTheme() {  
  const savedTheme = localStorage.getItem('meet_theme');  
  if (savedTheme === 'dark') {  
    document.body.classList.add('dark-mode');  
    nightToggleBtn.innerHTML = '<i class="fas fa-sun"></i> <span>Day Mode</span>';  
  } else {  
    document.body.classList.remove('dark-mode');  
    nightToggleBtn.innerHTML = '<i class="fas fa-moon"></i> <span>Night Mode</span>';  
  }  
}
initTheme();

function showMessage(message, type = 'error') {  
  messageContainer.innerHTML = `<div class="${type==='success'?'success-message':'error-message'}">${message}</div>`;  
  setTimeout(() => messageContainer.innerHTML='', 4000);  
}  

function setLoading(buttonId, isLoading) {  
  const button = document.getElementById(buttonId);  
  const text = button.querySelector('span:first-child');  
  const spinner = button.querySelector('.spinner');  
  if(isLoading){ button.disabled=true; if(text) text.style.display='none'; if(spinner) spinner.style.display='inline-block'; }  
  else{ button.disabled=false; if(text) text.style.display='inline-block'; if(spinner) spinner.style.display='none'; }  
}

// -----------------------
// MEDIA UPLOAD
// -----------------------
async function uploadMedia(file){  
  if(!file) return null;  
  if(file.size>MAX_FILE_SIZE) throw new Error('File size too large. Maximum 10MB.');  
  const formData=new FormData();  
  formData.append("file", file);  
  formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);  
  const res=await fetch(CLOUDINARY_URL,{method:"POST",body:formData});  
  if(!res.ok){ const err=await res.json().catch(()=>null); throw new Error(err?.error?.message||'Upload failed'); }  
  const data=await res.json(); return data.secure_url;  
}

// -----------------------
// CREATE POST (MeetCast)
// -----------------------
async function createMeetCast(text, files, privacy){  
  const user = auth.currentUser;  
  if(!user) throw new Error("Please login first");  
  let mediaUrls=[];  
  if(files && files.length>0){ for(let f of files){ mediaUrls.push(await uploadMedia(f)); } }  
  await addDoc(collection(db,"posts"),{  
    userId:user.uid, userName:user.displayName||"Anonymous", userInitial:user.displayName?.charAt(0).toUpperCase()||"U", userPhotoURL:user.photoURL||null,  
    text:text||'', media:mediaUrls, privacy:privacy||'public', starCount:0, timestamp:serverTimestamp()  
  });  
}

// -----------------------
// STAR / COMMENT LOGIC
// -----------------------
async function toggleStar(postId){  
  const user = auth.currentUser;  
  if(!user){ showMessage('Sign in to star MeetCasts'); return; }  
  const postRef=doc(db,"posts",postId);  
  const starRef=doc(db,"posts",postId,"stars",user.uid);  
  try{  
    await runTransaction(db, async tx=>{  
      const postSnap=await tx.get(postRef);  
      if(!postSnap.exists()) throw new Error("MeetCast not found");  
      const starSnap=await tx.get(starRef);  
      const currentCount=postSnap.data().starCount||0;  
      if(starSnap.exists()){ tx.delete(starRef); tx.update(postRef,{starCount:Math.max(0,currentCount-1)}); }  
      else{ tx.set(starRef,{userId:user.uid,userName:user.displayName||'Anonymous',userPhotoURL:user.photoURL||null,timestamp:serverTimestamp()}); tx.update(postRef,{starCount:currentCount+1}); }  
    });  
  }catch(e){ console.error(e); showMessage('Failed to update star'); }  
}

async function addResponse(postId, commentText){  
  const user = auth.currentUser;  
  if(!user || !commentText?.trim()) return;  
  await addDoc(collection(db,"posts",postId,"comments"),{  
    userId:user.uid, userName:user.displayName||"Anonymous", userInitial:user.displayName?.charAt(0).toUpperCase()||"U", userPhotoURL:user.photoURL||null,  
    text:commentText.trim(), timestamp:serverTimestamp()  
  });  
}

// -----------------------
// ASSOCIATES (REAL-TIME + AVATAR)
// -----------------------
async function followUser(userIdToFollow){  
  const user = auth.currentUser; if(!user) return;  
  try{  
    await setDoc(doc(db,"users",user.uid,"following",userIdToFollow),{timestamp:serverTimestamp()});  
    await setDoc(doc(db,"users",userIdToFollow,"followers",user.uid),{timestamp:serverTimestamp()});  
    showMessage('You are now associates!','success');  
    setupAssociateListener(userIdToFollow); // new: live update avatar  
  }catch(e){ console.error(e); showMessage('Failed to follow user'); }  
}

async function unfollowUser(userIdToUnfollow){  
  const user = auth.currentUser; if(!user) return;  
  try{  
    await deleteDoc(doc(db,"users",user.uid,"following",userIdToUnfollow));  
    await deleteDoc(doc(db,"users",userIdToUnfollow,"followers",user.uid));  
    showMessage('You are no longer associates.','success');  
    if(associateListeners[userIdToUnfollow]){ associateListeners[userIdToUnfollow](); delete associateListeners[userIdToUnfollow]; }  
  }catch(e){ console.error(e); showMessage('Failed to unfollow user'); }  
}

// New: setup real-time avatar updates for an associate
function setupAssociateListener(userId){  
  if(associateListeners[userId]) return;  
  const unsubscribe = onSnapshot(doc(db,"users",userId),(snap)=>{  
    if(snap.exists()){ userCache[userId]=snap.data(); updateFeedAvatars(userId,snap.data().photoURL); }  
  });  
  associateListeners[userId]=unsubscribe;  
}

// Update all posts/comments in feed with new avatar
function updateFeedAvatars(userId,newPhotoURL){  
  document.querySelectorAll(`[data-post-id]`).forEach(postEl=>{  
    const avatarImg = postEl.querySelector(`.post-user .user-avatar img`);  
    if(avatarImg && postEl.dataset.userId===userId) avatarImg.src=newPhotoURL;  
    postEl.querySelectorAll('.comment .user-avatar img').forEach(cEl=>{ if(cEl.dataset.userid===userId) cEl.src=newPhotoURL; });  
  });  
}

// -----------------------
// USER PROFILE CACHE
// -----------------------
async function getUserProfile(uid){  
  if(!uid) return null;  
  if(userCache[uid]) return userCache[uid];  
  try{  
    const snap=await getDoc(doc(db,"users",uid));  
    if(snap.exists()){ userCache[uid]=snap.data(); return userCache[uid]; }  
    return null;  
  }catch(e){ console.error(e); return null; }  
}

// -----------------------
// REAL-TIME FEED
// -----------------------
function cleanupPostListeners(){ Object.values(postListeners).forEach(fn=>fn&&fn()); postListeners={}; }  

function setupRealTimeListener(){  
  const postsQuery = query(collection(db,"posts"),orderBy("timestamp","desc"));  
  onSnapshot(postsQuery,snapshot=>{  
    cleanupPostListeners(); postsContainer.innerHTML='';  
    snapshot.docs.forEach(d=>{  
      const postId=d.id, data=d.data();  
      const starsQuery=query(collection(db,"posts",postId,"stars"));  
      const unsubscribeStars=onSnapshot(starsQuery,starsSnap=>{  
        const starCount=starsSnap.size; const isStarred=!!starsSnap.docs.find(s=>s.id===(currentUser?.uid||''));  
        const commentsQuery=query(collection(db,"posts",postId,"comments"),orderBy("timestamp","asc"));  
        const unsubscribeComments=onSnapshot(commentsQuery,commentsSnap=>{  
          const comments=commentsSnap.docs.map(c=>({id:c.id,...c.data()}));  
          renderPost(postId,data,starCount,isStarred,comments);  
        });  
        postListeners[postId]=()=>{unsubscribeStars();unsubscribeComments();};  
      });  
    });  
  });  
}

// -----------------------
// CLOUD FUNCTION (FIREBASE)
// -----------------------
// Place this in functions/index.js in your Firebase project
/*
import { onDocumentUpdated } from "firebase-functions/v2/firestore";
import admin from "firebase-admin"; admin.initializeApp();

export const propagateProfilePhoto = onDocumentUpdated("users/{userId}", async (event) => {
  const before = event.data.before.data();
  const after = event.data.after.data();
  if(before.photoURL === after.photoURL) return;
  const db = admin.firestore();
  const userId = event.params.userId;
  // update posts
  const postsSnap = await db.collection("posts").where("userId","==",userId).get();
  postsSnap.forEach(doc=>doc.ref.update({userPhotoURL:after.photoURL}));
  // update stars
  const postsSnap2 = await db.collection("posts").get();
  postsSnap2.forEach(post=>{
    post.ref.collection("stars").where("userId","==",userId).get().then(starsSnap=>{
      starsSnap.forEach(s=>s.ref.update({userPhotoURL:after.photoURL}));
    });
  });
  // update comments
  const postsSnap3 = await db.collection("posts").get();
  postsSnap3.forEach(post=>{
    post.ref.collection("comments").where("userId","==",userId).get().then(cSnap=>{
      cSnap.forEach(c=>c.ref.update({userPhotoURL:after.photoURL}));
    });
  });
});
*/

// Add event listeners and other existing functionality
postBtn.addEventListener('click', async () => {
  const text = postText.value.trim();
  const mediaFiles = postMedia.files;
  const privacy = privacySelect.value;

  if (!text && (!mediaFiles || mediaFiles.length === 0)) {
    showMessage('Please add some text or media to your post!');
    return;
  }

  setLoading('postBtn', true);

  try {
    await createMeetCast(text, mediaFiles, privacy);
    postText.value = '';
    mediaPreview.innerHTML = '';
    postMedia.value = '';
    postModal.style.display = 'none';
    document.body.style.overflow = 'auto';
    showMessage('MeetCast created successfully!', 'success');
  } catch (error) {
    console.error('MeetCast creation error:', error);
    showMessage('Failed to create MeetCast. Please try again.');
  } finally {
    setLoading('postBtn', false);
  }
});

// Modal controls
openComposer.addEventListener('click', () => {
  postModal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
});

closeModal.addEventListener('click', () => {
  postModal.style.display = 'none';
  document.body.style.overflow = 'auto';
});

postModal.addEventListener('click', (e) => {
  if (e.target === postModal) {
    postModal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }
});

// Media preview
postMedia.addEventListener('change', function(e) {
  const files = e.target.files;
  if (!files || files.length === 0) return;
  
  mediaPreview.innerHTML = '';
  
  for (let file of files) {
    if (file.size > MAX_FILE_SIZE) {
      showMessage('File size too large. Maximum 10MB.');
      postMedia.value = '';
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
      const isVideo = file.type.startsWith('video/');
      const mediaElement = document.createElement('div');
      mediaElement.style.position = 'relative';
      mediaElement.style.marginBottom = '10px';
      mediaElement.innerHTML = `
        ${isVideo ? 
          `<video controls style="width: 100%; max-height: 300px; object-fit: contain; background: var(--bg-color);"><source src="${e.target.result}" type="${file.type}"></video>` : 
          `<img src="${e.target.result}" alt="Preview" style="width: 100%; max-height: 300px; object-fit: contain; background: var(--bg-color);">`
        }
        <button class="remove-media" onclick="this.parentElement.remove()">&times;</button>
      `;
      mediaPreview.appendChild(mediaElement);
    };
    reader.readAsDataURL(file);
  }
});

// Comments modal controls
closeCommentsModal.addEventListener('click', () => {
  commentsModal.style.display = 'none';
  document.body.style.overflow = 'auto';
});

commentsModal.addEventListener('click', (e) => {
  if (e.target === commentsModal) {
    commentsModal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }
});

// Media modal controls
closeMediaModal.addEventListener('click', () => {
  mediaModal.style.display = 'none';
  document.body.style.overflow = 'auto';
  mediaModalVideo.pause();
});

mediaModal.addEventListener('click', (e) => {
  if (e.target === mediaModal) {
    mediaModal.style.display = 'none';
    document.body.style.overflow = 'auto';
    mediaModalVideo.pause();
  }
});

// Authentication state listener
onAuthStateChanged(auth, user => {
  if (!user) {
    window.location.href = 'login.html';
  } else {
    currentUser = user;
    // Update user info in UI
    const userNameText = user.displayName || 'User';
    const userInitial = userNameText.charAt(0).toUpperCase();
    
    // Function to update avatar with profile picture
    const updateAvatar = (element, initial) => {
      if (user.photoURL) {
        element.innerHTML = `<img src="${user.photoURL}" alt="${userNameText}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;"><div class="status-indicator status-online"></div>`;
      } else {
        element.textContent = initial;
      }
    };
    
    updateAvatar(currentUserAvatar, userInitial);
    updateAvatar(currentUserAvatarComposer, userInitial);
    updateAvatar(modalUserAvatar, userInitial);
    
    modalUserName.textContent = userNameText;
    userName.textContent = userNameText;
    
    setupRealTimeListener();
  }
});

// Logout functionality
logoutBtn.addEventListener('click', async () => {
  try {
    await signOut(auth);
    window.location.href = 'login.html';
  } catch (error) {
    console.error('Logout error:', error);
    showMessage('Failed to logout. Please try again.');
  }
});

// Theme toggle
nightToggleBtn.addEventListener('click', () => {
  if (document.body.classList.contains('dark-mode')) {
    document.body.classList.remove('dark-mode');
    localStorage.setItem('meet_theme', 'light');
    nightToggleBtn.innerHTML = '<i class="fas fa-moon"></i> <span>Night Mode</span>';
  } else {
    document.body.classList.add('dark-mode');
    localStorage.setItem('meet_theme', 'dark');
    nightToggleBtn.innerHTML = '<i class="fas fa-sun"></i> <span>Day Mode</span>';
  }
});

// Helper functions for rendering posts
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function formatTimestamp(timestamp) {
  if (!timestamp) return 'Just now';
  
  const date = timestamp.toDate();
  const now = new Date();
  const diff = now - date;
  
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);
  
  if (minutes < 1) return 'Just now';
  if (minutes < 60) return `${minutes}m ago`;
  if (hours < 24) return `${hours}h ago`;
  if (days < 7) return `${days}d ago`;
  
  return date.toLocaleDateString();
}

// Render post function
function renderPost(postId, data, starCount, isStarred, comments) {
  const postEl = document.createElement('div');
  postEl.classList.add('post');
  postEl.setAttribute('data-post-id', postId);
  postEl.setAttribute('data-user-id', data.userId);
  
  const user = auth.currentUser;
  const isOwner = data.userId === user.uid;
  
  // Use profile picture if available, otherwise fallback to initial
  const userAvatar = data.userPhotoURL ? 
    `<img src="${data.userPhotoURL}" alt="${data.userName}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">` : 
    data.userInitial || 'U';
  
  // Truncate long posts
  const maxLength = 200;
  let postContentHtml = '';
  if (data.text && data.text.length > maxLength) {
    postContentHtml = `
      <div class="post-text-truncated">
        ${escapeHtml(data.text.substring(0, maxLength))}...
        <span class="read-more" onclick="toggleReadMore(this)">Read more</span>
      </div>
      <div class="post-text-full" style="display: none;">
        ${escapeHtml(data.text)}
        <span class="read-less" onclick="toggleReadLess(this)" style="color: var(--primary); cursor: pointer; font-weight: 600;"> Read less</span>
      </div>
    `;
  } else {
    postContentHtml = escapeHtml(data.text || '');
  }
  
  // Media HTML
  let mediaHtml = '';
  if (data.media && data.media.length > 0) {
    if (data.media.length === 1) {
      const media = data.media[0];
      const isVideo = media.match(/\.(mp4|mov|avi|webm)$/i);
      mediaHtml = `
        <div class="post-media" onclick="openMediaModal('${media}', ${isVideo})">
          ${isVideo ? 
            `<video controls><source src="${media}"></video>` : 
            `<img src="${media}" loading="lazy">`
          }
        </div>
      `;
    } else {
      // Multiple media
      mediaHtml = '<div class="post-media" style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">';
      data.media.forEach((media, index) => {
        const isVideo = media.match(/\.(mp4|mov|avi|webm)$/i);
        mediaHtml += `
          <div onclick="openMediaModal('${media}', ${isVideo})" style="cursor: pointer;">
            ${isVideo ? 
              `<video style="width: 100%; height: 200px; object-fit: cover;"><source src="${media}"></video>` : 
              `<img src="${media}" style="width: 100%; height: 200px; object-fit: cover;" loading="lazy">`
            }
          </div>
        `;
      });
      mediaHtml += '</div>';
    }
  }
  
  postEl.innerHTML = `
    <div class="post-header">
      <div class="post-user" onclick="viewProfile('${data.userId}')">
        <div class="user-avatar">${userAvatar}</div>
        <div>
          <div class="user-name" style="cursor: pointer; color: var(--primary);">${data.userName || 'Anonymous'}</div>
          <div class="post-meta">
            ${formatTimestamp(data.timestamp)} ‚Ä¢ 
            ${data.privacy === 'public' ? 'üåç Public' : data.privacy === 'friends' ? 'üë• Friends' : 'üîí Only Me'}
          </div>
        </div>
      </div>
      ${isOwner ? `
        <div class="post-actions">
          <i class="fas fa-ellipsis-h" style="cursor: pointer;" onclick="togglePostMenu('${postId}')"></i>
          <div class="post-menu" id="menu-${postId}">
            <div class="post-menu-item delete" onclick="deletePost('${postId}')">
              <i class="fas fa-trash"></i> Delete
            </div>
          </div>
        </div>
      ` : ''}
    </div>
    <div class="post-content">${postContentHtml}</div>
    ${mediaHtml}
    <div class="post-stats">
      <div>${starCount} stars ‚Ä¢ ${comments.length} comments</div>
    </div>
    <div class="post-interactions">
      <div class="interaction-btn ${isStarred ? 'active' : ''}" onclick="window.toggleStar('${postId}')">
        <i class="fas fa-star"></i> Star
      </div>
      <div class="interaction-btn" onclick="focusComment('${postId}')">
        <i class="fas fa-comment"></i> Comment
      </div>
      <div class="interaction-btn" onclick="sharePost('${postId}')">
        <i class="fas fa-share"></i> Share
      </div>
    </div>
    <div class="comments-section">
      ${comments.slice(-2).map(comment => {
        const commentAvatar = comment.userPhotoURL ? 
          `<img src="${comment.userPhotoURL}" alt="${comment.userName}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">` : 
          comment.userInitial || 'U';
        
        return `
          <div class="comment">
            <div class="user-avatar" style="width: 32px; height: 32px; font-size: 14px; cursor: pointer;" onclick="viewProfile('${comment.userId}')">${commentAvatar}</div>
            <div class="comment-content">
              <div style="font-weight: 600; font-size: 14px; cursor: pointer; color: var(--primary);" onclick="viewProfile('${comment.userId}')">${comment.userName || 'User'}</div>
              <div>${escapeHtml(comment.text)}</div>
            </div>
          </div>
        `;
      }).join('')}
      ${comments.length > 2 ? `
        <div class="view-more-comments" onclick="openCommentsModal('${postId}')">
          View ${comments.length - 2} more comments
        </div>
      ` : ''}
      <div class="comment-input">
        <div class="user-avatar" style="width: 32px; height: 32px; font-size: 14px;">${user.displayName ? user.displayName.charAt(0).toUpperCase() : 'U'}</div>
        <input type="text" id="comment-${postId}" placeholder="Write a comment..." onkeypress="handleCommentKeypress(event, '${postId}')">
        <button class="send-comment-btn" onclick="addCommentViaButton('${postId}')">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  `;
  
  postsContainer.appendChild(postEl);
}

// Global functions for post interactions
window.toggleReadMore = (element) => {
  const truncated = element.parentElement;
  const full = truncated.nextElementSibling;
  
  truncated.style.display = 'none';
  full.style.display = 'block';
};

window.toggleReadLess = (element) => {
  const full = element.parentElement;
  const truncated = full.previousElementSibling;
  
  full.style.display = 'none';
  truncated.style.display = 'block';
};

window.togglePostMenu = (postId) => {
  const menu = document.getElementById(`menu-${postId}`);
  const isVisible = menu.style.display === 'block';
  
  document.querySelectorAll('.post-menu').forEach(m => {
    m.style.display = 'none';
  });
  
  menu.style.display = isVisible ? 'none' : 'block';
};

window.deletePost = async (postId) => {
  if (!confirm('Are you sure you want to delete this MeetCast?')) return;
  
  try {
    await deleteDoc(doc(db, "posts", postId));
    showMessage('MeetCast deleted successfully!', 'success');
  } catch (error) {
    console.error('Error deleting MeetCast:', error);
    showMessage('Failed to delete MeetCast. Please try again.');
  }
};

window.openMediaModal = (mediaUrl, isVideo = false) => {
  if (isVideo) {
    mediaModalImage.style.display = 'none';
    mediaModalVideo.style.display = 'block';
    mediaModalVideo.src = mediaUrl;
  } else {
    mediaModalImage.style.display = 'block';
    mediaModalVideo.style.display = 'none';
    mediaModalImage.src = mediaUrl;
  }
  
  mediaModal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
};

window.openCommentsModal = async (postId) => {
  const commentsQuery = query(collection(db, "posts", postId, "comments"), orderBy("timestamp", "asc"));
  const commentsSnapshot = await getDocs(commentsQuery);
  const comments = commentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  
  let commentsHtml = comments.map(comment => {
    const commentAvatar = comment.userPhotoURL ? 
      `<img src="${comment.userPhotoURL}" alt="${comment.userName}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">` : 
      comment.userInitial || 'U';
    
    return `
      <div class="comment" style="margin-bottom: 16px;">
        <div class="user-avatar" style="width: 40px; height: 40px; font-size: 16px; cursor: pointer;" onclick="viewProfile('${comment.userId}')">${commentAvatar}</div>
        <div class="comment-content" style="flex: 1;">
          <div style="font-weight: 600; font-size: 16px; cursor: pointer; color: var(--primary);" onclick="viewProfile('${comment.userId}')">${comment.userName || 'User'}</div>
          <div style="font-size: 16px;">${escapeHtml(comment.text)}</div>
          <div style="font-size: 12px; color: var(--secondary-text); margin-top: 4px;">${formatTimestamp(comment.timestamp)}</div>
        </div>
      </div>
    `;
  }).join('');
  
  commentsModalBody.innerHTML = commentsHtml;
  commentsModal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
};

window.focusComment = (postId) => {
  const commentInput = document.getElementById(`comment-${postId}`);
  if (commentInput) {
    commentInput.focus();
  }
};

window.handleCommentKeypress = async (event, postId) => {
  if (event.key === 'Enter') {
    await addCommentFromInput(postId);
  }
};

window.addCommentViaButton = async (postId) => {
  await addCommentFromInput(postId);
};

async function addCommentFromInput(postId) {
  const input = document.getElementById(`comment-${postId}`);
  const text = input.value.trim();
  
  if (!text) return;
  
  try {
    await addResponse(postId, text);
    input.value = '';
  } catch (error) {
    console.error('Error adding comment:', error);
    showMessage('Failed to add comment. Please try again.');
  }
}

window.sharePost = async (postId) => {
  try {
    if (navigator.share) {
      navigator.share({
        title: 'Check out this MeetCast on MEET',
        text: 'I found this interesting MeetCast on MEET',
        url: window.location.href
      });
    } else {
      showMessage('MeetCast shared!', 'success');
    }
  } catch (error) {
    console.error('Error sharing MeetCast:', error);
    showMessage('Failed to share MeetCast. Please try again.');
  }
};

// Profile navigation
window.viewProfile = (userId) => {
  sessionStorage.setItem('targetUserId', userId);
  window.location.href = 'profile.html';
};

function goToMyProfile() {
  const user = auth.currentUser;
  if (user) {
    sessionStorage.removeItem('targetUserId');
    window.location.href = 'profile.html';
  }
}

// Close menus when clicking outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('.post-actions')) {
    document.querySelectorAll('.post-menu').forEach(menu => {
      menu.style.display = 'none';
    });
  }
});

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
  // Prevent zoom on double-tap (iOS)
  document.addEventListener('touchstart', function(e) {
    if (e.touches.length > 1) {
      e.preventDefault();
    }
  }, { passive: false });
  
  let lastTouchEnd = 0;
  document.addEventListener('touchend', function(e) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, false);
});
</script>
</body>
</html>
