<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Meetversity</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  /* --- CSS VARIABLES --- */
  :root {
    --primary: #0080FF;
    --bg-color: #f0f2f5;
    --card-bg: #fff;
    --text-color: #111;
    --secondary-text: #65676b;
    --border-color: #dddfe2;
    --edu-primary: #0061FF;
    --edu-accent: #5AE4A8;
    --edu-gradient: linear-gradient(135deg, var(--edu-primary) 0%, var(--edu-accent) 100%);
    --radius: 12px;
    --shadow: 0 4px 12px rgba(0,0,0,0.05);
    --success: #10B981;
    --heart-color: #FF4136;
    /* NEW: Course Details Blue Color */
    --detail-blue: #007bff; 
  }

  body.dark-mode {
    --bg-color: #18191a;
    --card-bg: #242526;
    --text-color: #e4e6eb;
    --secondary-text: #b0b3b8;
    --border-color: #3e4042;
    --shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-color); transition: all 0.3s ease; min-height: 100vh; font-size: 15px; }
  
  .app-container { display: flex; min-height: 100vh; }

  /* --- SIDEBAR & NAVBAR --- */
  .sidebar {
    position: fixed; left: 0; top: 0; height: 100vh; width: 180px;
    background: linear-gradient(180deg, #0080FF 0%, #00C6FF 100%);
    z-index: 100; padding: 15px; color: white;
  }
  .sidebar-header { margin-bottom: 20px; font-weight: 700; font-size: 20px; }
  .sidebar-menu { list-style: none; }
  .sidebar-menu a {
    display: flex; align-items: center; padding: 10px; text-decoration: none; color: white;
    border-radius: 8px; margin-bottom: 5px; transition: background 0.2s;
  }
  .sidebar-menu a:hover, .sidebar-menu a.active { background: rgba(255, 255, 255, 0.2); }
  .sidebar-menu i { width: 25px; text-align: center; margin-right: 10px; }

  .main-content { flex: 1; margin-left: 180px; padding: 20px; }
  
  .navbar {
    background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);
    padding: 12px 20px; border-radius: 12px; margin-bottom: 20px;
    display: flex; justify-content: space-between; align-items: center; color: white;
  }
  .nav-controls { display: flex; gap: 10px; align-items: center; }
  .btn-nav { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px; }

  /* --- MEETVERSITY UI --- */
  .meetversity-container { max-width: 1200px; margin: 0 auto; }
  
  .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
  .page-title { font-size: 24px; font-weight: 800; background: var(--edu-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  
  /* REDUCED BUTTON SIZE */
  .create-btn {
    background: var(--edu-primary); color: white; border: none; padding: 8px 16px;
    border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;
    font-size: 13px; box-shadow: 0 4px 10px rgba(0,97,255,0.3); transition: transform 0.2s;
  }
  .create-btn:hover { transform: translateY(-2px); }
  .create-btn:disabled { opacity: 0.7; cursor: not-allowed; }

  /* Stats Cards */
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; }
  .stat-card { background: var(--card-bg); padding: 15px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; }
  .stat-val { font-size: 24px; font-weight: 700; color: var(--edu-primary); }
  .stat-lbl { font-size: 12px; color: var(--secondary-text); }

  /* Course Grid */
  .section-head { display: flex; justify-content: space-between; align-items: center; margin: 30px 0 15px; }
  .section-head h2 { font-size: 18px; font-weight: 700; }
  
  .grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
  
  .course-card {
    background: var(--card-bg); border-radius: var(--radius); overflow: hidden;
    box-shadow: var(--shadow); transition: transform 0.2s; display: flex; flex-direction: column;
  }
  .course-card:hover { transform: translateY(-5px); }
  
  .course-header { position: relative; height: 150px; }
  .course-thumb { height: 100%; width: 100%; object-fit: cover; background: #eee; }
  
  /* Poster Image Overlay - Increased size (Req 4) */
  .poster-badge {
    position: absolute; bottom: -20px; right: 15px; /* Moved down slightly */
    width: 48px; height: 48px; /* Increased size */
    border-radius: 50%;
    border: 3px solid var(--card-bg); /* Thicker border */
    background: var(--edu-primary);
    overflow: hidden; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: bold;
  }
  .poster-badge img { width: 100%; height: 100%; object-fit: cover; }

  .course-body { padding: 20px 15px 15px; flex: 1; display: flex; flex-direction: column; }
  
  .c-cat { font-size: 10px; text-transform: uppercase; color: var(--edu-primary); font-weight: 700; letter-spacing: 0.5px; }
  .c-title { font-size: 15px; font-weight: 700; margin: 5px 0; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  
  /* Updated Meta/Stats Section */
  .c-stats { 
      display: flex; gap: 10px; font-size: 11px; color: var(--secondary-text); 
      margin-bottom: 10px; align-items: center; 
  }
  .c-stats i { margin-right: 3px; }

  .c-cert { background: rgba(16, 185, 129, 0.1); color: var(--success); padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; width: fit-content; margin-bottom: 8px; }
  
  .c-footer { margin-top: auto; padding-top: 10px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; }
  
  /* Love Button Style (Req 2) */
  .btn-love {
      background: none; border: 1px solid var(--border-color); color: var(--secondary-text); 
      padding: 6px 10px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px;
      transition: color 0.2s, border-color 0.2s;
  }
  .btn-love.loved { color: var(--heart-color); border-color: var(--heart-color); }

  .btn-detail { flex: 1; background: none; border: 1px solid var(--border-color); color: var(--text-color); padding: 6px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; }

  .btn-join { flex: 1; background: var(--edu-primary); color: white; border: none; padding: 6px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; }
  .btn-join.joined { background: var(--success); cursor: default; }

  /* NEW: Course Details Button Style */
  .btn-course-details {
    flex: 1;
    background: var(--detail-blue); /* Blue background */
    color: white; 
    border: none; /* No border for a solid look */
    padding: 6px; 
    border-radius: 6px; 
    cursor: pointer; 
    font-weight: 600; 
    font-size: 13px;
  }
  
  /* Modal */
  .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
  .modal-box { background: var(--card-bg); width: 100%; max-width: 600px; border-radius: 12px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
  .modal-head { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--card-bg); z-index: 10; }
  .modal-body { padding: 20px; }
  
  /* Detail Modal Specific Styles (Req 5) */
  #detailModal .modal-box { max-width: 750px; text-align: left; }
  .detail-header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
  .detail-title { font-size: 24px; margin-bottom: 10px; font-weight: 700; color: var(--edu-primary); }
  .detail-creator { display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: 600; font-size: 14px; margin-top: 5px;}
  .detail-bio { margin: 15px 0; padding: 10px; background: var(--bg-color); border-radius: 8px; font-style: italic; font-size: 13px; color: var(--secondary-text); }
  .detail-section h4 { font-size: 16px; margin-top: 15px; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 2px solid var(--edu-primary); width: fit-content; }
  .detail-outline li { margin-bottom: 5px; font-size: 14px; list-style-type: none; }
  .detail-outline li i { color: var(--success); margin-right: 5px; }

  /* --- CHAT STYLES (NEW) --- */
  .classroom-chat {
      margin-top: 30px;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
  }
  body.dark-mode .classroom-chat {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
  }

  .chat-feed {
      height: 300px;
      overflow-y: scroll;
      display: flex;
      flex-direction: column;
      gap: 8px;
      border: 1px solid #eee;
      padding: 15px;
      margin-bottom: 10px;
  }
  body.dark-mode .chat-feed {
      background: var(--bg-color);
      border-color: var(--border-color);
  }

  .message {
      padding: 8px 12px;
      border-radius: 15px;
      max-width: 80%;
      font-size: 14px;
      word-wrap: break-word;
  }

  .message.other {
      background: #e4e6eb; /* Light grey for others */
      color: var(--text-color);
      align-self: flex-start;
      border-top-left-radius: 2px;
  }
  body.dark-mode .message.other {
      background: #3e4042;
  }

  .message.self {
      background: #0080FF; /* Primary blue for current user */
      color: white;
      align-self: flex-end;
      border-top-right-radius: 2px;
  }

  .message strong {
      font-weight: 600;
      display: block;
      margin-bottom: 2px;
  }

  .message small {
      display: block;
      font-size: 10px;
      color: #65676b;
      margin-top: 3px;
      text-align: right;
  }

  .message.self small {
      color: rgba(255, 255, 255, 0.7);
  }
  /* --- END CHAT STYLES --- */

  /* Form Elements */
  .form-group { margin-bottom: 15px; }
  .form-label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; }
  .form-input, .form-select, .form-textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); font-family: inherit; font-size: 14px; }
  .form-textarea { min-height: 80px; resize: vertical; }
  
  .file-drop { border: 2px dashed var(--border-color); padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.2s; }
  .file-drop:hover { border-color: var(--edu-primary); background: rgba(0,97,255,0.02); }
  
  /* Dynamic List for "What you'll learn" */
  .learn-item { display: flex; gap: 10px; margin-bottom: 8px; }
  .btn-icon { background: transparent; border: 1px solid var(--border-color); color: var(--text-color); width: 36px; border-radius: 6px; cursor: pointer; }
  
  .type-tabs { display: flex; gap: 10px; margin-bottom: 20px; background: var(--bg-color); padding: 5px; border-radius: 8px; }
  .type-tab { flex: 1; border: none; background: transparent; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--secondary-text); font-size: 13px; }
  .type-tab.active { background: white; color: var(--edu-primary); shadow: 0 2px 5px rgba(0,0,0,0.05); }
  
  .progress-bar { height: 6px; background: #eee; border-radius: 3px; margin-top: 5px; overflow: hidden; display: none; }
  .progress-fill { height: 100%; background: var(--edu-primary); width: 0%; transition: width 0.3s; }

  /* Responsive */
  @media (max-width: 768px) {
    .sidebar { width: 60px; padding: 10px 5px; }
    .sidebar-header, .sidebar-menu span { display: none; }
    .sidebar-menu i { margin: 0; width: 100%; font-size: 20px; }
    .main-content { margin-left: 60px; padding: 15px; }
    .grid-layout { grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .navbar { flex-direction: column; align-items: flex-start; gap: 10px; }
    .nav-controls { width: 100%; justify-content: space-between; }
  }
  @media (max-width: 480px) {
    .grid-layout { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div class="app-container">
  <div class="sidebar">
    <div class="sidebar-header">MEET</div>
    <ul class="sidebar-menu">
      <li><a href="feed.html"><i class="fas fa-home"></i> <span>Feed</span></a></li>
      <li><a href="#" class="active"><i class="fas fa-graduation-cap"></i> <span>Meetversity</span></a></li>
      <li><a href="chat.html"><i class="fas fa-comment"></i> <span>Chat</span></a></li>
      <li><a href="meetrader.html"><i class="fas fa-chart-line"></i> <span>Meetrader</span></a></li>
      <li><a href="profile.html"><i class="fas fa-user"></i> <span>Profile</span></a></li>
    </ul>
  </div>

  <div class="main-content">
    <div class="navbar">
      <h3>Meetversity</h3>
      <div class="nav-controls">
        <div style="display:flex; align-items:center; gap:10px;">
          <div id="userAvatar" style="width:32px; height:32px; background:white; color:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:14px; overflow:hidden;">U</div>
          <span id="userNameDisplay" style="font-size:14px;">Guest</span>
        </div>
        <button class="btn-nav" id="toggleDark"><i class="fas fa-moon"></i></button>
        <button class="btn-nav" onclick="auth.signOut()"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </div>

    <div class="meetversity-container">
      <div class="header-section">
        <h1 class="page-title">ACADEMY</h1>
        <button class="create-btn" onclick="window.openCreateModal()">
          <i class="fas fa-plus"></i> Create Course 
        </button>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-val" id="statCourses">0</div>
          <div class="stat-lbl">Full Courses</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="statLearners">0</div>
          <div class="stat-lbl">Learners</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="statVideos">0</div>
          <div class="stat-lbl">Quick Vids</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="statDocs">0</div>
          <div class="stat-lbl">Notes/Docs</div>
        </div>
      </div>

      <div class="section-head"><h2>Full Course Videos</h2></div>
      <div class="grid-layout" id="coursesFeed"><div style="padding:20px;">Loading...</div></div>

      <div class="section-head"><h2>Quick Videos</h2></div>
      <div class="grid-layout" id="videosFeed"></div>

      <div class="section-head"><h2>Notes & Documents</h2></div>
      <div class="grid-layout" id="docsFeed"></div>
    </div>
  </div>
</div>

<div class="modal" id="createModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3>Create Content</h3>
      <button onclick="closeCreateModal()" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
    </div>
    <div class="modal-body">
      <div class="type-tabs">
        <button class="type-tab active" onclick="setType('long-video', this)">Full Course (Video)</button>
        <button class="type-tab" onclick="setType('quick-video', this)">Quick Video</button>
        <button class="type-tab" onclick="setType('document', this)">Document (PDF/Note)</button>
      </div>

      <form id="createForm">
        <div class="form-group">
          <label class="form-label">Course Title</label>
          <input type="text" id="cTitle" class="form-input" placeholder="e.g. Advanced React Patterns" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Description / Summary</label>
          <textarea id="cDescription" class="form-textarea" placeholder="Briefly describe what this content covers (min 10 chars)" required></textarea>
        </div>


        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
          <div class="form-group">
            <label class="form-label">Category</label>
            <select id="cCategory" class="form-select">
              <option>Technology</option>
              <option>Business</option>
              <option>Design</option>
              <option>Marketing</option>
              <option>Health</option>
              <option>Academic</option>
              <option>Lifestyle</option>
              <option>Life Hack</option>
              <option>Sport</option>
              <option>Human Kinetics</option>
              <option>Guidance & Counseling</option>
              <option>Psychology</option>
              <option>Forensic Psychology</option>
              <option>Pastoral Psychology</option>
              <option>Ethical Hacking</option>
              <option>Finance</option>
              <option>Cooking</option>
              <option>Photography</option>
              <option>Personal Development</option>
              <option>Language Learning</option>
              <option>Arts & Crafts</option>
              <option>Travel</option>
              <option>Gaming</option>
              <option>History</option>
              <option>Science</option>
              <option>Mathematics</option>
              <option>Music Theory</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Duration / File Count</label>
            <input type="text" id="cDuration" class="form-input" placeholder="e.g. 2h 30m or 1 PDF" required>
          </div>
        </div>

        <input type="hidden" id="cPrice" value="0">
        <input type="hidden" id="cCurrency" value="USD">

        <div class="form-group">
          <label class="form-label">Instructor Bio (Optional)</label>
          <textarea id="cInstructorBio" class="form-textarea" placeholder="A short bio for your course page (max 500 chars)"></textarea>
        </div>


        <div class="form-group">
          <label class="form-label">Cover Image (Compressed)</label>
          <div class="file-drop" onclick="document.getElementById('cThumb').click()">
            <i class="fas fa-image" style="font-size:20px; color:var(--secondary-text);"></i>
            <p style="font-size:11px; color:var(--secondary-text); margin-top:5px;">Click to upload thumbnail</p>
            <input type="file" id="cThumb" accept="image/*" style="display:none" onchange="previewThumb(this)" required>
          </div>
          <img id="thumbPreview" style="width:100%; height:120px; object-fit:cover; border-radius:8px; display:none; margin-top:10px;">
        </div>

        <div class="form-group">
          <label class="form-label" id="mediaLabel">Upload Video File</label>
          <input type="file" id="cMediaFile" class="form-input" accept="video/*" required>
          <div class="progress-bar" id="mediaProgress">
              <div class="progress-fill" id="mediaProgressFill"></div>
          </div>
          <small style="color:var(--secondary-text); font-size:10px;">File will be uploaded via Cloudinary.</small>
        </div>

        <div class="form-group" id="learnSection">
          <label class="form-label">Course Outline (What you'll learn)</label>
          <div id="learnContainer">
             <div class="learn-item">
                 <input type="text" class="form-input learn-input" placeholder="e.g. Master CSS Grid">
                 <button type="button" class="btn-icon" onclick="this.parentElement.remove()">&times;</button>
             </div>
          </div>
          <button type="button" onclick="addLearnItem()" style="background:none; border:none; color:var(--primary); font-size:12px; cursor:pointer;">+ Add lesson/outcome</button>
        </div>

        <div class="form-group" id="certCheckboxGroup">
          <label style="display:flex; align-items:center; gap:10px; font-size:13px; cursor:pointer;">
            <input type="checkbox" id="cCert"> Offer MEET Certificate (Only for Full Courses)
          </label>
        </div>

        <button type="button" class="create-btn" id="submitBtn" style="width:100%; justify-content:center; padding:12px;" onclick="submitCourse()">
          Public Course </button>
      </form>
    </div>
  </div>
</div>

<div class="modal" id="applicationModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3>Course Application</h3>
      <button onclick="closeApplicationModal()" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
    </div>
    <div class="modal-body">
      <form id="applicationForm">
        <input type="hidden" id="applyCourseId">
        <p style="margin-bottom: 15px; font-size: 14px; color: var(--secondary-text);">Fill out this form to apply for <strong id="applyCourseTitle"></strong>.</p>

        <div class="form-group">
          <label class="form-label">Your Full Name</label>
          <input type="text" id="applicantName" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Email Address (For MEET Certificate)</label>
          <input type="email" id="applicantEmail" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Your Aspirations for learning this course</label>
          <textarea id="applicantAspirations" class="form-textarea" placeholder="Why do you want to join? (Min 20 chars)" required></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Current Role / Profession</label>
          <input type="text" id="applicantRole" class="form-input" placeholder="e.g. Student, Software Developer, Chef">
        </div>
        
        <button type="button" class="create-btn" id="submitApplicationBtn" style="width:100%; justify-content:center; padding:12px;" onclick="submitApplication()">
          Submit Application
        </button>
      </form>
    </div>
  </div>
</div>

<div class="modal" id="detailModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3 id="detailModalTitle">Content Details</h3>
      <button onclick="closeDetailModal()" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
    </div>
    <div class="modal-body" id="detailModalBodyContent">
      </div>
  </div>
</div>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, updateDoc, arrayUnion, arrayRemove, onSnapshot, query, orderBy, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  
  // <<< NEW: RTDB IMPORTS >>>
  import { getDatabase, ref, push, onValue, limitToLast } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
  // <<< END NEW IMPORTS >>>

  // --- FIREBASE CONFIG ---
  const firebaseConfig = {
      // NOTE: Replace this with your ACTUAL Firebase configuration!
      apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM", 
      authDomain: "meet-6e159.firebaseapp.com",
      databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com", // <<< CRITICAL FOR RTDB
      projectId: "meet-6e159",
      storageBucket: "meet-6e159-firebasestorage.app",
      messagingSenderId: "252353608421",
      appId: "1:252353608421:web:6706056048e9a8f12db20c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  
  // <<< NEW: RTDB INITIALIZATION >>>
  const rtdb = getDatabase(app); 
  window.rtdb = rtdb; // Expose globally
  // <<< END NEW INITIALIZATION >>>
  
  window.auth = auth;
  
  // Expose modal functions globally for inline HTML calls
  window.openCreateModal = () => { document.getElementById('createModal').style.display = 'flex'; };
  window.closeCreateModal = () => { document.getElementById('createModal').style.display = 'none'; document.getElementById('createForm').reset(); document.getElementById('thumbPreview').style.display = 'none'; thumbBase64 = null; };

  // --- CLOUDINARY CONFIG ---
  const CLOUD_NAME = "dcwof2ngn"; 
  const UPLOAD_PRESET = "Meet_video";
  const CLOUDINARY_GENERIC_URL = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`; 

  let currentUser = null;
  let currentType = 'long-video';
  let thumbBase64 = null; 
  let loveCounts = {};
  let reviewCounts = {};
  
  let chatUnsubscriber = null; // To hold the RTDB listener reference

  // --- AUTH & USER PROFILE ---
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      const userDoc = await getDoc(doc(db, "users", user.uid));
      const userData = userDoc.exists() ? userDoc.data() : {};
      
      currentUser.displayName = userData.displayName || user.displayName;
      currentUser.photoURL = userData.photoURL || user.photoURL;

      document.getElementById('userNameDisplay').innerText = currentUser.displayName || 'User';
      if(currentUser.photoURL) {
          document.getElementById('userAvatar').innerHTML = `<img src="${currentUser.photoURL}" style="width:100%;height:100%;object-fit:cover;">`;
      }
    } else {
      currentUser = null;
      document.getElementById('userNameDisplay').innerText = "Guest";
    }
  });

  // --- CHAT FUNCTIONS (NEW) ---
  const sendMessage = (courseId) => {
    const inputElement = document.getElementById(`messageInput-${courseId}`);
    const text = inputElement.value.trim();
    const type = 'message'; // Simple message type for now
    
    if (!window.currentUser || !text || !courseId) return; 

    const messagesRef = ref(window.rtdb, `course_chats/${courseId}/messages`);
    
    push(messagesRef, {
        senderId: window.currentUser.uid,
        senderName: window.currentUser.displayName || (window.currentUser.email ? window.currentUser.email.split('@')[0] : 'User'),
        text: text,
        timestamp: Date.now(),
        type: type 
    })
    .then(() => {
        inputElement.value = ''; // Clear input on success
    })
    .catch(error => {
        console.error("Failed to send message:", error);
        alert("Failed to send message. Check network or rules.");
    });
  };

  const setupChatListener = (courseId) => {
    const messagesFeed = document.getElementById(`messagesFeed-${courseId}`);
    if (!messagesFeed) return;

    // Remove previous listener if one exists
    if (chatUnsubscriber) chatUnsubscriber();

    const messagesRef = ref(window.rtdb, `course_chats/${courseId}/messages`);
    const chatQuery = query(messagesRef, limitToLast(50));
    
    // onValue returns the function to unsubscribe/stop listening
    chatUnsubscriber = onValue(chatQuery, (snapshot) => {
        messagesFeed.innerHTML = ''; // Clear and redraw all loaded messages
        
        snapshot.forEach((childSnapshot) => {
            const messageData = childSnapshot.val();
            const isSelf = messageData.senderId === window.currentUser.uid;
            
            const msgEl = document.createElement('div');
            msgEl.className = `message ${isSelf ? 'self' : 'other'}`;
            
            const senderDisplay = isSelf ? 'You' : messageData.senderName;

            msgEl.innerHTML = `
                ${!isSelf ? `<strong>${senderDisplay}:</strong>` : ''}
                <span>${messageData.text}</span>
                <small>${new Date(messageData.timestamp).toLocaleTimeString()}</small>
            `;
            messagesFeed.appendChild(msgEl);
        });
        
        // Auto-scroll to the bottom
        messagesFeed.scrollTop = messagesFeed.scrollHeight;
    });
  };
  // --- END CHAT FUNCTIONS ---

  // --- COMPRESSION LOGIC (For Thumbnails) ---
  const compressImage = (file) => {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.src = e.target.result;
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const MAX = 500;
          const scale = Math.min(MAX / img.width, 1);
          canvas.width = img.width * scale;
          canvas.height = img.height * scale;
          
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          resolve(canvas.toDataURL('image/jpeg', 0.6));
        };
      };
      reader.readAsDataURL(file);
    });
  };

  // --- CLOUDINARY UPLOAD HELPER ---
  const uploadToCloudinary = async (fileOrBase64) => {
    const formData = new FormData();

    if (fileOrBase64 instanceof File) {
        formData.append("file", fileOrBase64);
    } else if (typeof fileOrBase64 === 'string' && fileOrBase64.startsWith('data:')) {
        formData.append("file", fileOrBase64); 
    } else {
        throw new Error("Invalid file or Base64 string provided for upload.");
    }

    formData.append("upload_preset", UPLOAD_PRESET);
    
    try {
        const response = await fetch(CLOUDINARY_GENERIC_URL, { method: "POST", body: formData });
        const data = await response.json();

        if (data.error || !response.ok) {
            console.error("Upload Error:", data.error?.message || response.statusText, data);
            throw new Error(`Cloudinary Error: ${data.error?.message || 'Upload failed.'}`);
        }
        
        return data.secure_url;
    } catch (err) {
        console.error("Upload failed in helper:", err.message || err);
        throw err;
    }
  };

  // --- FEED & UI LOGIC ---
  const q = query(collection(db, "meetversity_courses"), orderBy("createdAt", "desc"));
  onSnapshot(q, (snapshot) => {
    const courses = [], videos = [], docs = [];
    let learners = 0;

    snapshot.docChanges().forEach(change => {
        const data = { id: change.doc.id, ...change.doc.data() };
        loveCounts[data.id] = data.lovedBy ? data.lovedBy.length : 0;
        reviewCounts[data.id] = data.reviewCount || 0;
    });

    snapshot.forEach((doc) => {
      const data = { id: doc.id, ...doc.data() };
      learners += (data.learners ? data.learners.length : 0);
      if(data.type === 'long-video') courses.push(data);
      else if(data.type === 'quick-video') videos.push(data);
      else docs.push(data);
    });

    document.getElementById('statCourses').innerText = courses.length;
    document.getElementById('statVideos').innerText = videos.length;
    document.getElementById('statDocs').innerText = docs.length;
    document.getElementById('statLearners').innerText = learners;

    renderGrid('coursesFeed', courses); // Full Course Videos
    renderGrid('videosFeed', videos); // Quick Videos
    renderGrid('docsFeed', docs); // Notes & Documents
  });

  function renderGrid(id, items) {
    const container = document.getElementById(id);
    container.innerHTML = '';
    if(!items.length) { container.innerHTML = '<div style="padding:10px; color:#888;">No content yet.</div>'; return; }

    items.forEach(item => {
      const isJoined = currentUser && item.learners?.includes(currentUser.uid);
      const isLoved = currentUser && item.lovedBy?.includes(currentUser.uid);
      const loves = loveCounts[item.id] || 0;
      const reviews = reviewCounts[item.id] || 0;

      const posterImg = item.instructorPhoto 
        ? `<img src="${item.instructorPhoto}" style="width:100%;height:100%;object-fit:cover;">` 
        : `<div style="width:100%;height:100%;background:#0080FF;color:white;display:flex;align-items:center;justify-content:center;">${item.instructorName?.[0]||'U'}</div>`;

      let actionButtons;
      let hasCertificate = item.hasCert && item.type !== 'document';

      if (item.type === 'long-video') {
          actionButtons = `
            <button class="btn-course-details" onclick="viewDetails('${item.id}')">Course Details</button>
            <button class="btn-join ${isJoined ? 'joined' : ''}" ${isJoined ? 'disabled' : ''} onclick="${isJoined ? '' : `openApplicationModal('${item.id}', '${item.title}')`}">
              ${isJoined ? 'Enrolled' : 'Enroll'}
            </button>
          `;
          hasCertificate = item.hasCert;
      } else {
          actionButtons = `<button class="btn-detail" onclick="viewDetails('${item.id}')">Details</button>`;
          hasCertificate = item.hasCert && item.type === 'quick-video'; 
      }

      const div = document.createElement('div');
      div.className = 'course-card';
      div.innerHTML = `
        <div class="course-header">
            <img src="${item.thumbnail || 'https://via.placeholder.com/300'}" class="course-thumb">
            <div class="poster-badge">${posterImg}</div>
        </div>
        <div class="course-body">
          ${hasCertificate ? '<div class="c-cert"><i class="fas fa-certificate"></i> Certificate</div>' : ''}
          <div class="c-cat">${item.category}</div>
          <div class="c-title">${item.title}</div>
          
          <div class="c-stats">
            <i class="fas fa-clock"></i>${item.duration}
            <i class="fas fa-star"></i>${reviews} Reviews
            <span>${item.instructorName}</span>
          </div>

          <div class="c-footer">
             <button class="btn-love ${isLoved ? 'loved' : ''}" onclick="toggleLove('${item.id}')">
                <i class="fas fa-heart"></i> <span class="love-count" data-id="${item.id}">${loves}</span>
            </button>
             ${actionButtons}
          </div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  // --- LOVE TOGGLE LOGIC (Uses arrayUnion/arrayRemove) ---
  window.toggleLove = async (courseId) => {
    if (!currentUser) { alert("Login required to show love."); return; }
    const courseRef = doc(db, "meetversity_courses", courseId);

    const courseCard = document.querySelector(`.course-card .btn-love[onclick*="${courseId}"]`);
    const isLoved = courseCard?.classList.contains('loved');

    try {
        if (isLoved) {
            await updateDoc(courseRef, { lovedBy: arrayRemove(currentUser.uid) });
            courseCard?.classList.remove('loved');
        } else {
            await updateDoc(courseRef, { lovedBy: arrayUnion(currentUser.uid) });
            courseCard?.classList.add('loved');
        }
    } catch (e) {
        console.error("Love toggle failed:", e);
        alert("Failed to update love status. (Check Firebase Rules)");
    }
  };


  // --- DETAILS MODAL LOGIC (INCLUDING CHAT) ---
  window.viewDetails = async (courseId) => {
    if (!currentUser) { alert("Login required to view content details."); return; }
    
    const courseRef = doc(db, "meetversity_courses", courseId);
    const courseDoc = await getDoc(courseRef);
    if (!courseDoc.exists()) { alert("Content not found."); return; }
    const data = courseDoc.data();
    
    const isEnrolled = data.learners?.includes(currentUser.uid);
    const detailModalBody = document.getElementById('detailModalBodyContent');
    
    // --- START: Build HTML Content for Detail Modal ---
    let html = `
        <div class="detail-header">
            <div class="detail-title">${data.title}</div>
            <div class="detail-creator">
                <div id="detailCreatorBadge" class="poster-badge" style="width:36px; height:36px;">${data.instructorPhoto ? `<img src="${data.instructorPhoto}" style="width:100%;height:100%;object-fit:cover;">` : (data.instructorName?.[0]||'U')}</div>
                <span>By ${data.instructorName}</span>
            </div>
            <div class="detail-meta" style="margin-top: 10px; font-size: 12px; color: var(--secondary-text);">
                ${data.category} | Duration: ${data.duration}
            </div>
        </div>

        <div class="detail-section">
            <h4>Course Summary</h4>
            <p>${data.description}</p>
            
            <h4>Instructor Profile</h4>
            <p class="detail-bio">${data.instructorBio || "The creator has not provided a bio."}</p>
        </div>
        
        <div class="detail-section" id="detailOutlineSection-${courseId}" style="${(data.outcomes && data.outcomes.length > 0) ? 'display:block;' : 'display:none;'}">
            <h4>Course Outline / Learning Outcomes</h4>
            <ul class="detail-outline">
                ${(data.outcomes || []).map(item => `<li><i class="fas fa-check-circle"></i> ${item}</li>`).join('')}
            </ul>
        </div>

        <div id="detailCertificateInfo-${courseId}" style="margin-top:10px; font-size:12px; font-weight:600; color:var(--success); text-align:center;">
             ${(data.type !== 'document' && data.hasCert) ? '<i class="fas fa-certificate"></i> This content offers a MEET Certificate.' : ''}
        </div>
        
        <button class="create-btn" id="detailJoinBtn-${courseId}" 
                style="width:100%; margin-top: 20px; display:${data.type === 'long-video' ? 'block' : 'none'};" 
                onclick="${isEnrolled ? '' : `openApplicationModal('${courseId}', '${data.title}')`}"
                data-course-id="${courseId}" data-course-title="${data.title}" ${isEnrolled ? 'disabled' : ''}>
            ${isEnrolled ? 'Enrolled' : 'Enroll / Join Class'}
        </button>

        <div id="detailMediaEmbed-${courseId}" style="margin-top:20px; text-align: center;">
             <a href="${data.mediaUrl}" target="_blank" style="color:var(--primary); font-size:14px;"><i class="fas fa-external-link-alt"></i> View Content File</a>
        </div>
        
        ${isEnrolled ? `
            <div class="classroom-chat">
                <h3><i class="fas fa-comments"></i> Live Class Discussion</h3>
                <div id="messagesFeed-${courseId}" class="chat-feed">
                    <p style="text-align:center; color:#999;">Loading real-time discussion...</p>
                </div>
                <div class="chat-input-area" style="display: flex; margin-top: 10px; gap: 10px;">
                    <input type="text" id="messageInput-${courseId}" placeholder="Type message or question..." maxlength="450" 
                           style="flex-grow: 1; padding: 10px; border-radius: 20px; border: 1px solid var(--border-color); background:var(--bg-color); color:var(--text-color);">
                    <button id="sendBtn-${courseId}" style="background: var(--edu-primary); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer;">
                        Send <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        ` : ''}
        `;
    // --- END: Build HTML Content for Detail Modal ---
    
    detailModalBody.innerHTML = html;
    document.getElementById('detailModal').style.display = 'flex';
    
    // --- ATTACH CHAT LISTENERS (Only if Enrolled) ---
    if (isEnrolled) {
        // 1. Start the real-time message listener
        setupChatListener(courseId);

        // 2. Attach the Send button event
        document.getElementById(`sendBtn-${courseId}`).addEventListener('click', () => {
            sendMessage(courseId);
        });

        // 3. Attach the Enter key event
        document.getElementById(`messageInput-${courseId}`).addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage(courseId);
            }
        });
    }
    // --- END CHAT LISTENERS ---
  };
  
  window.closeDetailModal = () => {
    document.getElementById('detailModal').style.display = 'none';
    if (chatUnsubscriber) {
        chatUnsubscriber(); // Stop the real-time chat listener
        chatUnsubscriber = null;
    }
  };


  // --- APPLICATION FORM MODAL LOGIC (Enrollment) ---

  window.openApplicationModal = (courseId, title) => {
    if (!currentUser) { alert("Login required to apply for a course."); return; }
    document.getElementById('applyCourseId').value = courseId;
    document.getElementById('applyCourseTitle').innerText = title;
    
    document.getElementById('applicantName').value = currentUser.displayName || '';
    document.getElementById('applicantEmail').value = currentUser.email || '';

    document.getElementById('applicationModal').style.display = 'flex';
    document.getElementById('detailModal').style.display = 'none';
  };

  window.closeApplicationModal = () => {
    document.getElementById('applicationModal').style.display = 'none';
    document.getElementById('applicationForm').reset();
  };

  window.submitApplication = async () => {
    const courseId = document.getElementById('applyCourseId').value;
    const name = document.getElementById('applicantName').value;
    const email = document.getElementById('applicantEmail').value;
    const aspirations = document.getElementById('applicantAspirations').value;
    const role = document.getElementById('applicantRole').value;

    if (!name || !email || aspirations.length < 20) {
        alert("Please fill in your name, email, and provide at least 20 characters for your aspirations.");
        return;
    }

    const submitBtn = document.getElementById('submitApplicationBtn');
    submitBtn.innerText = "Submitting...";
    submitBtn.disabled = true;

    try {
        // 1. Save Application
        await addDoc(collection(db, "course_applications"), {
            courseId: courseId,
            applicantId: currentUser.uid,
            name: name,
            email: email,
            aspirations: aspirations,
            role: role || 'N/A',
            appliedAt: serverTimestamp()
        });

        // 2. Mark user as 'learner' in the course document
        await updateDoc(doc(db, "meetversity_courses", courseId), {
            learners: arrayUnion(currentUser.uid)
        });

        alert("Form submitted, You are successfully enrolled!");
        closeApplicationModal();
        viewDetails(courseId); // Refresh the detail view to show the chat

    } catch (e) {
        console.error("Application submission failed:", e);
        alert(`Submission failed: ${e.message || "An unknown error occurred. (Check Firebase Rules)"}`);
    } finally {
        submitBtn.innerText = "Submit Application";
        submitBtn.disabled = false;
    }
  };

  // --- CREATION FORM LOGIC ---

  window.setType = (type, btn) => {
      currentType = type;
      document.querySelectorAll('.type-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      
      const mediaInput = document.getElementById('cMediaFile');
      const label = document.getElementById('mediaLabel');
      const learnSection = document.getElementById('learnSection');
      const certCheckboxGroup = document.getElementById('certCheckboxGroup');

      if(type === 'document') {
          label.innerText = "Upload Document (PDF, Image, or DOC)";
          mediaInput.accept = "image/*, application/pdf, .doc, .docx";
          document.getElementById('cDuration').placeholder = 'e.g. 1 PDF or 3 Images';
          learnSection.style.display = 'none'; 
          certCheckboxGroup.style.display = 'none';
      } else if (type === 'quick-video') {
          label.innerText = "Upload Quick Video File";
          mediaInput.accept = "video/*";
          document.getElementById('cDuration').placeholder = 'e.g. 5m 30s';
          learnSection.style.display = 'none';
          certCheckboxGroup.style.display = 'flex';
      } else { // long-video
          label.innerText = "Upload Full Course Video File";
          mediaInput.accept = "video/*";
          document.getElementById('cDuration').placeholder = 'e.g. 2h 30m';
          learnSection.style.display = 'block'; 
          certCheckboxGroup.style.display = 'flex';
      }
      mediaInput.value = ''; 
  };

  window.addLearnItem = () => {
      const div = document.createElement('div');
      div.className = 'learn-item';
      div.innerHTML = `<input type="text" class="form-input learn-input" placeholder="Lesson/Outcome..."><button type="button" class="btn-icon" onclick="this.parentElement.remove()">&times;</button>`;
      document.getElementById('learnContainer').appendChild(div);
  };

  window.previewThumb = async (input) => {
      if (input.files && input.files[0]) {
          const compressedDataUrl = await compressImage(input.files[0]);
          thumbBase64 = compressedDataUrl;
          const preview = document.getElementById('thumbPreview');
          preview.src = thumbBase64;
          preview.style.display = 'block';
      }
  };

  // Main Submit Logic
  window.submitCourse = async () => {
      const btn = document.getElementById('submitBtn');
      const progress = document.getElementById('mediaProgress');
      const fill = document.getElementById('mediaProgressFill');
      
      const title = document.getElementById('cTitle').value;
      const description = document.getElementById('cDescription').value;
      const category = document.getElementById('cCategory').value;
      const duration = document.getElementById('cDuration').value;
      const instructorBio = document.getElementById('cInstructorBio').value;
      const hasCert = document.getElementById('cCert').checked;
      
      const mediaFile = document.getElementById('cMediaFile').files[0];
      
      const price = 0; 
      const currency = 'USD';

      if(!title || !mediaFile || !description || !duration) {
        alert("Please fill in all required fields.");
        return;
      }
      if(description.length < 10) {
        alert("Description must be at least 10 characters long.");
        return;
      }

      const learnInputs = document.querySelectorAll('.learn-input');
      const outcomes = [];
      if(currentType === 'long-video') {
          learnInputs.forEach(i => { if(i.value.trim()) outcomes.push(i.value.trim()); });
          if(outcomes.length === 0) { alert("Please provide at least one lesson/outcome for Full Course content."); return; }
      }

      if(!thumbBase64) { alert("Please upload a thumbnail"); return; }

      btn.innerText = "Uploading...";
      btn.disabled = true;
      progress.style.display = 'block';
      fill.style.width = '10%';

      try {
          // 1. Upload Thumbnail
          const thumbUrl = await uploadToCloudinary(thumbBase64);
          fill.style.width = '40%';

          // 2. Upload Main Content
          const mediaUrl = await uploadToCloudinary(mediaFile); 
          fill.style.width = '80%';

          // 3. Save to Firestore
          await addDoc(collection(db, "meetversity_courses"), {
              title, 
              description, 
              category, 
              duration,
              price,
              currency,
              instructorBio: instructorBio || null,
              type: currentType,
              thumbnail: thumbUrl,
              mediaUrl: mediaUrl,
              outcomes: outcomes,
              hasCert: hasCert,
              instructorId: currentUser.uid,
              instructorName: currentUser.displayName || 'Instructor',
              instructorPhoto: currentUser.photoURL || null,
              learners: [],
              lovedBy: [],
              reviewCount: 0,
              createdAt: serverTimestamp()
          });

          fill.style.width = '100%';
          alert("Content Posted Successfully!");
          closeCreateModal();

      } catch(e) {
          console.error("Final Submission Error:", e);
          alert(`Upload failed: ${e.message || "An unknown error occurred."}`);
      } finally {
          btn.innerText = "Public Course";
          btn.disabled = false;
          progress.style.display = 'none';
      }
  };

  // Dark mode toggle
  document.getElementById('toggleDark').onclick = () => document.body.classList.toggle('dark-mode');

  // Initialize form to correct state on load
  document.addEventListener('DOMContentLoaded', () => {
    setType(currentType, document.querySelector(`.type-tab[onclick*="long-video"]`));
  });

</script>
</body>
</html>
