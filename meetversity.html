<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Meetversity</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  /* --- CSS VARIABLES & BASE STYLES --- */
  :root {
    --primary: #0080FF;
    --bg-color: #f0f2f5;
    --card-bg: #fff;
    --text-color: #111;
    --secondary-text: #65676b;
    --border-color: #dddfe2;
    --edu-primary: #0061FF;
    --edu-accent: #5AE4A8;
    --edu-gradient: linear-gradient(135deg, var(--edu-primary) 0%, var(--edu-accent) 100%);
    --radius: 12px;
    --shadow: 0 4px 12px rgba(0,0,0,0.05);
    --success: #10B981;
  }

  body.dark-mode {
    --bg-color: #18191a;
    --card-bg: #242526;
    --text-color: #e4e6eb;
    --secondary-text: #b0b3b8;
    --border-color: #3e4042;
    --shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-color); transition: all 0.3s ease; min-height: 100vh; font-size: 15px; }
  
  .app-container { display: flex; min-height: 100vh; }

  /* --- SIDEBAR & NAVBAR (Standardized) --- */
  .sidebar {
    position: fixed; left: 0; top: 0; height: 100vh; width: 180px;
    background: linear-gradient(180deg, #0080FF 0%, #00C6FF 100%);
    z-index: 100; padding: 15px; color: white;
  }
  .sidebar-header { margin-bottom: 20px; font-weight: 700; font-size: 20px; }
  .sidebar-menu { list-style: none; }
  .sidebar-menu a {
    display: flex; align-items: center; padding: 10px; text-decoration: none; color: white;
    border-radius: 8px; margin-bottom: 5px; transition: background 0.2s;
  }
  .sidebar-menu a:hover, .sidebar-menu a.active { background: rgba(255, 255, 255, 0.2); }
  .sidebar-menu i { width: 25px; text-align: center; margin-right: 10px; }

  .main-content { flex: 1; margin-left: 180px; padding: 20px; }
  
  .navbar {
    background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);
    padding: 12px 20px; border-radius: 12px; margin-bottom: 20px;
    display: flex; justify-content: space-between; align-items: center; color: white;
  }
  .nav-controls { display: flex; gap: 10px; align-items: center; }
  .btn-nav { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px; }

  /* --- MEETVERSITY SPECIFIC UI --- */
  .meetversity-container { max-width: 1200px; margin: 0 auto; }
  
  .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
  .page-title { font-size: 28px; font-weight: 800; background: var(--edu-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  
  .create-btn {
    background: var(--edu-primary); color: white; border: none; padding: 12px 24px;
    border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;
    box-shadow: 0 4px 10px rgba(0,97,255,0.3); transition: transform 0.2s;
  }
  .create-btn:hover { transform: translateY(-2px); }

  /* Stats Cards */
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; }
  .stat-card { background: var(--card-bg); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; }
  .stat-val { font-size: 28px; font-weight: 700; color: var(--edu-primary); }
  .stat-lbl { font-size: 13px; color: var(--secondary-text); }

  /* Sections */
  .section-head { display: flex; justify-content: space-between; align-items: center; margin: 30px 0 15px; }
  .section-head h2 { font-size: 20px; font-weight: 700; }

  /* Course Grid */
  .grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
  
  .course-card {
    background: var(--card-bg); border-radius: var(--radius); overflow: hidden;
    box-shadow: var(--shadow); transition: transform 0.2s; display: flex; flex-direction: column;
  }
  .course-card:hover { transform: translateY(-5px); }
  .course-thumb { height: 160px; width: 100%; object-fit: cover; background: #eee; }
  .course-body { padding: 15px; flex: 1; display: flex; flex-direction: column; }
  
  .c-cat { font-size: 11px; text-transform: uppercase; color: var(--edu-primary); font-weight: 700; letter-spacing: 0.5px; }
  .c-title { font-size: 16px; font-weight: 700; margin: 5px 0; line-height: 1.3; }
  .c-meta { display: flex; justify-content: space-between; font-size: 12px; color: var(--secondary-text); margin-bottom: 10px; }
  .c-cert { background: rgba(16, 185, 129, 0.1); color: var(--success); padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; width: fit-content; margin-bottom: 5px; }
  
  .c-footer { margin-top: auto; padding-top: 10px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; }
  .btn-join { flex: 1; background: var(--edu-primary); color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; }
  .btn-join.joined { background: var(--success); cursor: default; }
  .btn-review { background: transparent; border: 1px solid var(--border-color); color: var(--text-color); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; }

  /* Content Type Selection (in Modal) */
  .type-tabs { display: flex; gap: 10px; margin-bottom: 20px; background: var(--bg-color); padding: 5px; border-radius: 8px; }
  .type-tab { flex: 1; border: none; background: transparent; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--secondary-text); transition: 0.2s; }
  .type-tab.active { background: white; color: var(--edu-primary); shadow: 0 2px 5px rgba(0,0,0,0.05); }

  /* Modal Styles */
  .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
  .modal-box { background: var(--card-bg); width: 100%; max-width: 600px; border-radius: 12px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
  .modal-head { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
  .modal-body { padding: 20px; }
  
  /* Form Elements */
  .form-group { margin-bottom: 15px; }
  .form-label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; }
  .form-input, .form-select, .form-textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); font-family: inherit; }
  .form-textarea { min-height: 80px; resize: vertical; }
  
  .file-area { border: 2px dashed var(--border-color); padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; margin-top: 5px; }
  .file-area:hover { border-color: var(--edu-primary); background: rgba(0,97,255,0.02); }
  
  /* Responsive */
  @media (max-width: 768px) {
    .sidebar { width: 60px; padding: 10px 5px; }
    .sidebar-header, .sidebar-menu span { display: none; }
    .sidebar-menu i { margin: 0; width: 100%; font-size: 20px; }
    .main-content { margin-left: 60px; padding: 15px; }
    .grid-layout { grid-template-columns: 1fr; }
    .navbar { flex-direction: column; align-items: flex-start; gap: 10px; }
    .nav-controls { width: 100%; justify-content: space-between; }
  }
</style>
</head>
<body>

<div class="app-container">
  <div class="sidebar">
    <div class="sidebar-header">MEET</div>
    <ul class="sidebar-menu">
      <li><a href="feed.html"><i class="fas fa-home"></i> <span>Feed</span></a></li>
      <li><a href="#" class="active"><i class="fas fa-graduation-cap"></i> <span>Meetversity</span></a></li>
      <li><a href="chat.html"><i class="fas fa-comment"></i> <span>Chat</span></a></li>
      <li><a href="meetrader.html"><i class="fas fa-chart-line"></i> <span>Meetrader</span></a></li>
      <li><a href="profile.html"><i class="fas fa-user"></i> <span>Profile</span></a></li>
    </ul>
  </div>

  <div class="main-content">
    <div class="navbar">
      <h3>Meetversity</h3>
      <div class="nav-controls">
        <div style="display:flex; align-items:center; gap:10px;">
          <div id="userAvatar" style="width:32px; height:32px; background:white; color:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold;">U</div>
          <span id="userNameDisplay" style="font-size:14px;">Guest</span>
        </div>
        <button class="btn-nav" id="toggleDark"><i class="fas fa-moon"></i></button>
        <button class="btn-nav" onclick="auth.signOut()"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </div>

    <div class="meetversity-container">
      <div class="header-section">
        <h1 class="page-title">MEETVERSITY</h1>
        <button class="create-btn" onclick="openCreateModal()">
          <i class="fas fa-plus-circle"></i> Create Course
        </button>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-val" id="statCourses">0</div>
          <div class="stat-lbl">Total Courses</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="statLearners">0</div>
          <div class="stat-lbl">Total Learners</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="statDocs">0</div>
          <div class="stat-lbl">Documents</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="statVideos">0</div>
          <div class="stat-lbl">Quick Videos</div>
        </div>
      </div>

      <div class="section-head">
        <h2>Latest Courses</h2>
        <a href="#" style="color:var(--primary); text-decoration:none; font-size:13px;">View All</a>
      </div>
      <div class="grid-layout" id="coursesFeed">
        <div style="padding:20px; text-align:center; color:var(--secondary-text); grid-column:1/-1;">
          <i class="fas fa-spinner fa-spin"></i> Loading courses...
        </div>
      </div>

      <div class="section-head">
        <h2>Quick Videos</h2>
      </div>
      <div class="grid-layout" id="videosFeed">
         </div>

      <div class="section-head">
        <h2>Study Documents</h2>
      </div>
      <div class="grid-layout" id="docsFeed">
         </div>

    </div>
  </div>
</div>

<div class="modal" id="createModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3>Create Content</h3>
      <button onclick="closeCreateModal()" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
    </div>
    <div class="modal-body">
      <div class="type-tabs">
        <button class="type-tab active" onclick="setType('long-video', this)">Course</button>
        <button class="type-tab" onclick="setType('quick-video', this)">Quick Video</button>
        <button class="type-tab" onclick="setType('document', this)">Document</button>
      </div>

      <form id="createForm">
        <div class="form-group">
          <label class="form-label">Title</label>
          <input type="text" id="cTitle" class="form-input" placeholder="e.g. Advanced React Patterns" required>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
          <div class="form-group">
            <label class="form-label">Category</label>
            <select id="cCategory" class="form-select">
              <option>Technology</option>
              <option>Business</option>
              <option>Design</option>
              <option>Marketing</option>
              <option>Personal Dev</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Duration/Length</label>
            <input type="text" id="cDuration" class="form-input" placeholder="e.g. 2h 30m or 15 Pages" required>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Thumbnail Image</label>
          <div class="file-area" onclick="document.getElementById('cThumb').click()">
            <i class="fas fa-image" style="font-size:24px; color:var(--secondary-text);"></i>
            <p style="font-size:12px; color:var(--secondary-text); margin-top:5px;">Click to upload cover image</p>
            <input type="file" id="cThumb" accept="image/*" style="display:none" onchange="previewThumb(this)">
          </div>
          <img id="thumbPreview" style="width:100%; height:150px; object-fit:cover; border-radius:8px; display:none; margin-top:10px;">
        </div>

        <div class="form-group">
          <label class="form-label" id="mediaLabel">Video/File URL (Simulation)</label>
          <input type="text" id="cMedia" class="form-input" placeholder="Enter video link or filename">
          <small style="color:var(--secondary-text); font-size:11px;">*In production, this would be a file uploader to Firebase Storage.</small>
        </div>

        <div class="form-group">
          <label style="display:flex; align-items:center; gap:10px; font-size:13px; cursor:pointer;">
            <input type="checkbox" id="cCert"> Offer MEET Certificate upon completion
          </label>
        </div>

        <button type="button" class="create-btn" id="submitBtn" style="width:100%; justify-content:center;" onclick="submitCourse()">
          Post Content
        </button>
      </form>
    </div>
  </div>
</div>

<div class="modal" id="reviewModal">
  <div class="modal-box" style="max-width:400px;">
    <div class="modal-head">
      <h3>Write a Review</h3>
      <button onclick="document.getElementById('reviewModal').style.display='none'" style="background:none; border:none;">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="reviewCourseId">
      <div class="form-group">
        <label class="form-label">Rating</label>
        <select id="rRating" class="form-select">
          <option value="5">⭐⭐⭐⭐⭐ (5)</option>
          <option value="4">⭐⭐⭐⭐ (4)</option>
          <option value="3">⭐⭐⭐ (3)</option>
          <option value="2">⭐⭐ (2)</option>
          <option value="1">⭐ (1)</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Review</label>
        <textarea id="rText" class="form-textarea" placeholder="What did you think?"></textarea>
      </div>
      <button class="create-btn" style="width:100%; justify-content:center;" onclick="submitReview()">Submit Review</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, updateDoc, arrayUnion, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

  const firebaseConfig = {
      apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
      authDomain: "meet-6e159.firebaseapp.com",
      databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",
      projectId: "meet-6e159",
      storageBucket: "meet-6e159-firebasestorage.app",
      messagingSenderId: "252353608421",
      appId: "1:252353608421:web:6706056048e9a8f12db20c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  window.auth = auth; // For logout button

  let currentUser = null;
  let currentType = 'long-video';
  let thumbBase64 = null;

  // --- AUTH LISTENER ---
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('userNameDisplay').innerText = user.displayName || 'User';
      if(user.photoURL) document.getElementById('userAvatar').innerHTML = `<img src="${user.photoURL}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
    } else {
      // Redirect to login in real app
      document.getElementById('userNameDisplay').innerText = "Guest (Please Login)";
    }
  });

  // --- REAL TIME FEED ---
  const q = query(collection(db, "meetversity_courses"), orderBy("createdAt", "desc"));
  
  onSnapshot(q, (snapshot) => {
    const courses = [];
    const videos = [];
    const docs = [];
    let totalLearners = 0;

    snapshot.forEach((doc) => {
      const data = { id: doc.id, ...doc.data() };
      const lCount = data.learners ? data.learners.length : 0;
      totalLearners += lCount;

      if(data.type === 'long-video') courses.push(data);
      else if(data.type === 'quick-video') videos.push(data);
      else if(data.type === 'document') docs.push(data);
    });

    // Update Stats
    document.getElementById('statCourses').innerText = courses.length;
    document.getElementById('statVideos').innerText = videos.length;
    document.getElementById('statDocs').innerText = docs.length;
    document.getElementById('statLearners').innerText = totalLearners;

    // Render Grids
    renderGrid('coursesFeed', courses);
    renderGrid('videosFeed', videos);
    renderGrid('docsFeed', docs);
  });

  function renderGrid(elementId, items) {
    const container = document.getElementById(elementId);
    container.innerHTML = '';
    
    if(items.length === 0) {
      container.innerHTML = `<div style="color:var(--secondary-text); padding:10px;">No content yet. Be the first to post!</div>`;
      return;
    }

    items.forEach(item => {
      const isJoined = currentUser && item.learners && item.learners.includes(currentUser.uid);
      const learnerCount = item.learners ? item.learners.length : 0;
      const reviewsCount = item.reviews ? item.reviews.length : 0;
      
      // Rating Calc
      let rating = 0;
      if(reviewsCount > 0) {
        rating = (item.reviews.reduce((acc, r) => acc + r.rating, 0) / reviewsCount).toFixed(1);
      }

      const div = document.createElement('div');
      div.className = 'course-card';
      div.innerHTML = `
        <img src="${item.thumbnail || 'https://via.placeholder.com/300x160?text=No+Image'}" class="course-thumb">
        <div class="course-body">
          ${item.hasCert ? '<div class="c-cert"><i class="fas fa-certificate"></i> Certificate</div>' : ''}
          <div class="c-cat">${item.category}</div>
          <div class="c-title">${item.title}</div>
          <div class="c-meta">
            <span><i class="fas fa-user"></i> ${item.instructorName}</span>
            <span><i class="fas fa-star" style="color:gold"></i> ${rating || 'New'}</span>
          </div>
          <div class="c-meta">
            <span><i class="fas fa-clock"></i> ${item.duration}</span>
            <span><i class="fas fa-users"></i> ${learnerCount} Learners</span>
          </div>
          <div class="c-footer">
            <button class="btn-join ${isJoined ? 'joined' : ''}" onclick="window.joinCourse('${item.id}')">
              ${isJoined ? '<i class="fas fa-check"></i> Joined' : 'Join Course'}
            </button>
            <button class="btn-review" onclick="window.openReview('${item.id}')"><i class="fas fa-pen"></i></button>
          </div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  // --- CREATION LOGIC ---
  window.openCreateModal = () => {
    if(!currentUser) { alert("Please log in to create content."); return; }
    document.getElementById('createModal').style.display = 'flex';
  }
  window.closeCreateModal = () => {
    document.getElementById('createModal').style.display = 'none';
    document.getElementById('createForm').reset();
    document.getElementById('thumbPreview').style.display='none';
    thumbBase64 = null;
  }

  window.setType = (type, btn) => {
    currentType = type;
    document.querySelectorAll('.type-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    
    const lbl = document.getElementById('mediaLabel');
    if(type === 'document') lbl.innerText = "Document Link/File Name";
    else lbl.innerText = "Video Link/File Name";
  }

  // Image Compressor for Thumbnail
  window.previewThumb = (input) => {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const img = new Image();
        img.src = e.target.result;
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const maxWidth = 500;
            const scale = Math.min(maxWidth / img.width, 1);
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            thumbBase64 = canvas.toDataURL('image/jpeg', 0.7);
            
            const preview = document.getElementById('thumbPreview');
            preview.src = thumbBase64;
            preview.style.display = 'block';
        };
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  window.submitCourse = async () => {
    if(!currentUser) return;
    const title = document.getElementById('cTitle').value;
    const category = document.getElementById('cCategory').value;
    const duration = document.getElementById('cDuration').value;
    const media = document.getElementById('cMedia').value;
    const hasCert = document.getElementById('cCert').checked;

    if(!title || !duration) { alert("Title and Duration are required"); return; }

    const btn = document.getElementById('submitBtn');
    btn.innerText = "Posting..."; btn.disabled = true;

    try {
      await addDoc(collection(db, "meetversity_courses"), {
        title, category, duration, type: currentType,
        mediaUrl: media,
        thumbnail: thumbBase64,
        hasCert,
        instructorId: currentUser.uid,
        instructorName: currentUser.displayName || 'Instructor',
        learners: [],
        reviews: [],
        createdAt: serverTimestamp()
      });
      window.closeCreateModal();
    } catch(e) {
      console.error(e);
      alert("Error posting content.");
    } finally {
      btn.innerText = "Post Content"; btn.disabled = false;
    }
  }

  // --- INTERACTION LOGIC ---
  window.joinCourse = async (id) => {
    if(!currentUser) { alert("Please login."); return; }
    try {
      const ref = doc(db, "meetversity_courses", id);
      await updateDoc(ref, {
        learners: arrayUnion(currentUser.uid)
      });
    } catch(e) { console.error(e); }
  }

  window.openReview = (id) => {
    if(!currentUser) { alert("Please login."); return; }
    document.getElementById('reviewCourseId').value = id;
    document.getElementById('reviewModal').style.display = 'flex';
  }

  window.submitReview = async () => {
    const id = document.getElementById('reviewCourseId').value;
    const rating = parseInt(document.getElementById('rRating').value);
    const text = document.getElementById('rText').value;
    
    try {
      const ref = doc(db, "meetversity_courses", id);
      await updateDoc(ref, {
        reviews: arrayUnion({
          uid: currentUser.uid,
          userName: currentUser.displayName || 'User',
          rating, text,
          date: new Date().toISOString()
        })
      });
      document.getElementById('reviewModal').style.display = 'none';
      document.getElementById('rText').value = '';
    } catch(e) { console.error(e); }
  }

  // Dark Mode
  document.getElementById('toggleDark').onclick = () => {
    document.body.classList.toggle('dark-mode');
  }

</script>
</body>
</html>
