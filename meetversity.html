<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Meetversity</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  /* --- CSS VARIABLES & BASE STYLES --- */
  :root {
    --primary: #0080FF;
    --bg-color: #f0f2f5;
    --card-bg: #fff;
    --text-color: #111;
    --secondary-text: #65676b;
    --border-color: #dddfe2;
    --edu-primary: #0061FF;
    --edu-accent: #5AE4A8;
    --edu-gradient: linear-gradient(135deg, var(--edu-primary) 0%, var(--edu-accent) 100%);
    --radius: 12px;
    --shadow: 0 4px 12px rgba(0,0,0,0.05);
    --success: #10B981;
    --warning: #FFC107;
  }

  body.dark-mode {
    --bg-color: #18191a;
    --card-bg: #242526;
    --text-color: #e4e6eb;
    --secondary-text: #b0b3b8;
    --border-color: #3e4042;
    --shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-color); transition: all 0.3s ease; min-height: 100vh; font-size: 15px; }
  
  .app-container { display: flex; min-height: 100vh; }

  /* --- SIDEBAR & NAVBAR (Standardized) --- */
  .sidebar {
    position: fixed; left: 0; top: 0; height: 100vh; width: 180px;
    background: linear-gradient(180deg, #0080FF 0%, #00C6FF 100%);
    z-index: 100; padding: 15px; color: white;
    transition: width 0.3s;
  }
  .sidebar-header { margin-bottom: 20px; font-weight: 700; font-size: 20px; }
  .sidebar-menu { list-style: none; }
  .sidebar-menu a {
    display: flex; align-items: center; padding: 10px; text-decoration: none; color: white;
    border-radius: 8px; margin-bottom: 5px; transition: background 0.2s;
  }
  .sidebar-menu a:hover, .sidebar-menu a.active { background: rgba(255, 255, 255, 0.2); }
  .sidebar-menu i { width: 25px; text-align: center; margin-right: 10px; }

  .main-content { flex: 1; margin-left: 180px; padding: 20px; transition: margin-left 0.3s; }
  
  .navbar {
    background: var(--card-bg);
    padding: 12px 20px; border-radius: var(--radius); margin-bottom: 20px;
    display: flex; justify-content: space-between; align-items: center; color: var(--text-color);
    box-shadow: var(--shadow);
  }
  .nav-controls { display: flex; gap: 10px; align-items: center; }
  .btn-nav { background: var(--bg-color); border: none; color: var(--text-color); padding: 8px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: background 0.2s; }
  .btn-nav:hover { background: var(--border-color); }
  
  .nav-title { font-weight: 700; font-size: 1.4em; color: var(--edu-primary); }

  /* --- MEETVERSITY SPECIFIC UI --- */
  .meetversity-container { max-width: 1200px; margin: 0 auto; }
  
  .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
  .page-title { font-size: 28px; font-weight: 800; background: var(--edu-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  
  .create-btn {
    background: var(--edu-primary); color: white; border: none; padding: 10px 20px; /* Reduced padding */
    border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;
    box-shadow: 0 4px 10px rgba(0,97,255,0.3); transition: transform 0.2s;
    font-size: 14px; /* Reduced font size */
  }
  .create-btn:hover { transform: translateY(-2px); }

  /* Stats Cards */
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 30px; }
  .stat-card { 
    background: var(--card-bg); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); 
    text-align: center; display: flex; flex-direction: column; align-items: center;
  }
  .stat-val { font-size: 32px; font-weight: 700; color: var(--edu-primary); }
  .stat-lbl { font-size: 13px; color: var(--secondary-text); margin-top: 5px; }

  /* Sections */
  .section-head { display: flex; justify-content: space-between; align-items: center; margin: 30px 0 15px; }
  .section-head h2 { font-size: 20px; font-weight: 700; }

  /* Course Grid */
  .grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
  
  .course-card {
    background: var(--card-bg); border-radius: var(--radius); overflow: hidden;
    box-shadow: var(--shadow); transition: transform 0.2s; display: flex; flex-direction: column;
    border: 1px solid var(--border-color);
  }
  .course-card:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
  .course-thumb { height: 180px; width: 100%; object-fit: cover; background: #eee; }
  .course-body { padding: 15px; flex: 1; display: flex; flex-direction: column; }
  
  .c-cat { font-size: 11px; text-transform: uppercase; color: var(--edu-primary); font-weight: 700; letter-spacing: 0.5px; }
  .c-title { font-size: 18px; font-weight: 700; margin: 5px 0; line-height: 1.3; }
  .c-meta { display: flex; justify-content: space-between; font-size: 12px; color: var(--secondary-text); margin-bottom: 8px; }
  .c-meta span i { margin-right: 5px; }
  .c-cert { background: rgba(16, 185, 129, 0.1); color: var(--success); padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; width: fit-content; margin-bottom: 5px; }
  .c-instructor { display: flex; align-items: center; font-size: 12px; color: var(--secondary-text); margin-top: 5px; }
  .c-instructor img { width: 20px; height: 20px; border-radius: 50%; margin-right: 5px; object-fit: cover; }
  .c-rating-star { color: var(--warning); margin-right: 2px; }

  .c-footer { margin-top: auto; padding-top: 10px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; }
  .btn-join { flex: 1; background: var(--edu-primary); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition: background 0.2s; }
  .btn-join:hover { background: #004ecc; }
  .btn-join.joined { background: var(--success); cursor: default; }
  .btn-join.joined:hover { background: var(--success); }
  .btn-review { background: transparent; border: 1px solid var(--border-color); color: var(--text-color); padding: 10px; border-radius: 6px; cursor: pointer; font-size: 13px; width: 40px; text-align: center; transition: background 0.2s; }
  .btn-review:hover { background: var(--bg-color); }

  /* Content Type Selection (in Modal) */
  .type-tabs { display: flex; gap: 10px; margin-bottom: 20px; background: var(--bg-color); padding: 5px; border-radius: 8px; }
  .type-tab { flex: 1; border: none; background: transparent; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--secondary-text); transition: 0.2s; }
  .type-tab.active { background: var(--card-bg); color: var(--edu-primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

  /* Modal Styles */
  .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
  .modal-box { 
    background: var(--card-bg); width: 100%; max-width: 700px; border-radius: 12px; max-height: 90vh; 
    overflow-y: auto; display: flex; flex-direction: column; transform: scale(0.95); opacity: 0; 
    transition: transform 0.3s ease-out, opacity 0.3s ease-out;
  }
  .modal.open .modal-box { transform: scale(1); opacity: 1; }

  .modal-head { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
  .modal-body { padding: 20px; }
  
  /* Form Elements */
  .form-group { margin-bottom: 15px; }
  .form-label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; color: var(--text-color); }
  .form-input, .form-select, .form-textarea { 
    width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); 
    background: var(--bg-color); color: var(--text-color); font-family: inherit; transition: border-color 0.2s;
  }
  .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--edu-primary); outline: none; }
  .form-textarea { min-height: 80px; resize: vertical; }
  
  .file-area { 
    border: 2px dashed var(--border-color); padding: 20px; text-align: center; border-radius: 8px; 
    cursor: pointer; margin-top: 5px; transition: border-color 0.2s, background 0.2s; 
  }
  .file-area:hover { border-color: var(--edu-primary); background: rgba(0,97,255,0.05); }
  .file-area-text { font-size: 12px; color: var(--secondary-text); margin-top: 5px; }
  
  #thumbPreview, #mediaPreview, #outlinePreview { width:100%; height:150px; object-fit:cover; border-radius:8px; display:none; margin-top:10px; border: 1px solid var(--border-color); }
  #mediaPreview.file-pdf { height: auto; padding: 15px; text-align: center; }


  /* Responsive */
  @media (max-width: 768px) {
    .sidebar { width: 60px; padding: 10px 5px; }
    .sidebar-header, .sidebar-menu span { display: none; }
    .sidebar-menu i { margin: 0; width: 100%; font-size: 20px; }
    .main-content { margin-left: 60px; padding: 15px; }
    .grid-layout { grid-template-columns: 1fr; }
    
    .navbar { flex-wrap: wrap; gap: 15px; }
    .nav-controls { width: auto; justify-content: flex-end; }
    .nav-title { width: 100%; }
    
    .header-section { flex-direction: column; align-items: flex-start; gap: 15px; }
    .page-title { font-size: 24px; }
    .create-btn { width: 100%; justify-content: center; }

    .modal-box { max-width: 95%; }
  }
</style>
</head>
<body>

<div class="app-container">
  <div class="sidebar">
    <div class="sidebar-header">MEET</div>
    <ul class="sidebar-menu">
      <li><a href="feed.html"><i class="fas fa-home"></i> <span>Feed</span></a></li>
      <li><a href="#" class="active"><i class="fas fa-graduation-cap"></i> <span>Meetversity</span></a></li>
      <li><a href="chat.html"><i class="fas fa-comment"></i> <span>Chat</span></a></li>
      <li><a href="meetrader.html"><i class="fas fa-chart-line"></i> <span>Meetrader</span></a></li>
      <li><a href="profile.html"><i class="fas fa-user"></i> <span>Profile</span></a></li>
    </ul>
  </div>

  <div class="main-content">
    <div class="navbar">
      <h3 class="nav-title">Meetversity</h3>
      <div class="nav-controls">
        <div style="display:flex; align-items:center; gap:10px;">
          <div id="userAvatar" style="width:32px; height:32px; background:var(--edu-primary); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:14px; flex-shrink: 0;">U</div>
          <span id="userNameDisplay" style="font-size:14px; font-weight: 600;">Guest</span>
        </div>
        <button class="btn-nav" id="toggleDark" title="Toggle Dark Mode"><i class="fas fa-moon"></i></button>
        <button class="btn-nav" onclick="window.auth.signOut()" title="Sign Out"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </div>

    <div class="meetversity-container">
      <div class="header-section">
        <h1 class="page-title">MEETVERSITY</h1>
        <button class="create-btn" onclick="window.openCreateModal()">
          <i class="fas fa-plus-circle"></i> Create Course
        </button>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-val" id="statCourses">0</div>
          <div class="stat-lbl">Total Courses</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="statLearners">0</div>
          <div class="stat-lbl">Total Learners</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="statDocs">0</div>
          <div class="stat-lbl">Documents</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="statVideos">0</div>
          <div class="stat-lbl">Quick Videos</div>
        </div>
      </div>

      <div class="section-head">
        <h2>Latest Courses</h2>
        <a href="#" style="color:var(--edu-primary); text-decoration:none; font-size:13px; font-weight: 600;">View All</a>
      </div>
      <div class="grid-layout" id="coursesFeed">
        <div style="padding:40px 20px; text-align:center; color:var(--secondary-text); grid-column:1/-1;">
          <i class="fas fa-spinner fa-spin fa-2x"></i><p style="margin-top:10px;">Loading courses...</p>
        </div>
      </div>

      <div class="section-head">
        <h2>Quick Videos</h2>
      </div>
      <div class="grid-layout" id="videosFeed">
         </div>

      <div class="section-head">
        <h2>Study Documents</h2>
      </div>
      <div class="grid-layout" id="docsFeed">
         </div>

    </div>
  </div>
</div>

<div class="modal" id="createModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3>Create New Course/Content</h3>
      <button onclick="window.closeCreateModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-color);">&times;</button>
    </div>
    <div class="modal-body">
      <div class="type-tabs">
        <button class="type-tab active" data-type="long-video" onclick="window.setType('long-video', this)"><i class="fas fa-video"></i> Course (Long Video)</button>
        <button class="type-tab" data-type="quick-video" onclick="window.setType('quick-video', this)"><i class="fas fa-film"></i> Quick Video</button>
        <button class="type-tab" data-type="document" onclick="window.setType('document', this)"><i class="fas fa-file-alt"></i> Document (PDF)</button>
      </div>

      <form id="createForm">
        <div class="form-group">
          <label class="form-label">Title</label>
          <input type="text" id="cTitle" class="form-input" placeholder="e.g. Advanced React Patterns" required>
        </div>

        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
          <div class="form-group">
            <label class="form-label">Category</label>
            <select id="cCategory" class="form-select">
              <option value="Technology">Technology</option>
              <option value="Business">Business</option>
              <option value="Design">Design</option>
              <option value="Marketing">Marketing</option>
              <option value="Finance">Finance/Trading</option>
              <option value="Personal Dev">Personal Dev</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Duration/Length</label>
            <input type="text" id="cDuration" class="form-input" placeholder="e.g. 2h 30m or 15 Pages" required>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">What You'll Learn (Key Takeaways)</label>
          <textarea id="cLearning" class="form-textarea" placeholder="List 3-5 key things a learner will achieve..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Thumbnail Image (Required)</label>
          <div class="file-area" onclick="document.getElementById('cThumb').click()">
            <i class="fas fa-image" style="font-size:24px; color:var(--secondary-text);"></i>
            <p class="file-area-text">Click to upload cover image (Max 500KB after compression)</p>
            <input type="file" id="cThumb" accept="image/*" style="display:none" onchange="window.handleFileUpload(this, 'thumbnail')">
          </div>
          <img id="thumbPreview" src="">
        </div>

        <div class="form-group">
          <label class="form-label">Course Outline (PDF or Text)</label>
          <div class="file-area" onclick="document.getElementById('cOutlineFile').click()">
            <i class="fas fa-list-alt" style="font-size:24px; color:var(--secondary-text);"></i>
            <p class="file-area-text" id="outlineFileText">Click to upload Course Outline PDF (Optional)</p>
            <input type="file" id="cOutlineFile" accept="application/pdf" style="display:none" onchange="window.handleFileUpload(this, 'outline')">
          </div>
          <div id="outlinePreview" class="file-pdf" style="display:none;"></div>
          <label class="form-label" style="margin-top:10px;">...or enter outline text:</label>
          <textarea id="cOutlineText" class="form-textarea" placeholder="Alternatively, list the course modules/sections here."></textarea>
        </div>


        <div class="form-group">
          <label class="form-label" id="mediaLabel">Course Media (Video/PDF)</label>
          <div class="file-area" onclick="document.getElementById('cMediaFile').click()">
            <i class="fas fa-cloud-upload-alt" style="font-size:24px; color:var(--secondary-text);"></i>
            <p class="file-area-text" id="mediaFileText">Click to upload Video or Document (Max 50MB in production)</p>
            <input type="file" id="cMediaFile" accept="video/*, application/pdf" style="display:none" onchange="window.handleFileUpload(this, 'media')">
          </div>
          <div id="mediaPreview" class="file-pdf" style="display:none;"></div>
          <small style="color:var(--secondary-text); font-size:11px;">*Real file upload simulation ready for Cloudinary/Storage.</small>
        </div>


        <div class="form-group">
          <label style="display:flex; align-items:center; gap:10px; font-size:13px; cursor:pointer;">
            <input type="checkbox" id="cCert"> Offer **MEET Certificate** upon completion
          </label>
        </div>

        <button type="button" class="create-btn" id="submitBtn" style="width:100%; justify-content:center;" onclick="window.submitCourse()">
          <i class="fas fa-paper-plane"></i> Post Content
        </button>
      </form>
    </div>
  </div>
</div>

<div class="modal" id="reviewModal">
  <div class="modal-box" style="max-width:400px;">
    <div class="modal-head">
      <h3>Write a Review</h3>
      <button onclick="window.closeReviewModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-color);">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="reviewCourseId">
      <div class="form-group">
        <label class="form-label">Rating</label>
        <select id="rRating" class="form-select">
          <option value="5">⭐⭐⭐⭐⭐ (5)</option>
          <option value="4">⭐⭐⭐⭐ (4)</option>
          <option value="3">⭐⭐⭐ (3)</option>
          <option value="2">⭐⭐ (2)</option>
          <option value="1">⭐ (1)</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Review</label>
        <textarea id="rText" class="form-textarea" placeholder="What did you think?"></textarea>
      </div>
      <button class="create-btn" style="width:100%; justify-content:center;" onclick="window.submitReview()">Submit Review</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, updateDoc, arrayUnion, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  // NOTE: In a real app, you would also import getStorage from "firebase/storage" and use a dedicated Cloudinary SDK/API call.

  // --- MEETRADER'S FIREBASE CONFIGURATION ---
  const firebaseConfig = {
      apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
      authDomain: "meet-6e159.firebaseapp.com",
      databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",
      projectId: "meet-6e159",
      storageBucket: "meet-6e159-firebasestorage.app",
      messagingSenderId: "252353608421",
      appId: "1:2523536048e9a8f12db20c"
  };

  const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/YOUR_CLOUD_NAME/upload"; // Placeholder. Replace with actual cloud name.
  // NOTE: For security, the Cloudinary API Key/Secret should NEVER be in client-side code. Use a secure backend endpoint.
  // We'll simulate file processing but use Base64/local storage for the demo.

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  window.auth = auth; // Expose for logout button

  let currentUser = null;
  let currentType = 'long-video';
  let fileData = {
      thumbnail: null, // Base64 compressed image
      outline: null,   // Base64 PDF, or null
      media: null      // Base64/URL sim for main course content
  };

  // --- AUTH LISTENER ---
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      document.getElementById('userNameDisplay').innerText = user.displayName || 'User';
      window.setAvatar(user.photoURL, user.displayName);
    } else {
      currentUser = null;
      document.getElementById('userNameDisplay').innerText = "Guest (Log In to Post)";
      window.setAvatar(null, 'U');
    }
  });

  window.setAvatar = (photoURL, displayName) => {
    const avatarEl = document.getElementById('userAvatar');
    if(photoURL) {
        avatarEl.innerHTML = `<img src="${photoURL}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
        avatarEl.style.background = 'transparent';
    } else {
        avatarEl.innerHTML = displayName ? displayName[0] : 'U';
        avatarEl.style.background = 'var(--edu-primary)';
        avatarEl.style.color = 'white';
    }
  }

  // --- FILE/IMAGE HANDLING & COMPRESSION (Simulating Cloudinary/Storage Upload Prep) ---
  window.handleFileUpload = (input, type) => {
    if (input.files && input.files[0]) {
      const file = input.files[0];
      const reader = new FileReader();

      const updatePreview = (dataUrl) => {
        fileData[type] = dataUrl;
        
        // Update UI
        const preview = document.getElementById(type + 'Preview');
        const fileAreaText = document.getElementById(type + 'FileText');

        if (type === 'thumbnail') {
            preview.src = dataUrl;
            preview.style.display = 'block';
            fileAreaText.innerText = `Image uploaded: ${file.name}`;
        } else if (file.type.includes('pdf')) {
            // Display PDF icon and filename
            preview.innerHTML = `<i class="fas fa-file-pdf fa-2x" style="color:red;"></i><p class="file-area-text">${file.name}</p><p class="file-area-text" style="font-size:10px;">(PDF ready for upload)</p>`;
            preview.style.display = 'block';
            fileAreaText.innerText = `File uploaded: ${file.name}`;
        } else if (file.type.includes('video') && type === 'media') {
            // Display video icon and filename (cannot preview video easily with base64)
             preview.innerHTML = `<i class="fas fa-video fa-2x" style="color:var(--edu-primary);"></i><p class="file-area-text">${file.name}</p><p class="file-area-text" style="font-size:10px;">(Video ready for upload)</p>`;
            preview.style.display = 'block';
            fileAreaText.innerText = `File uploaded: ${file.name}`;
        }
      };

      if (type === 'thumbnail' && file.type.startsWith('image/')) {
        reader.onload = function (e) {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              const maxWidth = 500; // Max width for compression
              const scale = Math.min(maxWidth / img.width, 1);
              canvas.width = img.width * scale;
              canvas.height = img.height * scale;
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
              // Reduce memory size to ~70% quality
              updatePreview(canvas.toDataURL('image/jpeg', 0.7)); 
          };
        };
        reader.readAsDataURL(file);
      } else {
        // For PDF/Video, just read as Base64/DataURL for simulation
        reader.onload = function (e) {
            updatePreview(e.target.result);
        }
        reader.readAsDataURL(file);
      }
    }
  }

  // --- CREATION MODAL LOGIC ---
  window.openCreateModal = () => {
    if(!currentUser) { alert("Please log in to create content."); return; }
    document.getElementById('createModal').classList.add('open');
    document.getElementById('createModal').style.display = 'flex';
  }
  window.closeCreateModal = () => {
    document.getElementById('createModal').classList.remove('open');
    setTimeout(() => { document.getElementById('createModal').style.display = 'none'; }, 300);
    
    // Reset Form
    document.getElementById('createForm').reset();
    document.getElementById('thumbPreview').style.display = 'none';
    document.getElementById('mediaPreview').style.display = 'none';
    document.getElementById('outlinePreview').style.display = 'none';
    document.getElementById('outlinePreview').innerHTML = '';
    
    document.getElementById('outlineFileText').innerText = "Click to upload Course Outline PDF (Optional)";
    document.getElementById('mediaFileText').innerText = "Click to upload Video or Document (Max 50MB in production)";
    
    fileData = { thumbnail: null, outline: null, media: null };
  }

  window.setType = (type, btn) => {
    currentType = type;
    document.querySelectorAll('.type-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    
    const lbl = document.getElementById('mediaLabel');
    if(type === 'document') {
        lbl.innerText = "Document File (PDF/Ebook)";
        document.getElementById('cMediaFile').accept = 'application/pdf';
    } else {
        lbl.innerText = "Video File (MP4/WebM)";
        document.getElementById('cMediaFile').accept = 'video/*';
    }
    // Clear media file data when switching type
    fileData.media = null;
    document.getElementById('mediaPreview').style.display = 'none';
    document.getElementById('mediaPreview').innerHTML = '';
    document.getElementById('mediaFileText').innerText = "Click to upload Video or Document (Max 50MB in production)";
  }

  window.submitCourse = async () => {
    if(!currentUser) return;
    const title = document.getElementById('cTitle').value;
    const category = document.getElementById('cCategory').value;
    const duration = document.getElementById('cDuration').value;
    const learning = document.getElementById('cLearning').value;
    const outlineText = document.getElementById('cOutlineText').value;
    const hasCert = document.getElementById('cCert').checked;
    
    if(!title || !duration || !fileData.thumbnail) { 
        alert("Please provide a Title, Duration, and Thumbnail."); 
        return; 
    }
    if(!fileData.media) {
        alert("Please upload the Course Media (Video/Document).");
        return;
    }

    const btn = document.getElementById('submitBtn');
    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Processing...`; btn.disabled = true;

    try {
      // NOTE: In a production environment, you would upload fileData.thumbnail, fileData.media, and fileData.outline 
      // to Cloudinary/Firebase Storage here and get back public URLs. We use the Base64 as a placeholder.
      const uploadSuccess = true; // Assume success

      if (uploadSuccess) {
          await addDoc(collection(db, "meetversity_courses"), {
              title, category, duration, type: currentType,
              learningOutcomes: learning,
              outline: outlineText,
              mediaUrl: fileData.media, // Simulated URL/Base64
              thumbnail: fileData.thumbnail, // Simulated URL/Base64
              outlineFile: fileData.outline, // Simulated URL/Base64
              hasCert,
              instructorId: currentUser.uid,
              instructorName: currentUser.displayName || 'Instructor',
              instructorPhoto: currentUser.photoURL || '',
              learners: [],
              reviews: [],
              createdAt: serverTimestamp()
          });
          window.closeCreateModal();
      } else {
          // This block would handle actual upload failures (e.g., Cloudinary API errors)
          alert("Upload failed. Please try again.");
      }
    } catch(e) {
      console.error("Error posting content:", e);
      alert("An error occurred. Check console for details.");
    } finally {
      btn.innerHTML = `<i class="fas fa-paper-plane"></i> Post Content`; btn.disabled = false;
    }
  }

  // --- REAL TIME FEED ---
  const q = query(collection(db, "meetversity_courses"), orderBy("createdAt", "desc"));
  
  onSnapshot(q, (snapshot) => {
    const courses = [];
    const videos = [];
    const docs = [];
    let totalLearners = 0;

    snapshot.forEach((doc) => {
      const data = { id: doc.id, ...doc.data() };
      const lCount = data.learners ? data.learners.length : 0;
      totalLearners += lCount;

      if(data.type === 'long-video') courses.push(data);
      else if(data.type === 'quick-video') videos.push(data);
      else if(data.type === 'document') docs.push(data);
    });

    // Update Stats in Real-Time
    document.getElementById('statCourses').innerText = courses.length;
    document.getElementById('statVideos').innerText = videos.length;
    document.getElementById('statDocs').innerText = docs.length;
    document.getElementById('statLearners').innerText = totalLearners;

    // Render Grids
    renderGrid('coursesFeed', courses);
    renderGrid('videosFeed', videos);
    renderGrid('docsFeed', docs);
  });

  function renderGrid(elementId, items) {
    const container = document.getElementById(elementId);
    container.innerHTML = '';
    
    if(items.length === 0) {
      container.innerHTML = `<div style="color:var(--secondary-text); padding:10px; grid-column:1/-1;">
        <i class="fas fa-info-circle"></i> No content yet. Be the first to post a course!
      </div>`;
      return;
    }

    items.forEach(item => {
      const isJoined = currentUser && item.learners && item.learners.includes(currentUser.uid);
      const learnerCount = item.learners ? item.learners.length : 0;
      const reviewsCount = item.reviews ? item.reviews.length : 0;
      
      // Rating Calc
      let rating = 0;
      let ratingDisplay = 'New';
      if(reviewsCount > 0) {
        rating = (item.reviews.reduce((acc, r) => acc + r.rating, 0) / reviewsCount).toFixed(1);
        ratingDisplay = `<i class="fas fa-star c-rating-star"></i> ${rating}`;
      }

      const instructorAvatar = item.instructorPhoto 
        ? `<img src="${item.instructorPhoto}" alt="${item.instructorName[0]}">`
        : `<div style="width:20px; height:20px; background:#ccc; color:white; border-radius:50%; text-align:center; line-height:20px; font-size:10px; margin-right:5px;">${item.instructorName[0]}</div>`;

      const div = document.createElement('div');
      div.className = 'course-card';
      div.innerHTML = `
        <img src="${item.thumbnail || 'https://via.placeholder.com/300x180?text=No+Image'}" class="course-thumb">
        <div class="course-body">
          ${item.hasCert ? '<div class="c-cert"><i class="fas fa-certificate"></i> Certificate</div>' : ''}
          <div class="c-cat">${item.category}</div>
          <div class="c-title">${item.title}</div>
          <div class="c-instructor">${instructorAvatar} ${item.instructorName}</div>
          <div class="c-meta" style="margin-top:10px;">
            <span><i class="fas fa-clock"></i> ${item.duration}</span>
            <span>${ratingDisplay} (${reviewsCount})</span>
          </div>
          <div class="c-meta">
            <span><i class="fas fa-users"></i> ${learnerCount} Learners</span>
            <span><i class="fas fa-download"></i> View Content</span>
          </div>
          <div class="c-footer">
            <button class="btn-join ${isJoined ? 'joined' : ''}" onclick="window.joinCourse('${item.id}', this)">
              ${isJoined ? '<i class="fas fa-check"></i> Joined' : 'Join Course'}
            </button>
            <button class="btn-review" onclick="window.openReview('${item.id}')" title="Write a Review"><i class="fas fa-pen"></i></button>
          </div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  // --- INTERACTION LOGIC (Join & Review) ---
  window.joinCourse = async (id, button) => {
    if(!currentUser) { alert("Please login to join a course."); return; }
    
    // Simple check to prevent re-joining, though DB handles it too
    if(button.classList.contains('joined')) { return; } 

    try {
      button.disabled = true;
      button.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
      const ref = doc(db, "meetversity_courses", id);
      await updateDoc(ref, {
        learners: arrayUnion(currentUser.uid)
      });
      // UI update is handled by the real-time listener (onSnapshot)
    } catch(e) { 
      console.error(e); 
      button.disabled = false; // Re-enable on failure
      button.innerHTML = `Join Course`;
      alert("Error joining course. Please try again.");
    }
  }

  window.openReview = (id) => {
    if(!currentUser) { alert("Please login to write a review."); return; }
    document.getElementById('reviewCourseId').value = id;
    document.getElementById('reviewModal').classList.add('open');
    document.getElementById('reviewModal').style.display = 'flex';
  }

  window.closeReviewModal = () => {
    document.getElementById('reviewModal').classList.remove('open');
    setTimeout(() => { document.getElementById('reviewModal').style.display = 'none'; }, 300);
    document.getElementById('rText').value = '';
    document.getElementById('rRating').value = '5';
  }

  window.submitReview = async () => {
    const id = document.getElementById('reviewCourseId').value;
    const rating = parseInt(document.getElementById('rRating').value);
    const text = document.getElementById('rText').value;
    
    if(!text) { alert("Please write a review text."); return; }

    try {
      const ref = doc(db, "meetversity_courses", id);
      await updateDoc(ref, {
        reviews: arrayUnion({
          uid: currentUser.uid,
          userName: currentUser.displayName || 'User',
          rating, text,
          date: serverTimestamp() // Use server timestamp for reliable sorting
        })
      });
      window.closeReviewModal();
    } catch(e) { 
      console.error(e); 
      alert("Error submitting review. Please try again.");
    }
  }

  // Dark Mode
  document.getElementById('toggleDark').onclick = () => {
    document.body.classList.toggle('dark-mode');
  }

</script>
</body>
</html>
