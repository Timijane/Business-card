<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Meetversity</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  /* --- CSS VARIABLES --- */
  :root {
    --primary: #0080FF;
    --bg-color: #f0f2f5;
    --card-bg: #fff;
    --text-color: #111;
    --secondary-text: #65676b;
    --border-color: #dddfe2;
    --edu-primary: #0061FF;
    --edu-accent: #5AE4A8;
    --edu-gradient: linear-gradient(135deg, var(--edu-primary) 0%, var(--edu-accent) 100%);
    --radius: 12px;
    --shadow: 0 4px 12px rgba(0,0,0,0.05);
    --success: #10B981;
  }

  body.dark-mode {
    --bg-color: #18191a;
    --card-bg: #242526;
    --text-color: #e4e6eb;
    --secondary-text: #b0b3b8;
    --border-color: #3e4042;
    --shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-color); transition: all 0.3s ease; min-height: 100vh; font-size: 15px; }
  
  .app-container { display: flex; min-height: 100vh; }

  /* --- SIDEBAR & NAVBAR --- */
  .sidebar {
    position: fixed; left: 0; top: 0; height: 100vh; width: 180px;
    background: linear-gradient(180deg, #0080FF 0%, #00C6FF 100%);
    z-index: 100; padding: 15px; color: white;
  }
  .sidebar-header { margin-bottom: 20px; font-weight: 700; font-size: 20px; }
  .sidebar-menu { list-style: none; }
  .sidebar-menu a {
    display: flex; align-items: center; padding: 10px; text-decoration: none; color: white;
    border-radius: 8px; margin-bottom: 5px; transition: background 0.2s;
  }
  .sidebar-menu a:hover, .sidebar-menu a.active { background: rgba(255, 255, 255, 0.2); }
  .sidebar-menu i { width: 25px; text-align: center; margin-right: 10px; }

  .main-content { flex: 1; margin-left: 180px; padding: 20px; }
  
  .navbar {
    background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);
    padding: 12px 20px; border-radius: 12px; margin-bottom: 20px;
    display: flex; justify-content: space-between; align-items: center; color: white;
  }
  .nav-controls { display: flex; gap: 10px; align-items: center; }
  .btn-nav { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px; }

  /* --- MEETVERSITY UI --- */
  .meetversity-container { max-width: 1200px; margin: 0 auto; }
  
  .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
  .page-title { font-size: 24px; font-weight: 800; background: var(--edu-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  
  /* REDUCED BUTTON SIZE */
  .create-btn {
    background: var(--edu-primary); color: white; border: none; padding: 8px 16px;
    border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;
    font-size: 13px; box-shadow: 0 4px 10px rgba(0,97,255,0.3); transition: transform 0.2s;
  }
  .create-btn:hover { transform: translateY(-2px); }
  .create-btn:disabled { opacity: 0.7; cursor: not-allowed; }

  /* Stats Cards */
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; }
  .stat-card { background: var(--card-bg); padding: 15px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; }
  .stat-val { font-size: 24px; font-weight: 700; color: var(--edu-primary); }
  .stat-lbl { font-size: 12px; color: var(--secondary-text); }

  /* Course Grid */
  .section-head { display: flex; justify-content: space-between; align-items: center; margin: 30px 0 15px; }
  .section-head h2 { font-size: 18px; font-weight: 700; }
  
  .grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
  
  .course-card {
    background: var(--card-bg); border-radius: var(--radius); overflow: hidden;
    box-shadow: var(--shadow); transition: transform 0.2s; display: flex; flex-direction: column;
  }
  .course-card:hover { transform: translateY(-5px); }
  
  .course-header { position: relative; height: 150px; }
  .course-thumb { height: 100%; width: 100%; object-fit: cover; background: #eee; }
  
  /* Poster Image Overlay */
  .poster-badge {
    position: absolute; bottom: -15px; right: 15px;
    width: 36px; height: 36px; border-radius: 50%;
    border: 2px solid var(--card-bg); background: var(--edu-primary);
    overflow: hidden; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold;
  }
  .poster-badge img { width: 100%; height: 100%; object-fit: cover; }

  .course-body { padding: 20px 15px 15px; flex: 1; display: flex; flex-direction: column; }
  
  .c-cat { font-size: 10px; text-transform: uppercase; color: var(--edu-primary); font-weight: 700; letter-spacing: 0.5px; }
  .c-title { font-size: 15px; font-weight: 700; margin: 5px 0; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  
  .c-meta { display: flex; justify-content: space-between; font-size: 11px; color: var(--secondary-text); margin-bottom: 10px; }
  .c-cert { background: rgba(16, 185, 129, 0.1); color: var(--success); padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; width: fit-content; margin-bottom: 8px; }
  
  .c-footer { margin-top: auto; padding-top: 10px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; }
  .btn-join { flex: 1; background: var(--edu-primary); color: white; border: none; padding: 6px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; }
  .btn-join.joined { background: var(--success); cursor: default; }
  
  /* Modal */
  .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
  .modal-box { background: var(--card-bg); width: 100%; max-width: 600px; border-radius: 12px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
  .modal-head { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--card-bg); z-index: 10; }
  .modal-body { padding: 20px; }
  
  /* Form Elements */
  .form-group { margin-bottom: 15px; }
  .form-label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; }
  .form-input, .form-select, .form-textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); font-family: inherit; font-size: 14px; }
  .form-textarea { min-height: 80px; resize: vertical; }
  
  .file-drop { border: 2px dashed var(--border-color); padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.2s; }
  .file-drop:hover { border-color: var(--edu-primary); background: rgba(0,97,255,0.02); }
  
  /* Dynamic List for "What you'll learn" */
  .learn-item { display: flex; gap: 10px; margin-bottom: 8px; }
  .btn-icon { background: transparent; border: 1px solid var(--border-color); color: var(--text-color); width: 36px; border-radius: 6px; cursor: pointer; }
  
  .type-tabs { display: flex; gap: 10px; margin-bottom: 20px; background: var(--bg-color); padding: 5px; border-radius: 8px; }
  .type-tab { flex: 1; border: none; background: transparent; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--secondary-text); font-size: 13px; }
  .type-tab.active { background: white; color: var(--edu-primary); shadow: 0 2px 5px rgba(0,0,0,0.05); }
  
  .progress-bar { height: 6px; background: #eee; border-radius: 3px; margin-top: 5px; overflow: hidden; display: none; }
  .progress-fill { height: 100%; background: var(--edu-primary); width: 0%; transition: width 0.3s; }

  /* Responsive */
  @media (max-width: 768px) {
    .sidebar { width: 60px; padding: 10px 5px; }
    .sidebar-header, .sidebar-menu span { display: none; }
    .sidebar-menu i { margin: 0; width: 100%; font-size: 20px; }
    .main-content { margin-left: 60px; padding: 15px; }
    .grid-layout { grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .navbar { flex-direction: column; align-items: flex-start; gap: 10px; }
    .nav-controls { width: 100%; justify-content: space-between; }
  }
  @media (max-width: 480px) {
    .grid-layout { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div class="app-container">
  <div class="sidebar">
    <div class="sidebar-header">MEET</div>
    <ul class="sidebar-menu">
      <li><a href="feed.html"><i class="fas fa-home"></i> <span>Feed</span></a></li>
      <li><a href="#" class="active"><i class="fas fa-graduation-cap"></i> <span>Meetversity</span></a></li>
      <li><a href="chat.html"><i class="fas fa-comment"></i> <span>Chat</span></a></li>
      <li><a href="meetrader.html"><i class="fas fa-chart-line"></i> <span>Meetrader</span></a></li>
      <li><a href="profile.html"><i class="fas fa-user"></i> <span>Profile</span></a></li>
    </ul>
  </div>

  <div class="main-content">
    <div class="navbar">
      <h3>Meetversity</h3>
      <div class="nav-controls">
        <div style="display:flex; align-items:center; gap:10px;">
          <div id="userAvatar" style="width:32px; height:32px; background:white; color:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:14px; overflow:hidden;">U</div>
          <span id="userNameDisplay" style="font-size:14px;">Guest</span>
        </div>
        <button class="btn-nav" id="toggleDark"><i class="fas fa-moon"></i></button>
        <button class="btn-nav" onclick="auth.signOut()"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </div>

    <div class="meetversity-container">
      <div class="header-section">
        <h1 class="page-title">ACADEMY</h1>
        <button class="create-btn" onclick="openCreateModal()">
          <i class="fas fa-plus"></i> Create Content
        </button>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-val" id="statCourses">0</div>
          <div class="stat-lbl">Courses</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="statLearners">0</div>
          <div class="stat-lbl">Learners</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="statVideos">0</div>
          <div class="stat-lbl">Quick Vids</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="statDocs">0</div>
          <div class="stat-lbl">Notes</div>
        </div>
      </div>

      <div class="section-head"><h2>Featured Courses</h2></div>
      <div class="grid-layout" id="coursesFeed"><div style="padding:20px;">Loading...</div></div>

      <div class="section-head"><h2>Quick Videos</h2></div>
      <div class="grid-layout" id="videosFeed"></div>

      <div class="section-head"><h2>Notes & Documents</h2></div>
      <div class="grid-layout" id="docsFeed"></div>
    </div>
  </div>
</div>

<div class="modal" id="createModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3>Create Content</h3>
      <button onclick="closeCreateModal()" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
    </div>
    <div class="modal-body">
      <div class="type-tabs">
        <button class="type-tab active" onclick="setType('long-video', this)">Full Course</button>
        <button class="type-tab" onclick="setType('quick-video', this)">Quick Video</button>
        <button class="type-tab" onclick="setType('document', this)">Document (Picture of Note)</button>
      </div>

      <form id="createForm">
        <div class="form-group">
          <label class="form-label">Title</label>
          <input type="text" id="cTitle" class="form-input" placeholder="e.g. Advanced React Patterns" required>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
          <div class="form-group">
            <label class="form-label">Category</label>
            <select id="cCategory" class="form-select">
              <option>Technology</option>
              <option>Business</option>
              <option>Design</option>
              <option>Marketing</option>
              <option>Health</option>
              <option>Academic</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Duration</label>
            <input type="text" id="cDuration" class="form-input" placeholder="e.g. 2h 30m or 1 Image" required>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Cover Image (Compressed)</label>
          <div class="file-drop" onclick="document.getElementById('cThumb').click()">
            <i class="fas fa-image" style="font-size:20px; color:var(--secondary-text);"></i>
            <p style="font-size:11px; color:var(--secondary-text); margin-top:5px;">Click to upload thumbnail</p>
            <input type="file" id="cThumb" accept="image/*" style="display:none" onchange="previewThumb(this)" required>
          </div>
          <img id="thumbPreview" style="width:100%; height:120px; object-fit:cover; border-radius:8px; display:none; margin-top:10px;">
        </div>

        <div class="form-group">
          <label class="form-label" id="mediaLabel">Upload Video File</label>
          <input type="file" id="cMediaFile" class="form-input" accept="video/*" required>
          <div class="progress-bar" id="mediaProgress">
              <div class="progress-fill" id="mediaProgressFill"></div>
          </div>
          <small style="color:var(--secondary-text); font-size:10px;">File will be optimized via Cloudinary.</small>
        </div>

        <div class="form-group" id="learnSection">
          <label class="form-label">Course Outline (What you'll learn)</label>
          <div id="learnContainer">
             <div class="learn-item">
                 <input type="text" class="form-input learn-input" placeholder="e.g. Master CSS Grid">
                 <button type="button" class="btn-icon" onclick="this.parentElement.remove()">&times;</button>
             </div>
          </div>
          <button type="button" onclick="addLearnItem()" style="background:none; border:none; color:var(--primary); font-size:12px; cursor:pointer;">+ Add lesson/outcome</button>
        </div>

        <div class="form-group">
          <label style="display:flex; align-items:center; gap:10px; font-size:13px; cursor:pointer;">
            <input type="checkbox" id="cCert"> Offer MEET Certificate
          </label>
        </div>

        <button type="button" class="create-btn" id="submitBtn" style="width:100%; justify-content:center; padding:12px;" onclick="submitCourse()">
          Post Content
        </button>
      </form>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, updateDoc, arrayUnion, onSnapshot, query, orderBy, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

  // --- FIREBASE CONFIG ---
  const firebaseConfig = {
      apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
      authDomain: "meet-6e159.firebaseapp.com",
      databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",
      projectId: "meet-6e159",
      storageBucket: "meet-6e159-firebasestorage.app",
      messagingSenderId: "252353608421",
      appId: "1:252353608421:web:6706056048e9a8f12db20c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  window.auth = auth;

  // --- CLOUDINARY CONFIG (UNIFIED to Match Working Feed) ---
  const CLOUD_NAME = "dcwof2ngn"; 
  const UPLOAD_PRESET = "Meet_video"; // Unsigned Upload Preset
  // *** SIMPLIFIED URL: Use the generic upload endpoint that Cloudinary automatically routes ***
  const CLOUDINARY_GENERIC_URL = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`; 

  let currentUser = null;
  let currentType = 'long-video';
  let thumbBase64 = null; 

  // --- AUTH & USER PROFILE ---
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      const userDoc = await getDoc(doc(db, "users", user.uid));
      const userData = userDoc.exists() ? userDoc.data() : {};
      
      currentUser.displayName = userData.displayName || user.displayName;
      currentUser.photoURL = userData.photoURL || user.photoURL;

      document.getElementById('userNameDisplay').innerText = currentUser.displayName || 'User';
      if(currentUser.photoURL) {
          document.getElementById('userAvatar').innerHTML = `<img src="${currentUser.photoURL}" style="width:100%;height:100%;object-fit:cover;">`;
      }
    } else {
      document.getElementById('userNameDisplay').innerText = "Guest";
    }
  });

  // --- COMPRESSION LOGIC (For Thumbnails) ---
  const compressImage = (file) => {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.src = e.target.result;
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const MAX = 500;
          const scale = Math.min(MAX / img.width, 1);
          canvas.width = img.width * scale;
          canvas.height = img.height * scale;
          
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          resolve(canvas.toDataURL('image/jpeg', 0.6));
        };
      };
      reader.readAsDataURL(file);
    });
  };

  // --- CLOUDINARY UPLOAD HELPER (SIMPLIFIED: Uses the generic URL) ---
  const uploadToCloudinary = async (fileOrBase64) => {
    const formData = new FormData();

    if (fileOrBase64 instanceof File) {
        formData.append("file", fileOrBase64);
    } else if (typeof fileOrBase64 === 'string' && fileOrBase64.startsWith('data:')) {
        formData.append("file", fileOrBase64); // Base64 Data URL
    } else {
        throw new Error("Invalid file or Base64 string provided for upload.");
    }

    formData.append("upload_preset", UPLOAD_PRESET);
    
    // *** Use the generic URL, trusting Cloudinary's content detection, like the Feed ***
    try {
        const response = await fetch(CLOUDINARY_GENERIC_URL, { method: "POST", body: formData });
        const data = await response.json();

        if (data.error || !response.ok) {
            console.error("Upload Error:", data.error?.message || response.statusText, data);
            throw new Error(`Cloudinary Error: ${data.error?.message || 'Upload failed.'}`);
        }
        
        return data.secure_url;
    } catch (err) {
        console.error("Upload failed in helper:", err.message || err);
        throw err;
    }
  };

  // --- FEED & UI LOGIC (Remains the same) ---
  const q = query(collection(db, "meetversity_courses"), orderBy("createdAt", "desc"));
  onSnapshot(q, (snapshot) => {
    const courses = [], videos = [], docs = [];
    let learners = 0;

    snapshot.forEach((doc) => {
      const data = { id: doc.id, ...doc.data() };
      learners += (data.learners ? data.learners.length : 0);
      if(data.type === 'long-video') courses.push(data);
      else if(data.type === 'quick-video') videos.push(data);
      else docs.push(data);
    });

    document.getElementById('statCourses').innerText = courses.length;
    document.getElementById('statVideos').innerText = videos.length;
    document.getElementById('statDocs').innerText = docs.length;
    document.getElementById('statLearners').innerText = learners;

    renderGrid('coursesFeed', courses);
    renderGrid('videosFeed', videos);
    renderGrid('docsFeed', docs);
  });

  function renderGrid(id, items) {
    const container = document.getElementById(id);
    container.innerHTML = '';
    if(!items.length) { container.innerHTML = '<div style="padding:10px; color:#888;">No content yet.</div>'; return; }

    items.forEach(item => {
      const isJoined = currentUser && item.learners?.includes(currentUser.uid);
      const lCount = item.learners ? item.learners.length : 0;
      
      const posterImg = item.instructorPhoto 
        ? `<img src="${item.instructorPhoto}">` 
        : `<div style="width:100%;height:100%;background:#0080FF;color:white;display:flex;align-items:center;justify-content:center;">${item.instructorName?.[0]||'U'}</div>`;

      const div = document.createElement('div');
      div.className = 'course-card';
      div.innerHTML = `
        <div class="course-header">
            <img src="${item.thumbnail || 'https://via.placeholder.com/300'}" class="course-thumb">
            <div class="poster-badge">${posterImg}</div>
        </div>
        <div class="course-body">
          ${item.hasCert ? '<div class="c-cert"><i class="fas fa-certificate"></i> Certificate</div>' : ''}
          <div class="c-cat">${item.category}</div>
          <div class="c-title">${item.title}</div>
          <div class="c-meta">
            <span>${item.instructorName}</span>
            <span>${lCount} Learners</span>
          </div>
          <div class="c-footer">
             <button class="btn-join ${isJoined ? 'joined' : ''}" onclick="joinCourse('${item.id}')">
              ${isJoined ? 'Joined' : 'Join'}
            </button>
             <button style="background:none; border:1px solid #ddd; padding:6px; border-radius:6px; cursor:pointer;" onclick="viewDetails('${item.id}')">Details</button>
          </div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  // --- CREATION FORM LOGIC ---
  window.openCreateModal = () => {
      if(!currentUser) { alert("Login required"); return; }
      document.getElementById('createModal').style.display = 'flex';
      setType(currentType, document.querySelector(`.type-tab[onclick*="${currentType}"]`));
  };
  window.closeCreateModal = () => {
      document.getElementById('createModal').style.display = 'none';
      document.getElementById('createForm').reset();
      thumbBase64 = null;
      document.getElementById('thumbPreview').style.display = 'none';
      document.getElementById('mediaProgress').style.display = 'none';
      setType('long-video', document.querySelector(`.type-tab[onclick*="long-video"]`));
  };

  window.setType = (type, btn) => {
      currentType = type;
      document.querySelectorAll('.type-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      
      const mediaInput = document.getElementById('cMediaFile');
      const label = document.getElementById('mediaLabel');
      const learnSection = document.getElementById('learnSection');
      
      if(type === 'document') {
          label.innerText = "Upload Picture of Note/Document";
          mediaInput.accept = "image/*";
          document.getElementById('cDuration').placeholder = 'e.g. 1 Image';
          learnSection.style.display = 'none'; 
          document.getElementById('cCert').parentElement.style.display = 'none';
      } else {
          label.innerText = "Upload Video File";
          mediaInput.accept = "video/*";
          document.getElementById('cDuration').placeholder = 'e.g. 2h 30m';
          learnSection.style.display = 'block'; 
          document.getElementById('cCert').parentElement.style.display = 'flex';
      }
      mediaInput.value = ''; 
  };

  window.addLearnItem = () => {
      const div = document.createElement('div');
      div.className = 'learn-item';
      div.innerHTML = `<input type="text" class="form-input learn-input" placeholder="Lesson/Outcome..."><button type="button" class="btn-icon" onclick="this.parentElement.remove()">&times;</button>`;
      document.getElementById('learnContainer').appendChild(div);
  };

  window.previewThumb = async (input) => {
      if (input.files && input.files[0]) {
          const compressedDataUrl = await compressImage(input.files[0]);
          thumbBase64 = compressedDataUrl;
          const preview = document.getElementById('thumbPreview');
          preview.src = thumbBase64;
          preview.style.display = 'block';
      }
  };

  // Main Submit Logic
  window.submitCourse = async () => {
      const btn = document.getElementById('submitBtn');
      const progress = document.getElementById('mediaProgress');
      const fill = document.getElementById('mediaProgressFill');
      
      const title = document.getElementById('cTitle').value;
      const category = document.getElementById('cCategory').value;
      const duration = document.getElementById('cDuration').value;
      
      const mediaFile = document.getElementById('cMediaFile').files[0];
      
      const learnInputs = document.querySelectorAll('.learn-input');
      const outcomes = [];
      if(currentType !== 'document') {
          learnInputs.forEach(i => { if(i.value.trim()) outcomes.push(i.value.trim()); });
          if(outcomes.length === 0) { alert("Please provide at least one lesson/outcome for the course."); return; }
      }

      if(!title || !mediaFile) { alert("Title and Media File required"); return; }
      if(!thumbBase64) { alert("Please upload a thumbnail"); return; }

      btn.innerText = "Uploading...";
      btn.disabled = true;
      progress.style.display = 'block';
      fill.style.width = '10%';

      try {
          // 1. Upload Thumbnail (Base64 -> Cloudinary) - Should work as it's an image upload.
          const thumbUrl = await uploadToCloudinary(thumbBase64);
          fill.style.width = '40%';

          // 2. Upload Main Content (Video/Image -> Cloudinary) - This is the line that must now work.
          const mediaUrl = await uploadToCloudinary(mediaFile); 
          fill.style.width = '80%';

          // 3. Save to Firestore
          await addDoc(collection(db, "meetversity_courses"), {
              title, category, duration, type: currentType,
              thumbnail: thumbUrl,
              mediaUrl: mediaUrl,
              outcomes: outcomes,
              hasCert: currentType !== 'document' ? document.getElementById('cCert').checked : false,
              instructorId: currentUser.uid,
              instructorName: currentUser.displayName || 'Instructor',
              instructorPhoto: currentUser.photoURL || null,
              learners: [],
              createdAt: serverTimestamp()
          });

          fill.style.width = '100%';
          alert("Content Posted Successfully!");
          closeCreateModal();

      } catch(e) {
          console.error("Final Submission Error:", e);
          // *** If the error is still 'missing permission', the issue is 100% on the Cloudinary preset 'Meet_video'. ***
          alert(`Upload failed: ${e.message || "Please check console for details."}. CRITICAL: If still failing, check Cloudinary preset 'Meet_video' settings!`);
      } finally {
          btn.innerText = "Post Content";
          btn.disabled = false;
          progress.style.display = 'none';
      }
  };

  window.joinCourse = async (id) => {
      if(!currentUser) { alert("Login required"); return; }
      await updateDoc(doc(db, "meetversity_courses", id), {
          learners: arrayUnion(currentUser.uid)
      });
  };

  window.viewDetails = (id) => {
      alert("Feature: Opens content detail view (Video Player / Image Viewer) using mediaUrl: " + id);
  };

  // Dark mode toggle
  document.getElementById('toggleDark').onclick = () => document.body.classList.toggle('dark-mode');

</script>
</body>
</html>
