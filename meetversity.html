<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Meetversity</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  /* --- CSS VARIABLES --- */
  :root {
    --primary: #0080FF;
    --bg-color: #f0f2f5;
    --card-bg: #fff;
    --text-color: #111;
    --secondary-text: #65676b;
    --border-color: #dddfe2;
    --edu-primary: #0061FF;
    --edu-accent: #5AE4A8;
    --edu-gradient: linear-gradient(135deg, var(--edu-primary) 0%, var(--edu-accent) 100%);
    --radius: 12px;
    --shadow: 0 4px 12px rgba(0,0,0,0.05);
    --success: #10B981;
    --heart-color: #FF4136; /* Red for love button */
  }

  body.dark-mode {
    --bg-color: #18191a;
    --card-bg: #242526;
    --text-color: #e4e6eb;
    --secondary-text: #b0b3b8;
    --border-color: #3e4042;
    --shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-color); transition: all 0.3s ease; min-height: 100vh; font-size: 15px; }
  
  .app-container { display: flex; min-height: 100vh; }

  /* --- SIDEBAR & NAVBAR --- */
  .sidebar {
    position: fixed; left: 0; top: 0; height: 100vh; width: 180px;
    background: linear-gradient(180deg, #0080FF 0%, #00C6FF 100%);
    z-index: 100; padding: 15px; color: white;
  }
  .sidebar-header { margin-bottom: 20px; font-weight: 700; font-size: 20px; }
  .sidebar-menu { list-style: none; }
  .sidebar-menu a {
    display: flex; align-items: center; padding: 10px; text-decoration: none; color: white;
    border-radius: 8px; margin-bottom: 5px; transition: background 0.2s;
  }
  .sidebar-menu a:hover, .sidebar-menu a.active { background: rgba(255, 255, 255, 0.2); }
  .sidebar-menu i { width: 25px; text-align: center; margin-right: 10px; }

  .main-content { flex: 1; margin-left: 180px; padding: 20px; }
  
  .navbar {
    background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);
    padding: 12px 20px; border-radius: 12px; margin-bottom: 20px;
    display: flex; justify-content: space-between; align-items: center; color: white;
  }
  .nav-controls { display: flex; gap: 10px; align-items: center; }
  .btn-nav { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 5px; }

  /* --- MEETVERSITY UI --- */
  .meetversity-container { max-width: 1200px; margin: 0 auto; }
  
  .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
  .page-title { font-size: 24px; font-weight: 800; background: var(--edu-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  
  /* Course Card Specific Styles */
  .stat-val.love { color: var(--heart-color); }

  .course-card {
    background: var(--card-bg); border-radius: var(--radius); overflow: hidden;
    box-shadow: var(--shadow); transition: transform 0.2s; display: flex; flex-direction: column;
  }
  
  .course-header { position: relative; height: 150px; }
  
  /* Increase creator picture size */
  .poster-badge {
    position: absolute; bottom: -20px; right: 15px;
    width: 48px; height: 48px; /* Increased size */
    border-radius: 50%;
    border: 3px solid var(--card-bg); /* Thicker border */
    background: var(--edu-primary);
    overflow: hidden; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: bold;
  }

  .course-body { padding: 20px 15px 15px; flex: 1; display: flex; flex-direction: column; }
  
  .c-meta { display: flex; justify-content: space-between; font-size: 11px; color: var(--secondary-text); margin-bottom: 10px; }
  
  .c-stats { display: flex; gap: 15px; font-size: 11px; color: var(--secondary-text); margin-bottom: 10px; align-items: center; }
  .c-stats i { margin-right: 3px; }

  .c-footer { margin-top: auto; padding-top: 10px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; }
  
  .btn-love { background: none; border: 1px solid var(--border-color); color: var(--secondary-text); padding: 6px 12px; border-radius: 6px; cursor: pointer; transition: color 0.2s, border-color 0.2s; }
  .btn-love.loved { color: var(--heart-color); border-color: var(--heart-color); }

  /* Modal for Application Form */
  #applicationModal .modal-box { max-width: 450px; }
  
  /* Detail Modal */
  #detailModal .modal-box { max-width: 700px; text-align: left; }
  .detail-header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
  .detail-title { font-size: 24px; margin-bottom: 10px; font-weight: 700; color: var(--edu-primary); }
  .detail-creator { display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: 600; font-size: 14px; }
  .detail-bio { margin: 15px 0; padding: 10px; background: var(--bg-color); border-radius: 8px; font-style: italic; font-size: 13px; color: var(--secondary-text); }
  .detail-section h4 { font-size: 16px; margin-top: 15px; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 2px solid var(--edu-primary); width: fit-content; }
  .detail-outline li { margin-bottom: 5px; font-size: 14px; }

</style>
</head>
<body>

<div class="app-container">
  <div class="sidebar">...</div>

  <div class="main-content">
    <div class="navbar">...</div>

    <div class="meetversity-container">
      <div class="header-section">
        <h1 class="page-title">ACADEMY</h1>
        <button class="create-btn" onclick="openCreateModal()">
          <i class="fas fa-plus"></i> Create Content
        </button>
      </div>

      <div class="stats-grid">...</div>

      <div class="section-head"><h2>Full Course Videos</h2></div>
      <div class="grid-layout" id="coursesFeed"><div style="padding:20px;">Loading...</div></div>

      <div class="section-head"><h2>Quick Videos</h2></div>
      <div class="grid-layout" id="videosFeed"></div>

      <div class="section-head"><h2>Notes & Documents</h2></div>
      <div class="grid-layout" id="docsFeed"></div>
    </div>
  </div>
</div>

<div class="modal" id="createModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3>Create Content</h3>
      <button onclick="closeCreateModal()" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
    </div>
    <div class="modal-body">
      <div class="type-tabs">
        <button class="type-tab active" onclick="setType('long-video', this)">Full Course (Video)</button>
        <button class="type-tab" onclick="setType('quick-video', this)">Quick Video</button>
        <button class="type-tab" onclick="setType('document', this)">Document (PDF/Note)</button>
      </div>

      <form id="createForm">
        <div class="form-group">
          <label class="form-label">Course Title</label>
          <input type="text" id="cTitle" class="form-input" placeholder="e.g. Advanced React Patterns" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Description / Summary (10 - 500 chars)</label>
          <textarea id="cDescription" class="form-textarea" placeholder="Briefly describe what this content covers" required></textarea>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
          <div class="form-group">
            <label class="form-label">Category</label>
            <select id="cCategory" class="form-select">
              <option>Technology</option>
              <option>Business</option>
              <option>Design</option>
              <option>Marketing</option>
              <option>Health</option>
              <option>Academic</option>
              <option>Lifestyle</option>
              <option>Life Hack</option>
              <option>Sport</option>
              <option>Human Kinetics</option>
              <option>Guidance & Counseling</option>
              <option>Psychology</option>
              <option>Forensic Psychology</option>
              <option>Pastoral Psychology</option>
              <option>Ethical Hacking</option>
              <option>Finance & Investment</option>
              <option>Cooking & Culinary Arts</option>
              <option>-- More Categories (159+) --</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Duration (e.g., 2h 30m or 1 PDF)</label>
            <input type="text" id="cDuration" class="form-input" placeholder="Total length of content" required>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Instructor Bio (Max 500 chars)</label>
          <textarea id="cInstructorBio" class="form-textarea" placeholder="A short, professional bio for your course page"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Cover Image (Compressed)</label>
          <div class="file-drop" onclick="document.getElementById('cThumb').click()">
            <i class="fas fa-image" style="font-size:20px; color:var(--secondary-text);"></i>
            <p style="font-size:11px; color:var(--secondary-text); margin-top:5px;">Click to upload thumbnail</p>
            <input type="file" id="cThumb" accept="image/*" style="display:none" onchange="previewThumb(this)" required>
          </div>
          <img id="thumbPreview" style="width:100%; height:120px; object-fit:cover; border-radius:8px; display:none; margin-top:10px;">
        </div>

        <div class="form-group">
          <label class="form-label" id="mediaLabel">Upload Video File</label>
          <input type="file" id="cMediaFile" class="form-input" accept="video/*" required>
          <div class="progress-bar" id="mediaProgress">
              <div class="progress-fill" id="mediaProgressFill"></div>
          </div>
        </div>

        <div class="form-group" id="learnSection">
          <label class="form-label">Course Outline (What you'll learn)</label>
          <div id="learnContainer">
             <div class="learn-item">
                 <input type="text" class="form-input learn-input" placeholder="Lesson/Outcome...">
                 <button type="button" class="btn-icon" onclick="this.parentElement.remove()">&times;</button>
             </div>
          </div>
          <button type="button" onclick="addLearnItem()" style="background:none; border:none; color:var(--primary); font-size:12px; cursor:pointer;">+ Add lesson/outcome</button>
        </div>

        <div class="form-group" id="certCheckboxGroup">
          <label style="display:flex; align-items:center; gap:10px; font-size:13px; cursor:pointer;">
            <input type="checkbox" id="cCert"> Offer MEET Certificate (Only for Full Courses)
          </label>
        </div>

        <button type="button" class="create-btn" id="submitBtn" style="width:100%; justify-content:center; padding:12px;" onclick="submitCourse()">
          Public Course
        </button>
      </form>
    </div>
  </div>
</div>

<div class="modal" id="applicationModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3>Course Application</h3>
      <button onclick="closeApplicationModal()" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
    </div>
    <div class="modal-body">
      <form id="applicationForm">
        <input type="hidden" id="applyCourseId">
        <p style="margin-bottom: 15px; font-size: 14px; color: var(--secondary-text);">Fill out this form to apply for <strong id="applyCourseTitle"></strong>.</p>

        <div class="form-group">
          <label class="form-label">Your Full Name</label>
          <input type="text" id="applicantName" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Email Address (For Certificate)</label>
          <input type="email" id="applicantEmail" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Your Aspirations for learning this course</label>
          <textarea id="applicantAspirations" class="form-textarea" placeholder="Why do you want to join? (Min 20 chars)" required></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Current Role / Profession</label>
          <input type="text" id="applicantRole" class="form-input" placeholder="e.g. Student, Software Developer, Chef">
        </div>
        
        <button type="button" class="create-btn" id="submitApplicationBtn" style="width:100%; justify-content:center; padding:12px;" onclick="submitApplication()">
          Submit Application
        </button>
      </form>
    </div>
  </div>
</div>

<div class="modal" id="detailModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3 id="detailModalTitle">Course Details</h3>
      <button onclick="closeDetailModal()" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
    </div>
    <div class="modal-body">
      <div class="detail-header">
          <div class="detail-title" id="courseDetailTitle"></div>
          <div class="detail-creator">
              <div id="detailCreatorBadge" class="poster-badge" style="width:36px; height:36px;"></div>
              <span>By <span id="courseDetailCreator"></span></span>
          </div>
          <div class="detail-meta" style="margin-top: 10px; font-size: 12px; color: var(--secondary-text);">
              <span id="courseDetailCategory"></span> | Duration: <span id="courseDetailDuration"></span>
          </div>
      </div>

      <div class="detail-section">
          <h4>Course Summary</h4>
          <p id="courseDetailDescription"></p>
          
          <h4>Instructor Profile</h4>
          <p class="detail-bio" id="courseDetailBio"></p>
      </div>

      <div class="detail-section" id="detailOutlineSection">
          <h4>Course Outline / Learning Outcomes</h4>
          <ul id="courseDetailOutline" class="detail-outline"></ul>
      </div>

      <button class="create-btn" id="detailJoinBtn" style="width:100%; margin-top: 20px;" onclick="openApplicationModal(this.dataset.courseId, this.dataset.courseTitle)">
          Enroll / Join Class
      </button>
      <div id="detailMediaEmbed" style="margin-top:20px;"></div>
    </div>
  </div>
</div>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, updateDoc, arrayUnion, arrayRemove, onSnapshot, query, orderBy, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

  // --- FIREBASE CONFIG ---
  const firebaseConfig = {
      apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
      authDomain: "meet-6e159.firebaseapp.com",
      databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",
      projectId: "meet-6e159",
      storageBucket: "meet-6e159-firebasestorage.app",
      messagingSenderId: "252353608421",
      appId: "1:252353608421:web:6706056048e9a8f12db20c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  window.auth = auth;

  // --- CLOUDINARY CONFIG ---
  const CLOUD_NAME = "dcwof2ngn"; 
  const UPLOAD_PRESET = "Meet_video"; 
  const CLOUDINARY_GENERIC_URL = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`; 

  let currentUser = null;
  let currentType = 'long-video';
  let thumbBase64 = null; 

  // --- AUTH & USER PROFILE ---
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      // Fetch user data...
    } else {
      currentUser = null;
      // Handle guest state...
    }
  });

  // --- CLOUDINARY/DB HELPER FUNCTIONS (Compression, Upload) (Omitted for brevity - same as last working version)
  // ... (compressImage and uploadToCloudinary functions here) ...

  // --- REAL-TIME DATA & FEED RENDERING ---

  // Live query for love counts
  const loveCounts = {};
  onSnapshot(collection(db, "course_loves"), (snapshot) => {
    snapshot.docChanges().forEach((change) => {
        const data = change.doc.data();
        const courseId = data.courseId;
        const count = data.count || 0;
        loveCounts[courseId] = count;
        // Update love display on cards in real-time
        document.querySelectorAll(`.love-count[data-id="${courseId}"]`).forEach(el => {
            el.innerText = count;
        });
    });
  });

  // Main Feed Listener
  const q = query(collection(db, "meetversity_courses"), orderBy("createdAt", "desc"));
  onSnapshot(q, (snapshot) => {
    const courses = [], videos = [], docs = [];
    let learners = 0;

    snapshot.forEach((doc) => {
      const data = { id: doc.id, ...doc.data() };
      learners += (data.learners ? data.learners.length : 0);
      if(data.type === 'long-video') courses.push(data);
      else if(data.type === 'quick-video') videos.push(data);
      else docs.push(data);
    });

    // Update stats...
    document.getElementById('statCourses').innerText = courses.length;
    document.getElementById('statVideos').innerText = videos.length;
    document.getElementById('statDocs').innerText = docs.length;
    document.getElementById('statLearners').innerText = learners;

    // Render feeds dynamically
    renderGrid('coursesFeed', courses, true); // Full course gets 'Join Class'
    renderGrid('videosFeed', videos, false); // Quick video gets 'Details'
    renderGrid('docsFeed', docs, false);    // Docs get 'Details'
  });

  function renderGrid(id, items, showJoinButton) {
    const container = document.getElementById(id);
    container.innerHTML = '';
    if(!items.length) { container.innerHTML = '<div style="padding:10px; color:#888;">No content yet.</div>'; return; }

    items.forEach(item => {
      const lCount = item.learners ? item.learners.length : 0;
      const loves = loveCounts[item.id] || 0;
      const isLoved = currentUser && item.lovedBy?.includes(currentUser.uid);
      
      const posterImg = item.instructorPhoto 
        ? `<img src="${item.instructorPhoto}">` 
        : `<div style="width:100%;height:100%;background:#0080FF;color:white;display:flex;align-items:center;justify-content:center;">${item.instructorName?.[0]||'U'}</div>`;

      const actionButton = showJoinButton 
          ? `<button class="btn-join" onclick="openApplicationModal('${item.id}', '${item.title}')">Join Class</button>`
          : `<button class="btn-join" onclick="viewDetails('${item.id}')">Details</button>`;

      const div = document.createElement('div');
      div.className = 'course-card';
      div.innerHTML = `
        <div class="course-header">
            <img src="${item.thumbnail || 'https://via.placeholder.com/300'}" class="course-thumb">
            <div class="poster-badge">${posterImg}</div>
        </div>
        <div class="course-body">
          ${item.hasCert && item.type !== 'quick-video' ? '<div class="c-cert"><i class="fas fa-certificate"></i> Certificate</div>' : ''}
          <div class="c-cat">${item.category}</div>
          <div class="c-title">${item.title}</div>
          <div class="c-stats">
              <i class="fas fa-clock"></i>${item.duration}
              <i class="fas fa-user-graduate"></i>${lCount}
              <i class="fas fa-star"></i>${item.reviewCount || 0}
          </div>
          <div class="c-meta">
            <span>By ${item.instructorName}</span>
          </div>
          <div class="c-footer">
             <button class="btn-love ${isLoved ? 'loved' : ''}" onclick="toggleLove('${item.id}')">
                <i class="fas fa-heart"></i> <span class="love-count" data-id="${item.id}">${loves}</span>
            </button>
             ${actionButton}
          </div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  // --- LOVE TOGGLE LOGIC ---
  window.toggleLove = async (courseId) => {
    if (!currentUser) { alert("Login required to show love."); return; }
    const courseRef = doc(db, "meetversity_courses", courseId);

    // Check if the user has already loved this course
    const courseDoc = await getDoc(courseRef);
    const lovedBy = courseDoc.data().lovedBy || [];
    const isLoved = lovedBy.includes(currentUser.uid);

    if (isLoved) {
        // UNLOVE
        await updateDoc(courseRef, {
            lovedBy: arrayRemove(currentUser.uid)
        });
        document.querySelector(`.btn-love[onclick*="${courseId}"]`).classList.remove('loved');
    } else {
        // LOVE
        await updateDoc(courseRef, {
            lovedBy: arrayUnion(currentUser.uid)
        });
        document.querySelector(`.btn-love[onclick*="${courseId}"]`).classList.add('loved');
    }
    
    // NOTE: Real-time update of the *count* is handled by the `loveCounts` listener above,
    // which should be implemented using a Cloud Function that aggregates loves from a subcollection
    // to avoid excessive writes. For a client-only solution, we calculate it here:
    // **Temporary client-side update (replace with Cloud Function aggregation for production)**
    const newLoves = isLoved ? loves - 1 : loves + 1;
    document.querySelectorAll(`.love-count[data-id="${courseId}"]`).forEach(el => el.innerText = newLoves);
    loveCounts[courseId] = newLoves;
  };


  // --- DETAILS MODAL LOGIC ---
  window.viewDetails = async (courseId) => {
    if (!currentUser) { alert("Login required to view course details."); return; }
    
    const courseRef = doc(db, "meetversity_courses", courseId);
    const courseDoc = await getDoc(courseRef);
    if (!courseDoc.exists()) { alert("Course not found."); return; }
    const data = courseDoc.data();

    // Fill UI elements
    document.getElementById('courseDetailTitle').innerText = data.title;
    document.getElementById('courseDetailCreator').innerText = data.instructorName;
    document.getElementById('courseDetailCategory').innerText = data.category;
    document.getElementById('courseDetailDuration').innerText = data.duration;
    document.getElementById('courseDetailDescription').innerText = data.description;
    document.getElementById('courseDetailBio').innerText = data.instructorBio || "The creator has not provided a bio.";

    const creatorBadge = document.getElementById('detailCreatorBadge');
    if(data.instructorPhoto) {
        creatorBadge.innerHTML = `<img src="${data.instructorPhoto}" style="width:100%;height:100%;object-fit:cover;">`;
    } else {
        creatorBadge.innerHTML = data.instructorName?.[0]||'U';
        creatorBadge.style.backgroundColor = '#0080FF';
    }

    // Handle Outline Section
    const outlineUl = document.getElementById('courseDetailOutline');
    outlineUl.innerHTML = '';
    const outlineSection = document.getElementById('detailOutlineSection');
    
    if (data.type === 'long-video' && data.outcomes && data.outcomes.length > 0) {
        data.outcomes.forEach(item => {
            const li = document.createElement('li');
            li.innerHTML = `<i class="fas fa-check-circle" style="color:var(--success); margin-right:5px;"></i>${item}`;
            outlineUl.appendChild(li);
        });
        outlineSection.style.display = 'block';
    } else {
        outlineSection.style.display = 'none';
    }
    
    // Handle Join Button visibility based on content type
    const joinBtn = document.getElementById('detailJoinBtn');
    if (data.type === 'long-video') {
        joinBtn.style.display = 'block';
        joinBtn.dataset.courseId = courseId;
        joinBtn.dataset.courseTitle = data.title;
    } else {
        joinBtn.style.display = 'none';
    }

    // You would typically embed a video player or document viewer here
    document.getElementById('detailMediaEmbed').innerHTML = `<a href="${data.mediaUrl}" target="_blank" style="color:var(--primary); font-size:14px;"><i class="fas fa-external-link-alt"></i> View Content File</a>`;

    document.getElementById('detailModal').style.display = 'flex';
  };
  window.closeDetailModal = () => {
    document.getElementById('detailModal').style.display = 'none';
  };


  // --- APPLICATION FORM MODAL LOGIC (New) ---

  window.openApplicationModal = (courseId, title) => {
    if (!currentUser) { alert("Login required to apply for a course."); return; }
    document.getElementById('applyCourseId').value = courseId;
    document.getElementById('applyCourseTitle').innerText = title;
    
    // Pre-fill user data if available
    document.getElementById('applicantName').value = currentUser.displayName || '';
    document.getElementById('applicantEmail').value = currentUser.email || '';

    document.getElementById('applicationModal').style.display = 'flex';
  };

  window.closeApplicationModal = () => {
    document.getElementById('applicationModal').style.display = 'none';
    document.getElementById('applicationForm').reset();
  };

  window.submitApplication = async () => {
    const courseId = document.getElementById('applyCourseId').value;
    const name = document.getElementById('applicantName').value;
    const email = document.getElementById('applicantEmail').value;
    const aspirations = document.getElementById('applicantAspirations').value;
    const role = document.getElementById('applicantRole').value;

    if (aspirations.length < 20) {
        alert("Aspirations must be at least 20 characters long.");
        return;
    }

    const submitBtn = document.getElementById('submitApplicationBtn');
    submitBtn.innerText = "Submitting...";
    submitBtn.disabled = true;

    try {
        // 1. Save Application to new 'course_applications' collection
        await addDoc(collection(db, "course_applications"), {
            courseId: courseId,
            applicantId: currentUser.uid,
            name: name,
            email: email,
            aspirations: aspirations,
            role: role,
            appliedAt: serverTimestamp()
        });

        // 2. Mark user as 'learner' in the course document (Joining the class)
        await updateDoc(doc(db, "meetversity_courses", courseId), {
            learners: arrayUnion(currentUser.uid)
        });

        alert("Application submitted successfully! You have been enrolled.");
        closeApplicationModal();

    } catch (e) {
        console.error("Application submission failed:", e);
        alert(`Submission failed: ${e.message || "Please try again."}`);
    } finally {
        submitBtn.innerText = "Submit Application";
        submitBtn.disabled = false;
        // Redirect back to meetversity page (already on this page, so just closing the modal is enough)
    }
  };

  // --- CREATION FORM LOGIC (Updated fields) ---

  // ... (openCreateModal and closeCreateModal functions here - largely unchanged) ...
  // The original setType and addLearnItem functions are valid.

  // Main Submit Logic (Updated with new fields)
  window.submitCourse = async () => {
      const btn = document.getElementById('submitBtn');
      const progress = document.getElementById('mediaProgress');
      const fill = document.getElementById('mediaProgressFill');
      
      // Get all fields
      const title = document.getElementById('cTitle').value;
      const description = document.getElementById('cDescription').value;
      const category = document.getElementById('cCategory').value;
      const duration = document.getElementById('cDuration').value;
      const instructorBio = document.getElementById('cInstructorBio').value;
      const hasCert = document.getElementById('cCert').checked;
      
      const mediaFile = document.getElementById('cMediaFile').files[0];
      
      // Validation checks
      if(!title || !mediaFile || !description || !duration) {
        alert("Please fill in all required fields.");
        return;
      }
      if(description.length < 10) {
        alert("Description must be at least 10 characters long.");
        return;
      }
      if(instructorBio.length > 500) {
        alert("Instructor Bio cannot exceed 500 characters.");
        return;
      }

      const learnInputs = document.querySelectorAll('.learn-input');
      const outcomes = [];
      if(currentType !== 'document') {
          learnInputs.forEach(i => { if(i.value.trim()) outcomes.push(i.value.trim()); });
          if(outcomes.length === 0) { alert("Please provide at least one lesson/outcome for video content."); return; }
      }

      if(!thumbBase64) { alert("Please upload a thumbnail"); return; }

      btn.innerText = "Uploading...";
      btn.disabled = true;
      progress.style.display = 'block';
      fill.style.width = '10%';

      try {
          // 1. Upload Thumbnail (Base64 -> Cloudinary)
          const thumbUrl = await uploadToCloudinary(thumbBase64);
          fill.style.width = '40%';

          // 2. Upload Main Content (Video/Image/PDF -> Cloudinary)
          const mediaUrl = await uploadToCloudinary(mediaFile); 
          fill.style.width = '80%';

          // 3. Save to Firestore
          await addDoc(collection(db, "meetversity_courses"), {
              title, 
              description, 
              category, 
              duration, // Added duration
              // Price and Currency removed as requested
              instructorBio: instructorBio || null,
              type: currentType,
              thumbnail: thumbUrl,
              mediaUrl: mediaUrl,
              outcomes: outcomes,
              hasCert: currentType === 'long-video' ? hasCert : false, // Only long-video can offer cert
              instructorId: currentUser.uid,
              instructorName: currentUser.displayName || 'Instructor',
              instructorPhoto: currentUser.photoURL || null,
              learners: [],
              lovedBy: [], // Initialize love array
              reviewCount: 0, // Initialize review count
              createdAt: serverTimestamp()
          });

          fill.style.width = '100%';
          alert("Content Posted Successfully!");
          closeCreateModal();

      } catch(e) {
          console.error("Final Submission Error:", e);
          alert(`Upload failed: ${e.message || "An unknown error occurred."}`);
      } finally {
          btn.innerText = "Public Course";
          btn.disabled = false;
          progress.style.display = 'none';
      }
  };

  // Dark mode toggle
  document.getElementById('toggleDark').onclick = () => document.body.classList.toggle('dark-mode');

  // Initialization
  document.addEventListener('DOMContentLoaded', () => {
    setType(currentType, document.querySelector(`.type-tab[onclick*="long-video"]`));
  });
</script>
</body>
</html>
