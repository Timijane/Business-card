<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WhatsApp Call Clone - Secure</title>

<style>
  body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #0b0f19; color: #fff; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
  .hidden { display: none !important; }
  
  /* UI Layout */
  #login-screen, #dashboard { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; }
  input { padding: 15px; border-radius: 8px; border: 1px solid #333; background: #1f2a48; color: white; width: 280px; margin-bottom: 10px; font-size: 16px; outline: none; }
  
  /* Video Call UI */
  #call-screen { position: relative; flex: 1; display: flex; flex-direction: column; background: #000; }
  #video-container { position: relative; flex: 1; display: flex; justify-content: center; align-items: center; }
  #remoteVideo { width: 100%; height: 100%; background: #111; object-fit: cover; }
  #localVideo { position: absolute; bottom: 20px; right: 20px; width: 100px; height: 140px; border-radius: 8px; border: 2px solid #fff; background: #333; z-index: 10; object-fit: cover; }
  
  /* Control Buttons */
  #controls { padding: 25px; background: #11162a; display: flex; justify-content: center; gap: 20px; }
  .btn { width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
  .btn-green { background: #25D366; color: white; }
  .btn-red { background: #FF3B30; color: white; }
  .btn-gray { background: #3a3a3a; color: white; }
  .btn:active { transform: scale(0.9); }

  /* Incoming Popup */
  #incoming-call { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: #1f2a48; padding: 20px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index: 100; width: 85%; max-width: 320px; border: 1px solid #25D366; }
</style>
</head>
<body>

<div id="login-screen">
  <h2>Secure Call Clone</h2>
  <p style="color: #aaa; margin-bottom: 20px;">Authenticated Session Required</p>
  <button class="btn btn-green" style="width: 250px; border-radius: 8px;" onclick="login()">Enter App Securely</button>
</div>

<div id="dashboard" class="hidden">
  <h2 id="welcome-msg"></h2>
  <p id="my-id-display" style="font-size: 12px; color: #25D366;"></p>
  <div style="margin-top: 30px;">
    <input type="text" id="callee-input" placeholder="Paste Recipient UID here">
    <br>
    <button class="btn btn-green" style="width: 250px; border-radius: 8px; margin-top:10px" onclick="startCall()">Start Secure Video Call</button>
  </div>
</div>

<div id="incoming-call" class="hidden">
  <h3 id="caller-name">Incoming Call</h3>
  <p>Encrypted Video Connection...</p>
  <div style="display: flex; justify-content: center; gap: 20px;">
    <button class="btn btn-green" onclick="answerCall()">üìû</button>
    <button class="btn btn-red" onclick="rejectCall()">‚ùå</button>
  </div>
</div>

<div id="call-screen" class="hidden">
  <div id="video-container">
    <div id="status-text" style="position: absolute; color: #fff; z-index: 5;">Connecting to Peer...</div>
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay muted playsinline></video>
  </div>
  <div id="controls">
    <button class="btn btn-gray" onclick="toggleMic()">üé§</button>
    <button class="btn btn-gray" onclick="toggleCam()">üì∑</button>
    <button class="btn btn-red" onclick="endCall()">‚ùå</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, setDoc, addDoc, updateDoc, onSnapshot, collection, query, where, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
    authDomain: "meet-6e159.firebaseapp.com",
    projectId: "meet-6e159",
    storageBucket: "meet-6e159.firebasestorage.app",
    messagingSenderId: "252353608421",
    appId: "1:252353608421:web:6706056048e9a8f12db20c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const rtcConfig = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };

  let pc = null, localStream = null, currentCallDocId = null, myUid = null;

  // 1. AUTHENTICATED LOGIN
  window.login = async function() {
    try {
      await signInAnonymously(auth);
    } catch (e) {
      alert("Auth Error: Ensure Anonymous Auth is enabled in Firebase Console.");
    }
  };

  onAuthStateChanged(auth, (user) => {
    if (user) {
      myUid = user.uid;
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      document.getElementById('welcome-msg').innerText = "Secure Dashboard";
      document.getElementById('my-id-display').innerText = `Your Public ID: ${myUid}`;
      listenForIncomingCalls();
    }
  });

  // 2. LISTENING (SECURE)
  function listenForIncomingCalls() {
    const q = query(collection(db, 'calls'), where('calleeId', '==', myUid), where('type', '==', 'offer'));
    onSnapshot(q, (snapshot) => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') {
          const data = change.doc.data();
          if (!currentCallDocId && !data.status) {
            currentCallDocId = change.doc.id;
            document.getElementById('incoming-call').classList.remove('hidden');
          }
        }
      });
    });
  }

  // 3. START CALL
  window.startCall = async function() {
    const calleeId = document.getElementById('callee-input').value.trim();
    if (!calleeId) return alert("Enter a valid User UID");

    await setupMedia();
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('call-screen').classList.remove('hidden');

    const callDocRef = doc(collection(db, 'calls'));
    currentCallDocId = callDocRef.id;

    pc = new RTCPeerConnection(rtcConfig);
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

    pc.onicecandidate = e => e.candidate && addDoc(collection(callDocRef, 'offerCandidates'), e.candidate.toJSON());
    pc.ontrack = e => {
      document.getElementById('remoteVideo').srcObject = e.streams[0];
      document.getElementById('status-text').innerText = "";
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    await setDoc(callDocRef, { callerId: myUid, calleeId, type: 'offer', offer: { sdp: offer.sdp, type: offer.type } });

    onSnapshot(callDocRef, snap => {
      const data = snap.data();
      if (!pc.currentRemoteDescription && data?.answer) pc.setRemoteDescription(new RTCSessionDescription(data.answer));
      if (data?.status === 'ended') endCall(false);
    });

    onSnapshot(collection(callDocRef, 'answerCandidates'), snap => {
      snap.docChanges().forEach(change => {
        if (change.type === 'added') pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
      });
    });
  };

  // 4. ANSWER CALL
  window.answerCall = async function() {
    document.getElementById('incoming-call').classList.add('hidden');
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('call-screen').classList.remove('hidden');

    await setupMedia();
    const callDocRef = doc(db, 'calls', currentCallDocId);
    pc = new RTCPeerConnection(rtcConfig);
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

    pc.onicecandidate = e => e.candidate && addDoc(collection(callDocRef, 'answerCandidates'), e.candidate.toJSON());
    pc.ontrack = e => {
      document.getElementById('remoteVideo').srcObject = e.streams[0];
      document.getElementById('status-text').innerText = "";
    };

    const callData = (await getDoc(callDocRef)).data();
    await pc.setRemoteDescription(new RTCSessionDescription(callData.offer));

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await updateDoc(callDocRef, { answer: { type: answer.type, sdp: answer.sdp } });

    onSnapshot(collection(callDocRef, 'offerCandidates'), snap => {
      snap.docChanges().forEach(c => c.type === 'added' && pc.addIceCandidate(new RTCIceCandidate(c.doc.data())));
    });

    onSnapshot(callDocRef, snap => snap.data()?.status === 'ended' && endCall(false));
  };

  // HELPERS
  async function setupMedia() {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    document.getElementById('localVideo').srcObject = localStream;
  }

  window.endCall = async function(notify = true) {
    if (localStream) localStream.getTracks().forEach(t => t.stop());
    if (pc) pc.close();
    if (currentCallDocId && notify) await updateDoc(doc(db, 'calls', currentCallDocId), { status: 'ended' });
    window.location.reload();
  };

  window.toggleMic = () => localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled;
  window.toggleCam = () => localStream.getVideoTracks()[0].enabled = !localStream.getVideoTracks()[0].enabled;
  window.rejectCall = () => document.getElementById('incoming-call').classList.add('hidden');
</script>
</body>
</html>
