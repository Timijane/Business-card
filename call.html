<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pro Video/Voice Call</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

<style>
body{margin:0;font-family:Arial,sans-serif;background:#0b0f19;color:#fff}
.hidden{display:none}
video{width:50%;height:50vh;object-fit:cover;background:#000;margin-bottom:4px}
button{padding:12px 16px;margin:6px;border:none;border-radius:6px;font-size:15px}
.accept{background:#00c853;color:#fff}
.reject{background:#d50000;color:#fff}
.control{background:#1f2a48;color:#fff}
#chat{width:100%;height:160px;background:#11162a;display:flex;flex-direction:column}
#messages{flex:1;overflow-y:auto;padding:8px;font-size:14px}
#chat input{padding:10px;border:none;outline:none}
#call-history{margin-top:10px;font-size:14px}
.call-entry{padding:6px;border-bottom:1px solid #333}
.missed{color:#d50000}
#timer{margin-top:6px;font-size:14px}
</style>
</head>
<body>

<!-- RINGING SCREEN -->
<div id="ringing" class="hidden">
  <h2>Incoming Call...</h2>
  <audio id="ringtone" loop src="https://actions.google.com/sounds/v1/alarms/phone_alerts_and_ringtones.ogg" autoplay></audio>
  <button class="accept" onclick="acceptCall()">Accept</button>
  <button class="reject" onclick="rejectCall()">Reject</button>
</div>

<!-- CALL UI -->
<div id="callUI" class="hidden">
  <div id="videos">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay muted playsinline></video>
  </div>

  <div id="controls">
    <button class="control" onclick="toggleMic()">Mic</button>
    <button class="control" onclick="toggleCam()">Cam</button>
    <button class="reject" onclick="endCall()">End</button>
  </div>

  <div id="timer">Call duration: <span id="duration">00:00</span></div>

  <!-- IN-CALL CHAT -->
  <div id="chat">
    <div id="messages"></div>
    <input id="msgInput" placeholder="Type messageâ€¦" onkeydown="sendMessage(event)">
  </div>
</div>

<!-- CALL HISTORY -->
<div id="call-history">
  <h3>Call History</h3>
  <div id="history-list"></div>
</div>

<script>
// =================== FIREBASE CONFIG ===================
const firebaseConfig = {
  apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
  authDomain: "meet-6e159.firebaseapp.com",
  projectId: "meet-6e159",
  storageBucket: "meet-6e159.firebasestorage.app",
  messagingSenderId: "252353608421",
  appId: "1:252353608421:web:6706056048e9a8f12db20c"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// =================== AUTH ===================
async function signIn() {
  const user = await auth.signInAnonymously();
  return user.user.uid;
}

// =================== GLOBALS ===================
let userId, pc, localStream, callId, role, calleeId = null;
const rtcConfig = { iceServers:[{urls:"stun:stun.l.google.com:19302"}] };

// UI
const ringing = document.getElementById("ringing");
const callUI = document.getElementById("callUI");
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const messagesDiv = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const historyList = document.getElementById("history-list");
const durationEl = document.getElementById("duration");
const ringtone = document.getElementById("ringtone");

let callRef, offerCandidates, answerCandidates, messagesRef;
let callStartTime, timerInterval;

// =================== UTILITY ===================
function addToHistory(status) {
  const entry = document.createElement("div");
  entry.className = "call-entry" + (status==="missed"?" missed":"");
  entry.textContent = `[${new Date().toLocaleTimeString()}] ${status} call ${role==="caller"?"to":"from"} ${calleeId || "unknown"}`;
  historyList.prepend(entry);

  db.collection("call_history").add({
    userId,
    roomId: callId,
    calleeId: calleeId,
    status,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
}

// =================== MEDIA ===================
async function startMedia() {
  localStream = await navigator.mediaDevices.getUserMedia({
    audio:true,
    video:true
  });
  localVideo.srcObject = localStream;
}

// =================== TIMER ===================
function startTimer(){
  callStartTime = Date.now();
  timerInterval = setInterval(()=>{
    const diff = Date.now()-callStartTime;
    const mins = String(Math.floor(diff/60000)).padStart(2,"0");
    const secs = String(Math.floor((diff%60000)/1000)).padStart(2,"0");
    durationEl.textContent = `${mins}:${secs}`;
  },1000);
}
function stopTimer(){ clearInterval(timerInterval); }

// =================== CALL LOGIC ===================
async function initCall() {
  role = prompt("Are you caller or callee? (caller/callee)","caller");
  callId = prompt("Enter room ID or leave empty for new call","") || db.collection("calls").doc().id;

  if(role==="caller") calleeId = prompt("Enter callee ID","callee");
  userId = await signIn();

  callRef = db.collection("calls").doc(callId);
  offerCandidates = callRef.collection("offerIce");
  answerCandidates = callRef.collection("answerIce");
  messagesRef = callRef.collection("messages");

  if(role==="caller") startCaller();
  else listenForCall();
}

// =================== CALLER ===================
async function startCaller(){
  await startMedia();

  await callRef.set({
    callerId:userId,
    calleeId:calleeId,
    status:"calling",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  pc = new RTCPeerConnection(rtcConfig);
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.ontrack = e => remoteVideo.srcObject = e.streams[0];
  pc.onicecandidate = e=>e.candidate && offerCandidates.add(e.candidate.toJSON());

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await callRef.update({offer});

  callRef.onSnapshot(snap=>{
    const data = snap.data();
    if(data?.answer && !pc.currentRemoteDescription){
      pc.setRemoteDescription(new RTCSessionDescription(data.answer));
      showCallUI();
    }
    if(data?.status==="ended"){ endCall(); }
  });

  answerCandidates.onSnapshot(snap=>{
    snap.docChanges().forEach(c=>{
      if(c.type==="added") pc.addIceCandidate(c.doc.data());
    });
  });
}

// =================== CALLEE ===================
function listenForCall(){
  ringing.classList.remove("hidden");
  ringtone.play();
  callRef.onSnapshot(async snap=>{
    const data = snap.data();
    if(data?.offer && !pc){ acceptCall(); calleeId = data.callerId; }
    if(data?.status==="ended"){ endCall(); }
  });
}

// =================== ACCEPT CALL ===================
async function acceptCall(){
  ringing.classList.add("hidden");
  ringtone.pause();
  await startMedia();

  pc = new RTCPeerConnection(rtcConfig);
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.ontrack = e => remoteVideo.srcObject = e.streams[0];
  pc.onicecandidate = e => e.candidate && answerCandidates.add(e.candidate.toJSON());

  const snap = await callRef.get();
  await pc.setRemoteDescription(new RTCSessionDescription(snap.data().offer));

  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await callRef.update({answer,status:"active"});

  offerCandidates.onSnapshot(snap=>{
    snap.docChanges().forEach(c=>{
      if(c.type==="added") pc.addIceCandidate(c.doc.data());
    });
  });

  showCallUI();
  startTimer();
}

// =================== REJECT / END ===================
function rejectCall(){ 
  ringtone.pause();
  callRef.update({status:"missed"});
  addToHistory("missed");
  window.location.href="chat.html";
}
function endCall(){
  pc?.close();
  localStream?.getTracks().forEach(t=>t.stop());
  callRef.update({status:"ended"});
  addToHistory("ended");
  stopTimer();
  window.location.href="chat.html";
}

// =================== CONTROLS ===================
function toggleMic(){ localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled; }
function toggleCam(){ if(localStream.getVideoTracks()[0]) localStream.getVideoTracks()[0].enabled = !localStream.getVideoTracks()[0].enabled; }

// =================== IN-CALL CHAT ===================
messagesRef.onSnapshot(snap=>{
  snap.docChanges().forEach(c=>{
    if(c.type==="added"){
      const msg = c.doc.data();
      messagesDiv.innerHTML += `<div>${msg.senderId===userId?"You":calleeId}: ${msg.text}</div>`;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  });
});

function sendMessage(e){
  if(e.key==="Enter" && e.target.value.trim()){
    messagesRef.add({ senderId:userId, text:e.target.value });
    e.target.value = "";
  }
}

// =================== INIT ===================
initCall();

function showCallUI(){ callUI.classList.remove("hidden"); }
</script>
</body>
</html>
