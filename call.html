<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Call</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --primary: #0080FF;
  --primary-dark: #0066CC;
  --whatsapp-green: #00A884;
  --whatsapp-green-dark: #008069;
  --danger: #E53935;
  --danger-dark: #C62828;
  --success: #43A047;
  --warning: #FF9800;
  --bg-dark: #111B21;
  --bg-darker: #0B141A;
  --card-bg: #202C33;
  --text-light: #E9EDEF;
  --text-gray: #8696A0;
  --border-color: #2A3942;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
  font-family: 'Poppins', sans-serif;
  background: var(--bg-darker);
  color: var(--text-light);
}

/* WhatsApp-inspired Call Container */
.call-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  background: var(--bg-dark);
  z-index: 9999;
}

/* Call Header - WhatsApp Style */
.call-header {
  background: rgba(17, 27, 33, 0.9);
  backdrop-filter: blur(10px);
  padding: 15px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border-color);
  position: relative;
  z-index: 10;
}

.call-header-info {
  display: flex;
  align-items: center;
  gap: 15px;
}

.call-avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--whatsapp-green);
}

.call-info h3 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 5px;
}

.call-status {
  font-size: 14px;
  color: var(--text-gray);
  display: flex;
  align-items: center;
  gap: 8px;
}

.call-status.ringing {
  color: var(--whatsapp-green);
  animation: pulse 1.5s infinite;
}

.call-status.connected {
  color: var(--success);
}

.call-timer {
  font-family: 'Monaco', 'Courier New', monospace;
  font-size: 14px;
  letter-spacing: 1px;
}

.call-close-btn {
  background: rgba(255, 255, 255, 0.1);
  border: none;
  color: var(--text-light);
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 18px;
  transition: all 0.2s ease;
}

.call-close-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: scale(1.1);
}

/* Video Container - WhatsApp Style */
.video-container {
  flex: 1;
  position: relative;
  overflow: hidden;
  background: var(--bg-darker);
}

.remote-video-container {
  width: 100%;
  height: 100%;
  position: relative;
}

#remoteVideo {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.local-video-container {
  position: absolute;
  bottom: 100px;
  right: 20px;
  width: 120px;
  height: 160px;
  border-radius: 12px;
  overflow: hidden;
  border: 2px solid var(--whatsapp-green);
  background: var(--card-bg);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
  z-index: 5;
}

#localVideo {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.video-off-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--card-bg);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: var(--text-gray);
}

.video-off-overlay i {
  font-size: 40px;
  margin-bottom: 10px;
}

.video-off-overlay span {
  font-size: 14px;
}

/* Audio Only View */
.audio-only-view {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  text-align: center;
}

.user-avatar-large {
  width: 150px;
  height: 150px;
  border-radius: 50%;
  object-fit: cover;
  border: 4px solid var(--whatsapp-green);
  margin-bottom: 30px;
  box-shadow: 0 8px 32px rgba(0, 168, 132, 0.3);
}

.user-name {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 10px;
}

.call-type-indicator {
  color: var(--text-gray);
  font-size: 14px;
  margin-bottom: 30px;
}

/* Call Controls - WhatsApp Inspired */
.call-controls {
  padding: 20px;
  background: rgba(17, 27, 33, 0.95);
  backdrop-filter: blur(20px);
  border-top: 1px solid var(--border-color);
  display: flex;
  justify-content: center;
  gap: 25px;
  position: relative;
  z-index: 10;
}

.control-btn {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
}

.control-btn::after {
  content: '';
  position: absolute;
  top: -4px;
  left: -4px;
  right: -4px;
  bottom: -4px;
  border-radius: 50%;
  border: 2px solid transparent;
  transition: border-color 0.3s ease;
}

.control-btn:hover::after {
  border-color: rgba(255, 255, 255, 0.1);
}

.control-btn:active {
  transform: scale(0.95);
}

.control-btn.end-call {
  background: var(--danger);
  color: white;
  transform: rotate(135deg);
}

.control-btn.end-call:hover {
  background: var(--danger-dark);
  transform: rotate(135deg) scale(1.05);
}

.control-btn.mute {
  background: rgba(255, 255, 255, 0.15);
  color: white;
}

.control-btn.mute.active {
  background: rgba(255, 255, 255, 0.25);
  color: var(--danger);
}

.control-btn.video-toggle {
  background: rgba(255, 255, 255, 0.15);
  color: white;
}

.control-btn.video-toggle.active {
  background: rgba(255, 255, 255, 0.25);
  color: var(--danger);
}

.control-btn.speaker {
  background: rgba(255, 255, 255, 0.15);
  color: white;
}

.control-btn.speaker.active {
  background: var(--whatsapp-green);
  color: white;
}

.control-btn.flip-camera {
  background: rgba(255, 255, 255, 0.15);
  color: white;
}

.control-btn.add-participant {
  background: rgba(255, 255, 255, 0.15);
  color: white;
}

.control-label {
  position: absolute;
  bottom: -25px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 11px;
  color: var(--text-gray);
  white-space: nowrap;
}

/* Incoming Call Screen */
.incoming-call-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, var(--bg-darker) 0%, var(--bg-dark) 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-between;
  padding: 60px 20px 40px;
  z-index: 99999;
  animation: fadeIn 0.3s ease;
}

.caller-info {
  text-align: center;
  margin-top: 60px;
}

.caller-avatar {
  width: 150px;
  height: 150px;
  border-radius: 50%;
  object-fit: cover;
  border: 4px solid var(--whatsapp-green);
  margin-bottom: 25px;
  box-shadow: 0 8px 32px rgba(0, 168, 132, 0.3);
}

.caller-name {
  font-size: 28px;
  font-weight: 600;
  margin-bottom: 10px;
}

.call-type {
  font-size: 16px;
  color: var(--text-gray);
  margin-bottom: 5px;
}

.call-status-text {
  font-size: 14px;
  color: var(--whatsapp-green);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.incoming-call-controls {
  display: flex;
  gap: 60px;
  margin-bottom: 50px;
}

.incoming-control-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.incoming-control-btn:active {
  transform: scale(0.95);
}

.incoming-btn-circle {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
}

.accept-btn {
  background: var(--whatsapp-green);
}

.decline-btn {
  background: var(--danger);
}

.incoming-btn-label {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-gray);
}

/* Call Ended Screen */
.call-ended-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--bg-dark);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 99999;
  animation: fadeIn 0.3s ease;
}

.call-ended-icon {
  font-size: 80px;
  color: var(--text-gray);
  margin-bottom: 30px;
  opacity: 0.7;
}

.call-ended-info h2 {
  font-size: 28px;
  font-weight: 600;
  margin-bottom: 15px;
  text-align: center;
}

.call-ended-info p {
  color: var(--text-gray);
  text-align: center;
  margin-bottom: 25px;
  max-width: 300px;
}

.call-duration {
  font-size: 48px;
  font-family: 'Monaco', 'Courier New', monospace;
  color: var(--whatsapp-green);
  margin-bottom: 40px;
  letter-spacing: 2px;
}

.back-to-chat-btn {
  background: var(--whatsapp-green);
  color: white;
  border: none;
  padding: 15px 40px;
  border-radius: 25px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: all 0.3s ease;
}

.back-to-chat-btn:hover {
  background: var(--whatsapp-green-dark);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 168, 132, 0.4);
}

/* Connection Quality Indicator */
.connection-quality {
  position: absolute;
  top: 20px;
  right: 20px;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(10px);
  padding: 8px 12px;
  border-radius: 20px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  z-index: 5;
}

.connection-dots {
  display: flex;
  gap: 3px;
}

.connection-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--text-gray);
}

.connection-dot.good {
  background: var(--success);
}

.connection-dot.fair {
  background: var(--warning);
}

.connection-dot.poor {
  background: var(--danger);
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

@keyframes slideUp {
  from { transform: translateY(100px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* Responsive Design */
@media (max-width: 768px) {
  .local-video-container {
    width: 100px;
    height: 140px;
    bottom: 90px;
    right: 15px;
  }
  
  .control-btn {
    width: 55px;
    height: 55px;
    font-size: 20px;
  }
  
  .call-controls {
    gap: 20px;
  }
  
  .caller-avatar {
    width: 120px;
    height: 120px;
  }
  
  .incoming-call-controls {
    gap: 40px;
  }
  
  .incoming-btn-circle {
    width: 60px;
    height: 60px;
    font-size: 24px;
  }
}

@media (max-width: 480px) {
  .local-video-container {
    width: 80px;
    height: 120px;
    bottom: 80px;
    right: 10px;
  }
  
  .control-btn {
    width: 50px;
    height: 50px;
    font-size: 18px;
  }
  
  .call-controls {
    gap: 15px;
    padding: 15px;
  }
  
  .control-label {
    font-size: 10px;
    bottom: -22px;
  }
  
  .incoming-call-controls {
    gap: 30px;
  }
  
  .incoming-btn-circle {
    width: 50px;
    height: 50px;
    font-size: 20px;
  }
}

/* Loading Screen */
.loading-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--bg-dark);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 99999;
}

.loading-spinner {
  width: 60px;
  height: 60px;
  border: 3px solid rgba(0, 168, 132, 0.3);
  border-top: 3px solid var(--whatsapp-green);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Notification */
.notification {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(10px);
  color: white;
  padding: 12px 24px;
  border-radius: 25px;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 100000;
  animation: slideUp 0.3s ease;
}

.hidden {
  display: none !important;
}
</style>
</head>
<body>
<div class="call-container" id="callContainer">
  <!-- Call Header -->
  <div class="call-header">
    <div class="call-header-info">
      <img src="" alt="User" class="call-avatar" id="userAvatar">
      <div class="call-info">
        <h3 id="userName">User</h3>
        <div class="call-status" id="callStatus">
          <span id="statusText">Connecting...</span>
          <span class="call-timer" id="callTimer">00:00</span>
        </div>
      </div>
    </div>
    <button class="call-close-btn" id="closeCallBtn">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- Video Call View -->
  <div class="video-container" id="videoContainer">
    <div class="remote-video-container">
      <video id="remoteVideo" autoplay playsinline></video>
      <div class="video-off-overlay" id="remoteVideoOff">
        <i class="fas fa-video-slash"></i>
        <span id="remoteUserName">User</span>
      </div>
    </div>
    <div class="local-video-container">
      <video id="localVideo" autoplay muted playsinline></video>
      <div class="video-off-overlay" id="localVideoOff">
        <i class="fas fa-video-slash"></i>
        <span>You</span>
      </div>
    </div>
    
    <!-- Connection Quality Indicator -->
    <div class="connection-quality" id="connectionQuality">
      <div class="connection-dots">
        <div class="connection-dot good" id="dot1"></div>
        <div class="connection-dot good" id="dot2"></div>
        <div class="connection-dot good" id="dot3"></div>
      </div>
      <span id="qualityText">Good</span>
    </div>
  </div>

  <!-- Audio Only View -->
  <div class="audio-only-view hidden" id="audioOnlyView">
    <img src="" alt="User" class="user-avatar-large" id="audioUserAvatar">
    <div class="user-name" id="audioUserName">User</div>
    <div class="call-type-indicator" id="audioCallType">Voice call</div>
  </div>

  <!-- Call Controls -->
  <div class="call-controls">
    <button class="control-btn mute" id="muteBtn" title="Mute">
      <i class="fas fa-microphone"></i>
      <span class="control-label">Mute</span>
    </button>
    
    <button class="control-btn video-toggle" id="videoToggleBtn" title="Turn off video">
      <i class="fas fa-video"></i>
      <span class="control-label">Video</span>
    </button>
    
    <button class="control-btn speaker" id="speakerBtn" title="Speaker">
      <i class="fas fa-volume-up"></i>
      <span class="control-label">Speaker</span>
    </button>
    
    <button class="control-btn end-call" id="endCallBtn" title="End call">
      <i class="fas fa-phone"></i>
      <span class="control-label">End</span>
    </button>
    
    <button class="control-btn flip-camera" id="flipCameraBtn" title="Flip camera">
      <i class="fas fa-camera-rotate"></i>
      <span class="control-label">Flip</span>
    </button>
    
    <button class="control-btn add-participant" id="addParticipantBtn" title="Add participant">
      <i class="fas fa-user-plus"></i>
      <span class="control-label">Add</span>
    </button>
  </div>
</div>

<!-- Incoming Call Screen -->
<div class="incoming-call-screen hidden" id="incomingCallScreen">
  <div class="caller-info">
    <img src="" alt="Caller" class="caller-avatar" id="callerAvatar">
    <div class="caller-name" id="callerName">Caller Name</div>
    <div class="call-type" id="incomingCallType">Video Call</div>
    <div class="call-status-text">
      <i class="fas fa-phone-alt fa-flip-horizontal"></i>
      <span>Incoming call...</span>
    </div>
  </div>
  
  <div class="incoming-call-controls">
    <button class="incoming-control-btn" onclick="acceptIncomingCall()">
      <div class="incoming-btn-circle accept-btn">
        <i class="fas fa-phone-alt"></i>
      </div>
      <span class="incoming-btn-label">Accept</span>
    </button>
    
    <button class="incoming-control-btn" onclick="declineIncomingCall()">
      <div class="incoming-btn-circle decline-btn">
        <i class="fas fa-phone-slash"></i>
      </div>
      <span class="incoming-btn-label">Decline</span>
    </button>
  </div>
</div>

<!-- Call Ended Screen -->
<div class="call-ended-screen hidden" id="callEndedScreen">
  <div class="call-ended-icon">
    <i class="fas fa-phone-slash"></i>
  </div>
  <div class="call-ended-info">
    <h2 id="callEndedTitle">Call Ended</h2>
    <p id="callEndedMessage">The call has ended.</p>
    <div class="call-duration" id="callDuration">00:00</div>
    <button class="back-to-chat-btn" onclick="goBackToChat()">
      <i class="fas fa-arrow-left"></i>
      Back to Chat
    </button>
  </div>
</div>

<!-- Loading Screen -->
<div class="loading-screen hidden" id="loadingScreen">
  <div class="loading-spinner"></div>
  <div id="loadingText">Connecting...</div>
</div>

<!-- Notification -->
<div class="notification hidden" id="notification">
  <i class="fas fa-info-circle"></i>
  <span id="notificationText"></span>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
  authDomain: "meet-6e159.firebaseapp.com",
  projectId: "meet-6e159",
  storageBucket: "meet-6e159.firebasestorage.app",
  messagingSenderId: "252353608421",
  appId: "1:252353608421:web:6706056048e9a8f12db20c"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// WebRTC Configuration
const servers = {
  iceServers: [
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:stun1.l.google.com:19302' },
    { urls: 'stun:stun2.l.google.com:19302' },
    { urls: 'stun:stun3.l.google.com:19302' },
    { urls: 'stun:stun4.l.google.com:19302' }
  ]
};

// Global Variables
let currentUser = null;
let peerConnection = null;
let localStream = null;
let remoteStream = null;
let currentCallId = null;
let callType = null; // 'voice' or 'video'
let otherUserId = null;
let otherUserName = "";
let otherUserAvatar = "";
let isCaller = false;
let callTimer = null;
let callStartTime = null;
let callDuration = 0;
let currentCamera = 'user'; // 'user' or 'environment'
let isMuted = false;
let isVideoOff = false;
let isSpeakerOn = false;

// DOM Elements
const callContainer = document.getElementById('callContainer');
const incomingCallScreen = document.getElementById('incomingCallScreen');
const callEndedScreen = document.getElementById('callEndedScreen');
const loadingScreen = document.getElementById('loadingScreen');
const notification = document.getElementById('notification');

// Initialize the call page
window.initiateCall = async function(callData) {
  if (callData.initiator) {
    // We're making the call
    isCaller = true;
    currentCallId = callData.chatId;
    otherUserId = callData.otherUserId;
    callType = callData.type;
    
    // Show loading screen
    showLoading('Starting call...');
    
    // Get user info from URL or localStorage
    const params = new URLSearchParams(window.location.search);
    otherUserName = params.get('userName') || 'User';
    otherUserAvatar = params.get('userAvatar') || 'https://via.placeholder.com/150';
    
    await startCall();
  } else {
    // We're receiving a call
    setupIncomingCallListener();
  }
};

// Start a new call (as caller)
async function startCall() {
  try {
    await setupLocalMedia();
    await createPeerConnection();
    await createOffer();
    
    // Show call UI
    hideLoading();
    updateCallUI();
    startCallTimer();
    
    showNotification(`${callType === 'video' ? 'Video' : 'Voice'} call started`);
    
  } catch (error) {
    console.error('Error starting call:', error);
    showNotification('Failed to start call. Please try again.');
    endCall();
  }
}

// Setup local media (camera/microphone)
async function setupLocalMedia() {
  try {
    const constraints = {
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        autoGainControl: true
      },
      video: callType === 'video' ? {
        width: { ideal: 1280 },
        height: { ideal: 720 },
        facingMode: currentCamera
      } : false
    };
    
    localStream = await navigator.mediaDevices.getUserMedia(constraints);
    
    // Setup local video
    const localVideo = document.getElementById('localVideo');
    localVideo.srcObject = localStream;
    
    // Setup audio output
    const audioElements = document.querySelectorAll('audio, video');
    audioElements.forEach(el => {
      if (isSpeakerOn) {
        el.setAttribute('playsinline', 'false');
      } else {
        el.setAttribute('playsinline', 'true');
      }
    });
    
  } catch (error) {
    console.error('Error accessing media devices:', error);
    throw error;
  }
}

// Create peer connection
async function createPeerConnection() {
  peerConnection = new RTCPeerConnection(servers);
  
  // Add local tracks
  localStream.getTracks().forEach(track => {
    peerConnection.addTrack(track, localStream);
  });
  
  // Handle remote stream
  peerConnection.ontrack = (event) => {
    remoteStream = event.streams[0];
    const remoteVideo = document.getElementById('remoteVideo');
    remoteVideo.srcObject = remoteStream;
    
    // Show/hide video off overlay
    const videoOff = document.getElementById('remoteVideoOff');
    videoOff.classList.add('hidden');
  };
  
  // Handle ICE candidates
  peerConnection.onicecandidate = async (event) => {
    if (event.candidate) {
      await addDoc(collection(db, 'calls', currentCallId, 'offerCandidates'), {
        candidate: event.candidate.toJSON(),
        timestamp: new Date()
      });
    }
  };
  
  // Handle connection state
  peerConnection.onconnectionstatechange = () => {
    updateConnectionQuality();
  };
  
  // Handle ICE connection state
  peerConnection.oniceconnectionstatechange = () => {
    updateConnectionQuality();
  };
}

// Create and send offer
async function createOffer() {
  const offer = await peerConnection.createOffer();
  await peerConnection.setLocalDescription(offer);
  
  // Save call data to Firestore
  const callDoc = {
    offer: offer,
    callerId: currentUser.uid,
    callerName: currentUser.displayName || 'User',
    callerAvatar: currentUser.photoURL || 'https://via.placeholder.com/150',
    calleeId: otherUserId,
    callType: callType,
    status: 'ringing',
    createdAt: new Date()
  };
  
  await setDoc(doc(db, 'calls', currentCallId), callDoc);
  
  // Listen for answer
  onSnapshot(doc(db, 'calls', currentCallId), async (snapshot) => {
    const data = snapshot.data();
    if (!data) return;
    
    if (data.answer && !peerConnection.currentRemoteDescription) {
      const answerDescription = new RTCSessionDescription(data.answer);
      await peerConnection.setRemoteDescription(answerDescription);
      updateCallStatus('connected');
    }
    
    if (data.status === 'ended') {
      endCall();
    }
  });
  
  // Listen for answer ICE candidates
  onSnapshot(collection(db, 'calls', currentCallId, 'answerCandidates'), (snapshot) => {
    snapshot.docChanges().forEach(async (change) => {
      if (change.type === 'added') {
        const candidate = new RTCIceCandidate(change.doc.data().candidate);
        await peerConnection.addIceCandidate(candidate);
      }
    });
  });
}

// Setup listener for incoming calls
function setupIncomingCallListener() {
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      
      // Listen for incoming calls where current user is the callee
      const q = collection(db, 'calls');
      onSnapshot(q, (snapshot) => {
        snapshot.docChanges().forEach(async (change) => {
          if (change.type === 'added') {
            const callData = change.doc.data();
            currentCallId = change.doc.id;
            
            if (callData.calleeId === currentUser.uid && callData.status === 'ringing') {
              // Show incoming call screen
              showIncomingCall(callData);
            }
          }
        });
      });
    }
  });
}

// Show incoming call screen
function showIncomingCall(callData) {
  isCaller = false;
  callType = callData.callType;
  otherUserId = callData.callerId;
  otherUserName = callData.callerName;
  otherUserAvatar = callData.callerAvatar;
  
  // Update UI
  document.getElementById('callerAvatar').src = otherUserAvatar;
  document.getElementById('callerName').textContent = otherUserName;
  document.getElementById('incomingCallType').textContent = 
    callType === 'video' ? 'Video Call' : 'Voice Call';
  
  incomingCallScreen.classList.remove('hidden');
  
  // Auto-decline after 45 seconds if not answered
  setTimeout(() => {
    if (incomingCallScreen.classList.contains('hidden')) return;
    declineIncomingCall();
  }, 45000);
}

// Accept incoming call
window.acceptIncomingCall = async function() {
  try {
    incomingCallScreen.classList.add('hidden');
    showLoading('Connecting...');
    
    await setupLocalMedia();
    await createPeerConnection();
    await answerCall();
    
    hideLoading();
    updateCallUI();
    startCallTimer();
    
    showNotification('Call connected');
    
  } catch (error) {
    console.error('Error accepting call:', error);
    showNotification('Failed to connect call');
    endCall();
  }
};

// Answer incoming call
async function answerCall() {
  const callDoc = await getDoc(doc(db, 'calls', currentCallId));
  const callData = callDoc.data();
  
  if (!callData) {
    throw new Error('Call not found');
  }
  
  const offerDescription = new RTCSessionDescription(callData.offer);
  await peerConnection.setRemoteDescription(offerDescription);
  
  const answer = await peerConnection.createAnswer();
  await peerConnection.setLocalDescription(answer);
  
  // Update call with answer
  await updateDoc(doc(db, 'calls', currentCallId), {
    answer: answer,
    status: 'ongoing'
  });
  
  // Listen for offer ICE candidates
  onSnapshot(collection(db, 'calls', currentCallId, 'offerCandidates'), (snapshot) => {
    snapshot.docChanges().forEach(async (change) => {
      if (change.type === 'added') {
        const candidate = new RTCIceCandidate(change.doc.data().candidate);
        await peerConnection.addIceCandidate(candidate);
      }
    });
  });
}

// Decline incoming call
window.declineIncomingCall = async function() {
  await updateDoc(doc(db, 'calls', currentCallId), {
    status: 'ended',
    endedBy: currentUser.uid,
    endedAt: new Date()
  });
  
  incomingCallScreen.classList.add('hidden');
  showCallEndedScreen('Call declined');
};

// End call
window.endCall = async function() {
  if (currentCallId) {
    await updateDoc(doc(db, 'calls', currentCallId), {
      status: 'ended',
      endedBy: currentUser.uid,
      endedAt: new Date(),
      duration: callDuration
    });
  }
  
  cleanupCall();
  showCallEndedScreen('Call ended');
};

// Cleanup call resources
function cleanupCall() {
  if (callTimer) {
    clearInterval(callTimer);
    callTimer = null;
  }
  
  if (localStream) {
    localStream.getTracks().forEach(track => track.stop());
    localStream = null;
  }
  
  if (peerConnection) {
    peerConnection.close();
    peerConnection = null;
  }
  
  callContainer.classList.add('hidden');
}

// Update call UI
function updateCallUI() {
  // Update user info
  document.getElementById('userName').textContent = otherUserName;
  document.getElementById('userAvatar').src = otherUserAvatar;
  document.getElementById('audioUserName').textContent = otherUserName;
  document.getElementById('audioUserAvatar').src = otherUserAvatar;
  document.getElementById('remoteUserName').textContent = otherUserName;
  
  // Show appropriate view
  if (callType === 'video') {
    document.getElementById('videoContainer').classList.remove('hidden');
    document.getElementById('audioOnlyView').classList.add('hidden');
    document.getElementById('audioCallType').textContent = 'Video call';
  } else {
    document.getElementById('videoContainer').classList.add('hidden');
    document.getElementById('audioOnlyView').classList.remove('hidden');
    document.getElementById('audioCallType').textContent = 'Voice call';
  }
  
  callContainer.classList.remove('hidden');
  updateCallStatus('connected');
}

// Update call status
function updateCallStatus(status) {
  const statusText = document.getElementById('statusText');
  const callStatus = document.getElementById('callStatus');
  
  callStatus.classList.remove('ringing', 'connected');
  
  switch (status) {
    case 'ringing':
      statusText.textContent = 'Ringing...';
      callStatus.classList.add('ringing');
      break;
    case 'connecting':
      statusText.textContent = 'Connecting...';
      break;
    case 'connected':
      statusText.textContent = 'Connected';
      callStatus.classList.add('connected');
      break;
    case 'reconnecting':
      statusText.textContent = 'Reconnecting...';
      break;
  }
}

// Start call timer
function startCallTimer() {
  callStartTime = new Date();
  callTimer = setInterval(() => {
    const now = new Date();
    callDuration = Math.floor((now - callStartTime) / 1000);
    
    const minutes = Math.floor(callDuration / 60);
    const seconds = callDuration % 60;
    
    document.getElementById('callTimer').textContent = 
      `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }, 1000);
}

// Update connection quality
function updateConnectionQuality() {
  if (!peerConnection) return;
  
  const connectionDots = document.querySelectorAll('.connection-dot');
  const qualityText = document.getElementById('qualityText');
  
  let quality = 'good';
  
  if (peerConnection.iceConnectionState === 'connected' || 
      peerConnection.iceConnectionState === 'completed') {
    quality = 'good';
  } else if (peerConnection.iceConnectionState === 'checking' ||
             peerConnection.iceConnectionState === 'connected') {
    quality = 'fair';
  } else {
    quality = 'poor';
  }
  
  // Update dots
  connectionDots.forEach((dot, index) => {
    dot.classList.remove('good', 'fair', 'poor');
    if (quality === 'good' && index < 3) {
      dot.classList.add('good');
    } else if (quality === 'fair' && index < 2) {
      dot.classList.add('fair');
    } else if (quality === 'poor' && index < 1) {
      dot.classList.add('poor');
    }
  });
  
  qualityText.textContent = quality.charAt(0).toUpperCase() + quality.slice(1);
}

// Toggle mute
document.getElementById('muteBtn').addEventListener('click', () => {
  if (!localStream) return;
  
  const audioTrack = localStream.getAudioTracks()[0];
  if (audioTrack) {
    audioTrack.enabled = !audioTrack.enabled;
    isMuted = !audioTrack.enabled;
    
    const muteBtn = document.getElementById('muteBtn');
    muteBtn.classList.toggle('active', isMuted);
    muteBtn.innerHTML = `<i class="fas ${isMuted ? 'fa-microphone-slash' : 'fa-microphone'}"></i>
                        <span class="control-label">${isMuted ? 'Unmute' : 'Mute'}</span>`;
    
    showNotification(isMuted ? 'Microphone muted' : 'Microphone on');
  }
});

// Toggle video
document.getElementById('videoToggleBtn').addEventListener('click', () => {
  if (!localStream) return;
  
  const videoTrack = localStream.getVideoTracks()[0];
  if (videoTrack) {
    videoTrack.enabled = !videoTrack.enabled;
    isVideoOff = !videoTrack.enabled;
    
    const videoBtn = document.getElementById('videoToggleBtn');
    videoBtn.classList.toggle('active', isVideoOff);
    videoBtn.innerHTML = `<i class="fas ${isVideoOff ? 'fa-video-slash' : 'fa-video'}"></i>
                         <span class="control-label">${isVideoOff ? 'Video on' : 'Video off'}</span>`;
    
    // Show/hide local video overlay
    document.getElementById('localVideoOff').classList.toggle('hidden', !isVideoOff);
    
    showNotification(isVideoOff ? 'Video turned off' : 'Video turned on');
  }
});

// Toggle speaker
document.getElementById('speakerBtn').addEventListener('click', () => {
  isSpeakerOn = !isSpeakerOn;
  
  const speakerBtn = document.getElementById('speakerBtn');
  speakerBtn.classList.toggle('active', isSpeakerOn);
  speakerBtn.innerHTML = `<i class="fas ${isSpeakerOn ? 'fa-volume-up' : 'fa-volume-down'}"></i>
                         <span class="control-label">${isSpeakerOn ? 'Speaker' : 'Earpiece'}</span>`;
  
  // Update audio output
  const audioElements = document.querySelectorAll('audio, video');
  audioElements.forEach(el => {
    if (isSpeakerOn) {
      el.removeAttribute('playsinline');
    } else {
      el.setAttribute('playsinline', 'true');
    }
  });
  
  showNotification(isSpeakerOn ? 'Speaker mode on' : 'Earpiece mode on');
});

// Flip camera
document.getElementById('flipCameraBtn').addEventListener('click', async () => {
  if (!localStream) return;
  
  currentCamera = currentCamera === 'user' ? 'environment' : 'user';
  
  try {
    // Stop current video track
    const videoTrack = localStream.getVideoTracks()[0];
    if (videoTrack) videoTrack.stop();
    
    // Get new camera
    const newStream = await navigator.mediaDevices.getUserMedia({
      video: {
        width: { ideal: 1280 },
        height: { ideal: 720 },
        facingMode: currentCamera
      },
      audio: false
    });
    
    // Replace video track
    const newVideoTrack = newStream.getVideoTracks()[0];
    const sender = peerConnection.getSenders().find(s => 
      s.track && s.track.kind === 'video'
    );
    
    if (sender) {
      sender.replaceTrack(newVideoTrack);
    }
    
    // Update local stream
    localStream.removeTrack(videoTrack);
    localStream.addTrack(newVideoTrack);
    
    // Update local video
    document.getElementById('localVideo').srcObject = localStream;
    
    showNotification('Camera switched');
    
  } catch (error) {
    console.error('Error flipping camera:', error);
    showNotification('Failed to switch camera');
  }
});

// End call button
document.getElementById('endCallBtn').addEventListener('click', endCall);

// Close call button
document.getElementById('closeCallBtn').addEventListener('click', endCall);

// Show call ended screen
function showCallEndedScreen(message) {
  callEndedScreen.classList.remove('hidden');
  
  document.getElementById('callEndedTitle').textContent = message;
  document.getElementById('callEndedMessage').textContent = 
    `Call with ${otherUserName} has ended.`;
  
  const minutes = Math.floor(callDuration / 60);
  const seconds = callDuration % 60;
  document.getElementById('callDuration').textContent = 
    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Go back to chat
window.goBackToChat = function() {
  window.location.href = 'chat.html';
};

// Show loading screen
function showLoading(message) {
  loadingScreen.classList.remove('hidden');
  document.getElementById('loadingText').textContent = message;
}

// Hide loading screen
function hideLoading() {
  loadingScreen.classList.add('hidden');
}

// Show notification
function showNotification(message, duration = 3000) {
  notification.classList.remove('hidden');
  document.getElementById('notificationText').textContent = message;
  
  setTimeout(() => {
    notification.classList.add('hidden');
  }, duration);
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    endCall();
  } else if (e.key === 'm' || e.key === 'M') {
    document.getElementById('muteBtn').click();
  } else if (e.key === 'v' || e.key === 'V') {
    document.getElementById('videoToggleBtn').click();
  }
});

// Initialize when page loads
window.addEventListener('DOMContentLoaded', () => {
  // Check if we're initiating or receiving a call
  const params = new URLSearchParams(window.location.search);
  const action = params.get('action');
  
  if (action === 'initiate') {
    const callData = {
      initiator: true,
      chatId: params.get('chatId'),
      otherUserId: params.get('userId'),
      type: params.get('type') || 'video'
    };
    window.initiateCall(callData);
  } else {
    window.initiateCall({ initiator: false });
  }
});

// Handle page visibility changes
document.addEventListener('visibilitychange', () => {
  if (document.hidden && peerConnection) {
    showNotification('You minimized the call. Call is still active.');
  }
});

// Handle beforeunload
window.addEventListener('beforeunload', () => {
  if (peerConnection) {
    endCall();
  }
});
</script>
</body>
            </html>
