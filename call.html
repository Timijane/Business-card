<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WhatsApp Call Clone</title>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

<style>
  body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #0b0f19; color: #fff; display: flex; flex-direction: column; height: 100vh; }
  .hidden { display: none !important; }
  
  /* LOGIN SCREEN */
  #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
  input { padding: 15px; border-radius: 8px; border: 1px solid #333; background: #1f2a48; color: white; width: 250px; margin-bottom: 10px; font-size: 16px; }
  
  /* CALL UI */
  #call-screen { position: relative; flex: 1; display: flex; flex-direction: column; }
  #video-container { position: relative; flex: 1; background: #000; display: flex; justify-content: center; align-items: center; }
  video { object-fit: cover; }
  #remoteVideo { width: 100%; height: 100%; }
  #localVideo { position: absolute; bottom: 20px; right: 20px; width: 120px; height: 160px; border-radius: 10px; border: 2px solid #fff; background: #333; z-index: 10; }
  
  /* CONTROLS */
  #controls { padding: 20px; background: #11162a; display: flex; justify-content: center; gap: 20px; }
  .btn { width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
  .btn-green { background: #25D366; color: white; }
  .btn-red { background: #FF3B30; color: white; }
  .btn-gray { background: #3a3a3a; color: white; }

  /* INCOMING CALL POPUP */
  #incoming-call { position: absolute; top: 40px; left: 50%; transform: translateX(-50%); background: #1f2a48; padding: 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 100; text-align: center; width: 80%; max-width: 300px; }
  #status-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; color: #aaa; }
</style>
</head>
<body>

<div id="login-screen">
  <h2>WhatsApp Call Clone</h2>
  <input type="text" id="username-input" placeholder="Create your User ID (e.g. user1)">
  <button class="btn btn-green" style="width: 200px; border-radius: 8px;" onclick="login()">Login</button>
</div>

<div id="dashboard" class="hidden" style="text-align:center; padding-top: 50px;">
  <h2 id="welcome-msg"></h2>
  <div style="margin-top: 50px;">
    <input type="text" id="callee-input" placeholder="Enter ID to Call (e.g. user2)">
    <br>
    <button class="btn btn-green" style="width: 60px; display:inline-flex" onclick="startCall()">üìû</button>
  </div>
  <p style="color: #666; margin-top: 20px;">Waiting for incoming calls...</p>
</div>

<div id="incoming-call" class="hidden">
  <h3 id="caller-name">Unknown</h3>
  <p>Incoming Video Call...</p>
  <div style="display: flex; justify-content: center; gap: 20px; margin-top: 15px;">
    <button class="btn btn-green" onclick="answerCall()">üìû</button>
    <button class="btn btn-red" onclick="rejectCall()">‚ùå</button>
  </div>
</div>

<div id="call-screen" class="hidden">
  <div id="video-container">
    <div id="status-text">Connecting...</div>
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay muted playsinline></video>
  </div>
  <div id="controls">
    <button class="btn btn-gray" onclick="toggleMic()">üé§</button>
    <button class="btn btn-gray" onclick="toggleCam()">üì∑</button>
    <button class="btn btn-red" onclick="endCall()">‚ùå</button>
  </div>
</div>

<script>
// ================= CONFIGURATION =================
const firebaseConfig = {
  apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
  authDomain: "meet-6e159.firebaseapp.com",
  databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",
  projectId: "meet-6e159",
  storageBucket: "meet-6e159.firebasestorage.app",
  messagingSenderId: "252353608421",
  appId: "1:252353608421:web:6706056048e9a8f12db20c",
  measurementId: "G-9BFPPVMMRF"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Using Public STUN servers
const rtcConfig = {
  iceServers: [
    { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }
  ]
};

// ================= STATE =================
let pc = null;
let localStream = null;
let remoteStream = null;
let currentCallDocId = null;
let myUserId = null;
let unsubscribeCallListener = null;

// ================= 1. LOGIN & LISTEN =================
function login() {
  const input = document.getElementById('username-input').value.trim();
  if (!input) return alert("Please enter a username");
  
  myUserId = input;
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  document.getElementById('welcome-msg').innerText = `Logged in as: ${myUserId}`;

  // START LISTENING FOR CALLS IMMEDIATELY
  listenForIncomingCalls();
}

function listenForIncomingCalls() {
  // Query Firestore: "Find documents in 'calls' where calleeId matches My ID"
  db.collection('calls')
    .where('calleeId', '==', myUserId)
    .onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') {
          const data = change.doc.data();
          // Only react if the call is in 'offering' stage (ringing)
          if (data.type === 'offer' && !currentCallDocId) {
            currentCallDocId = change.doc.id;
            showIncomingCall(data.callerId);
          }
        }
      });
    });
}

function showIncomingCall(callerId) {
  document.getElementById('caller-name').innerText = callerId;
  document.getElementById('incoming-call').classList.remove('hidden');
}

// ================= 2. MAKE A CALL (Caller) =================
async function startCall() {
  const calleeId = document.getElementById('callee-input').value.trim();
  if (!calleeId) return alert("Enter a user ID to call");

  document.getElementById('dashboard').classList.add('hidden');
  document.getElementById('call-screen').classList.remove('hidden');
  
  await setupMedia();
  
  // Create a new Call Document
  const callDoc = db.collection('calls').doc();
  currentCallDocId = callDoc.id;
  const offerCandidates = callDoc.collection('offerCandidates');
  const answerCandidates = callDoc.collection('answerCandidates');

  pc = new RTCPeerConnection(rtcConfig);

  // Push local tracks
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  // Handle ICE Candidates
  pc.onicecandidate = event => {
    event.candidate && offerCandidates.add(event.candidate.toJSON());
  };

  // Handle Remote Stream
  pc.ontrack = event => {
    document.getElementById('status-text').innerText = "";
    document.getElementById('remoteVideo').srcObject = event.streams[0];
  };

  // Create Offer
  const offerDescription = await pc.createOffer();
  await pc.setLocalDescription(offerDescription);

  const offer = {
    sdp: offerDescription.sdp,
    type: offerDescription.type,
  };

  // Write to Firestore
  await callDoc.set({
    callerId: myUserId,
    calleeId: calleeId,
    type: 'offer',
    offer: offer
  });

  // Listen for Answer
  callDoc.onSnapshot((snapshot) => {
    const data = snapshot.data();
    if (!pc.currentRemoteDescription && data?.answer) {
      const answerDescription = new RTCSessionDescription(data.answer);
      pc.setRemoteDescription(answerDescription);
    }
    // If call ended remotely
    if(data?.status === 'ended') endCall(false); 
  });

  // Listen for Remote ICE Candidates
  answerCandidates.onSnapshot(snapshot => {
    snapshot.docChanges().forEach(change => {
      if (change.type === 'added') {
        const candidate = new RTCIceCandidate(change.doc.data());
        pc.addIceCandidate(candidate);
      }
    });
  });
}

// ================= 3. ANSWER CALL (Callee) =================
async function answerCall() {
  document.getElementById('incoming-call').classList.add('hidden');
  document.getElementById('dashboard').classList.add('hidden');
  document.getElementById('call-screen').classList.remove('hidden');

  await setupMedia();

  const callDoc = db.collection('calls').doc(currentCallDocId);
  const offerCandidates = callDoc.collection('offerCandidates');
  const answerCandidates = callDoc.collection('answerCandidates');

  pc = new RTCPeerConnection(rtcConfig);

  // Push local tracks
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  // Handle ICE Candidates
  pc.onicecandidate = event => {
    event.candidate && answerCandidates.add(event.candidate.toJSON());
  };

  // Handle Remote Stream
  pc.ontrack = event => {
    document.getElementById('status-text').innerText = "";
    document.getElementById('remoteVideo').srcObject = event.streams[0];
  };

  // Fetch Offer Data
  const callData = (await callDoc.get()).data();
  const offerDescription = callData.offer;

  await pc.setRemoteDescription(new RTCSessionDescription(offerDescription));

  // Create Answer
  const answerDescription = await pc.createAnswer();
  await pc.setLocalDescription(answerDescription);

  const answer = {
    type: answerDescription.type,
    sdp: answerDescription.sdp,
  };

  await callDoc.update({ answer });

  // Listen for Remote ICE Candidates
  offerCandidates.onSnapshot(snapshot => {
    snapshot.docChanges().forEach(change => {
      if (change.type === 'added') {
        const candidate = new RTCIceCandidate(change.doc.data());
        pc.addIceCandidate(candidate);
      }
    });
  });
  
  // Listener for end
  callDoc.onSnapshot(snap => {
      if(snap.data()?.status === 'ended') endCall(false);
  })
}

// ================= HELPERS =================

async function setupMedia() {
  localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  document.getElementById('localVideo').srcObject = localStream;
}

async function endCall(notifyRemote = true) {
  // Cleanup media
  if (localStream) {
    localStream.getTracks().forEach(track => track.stop());
  }
  if (pc) {
    pc.close();
  }
  
  // Notify Firestore (so the other person disconnects)
  if (currentCallDocId && notifyRemote) {
      await db.collection('calls').doc(currentCallDocId).update({ status: 'ended' });
  }

  // Reset UI
  document.getElementById('call-screen').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  document.getElementById('incoming-call').classList.add('hidden');
  document.getElementById('remoteVideo').srcObject = null;
  currentCallDocId = null;
  
  // Reload window to ensure clean slate (simple approach)
  setTimeout(() => window.location.reload(), 1000); 
}

function rejectCall() {
  document.getElementById('incoming-call').classList.add('hidden');
  // Optional: Update doc to say "rejected"
  currentCallDocId = null;
}

function toggleMic() {
  const audioTrack = localStream.getAudioTracks()[0];
  audioTrack.enabled = !audioTrack.enabled;
}

function toggleCam() {
  const videoTrack = localStream.getVideoTracks()[0];
  videoTrack.enabled = !videoTrack.enabled;
}
</script>
</body>
</html>
