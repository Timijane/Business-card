<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WhatsApp Clone - Secure Call</title>
<style>
    body { margin: 0; font-family: sans-serif; background: #0b141a; color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    .hidden { display: none !important; }
    
    /* Simplified Chat Interface for Demo */
    #chat-header { background: #202c33; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; }
    .call-btns { display: flex; gap: 20px; }
    .icon-btn { cursor: pointer; font-size: 20px; background: none; border: none; color: #aebac1; }

    /* Call Overlay */
    #call-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; display: flex; flex-direction: column; }
    #video-grid { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; }
    #remoteVideo { width: 100%; height: 100%; object-fit: cover; }
    #localVideo { position: absolute; bottom: 100px; right: 20px; width: 120px; height: 180px; border-radius: 10px; border: 2px solid #fff; background: #2a2f32; object-fit: cover; }
    
    /* Call Controls */
    #call-controls { height: 80px; background: #202c33; display: flex; justify-content: center; align-items: center; gap: 30px; border-radius: 20px 20px 0 0; }
    .control-btn { width: 50px; height: 50px; border-radius: 50%; border: none; color: white; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; }
    .end-btn { background: #ea0038; }
    .mute-btn { background: #3b4a54; }

    /* Incoming Call Popup */
    #incoming-overlay { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 350px; background: #233138; padding: 20px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 2000; border: 1px solid #00a884; }
    .incoming-btns { display: flex; justify-content: space-around; margin-top: 15px; }
    .accept { background: #00a884; color: white; padding: 10px 20px; border-radius: 20px; border: none; }
    .decline { background: #ea0038; color: white; padding: 10px 20px; border-radius: 20px; border: none; }
</style>
</head>
<body>

<div id="chat-header">
    <div id="chat-info">
        <strong id="active-chat-name">Select a Chat</strong>
        <p id="active-chat-status" style="font-size: 12px; color: #00a884; margin: 0;"></p>
    </div>
    <div class="call-btns">
        <button class="icon-btn" onclick="initiateCall('voice')">üìû</button>
        <button class="icon-btn" onclick="initiateCall('video')">üìπ</button>
    </div>
</div>

<div id="incoming-overlay" class="hidden">
    <div style="text-align: center;">
        <h3 id="incoming-caller-name">Incoming Call...</h3>
        <p id="incoming-call-type">Video Call</p>
    </div>
    <div class="incoming-btns">
        <button class="accept" onclick="acceptIncomingCall()">Accept</button>
        <button class="decline" onclick="declineIncomingCall()">Decline</button>
    </div>
</div>

<div id="call-screen" class="hidden">
    <div id="video-grid">
        <video id="remoteVideo" autoplay playsinline></video>
        <video id="localVideo" autoplay muted playsinline></video>
    </div>
    <div id="call-controls">
        <button class="control-btn mute-btn" onclick="toggleMute()">üé§</button>
        <button class="control-btn end-btn" onclick="hangUp()">‚ùå</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, addDoc, getDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
        authDomain: "meet-6e159.firebaseapp.com",
        projectId: "meet-6e159",
        storageBucket: "meet-6e159.firebasestorage.app",
        messagingSenderId: "252353608421",
        appId: "1:252353608421:web:6706056048e9a8f12db20c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const servers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };

    let pc = null;
    let localStream = null;
    let currentChatId = null;
    let recipientId = null;
    let myUid = null;

    // --- 1. SESSION MANAGEMENT ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            myUid = user.uid;
            console.log("Authenticated as:", myUid);
            startGlobalCallListener();
            
            // DEMO: Manually triggering a chat context
            // In your real app, call this when a user clicks a chat list item
            setupChatContext("demo_chat_123", "RECIPIENT_USER_ID_HERE", "John Doe");
        }
    });

    window.setupChatContext = function(chatId, otherUserId, otherUserName) {
        currentChatId = chatId;
        recipientId = otherUserId;
        document.getElementById('active-chat-name').innerText = otherUserName;
        document.getElementById('active-chat-status').innerText = "online";
    };

    // --- 2. THE LISTENER (WhatsApp Style - Background) ---
    function startGlobalCallListener() {
        const q = query(collection(db, 'calls'), where('calleeId', '==', myUid), where('status', '==', 'ringing'));
        onSnapshot(q, (snapshot) => {
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added') {
                    const data = change.doc.data();
                    currentChatId = change.doc.id; // Use the document ID (chatId)
                    showIncomingUI(data.callerName, data.callType);
                }
            });
        });
    }

    function showIncomingUI(name, type) {
        document.getElementById('incoming-caller-name').innerText = name;
        document.getElementById('incoming-call-type').innerText = type === 'video' ? 'Video Call' : 'Voice Call';
        document.getElementById('incoming-overlay').classList.remove('hidden');
    }

    // --- 3. INITIATE CALL (User A clicks button) ---
    window.initiateCall = async function(type) {
        if (!recipientId) return alert("Select a contact first");

        await startMedia();
        document.getElementById('call-screen').classList.remove('hidden');

        const callDoc = doc(db, 'calls', currentChatId);
        pc = new RTCPeerConnection(servers);
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        pc.onicecandidate = e => e.candidate && addDoc(collection(callDoc, 'offerCandidates'), e.candidate.toJSON());
        pc.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];

        const offerDescription = await pc.createOffer();
        await pc.setLocalDescription(offerDescription);

        await setDoc(callDoc, {
            callerId: myUid,
            callerName: auth.currentUser.displayName || "Someone",
            calleeId: recipientId,
            status: 'ringing',
            callType: type,
            offer: { type: offerDescription.type, sdp: offerDescription.sdp }
        });

        // Listen for remote answer
        onSnapshot(callDoc, (snapshot) => {
            const data = snapshot.data();
            if (data?.answer && !pc.currentRemoteDescription) {
                pc.setRemoteDescription(new RTCSessionDescription(data.answer));
            }
            if (data?.status === 'ended') cleanupCall();
        });

        // Listen for remote ICE
        onSnapshot(collection(callDoc, 'answerCandidates'), (snap) => {
            snap.docChanges().forEach(change => {
                if (change.type === 'added') pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
            });
        });
    };

    // --- 4. ACCEPT CALL (User B clicks Accept) ---
    window.acceptIncomingCall = async function() {
        document.getElementById('incoming-overlay').classList.add('hidden');
        document.getElementById('call-screen').classList.remove('hidden');

        await startMedia();
        const callDoc = doc(db, 'calls', currentChatId);
        pc = new RTCPeerConnection(servers);
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        pc.onicecandidate = e => e.candidate && addDoc(collection(callDoc, 'answerCandidates'), e.candidate.toJSON());
        pc.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];

        const callData = (await getDoc(callDoc)).data();
        await pc.setRemoteDescription(new RTCSessionDescription(callData.offer));

        const answerDescription = await pc.createAnswer();
        await pc.setLocalDescription(answerDescription);

        await updateDoc(callDoc, { 
            answer: { type: answerDescription.type, sdp: answerDescription.sdp },
            status: 'ongoing' 
        });

        onSnapshot(collection(callDoc, 'offerCandidates'), (snap) => {
            snap.docChanges().forEach(change => {
                if (change.type === 'added') pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
            });
        });

        onSnapshot(callDoc, (snap) => snap.data()?.status === 'ended' && cleanupCall());
    };

    // --- UTILITIES ---
    async function startMedia() {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = localStream;
    }

    window.hangUp = async function() {
        if (currentChatId) {
            await updateDoc(doc(db, 'calls', currentChatId), { status: 'ended' });
        }
        cleanupCall();
    };

    function cleanupCall() {
        if (localStream) localStream.getTracks().forEach(t => t.stop());
        if (pc) pc.close();
        pc = null;
        document.getElementById('call-screen').classList.add('hidden');
        document.getElementById('incoming-overlay').classList.add('hidden');
        window.location.reload(); 
    }

    window.declineIncomingCall = async function() {
        await updateDoc(doc(db, 'calls', currentChatId), { status: 'ended' });
        document.getElementById('incoming-overlay').classList.add('hidden');
    };

    window.toggleMute = () => {
        const enabled = localStream.getAudioTracks()[0].enabled;
        localStream.getAudioTracks()[0].enabled = !enabled;
    };
</script>
</body>
</html>
