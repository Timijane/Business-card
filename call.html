<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WhatsApp Call Clone</title>

<style>
  body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #0b0f19; color: #fff; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
  .hidden { display: none !important; }
  
  /* LOGIN SCREEN */
  #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
  input { padding: 15px; border-radius: 8px; border: 1px solid #333; background: #1f2a48; color: white; width: 250px; margin-bottom: 10px; font-size: 16px; outline: none; }
  
  /* CALL UI */
  #call-screen { position: relative; flex: 1; display: flex; flex-direction: column; background: #000; }
  #video-container { position: relative; flex: 1; display: flex; justify-content: center; align-items: center; }
  video { object-fit: cover; }
  #remoteVideo { width: 100%; height: 100%; background: #111; }
  #localVideo { position: absolute; bottom: 20px; right: 20px; width: 120px; height: 160px; border-radius: 10px; border: 2px solid #fff; background: #333; z-index: 10; }
  
  /* CONTROLS */
  #controls { padding: 20px; background: #11162a; display: flex; justify-content: center; gap: 20px; }
  .btn { width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: 0.3s; }
  .btn:active { transform: scale(0.9); }
  .btn-green { background: #25D366; color: white; }
  .btn-red { background: #FF3B30; color: white; }
  .btn-gray { background: #3a3a3a; color: white; }

  /* INCOMING CALL POPUP */
  #incoming-call { position: absolute; top: 40px; left: 50%; transform: translateX(-50%); background: #1f2a48; padding: 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 100; text-align: center; width: 80%; max-width: 300px; border: 1px solid #25D366; }
  #status-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 18px; color: #aaa; z-index: 5; }
</style>
</head>
<body>

<div id="login-screen">
  <h2>WhatsApp Call Clone</h2>
  <input type="text" id="username-input" placeholder="Create your User ID (e.g. user1)">
  <button class="btn btn-green" style="width: 200px; border-radius: 8px;" onclick="login()">Login</button>
</div>

<div id="dashboard" class="hidden" style="text-align:center; padding-top: 50px;">
  <h2 id="welcome-msg"></h2>
  <div style="margin-top: 50px;">
    <input type="text" id="callee-input" placeholder="Enter ID to Call (e.g. user2)">
    <br>
    <button class="btn btn-green" style="width: 60px; display:inline-flex; margin-top: 10px;" onclick="startCall()">üìû</button>
  </div>
  <p style="color: #666; margin-top: 20px;">Waiting for incoming calls...</p>
</div>

<div id="incoming-call" class="hidden">
  <h3 id="caller-name">Unknown</h3>
  <p>Incoming Video Call...</p>
  <div style="display: flex; justify-content: center; gap: 20px; margin-top: 15px;">
    <button class="btn btn-green" onclick="answerCall()">üìû</button>
    <button class="btn btn-red" onclick="rejectCall()">‚ùå</button>
  </div>
</div>

<div id="call-screen" class="hidden">
  <div id="video-container">
    <div id="status-text">Connecting...</div>
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay muted playsinline></video>
  </div>
  <div id="controls">
    <button class="btn btn-gray" onclick="toggleMic()">üé§</button>
    <button class="btn btn-gray" onclick="toggleCam()">üì∑</button>
    <button class="btn btn-red" onclick="endCall()">‚ùå</button>
  </div>
</div>

<script type="module">
  // Import Firebase Modular SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { 
    getFirestore, doc, setDoc, addDoc, updateDoc, onSnapshot, 
    collection, query, where, getDoc 
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // --- CONFIGURATION ---
  const firebaseConfig = {
    apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
    authDomain: "meet-6e159.firebaseapp.com",
    databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",
    projectId: "meet-6e159",
    storageBucket: "meet-6e159.firebasestorage.app",
    messagingSenderId: "252353608421",
    appId: "1:252353608421:web:6706056048e9a8f12db20c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const rtcConfig = {
    iceServers: [
      { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }
    ]
  };

  // --- GLOBAL STATE ---
  let pc = null;
  let localStream = null;
  let currentCallDocId = null;
  let myUserId = null;

  // ================= 1. LOGIN =================
  window.login = function() {
    const input = document.getElementById('username-input').value.trim();
    if (!input) return alert("Please enter a username");
    
    myUserId = input;
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    document.getElementById('welcome-msg').innerText = `Logged in as: ${myUserId}`;

    listenForIncomingCalls();
  };

  function listenForIncomingCalls() {
    const q = query(collection(db, 'calls'), where('calleeId', '==', myUserId), where('type', '==', 'offer'));
    onSnapshot(q, (snapshot) => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') {
          const data = change.doc.data();
          if (!currentCallDocId && !data.status) {
            currentCallDocId = change.doc.id;
            showIncomingCall(data.callerId);
          }
        }
      });
    });
  }

  function showIncomingCall(callerId) {
    document.getElementById('caller-name').innerText = callerId;
    document.getElementById('incoming-call').classList.remove('hidden');
  }

  // ================= 2. START CALL (Caller) =================
  window.startCall = async function() {
    const calleeId = document.getElementById('callee-input').value.trim();
    if (!calleeId) return alert("Enter a user ID to call");
    if (calleeId === myUserId) return alert("You cannot call yourself");

    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('call-screen').classList.remove('hidden');
    
    await setupMedia();
    
    const callDocRef = doc(collection(db, 'calls'));
    currentCallDocId = callDocRef.id;

    pc = new RTCPeerConnection(rtcConfig);
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    pc.onicecandidate = event => {
      if (event.candidate) {
        addDoc(collection(callDocRef, 'offerCandidates'), event.candidate.toJSON());
      }
    };

    pc.ontrack = event => {
      document.getElementById('status-text').innerText = "";
      document.getElementById('remoteVideo').srcObject = event.streams[0];
    };

    const offerDescription = await pc.createOffer();
    await pc.setLocalDescription(offerDescription);

    await setDoc(callDocRef, {
      callerId: myUserId,
      calleeId: calleeId,
      type: 'offer',
      offer: { sdp: offerDescription.sdp, type: offerDescription.type }
    });

    onSnapshot(callDocRef, (snapshot) => {
      const data = snapshot.data();
      if (!pc.currentRemoteDescription && data?.answer) {
        pc.setRemoteDescription(new RTCSessionDescription(data.answer));
      }
      if (data?.status === 'ended') endCall(false);
    });

    onSnapshot(collection(callDocRef, 'answerCandidates'), snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') {
          pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
        }
      });
    });
  };

  // ================= 3. ANSWER CALL (Callee) =================
  window.answerCall = async function() {
    document.getElementById('incoming-call').classList.add('hidden');
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('call-screen').classList.remove('hidden');

    await setupMedia();

    const callDocRef = doc(db, 'calls', currentCallDocId);
    pc = new RTCPeerConnection(rtcConfig);

    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    pc.onicecandidate = event => {
      if (event.candidate) {
        addDoc(collection(callDocRef, 'answerCandidates'), event.candidate.toJSON());
      }
    };

    pc.ontrack = event => {
      document.getElementById('status-text').innerText = "";
      document.getElementById('remoteVideo').srcObject = event.streams[0];
    };

    const callData = (await getDoc(callDocRef)).data();
    await pc.setRemoteDescription(new RTCSessionDescription(callData.offer));

    const answerDescription = await pc.createAnswer();
    await pc.setLocalDescription(answerDescription);

    await updateDoc(callDocRef, { 
      answer: { type: answerDescription.type, sdp: answerDescription.sdp } 
    });

    onSnapshot(collection(callDocRef, 'offerCandidates'), snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') {
          pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
        }
      });
    });

    onSnapshot(callDocRef, snap => {
      if (snap.data()?.status === 'ended') endCall(false);
    });
  };

  // ================= HELPERS =================
  async function setupMedia() {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      document.getElementById('localVideo').srcObject = localStream;
    } catch (e) {
      console.error(e);
      alert("Camera access denied or not available. Check your HTTPS/Localhost settings.");
    }
  }

  window.endCall = async function(notifyRemote = true) {
    if (localStream) localStream.getTracks().forEach(track => track.stop());
    if (pc) pc.close();
    
    if (currentCallDocId && notifyRemote) {
      try {
        await updateDoc(doc(db, 'calls', currentCallDocId), { status: 'ended' });
      } catch (e) {}
    }

    // Reset UI
    document.getElementById('call-screen').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    document.getElementById('remoteVideo').srcObject = null;
    currentCallDocId = null;
    
    setTimeout(() => window.location.reload(), 500); 
  };

  window.rejectCall = () => {
    document.getElementById('incoming-call').classList.add('hidden');
    currentCallDocId = null;
  };

  window.toggleMic = () => {
    if(localStream) {
      const audioTrack = localStream.getAudioTracks()[0];
      audioTrack.enabled = !audioTrack.enabled;
    }
  };

  window.toggleCam = () => {
    if(localStream) {
      const videoTrack = localStream.getVideoTracks()[0];
      videoTrack.enabled = !videoTrack.enabled;
    }
  };
</script>
</body>
</html>
