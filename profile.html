<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MEET | Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #0080FF;
            --primary-dark: #0066CC;
            --error: #EF4444;
            --success: #10B981;
            --bg-color: #f0f2f5;
            --card-bg: #fff;
            --text-color: #111;
            --secondary-text: #65676b;
            --border-color: #dddfe2;
            --online: #10B981;
            --offline: #EF4444;
        }

        body.dark-mode {
            --bg-color: #18191a;
            --card-bg: #242526;
            --text-color: #e4e6eb;
            --secondary-text: #b0b3b8;
            --border-color: #3e4042;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            min-height: 100vh;
            font-size: 16px;
        }

        .app-container { display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar {
            position: fixed; left: 0; top: 0; height: 100vh; width: 280px;
            background: linear-gradient(180deg, #0080FF 0%, #00C6FF 100%);
            border-right: 1px solid var(--border-color);
            overflow-y: auto; z-index: 100; padding: 20px; color: white;
        }
        .sidebar-menu { list-style: none; margin-top: 20px; }
        .sidebar-menu li { margin-bottom: 8px; }
        .sidebar-menu a {
            display: flex; align-items: center; padding: 12px;
            text-decoration: none; color: white; border-radius: 8px;
            transition: background 0.3s; font-size: 18px;
        }
        .sidebar-menu a:hover { background: rgba(255, 255, 255, 0.2); }
        .sidebar-menu i { margin-right: 12px; font-size: 20px; }

        /* Main Content */
        .main-content {
            flex: 1; margin-left: 280px; padding: 20px;
            width: calc(100% - 280px);
        }

        .navbar {
            background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);
            padding: 15px 20px; border-radius: 12px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
            color: white;
        }

        .nav-controls { display: flex; gap: 10px; align-items: center; }

        .btn {
            background: rgba(255, 255, 255, 0.2); color: white; border: none;
            padding: 8px 16px; border-radius: 8px; cursor: pointer;
            font-weight: 600; display: flex; align-items: center; gap: 8px;
            font-size: 14px; transition: 0.3s;
        }
        .btn:hover { background: rgba(255, 255, 255, 0.3); }

        /* Profile Header */
        .profile-header {
            position: relative; margin-bottom: 20px; border-radius: 12px;
            overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .profile-background {
            height: 250px;
            background: linear-gradient(135deg, #8ec5fc 0%, #e0c3fc 100%);
            position: relative; display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        .profile-background img { width: 100%; height: 100%; object-fit: cover; }

        .change-bg-btn {
            position: absolute; bottom: 20px; right: 20px;
            background: rgba(0,0,0,0.6); color: white; border: none;
            padding: 8px 16px; border-radius: 20px; cursor: pointer;
            display: none; z-index: 10;
        }

        .profile-info {
            background: var(--card-bg); padding: 20px;
            display: flex; align-items: flex-start; gap: 20px;
            position: relative; flex-wrap: wrap;
        }

        .profile-picture-container {
            margin-top: -80px; position: relative;
            width: 160px; height: 160px; flex-shrink: 0;
        }

        .profile-picture {
            width: 100%; height: 100%; border-radius: 50%;
            border: 5px solid var(--card-bg); overflow: hidden;
            background: white; display: flex; align-items: center; justify-content: center;
            font-size: 60px; color: var(--primary); font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .profile-picture img { width: 100%; height: 100%; object-fit: cover; }

        .change-pic-btn {
            position: absolute; bottom: 10px; right: 10px;
            background: var(--primary); color: white; border: none;
            width: 36px; height: 36px; border-radius: 50%;
            cursor: pointer; display: none;
            align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .profile-details { flex: 1; min-width: 200px; padding-top: 10px; }

        .profile-name-row {
            display: flex; align-items: center; justify-content: space-between;
            flex-wrap: wrap; gap: 10px; margin-bottom: 10px;
        }
        .profile-name { font-size: 28px; font-weight: 700; }
        
        .profile-bio { color: var(--secondary-text); margin-bottom: 15px; font-size: 16px; line-height: 1.5; }

        .profile-stats { display: flex; gap: 30px; margin-bottom: 15px; }
        .stat { display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .stat-value { font-weight: 700; font-size: 18px; }
        .stat-label { font-size: 14px; color: var(--secondary-text); }

        .action-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .associate-btn {
            background: var(--primary); color: white; padding: 8px 24px;
            border-radius: 8px; border: none; font-weight: 600; cursor: pointer;
        }
        .associate-btn.following { background: var(--secondary-text); }

        /* Sections */
        .profile-section {
            background: var(--card-bg); border-radius: 12px;
            padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        .section-title { font-size: 18px; font-weight: 600; }
        .edit-section-btn {
            background: none; border: none; color: var(--primary);
            cursor: pointer; display: none; font-size: 16px;
        }

        .info-item { margin-bottom: 15px; }
        .info-label { font-size: 13px; color: var(--secondary-text); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .info-value { font-size: 16px; display: flex; align-items: center; gap: 8px; word-break: break-word; }
        .private-info { color: var(--secondary-text); font-style: italic; display: flex; align-items: center; gap: 5px; }

        .skill-tag {
            display: inline-block; background: rgba(0, 128, 255, 0.1);
            color: var(--primary); padding: 6px 14px; border-radius: 20px;
            margin-right: 8px; margin-bottom: 8px; font-size: 14px; font-weight: 500;
        }

        /* Post Grid */
        .post-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        .post-item {
            aspect-ratio: 1; background: var(--bg-color); border-radius: 8px;
            overflow: hidden; position: relative; cursor: pointer;
            border: 1px solid var(--border-color);
        }
        .post-item img, .post-item video { width: 100%; height: 100%; object-fit: cover; }
        .post-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.6); color: white; padding: 8px;
            font-size: 12px; transform: translateY(100%); transition: 0.3s;
        }
        .post-item:hover .post-overlay { transform: translateY(0); }

        /* Modal Styles */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            align-items: center; justify-content: center; padding: 20px;
        }
        .modal-content {
            background: var(--card-bg); border-radius: 12px;
            width: 800px; max-width: 100%; max-height: 90vh;
            overflow-y: auto; display: flex; flex-direction: column;
        }
        .modal-header {
            padding: 16px; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            background: var(--card-bg); position: sticky; top: 0; z-index: 10;
        }
        .modal-body { padding: 20px; }
        
        /* Form Styles */
        .form-section { margin-bottom: 25px; border-bottom: 1px dashed var(--border-color); padding-bottom: 15px; }
        .form-section h4 { color: var(--primary); margin-bottom: 15px; font-size: 18px; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-full { grid-column: 1 / -1; }
        
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; }
        .form-control {
            width: 100%; padding: 10px; border: 1px solid var(--border-color);
            border-radius: 8px; background: var(--bg-color); color: var(--text-color);
            font-family: inherit;
        }
        textarea.form-control { resize: vertical; min-height: 80px; }
        
        .skills-input-container { display: flex; gap: 10px; margin-bottom: 10px; }
        .add-skill-btn { background: var(--success); color: white; border: none; width: 40px; border-radius: 8px; cursor: pointer; }
        .active-skills-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .active-skill-item { background: var(--bg-color); border: 1px solid var(--border-color); padding: 5px 10px; border-radius: 15px; display: flex; align-items: center; gap: 5px; font-size: 14px; }
        .remove-skill { color: var(--error); cursor: pointer; }
        
        .file-upload-box { 
            border: 2px dashed var(--border-color); padding: 20px; text-align: center; 
            border-radius: 8px; cursor: pointer; background: var(--bg-color);
        }
        .file-upload-box:hover { border-color: var(--primary); }

        .close-modal { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-color); }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { width: 70px; padding: 10px 5px; }
            .sidebar-header, .sidebar-menu span, .navbar h2, .btn span, .user-profile-nav span { display: none; }
            .main-content { margin-left: 70px; width: calc(100% - 70px); padding: 10px; }
            .profile-info { flex-direction: column; text-align: center; }
            .profile-picture-container { margin: -60px auto 10px; }
            .profile-details { width: 100%; }
            .profile-name-row { justify-content: center; flex-direction: column; }
            .profile-stats { justify-content: center; }
            .action-buttons { justify-content: center; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="sidebar">
        <div class="sidebar-header"><h2>MEET</h2></div>
        <ul class="sidebar-menu">
            <li><a href="feed.html"><i class="fas fa-home"></i> <span>Feed</span></a></li>
            <li><a href="#" onclick="window.location.href='profile.html'"><i class="fas fa-user"></i> <span>Profile</span></a></li>
            <li><a href="chat.html"><i class="fas fa-comment"></i> <span>Chat</span></a></li>
            <li><a href="organization.html"><i class="fas fa-sitemap"></i> <span>Organization</span></a></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="navbar">
            <h2>Profile</h2>
            <div class="nav-controls">
                <button class="btn" id="editProfileBtn" style="display:none;" onclick="openSettings()"><i class="fas fa-edit"></i> <span>Edit Portfolio</span></button>
                <button class="btn" id="nightToggleBtn"><i class="fas fa-moon"></i></button>
                <button class="btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>

        <div class="profile-header">
            <div class="profile-background" id="profileCover">
                <button class="change-bg-btn" id="changeCoverBtn"><i class="fas fa-camera"></i> Change Cover</button>
            </div>
            <div class="profile-info">
                <div class="profile-picture-container">
                    <div class="profile-picture" id="profileAvatar">U</div>
                    <button class="change-pic-btn" id="changeAvatarBtn"><i class="fas fa-camera"></i></button>
                </div>
                <div class="profile-details">
                    <div class="profile-name-row">
                        <div class="profile-name" id="displayName">Loading...</div>
                        <div class="action-buttons" id="actionButtons"></div>
                    </div>
                    <div class="profile-bio" id="bio"></div>
                    <div class="profile-stats">
                        <div class="stat">
                            <span class="stat-value" id="postsCount">0</span>
                            <span class="stat-label">Posts</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" id="associatesCount">0</span>
                            <span class="stat-label">Associates</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value" id="associatedWithCount">0</span>
                            <span class="stat-label">Associated With</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="profile-section">
            <div class="section-header">
                <div class="section-title">Professional Portfolio</div>
                <button class="edit-section-btn" onclick="openSettings()"><i class="fas fa-edit"></i> Edit</button>
            </div>
            
            <div class="form-grid">
                <div class="info-item">
                    <div class="info-label">Role</div>
                    <div id="profRoleVal" class="info-value">...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Industry</div>
                    <div id="profIndustryVal" class="info-value">...</div>
                </div>
            </div>

            <div class="info-item">
                <div class="info-label">Work Experience</div>
                <div id="profExpVal" class="info-value">...</div>
            </div>

            <div class="info-item">
                <div class="info-label">Education</div>
                <div id="profEduVal" class="info-value">...</div>
            </div>

            <div class="info-item">
                <div class="info-label">Skills</div>
                <div id="skillsList" class="info-value"></div>
            </div>

             <div class="info-item">
                <div class="info-label">Documents</div>
                <div id="docsList" class="info-value">No documents uploaded.</div>
            </div>
        </div>

        <div class="profile-section">
            <div class="section-header">
                <div class="section-title">Contact & Personal</div>
                <button class="edit-section-btn" onclick="openSettings()"><i class="fas fa-edit"></i> Edit</button>
            </div>
            <div class="form-grid">
                 <div class="info-item">
                    <div class="info-label">Email</div>
                    <div id="emailVal" class="info-value">...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Phone</div>
                    <div id="phoneVal" class="info-value">...</div>
                </div>
                 <div class="info-item form-full">
                    <div class="info-label">Website</div>
                    <div id="websiteVal" class="info-value">...</div>
                </div>
                 <div class="info-item">
                    <div class="info-label">Nationality</div>
                    <div id="nationalityVal" class="info-value">...</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Country of Residence</div>
                    <div id="residenceVal" class="info-value">...</div>
                </div>
            </div>
        </div>

        <div class="profile-section">
            <div class="section-header">
                <div class="section-title">Post History</div>
            </div>
            <div class="post-grid" id="userPostsGrid">
                <div style="padding:20px; color:var(--secondary-text);">Loading posts...</div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="settingsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Update Portfolio</h3>
            <button class="close-modal" onclick="closeSettings()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="settingsForm">
                <div class="form-section">
                    <h4>1. Personal Information</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Full Name (Official)</label>
                            <input type="text" id="editOfficialName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date of Birth</label>
                            <input type="date" id="editDob" class="form-control">
                        </div>
                        <div class="form-group form-full">
                            <label class="form-label">About / Introduction</label>
                            <textarea id="editAbout" class="form-control"></textarea>
                        </div>
                         <div class="form-group form-full">
                            <label class="form-label">Bio (Short)</label>
                            <input type="text" id="editBio" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nationality / Citizenship</label>
                            <input type="text" id="editNationality" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Current Country of Residence</label>
                            <input type="text" id="editResidence" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="text" id="editPhone" class="form-control" placeholder="+1 234...">
                        </div>
                         <div class="form-group">
                            <label class="form-label">Personal Website</label>
                            <input type="text" id="editWebsite" class="form-control" placeholder="https://...">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h4>2. Job Preferences</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Desired Job Title / Role</label>
                            <input type="text" id="editJobTitle" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Preferred Industry</label>
                            <input type="text" id="editIndustry" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Preferred Work Country</label>
                            <input type="text" id="editPrefCountry" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Employment Type</label>
                            <select id="editEmpType" class="form-control">
                                <option value="">Select...</option>
                                <option value="Full-time">Full-time</option>
                                <option value="Part-time">Part-time</option>
                                <option value="Contract">Contract</option>
                                <option value="Remote">Remote</option>
                                <option value="Internship">Internship</option>
                            </select>
                        </div>
                         <div class="form-group">
                            <label class="form-label">Expected Salary (Optional)</label>
                            <input type="text" id="editSalary" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Availability / Start Date</label>
                            <input type="date" id="editStartDate" class="form-control">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h4>3. Education</h4>
                    <div class="form-grid">
                         <div class="form-group">
                            <label class="form-label">Highest Level</label>
                            <select id="editEduLevel" class="form-control">
                                <option value="">Select...</option>
                                <option value="High School">High School</option>
                                <option value="Bachelor's">Bachelor's</option>
                                <option value="Master's">Master's</option>
                                <option value="PhD">PhD</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Field of Study / Major</label>
                            <input type="text" id="editMajor" class="form-control">
                        </div>
                        <div class="form-group form-full">
                            <label class="form-label">Name of Institution</label>
                            <input type="text" id="editInstitution" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Graduation Year</label>
                            <input type="number" id="editGradYear" class="form-control">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h4>4. Work Experience (Most Recent)</h4>
                     <div class="form-grid">
                        <div class="form-group form-full">
                            <label class="form-label">Employer</label>
                            <input type="text" id="editEmployer" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Job Title</label>
                            <input type="text" id="editWorkTitle" class="form-control">
                        </div>
                         <div class="form-group">
                            <label class="form-label">Dates (Start - End)</label>
                            <input type="text" id="editWorkDates" class="form-control" placeholder="e.g. 2020 - Present">
                        </div>
                        <div class="form-group form-full">
                            <label class="form-label">Key Responsibilities / Skills Used</label>
                            <textarea id="editResponsibilities" class="form-control"></textarea>
                        </div>
                        <div class="form-group form-full">
                            <label class="form-label">Previous Experience Details</label>
                            <textarea id="editPrevExp" class="form-control" placeholder="Briefly list previous roles..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h4>5. Skills</h4>
                    <div class="skills-input-container">
                        <input type="text" id="newSkillInput" class="form-control" placeholder="Add a skill...">
                        <button type="button" class="add-skill-btn" onclick="addSkill()"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="activeSkillsEdit" class="active-skills-list"></div>
                </div>

                <div class="form-section">
                    <h4>6. Documents</h4>
                    <div class="form-group">
                        <label class="form-label">Resume / CV</label>
                        <div class="file-upload-box" onclick="document.getElementById('resumeInput').click()">
                            <i class="fas fa-file-pdf"></i> <span id="resumeStatus">Click to Upload Resume</span>
                        </div>
                        <input type="file" id="resumeInput" accept=".pdf,.doc,.docx" style="display:none;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cover Letter (Optional)</label>
                        <div class="file-upload-box" onclick="document.getElementById('coverLetterInput').click()">
                            <i class="fas fa-file-alt"></i> <span id="coverLetterStatus">Click to Upload Cover Letter</span>
                        </div>
                         <input type="file" id="coverLetterInput" accept=".pdf,.doc,.docx" style="display:none;">
                    </div>
                </div>

                <div class="form-section" style="border:none;">
                    <h4>7. Additional Information</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Willingness to Relocate</label>
                            <select id="editRelocate" class="form-control">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Willingness to Travel</label>
                            <select id="editTravel" class="form-control">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                    </div>
                </div>

            </form>
            <button class="btn" style="background:var(--primary); width:100%; margin-top:10px;" onclick="saveSettings()">Save Changes</button>
        </div>
    </div>
</div>

<input type="file" id="avatarInput" accept="image/*" style="display:none;">
<input type="file" id="coverInput" accept="image/*" style="display:none;">

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { 
        getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, orderBy, getDocs, onSnapshot, deleteDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js"; // Added for completeness

    /**
     * @fileoverview Professionalized script for MEET Profile page, managing profile data,
     * settings, and file uploads using Firebase and Cloudinary.
     */

    // --- Configuration Constants ---
    const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/dcwof2ngn/upload`;
    // Using the Feed's logic (Meet_video preset which works for files)
    const CLOUDINARY_PRESET = 'Meet_video'; 

    const firebaseConfig = {
        apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
        authDomain: "meet-6e159.firebaseapp.com",
        databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",
        projectId: "meet-6e159",
        storageBucket: "meet-6e159.firebasestorage.app",
        messagingSenderId: "252353608421",
        appId: "1:252353608421:web:6706056048e9a8f12db20c"
    };

    // --- Firebase Initialization ---
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    // const storage = getStorage(app); // Included if storage were to be used instead of Cloudinary

    // --- State Variables ---
    let currentUser = null;
    let targetProfileId = null;
    let isOwnProfile = false;
    let profileData = {};
    let tempSkills = []; // State for settings modal
    let tempResumeURL = null; // State for resume URL in modal
    let tempCoverURL = null; // State for cover letter URL in modal

    // --- Utility Functions ---

    /** Initializes the theme based on local storage. */
    const initTheme = () => {
        if(localStorage.getItem('meet_theme') === 'dark') {
            document.body.classList.add('dark-mode');
        }
    };

    /** Handles the main authentication state change and routing. */
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = 'login.html';
            return;
        }
        currentUser = user;
        
        const urlParams = new URLSearchParams(window.location.search);
        const uidParam = urlParams.get('uid');
        
        targetProfileId = uidParam || currentUser.uid;
        isOwnProfile = (targetProfileId === currentUser.uid);

        if (isOwnProfile) {
            document.getElementById('editProfileBtn').style.display = 'flex';
            document.getElementById('changeAvatarBtn').style.display = 'flex';
            document.getElementById('changeCoverBtn').style.display = 'block';
            document.querySelectorAll('.edit-section-btn').forEach(btn => btn.style.display = 'block');
        } else {
            await setupAssociateButton(); 
        }

        await loadProfileData();
        setupRealtimeStats();
        await loadUserPosts();
        bindImageUploads(); // Re-bind after cover element might have been replaced
    });

    // --- Data Loading & Rendering ---

    /** Loads and updates the primary profile data from Firestore. */
    async function loadProfileData() {
        try {
            const docRef = doc(db, "users", targetProfileId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                profileData = docSnap.data();
                renderProfile(profileData);
            } else if(isOwnProfile) {
                // Initialize user document if it doesn't exist
                profileData = {
                    displayName: currentUser.displayName,
                    photoURL: currentUser.photoURL,
                    email: currentUser.email
                };
                await setDoc(docRef, profileData, {merge:true});
                renderProfile(profileData);
            }
        } catch (e) { 
            console.error("Error loading profile:", e); 
        }
    }

    /** Renders the profile data onto the HTML elements. */
    function renderProfile(data) {
        // Basic Header
        document.getElementById('displayName').textContent = data.displayName || data.officialName || "User";
        document.getElementById('bio').textContent = data.bio || (isOwnProfile ? "Add a bio..." : "");
        
        const avatarEl = document.getElementById('profileAvatar');
        if (data.photoURL) avatarEl.innerHTML = `<img src="${data.photoURL}">`;
        else avatarEl.innerText = (data.displayName||"U").charAt(0).toUpperCase();
        
        const coverEl = document.getElementById('profileCover');
        const coverBtn = isOwnProfile ? `<button class="change-bg-btn" id="changeCoverBtn" style="display:block"><i class="fas fa-camera"></i> Change Cover</button>` : '';
        if (data.coverURL) {
            coverEl.innerHTML = `<img src="${data.coverURL}">` + coverBtn;
        } else {
            // Keep original fallback background
            coverEl.innerHTML = coverBtn; 
        }

        // Contact
        document.getElementById('emailVal').textContent = data.email || "Not set";
        document.getElementById('phoneVal').textContent = data.phone || "Not set";
        document.getElementById('websiteVal').innerHTML = data.website ? `<a href="${data.website}" target="_blank" style="color:var(--primary);">${data.website}</a>` : "Not set";
        document.getElementById('nationalityVal').textContent = data.nationality || "Not set";
        document.getElementById('residenceVal').textContent = data.residence || "Not set";

        // Portfolio / Professional
        document.getElementById('profRoleVal').textContent = data.jobTitle || "Not set";
        document.getElementById('profIndustryVal').textContent = data.industry || "Not set";
        
        let expText = "Not set";
        if(data.employer) expText = `${data.jobTitle} at ${data.employer} (${data.workDates || ''})`;
        document.getElementById('profExpVal').textContent = expText;

        let eduText = "Not set";
        if(data.institution) eduText = `${data.eduLevel || ''} in ${data.major || ''} at ${data.institution}`;
        document.getElementById('profEduVal').textContent = eduText.trim() === 'in  at' ? 'Not set' : eduText;

        // Skills
        const skillsContainer = document.getElementById('skillsList');
        skillsContainer.innerHTML = '';
        if (data.skills && Array.isArray(data.skills) && data.skills.length > 0) {
            data.skills.forEach(skill => {
                skillsContainer.innerHTML += `<span class="skill-tag">${skill}</span>`;
            });
        } else {
            skillsContainer.innerHTML = '<span style="color:var(--secondary-text)">No skills listed</span>';
        }

        // Docs
        const docsContainer = document.getElementById('docsList');
        docsContainer.innerHTML = '';
        if(data.resumeURL) docsContainer.innerHTML += `<a href="${data.resumeURL}" target="_blank" class="skill-tag" style="background:#ffebeb; color:#d32f2f;"><i class="fas fa-file-pdf"></i> Resume</a>`;
        if(data.coverLetterURL) docsContainer.innerHTML += `<a href="${data.coverLetterURL}" target="_blank" class="skill-tag" style="background:#e3f2fd; color:#1976d2;"><i class="fas fa-file-alt"></i> Cover Letter</a>`;
        if(!data.resumeURL && !data.coverLetterURL) docsContainer.innerHTML = "No documents.";
    }

    /** Sets up real-time listeners for profile statistics. */
    function setupRealtimeStats() {
        // Stats
        onSnapshot(collection(db, `users/${targetProfileId}/associates`), (snap) => document.getElementById('associatesCount').innerText = snap.size);
        onSnapshot(collection(db, `users/${targetProfileId}/associatedWith`), (snap) => document.getElementById('associatedWithCount').innerText = snap.size);
        
        // Posts count
        const postsQuery = query(collection(db, "posts"), where("userId", "==", targetProfileId));
        onSnapshot(postsQuery, (snap) => document.getElementById('postsCount').innerText = snap.size);
    }

    /** Loads and renders user's posts. */
    async function loadUserPosts() {
        const grid = document.getElementById('userPostsGrid');
        const q = query(collection(db, "posts"), where("userId", "==", targetProfileId), orderBy("createdAt", "desc"));
        const snap = await getDocs(q);
        grid.innerHTML = '';
        if(snap.empty) { 
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px;">No posts to show.</div>'; 
            return; 
        }

        snap.forEach(doc => {
            const post = doc.data();
            if (post.privacy === 'private' && !isOwnProfile) return;
            const div = document.createElement('div');
            div.className = 'post-item';
            const mediaContent = post.media ? (post.mediaType === 'video' ? `<video src="${post.media}"></video>` : `<img src="${post.media}">`) : `<div style="padding:15px; font-size:14px; height:100%; background:#f0f2f5; color:#333; overflow:hidden;">${post.text}</div>`;
            const dateStr = post.createdAt?.toDate ? post.createdAt.toDate().toLocaleDateString() : 'N/A';
            div.innerHTML = `${mediaContent}<div class="post-overlay">${post.privacy==='private'?'<i class="fas fa-lock"></i> ':''}${dateStr}</div>`;
            grid.appendChild(div);
        });
    }

    // --- Association Logic ---

    /** Sets up the Associate/Disassociate button for other profiles. */
    async function setupAssociateButton() {
        const container = document.getElementById('actionButtons');
        const docRef = doc(db, `users/${currentUser.uid}/associates/${targetProfileId}`);
        const snap = await getDoc(docRef);
        const isFollowing = snap.exists();

        container.innerHTML = `<button class="associate-btn ${isFollowing ? 'following' : ''}" id="assocActionBtn">${isFollowing ? 'Disassociate' : 'Associate'}</button>`;
        
        document.getElementById('assocActionBtn').onclick = async () => {
            if (isFollowing) {
                await deleteDoc(doc(db, `users/${currentUser.uid}/associates/${targetProfileId}`));
                await deleteDoc(doc(db, `users/${targetProfileId}/associatedWith/${currentUser.uid}`));
            } else {
                await setDoc(doc(db, `users/${currentUser.uid}/associates/${targetProfileId}`), { timestamp: serverTimestamp() });
                await setDoc(doc(db, `users/${targetProfileId}/associatedWith/${currentUser.uid}`), { followerId: currentUser.uid, timestamp: serverTimestamp() });
                // Notification for the associated user
                await import("https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js").then(({ addDoc, collection }) => {
                    addDoc(collection(db, "notifications"), { 
                        targetUserId: targetProfileId, 
                        type: 'associate', 
                        text: `${currentUser.displayName} associated with you.`, 
                        read: false, 
                        createdAt: serverTimestamp() 
                    });
                });
            }
            // Re-run to update button state
            await setupAssociateButton();
        };
    }

    // --- SETTINGS Modal Logic ---

    /** Opens the settings modal and pre-fills the form with current profile data. */
    window.openSettings = () => {
        if(!isOwnProfile) return;
        
        // Personal Information
        document.getElementById('editOfficialName').value = profileData.officialName || profileData.displayName || '';
        document.getElementById('editDob').value = profileData.dob || '';
        document.getElementById('editAbout').value = profileData.introduction || '';
        document.getElementById('editBio').value = profileData.bio || '';
        document.getElementById('editNationality').value = profileData.nationality || '';
        document.getElementById('editResidence').value = profileData.residence || '';
        document.getElementById('editPhone').value = profileData.phone || '';
        document.getElementById('editWebsite').value = profileData.website || '';

        // Job Preferences
        document.getElementById('editJobTitle').value = profileData.jobTitle || '';
        document.getElementById('editIndustry').value = profileData.industry || '';
        document.getElementById('editPrefCountry').value = profileData.prefCountry || '';
        document.getElementById('editEmpType').value = profileData.empType || '';
        document.getElementById('editSalary').value = profileData.salary || '';
        document.getElementById('editStartDate').value = profileData.startDate || '';

        // Education
        document.getElementById('editEduLevel').value = profileData.eduLevel || '';
        document.getElementById('editMajor').value = profileData.major || '';
        document.getElementById('editInstitution').value = profileData.institution || '';
        document.getElementById('editGradYear').value = profileData.gradYear || '';

        // Work Experience
        document.getElementById('editEmployer').value = profileData.employer || '';
        document.getElementById('editWorkTitle').value = profileData.workTitle || '';
        document.getElementById('editWorkDates').value = profileData.workDates || '';
        document.getElementById('editResponsibilities').value = profileData.responsibilities || '';
        document.getElementById('editPrevExp').value = profileData.prevExp || '';

        // Additional Information
        document.getElementById('editRelocate').value = profileData.relocate || 'No';
        document.getElementById('editTravel').value = profileData.travel || 'No';

        // Skills Init
        tempSkills = profileData.skills ? [...profileData.skills] : [];
        renderEditSkills();

        // Documents Init
        tempResumeURL = profileData.resumeURL || null;
        tempCoverURL = profileData.coverLetterURL || null;
        updateDocStatus();

        document.getElementById('settingsModal').style.display = 'flex';
    };

    /** Closes the settings modal. */
    window.closeSettings = () => document.getElementById('settingsModal').style.display = 'none';

    // Skills Logic
    /** Adds a skill to the temporary skills list. */
    window.addSkill = () => {
        const input = document.getElementById('newSkillInput');
        const val = input.value.trim();
        if(val && !tempSkills.includes(val)) {
            tempSkills.push(val);
            renderEditSkills();
            input.value = '';
        }
    };

    /** Removes a skill from the temporary skills list. */
    window.removeSkill = (idx) => {
        tempSkills.splice(idx, 1);
        renderEditSkills();
    };

    /** Renders the temporary skills list in the modal. */
    function renderEditSkills() {
        const container = document.getElementById('activeSkillsEdit');
        container.innerHTML = '';
        tempSkills.forEach((skill, idx) => {
            container.innerHTML += `
                <div class="active-skill-item">
                    ${skill} <i class="fas fa-times remove-skill" onclick="window.removeSkill(${idx})"></i>
                </div>
            `;
        });
    }

    // Document Upload Logic
    /** * Uploads a file (CV/Cover Letter) to Cloudinary.
     * @param {File} file The file to upload.
     * @param {string} type The type of document ('resume' or 'cover').
     */
    async function uploadDocument(file, type) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", CLOUDINARY_PRESET);

        const statusId = type === 'resume' ? 'resumeStatus' : 'coverLetterStatus';
        document.getElementById(statusId).innerText = "Uploading...";
        
        try {
            const res = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
            const data = await res.json();
            if(data.error) throw new Error(data.error.message || "Cloudinary upload error.");

            // Update the temporary state URL
            if(type === 'resume') tempResumeURL = data.secure_url;
            else tempCoverURL = data.secure_url;

            updateDocStatus();
        } catch(e) { 
            console.error("Document upload failed:", e); 
            alert(`Document upload failed for ${type}: ${e.message}`); 
            document.getElementById(statusId).innerText = `Upload Failed! Click to retry.`;
        }
    }

    /** Updates the status text for document upload boxes. */
    function updateDocStatus() {
        document.getElementById('resumeStatus').innerText = tempResumeURL ? "Resume Uploaded (Ready to Save)" : "Click to Upload Resume";
        document.getElementById('coverLetterStatus').innerText = tempCoverURL ? "Cover Letter Uploaded (Ready to Save)" : "Click to Upload Cover Letter";
    }

    // --- Document Input Change Handlers (FIXED) ---
    document.getElementById('resumeInput').onchange = (e) => { 
        const file = e.target.files[0];
        if(file) {
            uploadDocument(file, 'resume');
            e.target.value = ''; // Reset input
        }
    };
    document.getElementById('coverLetterInput').onchange = (e) => { 
        const file = e.target.files[0];
        if(file) {
            uploadDocument(file, 'cover');
            e.target.value = ''; // Reset input
        }
    };

    // Save Logic
    /** Gathers form data, updates the user document in Firestore, and reloads profile. */
    window.saveSettings = async () => {
        const updates = {
            // Personal Information
            officialName: document.getElementById('editOfficialName').value,
            displayName: document.getElementById('editOfficialName').value || profileData.displayName,
            dob: document.getElementById('editDob').value,
            introduction: document.getElementById('editAbout').value,
            bio: document.getElementById('editBio').value,
            nationality: document.getElementById('editNationality').value,
            residence: document.getElementById('editResidence').value,
            phone: document.getElementById('editPhone').value,
            website: document.getElementById('editWebsite').value,

            // Job Preferences
            jobTitle: document.getElementById('editJobTitle').value,
            industry: document.getElementById('editIndustry').value,
            prefCountry: document.getElementById('editPrefCountry').value,
            empType: document.getElementById('editEmpType').value,
            salary: document.getElementById('editSalary').value,
            startDate: document.getElementById('editStartDate').value,

            // Education
            eduLevel: document.getElementById('editEduLevel').value,
            major: document.getElementById('editMajor').value,
            institution: document.getElementById('editInstitution').value,
            gradYear: document.getElementById('editGradYear').value,

            // Work Experience
            employer: document.getElementById('editEmployer').value,
            workTitle: document.getElementById('editWorkTitle').value,
            workDates: document.getElementById('editWorkDates').value,
            responsibilities: document.getElementById('editResponsibilities').value,
            prevExp: document.getElementById('editPrevExp').value,

            // Additional
            relocate: document.getElementById('editRelocate').value,
            travel: document.getElementById('editTravel').value,

            // Skills and Documents (Using the temporary state)
            skills: tempSkills,
            resumeURL: tempResumeURL, 
            coverLetterURL: tempCoverURL,
            updatedAt: serverTimestamp()
        };

        try {
            await updateDoc(doc(db, "users", currentUser.uid), updates);
            closeSettings();
            await loadProfileData();
            alert("Portfolio updated successfully!");
        } catch(e) { 
            console.error("Error saving profile:", e); 
            alert("Error saving portfolio. Please try again."); 
        }
    };

    // --- Image Uploads (Avatar/Cover) ---

    /** Binds click handlers to the Change Avatar/Cover buttons. */
    function bindImageUploads() {
        const changeAvatarBtn = document.getElementById('changeAvatarBtn');
        const changeCoverBtn = document.getElementById('changeCoverBtn');
        if(changeAvatarBtn) {
            // Remove previous listener to avoid duplicates
            changeAvatarBtn.onclick = null; 
            changeAvatarBtn.onclick = () => document.getElementById('avatarInput').click();
        }
        if(changeCoverBtn) {
            // Remove previous listener to avoid duplicates
            changeCoverBtn.onclick = null;
            changeCoverBtn.onclick = () => document.getElementById('coverInput').click();
        }
    }

    /** * Uploads an image (Avatar/Cover) to Cloudinary and updates Firestore.
     * @param {File} file The image file to upload.
     * @param {string} field The Firestore field name ('photoURL' or 'coverURL').
     */
    async function uploadImage(file, field) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", CLOUDINARY_PRESET); 
        
        try {
            const res = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
            const data = await res.json();
            if(data.error) throw new Error(data.error.message);
            
            await updateDoc(doc(db, "users", currentUser.uid), { [field]: data.secure_url, updatedAt: serverTimestamp() });
            await loadProfileData(); // Reload to refresh the UI
        } catch(e) { 
            console.error("Image upload failed:", e); 
            alert("Image upload failed: " + e.message); 
        }
    }

    // --- Image Input Change Handlers ---
    document.getElementById('avatarInput').onchange = (e) => { 
        if(e.target.files[0]) {
            uploadImage(e.target.files[0], 'photoURL');
            e.target.value = ''; 
        }
    };
    document.getElementById('coverInput').onchange = (e) => { 
        if(e.target.files[0]) {
            uploadImage(e.target.files[0], 'coverURL');
            e.target.value = ''; 
        }
    };

    // --- Global Event Listeners ---
    document.getElementById('logoutBtn').onclick = () => signOut(auth);
    document.getElementById('nightToggleBtn').onclick = () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('meet_theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    };

    // Initialize Theme
    initTheme();

    // The functions below are exposed globally for use in HTML 'onclick' attributes.
    window.removeSkill = removeSkill;
    window.addSkill = addSkill;

</script>
</body>
</html>
