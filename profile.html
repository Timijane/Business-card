<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MEET Feed</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
  #feed { max-width: 600px; margin: auto; }
  .post { background: #fff; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
  video, img { max-width: 100%; border-radius: 8px; }
  textarea { width: 100%; padding: 8px; margin-bottom: 8px; }
</style>
</head>
<body>

<h1>MEET Feed</h1>
<div>
  <textarea id="postText" placeholder="What's on your mind?"></textarea>
  <input type="file" id="mediaFile" accept="image/*,video/*">
  <button id="postBtn">Post</button>
</div>

<div id="feed"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import {
    getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
    authDomain: "meet-6e159.firebaseapp.com",
    databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",
    projectId: "meet-6e159",
    storageBucket: "meet-6e159.appspot.com",
    messagingSenderId: "252353608421",
    appId: "1:252353608421:web:6706056048e9a8f12db20c",
    measurementId: "G-9BFPPVMMRF"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let currentUser = null;
  onAuthStateChanged(auth, user => {
    if (!user) {
      alert("Please log in first!");
      // redirect to login if needed
    } else {
      currentUser = user;
    }
  });

  const postBtn = document.getElementById("postBtn");
  const postText = document.getElementById("postText");
  const mediaFile = document.getElementById("mediaFile");

  postBtn.addEventListener("click", async () => {
    if (!currentUser) return alert("You must be logged in to post!");

    const file = mediaFile.files[0];
    const text = postText.value.trim();
    if (!file && !text) return alert("Add text or media!");

    let mediaUrl = null;

    if (file) {
      // 1️⃣ Get signature from Pipedream
      const sigRes = await fetch("https://eo3myb8usavbg0l.m.pipedream.net");
      const sigData = await sigRes.json();

      const formData = new FormData();
      formData.append("file", file);
      formData.append("api_key", sigData.api_key);
      formData.append("timestamp", sigData.timestamp);
      formData.append("upload_preset", sigData.upload_preset);
      formData.append("signature", sigData.signature);

      // 2️⃣ Upload to Cloudinary
      const cloudUrl = `https://api.cloudinary.com/v1_1/${sigData.cloud_name}/auto/upload`;
      const uploadRes = await fetch(cloudUrl, { method: "POST", body: formData });
      const uploadData = await uploadRes.json();
      mediaUrl = uploadData.secure_url;
    }

    // 3️⃣ Save post to Firestore
    await addDoc(collection(db, "posts"), {
      userId: currentUser.uid,
      text: text || "",
      mediaUrl: mediaUrl || "",
      createdAt: serverTimestamp()
    });

    postText.value = "";
    mediaFile.value = "";
  });

  // 4️⃣ Display feed
  const feedDiv = document.getElementById("feed");
  const postsQuery = query(collection(db, "posts"), orderBy("createdAt", "desc"));
  onSnapshot(postsQuery, snapshot => {
    feedDiv.innerHTML = "";
    snapshot.forEach(doc => {
      const data = doc.data();
      const postDiv = document.createElement("div");
      postDiv.className = "post";
      let mediaHtml = "";
      if (data.mediaUrl) {
        if (data.mediaUrl.includes(".mp4") || data.mediaUrl.includes("video")) {
          mediaHtml = `<video controls src="${data.mediaUrl}"></video>`;
        } else {
          mediaHtml = `<img src="${data.mediaUrl}" />`;
        }
      }
      postDiv.innerHTML = `<p>${data.text}</p>${mediaHtml}`;
      feedDiv.appendChild(postDiv);
    });
  });
</script>

</body>
</html>
