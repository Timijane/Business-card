<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Profile</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root { --primary: #0080FF; --bg-color: #f0f2f5; --card-bg: #fff; --text-color: #111; --secondary-text: #65676b; }
    body { font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; }
    .app-container { display: flex; min-height: 100vh; }

    /* Sidebar (Matching Feed) */
    .sidebar { position: fixed; left: 0; top: 0; height: 100vh; width: 240px; background: linear-gradient(180deg, #0080FF 0%, #0066CC 100%); overflow-y: auto; z-index: 100; padding: 20px; color: white; }
    .sidebar-menu a { display: flex; align-items: center; padding: 12px; text-decoration: none; color: white; border-radius: 8px; transition: background 0.3s; font-size: 16px; }
    .sidebar-menu a:hover { background: rgba(255, 255, 255, 0.2); }
    .sidebar-menu i { margin-right: 15px; font-size: 20px; width: 25px; text-align: center; }

    .main-content { flex: 1; margin-left: 240px; padding: 20px; }

    /* Profile Header */
    .profile-header { position: relative; margin-bottom: 20px; border-radius: 12px; overflow: hidden; background: var(--card-bg); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .profile-background { height: 250px; background: #ddd; position: relative; overflow: hidden; }
    .profile-background img { width: 100%; height: 100%; object-fit: cover; }
    
    /* 1. Fixed Image Buttons */
    .change-btn { position: absolute; background: rgba(0,0,0,0.6); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; display: none; z-index: 10; }
    #changeCoverBtn { bottom: 10px; right: 10px; }
    
    .profile-info { padding: 20px; display: flex; gap: 20px; position: relative; }
    .profile-pic-container { width: 160px; height: 160px; border-radius: 50%; border: 5px solid var(--card-bg); margin-top: -80px; position: relative; background: #fff; overflow: hidden; flex-shrink: 0; }
    .profile-pic-container img { width: 100%; height: 100%; object-fit: cover; }
    #changeAvatarBtn { bottom: 10px; left: 50%; transform: translateX(-50%); border-radius: 20px; font-size: 12px; width: max-content; }

    .profile-details { padding-top: 10px; flex: 1; }
    .section { background: var(--card-bg); border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; }
    .edit-icon { position: absolute; top: 20px; right: 20px; cursor: pointer; color: var(--primary); display: none; }

    .info-row { margin-bottom: 10px; }
    .label { font-weight: 600; font-size: 14px; color: var(--secondary-text); }

    /* Modal */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
    .modal-content { background: white; width: 500px; padding: 20px; border-radius: 10px; max-height: 80vh; overflow-y: auto; }
    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; margin-bottom: 5px; font-weight: 600; }
    .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }

    @media(max-width:768px){ .sidebar{width:60px;} .main-content{margin-left:60px;} .profile-info{flex-direction:column; text-align:center;} .profile-pic-container{margin:-80px auto 0;} }
</style>
</head>
<body>

<div class="app-container">
    <div class="sidebar">
        <div style="margin-bottom:30px; text-align:center;"><h2>MEET</h2></div>
        <ul class="sidebar-menu">
          <li><a href="feed.html"><i class="fas fa-home fa-fw"></i> <span>Feed</span></a></li>
          <li><a href="#" onclick="location.reload()"><i class="fas fa-user fa-fw"></i> <span>Profile</span></a></li>
          <li><a href="chat.html"><i class="fas fa-comment-alt fa-fw"></i> <span>Chat</span></a></li>
          <li><a href="organization.html"><i class="fas fa-sitemap fa-fw"></i> <span>Organization</span></a></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="profile-header">
            <div class="profile-background" id="coverDisplay">
                <button id="changeCoverBtn" class="change-btn"><i class="fas fa-camera"></i> Edit Cover</button>
            </div>
            <div class="profile-info">
                <div class="profile-pic-container" id="avatarDisplay">
                     <button id="changeAvatarBtn" class="change-btn"><i class="fas fa-camera"></i> Update</button>
                    <img src="" id="avatarImg" onerror="this.src='https://via.placeholder.com/150'">
                </div>
                <div class="profile-details">
                    <h2 id="profileName">User Name</h2>
                    <p id="profileBio" style="color:var(--secondary-text)">Bio...</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h3>About <i class="fas fa-edit edit-icon" onclick="editSection('about')"></i></h3>
            <div class="info-row"><span class="label">Intro:</span> <span id="dispIntro"></span></div>
            <div class="info-row"><span class="label">Location:</span> <span id="dispLoc"></span></div>
        </div>

        <div class="section">
            <h3>Professional <i class="fas fa-edit edit-icon" onclick="editSection('professional')"></i></h3>
            <div class="info-row"><span class="label">Workplace:</span> <span id="dispWork"></span></div>
            <div class="info-row"><span class="label">Position:</span> <span id="dispPos"></span></div>
            <div class="info-row"><span class="label">Experience:</span> <span id="dispExp"></span></div>
            <div class="info-row"><span class="label">Portfolio:</span> <a href="#" id="dispPort" target="_blank"></a></div>
            <div class="info-row"><span class="label">Status:</span> <span id="dispStatus" style="background:#e0f2fe; color:#0284c7; padding:2px 8px; border-radius:10px; font-size:12px;"></span></div>
        </div>

        <div class="section">
            <h3>Contact <i class="fas fa-edit edit-icon" onclick="editSection('contact')"></i></h3>
            <div class="info-row"><span class="label">Email:</span> <span id="dispEmail"></span></div>
            <div class="info-row"><span class="label">Phone:</span> <span id="dispPhone"></span></div>
            <div class="info-row"><span class="label">Website:</span> <a href="#" id="dispWeb" target="_blank"></a></div>
        </div>
    </div>
</div>

<div class="modal" id="editModal">
    <div class="modal-content">
        <h3 id="modalTitle">Edit</h3>
        <form id="editForm"></form>
        <div style="margin-top:20px; text-align:right;">
            <button onclick="document.getElementById('editModal').style.display='none'" style="padding:8px 16px; cursor:pointer;">Cancel</button>
            <button onclick="saveData()" style="background:var(--primary); color:white; padding:8px 16px; border:none; border-radius:5px; cursor:pointer;">Save</button>
        </div>
    </div>
</div>

<input type="file" id="avatarInput" style="display:none" accept="image/*">
<input type="file" id="coverInput" style="display:none" accept="image/*">

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
        authDomain: "meet-6e159.firebaseapp.com",
        projectId: "meet-6e159"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dcwof2ngn/upload";

    let currentUser = null;
    let currentSection = '';
    let isOwnProfile = false;

    onAuthStateChanged(auth, async (user) => {
        if(user) {
            currentUser = user;
            const urlParams = new URLSearchParams(window.location.search);
            const targetId = urlParams.get('uid') || user.uid;
            isOwnProfile = (targetId === user.uid);

            if(isOwnProfile) {
                // 1. Show Buttons only if owner
                document.querySelectorAll('.edit-icon').forEach(el => el.style.display = 'inline');
                document.querySelectorAll('.change-btn').forEach(el => el.style.display = 'block');
            }

            loadData(targetId);
        } else { window.location.href = 'login.html'; }
    });

    async function loadData(uid) {
        const snap = await getDoc(doc(db, "users", uid));
        if(snap.exists()) {
            const data = snap.data();
            
            // Render Header
            document.getElementById('profileName').innerText = data.displayName || "User";
            document.getElementById('profileBio').innerText = data.bio || "";
            if(data.photoURL) document.getElementById('avatarImg').src = data.photoURL;
            if(data.coverURL) {
                document.getElementById('coverDisplay').style.background = `url(${data.coverURL}) center/cover no-repeat`;
            }

            // Render Sections
            setText('dispIntro', data.introduction);
            setText('dispLoc', data.location);
            setText('dispWork', data.workplace);
            setText('dispPos', data.position);
            setText('dispExp', data.yearsExperience ? data.yearsExperience + " Years" : "");
            setLink('dispPort', data.portfolio);
            setText('dispStatus', data.lookingForJob ? "Seeking Opportunities" : "Employed");
            setText('dispEmail', data.email);
            setText('dispPhone', data.phone);
            setLink('dispWeb', data.website); // 3. Website
        }
    }

    function setText(id, val) { document.getElementById(id).innerText = val || '---'; }
    function setLink(id, val) { 
        const el = document.getElementById(id);
        el.innerText = val || '---';
        el.href = val || '#';
    }

    // --- 1. Image Upload Logic ---
    document.getElementById('changeAvatarBtn').onclick = () => document.getElementById('avatarInput').click();
    document.getElementById('changeCoverBtn').onclick = () => document.getElementById('coverInput').click();

    document.getElementById('avatarInput').onchange = (e) => uploadImage(e.target.files[0], 'photoURL');
    document.getElementById('coverInput').onchange = (e) => uploadImage(e.target.files[0], 'coverURL');

    async function uploadImage(file, field) {
        if(!file) return;
        const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', 'Meet_profile');
        const res = await fetch(CLOUDINARY_URL, { method: 'POST', body: fd });
        const json = await res.json();
        
        await updateDoc(doc(db, "users", currentUser.uid), { [field]: json.secure_url });
        location.reload();
    }

    // --- 2. Professional & Contact Edit Logic ---
    window.editSection = (sec) => {
        currentSection = sec;
        const modal = document.getElementById('editModal');
        const form = document.getElementById('editForm');
        modal.style.display = 'flex';
        document.getElementById('modalTitle').innerText = "Edit " + sec;

        // Fetch current values (simplified for demo, ideally from state)
        if(sec === 'professional') {
            // 2. Added more professional fields
            form.innerHTML = `
                <div class="input-group"><label>Workplace</label><input id="inpWork"></div>
                <div class="input-group"><label>Position</label><input id="inpPos"></div>
                <div class="input-group"><label>Years of Experience</label><input type="number" id="inpExp"></div>
                <div class="input-group"><label>Portfolio URL</label><input type="url" id="inpPort"></div>
                <div class="input-group" style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="inpJob" style="width:auto;"> <label style="margin:0">Open to Work?</label>
                </div>
            `;
        } else if(sec === 'contact') {
             // 3. Added Website
            form.innerHTML = `
                <div class="input-group"><label>Phone</label><input id="inpPhone"></div>
                <div class="input-group"><label>Website URL</label><input id="inpWeb"></div>
            `;
        } else if(sec === 'about') {
            form.innerHTML = `
                <div class="input-group"><label>Display Name</label><input id="inpName"></div>
                <div class="input-group"><label>Bio</label><textarea id="inpBio"></textarea></div>
                <div class="input-group"><label>Intro</label><textarea id="inpIntro"></textarea></div>
                <div class="input-group"><label>Location</label><input id="inpLoc"></div>
            `;
        }
    };

    window.saveData = async () => {
        const updates = {};
        if(currentSection === 'professional') {
            updates.workplace = document.getElementById('inpWork').value;
            updates.position = document.getElementById('inpPos').value;
            updates.yearsExperience = document.getElementById('inpExp').value;
            updates.portfolio = document.getElementById('inpPort').value;
            updates.lookingForJob = document.getElementById('inpJob').checked;
        } else if (currentSection === 'contact') {
            updates.phone = document.getElementById('inpPhone').value;
            updates.website = document.getElementById('inpWeb').value;
        } else if (currentSection === 'about') {
            updates.displayName = document.getElementById('inpName').value;
            updates.bio = document.getElementById('inpBio').value;
            updates.introduction = document.getElementById('inpIntro').value;
            updates.location = document.getElementById('inpLoc').value;
        }

        await updateDoc(doc(db, "users", currentUser.uid), updates);
        location.reload();
    };

    window.auth = auth;
</script>
</body>
</html>
