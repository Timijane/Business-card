<script>
// ------------------ Profile Editing ------------------
let isEditingSection = null;

// Toggle Edit Mode for any section
function toggleEdit(sectionId) {
  const saveBtn = document.getElementById('saveProfile');

  // Exit previous edit if any
  if (isEditingSection && isEditingSection !== sectionId) cancelEdit();

  isEditingSection = sectionId;
  saveBtn.style.display = 'block';

  // Convert display elements into input fields
  if (sectionId === 'personalInfo') {
    togglePersonalInfoInputs(true);
  } else if (sectionId === 'educationInfo') {
    toggleEducationInputs(true);
  } else if (sectionId === 'experienceInfo') {
    toggleExperienceInputs(true);
  }

  // Change all edit buttons to "Cancel"
  const editButtons = document.querySelectorAll('.edit-btn');
  editButtons.forEach(btn => {
    btn.textContent = 'Cancel';
    btn.onclick = cancelEdit;
  });
}

// Cancel Editing
function cancelEdit() {
  const saveBtn = document.getElementById('saveProfile');
  isEditingSection = null;
  saveBtn.style.display = 'none';

  togglePersonalInfoInputs(false);
  toggleEducationInputs(false);
  toggleExperienceInputs(false);

  // Restore edit buttons
  const editButtons = document.querySelectorAll('.edit-btn');
  editButtons.forEach(btn => {
    btn.textContent = 'Edit';
    btn.onclick = function() {
      toggleEdit(this.closest('.detail-card').querySelector('.info-grid, #educationInfo, #experienceInfo').id);
    };
  });
}

// Toggle Personal Info Inputs
function togglePersonalInfoInputs(show) {
  document.getElementById('dobDisplay').style.display = show ? 'none' : 'block';
  document.getElementById('dobInput').style.display = show ? 'block' : 'none';

  document.getElementById('locationDisplay').style.display = show ? 'none' : 'block';
  document.getElementById('locationInputs').style.display = show ? 'block' : 'none';

  document.getElementById('languagesDisplay').style.display = show ? 'none' : 'block';
  document.getElementById('languagesInput').style.display = show ? 'block' : 'none';
}

// Toggle Education Inputs
function toggleEducationInputs(show) {
  const eduItems = document.querySelectorAll('#educationInfo .education-item');
  eduItems.forEach(item => {
    if (show) {
      const title = item.querySelector('.edu-title').textContent;
      const institution = item.querySelector('.edu-institution').textContent;
      const dates = item.querySelector('.edu-dates').textContent;
      const desc = item.querySelector('.edu-description') ? item.querySelector('.edu-description').textContent : '';

      item.innerHTML = `
        <input class="edu-title-input" value="${title}" placeholder="Degree/Title">
        <input class="edu-institution-input" value="${institution}" placeholder="Institution">
        <input class="edu-dates-input" value="${dates}" placeholder="Dates">
        <textarea class="edu-description-input" placeholder="Description">${desc}</textarea>
      `;
    } else {
      const title = item.querySelector('.edu-title-input').value;
      const institution = item.querySelector('.edu-institution-input').value;
      const dates = item.querySelector('.edu-dates-input').value;
      const desc = item.querySelector('.edu-description-input') ? item.querySelector('.edu-description-input').value : '';

      item.innerHTML = `
        <div class="edu-title">${title}</div>
        <div class="edu-institution">${institution}</div>
        <div class="edu-dates">${dates}</div>
        ${desc ? `<div class="edu-description">${desc}</div>` : ''}
      `;
    }
  });
}

// Toggle Experience Inputs
function toggleExperienceInputs(show) {
  const expItems = document.querySelectorAll('#experienceInfo .experience-item');
  expItems.forEach(item => {
    if (show) {
      const title = item.querySelector('.exp-title').textContent;
      const company = item.querySelector('.exp-company').textContent;
      const dates = item.querySelector('.exp-dates').textContent;
      const desc = item.querySelector('.exp-description') ? item.querySelector('.exp-description').textContent : '';

      item.innerHTML = `
        <input class="exp-title-input" value="${title}" placeholder="Job Title">
        <input class="exp-company-input" value="${company}" placeholder="Company">
        <input class="exp-dates-input" value="${dates}" placeholder="Dates">
        <textarea class="exp-description-input" placeholder="Description">${desc}</textarea>
      `;
    } else {
      const title = item.querySelector('.exp-title-input').value;
      const company = item.querySelector('.exp-company-input').value;
      const dates = item.querySelector('.exp-dates-input').value;
      const desc = item.querySelector('.exp-description-input') ? item.querySelector('.exp-description-input').value : '';

      item.innerHTML = `
        <div class="exp-title">${title}</div>
        <div class="exp-company">${company}</div>
        <div class="exp-dates">${dates}</div>
        ${desc ? `<div class="exp-description">${desc}</div>` : ''}
      `;
    }
  });
}

// Save Profile
document.getElementById('saveProfile').addEventListener('click', function() {
  // Personal Info
  document.getElementById('dobDisplay').textContent = formatDate(document.getElementById('dobInput').value);
  document.getElementById('locationDisplay').textContent =
    document.getElementById('cityInput').value + ', ' +
    document.getElementById('stateInput').value + ', ' +
    document.getElementById('countryInput').value;
  document.getElementById('languagesDisplay').textContent = document.getElementById('languagesInput').value;

  // Save Education & Experience in localStorage
  const educationData = [];
  document.querySelectorAll('#educationInfo .education-item').forEach(item => {
    educationData.push({
      title: item.querySelector('.edu-title') ? item.querySelector('.edu-title').textContent : '',
      institution: item.querySelector('.edu-institution') ? item.querySelector('.edu-institution').textContent : '',
      dates: item.querySelector('.edu-dates') ? item.querySelector('.edu-dates').textContent : '',
      description: item.querySelector('.edu-description') ? item.querySelector('.edu-description').textContent : ''
    });
  });
  localStorage.setItem('meet_education', JSON.stringify(educationData));

  const experienceData = [];
  document.querySelectorAll('#experienceInfo .experience-item').forEach(item => {
    experienceData.push({
      title: item.querySelector('.exp-title') ? item.querySelector('.exp-title').textContent : '',
      company: item.querySelector('.exp-company') ? item.querySelector('.exp-company').textContent : '',
      dates: item.querySelector('.exp-dates') ? item.querySelector('.exp-dates').textContent : '',
      description: item.querySelector('.exp-description') ? item.querySelector('.exp-description').textContent : ''
    });
  });
  localStorage.setItem('meet_experience', JSON.stringify(experienceData));

  cancelEdit();
  alert('Profile updated successfully!');
});

// Load saved Education & Experience
window.addEventListener('load', function() {
  const savedEdu = JSON.parse(localStorage.getItem('meet_education') || '[]');
  if (savedEdu.length) {
    const eduContainer = document.getElementById('educationInfo');
    eduContainer.innerHTML = '';
    savedEdu.forEach(ed => {
      eduContainer.innerHTML += `
        <div class="education-item">
          <div class="edu-title">${ed.title}</div>
          <div class="edu-institution">${ed.institution}</div>
          <div class="edu-dates">${ed.dates}</div>
          ${ed.description ? `<div class="edu-description">${ed.description}</div>` : ''}
        </div>
      `;
    });
  }

  const savedExp = JSON.parse(localStorage.getItem('meet_experience') || '[]');
  if (savedExp.length) {
    const expContainer = document.getElementById('experienceInfo');
    expContainer.innerHTML = '';
    savedExp.forEach(ex => {
      expContainer.innerHTML += `
        <div class="experience-item">
          <div class="exp-title">${ex.title}</div>
          <div class="exp-company">${ex.company}</div>
          <div class="exp-dates">${ex.dates}</div>
          ${ex.description ? `<div class="exp-description">${ex.description}</div>` : ''}
        </div>
      `;
    });
  }
});
</script>
