<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MEET | Feed</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* ==== (exact styling you provided, slightly trimmed for brevity) ==== */
:root {
  --primary: #0061FF; --primary-dark: #0050d4; --error: #EF4444; --success: #10B981;
  --bg-color: #f0f2f5; --card-bg: #fff; --text-color: #111; --secondary-text: #65676b;
  --border-color: #dddfe2; --online: #10B981; --offline: #EF4444;
}
body.dark-mode { --bg-color:#18191a; --card-bg:#242526; --text-color:#e4e6eb; --secondary-text:#b0b3b8; --border-color:#3e4042; }
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Poppins',sans-serif;background:linear-gradient(135deg,#e0f7ff 0%,#b3e0ff 100%);color:var(--text-color);min-height:100vh;transition:all .3s}
.app-container{display:flex;min-height:100vh}

/* Sidebar (fixed) */
.sidebar{position:fixed;left:0;top:0;height:100vh;width:280px;background:linear-gradient(180deg,#0061FF 0%,#4d94ff 100%);border-right:1px solid var(--border-color);overflow-y:auto;z-index:100;padding:20px;color:white}
.sidebar-header{padding:10px 0 20px;border-bottom:1px solid rgba(255,255,255,.2);margin-bottom:20px}
.sidebar-menu{list-style:none}
.sidebar-menu li{margin-bottom:8px}
.sidebar-menu a{display:flex;align-items:center;padding:12px;text-decoration:none;color:white;border-radius:8px;transition:background .3s}
.sidebar-menu a:hover{background:rgba(255,255,255,.12)}
.sidebar-menu i{margin-right:12px;font-size:20px}

/* Main content */
.main-content{flex:1;margin-left:280px;padding:20px}

/* Navbar */
.navbar{background:linear-gradient(135deg,#0061FF 0%,#4d94ff 100%);padding:15px 20px;border-radius:12px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;color:white;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.nav-controls{display:flex;gap:10px;align-items:center}
.search-bar{display:flex;align-items:center;background:rgba(255,255,255,.2);border-radius:20px;padding:8px 15px;margin-right:15px}
.search-bar input{background:transparent;border:none;color:white;outline:none;width:200px}
.user-profile-nav{display:flex;align-items:center;gap:10px;padding:5px 10px;border-radius:20px;background:rgba(255,255,255,.2);cursor:pointer;position:relative}
.user-avatar{width:40px;height:40px;border-radius:50%;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;cursor:pointer;position:relative}
.user-avatar.small{width:30px;height:30px;font-size:14px}
.status-indicator{position:absolute;bottom:0;right:0;width:12px;height:12px;border-radius:50%;border:2px solid white}
.status-online{background:var(--online)}.status-offline{background:var(--offline)}
.btn{background:rgba(255,255,255,.2);color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px}
.btn:hover{background:rgba(255,255,255,.3)}

/* Composer */
.post-composer{background:var(--card-bg);border-radius:12px;padding:16px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.composer-header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.composer-input{flex:1;background:var(--bg-color);border:none;padding:12px 16px;border-radius:25px;color:var(--text-color);font-size:14px;cursor:pointer}
.action-btn{display:flex;align-items:center;gap:8px;padding:8px 16px;border-radius:8px;cursor:pointer;color:var(--secondary-text)}
.action-btn:hover{background:var(--bg-color)}

/* Modal */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
.modal-content{background:var(--card-bg);border-radius:12px;width:500px;max-width:90%;max-height:90vh;overflow-y:auto}
.modal-header{padding:16px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}
.modal-body{padding:16px}
.close-modal{background:none;border:none;font-size:24px;cursor:pointer;color:var(--secondary-text)}

/* Post / Comments */
.posts{display:flex;flex-direction:column;gap:16px}
.post{background:var(--card-bg);border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.post-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.post-user{display:flex;align-items:center;gap:12px;cursor:pointer}
.post-meta{font-size:13px;color:var(--secondary-text)}
.post-media img,.post-media video{width:100%;max-height:500px;object-fit:contain}
.post-stats{display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border-color);color:var(--secondary-text);font-size:14px}
.post-interactions{display:flex;justify-content:space-around;padding:8px 0}
.interaction-btn{display:flex;align-items:center;gap:6px;padding:8px 16px;border-radius:4px;cursor:pointer;color:var(--secondary-text);font-weight:600}
.interaction-btn:hover{background:var(--bg-color)}
.interaction-btn.active{color:var(--primary)}
.comments-section{margin-top:12px;border-top:1px solid var(--border-color);padding-top:12px}
.comment{display:flex;gap:12px;margin-bottom:12px}
.comment-content{flex:1;background:var(--bg-color);padding:8px 12px;border-radius:18px}
.comment-input{display:flex;gap:8px;margin-top:12px;align-items:center}
.comment-input input{flex:1;background:var(--bg-color);border:none;padding:8px 12px;border-radius:18px;color:var(--text-color)}
.send-comment-btn{background:var(--primary);color:white;border:none;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.send-comment-btn:disabled{background:var(--secondary-text);cursor:not-allowed}
.loading{text-align:center;padding:20px;color:var(--secondary-text)}
.error-message{background:rgba(239,68,68,.1);color:var(--error);padding:10px;border-radius:5px;margin:10px 0;text-align:center}
.success-message{background:rgba(16,185,129,.1);color:var(--success);padding:10px;border-radius:5px;margin:10px 0;text-align:center}
.spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Responsive */
@media(max-width:1200px){.sidebar{width:80px}.main-content{margin-left:80px}.sidebar span{display:none}}
@media(max-width:768px){.sidebar{width:70px;padding:10px 5px}.main-content{margin-left:70px;padding:10px}.search-bar{display:none}.user-profile-nav span{display:none}}
</style>
</head>
<body>

<div class="app-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header"><h2 style="color:white">MEET</h2></div>
    <ul class="sidebar-menu">
      <li><a href="#"><i class="fas fa-home"></i> <span>Feed</span></a></li>
      <li><a href="profile.html"><i class="fas fa-user"></i> <span>Profile</span></a></li>
      <li><a href="#"><i class="fas fa-comment"></i> <span>Chat</span></a></li>
      <li><a href="#"><i class="fas fa-chart-line"></i> <span>Meetrader</span></a></li>
      <li><a href="#"><i class="fas fa-graduation-cap"></i> <span>Meetversity</span></a></li>
      <li><a href="#"><i class="fas fa-sitemap"></i> <span>Organization</span></a></li>
      <li><a href="#"><i class="fas fa-cog"></i> <span>Setting</span></a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="navbar">
      <h2 style="color:white">MEET Feed</h2>
      <div style="display:flex;align-items:center">
        <div class="search-bar"><i class="fas fa-search" style="margin-right:8px"></i><input placeholder="Search..."></div>
        <div class="nav-controls">
          <div class="user-profile-nav">
            <div class="user-avatar small" id="currentUserAvatar">U<div class="status-indicator status-online"></div></div>
            <span id="userName">User</span>
          </div>
          <button class="btn" id="nightToggleBtn"><i class="fas fa-moon"></i><span>Night Mode</span></button>
          <button class="btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span>Logout</span></button>
        </div>
      </div>
    </div>

    <!-- Composer -->
    <div class="post-composer">
      <div class="composer-header">
        <div class="user-avatar" id="currentUserAvatarComposer">U<div class="status-indicator status-online"></div></div>
        <div class="composer-input" id="openComposer">Surprise the world now</div>
      </div>
      <div class="composer-divider"></div>
      <div class="composer-actions">
        <div class="action-btn"><i class="fas fa-video" style="color:#f02849"></i><span>Live Video</span></div>
        <div class="action-btn"><i class="fas fa-images" style="color:#45bd62"></i><span>Photo/Video</span></div>
        <div class="action-btn"><i class="fas fa-laugh" style="color:#f7b928"></i><span>Feeling/Activity</span></div>
      </div>
    </div>

    <div class="ai-button" title="AI"><i class="fas fa-robot"></i></div>
    <div id="messageContainer"></div>

    <!-- Posts -->
    <div class="posts" id="postsContainer">
      <div class="loading">Loading posts...</div>
    </div>
  </div>
</div>

<!-- Post Modal -->
<div class="modal" id="postModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Create Post</h3>
      <button class="close-modal" id="closeModal">&times;</button>
    </div>
    <div class="modal-body">
      <div class="post-form">
        <div class="post-user-info">
          <div class="user-avatar" id="modalUserAvatar">U<div class="status-indicator status-online"></div></div>
          <div>
            <div class="user-name" id="modalUserName">User Name</div>
            <select id="privacy" style="border:none;background:var(--bg-color);color:var(--text-color);padding:4px 8px;border-radius:4px">
              <option value="public">üåç Public</option>
              <option value="friends">üë• Friends</option>
              <option value="private">üîí Only Me</option>
            </select>
          </div>
        </div>

        <textarea class="post-textarea" id="postText" placeholder="Surprise the world now"></textarea>
        <div class="media-preview" id="mediaPreview"></div>
        <div class="post-options">
          <div style="color:var(--secondary-text)">Add to your post</div>
          <div style="display:flex;gap:8px">
            <input type="file" id="postMedia" accept="image/*,video/*" style="display:none">
            <div class="action-btn" onclick="document.getElementById('postMedia').click()"><i class="fas fa-images" style="color:#45bd62"></i></div>
            <div class="action-btn"><i class="fas fa-user-tag" style="color:#1877f2"></i></div>
            <div class="action-btn"><i class="fas fa-laugh" style="color:#f7b928"></i></div>
            <div class="action-btn"><i class="fas fa-map-marker-alt" style="color:#f5533d"></i></div>
          </div>
        </div>

        <button class="btn" id="postBtn" style="width:100%;background:linear-gradient(135deg,#0061FF 0%,#4d94ff 100%)">
          <span id="postBtnText">Post</span>
          <span id="postBtnSpinner" class="spinner" style="display:none"></span>
        </button>

      </div>
    </div>
  </div>
</div>

<!-- Firebase + App Code -->
<script type="module">
/* ================= CONFIG - ADJUST THESE ================= */
// PIPEDREAM URL that returns signature JSON (replace with your actual Pipedream endpoint)
const PIPEDREAM_URL = "https://eou0ypk0bgs5o8z.m.pipedream.net"; // <- REPLACE if different

// Cloudinary info is returned by Pipedream. cloud_name and api_key come from there.
// Do NOT put api_secret in the frontend.

import {
  initializeApp
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";

import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

import {
  getFirestore,
  collection,
  addDoc,
  setDoc,
  doc,
  deleteDoc,
  updateDoc,
  getDoc,
  onSnapshot,
  query,
  orderBy,
  serverTimestamp,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

/* ================ FIREBASE CONFIG ================ */
const firebaseConfig = {
  apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
  authDomain: "meet-6e159.firebaseapp.com",
  databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",
  projectId: "meet-6e159",
  storageBucket: "meet-6e159.firebasestorage.app",
  messagingSenderId: "252353608421",
  appId: "1:252353608421:web:6706056048e9a8f12db20c",
  measurementId: "G-9BFPPVMMRF"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ================ DOM ================ */
const postsContainer = document.getElementById('postsContainer');
const postBtn = document.getElementById('postBtn');
const postText = document.getElementById('postText');
const postMedia = document.getElementById('postMedia');
const privacySelect = document.getElementById('privacy');
const logoutBtn = document.getElementById('logoutBtn');
const messageContainer = document.getElementById('messageContainer');
const nightToggleBtn = document.getElementById('nightToggleBtn');
const postModal = document.getElementById('postModal');
const openComposer = document.getElementById('openComposer');
const closeModal = document.getElementById('closeModal');
const mediaPreview = document.getElementById('mediaPreview');
const currentUserAvatar = document.getElementById('currentUserAvatar');
const currentUserAvatarComposer = document.getElementById('currentUserAvatarComposer');
const modalUserAvatar = document.getElementById('modalUserAvatar');
const modalUserName = document.getElementById('modalUserName');
const userNameEl = document.getElementById('userName');

const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB to allow longer videos if preset allows
/* note: Cloudinary/preset and account quota still apply */

/* ================ UI helpers ================ */
function showMessage(msg, type='error') {
  messageContainer.innerHTML = `<div class="${type==='success'?'success-message':'error-message'}">${msg}</div>`;
  setTimeout(()=>messageContainer.innerHTML='',5000);
}
function setLoading(buttonId, isLoading) {
  const button = document.getElementById(buttonId);
  if(!button) return;
  const text = button.querySelector('span:first-child');
  const spinner = button.querySelector('.spinner');
  if(isLoading){ button.disabled = true; if(text) text.style.display='none'; if(spinner) spinner.style.display='inline-block'; }
  else { button.disabled = false; if(text) text.style.display='inline-block'; if(spinner) spinner.style.display='none'; }
}

/* ================ PIPEDREAM SIGNATURE ================
  Calls your Pipedream endpoint which must return JSON:
  { cloud_name, api_key, upload_preset, timestamp, signature }
  (You already validated that your Pipedream returns similar output)
===================================================== */
async function fetchSignature() {
  const res = await fetch(PIPEDREAM_URL, { method: 'GET' });
  if (!res.ok) {
    const text = await res.text().catch(()=>'');
    throw new Error('Failed to get signature: ' + (text || res.statusText));
  }
  const data = await res.json();
  // basic validation
  if(!data.signature || !data.timestamp || !data.api_key || !data.cloud_name) {
    throw new Error('Invalid signature response from server.');
  }
  return data; // contains cloud_name, api_key, upload_preset, timestamp, signature
}

/* ================ UPLOAD TO CLOUDINARY ================
  Uses the signed params returned by Pipedream. For signed uploads
  we POST to https://api.cloudinary.com/v1_1/{cloud_name}/upload
  with form fields: file, api_key, timestamp, signature, (upload_preset if your signature included it)
===================================================== */
async function uploadToCloudinary(file) {
  // ask server (Pipedream) for signature/timestamp etc.
  const sig = await fetchSignature();
  const { cloud_name, api_key, upload_preset, timestamp, signature } = sig;
  const url = `https://api.cloudinary.com/v1_1/${cloud_name}/upload`;

  const formData = new FormData();
  formData.append('file', file);
  formData.append('api_key', api_key);
  formData.append('timestamp', timestamp);
  formData.append('signature', signature);

  // include upload_preset if your signature generation included it (your Pipedream code used upload_preset)
  if(upload_preset) formData.append('upload_preset', upload_preset);

  // Optionally set folder to meet_videos (if you configured preset to use asset folder)
  // formData.append('folder', 'meet_videos');

  const response = await fetch(url, {
    method: 'POST',
    body: formData
  });

  if(!response.ok) {
    const text = await response.text().catch(()=> '');
    throw new Error('Cloudinary upload failed: ' + (text || response.statusText));
  }
  const data = await response.json();
  return data.secure_url || data.url;
}

/* ================ CREATE POST ================ */
async function createPost(text, file, privacy) {
  const user = auth.currentUser;
  if(!user) throw new Error('You must be logged in');

  let mediaUrl = "";
  if (file) {
    // validate size
    if (file.size > MAX_FILE_SIZE) throw new Error('File too large. Max ' + (MAX_FILE_SIZE/1024/1024) + 'MB');
    mediaUrl = await uploadToCloudinary(file);
  }

  const newDoc = await addDoc(collection(db, 'posts'), {
    userId: user.uid,
    userName: user.displayName || 'Anonymous',
    userInitial: (user.displayName && user.displayName.charAt(0).toUpperCase()) || 'U',
    text: text || '',
    media: mediaUrl || '',
    privacy: privacy || 'public',
    shares: 0,
    timestamp: serverTimestamp()
    // note: don't store likes/comments arrays here (we use subcollections)
  });

  return newDoc.id;
}

/* ================ LIKES (subcollection) ================
  We'll keep a doc per user under posts/{postId}/likes/{uid}
  Firestore security rules you shared allow create/delete of this subcollection when request.resource.data.userId == auth.uid
===================================================== */
async function likePost(postId) {
  const user = auth.currentUser; if(!user) return;
  const likeRef = doc(db, 'posts', postId, 'likes', user.uid);
  const snap = await getDoc(likeRef);
  if (snap.exists()) {
    // unlike
    await deleteDoc(likeRef);
  } else {
    // create like
    await setDoc(likeRef, {
      userId: user.uid,
      timestamp: serverTimestamp()
    });
  }
}

/* ================ COMMENTS (subcollection) ================
  Add a comment doc to posts/{postId}/comments
===================================================== */
async function addCommentToPost(postId, text) {
  const user = auth.currentUser; if(!user) return;
  if(!text || !text.trim()) return;
  await addDoc(collection(db, 'posts', postId, 'comments'), {
    userId: user.uid,
    userName: user.displayName || 'Anonymous',
    userInitial: (user.displayName && user.displayName.charAt(0).toUpperCase()) || 'U',
    text: text.trim(),
    timestamp: serverTimestamp()
  });
}

/* ================ REALTIME LISTENERS ================
  Listen for posts (top-level). For each rendered post we also attach listeners
  to likes and comments subcollections to show live counts and comment lists.
===================================================== */
function setupRealtimePosts() {
  const q = query(collection(db, 'posts'), orderBy('timestamp', 'desc'));
  onSnapshot(q, snapshot => {
    postsContainer.innerHTML = '';
    if(snapshot.empty) {
      postsContainer.innerHTML = '<div class="loading">No posts yet. Be the first to post!</div>';
      return;
    }
    snapshot.forEach(docSnap => {
      const postData = docSnap.data();
      renderPost(docSnap.id, postData);
    });
  }, error => {
    console.error('posts listener error', error);
    postsContainer.innerHTML = '<div class="error-message">Failed to load posts. Please refresh the page.</div>';
  });
}

/* ================ RENDERING ================== */
function escapeHtml(text) {
  if (!text) return '';
  const d = document.createElement('div');
  d.textContent = text;
  return d.innerHTML;
}

function formatTimestamp(ts) {
  if(!ts) return 'Just now';
  try {
    const d = ts.toDate();
    const now = new Date();
    const diff = now - d;
    const minutes = Math.floor(diff/60000); if(minutes < 1) return 'Just now';
    if(minutes < 60) return minutes + 'm ago';
    const hours = Math.floor(diff/3600000); if(hours < 24) return hours + 'h ago';
    const days = Math.floor(diff/86400000); if(days < 7) return days + 'd ago';
    return d.toLocaleDateString();
  } catch(e) {
    return 'Just now';
  }
}

function renderPost(postId, post) {
  // create container
  const postEl = document.createElement('div');
  postEl.className = 'post';
  postEl.dataset.postId = postId;

  // placeholder stats while listeners attach
  const likesCountId = `likes-count-${postId}`;
  const commentsWrapId = `comments-wrap-${postId}`;

  // build HTML (comments list will be populated by subcollection listener)
  postEl.innerHTML = `
    <div class="post-header">
      <div class="post-user" onclick="viewProfile('${post.userId}')">
        <div class="user-avatar">${post.userInitial || 'U'}</div>
        <div>
          <div class="user-name">${escapeHtml(post.userName || 'Anonymous')}</div>
          <div class="post-meta">${formatTimestamp(post.timestamp)} ‚Ä¢ ${post.privacy === 'public' ? 'üåç Public' : post.privacy === 'friends' ? 'üë• Friends' : 'üîí Only Me'}</div>
        </div>
      </div>
      ${ (auth.currentUser && auth.currentUser.uid === post.userId) ? `
        <div class="post-actions">
          <i class="fas fa-ellipsis-h" style="cursor:pointer" onclick="togglePostMenu('${postId}')"></i>
          <div class="post-menu" id="menu-${postId}">
            <div class="post-menu-item" onclick="editPost('${postId}')"><i class="fas fa-edit"></i> Edit</div>
            <div class="post-menu-item delete" onclick="confirmDeletePost('${postId}')"><i class="fas fa-trash"></i> Delete</div>
          </div>
        </div>` : ''}
    </div>

    <div class="post-content">${escapeHtml(post.text || '')}</div>

    ${ post.media ? `<div class="post-media">${ /\.(mp4|mov|avi|webm)$/i.test(post.media) ? `<video controls><source src="${post.media}"></video>` : `<img src="${post.media}" loading="lazy">` }</div>` : '' }

    <div class="post-stats">
      <div id="${likesCountId}">0 likes ‚Ä¢ 0 comments</div>
    </div>

    <div class="post-interactions">
      <div class="interaction-btn" id="like-btn-${postId}" style="cursor:pointer"><i class="fas fa-thumbs-up"></i> Like</div>
      <div class="interaction-btn" onclick="focusComment('${postId}')"><i class="fas fa-comment"></i> Comment</div>
      <div class="interaction-btn" onclick="sharePost('${postId}')"><i class="fas fa-share"></i> Share</div>
    </div>

    <div class="comments-section">
      <div id="${commentsWrapId}"></div>
      <div class="comment-input">
        <div class="user-avatar" style="width:32px;height:32px;font-size:14px">${(auth.currentUser && auth.currentUser.displayName) ? auth.currentUser.displayName.charAt(0).toUpperCase() : 'U'}</div>
        <input type="text" id="comment-${postId}" placeholder="Write a comment...">
        <button class="send-comment-btn" id="send-comment-${postId}" title="Send"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  `;

  postsContainer.appendChild(postEl);

  // attach events
  document.getElementById(`like-btn-${postId}`).addEventListener('click', async () => {
    try { await likePost(postId); } catch(e){ console.error(e); showMessage('Failed to like.','error'); }
  });

  document.getElementById(`send-comment-${postId}`).addEventListener('click', async () => {
    const input = document.getElementById(`comment-${postId}`);
    const text = input.value.trim();
    if(!text) return;
    try {
      await addCommentToPost(postId, text);
      input.value = '';
    } catch(err){ console.error(err); showMessage('Failed to add comment.','error'); }
  });

  document.getElementById(`comment-${postId}`).addEventListener('keypress', async (e) => {
    if(e.key === 'Enter') {
      const text = e.target.value.trim();
      if(!text) return;
      try { await addCommentToPost(postId, text); e.target.value = ''; } catch(err){ console.error(err); showMessage('Failed to add comment.','error'); }
    }
  });

  // listen for likes subcollection changes
  const likesCol = collection(db, 'posts', postId, 'likes');
  const likesQ = query(likesCol, orderBy('timestamp','asc'));
  const unSubLikes = onSnapshot(likesQ, (snap)=> {
    const likes = snap.size; // number of docs
    const userHasLiked = snap.docs.some(d=> d.id === (auth.currentUser ? auth.currentUser.uid : null));
    const likeBtn = document.getElementById(`like-btn-${postId}`);
    if(likeBtn) {
      likeBtn.classList.toggle('active', userHasLiked);
    }
    const likesCountEl = document.getElementById(likesCountId);
    const commentsWrap = document.getElementById(commentsWrapId);
    // update the text; comments count will be updated by comments listener
    const prevText = likesCountEl ? likesCountEl.innerText : '';
    // get current comment count (if commentsWrap has children, use that)
    let commentCount = 0;
    if(commentsWrap) commentCount = commentsWrap.querySelectorAll('.comment').length;
    if(likesCountEl) likesCountEl.innerText = `${likes} likes ‚Ä¢ ${commentCount} comments`;
  });

  // listen for comments subcollection
  const commentsCol = collection(db, 'posts', postId, 'comments');
  const commentsQ = query(commentsCol, orderBy('timestamp','asc'));
  const unSubComments = onSnapshot(commentsQ, (snap)=> {
    const commentsWrap = document.getElementById(commentsWrapId);
    if(!commentsWrap) return;
    commentsWrap.innerHTML = '';
    snap.forEach(docSnap => {
      const c = docSnap.data();
      const commentHTML = `
        <div class="comment">
          <div class="user-avatar" style="width:32px;height:32px;font-size:14px">${c.userInitial || 'U'}</div>
          <div class="comment-content"><div style="font-weight:600;font-size:14px">${escapeHtml(c.userName || 'User')}</div><div>${escapeHtml(c.text)}</div></div>
        </div>
      `;
      commentsWrap.insertAdjacentHTML('beforeend', commentHTML);
    });
    // update likes/comments line text
    const likesCountEl = document.getElementById(likesCountId);
    const likesCountText = likesCountEl ? likesCountEl.innerText.split(' ‚Ä¢ ')[0] : '0 likes';
    if(likesCountEl) likesCountEl.innerText = `${likesCountText} ‚Ä¢ ${snap.size} comments`;
  });

  // Return unsub functions so we could call them if we want to detach listeners later
  return { unSubLikes, unSubComments };
}

/* ================ Helper utilities exposed to global for inline onclicks ================ */
window.viewProfile = (userId) => { window.location.href = `profile.html?userId=${userId}`; };
window.focusComment = (postId) => { const el = document.getElementById(`comment-${postId}`); if(el) el.focus(); };
window.sharePost = (postId) => { if(navigator.share){ navigator.share({title:'Check out this post on MEET', text:'Check this out', url:window.location.href}); } else showMessage('Post shared!','success'); };
window.togglePostMenu = (postId) => {
  document.querySelectorAll('.post-menu').forEach(m=>m.style.display='none');
  const menu = document.getElementById(`menu-${postId}`);
  if(menu) menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
};
window.editPost = (postId) => { showMessage('Edit feature coming soon!','success'); };
window.confirmDeletePost = async (postId) => {
  if(!confirm('Delete this post?')) return;
  try {
    await deleteDoc(doc(db, 'posts', postId));
    showMessage('Post deleted','success');
  } catch(e) { console.error(e); showMessage('Delete failed','error'); }
};

/* ================ Auth + initialization ================ */
onAuthStateChanged(auth, user => {
  if(!user) {
    // redirect to login if you want
    // window.location.href = 'login.html';
    showMessage('Not logged in. Redirecting to login...', 'error');
    setTimeout(()=>window.location.href='login.html',1000);
    return;
  }
  // populate UI
  const name = user.displayName || 'User';
  const initial = (name.charAt(0) || 'U').toUpperCase();
  currentUserAvatar.textContent = initial;
  currentUserAvatarComposer.textContent = initial;
  modalUserAvatar.textContent = initial;
  modalUserName.textContent = name;
  userNameEl.textContent = name;

  // load posts realtime
  setupRealtimePosts();
});

logoutBtn.addEventListener('click', async ()=> {
  try { await signOut(auth); window.location.href='login.html'; } catch(e){ console.error(e); showMessage('Logout failed','error'); }
});

/* ================ Compose modal + media preview + posting ================ */
openComposer.addEventListener('click', ()=> { postModal.style.display = 'flex'; });
closeModal.addEventListener('click', ()=> { postModal.style.display = 'none'; resetPostForm(); });

postMedia.addEventListener('change', function(e){
  const file = e.target.files[0];
  if(!file) return;
  if(file.size > MAX_FILE_SIZE){ showMessage('File too large.'); postMedia.value=''; return; }
  const reader = new FileReader();
  reader.onload = function(ev){
    const isVideo = file.type.startsWith('video/');
    mediaPreview.innerHTML = `
      ${isVideo ? `<video controls style="width:100%;max-height:300px"><source src="${ev.target.result}" type="${file.type}"></video>` : `<img src="${ev.target.result}" alt="Preview" style="width:100%;max-height:300px;object-fit:contain">`}
      <button class="remove-media" onclick="removeMedia()">&times;</button>
    `;
  };
  reader.readAsDataURL(file);
});

window.removeMedia = function(){ mediaPreview.innerHTML=''; postMedia.value=''; };
function resetPostForm(){ postText.value=''; removeMedia(); }

/* POST button */
postBtn.addEventListener('click', async () => {
  const text = postText.value.trim();
  const file = postMedia.files[0];
  const privacy = privacySelect.value;
  if(!text && !file){ showMessage('Please add text or media.','error'); return; }
  setLoading('postBtn', true);
  try {
    await createPost(text, file, privacy);
    resetPostForm();
    postModal.style.display = 'none';
    showMessage('Post created successfully!', 'success');
  } catch(err){
    console.error(err);
    showMessage(err.message || 'Failed to create post','error');
  } finally { setLoading('postBtn', false); }
});

/* ================ Initial theme ================ */
(function initTheme(){
  const saved = localStorage.getItem('meet_theme');
  if(saved === 'dark') document.body.classList.add('dark-mode');
  nightToggleBtn.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('meet_theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
  });
})();
</script>
</body>
            </html>
