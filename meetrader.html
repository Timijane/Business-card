<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Meetrader | Marketplace</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f5f5;
      margin: 0;
      color: #333;
    }
    .dark-mode { background: #121212; color: #eee; }
    header {
      background: #007bff;
      color: white;
      text-align: center;
      padding: 15px;
      font-size: 22px;
      font-weight: 600;
    }
    .container {
      max-width: 900px;
      margin: 20px auto;
      padding: 15px;
    }
    .post-form {
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 25px;
    }
    .post-form input, .post-form select, .post-form textarea {
      width: 100%;
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: inherit;
    }
    .post-form button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    .market-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }
    .item-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: 0.3s;
    }
    .item-card:hover { transform: scale(1.03); }
    .item-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }
    .item-info { padding: 10px; }
    .item-info h4 { margin: 0; font-size: 16px; font-weight: 600; }
    .item-info p { margin: 5px 0; font-size: 14px; }
    .theme-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    #preview {
      width: 100%;
      max-height: 200px;
      object-fit: cover;
      border-radius: 8px;
      display: none;
      margin-bottom: 10px;
    }
    #uploadProgress {
      width: 100%;
      background: #eee;
      border-radius: 5px;
      margin-bottom: 10px;
      display: none;
    }
    #uploadProgress div {
      height: 8px;
      width: 0%;
      background: #007bff;
      border-radius: 5px;
      transition: width 0.3s ease;
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>
  <header>üõçÔ∏è Meetrader Marketplace</header>

  <div class="container">
    <!-- Post Product Form -->
    <div class="post-form">
      <h3>Post a New Item</h3>
      <input type="text" id="title" placeholder="Product Title" required />
      <textarea id="description" placeholder="Description"></textarea>
      <input type="number" id="price" placeholder="Price" required />
      <select id="currency">
        <option value="NGN">NGN</option>
        <option value="USD">USD</option>
        <option value="EUR">EUR</option>
        <option value="GBP">GBP</option>
        <option value="CAD">CAD</option>
        <option value="INR">INR</option>
      </select>
      <input type="text" id="location" placeholder="Location" />
      <select id="category">
        <option value="Electronics">Electronics</option>
        <option value="Fashion">Fashion</option>
        <option value="Services">Services</option>
        <option value="Automobile">Automobile</option>
        <option value="Real Estate">Real Estate</option>
        <option value="Other">Other</option>
      </select>
      <input type="file" id="itemImage" accept="image/*" />
      <img id="preview" alt="Preview" />
      <div id="uploadProgress"><div></div></div>
      <button id="postItemBtn">Post Item</button>
    </div>

    <!-- Market Feed -->
    <div class="market-grid" id="marketGrid"></div>
  </div>

  <button class="theme-toggle" id="themeToggle"><i class="fas fa-moon"></i> Dark</button>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
      authDomain: "meet-6e159.firebaseapp.com",
      databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",
      projectId: "meet-6e159",
      storageBucket: "meet-6e159.firebasestorage.app",
      messagingSenderId: "252353608421",
      appId: "1:252353608421:web:6706056048e9a8f12db20c",
      measurementId: "G-9BFPPVMMRF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Cloudinary Setup
    const CLOUD_NAME = "dcwof2ngn";
    const UPLOAD_PRESET = "Meet-profile";

    // Preview selected image
    document.getElementById("itemImage").addEventListener("change", (e) => {
      const file = e.target.files[0];
      const preview = document.getElementById("preview");
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          preview.src = ev.target.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else {
        preview.style.display = "none";
      }
    });

    // Upload file to Cloudinary (unsigned)
    async function uploadToCloudinary(file) {
      return new Promise((resolve, reject) => {
        const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`;
        const xhr = new XMLHttpRequest();
        const progressBar = document.querySelector("#uploadProgress");
        const progressFill = progressBar.querySelector("div");
        progressBar.style.display = "block";
        progressFill.style.width = "0%";

        xhr.open("POST", url);
        xhr.upload.addEventListener("progress", (e) => {
          if (e.lengthComputable) {
            const percent = (e.loaded / e.total) * 100;
            progressFill.style.width = percent + "%";
          }
        });
        xhr.onload = () => {
          if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            progressBar.style.display = "none";
            resolve(response.secure_url);
          } else reject("Upload failed");
        };
        xhr.onerror = () => reject("Upload error");

        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", UPLOAD_PRESET);
        xhr.send(formData);
      });
    }

    // Post item
    document.getElementById("postItemBtn").addEventListener("click", async () => {
      const file = document.getElementById("itemImage").files[0];
      const title = document.getElementById("title").value.trim();
      const description = document.getElementById("description").value.trim();
      const price = document.getElementById("price").value.trim();
      const currency = document.getElementById("currency").value;
      const location = document.getElementById("location").value.trim();
      const category = document.getElementById("category").value;

      if (!file || !title || !price) {
        alert("Please fill all required fields and select an image.");
        return;
      }

      try {
        const imageUrl = await uploadToCloudinary(file);
        await db.collection("marketItems").add({
          title,
          description,
          price,
          currency,
          location,
          category,
          imageUrl,
          userId: auth.currentUser ? auth.currentUser.uid : "guest",
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert("‚úÖ Item posted successfully!");
        document.querySelector(".post-form").reset();
        document.getElementById("preview").style.display = "none";
      } catch (err) {
        alert("‚ùå Upload failed: " + err);
      }
    });

    // Real-time market updates
    function loadItemsRealtime() {
      const grid = document.getElementById("marketGrid");
      grid.innerHTML = "<p>Loading...</p>";

      db.collection("marketItems")
        .orderBy("createdAt", "desc")
        .onSnapshot(snapshot => {
          grid.innerHTML = "";
          snapshot.forEach(doc => {
            const data = doc.data();
            const card = `
              <div class="item-card">
                <img src="${data.imageUrl}" alt="${data.title}">
                <div class="item-info">
                  <h4>${data.title}</h4>
                  <p>${data.currency}${data.price}</p>
                  <p>${data.category} ‚Ä¢ ${data.location || "N/A"}</p>
                </div>
              </div>`;
            grid.innerHTML += card;
          });
        });
    }

    loadItemsRealtime();

    // Theme toggle
    document.getElementById("themeToggle").addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
    });
  </script>
</body>
</html>
