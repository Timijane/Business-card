<script type="module">
  // Import Firebase modules
  import { 
    getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDoc, getDocs, onSnapshot, serverTimestamp, 
    query, orderBy, where, setDoc
  } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
    authDomain: "meet-6e159.firebaseapp.com",
    databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",
    projectId: "meet-6e159",
    storageBucket: "meet-6e159.firebasestorage.app",
    messagingSenderId: "252353608421",
    appId: "1:252353608421:web:6706056048e9a8f12db20c",
    measurementId: "G-9BFPPVMMRF"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  // DOM Elements
  const meetraderItems = document.getElementById('meetraderItems');
  const emptyState = document.getElementById('emptyState');
  const filterBtn = document.getElementById('filterBtn');
  const meetraderFilters = document.getElementById('meetraderFilters');
  const closeFilters = document.getElementById('closeFilters');
  const applyFilters = document.getElementById('applyFilters');
  const postItemBtn = document.getElementById('postItemBtn');
  const postItemModal = document.getElementById('postItemModal');
  const closePostItemModal = document.getElementById('closePostItemModal');
  const cancelPostItem = document.getElementById('cancelPostItem');
  const postItemForm = document.getElementById('postItemForm');
  const imageUpload = document.getElementById('imageUpload');
  const itemImage = document.getElementById('itemImage');
  const imagePreview = document.getElementById('imagePreview');
  const previewImage = document.getElementById('previewImage');
  const searchInput = document.getElementById('searchInput');
  const logoutBtn = document.getElementById('logoutBtn');
  const nightToggleBtn = document.getElementById('nightToggleBtn');
  const currentUserAvatar = document.getElementById('currentUserAvatar');
  const userName = document.getElementById('userName');
  const messageContainer = document.getElementById('messageContainer');

  // State
  let currentUser = null;
  let items = [];
  let filteredItems = [];
  let selectedImageFile = null;

  // Currency symbols
  const currencySymbols = {
    'USD': '$',
    'EUR': '€',
    'GBP': '£',
    'CAD': '$',
    'AUD': '$',
    'JPY': '¥',
    'CNY': '¥',
    'INR': '₹',
    'NGN': '₦',
    'GHS': '₵',
    'KES': 'KSh',
    'ZAR': 'R'
  };

  // Theme management
  function initTheme() {
    const savedTheme = localStorage.getItem('meet_theme');
    if (savedTheme === 'dark') {
      document.body.classList.add('dark-mode');
      nightToggleBtn.innerHTML = '<i class="fas fa-sun"></i> <span>Day Mode</span>';
    } else {
      document.body.classList.remove('dark-mode');
      nightToggleBtn.innerHTML = '<i class="fas fa-moon"></i> <span>Night Mode</span>';
    }
  }

  // Message display
  function showMessage(message, type = 'error') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    messageDiv.textContent = message;
    messageContainer.appendChild(messageDiv);
    
    setTimeout(() => {
      if (messageDiv.parentNode) {
        messageDiv.parentNode.removeChild(messageDiv);
      }
    }, 5000);
  }

  // Get user profile data
  async function getUserProfile(userId) {
    try {
      const userDoc = await getDoc(doc(db, "users", userId));
      if (userDoc.exists()) {
        return userDoc.data();
      }
      return null;
    } catch (error) {
      console.error('Error getting user profile:', error);
      return null;
    }
  }

  // Upload image to Firebase Storage
  async function uploadImage(file, userId) {
    try {
      // Create a unique filename
      const timestamp = Date.now();
      const filename = `meetrader/${userId}/${timestamp}_${file.name}`;
      
      // Create storage reference
      const storageRef = ref(storage, filename);
      
      // Upload the file
      const snapshot = await uploadBytes(storageRef, file);
      
      // Get the download URL
      const downloadURL = await getDownloadURL(snapshot.ref);
      
      return downloadURL;
    } catch (error) {
      console.error('Error uploading image:', error);
      throw new Error('Failed to upload image');
    }
  }

  // CREATE ITEM - FIXED VERSION WITH IMAGE UPLOAD
  async function createItem(itemData, imageFile) {
    const user = auth.currentUser;
    if (!user) throw new Error("Please login first!");

    // Get user profile data
    const userProfile = await getUserProfile(user.uid);
    const userName = user.displayName || userProfile?.name || "Anonymous";
    const userInitial = userName.charAt(0).toUpperCase();

    let imageUrl = 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'; // Default image
    
    // Upload image if provided
    if (imageFile) {
      try {
        imageUrl = await uploadImage(imageFile, user.uid);
      } catch (error) {
        console.error('Image upload failed, using default image:', error);
        // Continue with default image
      }
    }

    // Create the item in Firestore
    const docRef = await addDoc(collection(db, "meetrader"), {
      userId: user.uid,
      userName: userName,
      userInitial: userInitial,
      title: itemData.title,
      price: parseFloat(itemData.price),
      currency: itemData.currency,
      location: itemData.location,
      description: itemData.description,
      category: itemData.category,
      condition: itemData.condition,
      image: imageUrl,
      timestamp: serverTimestamp(),
      likes: 0,
      status: 'active'
    });

    return docRef.id;
  }

  // TOGGLE LIKE
  async function toggleLike(itemId) {
    const user = auth.currentUser;
    if (!user) return;

    const itemRef = doc(db, "meetrader", itemId);
    const likeRef = doc(db, "meetrader", itemId, "likes", user.uid);
    
    try {
      const likeSnap = await getDoc(likeRef);
      
      if (likeSnap.exists()) {
        // Unlike: remove the like document and decrement likes count
        await deleteDoc(likeRef);
        const itemDoc = await getDoc(itemRef);
        if (itemDoc.exists()) {
          await updateDoc(itemRef, {
            likes: (itemDoc.data().likes || 1) - 1
          });
        }
      } else {
        // Like: create a like document and increment likes count
        await setDoc(likeRef, {
          userId: user.uid,
          timestamp: serverTimestamp()
        });
        const itemDoc = await getDoc(itemRef);
        if (itemDoc.exists()) {
          await updateDoc(itemRef, {
            likes: (itemDoc.data().likes || 0) + 1
          });
        }
      }
    } catch (error) {
      console.error('Error toggling like:', error);
      showMessage('Failed to update like. Please try again.');
    }
  }

  // DELETE ITEM
  async function deleteItem(itemId) {
    if (!confirm('Are you sure you want to delete this item?')) return;
    
    try {
      await deleteDoc(doc(db, "meetrader", itemId));
      showMessage('Item deleted successfully!', 'success');
    } catch (error) {
      console.error('Error deleting item:', error);
      showMessage('Failed to delete item. Please try again.');
    }
  }

  // Authentication state listener
  onAuthStateChanged(auth, async user => {
    if (!user) {
      window.location.href = 'login.html';
    } else {
      currentUser = user;
      // Update user info in UI
      const userNameText = user.displayName || 'User';
      const userInitial = userNameText.charAt(0).toUpperCase();
      
      currentUserAvatar.textContent = userInitial;
      userName.textContent = userNameText;
      
      setupRealTimeListener();
    }
  });

  // Setup real-time listener for items
  const setupRealTimeListener = () => {
    const itemsQuery = query(collection(db, "meetrader"), orderBy("timestamp", "desc"));
    
    onSnapshot(itemsQuery, (snapshot) => {
      items = [];
      snapshot.docs.forEach((doc) => {
        const item = doc.data();
        // Convert Firestore timestamp to Date if it exists
        const timestamp = item.timestamp ? item.timestamp.toDate() : new Date();
        items.push({
          id: doc.id,
          ...item,
          timestamp: timestamp
        });
      });
      
      filteredItems = [...items];
      renderItems();
    }, error => {
      console.error('Real-time listener error:', error);
      showMessage('Failed to load items. Please refresh the page.');
    });
  };

  // Render items
  function renderItems() {
    if (filteredItems.length === 0) {
      meetraderItems.style.display = 'none';
      emptyState.style.display = 'block';
      return;
    }
    
    meetraderItems.style.display = 'grid';
    emptyState.style.display = 'none';
    
    meetraderItems.innerHTML = '';
    
    filteredItems.forEach(item => {
      const itemCard = document.createElement('div');
      itemCard.className = 'item-card';
      
      const currencySymbol = currencySymbols[item.currency] || item.currency;
      const isOwner = currentUser && currentUser.uid === item.userId;
      
      itemCard.innerHTML = `
        <img src="${item.image}" alt="${item.title}" class="item-image" onerror="this.src='https://images.unsplash.com/photo-1560472354-b33ff0c44a43?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'">
        <div class="item-details">
          <div class="item-header">
            <h3 class="item-title">${item.title}</h3>
            <div class="item-price">${currencySymbol}${item.price}</div>
          </div>
          <p class="item-description">${item.description}</p>
          <div class="item-location">
            <i class="fas fa-map-marker-alt"></i> ${item.location}
          </div>
          <div class="item-footer">
            <div class="item-seller">
              <div class="seller-avatar">${item.userInitial}</div>
              <span class="seller-name">${item.userName}</span>
            </div>
            <div class="item-actions">
              <button class="action-btn like-btn" data-id="${item.id}" title="Like">
                <i class="fas fa-heart"></i>
              </button>
              <button class="action-btn message-btn" data-id="${item.id}" title="Message Seller">
                <i class="fas fa-comment"></i>
              </button>
              ${isOwner ? `
                <button class="action-btn delete-btn" data-id="${item.id}" title="Delete Item">
                  <i class="fas fa-trash"></i>
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      `;
      
      meetraderItems.appendChild(itemCard);
    });
    
    // Add event listeners
    document.querySelectorAll('.like-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const itemId = e.currentTarget.getAttribute('data-id');
        toggleLike(itemId);
      });
    });
    
    document.querySelectorAll('.message-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const itemId = e.currentTarget.getAttribute('data-id');
        messageSeller(itemId);
      });
    });
    
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const itemId = e.currentTarget.getAttribute('data-id');
        deleteItem(itemId);
      });
    });
  }

  // Message seller
  function messageSeller(itemId) {
    const item = items.find(i => i.id === itemId);
    if (!item) return;
    
    showMessage(`Would open chat with ${item.userName} about "${item.title}"`, 'success');
  }

  // Initialize
  function initMeetrader() {
    setupEventListeners();
    initTheme();
  }

  // Setup event listeners
  function setupEventListeners() {
    // Theme toggle
    nightToggleBtn.addEventListener('click', () => {
      if (document.body.classList.contains('dark-mode')) {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('meet_theme', 'light');
        nightToggleBtn.innerHTML = '<i class="fas fa-moon"></i> <span>Night Mode</span>';
      } else {
        document.body.classList.add('dark-mode');
        localStorage.setItem('meet_theme', 'dark');
        nightToggleBtn.innerHTML = '<i class="fas fa-sun"></i> <span>Day Mode</span>';
      }
    });

    // Logout functionality
    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
        window.location.href = 'login.html';
      } catch (error) {
        console.error('Logout error:', error);
        showMessage('Failed to logout. Please try again.');
      }
    });

    // Filter button
    filterBtn.addEventListener('click', () => {
      meetraderFilters.style.display = 'block';
    });

    // Close filters
    closeFilters.addEventListener('click', () => {
      meetraderFilters.style.display = 'none';
    });

    // Apply filters
    applyFilters.addEventListener('click', applyFiltersHandler);

    // Post item button
    postItemBtn.addEventListener('click', openPostItemModal);

    // Close post item modal
    closePostItemModal.addEventListener('click', closePostItemModalHandler);
    cancelPostItem.addEventListener('click', closePostItemModalHandler);
    postItemModal.addEventListener('click', (e) => {
      if (e.target === postItemModal) {
        closePostItemModalHandler();
      }
    });

    // Post item form
    postItemForm.addEventListener('submit', submitItemForm);

    // Image upload
    imageUpload.addEventListener('click', () => {
      itemImage.click();
    });
    itemImage.addEventListener('change', handleImageUpload);

    // Search
    searchInput.addEventListener('input', handleSearch);
  }

  // Apply filters
  function applyFiltersHandler() {
    const category = document.getElementById('categoryFilter').value;
    const location = document.getElementById('locationFilter').value.toLowerCase();
    const minPrice = document.getElementById('minPrice').value;
    const maxPrice = document.getElementById('maxPrice').value;
    const condition = document.getElementById('conditionFilter').value;
    
    filteredItems = items.filter(item => {
      // Category filter
      if (category && item.category !== category) return false;
      
      // Location filter
      if (location && !item.location.toLowerCase().includes(location)) return false;
      
      // Price filter
      if (minPrice && item.price < parseFloat(minPrice)) return false;
      if (maxPrice && item.price > parseFloat(maxPrice)) return false;
      
      // Condition filter
      if (condition && item.condition !== condition) return false;
      
      return true;
    });
    
    renderItems();
    meetraderFilters.style.display = 'none';
  }

  // Open post item modal
  function openPostItemModal() {
    postItemModal.style.display = 'flex';
  }

  // Close post item modal
  function closePostItemModalHandler() {
    postItemModal.style.display = 'none';
    postItemForm.reset();
    imagePreview.style.display = 'none';
    selectedImageFile = null;
  }

  // Handle image upload
  function handleImageUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // Check file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
      showMessage('File size too large. Please choose an image smaller than 5MB.');
      return;
    }
    
    // Check file type
    if (!file.type.startsWith('image/')) {
      showMessage('Please select a valid image file.');
      return;
    }
    
    selectedImageFile = file;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      previewImage.src = e.target.result;
      imagePreview.style.display = 'block';
    };
    reader.readAsDataURL(file);
  }

  // Submit item form - FIXED VERSION
  async function submitItemForm(e) {
    e.preventDefault();
    
    // Get form values
    const title = document.getElementById('itemTitle').value.trim();
    const price = document.getElementById('itemPrice').value;
    const currency = document.getElementById('itemCurrency').value;
    const location = document.getElementById('itemLocation').value.trim();
    const category = document.getElementById('itemCategory').value;
    const condition = document.getElementById('itemCondition').value;
    const description = document.getElementById('itemDescription').value.trim();
    
    // Validate form
    if (!title || !price || !location || !category || !description) {
      showMessage('Please fill in all required fields.');
      return;
    }
    
    if (parseFloat(price) <= 0) {
      showMessage('Please enter a valid price.');
      return;
    }
    
    // Show loading state
    const submitBtn = postItemForm.querySelector('.submit-btn');
    const originalText = submitBtn.textContent;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Posting...';
    submitBtn.disabled = true;
    
    try {
      // Create item data
      const itemData = {
        title,
        price: parseFloat(price),
        currency,
        location,
        description,
        category,
        condition
      };
      
      // Create the item in Firebase
      await createItem(itemData, selectedImageFile);
      
      // Success
      showMessage('Item posted successfully!', 'success');
      closePostItemModalHandler();
      
    } catch (error) {
      console.error('Error posting item:', error);
      showMessage(error.message || 'Failed to post item. Please try again.');
    } finally {
      // Reset button state
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }
  }

  // Handle search
  function handleSearch() {
    const query = searchInput.value.toLowerCase().trim();
    
    if (!query) {
      filteredItems = [...items];
    } else {
      filteredItems = items.filter(item => 
        item.title.toLowerCase().includes(query) ||
        item.description.toLowerCase().includes(query) ||
        item.location.toLowerCase().includes(query) ||
        item.userName.toLowerCase().includes(query)
      );
    }
    
    renderItems();
  }

  // Initialize meetrader when page loads
  document.addEventListener('DOMContentLoaded', initMeetrader);
</script>
