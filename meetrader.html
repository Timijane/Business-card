<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Meetrader</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  /* --- CORE STYLES (MATCHING FEED) --- */
  :root {
    --primary: #0080FF;
    --primary-dark: #0066CC;
    --error: #EF4444;
    --success: #10B981;
    --warning: #F59E0B;
    --bg-color: #f0f2f5;
    --card-bg: #fff;
    --text-color: #111;
    --secondary-text: #65676b;
    --border-color: #dddfe2;
  }

  body.dark-mode {
    --bg-color: #18191a;
    --card-bg: #242526;
    --text-color: #e4e6eb;
    --secondary-text: #b0b3b8;
    --border-color: #3e4042;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; overflow-x: hidden; font-size: 18px; }
  body { font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-color); transition: all 0.3s ease; min-height: 100vh; }
  .app-container { display: flex; min-height: 100vh; position: relative; }

  /* --- SIDEBAR (MATCHING FEED) --- */
  .sidebar { position: fixed; left: 0; top: 0; height: 100vh; width: 180px; background: linear-gradient(180deg, #0080FF 0%, #00C6FF 100%); border-right: 1px solid var(--border-color); overflow-y: auto; z-index: 100; padding: 15px; color: white; }
  .sidebar-header { padding: 5px 0 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); margin-bottom: 15px; }
  .sidebar-menu { list-style: none; }
  .sidebar-menu li { margin-bottom: 6px; }
  .sidebar-menu a { display: flex; align-items: center; padding: 10px; text-decoration: none; color: white; border-radius: 8px; transition: background 0.3s; min-height: 40px; font-size: 16px; }
  .sidebar-menu a:hover { background: rgba(255, 255, 255, 0.2); }
  .sidebar-menu i { margin-right: 10px; font-size: 18px; width: 22px; text-align: center; }
  
  /* Sidebar Icons Specific Colors */
  .sidebar-menu a[href="feed.html"] i { color: #fff; }
  .sidebar-menu a[onclick*="viewProfile"] i { color: #f4d03f; }
  .sidebar-menu a[href="chat.html"] i { color: #4CAF50; }
  .sidebar-menu a[href="meetrader.html"] i { color: #FF5722; }
  .sidebar-menu a[href="meetversity.html"] i { color: #9C27B0; }
  .sidebar-menu a[href="organization.html"] i { color: #00BCD4; }
  .sidebar-menu a[onclick*="openUsersModal"] i { color: #e91e63; }

  .main-content { flex: 1; margin-left: 180px; padding: 15px; min-height: 100vh; font-size: 18px; }

  /* --- NAVBAR (MATCHING FEED) --- */
  .navbar { background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%); padding: 10px 15px; border-radius: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1); color: white; flex-wrap: wrap; gap: 8px; }
  .nav-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .search-bar { display: flex; align-items: center; background: rgba(255, 255, 255, 0.2); border-radius: 20px; padding: 6px 12px; margin-right: 10px; }
  .search-bar input { background: transparent; border: none; color: white; outline: none; width: 180px; font-size: 16px; }
  .search-bar input::placeholder { color: rgba(255, 255, 255, 0.7); }
  
  .user-profile-nav { display: flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 20px; background: rgba(255, 255, 255, 0.2); cursor: pointer; position: relative; min-height: 36px; }
  .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; position: relative; min-width: 36px; font-size: 16px; overflow: hidden; }
  .user-avatar.small { width: 28px; height: 28px; font-size: 14px; min-width: 28px; }
  .user-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
  
  .btn { background: rgba(255, 255, 255, 0.2); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.3s; display: flex; align-items: center; gap: 6px; font-size: 16px; min-height: 36px; }
  .btn i { font-size: 18px; }
  #notificationsBtn i { color: #FFC107; }
  #nightToggleBtn i { color: #9C27B0; }
  #logoutBtn i { color: #EF4444; }
  .btn:hover { background: rgba(255, 255, 255, 0.3); }
  .unread-badge { background: var(--error); color: white; border-radius: 50%; padding: 2px 5px; font-size: 10px; display: none; min-width: 16px; justify-content: center; align-items: center; }

  /* --- MEETRADER SPECIFIC STYLES --- */
  
  /* Filters */
  .filters-container {
    background: var(--card-bg);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: center;
  }

  .filter-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 150px; }
  .filter-label { font-size: 14px; color: var(--secondary-text); font-weight: 600; }
  .filter-select, .filter-input { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); outline: none; font-size: 15px; }
  .filter-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; height: 40px; align-self: flex-end; }

  /* Grid & Cards */
  .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
  .product-card { background: var(--card-bg); border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.3s; display: flex; flex-direction: column; position: relative; }
  .product-card:hover { transform: translateY(-5px); }

  /* Instagram-style Image Slider */
  .ad-carousel { position: relative; width: 100%; height: 250px; background: #000; overflow: hidden; }
  
  .ad-images-container { display: flex; width: 100%; height: 100%; transition: transform 0.3s ease-in-out; }
  .ad-img { min-width: 100%; width: 100%; height: 100%; object-fit: cover; }

  /* Counter Badge (1/3) */
  .ad-counter { position: absolute; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.6); color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; z-index: 10; }

  /* Navigation Arrows */
  .ad-nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255, 255, 255, 0.8); color: #333; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; opacity: 0.7; transition: opacity 0.2s; }
  .ad-nav-btn:hover { opacity: 1; background: white; }
  .ad-prev { left: 10px; }
  .ad-next { right: 10px; }

  /* Card Details */
  .product-details { padding: 15px; flex: 1; display: flex; flex-direction: column; }
  .product-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
  .product-title { font-weight: 700; font-size: 18px; color: var(--text-color); }
  .product-price { color: var(--success); font-weight: 700; font-size: 18px; }
  .product-seller { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-size: 14px; color: var(--secondary-text); }
  .product-desc { font-size: 14px; color: var(--secondary-text); margin-bottom: 15px; flex: 1; line-height: 1.4; }
  .product-actions { display: flex; gap: 10px; margin-top: auto; }
  .action-btn-product { flex: 1; padding: 8px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 6px; }
  .btn-msg { background: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); }
  .btn-buy { background: var(--primary); color: white; }

  /* Loading & Modals */
  .loading { text-align: center; padding: 20px; color: var(--secondary-text); width: 100%; }
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 15px; }
  .modal-content { background: var(--card-bg); border-radius: 10px; width: 450px; max-width: 90%; max-height: 85vh; overflow-y: auto; }
  .modal-header { padding: 14px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
  .modal-body { padding: 14px; }
  .close-modal { background: none; border: none; font-size: 22px; cursor: pointer; color: var(--secondary-text); }
  
  /* Notification List */
  .notif-item { padding: 10px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 16px; }
  .notif-unread { background: #f0f9ff; }
  .notif-actions { display: flex; gap: 8px; }
  .notif-btn { cursor: pointer; color: var(--secondary-text); font-size: 13px; }
  
  /* User List */
  .user-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border-color); margin-bottom: 8px; }
  .association-btn { padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; }
  .associate-btn { background: var(--primary); color: white; }
  .disassociate-btn { background: var(--error); color: white; }

  /* Responsive */
  @media (max-width: 768px) {
    .sidebar { width: 60px; padding: 8px 4px; }
    .sidebar-header { display: none; }
    .sidebar-menu a { flex-direction: column; padding: 8px 4px; font-size: 12px; text-align: center; }
    .sidebar-menu i { margin-right: 0; margin-bottom: 4px; font-size: 18px; }
    .main-content { margin-left: 60px; padding: 8px; width: calc(100% - 60px); }
    .navbar { flex-direction: column; align-items: flex-start; gap: 10px; }
    .search-bar, .user-profile-nav span, .btn span { display: none; }
    .nav-controls { width: 100%; justify-content: space-between; }
    .filters-container { flex-direction: column; align-items: stretch; }
    .filter-btn { width: 100%; }
  }
</style>
</head>
<body>

<div class="app-container">
  <div class="sidebar">
    <div class="sidebar-header">
      <h2 style="color: white; font-size: 20px;">MEET</h2>
    </div>
    <ul class="sidebar-menu">
      <li><a href="feed.html"><i class="fas fa-home"></i> <span>Feed</span></a></li>
      <li><a href="#" onclick="viewProfile(auth.currentUser.uid)"><i class="fas fa-user"></i> <span>Profile</span></a></li>
      <li><a href="chat.html"><i class="fas fa-comment"></i> <span>Chat</span></a></li>
      <li><a href="meetrader.html"><i class="fas fa-chart-line"></i> <span>Meetrader</span></a></li>
      <li><a href="meetversity.html"><i class="fas fa-graduation-cap"></i> <span>Meetversity</span></a></li>
      <li><a href="organization.html"><i class="fas fa-sitemap"></i> <span>Organization</span></a></li>
      <li><a href="#" onclick="openUsersModal()"><i class="fas fa-users"></i> <span>Find Associates</span></a></li>
    </ul>
  </div>

  <div class="main-content">
    <div class="navbar">
      <h2 style="color: white; font-size: 20px;">Meetrader</h2>
      <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px;">
        <div class="search-bar">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Search...">
        </div>
        <div class="nav-controls">
          <div class="user-profile-nav" onclick="viewProfile(auth.currentUser.uid)">
            <div class="user-avatar small" id="currentUserAvatar">U</div>
            <span id="userName" style="font-size: 15px;">User</span>
          </div>
          <button class="btn" id="notificationsBtn" onclick="openNotificationsModal()">
            <i class="fas fa-bell"></i> <span style="font-size: 15px;">Notifications</span>
            <span class="unread-badge" id="unreadBadge"></span>
          </button>
          <button class="btn" id="nightToggleBtn">
            <i class="fas fa-moon"></i> <span style="font-size: 15px;">Night Mode</span>
          </button>
          <button class="btn" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i> <span style="font-size: 15px;">Logout</span>
          </button>
        </div>
      </div>
    </div>

    <div class="filters-container">
      <div class="filter-group">
        <label class="filter-label">Keywords</label>
        <input type="text" class="filter-input" id="filterKeywords" placeholder="e.g. MacBook, Shoes...">
      </div>
      <div class="filter-group">
        <label class="filter-label">Category</label>
        <select class="filter-select" id="filterCategory">
          <option value="all">All Categories</option>
          <option value="electronics">Electronics</option>
          <option value="fashion">Fashion</option>
          <option value="home">Home & Living</option>
          <option value="services">Services</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">Max Price</label>
        <input type="number" class="filter-input" id="filterPrice" placeholder="Any price">
      </div>
      <button class="filter-btn" onclick="applyFilters()">Filter Results</button>
    </div>

    <div class="products-grid" id="productsContainer">
      <div class="loading">Loading ads...</div>
    </div>

  </div>
</div>

<div class="modal" id="notificationsModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="font-size: 18px;">Notifications</h3>
      <button class="close-modal" id="closeNotificationsModal">&times;</button>
    </div>
    <div class="modal-body">
      <div id="notificationsList"></div>
    </div>
  </div>
</div>

<div class="modal" id="usersModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="font-size: 18px;">Find Associates</h3>
      <button class="close-modal" id="closeUsersModal">&times;</button>
    </div>
    <div class="modal-body">
      <div id="usersList"><div class="loading">Loading users...</div></div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { 
    getFirestore, collection, doc, getDoc, getDocs, 
    onSnapshot, query, where, orderBy, updateDoc, deleteDoc, setDoc, serverTimestamp 
  } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
    authDomain: "meet-6e159.firebaseapp.com",
    databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",
    projectId: "meet-6e159",
    storageBucket: "meet-6e159-firebasestorage.app",
    messagingSenderId: "252353608421",
    appId: "1:252353608421:web:6706056048e9a8f12db20c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let currentUser = null;
  const userCache = {};

  // MOCK DATA FOR ADS (Demonstrating Carousel & Filtering)
  const mockAds = [
    {
      id: 1,
      title: "MacBook Pro M1",
      price: "$950",
      rawPrice: 950,
      category: "electronics",
      seller: "TechGuy",
      desc: "Perfect condition. Battery 95%.",
      images: [
        "https://images.unsplash.com/photo-1517336714731-489689fd1ca4?auto=format&fit=crop&w=500&q=60",
        "https://images.unsplash.com/photo-1611186871348-640e0479d00b?auto=format&fit=crop&w=500&q=60",
        "https://images.unsplash.com/photo-1525547719571-a2d4ac8945e2?auto=format&fit=crop&w=500&q=60"
      ]
    },
    {
      id: 2,
      title: "Vintage Denim Jacket",
      price: "$45",
      rawPrice: 45,
      category: "fashion",
      seller: "Fashionista",
      desc: "Size M, authentic 90s vintage.",
      images: [
        "https://images.unsplash.com/photo-1559551409-dadc959f76b8?auto=format&fit=crop&w=500&q=60",
        "https://images.unsplash.com/photo-1551537482-f2075a1d41f2?auto=format&fit=crop&w=500&q=60"
      ]
    },
    {
      id: 3,
      title: "Modern Sofa Set",
      price: "$300",
      rawPrice: 300,
      category: "home",
      seller: "HomeDecor",
      desc: "Grey 3-seater sofa. Pickup only.",
      images: [
        "https://images.unsplash.com/photo-1555041469-a586c61ea9bc?auto=format&fit=crop&w=500&q=60"
      ]
    },
    {
      id: 4,
      title: "Web Design Service",
      price: "$50/hr",
      rawPrice: 50,
      category: "services",
      seller: "CreativeMind",
      desc: "Professional websites and branding.",
      images: [
        "https://images.unsplash.com/photo-1626785774573-4b799315545d?auto=format&fit=crop&w=500&q=60",
        "https://images.unsplash.com/photo-1572044162444-ad60f128bdea?auto=format&fit=crop&w=500&q=60"
      ]
    }
  ];

  // --- HELPER FUNCTIONS ---
  async function getUserDataWithCache(userId) {
    if (userCache[userId] && (Date.now() - userCache[userId].timestamp < 60000)) {
        return userCache[userId].data;
    }
    try {
      const docSnap = await getDoc(doc(db, "users", userId));
      if (docSnap.exists()) {
        const data = docSnap.data();
        userCache[userId] = { data, timestamp: Date.now() };
        return data;
      }
    } catch (e) { console.error(e); }
    return null;
  }

  function getAvatarHTML(photoURL, name, size = 'medium') {
    const initial = name ? name.charAt(0).toUpperCase() : 'U';
    const style = size === 'small' ? 'width:28px;height:28px;font-size:14px; min-width: 28px;' : 'width:36px;height:36px;font-size:16px; min-width: 36px;';
    if (photoURL) {
      return `<img src="${photoURL}" alt="${name}" style="${style} border-radius:50%; object-fit:cover;">`;
    }
    return `<div style="${style} background:var(--primary); color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold;">${initial}</div>`;
  }

  window.viewProfile = (targetId) => {
    if(!targetId) return;
    window.location.href = `profile.html?uid=${targetId}`;
  };

  // --- AUTH STATE CHANGE ---
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = 'login.html';
    } else {
      currentUser = user;
      const userData = await getUserDataWithCache(user.uid);
      const photo = userData?.photoURL || user.photoURL;
      const name = userData?.displayName || user.displayName || 'User';
      
      // Update Navbar User Info
      document.getElementById('currentUserAvatar').innerHTML = getAvatarHTML(photo, name, 'small');
      document.getElementById('userName').textContent = name;
      
      setupNotificationsCount();
      renderProducts(mockAds);
    }
  });

  // --- MEETRADER LOGIC ---

  // 1. Render Ads with Carousel
  function renderProducts(ads) {
    const container = document.getElementById('productsContainer');
    container.innerHTML = '';

    if(ads.length === 0) {
        container.innerHTML = '<div class="loading">No items found matching your filters.</div>';
        return;
    }

    ads.forEach(ad => {
        const hasMultiple = ad.images.length > 1;
        const card = document.createElement('div');
        card.className = 'product-card';
        
        // Create Image strip HTML
        let imagesHTML = '';
        ad.images.forEach(img => {
            imagesHTML += `<img src="${img}" class="ad-img" alt="${ad.title}">`;
        });

        card.innerHTML = `
            <div class="ad-carousel" id="carousel-${ad.id}" data-index="0" data-total="${ad.images.length}">
                <div class="ad-images-container" style="width: ${ad.images.length * 100}%">
                    ${imagesHTML}
                </div>
                ${hasMultiple ? `
                    <div class="ad-counter" id="counter-${ad.id}">1/${ad.images.length}</div>
                    <button class="ad-nav-btn ad-prev" onclick="slideImage(${ad.id}, -1)">&#10094;</button>
                    <button class="ad-nav-btn ad-next" onclick="slideImage(${ad.id}, 1)">&#10095;</button>
                ` : ''}
            </div>
            <div class="product-details">
                <div class="product-header">
                    <div class="product-title">${ad.title}</div>
                    <div class="product-price">${ad.price}</div>
                </div>
                <div class="product-seller">
                    <div class="seller-avatar" style="background:#ccc; width:24px; height:24px; border-radius:50%"></div>
                    <span>${ad.seller}</span>
                </div>
                <div class="product-desc">${ad.desc}</div>
                <div class="product-actions">
                    <button class="action-btn-product btn-msg"><i class="fas fa-comment"></i> Message</button>
                    <button class="action-btn-product btn-buy"><i class="fas fa-shopping-cart"></i> Buy Now</button>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
  }

  // 2. Carousel Slide Logic
  window.slideImage = (id, direction) => {
      const carousel = document.getElementById(`carousel-${id}`);
      const container = carousel.querySelector('.ad-images-container');
      const counter = document.getElementById(`counter-${id}`);
      
      let currentIndex = parseInt(carousel.dataset.index);
      const total = parseInt(carousel.dataset.total);
      
      let newIndex = currentIndex + direction;

      // Check bounds
      if (newIndex < 0) newIndex = 0;
      if (newIndex >= total) newIndex = total - 1;

      // Calculate translate percent: - (index * (100 / total items))%
      const percent = -(newIndex * (100 / total));
      container.style.transform = `translateX(${percent}%)`;

      // Update Counter (1/3, 2/3 etc)
      counter.innerText = `${newIndex + 1}/${total}`;
      
      // Update state
      carousel.dataset.index = newIndex;
  };

  // 3. Filtering Logic
  window.applyFilters = () => {
      const keyword = document.getElementById('filterKeywords').value.toLowerCase();
      const category = document.getElementById('filterCategory').value;
      const maxPrice = document.getElementById('filterPrice').value;

      const filtered = mockAds.filter(ad => {
          const matchesKeyword = ad.title.toLowerCase().includes(keyword) || ad.desc.toLowerCase().includes(keyword);
          const matchesCategory = category === 'all' || ad.category === category;
          const matchesPrice = !maxPrice || ad.rawPrice <= parseFloat(maxPrice);
          
          return matchesKeyword && matchesCategory && matchesPrice;
      });

      renderProducts(filtered);
  };

  // --- SHARED UI LOGIC (NOTIFICATIONS/MODALS) ---
  function setupNotificationsCount() {
    const q = query(collection(db, "notifications"), where("targetUserId", "==", currentUser.uid), where("read", "==", false));
    onSnapshot(q, (snap) => {
        const badge = document.getElementById('unreadBadge');
        if(!snap.empty) {
            badge.style.display = 'flex';
            badge.innerText = snap.size;
        } else {
            badge.style.display = 'none';
        }
    });
  }

  window.openNotificationsModal = () => {
    const modal = document.getElementById('notificationsModal');
    const list = document.getElementById('notificationsList');
    modal.style.display = 'flex';
    list.innerHTML = '<div class="loading">Loading...</div>';
    
    const q = query(collection(db, "notifications"), where("targetUserId", "==", currentUser.uid), orderBy("createdAt", "desc"));
    
    onSnapshot(q, (snap) => {
        list.innerHTML = '';
        if (snap.empty) {
            list.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">No notifications.</div>';
            return;
        }
        snap.forEach(d => {
            const n = d.data();
            const id = d.id;
            list.innerHTML += `
                <div class="notif-item ${!n.read ? 'notif-unread' : ''}">
                    <div style="flex:1;">
                        ${n.text}
                        <div style="font-size:12px; color:#888;">${n.createdAt?.toDate().toLocaleTimeString() || ''}</div>
                    </div>
                    <div class="notif-actions">
                        ${!n.read ? `<i class="fas fa-check notif-btn" title="Mark as read" onclick="markNotifRead('${id}')"></i>` : ''}
                        <i class="fas fa-trash notif-btn delete" title="Delete" onclick="deleteNotif('${id}')"></i>
                    </div>
                </div>
            `;
        });
    });
  };

  window.markNotifRead = async (id) => await updateDoc(doc(db, "notifications", id), { read: true });
  window.deleteNotif = async (id) => await deleteDoc(doc(db, "notifications", id));

  document.getElementById('closeNotificationsModal').onclick = () => document.getElementById('notificationsModal').style.display = 'none';
  document.getElementById('closeUsersModal').onclick = () => document.getElementById('usersModal').style.display = 'none';
  document.getElementById('nightToggleBtn').onclick = () => document.body.classList.toggle('dark-mode');
  document.getElementById('logoutBtn').onclick = () => signOut(auth);

  // Users Modal Logic
  window.openUsersModal = async () => {
    document.getElementById('usersModal').style.display = 'flex';
    const list = document.getElementById('usersList');
    list.innerHTML = '<div class="loading">Loading users...</div>';
    const snap = await getDocs(collection(db, "users"));
    let html = '';
    for (const userDoc of snap.docs) {
        if (userDoc.id === currentUser.uid) continue;
        const user = userDoc.data();
        const assocSnap = await getDoc(doc(db, `users/${currentUser.uid}/associates/${userDoc.id}`));
        const isAssoc = assocSnap.exists();
        html += `
          <div class="user-item">
             <div style="display:flex; align-items:center; gap:10px;">
                ${getAvatarHTML(user.photoURL, user.displayName, 'small')}
                <span onclick="viewProfile('${userDoc.id}')" style="cursor:pointer; font-weight:600;">${user.displayName || 'User'}</span>
             </div>
             <button class="association-btn ${isAssoc ? 'disassociate-btn' : 'associate-btn'}" 
                onclick="toggleAssociate('${userDoc.id}', ${isAssoc})">
                ${isAssoc ? 'Disassociate' : 'Associate'}
             </button>
          </div>
        `;
    }
    list.innerHTML = html;
  };
  
  window.toggleAssociate = async (targetId, isCurrentlyAssociated) => {
      try {
        if (isCurrentlyAssociated) {
            await deleteDoc(doc(db, `users/${currentUser.uid}/associates/${targetId}`));
            await deleteDoc(doc(db, `users/${targetId}/associatedWith/${currentUser.uid}`));
        } else {
            await setDoc(doc(db, `users/${currentUser.uid}/associates/${targetId}`), { timestamp: serverTimestamp() });
            await setDoc(doc(db, `users/${targetId}/associatedWith/${currentUser.uid}`), { followerId: currentUser.uid, timestamp: serverTimestamp() });
        }
        window.openUsersModal(); 
    } catch (e) { console.error(e); }
  };

  window.auth = auth;
</script>
</body>
</html>
