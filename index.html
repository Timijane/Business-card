<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MEET | Connect</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #0061FF;
  --primary-dark: #0050d4;
  --accent: #5AE4A8;
  --text-dark: #111827;
  --text-light: #6B7280;
  --surface: #ffffff;
  --error: #EF4444;
  --success: #10B981;
  --warning: #F59E0B;
  --border: #d1d5db;
}

/* === BASE LAYOUT === */
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  padding: 20px;
  animation: fadeIn 1s ease-in-out;
}

/* === LOGO AREA === */
.logo-container { ... /* keep your original CSS (omitted here for brevity) */ }

/* (I kept the same CSS blocks you provided - omitted here for brevity in this message)
   In the file below I include the full original CSS you provided plus the small additions:
   - .password-toggle:focus { outline: none; box-shadow: none; }
   - .password-toggle { -webkit-tap-highlight-color: transparent; } */

/* === PASSWORD TOGGLE FOCUS FIX === */
.password-toggle:focus {
  outline: none !important;
  box-shadow: none !important;
}

/* prevent iOS link/button highlight */
.password-toggle {
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}

/* rest of your CSS... */
.form-card { background: var(--surface); border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.15); padding: 2rem; width: 100%; max-width: 400px; margin-top: 2.5rem; text-align: center; animation: fadeUp 1.2s ease; }
.form-card h2 { margin-bottom: 1.5rem; color: var(--text-dark); }
.form-group { margin-bottom: 1rem; text-align: left; }
.form-label { display: block; margin-bottom: 0.5rem; color: var(--text-dark); font-weight: 600; font-size: 0.9rem; }
.input-wrapper { position: relative; }
.form-input { width: 100%; padding: 0.8rem; padding-right: 40px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; box-sizing: border-box; transition: all 0.3s; }
.form-input:focus { outline: 2px solid var(--primary); outline-offset: 2px; border-color: var(--primary); }
.form-input.error { border-color: var(--error); }
.password-toggle { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 1.1rem; color: var(--text-light); z-index: 2; padding: 0; transition: color 0.2s; outline: none; -webkit-user-select: none; user-select: none; }
.password-toggle:hover { color: var(--primary); }
select.form-input { appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'><path fill='%236B7280' d='M2 0L0 2h4zm0 5L0 3h4z'/></svg>"); background-repeat: no-repeat; background-position: right 0.7rem top 50%; background-size: 0.65rem auto; padding-right: 2.5rem; }
button { width: 100%; padding: 0.8rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background 0.3s; margin-top: 0.5rem; }
button:hover { background: var(--primary-dark); }
button:disabled { background: #9CA3AF; cursor: not-allowed; }
.toggle { font-size: 0.9rem; color: var(--text-light); margin-top: 0.8rem; }
.toggle a { color: var(--primary); text-decoration: none; font-weight: 600; cursor: pointer; }
.forgot-password { text-align: right; margin-top: 0.5rem; }
.forgot-password a { color: var(--primary); text-decoration: none; font-size: 0.9rem; }

/* spinner, messages, hints, animations (same as you had) */
.spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.message { padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem; text-align: left; }
.message.error { background: rgba(239, 68, 68, 0.1); color: var(--error); border: 1px solid rgba(239, 68, 68, 0.2); }
.message.success { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.2); }
.validation-hint { font-size: 0.8rem; margin-top: 0.25rem; color: var(--text-light); }
.validation-hint.error { color: var(--error); }
.validation-hint.success { color: var(--success); }
@keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} } @keyframes fadeUp { from {transform: translateY(40px); opacity: 0;} to {transform: translateY(0); opacity: 1;} } @keyframes moveUp { 0% {transform: translateY(50px); opacity: 0;} 100% {transform: translateY(0); opacity: 1;} } @keyframes pulse { 0%,100% {transform: scale(1); opacity: 1;} 50% {transform: scale(1.05); opacity: 0.9;} }
.form-loading { opacity: 0.7; pointer-events: none; }
</style>
</head>
<body>

<div class="logo-container">
  <div class="logo-icon">
    <div class="logo-stroke logo-black"></div>
    <div class="logo-stroke logo-white"></div>
    <div class="logo-stroke logo-yellow"></div>
    <div class="logo-stroke logo-brown"></div>
  </div>
  <div class="logo-text">MEET</div>
  <div class="tagline">Where People and Opportunity Connect</div>
</div>

<div class="form-card">
  <h2 id="formTitle">Login to MEET</h2>
  <div id="messageContainer"></div>

  <form id="loginForm">
    <div class="form-group">
      <label class="form-label" for="loginEmail">Email Address</label>
      <input type="email" id="loginEmail" class="form-input" placeholder="Enter your email" required autocomplete="email">
    </div>
    <div class="form-group">
      <label class="form-label" for="loginPassword">Password</label>
      <div class="input-wrapper">
        <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required autocomplete="current-password">
        <button type="button" class="password-toggle" id="loginPasswordToggle" aria-label="Toggle password visibility">üëÅÔ∏è</button>
      </div>
      <div class="forgot-password">
        <a id="forgotPasswordLink" href="#forgot">Forgot Password?</a>
      </div>
    </div>
    <button type="submit" id="loginBtn">
      <span id="loginText">Login</span>
      <span id="loginSpinner" class="spinner" style="display: none;"></span>
    </button>
    <div class="toggle">
      Don't have an account? <a id="showSignup" href="#signup">Sign up</a>
    </div>
  </form>

  <form id="signupForm" style="display: none;">
    <div class="form-group">
      <label class="form-label" for="signupFullName">Full Name</label>
      <input type="text" id="signupFullName" class="form-input" placeholder="Enter your full name" required autocomplete="name">
      <div id="fullNameHint" class="validation-hint"></div>
    </div>
    <div class="form-group">
      <label class="form-label" for="signupUsername">Username</label>
      <input type="text" id="signupUsername" class="form-input" placeholder="Choose a username (3-20 characters)" required>
      <div id="usernameHint" class="validation-hint"></div>
    </div>
    <div class="form-group">
      <label class="form-label" for="signupEmail">Email Address</label>
      <input type="email" id="signupEmail" class="form-input" placeholder="Enter your email" required autocomplete="email">
      <div id="emailHint" class="validation-hint"></div>
    </div>
    <div class="form-group">
      <label class="form-label" for="signupPhone">Phone Number</label>
      <input type="tel" id="signupPhone" class="form-input" placeholder="Enter your phone number" required>
      <div id="phoneHint" class="validation-hint"></div>
    </div>
    <div class="form-group">
      <label class="form-label" for="signupPassword">Password</label>
      <div class="input-wrapper">
        <input type="password" id="signupPassword" class="form-input" placeholder="Create a password (min. 8 characters)" required autocomplete="new-password">
        <button type="button" class="password-toggle" id="signupPasswordToggle" aria-label="Toggle password visibility">üëÅÔ∏è</button>
      </div>
      <div id="passwordHint" class="validation-hint">Must be at least 8 characters with uppercase, lowercase, and number</div>
    </div>
    <div class="form-group">
      <label class="form-label" for="signupConfirmPassword">Confirm Password</label>
      <div class="input-wrapper">
        <input type="password" id="signupConfirmPassword" class="form-input" placeholder="Confirm your password" required autocomplete="new-password">
        <button type="button" class="password-toggle" id="signupConfirmPasswordToggle" aria-label="Toggle password visibility">üëÅÔ∏è</button>
      </div>
      <div id="confirmPasswordHint" class="validation-hint"></div>
    </div>
    <div class="form-group">
      <label class="form-label" for="signupGender">Gender</label>
      <select id="signupGender" class="form-input" required>
        <option value="">Select your gender</option>
        <option value="male">Male</option>
        <option value="female">Female</option>
        <option value="other">Other</option>
        <option value="prefer-not-to-say">Prefer not to say</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">
        <input type="checkbox" id="termsCheckbox" required>
        I agree to the <a href="#" id="termsLink">Terms of Service</a> and <a href="#" id="privacyLink">Privacy Policy</a>
      </label>
    </div>
    <button type="submit" id="signupBtn">
      <span id="signupText">Create Account</span>
      <span id="signupSpinner" class="spinner" style="display: none;"></span>
    </button>
    <div class="toggle">
      Already have an account? <a id="showLogin" href="#login">Login</a>
    </div>
  </form>

  <form id="forgotPasswordForm" style="display: none;">
    <div class="form-group">
      <label class="form-label" for="forgotPasswordEmail">Email Address</label>
      <input type="email" id="forgotPasswordEmail" class="form-input" placeholder="Enter your email" required>
    </div>
    <button type="submit" id="resetPasswordBtn">
      <span id="resetPasswordText">Reset Password</span>
      <span id="resetPasswordSpinner" class="spinner" style="display: none;"></span>
    </button>
    <div class="toggle">
      Remember your password? <a id="showLoginFromForgot" href="#login">Back to Login</a>
    </div>
  </form>
</div>

<script type="module">
/* ---------- Firebase imports ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  updateProfile,
  onAuthStateChanged,
  signOut,
  sendPasswordResetEmail,
  reload as reloadUser // reload function for modular SDK
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  serverTimestamp,
  getDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import {
  getDatabase,
  ref,
  set,
  onDisconnect
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

/* ---------- Firebase config ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
  authDomain: "meet-6e159.firebaseapp.com",
  projectId: "meet-6e159",
  storageBucket: "meet-6e159.firebasestorage.app",
  messagingSenderId: "252353608421",
  appId: "1:252353608421:web:6706056048e9a8f12db20c",
  measurementId: "G-9BFPPVMMRF",
  databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com/"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const rtdb = getDatabase(app);

/* ---------- DOM ---------- */
const loginForm = document.getElementById('loginForm');
const signupForm = document.getElementById('signupForm');
const forgotPasswordForm = document.getElementById('forgotPasswordForm');
const formTitle = document.getElementById('formTitle');
const showSignup = document.getElementById('showSignup');
const showLogin = document.getElementById('showLogin');
const forgotPasswordLink = document.getElementById('forgotPasswordLink');
const showLoginFromForgot = document.getElementById('showLoginFromForgot');
const messageContainer = document.getElementById('messageContainer');

/* ---------- Rate limiting ---------- */
let loginAttempts = 0;
const MAX_LOGIN_ATTEMPTS = 5;
const RATE_LIMIT_TIME = 30000; // 30s

/* ---------- Validation & utils ---------- */
function isValidEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}
function isStrongPassword(password) {
  return password.length >= 8 &&
         /[A-Z]/.test(password) &&
         /[a-z]/.test(password) &&
         /[0-9]/.test(password);
}
function isValidPhone(phone) {
  const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
  return phoneRegex.test(phone.replace(/[\s\-\(\)]/g, ''));
}
function isValidUsername(username) {
  const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
  return usernameRegex.test(username);
}
function sanitizeInput(input) {
  const div = document.createElement('div');
  div.textContent = input;
  return div.innerHTML;
}
function sanitizeFormInputs() {
  const inputs = document.querySelectorAll('input, textarea');
  inputs.forEach(input => {
    // only sanitize text-like values (not file inputs). safe approach:
    if (input.type !== 'file' && input.type !== 'checkbox' && input.type !== 'radio') {
      input.value = sanitizeInput(input.value);
    }
  });
}

/* ---------- Password toggle (works on iOS/Android & removes blue outline) ---------- */
function setupPasswordToggle(passwordInputId, toggleButtonId) {
  const passwordInput = document.getElementById(passwordInputId);
  const toggleButton = document.getElementById(toggleButtonId);
  if (!passwordInput || !toggleButton) return;

  // Prevent the button from taking focus (mousedown + touchstart)
  toggleButton.addEventListener('mousedown', (e) => { e.preventDefault(); });
  toggleButton.addEventListener('touchstart', (e) => { e.preventDefault(); });

  toggleButton.addEventListener('click', (e) => {
    e.preventDefault();
    const type = passwordInput.type === 'password' ? 'text' : 'password';
    passwordInput.type = type;
    toggleButton.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üîí';
    // Keep cursor/focus on the input for UX
    passwordInput.focus({ preventScroll: true });
  });

  // Ensure no focus outline appears
  toggleButton.addEventListener('focus', (e) => { toggleButton.blur(); });
}
setupPasswordToggle('loginPassword', 'loginPasswordToggle');
setupPasswordToggle('signupPassword', 'signupPasswordToggle');
setupPasswordToggle('signupConfirmPassword', 'signupConfirmPasswordToggle');

/* ---------- UI helpers ---------- */
function showMessage(message, type = 'error') {
  messageContainer.innerHTML = `<div class="message ${type}">${message}</div>`;
}
function clearMessage() { messageContainer.innerHTML = ''; }
function setLoading(buttonId, isLoading) {
  const button = document.getElementById(buttonId);
  if (!button) return;
  const text = button.querySelector('span:first-child');
  const spinner = button.querySelector('.spinner');

  if (isLoading) {
    button.disabled = true;
    if (text) text.style.display = 'none';
    if (spinner) spinner.style.display = 'inline-block';
    document.querySelector('.form-card').classList.add('form-loading');
  } else {
    button.disabled = false;
    if (text) text.style.display = 'inline-block';
    if (spinner) spinner.style.display = 'none';
    document.querySelector('.form-card').classList.remove('form-loading');
  }
}

/* ---------- Rate limit check ---------- */
function checkRateLimit() {
  if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
    showMessage('Too many login attempts. Please try again in 30 seconds.', 'error');
    setTimeout(() => { loginAttempts = 0; }, RATE_LIMIT_TIME);
    return false;
  }
  return true;
}

/* ---------- Real-time validation ---------- */
function setupRealTimeValidation() {
  const signupPassword = document.getElementById('signupPassword');
  const signupConfirmPassword = document.getElementById('signupConfirmPassword');
  const signupEmail = document.getElementById('signupEmail');
  const signupUsername = document.getElementById('signupUsername');
  const signupPhone = document.getElementById('signupPhone');
  const signupFullName = document.getElementById('signupFullName');

  if (signupPassword) {
    signupPassword.addEventListener('input', () => {
      const hint = document.getElementById('passwordHint');
      if (signupPassword.value.length === 0) {
        hint.textContent = 'Must be at least 8 characters with uppercase, lowercase, and number';
        hint.className = 'validation-hint';
      } else if (isStrongPassword(signupPassword.value)) {
        hint.textContent = 'Password strength: Strong';
        hint.className = 'validation-hint success';
      } else {
        hint.textContent = 'Password must be at least 8 characters with uppercase, lowercase, and number';
        hint.className = 'validation-hint error';
      }
    });
  }

  if (signupConfirmPassword) {
    signupConfirmPassword.addEventListener('input', () => {
      const hint = document.getElementById('confirmPasswordHint');
      if (signupConfirmPassword.value === (signupPassword?.value || '')) {
        hint.textContent = 'Passwords match';
        hint.className = 'validation-hint success';
      } else {
        hint.textContent = 'Passwords do not match';
        hint.className = 'validation-hint error';
      }
    });
  }

  if (signupEmail) {
    signupEmail.addEventListener('input', () => {
      const hint = document.getElementById('emailHint');
      if (isValidEmail(signupEmail.value)) {
        hint.textContent = 'Valid email address';
        hint.className = 'validation-hint success';
      } else {
        hint.textContent = 'Please enter a valid email address';
        hint.className = 'validation-hint error';
      }
    });
  }

  if (signupUsername) {
    signupUsername.addEventListener('input', () => {
      const hint = document.getElementById('usernameHint');
      if (isValidUsername(signupUsername.value)) {
        hint.textContent = 'Valid username';
        hint.className = 'validation-hint success';
      } else {
        hint.textContent = 'Username must be 3-20 characters and contain only letters, numbers, and underscores';
        hint.className = 'validation-hint error';
      }
    });
  }

  if (signupPhone) {
    signupPhone.addEventListener('input', () => {
      const hint = document.getElementById('phoneHint');
      if (isValidPhone(signupPhone.value)) {
        hint.textContent = 'Valid phone number';
        hint.className = 'validation-hint success';
      } else {
        hint.textContent = 'Please enter a valid phone number';
        hint.className = 'validation-hint error';
      }
    });
  }

  if (signupFullName) {
    signupFullName.addEventListener('input', () => {
      const hint = document.getElementById('fullNameHint');
      if (signupFullName.value.trim().length >= 2) {
        hint.textContent = '';
        hint.className = 'validation-hint';
      } else {
        hint.textContent = 'Please enter your full name';
        hint.className = 'validation-hint error';
      }
    });
  }
}

/* ---------- Toggle forms ---------- */
function showForm(formToShow) {
  loginForm.style.display = 'none';
  signupForm.style.display = 'none';
  forgotPasswordForm.style.display = 'none';
  formToShow.style.display = 'block';

  if (formToShow === loginForm) formTitle.textContent = 'Login to MEET';
  else if (formToShow === signupForm) formTitle.textContent = 'Join MEET';
  else if (formToShow === forgotPasswordForm) formTitle.textContent = 'Reset Password';

  clearMessage();
}

showSignup.addEventListener('click', (e) => { e.preventDefault(); showForm(signupForm); setupRealTimeValidation(); });
showLogin.addEventListener('click', (e) => { e.preventDefault(); showForm(loginForm); });
forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); showForm(forgotPasswordForm); });
showLoginFromForgot.addEventListener('click', (e) => { e.preventDefault(); showForm(loginForm); });

/* ---------- Helper: read Firestore users doc fallback ---------- */
async function getUserDoc(uid) {
  try {
    const userDocRef = doc(db, "users", uid);
    const snapshot = await getDoc(userDocRef);
    if (snapshot.exists()) return snapshot.data();
    return null;
  } catch (err) {
    console.error("getUserDoc error:", err);
    return null;
  }
}

/* ---------- SIGNUP flow (robust for iOS) ---------- */
signupForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  sanitizeFormInputs();

  const fullName = document.getElementById('signupFullName').value.trim();
  const username = document.getElementById('signupUsername').value.trim();
  const email = document.getElementById('signupEmail').value.trim();
  const phone = document.getElementById('signupPhone').value.trim();
  const password = document.getElementById('signupPassword').value;
  const confirmPassword = document.getElementById('signupConfirmPassword').value;
  const gender = document.getElementById('signupGender').value;
  const termsAccepted = document.getElementById('termsCheckbox').checked;

  if (!fullName || !username || !email || !phone || !password || !confirmPassword || !gender) {
    showMessage('Please fill in all fields', 'error'); return;
  }
  if (!termsAccepted) { showMessage('Please agree to Terms', 'error'); return; }
  if (!isValidEmail(email)) { showMessage('Please enter a valid email address', 'error'); return; }
  if (!isValidUsername(username)) { showMessage('Invalid username', 'error'); return; }
  if (!isValidPhone(phone)) { showMessage('Please enter a valid phone number', 'error'); return; }
  if (!isStrongPassword(password)) { showMessage('Password must be stronger', 'error'); return; }
  if (password !== confirmPassword) { showMessage("Passwords don't match", 'error'); return; }

  setLoading('signupBtn', true);
  clearMessage();

  try {
    // 1) Create auth user
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    if (!user || !user.uid) throw new Error('User creation failed');

    // 2) Write Firestore user doc first (so backend state is present)
    const userDoc = {
      uid: user.uid,
      displayName: fullName,
      fullName,
      username,
      email,
      phone,
      gender,
      createdAt: serverTimestamp()
    };
    await setDoc(doc(db, "users", user.uid), userDoc);

    // 3) Try updating auth profile (displayName); retry logic for iOS flakiness
    try {
      await updateProfile(user, { displayName: fullName });
    } catch (updErr) {
      console.warn('updateProfile first attempt failed:', updErr);
      // retry once after a short delay
      await new Promise(r => setTimeout(r, 400));
      try {
        await updateProfile(user, { displayName: fullName });
      } catch (updErr2) {
        console.warn('updateProfile retry failed:', updErr2);
      }
    }

    // 4) reload auth user to ensure displayName is available in current user object
    try {
      await reloadUser(user);
    } catch (reloadErr) {
      console.warn('User reload failed:', reloadErr);
    }

    // 5) Set online status in RTDB and onDisconnect
    try {
      const statusRef = ref(rtdb, 'status/' + user.uid);
      await set(statusRef, 'online');
      onDisconnect(statusRef).set('offline');
    } catch (rtdbErr) {
      console.warn('RTDB status set error:', rtdbErr);
    }

    showMessage('Account created successfully! Redirecting...', 'success');
    setTimeout(() => { window.location.href = 'feed.html'; }, 1200);
  } catch (error) {
    console.error('signup error:', error);
    let errorMessage = error?.message || 'Sign up failed';
    if (error?.code === 'auth/email-already-in-use') errorMessage = 'An account with this email already exists.';
    if (error?.code === 'auth/weak-password') errorMessage = 'Password too weak.';
    if (error?.code === 'auth/invalid-email') errorMessage = 'Invalid email address.';
    showMessage(errorMessage, 'error');
  } finally {
    setLoading('signupBtn', false);
  }
});

/* ---------- LOGIN ---------- */
loginForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  sanitizeFormInputs();

  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;

  if (!email || !password) { showMessage('Please fill in all fields', 'error'); return; }
  if (!isValidEmail(email)) { showMessage('Please enter a valid email address', 'error'); return; }
  if (!checkRateLimit()) return;

  setLoading('loginBtn', true);
  clearMessage();

  try {
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    loginAttempts = 0;

    // Ensure Firestore user exists. If not, try to create minimal doc using auth profile
    try {
      const snapshot = await getDoc(doc(db, "users", user.uid));
      if (!snapshot.exists()) {
        // create fallback profile using auth's displayName/email
        await setDoc(doc(db, "users", user.uid), {
          uid: user.uid,
          displayName: user.displayName || '',
          email: user.email || '',
          createdAt: serverTimestamp()
        });
      }
    } catch (fsErr) {
      console.warn('firestore fallback error on login:', fsErr);
    }

    // Set RTDB online status
    try {
      const statusRef = ref(rtdb, 'status/' + user.uid);
      await set(statusRef, 'online');
      onDisconnect(statusRef).set('offline');
    } catch (rtdbErr) {
      console.warn('RTDB status set error:', rtdbErr);
    }

    showMessage('Login successful! Redirecting...', 'success');
    setTimeout(() => { window.location.href = 'feed.html'; }, 900);
  } catch (error) {
    console.error('login error:', error);
    loginAttempts++;
    let errorMessage = 'Login failed. Please try again.';
    if (error?.code === 'auth/user-not-found') errorMessage = 'No account found with this email.';
    if (error?.code === 'auth/wrong-password') errorMessage = 'Incorrect password.';
    if (error?.code === 'auth/invalid-email') errorMessage = 'Invalid email address.';
    if (error?.code === 'auth/user-disabled') errorMessage = 'This account has been disabled.';
    if (error?.code === 'auth/too-many-requests') errorMessage = 'Too many failed login attempts. Please try again later.';
    showMessage(errorMessage, 'error');
  } finally {
    setLoading('loginBtn', false);
  }
});

/* ---------- FORGOT PASSWORD ---------- */
forgotPasswordForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const email = document.getElementById('forgotPasswordEmail').value.trim();
  if (!email) { showMessage('Please enter your email address', 'error'); return; }
  if (!isValidEmail(email)) { showMessage('Please enter a valid email address', 'error'); return; }

  setLoading('resetPasswordBtn', true);
  clearMessage();
  try {
    await sendPasswordResetEmail(auth, email);
    showMessage('Password reset email sent! Check your inbox.', 'success');
    setTimeout(() => { showForm(loginForm); }, 2500);
  } catch (error) {
    console.error('reset password error:', error);
    let errorMessage = 'Failed to send reset email. Please try again.';
    if (error?.code === 'auth/user-not-found') errorMessage = 'No account found with this email.';
    if (error?.code === 'auth/invalid-email') errorMessage = 'Invalid email address.';
    showMessage(errorMessage, 'error');
  } finally {
    setLoading('resetPasswordBtn', false);
  }
});

/* ---------- onAuthStateChanged: robust handling & redirect ---------- */
onAuthStateChanged(auth, async (user) => {
  if (!user) return;
  // Ensure Firestore has a user doc; if not, try to fetch and create fallback
  try {
    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (!userDoc.exists()) {
      // try to populate from auth profile
      await setDoc(doc(db, "users", user.uid), {
        uid: user.uid,
        displayName: user.displayName || '',
        email: user.email || '',
        createdAt: serverTimestamp()
      });
    } else {
      // If auth user has no displayName (iOS case), copy Firestore displayName into auth (best effort)
      if (!user.displayName) {
        const data = userDoc.data();
        if (data?.displayName) {
          try {
            await updateProfile(user, { displayName: data.displayName });
            try { await reloadUser(user); } catch(e) { /* non-fatal */ }
          } catch (updErr) { console.warn('could not update auth profile from Firestore:', updErr); }
        }
      }
    }
  } catch (err) {
    console.warn('onAuthStateChanged firestore check error:', err);
  }

  // Set RTDB status (best effort)
  try {
    const statusRef = ref(rtdb, 'status/' + user.uid);
    await set(statusRef, 'online');
    onDisconnect(statusRef).set('offline');
  } catch (err) {
    console.warn('RTDB status error on auth change:', err);
  }

  // Finally redirect to feed (or wherever)
  window.location.href = 'feed.html';
});

/* ---------- Initialize realtime validation for signup if user clicks sign up ---------- */
document.addEventListener('DOMContentLoaded', () => {
  // calling setupRealTimeValidation here doesn't hurt
  setupRealTimeValidation();
});
</script>
</body>
</html>
