<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Chat Professional</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary: #0080FF;
    --primary-dark: #0066CC;
    --bg-color: #f0f2f5;
    --card-bg: #fff;
    --text-color: #111;
    --secondary-text: #65676b;
    --border-color: #dddfe2;
    --app-height: 100dvh;
    --chat-font: 'Poppins', sans-serif;
    --sent-bubble-bg: #0080FF;
    --sent-text-color: #fff;
    --received-bubble-bg: #fff;
    --received-text-color: #111;
  }

  body.dark-mode {
    --bg-color: #0f0f10;
    --card-bg: #1e1e1e;
    --text-color: #e4e6eb;
    --secondary-text: #b0b3b8;
    --border-color: #2f3031;
    --received-bubble-bg: #2a2b2c;
    --received-text-color: #e4e6eb;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  html, body { height: 100%; overflow: hidden; font-size: 14px; font-family: var(--chat-font); background: var(--bg-color); color: var(--text-color); }

  .app-container { display: flex; height: var(--app-height); position: relative; overflow: hidden; }

  /* Sidebar */
  .sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 260px; background: linear-gradient(180deg, #0080FF 0%, #00C6FF 100%); z-index: 200; padding: 20px; color: white; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 4px 0 15px rgba(0,0,0,0.1); }
  .sidebar.open { transform: translateX(0); }
  .sidebar-header { padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.2); margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center;}
  .sidebar-menu { list-style: none; }
  .sidebar-menu li { margin-bottom: 8px; }
  .sidebar-menu a { display: flex; align-items: center; padding: 12px; text-decoration: none; color: white; border-radius: 8px; font-size: 16px; transition: 0.2s;}
  .sidebar-menu a:hover { background: rgba(255, 255, 255, 0.2); transform: translateX(5px); }
  .sidebar-menu i { margin-right: 12px; font-size: 18px; width: 25px; text-align: center; }
  .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 190; backdrop-filter: blur(2px); }
  .sidebar-overlay.active { display: block; }

  /* Main Content */
  .main-content { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; padding: 10px; width: 100%; }

  /* Navbar */
  .navbar { background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%); padding: 10px 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; color: white; flex-shrink: 0; box-shadow: 0 4px 15px rgba(0,128,255,0.2); }
  .navbar-left { display: flex; align-items: center; gap: 15px; }
  .navbar-right { display: flex; align-items: center; gap: 10px; }
  .hamburger-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
  .nav-user-img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.8); object-fit: cover; }
  .btn { background: rgba(255, 255, 255, 0.2); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: 0.2s; }

  /* Chat Container */
  .chat-container { flex: 1; background: var(--card-bg); border-radius: 12px; overflow: hidden; display: flex; min-height: 0; position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
  .conversations-sidebar { width: 320px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; height: 100%; background: var(--card-bg); }
  .chat-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
  .new-chat-btn { background: #0080FF; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; transition: transform 0.2s; box-shadow: 0 2px 5px rgba(0,128,255,0.3); }
  .new-chat-btn:hover { transform: scale(1.1); }
  .chat-search { padding: 10px; border-bottom: 1px solid var(--border-color); }
  .chat-search input { width: 100%; padding: 10px 15px; border-radius: 20px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); outline: none; }
  .conversations-list { flex: 1; overflow-y: auto; }
  .conversation-item { display: flex; align-items: center; gap: 10px; padding: 12px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: 0.2s; }
  .conversation-item:hover, .conversation-item.active { background: rgba(0,128,255,0.08); border-left: 4px solid var(--primary); }
  .conversation-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; }
  .conversation-info { flex: 1; min-width: 0; }
  .conversation-name { font-weight: 600; font-size: 15px; }
  .conversation-preview { font-size: 13px; color: var(--secondary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* Chat Area */
  .chat-area { flex: 1; display: flex; flex-direction: column; height: 100%; background: var(--bg-color); position: relative; }
  .chat-area-header { padding: 10px 15px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.9); z-index: 10; backdrop-filter: blur(10px); }
  body.dark-mode .chat-area-header { background: rgba(30,30,30,0.9); }
  .chat-actions { display: flex; gap: 15px; margin-left: auto; }
  .chat-action-btn { background: none; border: none; color: var(--primary); font-size: 18px; cursor: pointer; padding: 8px; border-radius: 50%; }
  
  .messages-container { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; background-size: cover; background-position: center; }

  /* Message Styling */
  .date-divider { text-align: center; margin: 20px 0; opacity: 0.8; }
  .date-divider span { background: rgba(0,0,0,0.2); backdrop-filter: blur(4px); color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; }

  .message-wrapper { display: flex; gap: 8px; max-width: 80%; align-items: flex-end; margin-bottom: 4px; position: relative; }
  .message-wrapper.sent { align-self: flex-end; flex-direction: row-reverse; }
  
  /* Optimistic State (Pending) */
  .message-wrapper.optimistic { opacity: 0.7; }
  
  .message-bubble { padding: 8px 14px; border-radius: 18px; position: relative; word-wrap: break-word; font-size: 15px; line-height: 1.4; max-width: 100%; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }
  .received .message-bubble { background: var(--received-bubble-bg); border-bottom-left-radius: 4px; color: var(--received-text-color); }
  .sent .message-bubble { background: var(--sent-bubble-bg); color: var(--sent-text-color); border-bottom-right-radius: 4px; }
  
  .message-time { font-size: 10px; opacity: 0.7; margin-top: 2px; text-align: right; display: flex; align-items: center; justify-content: flex-end; gap: 4px; }
  .message-status-icon { font-size: 10px; }
  
  .message-input-container { padding: 10px; background: var(--card-bg); border-top: 1px solid var(--border-color); }
  .message-input-wrapper { display: flex; align-items: flex-end; gap: 10px; }
  .message-input { flex: 1; padding: 12px 18px; border-radius: 24px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); resize: none; max-height: 120px; outline: none; }
  .send-button { background: var(--primary); color: white; border: 0; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

  /* Wallpaper Grid Fix */
  .wallpaper-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; padding: 20px; align-items: center; justify-content: center; }
  .wallpaper-content { background: var(--card-bg); border-radius: 12px; padding: 20px; max-width: 800px; width: 95%; height: 80vh; display: flex; flex-direction: column; }
  .wallpaper-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
  /* STRICT GRID SYSTEM */
  .wallpaper-grid { 
      display: grid; 
      grid-template-columns: repeat(2, 1fr); /* Mobile: 2 items per row */
      gap: 15px; 
      overflow-y: auto; 
      padding: 5px; 
  } 
  .wallpaper-thumb { aspect-ratio: 9/16; border-radius: 8px; overflow: hidden; cursor: pointer; border: 3px solid transparent; background: #eee; position: relative; }
  .wallpaper-thumb:hover { border-color: #0080FF; }
  .wallpaper-thumb img { width: 100%; height: 100%; object-fit: cover; display:block; }
  
  @media (min-width: 768px) {
    .wallpaper-grid { grid-template-columns: repeat(4, 1fr); } /* Desktop: 4 items per row */
  }

  @media (max-width: 768px) {
    .conversations-sidebar { width: 100%; position: absolute; z-index: 50; }
    .chat-area { width: 100%; position: absolute; z-index: 60; transform: translateX(100%); transition: transform 0.3s; }
    .chat-area.active { transform: translateX(0); }
  }
  
  /* User Search Overlay */
  .user-search-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: flex-start; padding-top: 80px; backdrop-filter: blur(5px); }
  .user-search-modal { background: var(--card-bg); border-radius: 16px; width: 90%; max-width: 500px; padding: 20px; }
  .search-result-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
</style>
</head>
<body>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
<div class="app-container">
  <div class="sidebar" id="mainSidebar">
    <div class="sidebar-header">
      <h2>MEET</h2>
      <button onclick="toggleSidebar()" style="background:none; border:none; color:white;"><i class="fas fa-times"></i></button>
    </div>
    <ul class="sidebar-menu">
      <li><a href="chat.html" class="active"><i class="fas fa-comment"></i> <span>Chat</span></a></li>
      <li><a href="#" onclick="alert('Demo Link')"><i class="fas fa-user"></i> <span>Profile</span></a></li>
    </ul>
  </div>

  <div class="main-content">
    <div class="navbar">
      <div class="navbar-left">
        <button class="hamburger-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <h3>Chat</h3>
      </div>
      <div class="navbar-right">
        <img src="" id="navUserImg" class="nav-user-img">
        <button class="btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </div>

    <div class="chat-container">
      <div class="conversations-sidebar" id="conversationsSidebar">
        <div class="chat-header">
          <h3>Messages</h3>
          <button class="new-chat-btn" onclick="document.getElementById('userSearchOverlay').style.display='flex'"><i class="fas fa-plus"></i></button>
        </div>
        <div class="chat-search"><input type="text" placeholder="Search chats..." id="chatSearch"></div>
        <div class="conversations-list" id="conversationsList"></div>
      </div>

      <div class="chat-area" id="chatArea">
        <div id="emptyChat" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:var(--secondary-text);">
          <i class="far fa-comments" style="font-size:70px; opacity:0.3; margin-bottom:20px;"></i>
          <h3>Select a conversation</h3>
        </div>

        <div class="chat-area-header" id="chatHeader" style="display: none;">
          <button class="chat-action-btn" id="backButton" style="color:var(--text-color); margin-right:10px;"><i class="fas fa-arrow-left"></i></button>
          <img src="" id="currentChatAvatar" class="conversation-avatar">
          <div style="flex:1; margin-left:10px; font-weight:700;" id="chatUserName">User</div>
          <div class="chat-actions">
            <button class="chat-action-btn" onclick="openWallpaperModal()"><i class="fas fa-image"></i></button>
          </div>
        </div>

        <div class="messages-container" id="messagesContainer" style="display: none;"></div>

        <div class="message-input-container" id="messageInputContainer" style="display: none;">
          <div class="message-input-wrapper">
            <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
            <button class="send-button" id="sendButton"><i class="fas fa-paper-plane"></i></button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="wallpaper-modal" id="wallpaperModal">
  <div class="wallpaper-content">
    <div class="wallpaper-header">
      <h3>Choose Wallpaper</h3>
      <button onclick="document.getElementById('wallpaperModal').style.display='none'" style="background:none; border:none; font-size:24px;"><i class="fas fa-times"></i></button>
    </div>
    <div class="wallpaper-grid" id="wallpaperGrid"></div>
  </div>
</div>

<div class="user-search-overlay" id="userSearchOverlay">
  <div class="user-search-modal">
    <h3>New Conversation</h3>
    <input type="text" id="userSearchInput" placeholder="Search email..." style="width:100%; padding:10px; margin:10px 0; border:1px solid #ccc; border-radius:8px;">
    <div id="userSearchResults"></div>
    <button onclick="document.getElementById('userSearchOverlay').style.display='none'" style="margin-top:10px; padding:10px; border:none; background:#eee; width:100%; border-radius:8px;">Close</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getFirestore, collection, addDoc, updateDoc, doc, getDoc, getDocs, onSnapshot, serverTimestamp, query, orderBy, where, setDoc, limit } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM", 
    authDomain: "meet-6e159.firebaseapp.com",
    projectId: "meet-6e159",
    storageBucket: "meet-6e159.firebasestorage.app",
    messagingSenderId: "252353608421",
    appId: "1:252353608421:web:6706056048e9a8f12db20c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let currentUser = null;
  let currentChatId = null;
  let unsubscribeMessages = null;
  
  const messagesContainer = document.getElementById('messagesContainer');
  const messageInput = document.getElementById('messageInput');

  // --- 1. AUTH & PERSISTENCE ---
  onAuthStateChanged(auth, async user => {
    if (!user) {
        window.location.href = 'login.html';
    } else {
        currentUser = user;
        document.getElementById('navUserImg').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}`;
        loadConversations();
        
        // RE-OPEN CHAT ON REFRESH (Persistence Fix)
        const savedChat = localStorage.getItem('last_active_chat');
        if(savedChat) {
            // We need to fetch basic info to restore the header
            const chatDoc = await getDoc(doc(db, "conversations", savedChat));
            if(chatDoc.exists()) {
                const data = chatDoc.data();
                const otherId = data.participants.find(p => p !== user.uid);
                const name = data.participantNames[otherId];
                const avatar = data.participantAvatars[otherId];
                openChat(savedChat, name, avatar);
            }
        }
    }
  });

  document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('last_active_chat');
      signOut(auth);
  });

  // --- 2. LOAD CONVERSATIONS ---
  function loadConversations() {
    const q = query(collection(db, "conversations"), where("participants", "array-contains", currentUser.uid));
    onSnapshot(q, (snapshot) => {
      const list = document.getElementById('conversationsList');
      list.innerHTML = '';
      const convs = [];
      snapshot.forEach(doc => convs.push({id: doc.id, ...doc.data()}));
      // Sort by recent update locally
      convs.sort((a,b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));

      convs.forEach(conv => {
         const otherId = conv.participants.find(p => p !== currentUser.uid);
         const name = conv.participantNames?.[otherId] || 'User';
         const avatar = conv.participantAvatars?.[otherId] || `https://ui-avatars.com/api/?name=${name}`;
         
         const div = document.createElement('div');
         div.className = `conversation-item ${currentChatId === conv.id ? 'active' : ''}`;
         div.innerHTML = `
            <img src="${avatar}" class="conversation-avatar">
            <div class="conversation-info">
                <div class="conversation-name">${name}</div>
                <div class="conversation-preview">${conv.lastMessage || 'Start chatting'}</div>
            </div>`;
         div.onclick = () => openChat(conv.id, name, avatar);
         list.appendChild(div);
      });
    });
  }

  // --- 3. OPEN CHAT ---
  window.openChat = async (chatId, name, avatar) => {
    currentChatId = chatId;
    localStorage.setItem('last_active_chat', chatId); // Save state

    // UI Updates
    document.getElementById('emptyChat').style.display = 'none';
    document.getElementById('chatHeader').style.display = 'flex';
    document.getElementById('messagesContainer').style.display = 'flex';
    document.getElementById('messageInputContainer').style.display = 'block';
    
    document.getElementById('chatUserName').innerText = name;
    document.getElementById('currentChatAvatar').src = avatar;

    // Load Wallpaper
    const wp = localStorage.getItem('meet_wallpaper_' + chatId);
    if(wp) messagesContainer.style.backgroundImage = `url(${wp})`;
    else messagesContainer.style.backgroundImage = 'none';

    // Mobile Sidebar Handling
    if(window.innerWidth <= 768) {
        document.getElementById('chatArea').classList.add('active');
        document.getElementById('conversationsSidebar').style.display = 'none'; // Hide sidebar on mobile to save resources
    }

    loadMessages(chatId);
  }

  // --- 4. MESSAGE RENDERING & PREVENTING DOUBLES ---
  function loadMessages(chatId) {
    if(unsubscribeMessages) unsubscribeMessages();
    messagesContainer.innerHTML = ''; // Clean start

    const q = query(
        collection(db, "conversations", chatId, "messages"), 
        orderBy("timestamp", "asc")
    );

    // includeMetadataChanges: true is CRITICAL for latency compensation to work without dupes
    unsubscribeMessages = onSnapshot(q, { includeMetadataChanges: true }, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            const msg = change.doc.data();
            const isMe = msg.senderId === currentUser.uid;
            
            // Check for Pending Writes (Optimistic UI handled by Firestore)
            const isPending = change.doc.metadata.hasPendingWrites; 

            if (change.type === "added") {
                const existingEl = document.getElementById(change.doc.id);
                if(existingEl) return; // Prevent duplicates if already exists

                // If this is a real server message, check if we have a temporary optimistic one to remove
                if (!isPending && isMe) {
                   // Clean up any manually added optimistic messages that match the content
                   // This acts as a failsafe, though Firestore SDK usually handles it.
                   const manualOptimistics = document.querySelectorAll(`.optimistic-manual[data-text="${msg.text}"]`);
                   manualOptimistics.forEach(el => el.remove());
                }

                appendMessage(msg, isMe, change.doc.id, isPending);
            } 
            else if (change.type === "modified") {
                // Update status (e.g. pending -> sent)
                const el = document.getElementById(change.doc.id);
                if(el) {
                    const newEl = createMessageElement(msg, isMe, change.doc.id, isPending);
                    el.replaceWith(newEl);
                }
            }
        });
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });
  }

  function createMessageElement(msg, isMe, id, isPending) {
    const div = document.createElement('div');
    div.className = `message-wrapper ${isMe ? 'sent' : 'received'} ${isPending ? 'optimistic' : ''}`;
    div.id = id;
    
    // Status Icon Logic
    let statusIcon = '';
    if(isMe) {
        statusIcon = isPending ? '<i class="far fa-clock"></i>' : '<i class="fas fa-check-double"></i>';
    }

    const time = msg.timestamp ? new Date(msg.timestamp.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...';

    div.innerHTML = `
       <div class="message-bubble">
          ${msg.text}
          <div class="message-time">${time} <span class="message-status-icon">${statusIcon}</span></div>
       </div>
    `;
    return div;
  }

  function appendMessage(msg, isMe, id, isPending) {
      const el = createMessageElement(msg, isMe, id, isPending);
      messagesContainer.appendChild(el);
  }

  // --- 5. SENDING MESSAGES ---
  document.getElementById('sendButton').addEventListener('click', async () => {
      const text = messageInput.value.trim();
      if(!text || !currentChatId) return;

      messageInput.value = ''; // Clear input immediately

      try {
          // We rely on Firestore SDK's Latency Compensation for immediate feedback
          // This prevents the "Double Message" bug because Firestore manages the local state.
          await addDoc(collection(db, "conversations", currentChatId, "messages"), {
              text: text,
              senderId: currentUser.uid,
              timestamp: serverTimestamp()
          });
          
          await updateDoc(doc(db, "conversations", currentChatId), {
              lastMessage: text,
              updatedAt: serverTimestamp()
          });
      } catch (e) {
          console.error("Error sending:", e);
          alert("Failed to send message. Check connection.");
      }
  });

  // Handle Enter Key
  messageInput.addEventListener('keydown', (e) => {
    if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('sendButton').click(); }
  });

  // --- 6. WALLPAPER LOGIC ---
  window.openWallpaperModal = () => {
    const modal = document.getElementById('wallpaperModal');
    const grid = document.getElementById('wallpaperGrid');
    modal.style.display = 'flex';
    grid.innerHTML = '';
    
    // Generate 12 wallpapers
    for(let i=1; i<=12; i++) {
        const url = `https://picsum.photos/seed/wall${i}/400/800`;
        const div = document.createElement('div');
        div.className = 'wallpaper-thumb';
        div.innerHTML = `<img src="${url}" loading="lazy">`;
        div.onclick = () => {
            localStorage.setItem('meet_wallpaper_' + currentChatId, url);
            messagesContainer.style.backgroundImage = `url(${url})`;
            modal.style.display = 'none';
        };
        grid.appendChild(div);
    }
  };

  // --- 7. UTILS ---
  window.toggleSidebar = () => {
     document.getElementById('mainSidebar').classList.toggle('open');
     document.getElementById('sidebarOverlay').classList.toggle('active');
  };

  document.getElementById('backButton').addEventListener('click', () => {
      document.getElementById('chatArea').classList.remove('active');
      document.getElementById('conversationsSidebar').style.display = 'flex';
  });

  // Search Logic
  document.getElementById('userSearchInput').addEventListener('input', async (e) => {
      const term = e.target.value;
      if(term.length < 3) return;
      const q = query(collection(db, "users"), where("email", ">=", term), limit(5));
      const snap = await getDocs(q);
      const resDiv = document.getElementById('userSearchResults');
      resDiv.innerHTML = '';
      snap.forEach(doc => {
         if(doc.id === currentUser.uid) return;
         const d = doc.data();
         const div = document.createElement('div');
         div.className = 'search-result-item';
         div.innerHTML = `<b>${d.name || 'User'}</b> <small>(${d.email})</small>`;
         div.onclick = async () => {
             // Create conversation ID based on sorted UIDs to ensure uniqueness
             const participants = [currentUser.uid, doc.id].sort();
             const chatId = participants.join('_');
             await setDoc(doc(db, "conversations", chatId), {
                 participants,
                 participantNames: { [currentUser.uid]: currentUser.displayName, [doc.id]: d.name },
                 participantAvatars: { [currentUser.uid]: currentUser.photoURL, [doc.id]: d.photoURL },
                 updatedAt: serverTimestamp(),
                 lastMessage: ''
             }, { merge: true });
             document.getElementById('userSearchOverlay').style.display = 'none';
             openChat(chatId, d.name, d.photoURL);
         };
         resDiv.appendChild(div);
      });
  });

</script>
</body>
</html>
