<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Page</title>
<script type="module">
  // ---------------------- FIREBASE SETUP ----------------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
  import { getFirestore, doc, collection, setDoc, addDoc, getDoc, query, orderBy, onSnapshot, updateDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MSG_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // ---------------------- LOGIN FOR DEMO ----------------------
  // Replace with your own email/password login
  const demoEmail = "test1@example.com";
  const demoPass = "123456";

  let currentUser;
  signInWithEmailAndPassword(auth, demoEmail, demoPass)
    .then(res => {
      currentUser = res.user;
      console.log("Logged in as:", currentUser.uid);
    })
    .catch(err => console.error(err));

  // ---------------------- UTILITY ----------------------
  function getChatId(uid1, uid2) {
    return [uid1, uid2].sort().join("_");
  }

  async function createChatIfNotExist(uid1, uid2) {
    const chatId = getChatId(uid1, uid2);
    const chatRef = doc(db, "chats", chatId);
    const chatSnap = await getDoc(chatRef);
    if (!chatSnap.exists()) {
      await setDoc(chatRef, { users: [uid1, uid2], typing: {} });
      console.log("Chat created:", chatId);
    }
    return chatRef;
  }

  async function sendMessage(toUid, text) {
    if (!currentUser) return alert("Not logged in yet!");
    const chatRef = await createChatIfNotExist(currentUser.uid, toUid);
    const messagesRef = collection(chatRef, "messages");
    await addDoc(messagesRef, { senderId: currentUser.uid, message: text, timestamp: new Date() });
    document.getElementById("messageInput").value = "";
  }

  async function setTyping(toUid, isTyping) {
    if (!currentUser) return;
    const chatRef = await createChatIfNotExist(currentUser.uid, toUid);
    await updateDoc(chatRef, { [`typing.${currentUser.uid}`]: isTyping });
  }

  function listenMessages(toUid) {
    const chatId = getChatId(currentUser.uid, toUid);
    const messagesRef = collection(db, "chats", chatId, "messages");
    const q = query(messagesRef, orderBy("timestamp", "asc"));
    onSnapshot(q, snapshot => {
      const container = document.getElementById("messages");
      container.innerHTML = "";
      snapshot.docs.forEach(doc => {
        const msg = doc.data();
        const div = document.createElement("div");
        div.textContent = (msg.senderId === currentUser.uid ? "You: " : "Other: ") + msg.message;
        container.appendChild(div);
      });
    });
  }

  function listenTyping(toUid) {
    const chatId = getChatId(currentUser.uid, toUid);
    const chatRef = doc(db, "chats", chatId);
    onSnapshot(chatRef, docSnap => {
      const status = document.getElementById("typingStatus");
      if (docSnap.exists()) {
        const typing = docSnap.data().typing || {};
        status.textContent = typing[toUid] ? "User is typing..." : "";
      }
    });
  }

  // ---------------------- SEARCH USERS ----------------------
  async function searchUsers() {
    const name = document.getElementById("searchInput").value.toLowerCase();
    const usersContainer = document.getElementById("users");
    usersContainer.innerHTML = "";
    const usersCol = collection(db, "users");
    const q = query(usersCol);
    const snap = await getDocs(q);
    snap.docs.forEach(docSnap => {
      const data = docSnap.data();
      if (data.name && data.name.toLowerCase().includes(name) && docSnap.id !== currentUser.uid) {
        const div = document.createElement("div");
        div.textContent = data.name;
        div.style.cursor = "pointer";
        div.addEventListener("click", () => startChat(docSnap.id));
        usersContainer.appendChild(div);
      }
    });
  }

  let activeChatUser = null;

  async function startChat(uid) {
    activeChatUser = uid;
    document.getElementById("chatWith").textContent = "Chatting with: " + uid;
    await createChatIfNotExist(currentUser.uid, uid);
    listenMessages(uid);
    listenTyping(uid);
  }

  // ---------------------- EVENT LISTENERS ----------------------
  window.addEventListener("DOMContentLoaded", () => {
    document.getElementById("searchBtn").addEventListener("click", searchUsers);

    const messageInput = document.getElementById("messageInput");
    messageInput.addEventListener("input", () => {
      if (activeChatUser) setTyping(activeChatUser, messageInput.value.length > 0);
    });

    document.getElementById("sendBtn").addEventListener("click", () => {
      if (activeChatUser) sendMessage(activeChatUser, messageInput.value);
    });
  });
</script>
<style>
  #messages { border: 1px solid #ccc; height: 200px; overflow-y: scroll; padding: 5px; margin-bottom: 5px; }
  #users div:hover { background-color: #eee; }
</style>
</head>
<body>
<h2>Search Users</h2>
<input type="text" id="searchInput" placeholder="Enter name">
<button id="searchBtn">Search</button>
<div id="users"></div>

<h2 id="chatWith">No chat selected</h2>
<div id="messages"></div>
<div id="typingStatus" style="color: green; font-weight: bold;"></div>
<input type="text" id="messageInput" placeholder="Type a message...">
<button id="sendBtn">Send</button>
</body>
</html>
