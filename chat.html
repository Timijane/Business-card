<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MEET | Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root{
    --primary:#0061FF;
    --accent:#5AE4A8;
    --bg:#f7f9fb;
    --card:#fff;
    --text:#111827;
    --muted:#6b7280;
    --radius:12px;
    --shadow: 0 6px 18px rgba(16,24,40,0.06);
    --my-msg-bg: linear-gradient(90deg, var(--primary), var(--accent));
    --their-msg-bg: #fff;
  }
  body.dark {
    --bg:#081226;
    --card:#0b1726;
    --text:#e6eef8;
    --muted:#93a3bd;
    --shadow: 0 6px 18px rgba(0,0,0,0.6);
    --their-msg-bg: #1f2937;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Arial; background:var(--bg); color:var(--text);
    height:100vh; display:flex; flex-direction:column; transition:background .35s,color .35s; overflow: hidden;
  }
  /* Header & Sidebar */
  header{ display:flex; align-items:center; gap:16px; padding:12px 20px; background:var(--card); box-shadow:var(--shadow); position:sticky; top:0; z-index:50; }
  .left { display:flex; align-items:center; gap:12px; }
  .logo-icon{ width:44px;height:44px;border-radius:8px; background:linear-gradient(135deg,var(--primary),var(--accent)); display:flex;align-items:center;justify-content:center; -webkit-mask:url('#m-mask');mask:url('#m-mask') center/contain no-repeat; }
  .brand { font-weight:700;font-size:18px;color:var(--primary); }
  .search { flex:1;display:flex;align-items:center;gap:10px;background:rgba(0,0,0,0.05);border-radius:10px;padding:8px 12px; max-width:600px; }
  body.dark .search{background:rgba(255,255,255,0.1);}
  .search input{border:0;background:transparent;outline:none;width:100%;color:var(--text)}
  .header-right{display:flex;align-items:center;gap:10px}

  .layout{display:flex;flex:1;overflow:hidden}
  aside{ width:240px;background:var(--card);padding:18px;border-right:1px solid rgba(0,0,0,0.05); display:flex;flex-direction:column;gap:8px;box-shadow:var(--shadow); transition: width 0.3s ease; z-index: 20; }
  aside button{ border:0;background:transparent;padding:12px 14px;border-radius:10px;text-align:left;font-weight:600;color:var(--muted);cursor:pointer; display: flex; align-items: center; gap: 12px; text-decoration: none; width: 100%; font-family: inherit; font-size: inherit; }
  aside button:hover { background: rgba(0,0,0,0.05); }
  aside button.active{color:var(--primary);background:linear-gradient(90deg, rgba(0,97,255,0.06), rgba(90,228,168,0.03));}
  main{flex:1;padding:0;overflow:hidden;display:flex;}

  /* Chat Specifics */
  .chat-container { display: flex; width: 100%; height: 100%; }
  .conversations-sidebar { width: 320px; background: var(--card); border-right: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; height: 100%; }
  body.dark .conversations-sidebar { border-right: 1px solid rgba(255,255,255,0.05); }

  .chat-header { padding: 15px 20px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
  .chat-title { font-size: 18px; font-weight: 700; }
  .new-chat-btn { background: linear-gradient(90deg, var(--primary), var(--accent)); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: transform 0.2s; }
  .new-chat-btn:hover { transform: scale(1.1); }

  .conversations-list { flex: 1; overflow-y: auto; padding: 8px 0; }
  .conversation-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.03); transition: background 0.2s; }
  .conversation-item:hover, .conversation-item.active { background: rgba(0,97,255,0.05); }
  .conversation-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 1px solid var(--muted); }
  .conversation-info { flex: 1; min-width: 0; }
  .conversation-name { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
  .conversation-preview { font-size: 12px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .conversation-time { font-size: 11px; color: var(--muted); }

  /* Chat Area */
  .chat-area { flex: 1; display: flex; flex-direction: column; height: 100%; background: var(--bg); position: relative; }
  
  /* Empty State */
  .empty-chat { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; padding: 30px; color: var(--muted); }
  .empty-chat i { font-size: 40px; margin-bottom: 15px; opacity: 0.5; }

  .chat-area-header { padding: 10px 15px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px; background: var(--card); z-index: 10; }
  .current-chat-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer; }
  .current-chat-info { flex: 1; cursor: pointer; }
  .current-chat-name { font-weight: 700; font-size: 15px; }
  .current-chat-status { font-size: 11px; color: var(--muted); display: flex; align-items: center; gap: 5px; }
  
  .chat-actions { display: flex; gap: 5px; }
  .chat-action-btn { background: transparent; border: none; color: var(--muted); cursor: pointer; font-size: 16px; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
  .chat-action-btn:hover { background: rgba(0,97,255,0.1); color: var(--primary); }

  .messages-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
  
  .message { display: flex; gap: 10px; max-width: 75%; position: relative; }
  .message.sent { align-self: flex-end; flex-direction: row-reverse; }
  .message.received { align-self: flex-start; }
  
  .message-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; align-self: flex-end; margin-bottom: 5px; }
  
  .message-bubble { padding: 10px 14px; border-radius: 18px; position: relative; word-wrap: break-word; font-size: 14px; line-height: 1.5; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
  .received .message-bubble { background: var(--their-msg-bg); border-bottom-left-radius: 4px; }
  .sent .message-bubble { background: var(--my-msg-bg); color: white; border-bottom-right-radius: 4px; }
  
  .message-image { max-width: 200px; border-radius: 10px; margin-bottom: 5px; cursor: pointer; }
  .message-time { font-size: 10px; opacity: 0.7; margin-top: 4px; text-align: right; }
  .reaction-badge { position: absolute; bottom: -8px; right: 0; background: var(--card); border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; padding: 2px 6px; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 2; }

  /* Input Area */
  .message-input-container { padding: 15px; background: var(--card); border-top: 1px solid rgba(0,0,0,0.05); }
  .ai-mode-toggle { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer; width: fit-content; }
  .ai-toggle-switch { width: 30px; height: 16px; background: #ccc; border-radius: 10px; position: relative; transition: 0.3s; }
  .ai-toggle-switch.active { background: var(--primary); }
  .ai-toggle-knob { width: 12px; height: 12px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.3s; }
  .ai-toggle-switch.active .ai-toggle-knob { transform: translateX(14px); }
  
  .message-input-wrapper { display: flex; align-items: flex-end; gap: 10px; background: var(--bg); padding: 8px 12px; border-radius: 24px; border: 1px solid rgba(0,0,0,0.1); }
  .message-input { flex: 1; background: transparent; border: none; resize: none; max-height: 120px; outline: none; padding: 8px; font-family: inherit; font-size: 15px; color: var(--text); }
  .input-actions { display: flex; gap: 5px; }
  .input-action-btn { background: transparent; border: none; color: var(--muted); cursor: pointer; padding: 8px; border-radius: 50%; transition: 0.2s; }
  .input-action-btn:hover { color: var(--primary); background: rgba(0,0,0,0.05); }
  .send-button { background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: 0.2s; margin-left: 5px; }
  .send-button:hover { transform: scale(1.05); }

  /* Modals */
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
  .modal-content { background: var(--card); width: 100%; max-width: 400px; border-radius: 16px; padding: 20px; box-shadow: var(--shadow); display: flex; flex-direction: column; max-height: 80vh; }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.1); }
  .close-modal { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); }
  
  .user-search-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; }
  .user-search-item:hover { background: rgba(0,97,255,0.05); }

  /* Context Menu for Edit/Delete */
  .context-menu { display: none; position: absolute; background: var(--card); box-shadow: 0 2px 10px rgba(0,0,0,0.2); border-radius: 8px; z-index: 100; overflow: hidden; min-width: 120px; }
  .context-menu-item { padding: 10px 15px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px; }
  .context-menu-item:hover { background: rgba(0,0,0,0.05); }
  .context-menu-item.delete { color: #ef4444; }

  /* Mobile Responsive */
  @media (max-width: 900px) {
    aside { width: 70px; }
    aside button span { display: none; }
    aside button { justify-content: center; }
    .conversations-sidebar { width: 100%; position: absolute; z-index: 20; transition: transform 0.3s; }
    .conversations-sidebar.hidden { transform: translateX(-100%); }
    .chat-area { width: 100%; position: absolute; z-index: 10; }
    .brand, .search { display: none; }
  }
</style>
</head>
<body>

<svg style="position:absolute;width:0;height:0" aria-hidden>
  <defs><mask id="m-mask" viewBox="0 0 100 100"><path fill="white" d="M10 80 L10 20 L30 60 L50 20 L70 60 L90 20 L90 80 L70 40 L50 80 L30 40 Z"/></mask></defs>
</svg>

<header>
  <div class="left">
    <div class="logo-icon" title="MEET"></div>
    <div class="brand">MEET</div>
  </div>
  <div class="search">
    <span>üîç</span>
    <input id="globalSearch" placeholder="Search..." />
  </div>
  <div class="header-right">
    <button id="darkToggle" style="background:transparent;border:none;font-size:20px;cursor:pointer">üåô</button>
    <img id="currentUserPic" src="https://via.placeholder.com/38" style="width:38px;height:38px;border-radius:50%;border:2px solid #fff;object-fit:cover; cursor:pointer;" onclick="window.location.href='profile.html'">
  </div>
</header>

<div class="layout">
  <aside>
    <button onclick="window.location.href='feed.html'">üè† <span class="menu-text">Feed</span></button>
    <button class="active" onclick="window.location.href='chat.html'">üí¨ <span class="menu-text">Chat</span></button>
    <button onclick="window.location.href='conference.html'">üé• <span class="menu-text">Conference</span></button>
    <button onclick="window.location.href='marketplace.html'">üõí <span class="menu-text">Marketplace</span></button>
    <button onclick="window.location.href='profile.html'">üë§ <span class="menu-text">Profile</span></button>
    <button onclick="window.location.href='meetversity.html'">üéì <span class="menu-text">Meetversity</span></button>
    <button onclick="window.location.href='organization.html'">üè¢ <span class="menu-text">Organization</span></button>
  </aside>

  <main>
    <div class="chat-container">
      <div class="conversations-sidebar" id="conversationsSidebar">
        <div class="chat-header">
          <div class="chat-title">Discussions</div>
          <button class="new-chat-btn" onclick="openSearchModal()">+</button>
        </div>
        <div class="conversations-list" id="conversationsList">
          <div style="text-align:center; padding:20px; color:var(--muted);">Loading chats...</div>
        </div>
      </div>

      <div class="chat-area" id="chatArea">
        <div class="empty-chat" id="emptyChat">
          <i class="fas fa-comments"></i>
          <h3>Select a conversation</h3>
          <p>Click + to start a new chat with anyone.</p>
</div>

        <div class="chat-area-header" id="chatHeader" style="display:none;">
          <img src="https://via.placeholder.com/40" alt="Avatar" class="current-chat-avatar" id="currentChatAvatar">
          <div class="current-chat-info">
            <div class="current-chat-name" id="currentChatName"></div>
            <div class="current-chat-status" id="currentChatStatus"></div>
          </div>
          <div class="chat-actions">
            <button class="chat-action-btn" title="Call"><i class="fas fa-phone"></i></button>
            <button class="chat-action-btn" title="Video Call"><i class="fas fa-video"></i></button>
            <button class="chat-action-btn" title="More"><i class="fas fa-ellipsis-h"></i></button>
          </div>
        </div>

        <div class="messages-container" id="messagesContainer" style="display:none;"></div>

        <div class="message-input-container" id="messageInputContainer" style="display:none;">
          <div class="ai-mode-toggle" onclick="toggleAIMode()">
            <span>AI Auto-Reply</span>
            <div class="ai-toggle-switch" id="aiToggle">
              <div class="ai-toggle-knob"></div>
            </div>
          </div>
          <div class="message-input-wrapper">
            <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
            <div class="input-actions">
              <button class="input-action-btn" id="attachImageBtn" title="Attach Image"><i class="fas fa-image"></i></button>
              <input type="file" id="imageInput" accept="image/*" style="display:none;">
            </div>
            <button class="send-button" id="sendBtn"><i class="fas fa-paper-plane"></i></button>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<div class="modal" id="userSearchModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Start New Chat</h3>
      <button class="close-modal" onclick="closeSearchModal()">&times;</button>
    </div>
    <input type="text" id="userSearchInput" placeholder="Search users..." oninput="searchUsers()" style="padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.1);margin-bottom:10px;">
    <div id="userSearchResults" style="overflow-y:auto; max-height:300px;"></div>
  </div>
</div>

<div class="context-menu" id="messageContextMenu">
  <div class="context-menu-item" id="editMessage"><i class="fas fa-edit"></i> Edit</div>
  <div class="context-menu-item delete" id="deleteMessage"><i class="fas fa-trash"></i> Delete</div>
</div>

<script type="module">
// --- FIREBASE IMPORTS ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
import { getFirestore, collection, doc, query, where, onSnapshot, addDoc, setDoc, getDoc, getDocs, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
// NOTE: Firebase Storage is NOT imported as we are using Cloudinary for uploads

// --- CONFIGURATION ---
const firebaseConfig = {
  apiKey: "YOUR_FIREBASE_API_KEY", // <--- REPLACE
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  // storageBucket: "YOUR_PROJECT.appspot.com", // Not strictly needed if using Cloudinary
  messagingSenderId: "SENDER_ID",
  appId: "APP_ID"
};

const CLOUDINARY_UPLOAD_URL = "https://api.cloudinary.com/v1_1/YOUR_CLOUD_NAME/image/upload"; // <--- REPLACE 'YOUR_CLOUD_NAME'
const CLOUDINARY_UPLOAD_PRESET = "YOUR_UPLOAD_PRESET"; // <--- REPLACE

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let currentChatId = null;
let currentOtherUserId = null;
let aiMode = false;

// --- UTILITY FUNCTIONS ---

function getChatId(uid1, uid2) {
    return [uid1, uid2].sort().join("_");
}

function getOtherUserIdFromChat(participants) {
    return participants.find(uid => uid !== currentUser.uid);
}

// Simple Dark Mode Toggle
(function initTheme(){
    const t = localStorage.getItem('meet_theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme:dark)').matches ? 'dark' : 'light');
    if(t==='dark') document.body.classList.add('dark');
    document.getElementById('darkToggle').textContent = t === 'dark' ? '‚òÄÔ∏è' : 'üåô';
})();
document.getElementById('darkToggle').addEventListener('click', ()=>{
    document.body.classList.toggle('dark');
    const now = document.body.classList.contains('dark') ? 'dark' : 'light';
    localStorage.setItem('meet_theme', now);
    document.getElementById('darkToggle').textContent = now === 'dark' ? '‚òÄÔ∏è' : 'üåô';
});


// --- AUTH & INITIALIZATION ---
// DEMO: Sign in anonymously for testing. Replace with your actual login logic.
signInAnonymously(auth).catch(error => console.error("Anonymous Sign-in Failed:", error));

onAuthStateChanged(auth, user => {
  if(user){
    currentUser = user;
    // NOTE: In a real app, user.photoURL is set during user creation.
    document.getElementById('currentUserPic').src = user.photoURL || 'https://i.pravatar.cc/38?img=' + (user.uid.charCodeAt(0) % 70); 
    loadConversations();
  } else {
    // Redirect or show login UI
    console.log("User logged out or failed to log in.");
  }
});

// --- CLOUDINARY UPLOAD ---
async function uploadImageToCloudinary(file) {
    if (!file) return null;

    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
    formData.append('folder', 'meet_chat_uploads');

    try {
        const response = await fetch(CLOUDINARY_UPLOAD_URL, {
            method: 'POST',
            body: formData,
        });

        if (!response.ok) {
            throw new Error(`Cloudinary upload failed: ${response.statusText}`);
        }

        const data = await response.json();
        return data.secure_url;
    } catch (error) {
        console.error("Error uploading to Cloudinary:", error);
        alert("Failed to upload image. Check console for details.");
        return null;
    }
}


// --- CONVERSATIONS ---

function loadConversations(){
  if (!currentUser) return;
  const conversationsRef = collection(db, "chats");
  // Query chats where 'users' array contains the current user's UID
  const q = query(conversationsRef, where("users", "array-contains", currentUser.uid), orderBy("lastUpdated", "desc"));
  
  onSnapshot(q, async snapshot => {
    const list = document.getElementById("conversationsList");
    list.innerHTML = "";
    
    // Fetch all user names concurrently for efficiency
    const userIdsToFetch = new Set();
    snapshot.docs.forEach(docSnap => {
        const otherId = getOtherUserIdFromChat(docSnap.data().users);
        if (otherId) userIdsToFetch.add(otherId);
    });
    
    // Simple User Data Mock/Fetch
    const userMap = {};
    for (const userId of Array.from(userIdsToFetch)) {
        // In a real app, fetch from /users/{userId}
        const userDoc = await getDoc(doc(db, "users", userId)).catch(() => null);
        userMap[userId] = userDoc?.exists() ? userDoc.data() : { name: `User ${userId.substring(0, 5)}`, photoURL: `https://i.pravatar.cc/45?img=${userId.charCodeAt(0) % 70}` };
    }

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const otherUserId = getOtherUserIdFromChat(data.users);
      const otherUser = userMap[otherUserId];
      
      const item = document.createElement("div");
      item.className = "conversation-item";
      if (docSnap.id === currentChatId) item.classList.add('active');
      
      const lastMessage = data.lastMessage || (data.imageUrl ? "Image sent" : "Start chatting...");
      const userPhoto = otherUser?.photoURL || 'https://via.placeholder.com/45';
      const userName = otherUser?.name || `User ${otherUserId?.substring(0, 5) || 'Unknown'}`;
      
      item.innerHTML = `<img src="${userPhoto}" class="conversation-avatar">
                        <div class="conversation-info">
                          <div class="conversation-name">${userName}</div>
                          <div class="conversation-preview">${lastMessage}</div>
                        </div>
                        <div class="conversation-time">${data.lastUpdated ? formatTimestamp(data.lastUpdated) : ''}</div>`;
                        
      item.onclick = () => openChat(docSnap.id, otherUserId, userName, userPhoto);
      list.appendChild(item);
    });
  });
}

function formatTimestamp(timestamp) {
    // Simple formatting: if today, show time; otherwise, show date
    const date = timestamp.toDate ? timestamp.toDate() : new Date();
    const now = new Date();
    if (date.toDateString() === now.toDateString()) {
        return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    } else {
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }
}

async function openChat(chatId, otherUserId, otherUserName, otherUserPhoto){
  currentChatId = chatId;
  currentOtherUserId = otherUserId;
  
  // UI Updates
  document.getElementById('emptyChat').style.display = 'none';
  document.getElementById('chatHeader').style.display = 'flex';
  document.getElementById('messagesContainer').style.display = 'flex';
  document.getElementById('messageInputContainer').style.display = 'block';
  document.getElementById('currentChatName').textContent = otherUserName;
  document.getElementById('currentChatAvatar').src = otherUserPhoto;
  
  // Update active status in sidebar
  document.querySelectorAll('.conversation-item').forEach(el => el.classList.remove('active'));
  document.querySelector(`#conversationsList div[onclick*="${chatId}"]`).classList.add('active');

  loadMessages(chatId);
  // Add listener for typing status or online status here
  // listenToStatus(otherUserId);
}

function loadMessages(chatId){
  const messagesRef = collection(db, "chats", chatId, "messages");
  const q = query(messagesRef, orderBy("timestamp", "asc"));
  const container = document.getElementById("messagesContainer");
  
  // Ensure we don't attach multiple listeners to the same container
  if (container.unsubscribe) container.unsubscribe();

  container.innerHTML = "";
  
  const unsubscribe = onSnapshot(q, snapshot => {
    container.innerHTML = "";
    snapshot.forEach(docSnap => {
      const msg = docSnap.data();
      const div = document.createElement("div");
      
      // Determine if sent or received (AI bot is considered received for layout)
      const isSent = msg.senderId === currentUser.uid;
      
      div.className = `message ${isSent ? 'sent' : 'received'}`;
      
      let content = msg.text ? `<div class="message-bubble">${msg.text}</div>` : '';
      if (msg.imageUrl) {
          content = `<div class="message-bubble"><img src="${msg.imageUrl}" class="message-image" alt="User Image"></div>`;
      }
      
      div.innerHTML = content;
      container.appendChild(div);
    });
    container.scrollTop = container.scrollHeight;
  });
  
  container.unsubscribe = unsubscribe; // Store the unsubscribe function
}


// --- MESSAGING ---

document.getElementById("sendBtn").addEventListener("click", () => sendMessage(null));
document.getElementById("messageInput").addEventListener("keydown", (e) => {
    // Send on Enter, unless Shift is pressed
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); 
        sendMessage(null);
    }
});

async function sendMessage(imageUrl = null){
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  
  if(!currentChatId || (!text && !imageUrl)) return;
  
  const messagesRef = collection(db, "chats", currentChatId, "messages");
  
  const messageData = {
    senderId: currentUser.uid,
    timestamp: serverTimestamp(),
  };

  if (imageUrl) {
      messageData.imageUrl = imageUrl;
  } else {
      messageData.text = text;
      input.value = ""; // Clear only for text message
  }

  // 1. Add Message
  await addDoc(messagesRef, messageData);
  
  // 2. Update Chat Metadata (for sidebar preview/ordering)
  await updateDoc(doc(db, "chats", currentChatId), {
      lastMessage: text || (imageUrl ? "Image" : "Message"),
      lastUpdated: serverTimestamp()
  });

  // 3. AI Auto-Reply (Simulated)
  if(aiMode && !imageUrl){
    setTimeout(async ()=>{
      await addDoc(messagesRef, {
        text: "AI Reply: Understood. I will process that request shortly.", 
        senderId: "ai_bot",
        timestamp: serverTimestamp()
      });
      await updateDoc(doc(db, "chats", currentChatId), {
        lastMessage: "AI Reply:...",
        lastUpdated: serverTimestamp()
      });
    }, 1500);
  }
}

// --- IMAGE UPLOAD ---
document.getElementById("attachImageBtn").addEventListener("click", ()=>document.getElementById("imageInput").click());
document.getElementById("imageInput").addEventListener("change", async e=>{
  if (!currentChatId) {
      alert("Please select a chat first.");
      e.target.value = ''; // Clear input
      return;
  }
  
  const file = e.target.files[0];
  e.target.value = ''; // Clear input to allow re-uploading the same file

  if(!file) return;

  const loadingText = document.getElementById('currentChatStatus');
  const originalText = loadingText.textContent;
  loadingText.textContent = "Uploading image...";

  const url = await uploadImageToCloudinary(file);
  
  loadingText.textContent = originalText;

  if (url) {
      await sendMessage(url);
  }
});


// --- AI TOGGLE ---
function toggleAIMode(){
  aiMode = !aiMode;
  document.getElementById("aiToggle").classList.toggle("active", aiMode);
  document.getElementById('currentChatStatus').textContent = aiMode ? "AI Mode: ON" : "AI Mode: OFF";
}
window.toggleAIMode = toggleAIMode; // Make accessible from inline HTML

// --- USER SEARCH MODAL ---
function openSearchModal(){ 
    document.getElementById("userSearchModal").style.display="flex"; 
    document.getElementById("userSearchResults").innerHTML = '';
    document.getElementById("userSearchInput").value = '';
}
function closeSearchModal(){ document.getElementById("userSearchModal").style.display="none"; }
window.openSearchModal = openSearchModal; // Make accessible from inline HTML
window.closeSearchModal = closeSearchModal; // Make accessible from inline HTML

async function searchUsers(){
    const name = document.getElementById("userSearchInput").value.trim();
    const resultsDiv = document.getElementById("userSearchResults");
    resultsDiv.innerHTML = '';
    
    if (name.length < 2) {
        resultsDiv.innerHTML = `<p style="text-align:center; color:var(--muted)">Type at least 2 characters to search.</p>`;
        return;
    }
    
    // In a real app, this query needs a proper Firestore index for case-insensitive search.
    // We'll simulate a search for users whose name STARTS WITH the input.
    const q = query(collection(db, "users"), 
        where("name", ">=", name),
        where("name", "<=", name + '\uf8ff'),
        limit(10)
    );
    
    const snapshot = await getDocs(q);
    
    if (snapshot.empty) {
        resultsDiv.innerHTML = `<p style="text-align:center; color:var(--muted)">No users found.</p>`;
        return;
    }
    
    snapshot.forEach(docSnap => {
        const user = docSnap.data();
        if (docSnap.id === currentUser.uid) return; // Don't show current user
        
        const item = document.createElement("div");
        item.className = "user-search-item";
        item.innerHTML = `<img src="${user.photoURL || 'https://via.placeholder.com/40'}" class="conversation-avatar" style="width:40px;height:40px;">
                          <span>${user.name}</span>`;
        item.onclick = () => createAndOpenChat(docSnap.id, user.name, user.photoURL);
        resultsDiv.appendChild(item);
    });
}
window.searchUsers = searchUsers; // Make accessible from inline HTML

async function createAndOpenChat(otherUserId, otherUserName, otherUserPhoto) {
    const chatId = getChatId(currentUser.uid, otherUserId);
    const chatRef = doc(db, "chats", chatId);
    const chatSnap = await getDoc(chatRef);
    
    if (!chatSnap.exists()) {
        await setDoc(chatRef, {
            users: [currentUser.uid, otherUserId],
            lastMessage: "Conversation started.",
            lastUpdated: serverTimestamp()
        });
    }
    
    closeSearchModal();
    // After creation/check, open the chat
    openChat(chatId, otherUserId, otherUserName, otherUserPhoto);
    loadConversations(); // Refresh sidebar to show new chat
}

</script>
</body>
</html>
