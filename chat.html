<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MEET | Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root{
    --primary:#0061FF;
    --accent:#5AE4A8;
    --bg:#f7f9fb;
    --card:#fff;
    --text:#111827;
    --muted:#6b7280;
    --radius:12px;
    --shadow: 0 6px 18px rgba(16,24,40,0.06);
    --my-msg-bg: linear-gradient(90deg, var(--primary), var(--accent));
    --their-msg-bg: #fff;
  }
  body.dark {
    --bg:#081226;
    --card:#0b1726;
    --text:#e6eef8;
    --muted:#93a3bd;
    --shadow: 0 6px 18px rgba(0,0,0,0.6);
    --their-msg-bg: #1f2937;
  }
  /* Base Styles from mock code */
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter,system-ui,Segoe UI,Arial; background:var(--bg); color:var(--text);
    height:100vh; display:flex; flex-direction:column; transition:background .35s,color .35s; overflow: hidden;
  }
  header{ display:flex; align-items:center; gap:16px; padding:12px 20px; background:var(--card); box-shadow:var(--shadow); position:sticky; top:0; z-index:50; }
  .left { display:flex; align-items:center; gap:12px; }
  .logo-icon{ width:44px;height:44px;border-radius:8px; background:linear-gradient(135deg,var(--primary),var(--accent)); display:flex;align-items:center;justify-content:center; -webkit-mask:url('#m-mask');mask:url('#m-mask') center/contain no-repeat; }
  .brand { font-weight:700;font-size:18px;color:var(--primary); }
  .search { flex:1;display:flex;align-items:center;gap:10px;background:#eef3ff;border-radius:10px;padding:8px 12px; max-width:600px; }
  body.dark .search{background:#0f2134}
  .search input{border:0;background:transparent;outline:none;width:100%;color:var(--text)}
  .header-right{display:flex;align-items:center;gap:10px}
  .layout{display:flex;flex:1;overflow:hidden}
  aside{ width:240px;background:var(--card);padding:18px;border-right:1px solid rgba(0,0,0,0.03); display:flex;flex-direction:column;gap:8px;box-shadow:var(--shadow); transition: width 0.3s ease; }
  aside button{ border:0;background:transparent;padding:12px 14px;border-radius:10px;text-align:left;font-weight:600;color:var(--muted);cursor:pointer; display: flex; align-items: center; gap: 12px; text-decoration: none; width: 100%; font-family: inherit; font-size: inherit; }
  aside button.active{color:var(--primary);background:linear-gradient(90deg, rgba(0,97,255,0.06), rgba(90,228,168,0.03));}
  main{flex:1;padding:0;overflow:hidden;display:flex;}
  .chat-container { display: flex; width: 100%; height: 100%; }
  .conversations-sidebar { width: 320px; background: var(--card); border-right: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; height: 100%; z-index: 20; }
  .chat-header { padding: 15px 20px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
  .chat-title { font-size: 18px; font-weight: 700; }
  .new-chat-btn { background: linear-gradient(90deg, var(--primary), var(--accent)); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
  .chat-search { padding: 12px 20px; border-bottom: 1px solid rgba(0,0,0,0.05); }
  .chat-search input { width: 100%; padding: 10px 15px; border-radius: 20px; border: 1px solid rgba(0,0,0,0.1); background: var(--bg); font-size: 14px; color: var(--text); }
  .conversations-list { flex: 1; overflow-y: auto; padding: 8px 0; }
  .conversation-item { display: flex; align-items: center; gap: 12px; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.03); transition: background 0.2s; }
  .conversation-item:hover, .conversation-item.active { background: rgba(0,97,255,0.05); }
  .conversation-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; position: relative; }
  .online-indicator { position: absolute; bottom: 2px; right: 2px; width: 10px; height: 10px; border-radius: 50%; background: #34D399; border: 2px solid var(--card); }
  .conversation-info { flex: 1; min-width: 0; }
  .conversation-name { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
  .conversation-preview { font-size: 12px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .conversation-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
  .conversation-time { font-size: 11px; color: var(--muted); }
  .unread-badge { background: linear-gradient(90deg, var(--primary), var(--accent)); color: white; border-radius: 10px; padding: 2px 6px; font-size: 10px; font-weight: 700; min-width: 16px; text-align: center; }
  .chat-area { flex: 1; display: flex; flex-direction: column; height: 100%; background: var(--bg); position: relative; }
  .chat-area-header { padding: 12px 15px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; gap: 10px; background: var(--card); z-index: 10; }
  .current-chat-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
  .current-chat-info { flex: 1; cursor: pointer; }
  .current-chat-name { font-weight: 700; font-size: 15px; }
  .current-chat-status { font-size: 11px; color: var(--muted); }
  .chat-actions { display: flex; gap: 8px; }
  .chat-action-btn { background: transparent; border: none; color: var(--muted); cursor: pointer; font-size: 16px; padding: 5px; transition: color 0.2s; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
  .chat-action-btn:hover { background: rgba(0,0,0,0.05); color: var(--primary); }
  .back-button { display: none; background: transparent; border: none; font-size: 18px; cursor: pointer; padding: 5px; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
  .messages-container { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
  .message { display: flex; gap: 8px; max-width: 75%; }
  .message.sent { align-self: flex-end; flex-direction: row-reverse; }
  .message-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; align-self: flex-end; }
  .message-bubble { padding: 10px 14px; border-radius: 16px; position: relative; word-wrap: break-word; max-width: 100%; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
  .received .message-bubble { background: var(--their-msg-bg); border-bottom-left-radius: 4px; }
  .sent .message-bubble { background: var(--my-msg-bg); color: white; border-bottom-right-radius: 4px; }
  .message-text { margin: 0; font-size: 14px; line-height: 1.4; white-space: pre-wrap; }
  .message-time { font-size: 10px; opacity: 0.8; margin-top: 4px; text-align: right; display: block; }
  .ai-assistant .message-bubble { background: linear-gradient(135deg, #8B5CF6, #EC4899); color: white; border-radius: 16px; border-bottom-left-radius: 4px; }
  .message-input-container { padding: 10px 15px 20px; border-top: 1px solid rgba(0,0,0,0.05); background: var(--card); }
  .message-input-wrapper { display: flex; align-items: flex-end; gap: 8px; }
  .message-input-actions { display: flex; gap: 8px; margin-bottom: 8px; }
  .input-action { background: transparent; border: none; color: var(--muted); cursor: pointer; font-size: 20px; padding: 8px; transition: color 0.2s; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
  .input-action:hover { background: rgba(0,0,0,0.05); color: var(--primary); }
  .message-input { flex: 1; padding: 12px 16px; border-radius: 24px; border: 1px solid rgba(0,0,0,0.1); background: var(--bg); resize: none; font-family: inherit; font-size: 15px; line-height: 1.4; min-height: 50px; max-height: 150px; outline: none; color: var(--text); overflow-y: hidden; }
  .send-button { background: linear-gradient(90deg, var(--primary), var(--accent)); color: white; border: none; width: 48px; height: 48px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: var(--shadow); transition: transform 0.2s; flex-shrink: 0; margin-bottom: 4px; }
  .send-button:hover { transform: scale(1.05); }
  .smart-suggestions { display: flex; gap: 6px; margin-bottom: 10px; flex-wrap: wrap; }
  .suggestion-chip { background: rgba(0,97,255,0.1); border: 1px solid rgba(0,97,255,0.2); color: var(--primary); padding: 6px 12px; border-radius: 16px; font-size: 12px; cursor: pointer; transition: background 0.2s; }
  .suggestion-chip:hover { background: rgba(0,97,255,0.2); }
  .ai-mode-toggle { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: rgba(0,97,255,0.1); border-radius: 16px; margin-bottom: 10px; cursor: pointer; width: fit-content; }
  .ai-mode-text { font-size: 12px; font-weight: 600; color: var(--primary); }
  .ai-toggle-switch { width: 36px; height: 20px; background: #ccc; border-radius: 10px; position: relative; transition: background 0.3s; }
  .ai-toggle-switch.active { background: var(--primary); }
  .ai-toggle-knob { width: 16px; height: 16px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: transform 0.3s; }
  .ai-toggle-switch.active .ai-toggle-knob { transform: translateX(16px); }
  .empty-chat { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; padding: 30px; color: var(--muted); }
  .empty-chat-icon { font-size: 40px; margin-bottom: 12px; }
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
  .modal-content { background: var(--card); width: 100%; max-width: 400px; border-radius: 16px; padding: 20px; box-shadow: var(--shadow); display: flex; flex-direction: column; max-height: 80vh; }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.1); }
  .close-modal { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted); }
  .user-search-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; }
  .user-search-item:hover { background: rgba(0,97,255,0.05); }

  /* New Feature Styles (from mock code, adapted) */
  .media-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px; }
  .media-option { display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 12px; background: var(--bg); border-radius: var(--radius); cursor: pointer; transition: background 0.2s; }
  .media-option:hover { background: rgba(0,97,255,0.1); }
  .media-option-icon { font-size: 20px; }
  .media-option-text { font-size: 11px; font-weight: 600; }

  /* Video Call Interface */
  .video-call-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: none; flex-direction: column; z-index: 2000; }
  .video-call-header { padding: 12px 15px; background: var(--card); display: flex; justify-content: space-between; align-items: center; }
  .video-call-main { flex: 1; display: flex; position: relative; background: #000; }
  .video-remote, .video-local { width: 100%; height: 100%; object-fit: cover; background: #333; }
  .video-local { position: absolute; bottom: 15px; right: 15px; width: 120px; height: 90px; border-radius: var(--radius); object-fit: cover; border: 2px solid var(--card); }
  .video-call-controls { padding: 15px; background: var(--card); display: flex; justify-content: center; gap: 12px; }
  .call-control-btn { width: 45px; height: 45px; border-radius: 50%; border: none; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  .call-end-btn { background: #ff4444; color: white; }
  .call-action-btn { background: var(--card); color: var(--text); }
  .call-action-btn.active { background: var(--primary); color: white; } /* Active state for controls */
  #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--card); color: var(--text); padding: 12px 20px; border-radius: 8px; box-shadow: var(--shadow); z-index: 1000; font-size: 14px; display: none; }
  
  /* Mobile Responsive (Adapted from mock code) */
  @media (max-width: 900px) {
    aside { width: 70px; }
    aside button span { display: none; }
    aside button { justify-content: center; }
    .conversations-sidebar { width: 100%; position: absolute; transform: translateX(0); transition: transform 0.3s ease; }
    .conversations-sidebar.hidden { transform: translateX(-100%); }
    .chat-area { width: 100%; position: absolute; transform: translateX(100%); transition: transform 0.3s ease; }
    .chat-area.active { transform: translateX(0); }
    .back-button { display: flex; }
    .brand, .search { display: none; }
  }
</style>
</head>
<body>

<svg style="position:absolute;width:0;height:0" aria-hidden>
  <defs><mask id="m-mask" viewBox="0 0 100 100"><path fill="white" d="M10 80 L10 20 L30 60 L50 20 L70 60 L90 20 L90 80 L70 40 L50 80 L30 40 Z"/></mask></defs>
</svg>

<header>
  <div class="left">
    <div class="logo-icon" title="MEET"></div>
    <div class="brand">MEET</div>
  </div>

  <div class="search">
    <span><i class="fas fa-search"></i></span>
    <input id="globalSearch" placeholder="Search..." />
  </div>

  <div class="header-right">
    <button id="goLive" style="background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;border:0;padding:6px 10px;border-radius:6px;font-weight:700;font-size:11px" onclick="comingSoon('Go Live')">
      Go Live
    </button>
    <button id="darkToggle" title="Toggle dark mode">üåô</button>
    <div style="display:flex;align-items:center;gap:8px">
      <img id="currentUserPic" src="https://i.pravatar.cc/100?img=5" style="width:38px;height:38px;border-radius:50%;border:2px solid #fff;object-fit:cover; cursor:pointer;" onclick="navigateTo('profile.html')">
    </div>
  </div>
</header>

<div class="layout">
  <aside>
    <button onclick="navigateTo('feed.html')"><i class="fas fa-home"></i> <span class="menu-text">Feed</span></button>
    <button class="active" onclick="navigateTo('chat.html')"><i class="fas fa-comment-dots"></i> <span class="menu-text">Chat</span></button>
    <button onclick="navigateTo('conference.html')"><i class="fas fa-video"></i> <span class="menu-text">Conference</span></button>
    <button onclick="navigateTo('marketplace.html')"><i class="fas fa-store"></i> <span class="menu-text">Marketplace</span></button>
    <button onclick="navigateTo('profile.html')"><i class="fas fa-user"></i> <span class="menu-text">Profile</span></button>
    <button onclick="navigateTo('meetversity.html')"><i class="fas fa-graduation-cap"></i> <span class="menu-text">Meetversity</span></button>
    <button onclick="navigateTo('organization.html')"><i class="fas fa-building"></i> <span class="menu-text">Organization</span></button>
    <div style="flex:1"></div>
  </aside>

  <main>
    <div class="chat-container">
      <div class="conversations-sidebar" id="conversationsSidebar">
        <div class="chat-header">
          <div class="chat-title">Discussions</div>
          <button class="new-chat-btn" onclick="openSearchModal()"><i class="fas fa-plus"></i></button>
        </div>
        
        <div class="chat-search">
          <input type="text" placeholder="Search conversations..." id="chatSearch">
        </div>
        
        <div class="conversations-list" id="conversationsList">
          <div style="text-align:center; padding:20px; color:var(--muted);">Loading chats...</div>
        </div>
      </div>

      <div class="chat-area" id="chatArea">
        <div class="empty-chat" id="emptyChat">
          <div class="empty-chat-icon"><i class="fas fa-comments"></i></div>
          <h3>Select a conversation</h3>
          <p>Choose a chat from the sidebar or click + to start a new conversation</p>
        </div>
        
        <div class="chat-area-header" id="chatHeader" style="display: none;">
          <button class="back-button" onclick="showConversationsView()"><i class="fas fa-arrow-left"></i></button>
          <img src="" alt="" class="current-chat-avatar" id="currentChatAvatar" onclick="viewProfile()">
          <div class="current-chat-info" onclick="viewProfile()">
            <div class="current-chat-name" id="currentChatName"></div>
            <div class="current-chat-status" id="currentChatStatus"></div>
          </div>
          <div class="chat-actions">
            <button class="chat-action-btn" onclick="startVoiceCall()" title="Voice Call"><i class="fas fa-phone"></i></button>
            <button class="chat-action-btn" onclick="startVideoCall()" title="Video Call"><i class="fas fa-video"></i></button>
            <button class="chat-action-btn" onclick="viewProfile()" title="View Profile"><i class="fas fa-info-circle"></i></button>
          </div>
        </div>
        
        <div class="messages-container" id="messagesContainer" style="display: none;">
          </div>
        
        <div class="message-input-container" id="messageInputContainer" style="display: none;">
          <div class="ai-mode-toggle" id="aiModeToggle">
            <div class="ai-mode-text">AI Auto-Reply</div>
            <div class="ai-toggle-switch" id="aiSwitch">
              <div class="ai-toggle-knob"></div>
            </div>
          </div>
          <div class="smart-suggestions" id="smartSuggestions">
            </div>
          <div class="message-input-wrapper">
            <div class="message-input-actions">
              <input type="file" id="imageInput" accept="image/*" style="display:none">
              <button class="input-action" onclick="document.getElementById('imageInput').click()" title="Attach Photo"><i class="fas fa-image"></i></button>
              <button class="input-action" onclick="openMediaModal()" title="Attach File"><i class="fas fa-paperclip"></i></button>
              <button class="input-action" onclick="sendVoiceMessage()" title="Voice Message"><i class="fas fa-microphone"></i></button>
            </div>
            <textarea class="message-input" placeholder="Type a message..." id="messageInput" rows="1"></textarea>
            <button class="send-button" id="sendButton"><i class="fas fa-paper-plane"></i></button>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<div class="modal" id="searchModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>New Chat</h3>
      <button class="close-modal" onclick="closeSearchModal()">√ó</button>
    </div>
    <div style="background:var(--bg); padding:8px; border-radius:8px; margin-bottom:10px; display:flex; gap:10px;">
      <i class="fas fa-search" style="color:var(--muted); padding-top:4px;"></i>
      <input type="text" id="userSearchInput" placeholder="Search by name or email..." style="background:transparent; border:none; width:100%; outline:none; color:var(--text);">
    </div>
    <div id="searchResults" style="overflow-y:auto; flex:1;"></div>
  </div>
</div>

<div class="modal" id="mediaModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Send Media</h3>
      <button class="close-modal" onclick="closeMediaModal()">√ó</button>
    </div>
    <div class="media-options">
      <div class="media-option" onclick="comingSoon('Document')">
        <div class="media-option-icon"><i class="fas fa-file-alt"></i></div>
        <div class="media-option-text">Document</div>
      </div>
      <div class="media-option" onclick="comingSoon('Video')">
        <div class="media-option-icon"><i class="fas fa-video"></i></div>
        <div class="media-option-text">Video</div>
      </div>
      <div class="media-option" onclick="comingSoon('Music')">
        <div class="media-option-icon"><i class="fas fa-music"></i></div>
        <div class="media-option-text">Music</div>
      </div>
      <div class="media-option" onclick="comingSoon('Location')">
        <div class="media-option-icon"><i class="fas fa-map-marker-alt"></i></div>
        <div class="media-option-text">Location</div>
      </div>
      <div class="media-option" onclick="comingSoon('Contact')">
        <div class="media-option-icon"><i class="fas fa-user-circle"></i></div>
        <div class="media-option-text">Contact</div>
      </div>
    </div>
  </div>
</div>

<div class="video-call-modal" id="videoCallModal">
  <div class="video-call-header">
    <div id="callTimer">00:00</div>
    <div id="callStatus">Video Call - <span id="callUserName"></span></div>
    <button class="call-action-btn" onclick="endCall()"><i class="fas fa-times"></i></button>
  </div>
  <div class="video-call-main">
    <video class="video-remote" id="remoteVideo" autoplay muted></video>
    <video class="video-local" id="localVideo" autoplay muted></video>
    </div>
  <div class="video-call-controls">
    <button class="call-action-btn" id="muteBtn" onclick="toggleMute()" title="Mute/Unmute"><i class="fas fa-microphone"></i></button>
    <button class="call-action-btn" id="videoBtn" onclick="toggleVideo()" title="Toggle Video"><i class="fas fa-video"></i></button>
    <button class="call-end-btn" onclick="endCall()" title="End Call"><i class="fas fa-phone-slash"></i></button>
    <button class="call-action-btn" id="speakerBtn" onclick="toggleSpeaker()" title="Toggle Speaker"><i class="fas fa-volume-up"></i></button>
  </div>
</div>

<div id="toast"></div>

<script type="module">
  // --- FIREBASE IMPORTS ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getFirestore, collection, addDoc, doc, getDoc, getDocs, onSnapshot, query, orderBy, where, setDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";
  
  // --- FIREBASE CONFIG (REPLACE WITH YOUR ACTUAL CREDENTIALS) ---
  const firebaseConfig = {
    apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
    authDomain: "meet-6e159.firebaseapp.com",
    databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",
    projectId: "meet-6e159",
    storageBucket: "meet-6e159.appspot.com", // Changed to default Firebase Storage URL
    messagingSenderId: "252353608421",
    appId: "1:2523536048e9a8f12db20c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  let currentUser = null;
  let currentChatId = null;
  let currentChatUser = null;
  let aiEnabled = false;
  let isMobile = window.innerWidth <= 900;
  let callTimer = null;
  let callSeconds = 0;

  // --- Utility Functions ---

  window.navigateTo = (page) => { if (window.location.href.indexOf(page) === -1) window.location.href = page; };
  window.comingSoon = (feature) => showToast(`${feature} feature is coming soon!`);
  window.openSearchModal = () => {
      document.getElementById('searchModal').style.display = 'flex';
      document.getElementById('userSearchInput').value = '';
      document.getElementById('searchResults').innerHTML = '';
      document.getElementById('userSearchInput').focus();
  };
  window.closeSearchModal = () => document.getElementById('searchModal').style.display = 'none';

  window.openMediaModal = () => document.getElementById('mediaModal').style.display = 'flex';
  window.closeMediaModal = () => document.getElementById('mediaModal').style.display = 'none';
  window.sendVoiceMessage = () => comingSoon('Voice Message');


  function showToast(message) {
    let toast = document.getElementById('toast');
    if (!toast) {
      toast = document.createElement('div');
      toast.id = 'toast';
      document.body.appendChild(toast);
    }
    toast.textContent = message;
    toast.style.display = 'block';
    setTimeout(() => { toast.style.display = 'none'; }, 3000);
  }

  function updateAIToggleUI() {
      const btn = document.getElementById('aiSwitch');
      if(aiEnabled) btn.classList.add('active');
      else btn.classList.remove('active');
  }
  
  window.toggleAIMode = async () => {
      aiEnabled = !aiEnabled;
      updateAIToggleUI();
      const message = aiEnabled ? 'AI Auto-Reply enabled' : 'Manual Reply mode enabled';
      showToast(message);

      if (currentUser) {
          await updateDoc(doc(db, "users", currentUser.uid), { aiMode: aiEnabled }).catch(console.error);
      }
  };

  window.handleInputKey = (event) => {
      const input = document.getElementById('messageInput');
      // Auto-resize textarea
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 150) + 'px';

      if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
      }
  };
  
  window.showConversationsView = () => {
    document.getElementById('conversationsSidebar').classList.remove('hidden');
    document.getElementById('chatArea').classList.remove('active');
  };
  
  window.viewProfile = () => {
    if(currentChatUser) window.location.href = `profile.html?uid=${currentChatUser.uid}`;
  };

  // --- Auth Check & Initialization ---

  onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = 'login.html';
    currentUser = user;
    
    // Load basic user info (displayName, photoURL, aiMode)
    try {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if(userDoc.exists()) {
            const d = userDoc.data();
            document.getElementById('currentUserPic').src = d.photoURL || user.photoURL || 'https://i.pravatar.cc/100?img=5';
            aiEnabled = d.aiMode || false;
            updateAIToggleUI();
        }
    } catch (e) { console.error("Error loading current user data:", e); }
    
    loadConversations();
    setupDOMListeners();
  });

  function setupDOMListeners() {
      document.getElementById('sendButton').addEventListener('click', sendMessage);
      document.getElementById('messageInput').addEventListener('keydown', window.handleInputKey);
      document.getElementById('aiModeToggle').addEventListener('click', window.toggleAIMode);
      document.getElementById('userSearchInput').oninput = searchUsers;
      window.addEventListener('resize', () => {
        isMobile = window.innerWidth <= 900;
        if(currentChatId && isMobile) {
            document.getElementById('conversationsSidebar').classList.add('hidden');
            document.getElementById('chatArea').classList.add('active');
        }
      });
  }

  // --- Conversations List (Real-time) ---
  function loadConversations() {
    const list = document.getElementById('conversationsList');
    list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--muted);"><i class="fas fa-spinner fa-spin"></i> Loading chats...</div>';

    if (!currentUser) return;

    // Listen to chats where currentUser is one of the participants, ordered by lastUpdated
    const q = query(collection(db, "chats"), where("users", "array-contains", currentUser.uid), orderBy("lastUpdated", "desc"));
    
    if (list.unsubscribe) list.unsubscribe();

    list.unsubscribe = onSnapshot(q, async (snapshot) => {
      list.innerHTML = '';
      
      if (snapshot.empty) {
        list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--muted);"><i class="fas fa-exclamation-circle"></i> No conversations yet. Start one!</div>';
        return;
      }

      const userIdsToFetch = new Set();
      snapshot.docs.forEach(d => {
        const otherId = d.data().users.find(u => u !== currentUser.uid);
        if (otherId) userIdsToFetch.add(otherId);
      });

      const userMap = {};
      // Fetch all other user data efficiently
      const userPromises = Array.from(userIdsToFetch).map(async otherId => {
          const uData = await getDoc(doc(db, "users", otherId));
          userMap[otherId] = uData.exists() ? uData.data() : { displayName: 'Unknown User', photoURL: 'https://i.pravatar.cc/100?img=20', jobTitle: 'User' };
          userMap[otherId].uid = otherId;
      });
      await Promise.all(userPromises);

      snapshot.forEach(d => {
        const chat = d.data();
        const otherId = chat.users.find(u => u !== currentUser.uid);
        const otherUser = userMap[otherId];
        if (!otherUser) return; // Skip if user data failed to load

        const isActive = currentChatId === d.id;
        const lastUpdateTime = chat.lastUpdated ? new Date(chat.lastUpdated.toDate()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
        
        const convElement = document.createElement('div');
        convElement.className = `conversation-item ${isActive ? 'active' : ''}`;
        
        convElement.onclick = () => {
            document.querySelectorAll('.conversation-item').forEach(item => item.classList.remove('active'));
            convElement.classList.add('active');
            openChat(d.id, otherUser);
            if (isMobile) {
                document.getElementById('conversationsSidebar').classList.add('hidden');
                document.getElementById('chatArea').classList.add('active');
            }
        };

        convElement.innerHTML = `
          <div style="position:relative">
            <img src="${otherUser.photoURL || 'https://i.pravatar.cc/100?img=20'}" alt="${otherUser.displayName}" class="conversation-avatar">
            ${otherUser.online ? '<div class="online-indicator"></div>' : ''}
          </div>
          <div class="conversation-info">
            <div class="conversation-name">${otherUser.displayName}</div>
            <div class="conversation-preview">${chat.lastMessage || 'Start chatting'}</div>
          </div>
          <div class="conversation-meta">
            <div class="conversation-time">${lastUpdateTime}</div>
            </div>
        `;
        list.appendChild(convElement);
        
        // Auto-load the currently selected chat on refresh
        if (isActive) openChat(d.id, otherUser, false);
      });
    }, (error) => {
        console.error("Error fetching conversations: ", error);
        list.innerHTML = '<div style="text-align:center; padding:20px; color:red;"><i class="fas fa-exclamation-triangle"></i> Failed to load chats.</div>';
    });
  }

  // --- Chat Area ---
  window.openChat = (chatId, userObj, shouldScroll = true) => {
    if(currentChatId === chatId) return; // Prevent re-loading same chat

    currentChatId = chatId;
    currentChatUser = userObj;
    
    // UI Updates
    document.getElementById('emptyChat').style.display = 'none';
    document.getElementById('chatHeader').style.display = 'flex';
    document.getElementById('messagesContainer').style.display = 'flex';
    document.getElementById('messageInputContainer').style.display = 'block';
    
    // Header Info
    document.getElementById('currentChatAvatar').src = userObj.photoURL || 'https://i.pravatar.cc/100?img=20';
    document.getElementById('currentChatName').textContent = userObj.displayName;
    document.getElementById('currentChatStatus').textContent = (userObj.jobTitle || 'Member') + (userObj.online ? ' ‚Ä¢ Online' : ' ‚Ä¢ Offline');

    loadMessages(chatId, shouldScroll);
    updateSmartSuggestions(userObj);
  };

  function loadMessages(chatId, shouldScroll) {
    const q = query(collection(db, `chats/${chatId}/messages`), orderBy("createdAt", "asc"));
    const container = document.getElementById('messagesContainer');
    
    if (container.unsubscribe) container.unsubscribe();

    container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--muted);"><i class="fas fa-spinner fa-spin"></i> Loading messages...</div>';
    
    container.unsubscribe = onSnapshot(q, (snap) => {
        container.innerHTML = '';
        snap.forEach(d => {
            const msg = d.data();
            const isMe = msg.senderId === currentUser.uid;
            const isAI = msg.senderId === currentChatUser.uid && (msg.text || '').includes('AI Auto-Reply');
            const isSystem = msg.senderId === 'system';
            
            if (isSystem) {
                const sysDiv = document.createElement('div');
                sysDiv.style.textAlign = 'center';
                sysDiv.style.fontSize = '12px';
                sysDiv.style.color = 'var(--muted)';
                sysDiv.style.margin = '10px 0';
                sysDiv.textContent = msg.text;
                container.appendChild(sysDiv);
                return;
            }

            const div = document.createElement('div');
            div.className = `message ${isMe ? 'sent' : 'received'} ${isAI ? 'ai-assistant' : ''}`;
            
            const avatarSrc = isMe 
                ? document.getElementById('currentUserPic').src 
                : (currentChatUser?.photoURL || 'https://i.pravatar.cc/100?img=20'); 

            let content = '';
            // Basic support for image upload using text/url for now
            if(msg.image) content += `<img src="${msg.image}" style="max-width:100%; border-radius:8px; margin-bottom:5px; cursor:pointer;" alt="Shared Image" onclick="window.open('${msg.image}')">`;
            if(msg.text) content += `<p class="message-text">${msg.text}</p>`;
            
            const timeStr = msg.createdAt ? new Date(msg.createdAt.toDate()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...';

            // Check if AI response and add specific interaction
            let aiInteraction = '';
            if (isAI) {
                aiInteraction = `
                    <div class="quick-replies">
                        <div class="suggestion-chip" onclick="useSuggestion('Help me draft a professional introduction')">Draft intro</div>
                        <div class="suggestion-chip" onclick="useSuggestion('Find resources for UI/UX design')">Find resources</div>
                    </div>
                `;
            }

            div.innerHTML = `
                <img src="${avatarSrc}" class="message-avatar">
                <div class="message-bubble">
                    ${content}
                    ${aiInteraction}
                    <div class="message-time">${timeStr}</div>
                </div>
            `;
            container.appendChild(div);
        });
        if (shouldScroll) container.scrollTop = container.scrollHeight;
    }, (error) => {
        console.error("Error fetching messages: ", error);
        container.innerHTML = '<div style="text-align:center; padding:20px; color:red;"><i class="fas fa-exclamation-triangle"></i> Failed to load messages.</div>';
    });
  }

  // --- Sending Messages & Image Upload ---
  window.sendMessage = async () => {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    if(!text || !currentChatId || !currentUser) return;
    
    const messageData = {
        text: text,
        senderId: currentUser.uid,
        createdAt: serverTimestamp()
    };
    
    try {
        await addDoc(collection(db, `chats/${currentChatId}/messages`), messageData);
        
        await updateDoc(doc(db, "chats", currentChatId), {
            lastMessage: text.substring(0, 50) + (text.length > 50 ? '...' : ''),
            lastUpdated: serverTimestamp(),
        });
        
        input.value = '';
        input.style.height = 'auto';

        // Simulate AI Logic for the *recipient* if enabled on their end
        // In a real app, this would be handled by a Cloud Function checking the recipient's AI mode.
        // For this frontend-only simulation, we'll check the current chat user's profile.
        if (currentChatUser.aiMode) {
             checkAIResponse(currentChatUser.uid, text);
        }

    } catch(e) { 
        console.error("Error sending message:", e); 
        showToast("Failed to send message. Check console for details.");
    }
  };

  // Image Upload to Firebase Storage
  document.getElementById('imageInput').onchange = async (e) => {
      const file = e.target.files[0];
      if(!file || !currentChatId || !currentUser) return;
      
      const sendBtn = document.getElementById('sendButton');
      const originalIcon = sendBtn.innerHTML;
      sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 
      sendBtn.disabled = true;

      try {
          const storageRef = ref(storage, `chat_images/${currentChatId}/${Date.now()}_${file.name}`);
          const snapshot = await uploadBytes(storageRef, file);
          const imageUrl = await getDownloadURL(snapshot.ref);
          
          await addDoc(collection(db, `chats/${currentChatId}/messages`), {
              image: imageUrl,
              senderId: currentUser.uid,
              createdAt: serverTimestamp()
          });
          
          await updateDoc(doc(db, "chats", currentChatId), {
            lastMessage: "üñºÔ∏è Sent a photo",
            lastUpdated: serverTimestamp()
          });
          
      } catch(e) { 
          showToast("Image upload failed. Check Firebase Storage rules."); 
          console.error(e);
      } finally {
          sendBtn.innerHTML = originalIcon;
          sendBtn.disabled = false;
          e.target.value = ''; 
      }
  };


  // --- Search & New Chat ---
  async function searchUsers(e) {
      const val = e.target.value.toLowerCase();
      const results = document.getElementById('searchResults');
      results.innerHTML = '';
      
      if(val.length < 2) {
          results.innerHTML = '<div style="padding: 10px; color: var(--muted);">Type at least 2 characters.</div>';
          return;
      }
      
      try {
          // Note: Full text search is limited in Firestore. This is a basic prefix search simulation.
          const q = query(collection(db, "users")); 
          const snap = await getDocs(q);
          let foundCount = 0;
          
          snap.forEach(d => {
              const u = d.data();
              const displayName = u.displayName || u.email;
              
              if(d.id !== currentUser.uid && (displayName.toLowerCase().includes(val) || u.email?.toLowerCase().includes(val))) {
                  const div = document.createElement('div');
                  div.className = 'user-search-item';
                  div.innerHTML = `
                      <img src="${u.photoURL || 'https://i.pravatar.cc/100?img=30'}" style="width:30px;height:30px;border-radius:50%">
                      <div>
                          <div style="font-weight:600;font-size:14px">${displayName}</div>
                          <div style="font-size:12px;color:var(--muted)">${u.jobTitle || 'Member'}</div>
                      </div>
                  `;
                  div.onclick = () => startNewChat(d.id, u);
                  results.appendChild(div);
                  foundCount++;
              }
          });

          if(foundCount === 0) {
             results.innerHTML = '<div style="padding: 10px; color: var(--muted);">No users found.</div>';
          }

      } catch (e) {
          console.error("Error during user search:", e);
          results.innerHTML = '<div style="padding: 10px; color: red;">Error searching users.</div>';
      }
  }

  async function startNewChat(targetUid, targetUser) {
      if (!currentUser) return;
      const uids = [currentUser.uid, targetUid].sort();
      const chatId = uids.join('_');
      
      try {
          const chatDocRef = doc(db, "chats", chatId);
          const chatDoc = await getDoc(chatDocRef);
          
          if(!chatDoc.exists()) {
              await setDoc(chatDocRef, {
                  users: uids,
                  lastUpdated: serverTimestamp(),
                  lastMessage: 'Chat started'
              });
              
              await addDoc(collection(db, `chats/${chatId}/messages`), {
                  text: 'Conversation started.',
                  senderId: 'system',
                  createdAt: serverTimestamp()
              });
          }
          
          closeSearchModal();
          openChat(chatId, {...targetUser, uid: targetUid});
          loadConversations();
          
      } catch (e) {
          console.error("Failed to start new chat:", e);
          showToast("Could not start chat. Check console/security rules.");
      }
  }
  
  // --- Smart Suggestions and AI Response ---
  
  function updateSmartSuggestions(userObj) {
      const suggestionsContainer = document.getElementById('smartSuggestions');
      suggestionsContainer.innerHTML = '';
      
      // Basic logic: If talking to a mentor/expert, provide relevant suggestions
      const profession = userObj.jobTitle || '';

      const suggestions = [];

      if (profession.toLowerCase().includes('design') || profession.toLowerCase().includes('mentor')) {
          suggestions.push('Can we schedule a 1:1 mentorship session?');
          suggestions.push('What are your thoughts on the latest design trend?');
          suggestions.push('I need feedback on my portfolio.');
      } else if (profession.toLowerCase().includes('manager') || profession.toLowerCase().includes('project')) {
          suggestions.push('Can we discuss the project requirements and scope?');
          suggestions.push('What are the next steps for this task?');
          suggestions.push('When is the next team meeting scheduled?');
      } else {
          suggestions.push('Thanks for reaching out!');
          suggestions.push('Can you tell me more about this?');
          suggestions.push('I will follow up on this later.');
      }
      
      suggestions.forEach(text => {
          const chip = document.createElement('div');
          chip.className = 'suggestion-chip';
          chip.textContent = text;
          chip.onclick = () => useSuggestion(text);
          suggestionsContainer.appendChild(chip);
      });
  }
  
  window.useSuggestion = (text) => {
      const messageInput = document.getElementById('messageInput');
      messageInput.value = text;
      messageInput.focus();
      // Auto-resize textarea
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 150) + 'px';
  };

  function generateSmartResponse(text, name) {
      text = text.toLowerCase();
      if(text.includes('hello') || text.includes('hi')) return `Hello! ${name} is currently away, but I'm handling messages. How can I assist?`;
      if(text.includes('schedule') || text.includes('call') || text.includes('meeting')) return "I'll check the human's calendar and get back to you with availability ASAP.";
      if(text.includes('thanks') || text.includes('thank')) return "You're welcome! I've passed your appreciation along.";
      return "Thanks for reaching out! I've noted your message and will notify the user to respond personally soon.\n\n[AI Auto-Reply ‚Ä¢ For immediate assistance, please rephrase your question.]";
  }

  async function checkAIResponse(targetUid, incomeText) {
      const targetDoc = await getDoc(doc(db, "users", targetUid));
      
      if(targetDoc.exists() && targetDoc.data().aiMode) {
          // Simulate typing indicator from the other user
          // Note: A "real" typing indicator requires real-time database updates from the user's device.
          // This is a simple client-side simulation.
          showToast(`${targetDoc.data().displayName || 'The User'} is typing...`); 

          setTimeout(async () => {
              const targetDisplayName = targetDoc.data().displayName || 'The User';
              const reply = generateSmartResponse(incomeText, targetDisplayName);
              
              const aiMessage = reply + "\n\n‚ú® [AI Auto-Reply]";

              await addDoc(collection(db, `chats/${currentChatId}/messages`), {
                  text: aiMessage,
                  senderId: targetUid, // Rule allows senderId == request.auth.uid (the target user)
                  createdAt: serverTimestamp()
              }).catch(console.error);
              
              await updateDoc(doc(db, "chats", currentChatId), {
                lastMessage: "‚ú® AI Reply: " + reply.split('\n')[0],
                lastUpdated: serverTimestamp(),
              });
              showToast(`${targetDoc.data().displayName || 'The User'} has responded.`); 
          }, 3000); // 3 second simulated delay
      }
  }

  // --- Video Call Simulation (Sticking to the mock's client-side approach) ---
  
  window.startVoiceCall = () => comingSoon('Voice Call (WebRTC)');
  window.startVideoCall = () => {
    if (!currentChatUser) {
        showToast("Please select a user to call.");
        return;
    }
    document.getElementById('callUserName').textContent = currentChatUser.displayName;
    document.getElementById('videoCallModal').style.display = 'flex';
    startCallTimer();
    // In a real scenario, this is where WebRTC negotiation would start.
    showToast(`Initiating video call with ${currentChatUser.displayName}...`);
  };

  window.endCall = () => {
    document.getElementById('videoCallModal').style.display = 'none';
    stopCallTimer();
    showToast('Call ended');
  };

  const muteBtn = document.getElementById('muteBtn');
  const videoBtn = document.getElementById('videoBtn');
  const speakerBtn = document.getElementById('speakerBtn');
  
  window.toggleMute = () => {
    muteBtn.classList.toggle('active');
    showToast(muteBtn.classList.contains('active') ? 'Mic Muted' : 'Mic Unmuted');
  };

  window.toggleVideo = () => {
    videoBtn.classList.toggle('active');
    showToast(videoBtn.classList.contains('active') ? 'Video Off' : 'Video On');
  };

  window.toggleSpeaker = () => {
    speakerBtn.classList.toggle('active');
    showToast(speakerBtn.classList.contains('active') ? 'Speaker Off' : 'Speaker On');
  };

  function startCallTimer() {
    callSeconds = 0;
    document.getElementById('callTimer').textContent = '00:00';
    callTimer = setInterval(() => {
      callSeconds++;
      const minutes = Math.floor(callSeconds / 60);
      const seconds = callSeconds % 60;
      document.getElementById('callTimer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
  }

  function stopCallTimer() {
    if (callTimer) {
      clearInterval(callTimer);
      callTimer = null;
    }
  }

  // Dark Mode Initialization
  const darkToggle = document.getElementById('darkToggle');
  const storedTheme = localStorage.getItem('meet_theme');
  if(storedTheme === 'dark') document.body.classList.add('dark');
  darkToggle.textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';

  darkToggle.onclick = () => {
      document.body.classList.toggle('dark');
      localStorage.setItem('meet_theme', document.body.classList.contains('dark') ? 'dark' : 'light');
      darkToggle.textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
  };
</script>
</body>
</html>
