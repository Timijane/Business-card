<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/picmo@latest/dist/umd/index.js"></script>
<style>
  :root {
    --primary: #0080FF;
    --primary-dark: #0066CC;
    --accent: #00C6FF;
    --success: #10B981;
    --error: #EF4444;
    --bg-color: #f0f2f5;
    --card-bg: #fff;
    --text-color: #111;
    --secondary-text: #65676b;
    --border-color: #dddfe2;
    --online: #10B981;
    --offline: #EF4444;
    --radius: 12px;
    --shadow: 0 2px 8px rgba(0,0,0,0.1);
    --ai-color: #8A2BE2;
  }

  body.dark-mode {
    --bg-color: #18191a;
    --card-bg: #242526;
    --text-color: #e4e6eb;
    --secondary-text: #b0b3b8;
    --border-color: #3e4042;
    --shadow: 0 2px 8px rgba(0,0,0,0.3);
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }

  html, body {
    height: 100%;
    /* Prevent horizontal scroll on mobile */
    overflow: hidden; 
    font-size: 16px;
  }

  body {
    font-family: 'Poppins', sans-serif;
    background: var(--bg-color);
    color: var(--text-color);
    transition: all 0.3s ease;
  }

  .app-container {
    display: flex;
    height: 100dvh; /* Dynamic viewport height for mobile browsers */
    position: relative;
    overflow: hidden;
  }

  /* Sidebar */
  .sidebar {
    width: 280px;
    background: linear-gradient(180deg, #0080FF 0%, #00C6FF 100%);
    border-right: 1px solid var(--border-color);
    overflow-y: auto;
    z-index: 100;
    padding: 20px;
    color: white;
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
  }

  .sidebar-header h2 { font-size: 24px; font-weight: 700; margin-bottom: 20px;}
  .sidebar-menu { list-style: none; }
  .sidebar-menu li { margin-bottom: 8px; }
  .sidebar-menu a {
    display: flex; align-items: center; padding: 12px;
    text-decoration: none; color: white; border-radius: 8px;
    transition: background 0.3s; font-size: 16px;
  }
  .sidebar-menu a:hover, .sidebar-menu a.active { background: rgba(255, 255, 255, 0.2); }
  .sidebar-menu i { margin-right: 12px; font-size: 18px; width: 20px; text-align: center;}

  /* Main Content */
  .main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--bg-color);
    height: 100%;
    position: relative;
    overflow: hidden;
  }

  /* Chat Container - The main wrapper for chat lists and messages */
  .chat-interface {
    display: flex;
    width: 100%;
    height: 100%;
    background: var(--card-bg);
    overflow: hidden;
  }

  /* Conversations List Sidebar */
  .conversations-sidebar {
    width: 350px;
    background: var(--card-bg);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    height: 100%;
    flex-shrink: 0;
    z-index: 50;
  }

  .chat-header-search {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
  }
  
  .chat-header-top {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
  }
  .chat-header-title { font-weight: 700; font-size: 20px; }

  .new-chat-btn {
    background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);
    color: white; border: none; width: 36px; height: 36px; border-radius: 50%;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
  }

  .chat-search-input {
    width: 100%; padding: 10px 15px; border-radius: 20px;
    border: 1px solid var(--border-color); background: var(--bg-color); outline: none;
    color: var(--text-color);
  }

  .conversations-list { flex: 1; overflow-y: auto; }

  .conversation-item {
    display: flex; align-items: center; gap: 12px; padding: 15px;
    cursor: pointer; border-bottom: 1px solid var(--border-color);
    transition: background 0.2s;
  }
  .conversation-item:hover, .conversation-item.active { background: rgba(0,128,255,0.05); }

  .conversation-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; position: relative; }
  .online-indicator {
    position: absolute; bottom: 0; right: 0; width: 12px; height: 12px;
    border-radius: 50%; background: var(--online); border: 2px solid var(--card-bg);
  }

  .conversation-info { flex: 1; min-width: 0; }
  .conversation-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
  .conversation-name { font-weight: 600; font-size: 16px; }
  .conversation-time { font-size: 12px; color: var(--secondary-text); }
  .conversation-preview { font-size: 14px; color: var(--secondary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* Chat Area */
  .chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
    background: var(--bg-color);
    position: relative;
    min-width: 0; /* Important for flexbox text truncation */
  }

  .chat-area-header {
    padding: 10px 20px;
    background: var(--card-bg);
    border-bottom: 1px solid var(--border-color);
    display: flex; align-items: center; gap: 12px;
    height: 65px;
    flex-shrink: 0;
  }

  .chat-user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
  .chat-user-info { flex: 1; }
  .chat-user-name { font-weight: 600; font-size: 16px; }
  .chat-user-status { font-size: 12px; color: var(--secondary-text); }

  /* AI Toggle Switch */
  .ai-toggle-wrapper {
      display: flex; align-items: center; gap: 8px; margin-right: 10px;
  }
  .ai-toggle-btn {
      background: transparent; border: 1px solid var(--secondary-text); color: var(--secondary-text);
      padding: 5px 10px; border-radius: 20px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px;
      transition: all 0.3s;
  }
  .ai-toggle-btn.active {
      background: var(--ai-color); border-color: var(--ai-color); color: white;
      box-shadow: 0 0 10px rgba(138, 43, 226, 0.4);
  }

  .chat-actions button {
    background: none; border: none; color: var(--secondary-text);
    font-size: 18px; cursor: pointer; padding: 8px;
  }

  .messages-wrapper {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    /* Ensure content fits */
    width: 100%;
  }

  .message {
    display: flex; gap: 10px; max-width: 75%;
    position: relative; margin-bottom: 5px;
    /* Prevent messages from overflowing screen */
    min-width: 0; 
  }
  
  .message.sent { align-self: flex-end; flex-direction: row-reverse; }

  .message-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; align-self: flex-end; flex-shrink: 0; }

  .message-bubble {
    padding: 10px 14px; border-radius: 18px; position: relative;
    word-wrap: break-word; overflow-wrap: break-word; /* Crucial for long text */
    max-width: 100%;
    font-size: 15px; line-height: 1.4;
  }

  .received .message-bubble { background: var(--card-bg); border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
  .sent .message-bubble { background: var(--primary); color: white; border-bottom-right-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

  .message-time { font-size: 10px; margin-top: 4px; opacity: 0.7; text-align: right; }

  /* Message Actions (Hover) */
  .message:hover .msg-actions-menu { opacity: 1; pointer-events: auto; }
  .msg-actions-menu {
      position: absolute; top: -25px; right: 0;
      background: var(--card-bg); box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      border-radius: 20px; padding: 2px 5px; display: flex; gap: 5px;
      opacity: 0; transition: opacity 0.2s; pointer-events: none; z-index: 10;
  }
  .sent .msg-actions-menu { left: 0; right: auto; }
  .action-icon { font-size: 12px; padding: 5px; cursor: pointer; color: var(--secondary-text); border-radius: 50%; }
  .action-icon:hover { background: var(--bg-color); color: var(--primary); }

  /* Reply Context */
  .reply-context {
      font-size: 12px; background: rgba(0,0,0,0.05); padding: 5px 8px;
      border-left: 3px solid var(--primary); border-radius: 4px; margin-bottom: 5px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      opacity: 0.8;
  }
  .sent .reply-context { background: rgba(255,255,255,0.2); border-left-color: white; }

  /* Input Area */
  .chat-input-area {
    padding: 10px 15px;
    background: var(--card-bg);
    border-top: 1px solid var(--border-color);
    flex-shrink: 0;
  }

  /* Reply Preview Bar */
  .input-context-bar {
      background: var(--bg-color); padding: 8px 12px; border-radius: 8px; margin-bottom: 8px;
      display: none; justify-content: space-between; align-items: center; border-left: 3px solid var(--primary);
  }
  .input-context-text { font-size: 13px; color: var(--secondary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90%; }

  .input-wrapper { display: flex; align-items: flex-end; gap: 10px; }
  
  .input-actions { display: flex; gap: 5px; }
  .input-btn {
    background: none; border: none; color: var(--secondary-text);
    font-size: 20px; cursor: pointer; padding: 8px; border-radius: 50%;
  }
  .input-btn:hover { color: var(--primary); background: rgba(0,0,0,0.05); }

  .message-input {
    flex: 1; padding: 10px 15px; border-radius: 20px;
    border: 1px solid var(--border-color); background: var(--bg-color);
    resize: none; font-family: inherit; font-size: 15px; max-height: 100px; outline: none;
    color: var(--text-color);
  }
  .send-btn {
    background: var(--primary); color: white; border: none;
    width: 45px; height: 45px; border-radius: 50%; cursor: pointer;
    display: flex; align-items: center; justify-content: center; font-size: 18px;
    flex-shrink: 0;
  }

  /* Emoji Picker Container */
  #emojiPickerContainer {
      position: absolute; bottom: 80px; left: 20px; z-index: 1000; display: none;
  }

  /* Back Button (Mobile) */
  .back-btn { display: none; background: none; border: none; font-size: 20px; margin-right: 10px; cursor: pointer; color: var(--text-color); }

  /* Empty State */
  .empty-state {
      flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
      text-align: center; color: var(--secondary-text); padding: 20px;
  }

  /* Toast */
  .toast {
      position: fixed; top: 20px; right: 20px; background: var(--success); color: white;
      padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 9999; animation: slideIn 0.3s ease;
  }
  @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .sidebar { display: none; } /* Hide main nav sidebar on mobile */
    .conversations-sidebar { width: 100%; border-right: none; }
    .chat-area { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: translateX(100%); transition: transform 0.3s ease; z-index: 100; }
    .chat-area.active { transform: translateX(0); }
    .back-btn { display: block; }
    .message { max-width: 85%; }
    .chat-header-search { padding: 10px; }
    .ai-toggle-btn span { display: none; } /* Hide text on small screens */
  }
</style>
</head>
<body>

<div class="app-container">
  <div class="sidebar">
    <div class="sidebar-header"><h2>MEET</h2></div>
    <ul class="sidebar-menu">
      <li><a href="feed.html"><i class="fas fa-home"></i> <span>Feed</span></a></li>
      <li><a href="chat.html" class="active"><i class="fas fa-comment"></i> <span>Chat</span></a></li>
      <li><a href="profile.html"><i class="fas fa-user"></i> <span>Profile</span></a></li>
      <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a></li>
    </ul>
  </div>

  <div class="main-content">
    <div class="chat-interface">
      <div class="conversations-sidebar" id="conversationsSidebar">
        <div class="chat-header-search">
           <div class="chat-header-top">
               <div class="chat-header-title">Messages</div>
               <button class="new-chat-btn" onclick="openUserSearch()"><i class="fas fa-plus"></i></button>
           </div>
           <input type="text" class="chat-search-input" id="conversationSearch" placeholder="Search conversations...">
        </div>
        <div class="conversations-list" id="conversationsList">
            </div>
      </div>

      <div class="chat-area" id="chatArea">
        <div class="empty-state" id="emptyState">
            <i class="fas fa-comments" style="font-size: 60px; margin-bottom: 20px; opacity: 0.3;"></i>
            <h3>Select a Conversation</h3>
            <p>Choose a chat from the left or start a new one.</p>
        </div>

        <div class="chat-area-header" id="chatAreaHeader" style="display:none;">
            <button class="back-btn" onclick="closeChat()"><i class="fas fa-arrow-left"></i></button>
            <img src="" class="chat-user-avatar" id="currentChatAvatar">
            <div class="chat-user-info">
                <div class="chat-user-name" id="currentChatName">User</div>
                <div class="chat-user-status" id="currentChatStatus">Offline</div>
            </div>
            
            <div class="ai-toggle-wrapper">
                <button class="ai-toggle-btn" id="aiToggleBtn" onclick="toggleAI()">
                    <i class="fas fa-robot"></i> <span>AI Reply</span>
                </button>
            </div>
        </div>

        <div class="messages-wrapper" id="messagesWrapper" style="display:none;">
            </div>

        <div id="emojiPickerContainer"></div>

        <div class="chat-input-area" id="chatInputArea" style="display:none;">
            <div class="input-context-bar" id="inputContextBar">
                <div class="input-context-text" id="contextText">Replying to...</div>
                <button onclick="cancelContext()" style="background:none; border:none; color:var(--error); cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>

            <div class="input-wrapper">
                <div class="input-actions">
                    <button class="input-btn" onclick="toggleEmojiPicker()"><i class="far fa-smile"></i></button>
                    <button class="input-btn" title="Send Image (Demo)"><i class="far fa-image"></i></button>
                </div>
                <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
                <button class="send-btn" id="sendBtn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toastContainer"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDoc, getDocs, onSnapshot, serverTimestamp, query, orderBy, where, setDoc, limit } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
    authDomain: "meet-6e159.firebaseapp.com",
    databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",
    projectId: "meet-6e159",
    storageBucket: "meet-6e159.firebasestorage.app",
    messagingSenderId: "252353608421",
    appId: "1:252353608421:web:6706056048e9a8f12db20c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // --- STATE ---
  let currentUser = null;
  let currentChatId = null;
  let currentChatUser = null; 
  let isAIEnabled = false;
  let contextMode = null; // 'reply' or 'edit'
  let contextMessageId = null; // ID of message being replied to or edited
  let picker = null; // Emoji picker instance

  // --- DOM ELEMENTS ---
  const conversationsList = document.getElementById('conversationsList');
  const chatArea = document.getElementById('chatArea');
  const messagesWrapper = document.getElementById('messagesWrapper');
  const messageInput = document.getElementById('messageInput');
  const chatHeader = document.getElementById('chatAreaHeader');
  const chatInputArea = document.getElementById('chatInputArea');
  const emptyState = document.getElementById('emptyState');
  const inputContextBar = document.getElementById('inputContextBar');
  const contextText = document.getElementById('contextText');
  const aiToggleBtn = document.getElementById('aiToggleBtn');
  
  // --- INITIALIZATION ---
  onAuthStateChanged(auth, async (user) => {
      if (!user) {
          window.location.href = 'login.html';
      } else {
          currentUser = user;
          loadConversations();
          initEmojiPicker();
          updateUserStatus(true);
      }
  });

  // --- EMOJI PICKER ---
  function initEmojiPicker() {
      const container = document.getElementById('emojiPickerContainer');
      picker = picmo.createPicker({ rootElement: container });
      picker.addEventListener('emoji:select', selection => {
          messageInput.value += selection.emoji;
          messageInput.focus();
          container.style.display = 'none';
      });
  }

  window.toggleEmojiPicker = () => {
      const container = document.getElementById('emojiPickerContainer');
      container.style.display = container.style.display === 'block' ? 'none' : 'block';
  }

  // --- CONVERSATIONS ---
  function loadConversations() {
      const q = query(collection(db, "conversations"), where("participants", "array-contains", currentUser.uid));
      
      onSnapshot(q, (snapshot) => {
          let chats = [];
          snapshot.forEach(doc => {
              chats.push({ id: doc.id, ...doc.data() });
          });

          // Sort by updatedAt DESC (Newest first)
          chats.sort((a, b) => {
             const tA = a.updatedAt?.toMillis() || 0;
             const tB = b.updatedAt?.toMillis() || 0;
             return tB - tA;
          });

          renderConversations(chats);
      });
  }

  function renderConversations(chats) {
      conversationsList.innerHTML = '';
      if(chats.length === 0) {
          conversationsList.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">No conversations yet.</div>';
          return;
      }

      chats.forEach(chat => {
          const otherId = chat.participants.find(id => id !== currentUser.uid);
          const name = chat.participantNames?.[otherId] || 'User';
          const avatar = chat.participantAvatars?.[otherId] || `https://ui-avatars.com/api/?name=${name}&background=0080FF&color=fff`;
          const lastMsg = chat.lastMessage || 'New Conversation';
          
          // Check for unread notification logic (Global Alert)
          // If message is new and not in current chat, show toast
          if (chat.updatedAt && Date.now() - chat.updatedAt.toMillis() < 5000 && chat.id !== currentChatId) {
             // Only notify if last message wasn't from me
             // (Simplification: Real logic would check unread array)
             showToast(`New message from ${name}`);
          }

          const div = document.createElement('div');
          div.className = `conversation-item ${currentChatId === chat.id ? 'active' : ''}`;
          div.innerHTML = `
              <div style="position:relative;">
                  <img src="${avatar}" class="conversation-avatar">
                  <div class="online-indicator" style="background: ${chat.status?.[otherId]?.isOnline ? 'var(--online)' : 'var(--offline)'}"></div>
              </div>
              <div class="conversation-info">
                  <div class="conversation-top">
                      <span class="conversation-name">${name}</span>
                      <span class="conversation-time">${formatTime(chat.updatedAt)}</span>
                  </div>
                  <div class="conversation-preview">${lastMsg}</div>
              </div>
          `;
          div.onclick = () => openChat(chat.id, otherId, name, avatar);
          conversationsList.appendChild(div);
      });
  }

  // --- CHAT LOGIC ---
  window.openChat = async (chatId, userId, name, avatar) => {
      currentChatId = chatId;
      currentChatUser = userId;
      
      // Update UI
      chatArea.classList.add('active'); // Mobile slide-in
      emptyState.style.display = 'none';
      chatHeader.style.display = 'flex';
      messagesWrapper.style.display = 'flex';
      chatInputArea.style.display = 'block';
      
      // Update Header
      document.getElementById('currentChatName').innerText = name;
      document.getElementById('currentChatAvatar').src = avatar;
      
      loadMessages(chatId);
      watchStatus(userId);
      
      // Clear AI toggle state for new chat
      isAIEnabled = false; 
      updateAIToggleUI();
  };

  window.closeChat = () => {
      chatArea.classList.remove('active'); // Mobile slide-out
      currentChatId = null;
  };

  function loadMessages(chatId) {
      const q = query(collection(db, "conversations", chatId, "messages"), orderBy("timestamp", "asc"));
      
      onSnapshot(q, (snapshot) => {
          messagesWrapper.innerHTML = '';
          const messages = [];
          snapshot.forEach(doc => messages.push({id: doc.id, ...doc.data()}));
          
          let lastSender = null;

          messages.forEach(msg => {
              const isSent = msg.senderId === currentUser.uid;
              const div = document.createElement('div');
              div.className = `message ${isSent ? 'sent' : 'received'}`;
              
              // Avatar
              const avatarUrl = isSent ? 
                  (currentUser.photoURL || `https://ui-avatars.com/api/?name=${currentUser.displayName}`) : 
                  document.getElementById('currentChatAvatar').src;
              
              // Reply Context Visual
              let replyHtml = '';
              if(msg.replyTo) {
                  replyHtml = `<div class="reply-context">${msg.replyTo.text}</div>`;
              }

              // Text + AI Tag
              let textContent = msg.text;
              if (msg.isAI) {
                  textContent += `<br><br><em style="font-size:11px; opacity:0.7;">......this message is written by ai</em>`;
              }

              div.innerHTML = `
                  <img src="${avatarUrl}" class="message-avatar">
                  <div class="message-bubble">
                      ${replyHtml}
                      ${textContent}
                      <div class="message-time">${formatTime(msg.timestamp)}</div>
                  </div>
                  <div class="msg-actions-menu">
                      <i class="fas fa-reply action-icon" onclick="initReply('${msg.id}', '${msg.text.replace(/'/g, "\\'")}')" title="Reply"></i>
                      ${isSent ? `<i class="fas fa-trash action-icon" onclick="deleteMessage('${msg.id}')" title="Delete"></i>` : ''}
                  </div>
              `;
              messagesWrapper.appendChild(div);
          });
          
          scrollToBottom();

          // Check for AI Auto Reply Trigger
          const lastMsg = messages[messages.length - 1];
          if(isAIEnabled && lastMsg && lastMsg.senderId !== currentUser.uid && (Date.now() - lastMsg.timestamp?.toMillis()) < 2000) {
              triggerAIReply();
          }
      });
  }

  // --- ACTIONS: SEND, REPLY, AI ---

  document.getElementById('sendBtn').onclick = sendMessage;
  messageInput.addEventListener('keypress', (e) => {
      if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });

  async function sendMessage() {
      const text = messageInput.value.trim();
      if(!text) return;
      
      const payload = {
          text: text,
          senderId: currentUser.uid,
          timestamp: serverTimestamp(),
          isAI: false
      };

      if(contextMode === 'reply') {
          payload.replyTo = { id: contextMessageId, text: document.getElementById('contextText').innerText.replace('Replying to: ', '') };
      }

      messageInput.value = '';
      cancelContext();
      
      await addDoc(collection(db, "conversations", currentChatId, "messages"), payload);
      await updateDoc(doc(db, "conversations", currentChatId), {
          lastMessage: text,
          updatedAt: serverTimestamp()
      });
  }

  // Reply functionality
  window.initReply = (msgId, text) => {
      contextMode = 'reply';
      contextMessageId = msgId;
      inputContextBar.style.display = 'flex';
      contextText.innerText = `Replying to: ${text}`;
      messageInput.focus();
  };

  window.cancelContext = () => {
      contextMode = null;
      contextMessageId = null;
      inputContextBar.style.display = 'none';
  };

  window.deleteMessage = async (msgId) => {
      if(confirm('Delete message?')) {
          await deleteDoc(doc(db, "conversations", currentChatId, "messages", msgId));
      }
  };

  // AI Logic
  window.toggleAI = () => {
      isAIEnabled = !isAIEnabled;
      updateAIToggleUI();
      if(isAIEnabled) showToast("AI Auto-reply Enabled");
  };

  function updateAIToggleUI() {
      if(isAIEnabled) aiToggleBtn.classList.add('active');
      else aiToggleBtn.classList.remove('active');
  }

  function triggerAIReply() {
      // Simulate thinking time
      setTimeout(async () => {
          const aiResponses = ["That sounds interesting!", "Could you tell me more?", "I see.", "Okay, got it."];
          const randomResponse = aiResponses[Math.floor(Math.random() * aiResponses.length)];
          
          await addDoc(collection(db, "conversations", currentChatId, "messages"), {
              text: randomResponse,
              senderId: currentUser.uid, // Sent on behalf of user
              timestamp: serverTimestamp(),
              isAI: true
          });
          
          await updateDoc(doc(db, "conversations", currentChatId), {
              lastMessage: randomResponse,
              updatedAt: serverTimestamp()
          });
      }, 3000);
  }

  // --- UTILS ---
  function scrollToBottom() {
      messagesWrapper.scrollTop = messagesWrapper.scrollHeight;
  }

  function formatTime(timestamp) {
      if(!timestamp) return '';
      const date = timestamp.toDate ? timestamp.toDate() : new Date();
      return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }

  function showToast(msg) {
      const t = document.createElement('div');
      t.className = 'toast';
      t.innerText = msg;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 3000);
  }

  async function updateUserStatus(isOnline) {
    if (!auth.currentUser) return;
    try {
        await updateDoc(doc(db, "users", auth.currentUser.uid), { isOnline: isOnline, lastActive: serverTimestamp() });
        // Also update conversation status if supported
    } catch (e) {}
  }
  
  function watchStatus(userId) {
      // Simplified status watcher
      onSnapshot(doc(db, "users", userId), (doc) => {
          if(doc.exists()) {
             const data = doc.data();
             const statusEl = document.getElementById('currentChatStatus');
             if(data.isOnline) statusEl.innerText = "Online";
             else statusEl.innerText = "Offline";
          }
      });
  }

  // New Chat Search
  window.openUserSearch = async () => {
      const email = prompt("Enter email of user to chat with:");
      if(!email) return;
      
      const q = query(collection(db, "users"), where("email", "==", email));
      const snap = await getDocs(q);
      
      if(!snap.empty) {
          const user = snap.docs[0].data();
          const userId = snap.docs[0].id;
          // Create chat ID based on sorted UIDs
          const participants = [currentUser.uid, userId].sort();
          const chatId = participants.join('_');
          
          await setDoc(doc(db, "conversations", chatId), {
              participants: participants,
              participantNames: { [currentUser.uid]: currentUser.displayName, [userId]: user.name || user.displayName },
              updatedAt: serverTimestamp()
          }, { merge: true }); // Merge to avoid overwriting existing chat
          
          // Open the chat
          openChat(chatId, userId, user.name || user.displayName, user.photoURL);
      } else {
          showToast("User not found");
      }
  };

  document.getElementById('logoutBtn').onclick = () => signOut(auth);

</script>
</body>
</html>
