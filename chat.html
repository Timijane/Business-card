<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Professional Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary: #0080FF;
    --primary-dark: #0066CC;
    --bg-color: #f0f2f5;
    --card-bg: #fff;
    --text-color: #111;
    --secondary-text: #65676b;
    --border-color: #dddfe2;
    --error: #EF4444;
    --success: #10B981;
    --warning: #F59E0B;
    --app-height: 100dvh;
    --chat-font: 'Poppins', sans-serif;
    --sent-bubble-bg: #0080FF;
    --sent-text-color: #fff;
    --received-bubble-bg: #fff;
    --received-text-color: #111;
    --shadow-light: 0 2px 10px rgba(0,0,0,0.05);
    --shadow-medium: 0 4px 15px rgba(0,128,255,0.2);
  }

  body.dark-mode {
    --bg-color: #0f0f10;
    --card-bg: #1e1e1e;
    --text-color: #e4e6eb;
    --secondary-text: #b0b3b8;
    --border-color: #2f3031;
    --received-bubble-bg: #2a2b2c;
    --received-text-color: #e4e6eb;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  html, body { 
    height: 100%; 
    overflow: hidden; 
    font-size: 14px; 
    font-family: var(--chat-font); 
    background: var(--bg-color); 
    color: var(--text-color); 
    transition: all 0.3s ease;
  }

  .app-container { 
    display: flex; 
    height: var(--app-height); 
    position: relative; 
    overflow: hidden; 
    max-width: 100vw;
  }

  /* --- SIDEBAR & NAVBAR --- */
  .sidebar {
    position: fixed; top: 0; left: 0; height: 100%; width: 280px;
    background: linear-gradient(180deg, #0080FF 0%, #00C6FF 100%);
    z-index: 200; padding: 25px; color: white;
    transform: translateX(-100%); 
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 4px 0 20px rgba(0,0,0,0.15);
  }
  .sidebar.open { transform: translateX(0); }
  
  .sidebar-header { padding-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.2); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
  .sidebar-menu { list-style: none; }
  .sidebar-menu li { margin-bottom: 12px; }
  .sidebar-menu a { display: flex; align-items: center; padding: 14px 12px; text-decoration: none; color: white; border-radius: 12px; font-size: 16px; transition: all 0.2s ease; }
  .sidebar-menu a:hover, .sidebar-menu a.active { background: rgba(255, 255, 255, 0.25); font-weight: 600; }
  .sidebar-menu i { margin-right: 15px; width: 24px; text-align: center; }
  .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 190; backdrop-filter: blur(4px); }
  .sidebar-overlay.active { display: block; }

  .main-content { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; padding: 12px; width: 100%; }

  .navbar {
    background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);
    padding: 12px 20px; border-radius: 16px; margin-bottom: 12px;
    display: flex; justify-content: space-between; align-items: center;
    color: white; flex-shrink: 0; box-shadow: var(--shadow-medium);
  }
  .navbar-left, .navbar-right { display: flex; align-items: center; gap: 15px; }
  .hamburger-btn { background: none; border: none; color: white; font-size: 22px; cursor: pointer; }
  .nav-user-img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; object-fit: cover; }
  .btn { background: rgba(255, 255, 255, 0.2); color: white; border: none; padding: 8px 12px; border-radius: 10px; cursor: pointer; transition: 0.2s; }
  
  /* --- CHAT CONTAINER --- */
  .chat-container { 
    flex: 1; background: var(--card-bg); border-radius: 16px; overflow: hidden; 
    display: flex; min-height: 0; position: relative; border: 1px solid var(--border-color);
  }
  
  .conversations-sidebar { width: 320px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; height: 100%; background: var(--card-bg); }
  .chat-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
  .new-chat-btn { background: var(--primary); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 14px; }
  .chat-search { padding: 15px; border-bottom: 1px solid var(--border-color); }
  .chat-search input { width: 100%; padding: 10px 15px; border-radius: 20px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); outline: none; }
  .conversations-list { flex: 1; overflow-y: auto; }
  
  .conversation-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: 0.2s; }
  .conversation-item:hover, .conversation-item.active { background: rgba(0,128,255,0.08); border-left: 3px solid var(--primary); }
  .conversation-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border-color); }
  .conversation-info { flex: 1; min-width: 0; }
  .conversation-name { font-weight: 600; font-size: 15px; margin-bottom: 2px; }
  .conversation-preview { font-size: 13px; color: var(--secondary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* --- CHAT AREA --- */
  .chat-area { flex: 1; display: flex; flex-direction: column; height: 100%; background: var(--bg-color); position: relative; }
  .chat-area-header { padding: 12px 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 12px; background: var(--card-bg); z-index: 10; }
  .chat-user-info { flex: 1; }
  .chat-user-name { font-weight: 700; font-size: 16px; }
  .chat-actions { display: flex; gap: 5px; }
  .chat-action-btn { background: none; border: none; color: var(--secondary-text); font-size: 18px; cursor: pointer; padding: 8px; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; }
  .chat-action-btn:hover { background: rgba(0,128,255,0.1); color: var(--primary); }

  .empty-chat { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--secondary-text); text-align: center; }
  
  .messages-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background-size: cover; background-position: center; }
  
  /* Messages */
  .message-wrapper { display: flex; gap: 10px; max-width: 85%; align-items: flex-end; position: relative; margin-bottom: 10px; }
  .message-wrapper.sent { align-self: flex-end; flex-direction: row-reverse; }
  .message-bubble { padding: 10px 16px; border-radius: 18px; font-size: 14px; line-height: 1.5; max-width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; }
  .received .message-bubble { background: var(--received-bubble-bg); border-bottom-left-radius: 4px; color: var(--received-text-color); border: 1px solid var(--border-color); }
  .sent .message-bubble { background: var(--sent-bubble-bg); color: var(--sent-text-color); border-bottom-right-radius: 4px; }
  
  .message-img, .message-video { max-width: 250px; max-height: 250px; border-radius: 12px; margin-top: 5px; cursor: pointer; }
  .message-time { font-size: 10px; opacity: 0.7; margin-top: 4px; text-align: right; display: block; }
  
  /* Input Area */
  .message-input-container { padding: 12px 15px; background: var(--card-bg); border-top: 1px solid var(--border-color); }
  .reply-preview-bar { display: none; background: rgba(0,128,255,0.08); padding: 8px 12px; border-left: 3px solid var(--primary); justify-content: space-between; font-size: 13px; margin-bottom: 8px; border-radius: 8px; }
  .writing-assist-bar { display: none; gap: 8px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; }
  .assist-chip { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 6px 12px; border-radius: 20px; font-size: 12px; white-space: nowrap; cursor: pointer; }

  .message-input-wrapper { display: flex; align-items: flex-end; gap: 10px; }
  .message-input-actions { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
  .input-action { background: transparent; border: none; color: var(--secondary-text); cursor: pointer; font-size: 18px; padding: 8px; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; }
  .input-action:hover { color: var(--primary); background: rgba(0,128,255,0.1); }
  .message-input { flex: 1; padding: 12px 18px; border-radius: 24px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); resize: none; font-family: inherit; font-size: 14px; max-height: 100px; outline: none; }
  .send-button { background: var(--primary); color: white; border: 0; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

  /* Emoji Picker */
  .emoji-picker { display: none; position: absolute; bottom: 80px; left: 15px; width: 320px; height: 350px; background: var(--card-bg); border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 100; border: 1px solid var(--border-color); flex-direction: column; overflow: hidden; }
  .emoji-header { padding: 10px; background: var(--bg-color); border-bottom: 1px solid var(--border-color); display: flex; gap: 5px; overflow-x: auto; }
  .emoji-content { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px; }
  .emoji-item { font-size: 20px; cursor: pointer; text-align: center; padding: 5px; border-radius: 4px; }

  /* --- MODALS (Fixed for Mobile) --- */
  .settings-modal, .wallpaper-modal, .user-search-overlay { 
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2100; 
    align-items: center; justify-content: center; padding: 20px;
  }
  
  .settings-content, .wallpaper-content { 
    background: var(--card-bg); width: 100%; max-width: 550px; 
    max-height: 85vh; /* Fix for mobile overflow */
    border-radius: 20px; display: flex; flex-direction: column; 
    box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow-y: auto; position: relative;
  }

  .settings-content { padding: 25px; gap: 20px; }
  .wallpaper-content { padding: 20px; height: 80vh; }
  .wallpaper-header, .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
  .wallpaper-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; overflow-y: auto; padding: 5px; }
  .wallpaper-thumb { aspect-ratio: 9/16; border-radius: 8px; overflow: hidden; cursor: pointer; background: #eee; }
  .wallpaper-thumb img { width: 100%; height: 100%; object-fit: cover; }
  
  .user-search-modal { background: var(--card-bg); width: 100%; max-width: 500px; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
  .search-results { max-height: 300px; overflow-y: auto; }

  /* --- VIDEO CALL & VOICE UI --- */
  .call-modal {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #000; z-index: 3000; flex-direction: column;
  }
  .video-container { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; }
  .remote-video { width: 100%; height: 100%; object-fit: cover; }
  .local-video {
    position: absolute; bottom: 100px; right: 20px; width: 100px; height: 140px;
    background: #333; border-radius: 12px; object-fit: cover; border: 2px solid white;
    z-index: 10; box-shadow: 0 4px 15px rgba(0,0,0,0.5); transition: all 0.3s ease;
  }
  
  .call-controls {
    padding: 20px; background: rgba(0,0,0,0.8); display: flex; justify-content: center; gap: 20px; backdrop-filter: blur(10px);
    padding-bottom: max(20px, env(safe-area-inset-bottom));
  }
  .call-btn {
    width: 50px; height: 50px; border-radius: 50%; border: none; font-size: 20px; cursor: pointer; color: white;
    display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;
  }
  .btn-mute { background: rgba(255,255,255,0.2); }
  .btn-video-toggle { background: rgba(255,255,255,0.2); }
  .btn-end { background: #EF4444; transform: rotate(135deg); }
  .btn-chat-overlay { background: var(--primary); }
  .active-state { background: white; color: black; }

  /* Shy User Overlay */
  .video-chat-overlay {
    position: absolute; bottom: 160px; left: 20px; right: 20px; pointer-events: none;
    display: flex; flex-direction: column; align-items: flex-start; gap: 10px; z-index: 20;
  }
  .floating-message {
    background: rgba(0, 0, 0, 0.6); color: white; padding: 8px 14px; border-radius: 16px; font-size: 14px;
    max-width: 80%; backdrop-filter: blur(4px); animation: floatUp 5s forwards; pointer-events: auto;
  }
  @keyframes floatUp {
    0% { opacity: 0; transform: translateY(20px); }
    10% { opacity: 1; transform: translateY(0); }
    90% { opacity: 1; transform: translateY(-20px); }
    100% { opacity: 0; transform: translateY(-40px); }
  }

  /* Incoming Call Popup */
  .incoming-call-modal {
    display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    background: var(--card-bg); padding: 15px; border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.4); z-index: 3100; border: 2px solid var(--primary);
    width: 90%; max-width: 350px; animation: slideDown 0.3s ease;
  }
  @keyframes slideDown { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

  /* Voice Recorder Styles */
  .voice-recorder-active { background: #ef4444 !important; color: white !important; animation: pulseRed 1.5s infinite; }
  @keyframes pulseRed {
    0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
    100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
  }

  /* --- MEDIA QUERIES --- */
  @media (max-width: 768px) {
    .sidebar { width: 260px; }
    .chat-container { border-radius: 0; height: 100%; margin: 0; border: none; }
    .conversations-sidebar { width: 100%; position: absolute; z-index: 50; }
    .chat-area { width: 100%; position: absolute; z-index: 60; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .chat-area.active { transform: translateX(0); }
    
    .wallpaper-grid { grid-template-columns: repeat(2, 1fr); }
    .emoji-picker { width: 95%; left: 2.5%; bottom: 80px; height: 300px; }
    
    /* Ensure modals don't overflow screen */
    .wallpaper-content, .settings-content { max-height: 80vh; width: 95%; }
    .local-video { width: 90px; height: 120px; bottom: 120px; right: 15px; }
  }
</style>
</head>
<body>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
<div class="app-container">
  <div class="sidebar" id="mainSidebar">
    <div class="sidebar-header">
      <h2>MEET</h2>
      <button onclick="toggleSidebar()" style="background:none; border:none; color:white; font-size:20px;"><i class="fas fa-times"></i></button>
    </div>
    <ul class="sidebar-menu">
      <li><a href="feed.html"><i class="fas fa-home"></i> <span>Feed</span></a></li>
      <li><a href="profile.html"><i class="fas fa-user"></i> <span>Profile</span></a></li>
      <li><a href="chat.html" class="active"><i class="fas fa-comment"></i> <span>Chat</span></a></li>
      <li><a href="conference.html"><i class="fas fa-video"></i> <span>Conference</span></a></li>
      <li><a href="meetrader.html"><i class="fas fa-store"></i> <span>Meetrader</span></a></li>
    </ul>
  </div>

  <div class="main-content">
    <div class="navbar">
      <div class="navbar-left">
        <button class="hamburger-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <h2 style="font-weight:600; font-size:20px;">Chat</h2>
      </div>
      <div class="navbar-right">
        <img src="https://via.placeholder.com/40" id="navUserImg" class="nav-user-img" alt="Me">
        <span id="navUserName" style="font-weight:600;"></span>
        <button class="btn" id="nightToggleBtn"><i class="fas fa-moon"></i></button>
        <button class="btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </div>

    <div class="chat-container">
      <div class="conversations-sidebar" id="conversationsSidebar">
        <div class="chat-header">
          <h3>Messages</h3>
          <button class="new-chat-btn" onclick="openUserSearchOverlay()"><i class="fas fa-plus"></i></button>
        </div>
        <div class="chat-search">
          <input type="text" placeholder="Search chats..." id="chatSearch">
        </div>
        <div class="conversations-list" id="conversationsList"></div>
      </div>

      <div class="chat-area" id="chatArea">
        <div id="emptyChat" class="empty-chat">
          <i class="far fa-comments" style="font-size:60px; margin-bottom:20px; opacity:0.3;"></i>
          <h3>Select a conversation</h3>
        </div>

        <div class="chat-area-header" id="chatHeader" style="display: none;">
          <button class="chat-action-btn" id="backButton" style="color:var(--text-color); margin-right:5px;"><i class="fas fa-arrow-left"></i></button>
          <img src="" id="currentChatAvatar" class="conversation-avatar" style="width:36px; height:36px;">
          <div class="chat-user-info">
            <div class="chat-user-name" id="chatUserName">User</div>
          </div>
          <div class="chat-actions">
            <button class="chat-action-btn" onclick="startVoiceCall()" title="Voice Call"><i class="fas fa-phone-alt"></i></button>
            <button class="chat-action-btn" onclick="startVideoCall()" title="Video Call"><i class="fas fa-video"></i></button>
            <button class="chat-action-btn" onclick="openWallpaperModal()"><i class="fas fa-image"></i></button>
            <button class="chat-action-btn" onclick="openSettingsModal()"><i class="fas fa-sliders-h"></i></button>
          </div>
        </div>

        <div class="messages-container" id="messagesContainer" style="display: none;"></div>

        <div class="message-input-container" id="messageInputContainer" style="display: none;">
          <div class="reply-preview-bar" id="replyPreview">
            <span id="replyText">Replying...</span>
            <button onclick="cancelReply()" style="background:none;border:none;color:var(--text-color);">&times;</button>
          </div>
            
          <div class="writing-assist-bar" id="assistBar">
            <button class="assist-chip" onclick="applyWritingAssist('fix')">Fix Grammar</button>
            <button class="assist-chip" onclick="applyWritingAssist('formal')">Formal</button>
          </div>

          <div class="message-input-wrapper">
            <div class="message-input-actions">
              <button class="input-action" onclick="toggleAssistBar()"><i class="fas fa-magic"></i></button>
              <button class="input-action" onclick="toggleEmojiPicker()"><i class="far fa-smile"></i></button>
              
              <input type="file" id="imageInputHidden" accept="image/*" style="display:none" onchange="uploadToCloudinary(this.files[0], 'image')">
              <input type="file" id="videoInputHidden" accept="video/*" style="display:none" onchange="uploadToCloudinary(this.files[0], 'video')">
              
              <button class="input-action" onclick="document.getElementById('imageInputHidden').click()"><i class="fas fa-image"></i></button>
              <button class="input-action" onclick="document.getElementById('videoInputHidden').click()"><i class="fas fa-film"></i></button>
              
              <button class="input-action" id="voiceRecordBtn" 
                      onmousedown="startRecording()" onmouseup="stopRecording()" 
                      ontouchstart="startRecording()" ontouchend="stopRecording()" 
                      title="Hold to Record"><i class="fas fa-microphone"></i></button>
            </div>
            
            <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
            <button class="send-button" id="sendButton"><i class="fas fa-paper-plane"></i></button>
          </div>
          
          <div class="emoji-picker" id="emojiPicker">
            <div class="emoji-header" id="emojiNav"></div>
            <div class="emoji-content" id="emojiContent"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="call-modal" id="callModal">
  <div class="video-container">
    <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
    <video id="localVideo" class="local-video" autoplay playsinline muted></video>
    <div class="video-chat-overlay" id="videoChatOverlay"></div>
  </div>
  <div class="call-controls">
    <button class="call-btn btn-mute" onclick="toggleMute()" id="muteBtn"><i class="fas fa-microphone"></i></button>
    <button class="call-btn btn-video-toggle" onclick="toggleCamera()" id="cameraBtn"><i class="fas fa-video"></i></button>
    <button class="call-btn btn-end" onclick="endCall()"><i class="fas fa-phone"></i></button>
    <button class="call-btn btn-chat-overlay" onclick="focusChatInput()"><i class="fas fa-comment-dots"></i></button>
  </div>
</div>

<div class="incoming-call-modal" id="incomingCallModal">
  <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px;">
    <img src="" id="callerAvatar" style="width:50px; height:50px; border-radius:50%; object-fit:cover;">
    <div>
      <div style="font-weight:700; font-size:16px;" id="callerName">User</div>
      <div style="font-size:13px; color:var(--primary);">Incoming Call...</div>
    </div>
  </div>
  <div style="display:flex; gap:10px;">
    <button onclick="rejectCall()" style="flex:1; padding:10px; border-radius:8px; border:none; background:#eee; color:#333; cursor:pointer;">Decline</button>
    <button onclick="acceptCall()" style="flex:1; padding:10px; border-radius:8px; border:none; background:var(--success); color:white; cursor:pointer;">Accept</button>
  </div>
</div>

<div class="settings-modal" id="settingsModal">
  <div class="settings-content">
    <div class="settings-header">
      <h3>Settings</h3>
      <button onclick="closeSettingsModal()" style="background:none; border:none; font-size:24px;">&times;</button>
    </div>
    <div style="margin-bottom:20px;">
      <h4>Font</h4>
      <select id="fontSelect" style="width:100%; padding:10px; border-radius:8px; margin-top:5px;" onchange="changeFont()"></select>
    </div>
    <div style="margin-bottom:20px;">
      <h4>Bubble Color</h4>
      <div class="color-grid" id="colorGrid" style="display:flex; gap:10px; flex-wrap:wrap;"></div>
    </div>
  </div>
</div>

<div class="user-search-overlay" id="userSearchOverlay">
  <div class="user-search-modal">
    <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
      <h3>Start Chat</h3>
      <button onclick="closeUserSearchOverlay()" style="border:none; background:none;">&times;</button>
    </div>
    <input type="text" id="userSearchInput" placeholder="Name or email..." style="width:100%; padding:15px; border:none; border-bottom:1px solid #eee; outline:none;">
    <div class="search-results" id="userSearchResults"></div>
  </div>
</div>

<div class="wallpaper-modal" id="wallpaperModal">
  <div class="wallpaper-content">
    <div class="wallpaper-header">
      <h3>Wallpapers</h3>
      <button onclick="closeWallpaperModal()" style="border:none; background:none; font-size:20px;">&times;</button>
    </div>
    <div class="wallpaper-grid" id="wallpaperGrid"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getFirestore, collection, addDoc, updateDoc, doc, getDoc, getDocs, onSnapshot, serverTimestamp, query, orderBy, where, setDoc, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
    authDomain: "meet-6e159.firebaseapp.com",
    projectId: "meet-6e159",
    storageBucket: "meet-6e159.firebasestorage.app",
    messagingSenderId: "252353608421",
    appId: "1:252353608421:web:6706056048e9a8f12db20c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // === GLOBALS ===
  let currentUser = null;
  let currentChatId = null;
  let currentChatUser = null;
  let currentChatUserName = '';
  let currentChatUserAvatar = '';
  let unsubscribeMessages = null;
  let unsubscribeConversations = null;
  let replyToMsg = null;
  let editingMsgId = null;

  // WebRTC Globals
  const servers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };
  let pc = null;
  let localStream = null;
  let callDocId = null;
  let isCaller = false;
  let mediaRecorder = null;
  let audioChunks = [];

  // DOM Elements
  const messagesContainer = document.getElementById('messagesContainer');
  const messageInput = document.getElementById('messageInput');
  const sidebar = document.getElementById('mainSidebar');
  const sidebarOverlay = document.getElementById('sidebarOverlay');
  const navUserImg = document.getElementById('navUserImg');
  const navUserName = document.getElementById('navUserName');

  // === UTILITY ===
  function showError(msg) { console.error(msg); alert(msg); }
  
  function formatDateHeader(timestamp) {
    if (!timestamp) return null;
    const date = new Date(timestamp.seconds * 1000);
    return date.toLocaleDateString();
  }

  // === WEBRTC FUNCTIONS ===
  
  // 1. Init Stream
  async function initLocalStream(video = true) {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video: video, audio: true });
      document.getElementById('localVideo').srcObject = localStream;
      document.getElementById('callModal').style.display = 'flex';
      
      if (!video) {
        localStream.getVideoTracks().forEach(track => track.enabled = false);
        const btn = document.getElementById('cameraBtn');
        btn.classList.add('active-state');
        btn.innerHTML = '<i class="fas fa-video-slash"></i>';
      }
      return localStream;
    } catch (err) {
      console.error(err);
      showError("Could not access camera/microphone");
      return null;
    }
  }

  // 2. Start Call
  window.startVideoCall = () => startCallRequest('video');
  window.startVoiceCall = () => startCallRequest('voice');

  async function startCallRequest(type) {
    if (!currentChatId) return;
    isCaller = true;
    await initLocalStream(type === 'video');
    
    pc = new RTCPeerConnection(servers);
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    
    pc.ontrack = (event) => {
      event.streams[0].getTracks().forEach(track => {
        document.getElementById('remoteVideo').srcObject = event.streams[0];
      });
    };
    
    pc.onicecandidate = (event) => {
      if (event.candidate && callDocId) {
        addDoc(collection(db, "conversations", currentChatId, "calls", callDocId, "callerCandidates"), event.candidate.toJSON());
      }
    };
    
    const offerDescription = await pc.createOffer();
    await pc.setLocalDescription(offerDescription);
    
    const callDoc = await addDoc(collection(db, "conversations", currentChatId, "calls"), {
      offer: { type: offerDescription.type, sdp: offerDescription.sdp },
      type: type,
      callerId: currentUser.uid,
      callerName: currentUser.displayName || 'User',
      callerAvatar: navUserImg.src,
      timestamp: serverTimestamp(),
      status: 'offering'
    });
    callDocId = callDoc.id;
    
    onSnapshot(callDoc, (snapshot) => {
      const data = snapshot.data();
      if (!pc.currentRemoteDescription && data?.answer) {
        pc.setRemoteDescription(new RTCSessionDescription(data.answer));
      }
      if(data?.status === 'ended') endCallCleanup();
    });
    
    onSnapshot(collection(db, "conversations", currentChatId, "calls", callDocId, "calleeCandidates"), (snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === 'added') pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
      });
    });
  }

  // 3. Accept Call
  window.acceptCall = async () => {
    document.getElementById('incomingCallModal').style.display = 'none';
    isCaller = false;
    const callDoc = await getDoc(doc(db, "conversations", currentChatId, "calls", callDocId));
    const callData = callDoc.data();
    
    await initLocalStream(callData.type === 'video');
    pc = new RTCPeerConnection(servers);
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    
    pc.ontrack = (event) => {
      event.streams[0].getTracks().forEach(track => document.getElementById('remoteVideo').srcObject = event.streams[0]);
    };
    
    pc.onicecandidate = (event) => {
      if (event.candidate) {
        addDoc(collection(db, "conversations", currentChatId, "calls", callDocId, "calleeCandidates"), event.candidate.toJSON());
      }
    };
    
    await pc.setRemoteDescription(new RTCSessionDescription(callData.offer));
    const answerDescription = await pc.createAnswer();
    await pc.setLocalDescription(answerDescription);
    
    await updateDoc(doc(db, "conversations", currentChatId, "calls", callDocId), {
      answer: { type: answerDescription.type, sdp: answerDescription.sdp },
      status: 'answered'
    });
    
    onSnapshot(collection(db, "conversations", currentChatId, "calls", callDocId, "callerCandidates"), (snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === 'added') pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
      });
    });
    
    onSnapshot(doc(db, "conversations", currentChatId, "calls", callDocId), (snap) => {
      if(snap.data()?.status === 'ended') endCallCleanup();
    });
  };

  window.rejectCall = () => {
    document.getElementById('incomingCallModal').style.display = 'none';
    if(callDocId) updateDoc(doc(db, "conversations", currentChatId, "calls", callDocId), { status: 'rejected' });
  };

  // 4. End Call
  window.endCall = async () => {
    if (callDocId && currentChatId) {
      await updateDoc(doc(db, "conversations", currentChatId, "calls", callDocId), { status: 'ended' });
    }
    endCallCleanup();
  };

  function endCallCleanup() {
    if (pc) { pc.close(); pc = null; }
    if (localStream) { localStream.getTracks().forEach(track => track.stop()); }
    document.getElementById('callModal').style.display = 'none';
    document.getElementById('remoteVideo').srcObject = null;
    callDocId = null;
  }

  // 5. Controls & Shy User
  window.toggleMute = () => {
    const audioTrack = localStream.getAudioTracks()[0];
    if (audioTrack) {
      audioTrack.enabled = !audioTrack.enabled;
      const btn = document.getElementById('muteBtn');
      btn.classList.toggle('active-state');
      btn.innerHTML = audioTrack.enabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
    }
  };

  window.toggleCamera = () => {
    const videoTrack = localStream.getVideoTracks()[0];
    if (videoTrack) {
      videoTrack.enabled = !videoTrack.enabled;
      const btn = document.getElementById('cameraBtn');
      btn.classList.toggle('active-state');
      btn.innerHTML = videoTrack.enabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
    }
  };

  window.focusChatInput = () => {
    document.getElementById('messageInput').focus();
  };

  // === VOICE RECORDING ===
  window.startRecording = async () => {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return showError("Audio not supported");
    const btn = document.getElementById('voiceRecordBtn');
    btn.classList.add('voice-recorder-active');
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const audioFile = new File([audioBlob], "voice_note.webm", { type: "audio/webm" });
        window.uploadToCloudinary(audioFile, 'video'); // Reuse upload logic
      };
      mediaRecorder.start();
    } catch (err) { console.error(err); btn.classList.remove('voice-recorder-active'); }
  };

  window.stopRecording = () => {
    document.getElementById('voiceRecordBtn').classList.remove('voice-recorder-active');
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
      mediaRecorder.stream.getTracks().forEach(t => t.stop());
    }
  };

  // === UI RENDERING ===

  function renderMessageHTML(msg, isMe, id) {
    const avatarSrc = isMe ? navUserImg.src : currentChatUserAvatar;
    let content = "";
    
    if (msg.replyTo) {
      content += `<div style="background:rgba(0,0,0,0.05); padding:5px; border-left:2px solid var(--primary); font-size:11px; margin-bottom:5px;">
        <b>${msg.replyTo.user}</b><br>${msg.replyTo.text.substring(0,30)}</div>`;
    }

    if (msg.mediaType === 'image') {
      content += `<img src="${msg.mediaUrl}" class="message-img" onclick="window.open('${msg.mediaUrl}')">`;
    } else if (msg.mediaType === 'video') {
      // Check for voice note extension
      if(msg.mediaUrl && (msg.mediaUrl.includes('.webm') || msg.mediaUrl.includes('.mp3') || msg.mediaUrl.includes('voice_note'))) {
        content += `<div style="padding:5px; display:flex; align-items:center; gap:5px;">
          <i class="fas fa-microphone"></i> <audio src="${msg.mediaUrl}" controls style="height:30px; max-width:200px;"></audio>
        </div>`;
      } else {
        content += `<video src="${msg.mediaUrl}" controls class="message-video"></video>`;
      }
    }
    
    if (msg.text) content += `<div>${msg.text}</div>`;

    const div = document.createElement('div');
    div.className = `message-wrapper ${isMe ? 'sent' : 'received'}`;
    div.id = id;
    
    // Message options logic simplified for brevity
    const options = `<button onclick="handleReply('${id}', '${(msg.text||'Media').replace(/'/g,"\\'")}', '${isMe?'You':currentChatUserName}')" style="background:none; border:none; color:#999; cursor:pointer; font-size:10px; margin:0 5px;"><i class="fas fa-reply"></i></button>`;

    div.innerHTML = `
      ${isMe ? options : ''}
      <img src="${avatarSrc}" style="width:28px; height:28px; border-radius:50%; object-fit:cover; margin-bottom:5px;">
      <div class="message-bubble">
        ${content}
        <span class="message-time">${msg.timestamp ? new Date(msg.timestamp.seconds*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '...'}</span>
      </div>
      ${!isMe ? options : ''}
    `;
    return div;
  }

  // === CORE APP LOGIC ===

  onAuthStateChanged(auth, async user => {
    if (!user) { window.location.href = 'login.html'; return; }
    currentUser = user;
    
    // Load User Data
    try {
      const uDoc = await getDoc(doc(db, "users", user.uid));
      const uData = uDoc.exists() ? uDoc.data() : {};
      navUserImg.src = user.photoURL || uData.photoURL || `https://ui-avatars.com/api/?name=${user.displayName||'User'}&background=0080FF&color=fff`;
      navUserName.textContent = user.displayName || uData.name || 'User';
    } catch(e) { console.error(e); }
    
    loadConversations();
    
    // Initialize settings
    initEmojiPicker();
    const fonts = ["Poppins", "Roboto", "Open Sans", "Lato", "Montserrat"];
    const fontSel = document.getElementById('fontSelect');
    fonts.forEach(f => fontSel.innerHTML += `<option value="${f}">${f}</option>`);
    
    const colors = ['#0080FF', '#FF0055', '#8000FF', '#00BFA5', '#111'];
    const colGrid = document.getElementById('colorGrid');
    colors.forEach(c => {
      const d = document.createElement('div');
      d.style.cssText = `width:30px; height:30px; border-radius:50%; background:${c}; cursor:pointer;`;
      d.onclick = () => { document.documentElement.style.setProperty('--sent-bubble-bg', c); };
      colGrid.appendChild(d);
    });
  });

  function loadConversations() {
    const q = query(collection(db, "conversations"), where("participants", "array-contains", currentUser.uid));
    unsubscribeConversations = onSnapshot(q, (snapshot) => {
      const list = document.getElementById('conversationsList');
      list.innerHTML = '';
      snapshot.forEach(doc => {
        const d = doc.data();
        const otherId = d.participants.find(p => p !== currentUser.uid);
        const name = d.participantNames?.[otherId] || 'User';
        const avatar = d.participantAvatars?.[otherId] || `https://ui-avatars.com/api/?name=${name}`;
        
        const div = document.createElement('div');
        div.className = `conversation-item ${currentChatId === doc.id ? 'active' : ''}`;
        div.setAttribute('data-chat-id', doc.id);
        div.innerHTML = `<img src="${avatar}" class="conversation-avatar"><div class="conversation-info"><div class="conversation-name">${name}</div><div class="conversation-preview">${d.lastMessage || ''}</div></div>`;
        div.onclick = () => openChat(doc.id, otherId, name, avatar);
        list.appendChild(div);
      });
    });
  }

  async function openChat(chatId, otherId, name, avatar) {
    currentChatId = chatId;
    currentChatUser = otherId;
    currentChatUserName = name;
    currentChatUserAvatar = avatar;

    document.getElementById('emptyChat').style.display = 'none';
    document.getElementById('chatHeader').style.display = 'flex';
    document.getElementById('messagesContainer').style.display = 'flex';
    document.getElementById('messageInputContainer').style.display = 'block';
    
    document.getElementById('chatUserName').innerText = name;
    document.getElementById('currentChatAvatar').src = avatar;
    
    // Mobile Transition
    if(window.innerWidth <= 768) {
        document.getElementById('chatArea').classList.add('active');
    }

    // Load Messages
    if (unsubscribeMessages) unsubscribeMessages();
    const q = query(collection(db, "conversations", chatId, "messages"), orderBy("timestamp", "asc"));
    
    unsubscribeMessages = onSnapshot(q, (snapshot) => {
      messagesContainer.innerHTML = '';
      snapshot.forEach(change => {
        const msg = change.data();
        const isMe = msg.senderId === currentUser.uid;
        messagesContainer.appendChild(renderMessageHTML(msg, isMe, change.id));
        
        // SHY USER LOGIC: Show message in video overlay
        if (document.getElementById('callModal').style.display === 'flex' && change.type !== 'removed') {
           const overlay = document.getElementById('videoChatOverlay');
           const bubble = document.createElement('div');
           bubble.className = 'floating-message';
           bubble.innerHTML = `<strong>${isMe?'Me':name}:</strong> ${msg.text || 'Media'}`;
           overlay.appendChild(bubble);
           setTimeout(() => bubble.remove(), 5000);
        }
      });
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });

    // Listen for Incoming Calls in this chat
    const callQuery = query(collection(db, "conversations", chatId, "calls"), where("status", "==", "offering"), limit(1));
    onSnapshot(callQuery, (snap) => {
      snap.docChanges().forEach(change => {
        if(change.type === 'added') {
            const d = change.doc.data();
            if(d.callerId !== currentUser.uid) {
                callDocId = change.doc.id;
                document.getElementById('callerName').innerText = d.callerName;
                document.getElementById('callerAvatar').src = d.callerAvatar;
                document.getElementById('incomingCallModal').style.display = 'block';
            }
        }
      });
    });
  }

  // === SENDING MESSAGES ===
  document.getElementById('sendButton').addEventListener('click', sendMessage);
  
  async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text && !replyToMsg) return;
    
    messageInput.value = '';
    const payload = {
      text,
      senderId: currentUser.uid,
      timestamp: serverTimestamp(),
      replyTo: replyToMsg ? { id: replyToMsg.id, user: replyToMsg.user, text: replyToMsg.text } : null
    };
    
    cancelReply();
    await addDoc(collection(db, "conversations", currentChatId, "messages"), payload);
    await updateDoc(doc(db, "conversations", currentChatId), { lastMessage: text, updatedAt: serverTimestamp() });
  }

  // === FILE UPLOADS ===
  window.uploadToCloudinary = async (file, type) => {
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', 'Meet_video'); // Use your preset
    fd.append('resource_type', 'video'); // Use 'video' for both video and audio
    
    try {
        const res = await fetch(`https://api.cloudinary.com/v1_1/dcwof2ngn/upload`, { method: 'POST', body: fd });
        const data = await res.json();
        if(data.secure_url) {
            await addDoc(collection(db, "conversations", currentChatId, "messages"), {
                mediaUrl: data.secure_url,
                mediaType: type === 'image' ? 'image' : 'video',
                text: "",
                senderId: currentUser.uid,
                timestamp: serverTimestamp()
            });
            await updateDoc(doc(db, "conversations", currentChatId), { lastMessage: type === 'image' ? 'Image' : 'Media', updatedAt: serverTimestamp() });
        }
    } catch(e) { console.error(e); }
  };

  // === UI HELPERS ===
  window.toggleSidebar = () => { sidebar.classList.toggle('open'); sidebarOverlay.classList.toggle('active'); };
  document.getElementById('backButton').addEventListener('click', () => { document.getElementById('chatArea').classList.remove('active'); });
  
  window.handleReply = (id, text, user) => {
    replyToMsg = { id, text, user };
    document.getElementById('replyText').innerText = `Replying to ${user}`;
    document.getElementById('replyPreview').style.display = 'flex';
  };
  window.cancelReply = () => { replyToMsg = null; document.getElementById('replyPreview').style.display = 'none'; };
  
  // Settings & Wallpaper
  window.openSettingsModal = () => document.getElementById('settingsModal').style.display = 'flex';
  window.closeSettingsModal = () => document.getElementById('settingsModal').style.display = 'none';
  window.openWallpaperModal = () => {
    document.getElementById('wallpaperModal').style.display = 'flex';
    const grid = document.getElementById('wallpaperGrid');
    grid.innerHTML = '';
    for(let i=0; i<12; i++) {
        const d = document.createElement('div');
        d.className = 'wallpaper-thumb';
        const url = `https://picsum.photos/seed/${i}/400/800`;
        d.innerHTML = `<img src="${url}">`;
        d.onclick = () => {
            messagesContainer.style.backgroundImage = `url(${url})`;
            closeWallpaperModal();
        };
        grid.appendChild(d);
    }
  };
  window.closeWallpaperModal = () => document.getElementById('wallpaperModal').style.display = 'none';
  
  // Search
  window.openUserSearchOverlay = () => { document.getElementById('userSearchOverlay').style.display = 'flex'; document.getElementById('userSearchInput').focus(); };
  window.closeUserSearchOverlay = () => document.getElementById('userSearchOverlay').style.display = 'none';
  document.getElementById('userSearchInput').addEventListener('input', async (e) => {
    const term = e.target.value.toLowerCase();
    const res = document.getElementById('userSearchResults');
    res.innerHTML = '';
    if(term.length < 2) return;
    
    const q = query(collection(db, "users"), where("email", ">=", term), limit(5));
    const snap = await getDocs(q);
    snap.forEach(doc => {
        const d = doc.data();
        if(doc.id === currentUser.uid) return;
        const div = document.createElement('div');
        div.style.padding = '10px'; div.style.borderBottom = '1px solid #eee'; div.style.cursor = 'pointer';
        div.innerHTML = `<b>${d.name||'User'}</b><br><small>${d.email}</small>`;
        div.onclick = async () => {
            const chatId = [currentUser.uid, doc.id].sort().join('_');
            await setDoc(doc(db, "conversations", chatId), {
                participants: [currentUser.uid, doc.id],
                updatedAt: serverTimestamp()
            }, {merge:true});
            closeUserSearchOverlay();
            // Conversation list listener will pick it up
        };
        res.appendChild(div);
    });
  });

  // Emoji
  window.toggleEmojiPicker = () => {
      const picker = document.getElementById('emojiPicker');
      picker.style.display = picker.style.display === 'flex' ? 'none' : 'flex';
      if(picker.style.display === 'flex') {
         const content = document.getElementById('emojiContent');
         content.innerHTML = '';
         ['ðŸ˜€','ðŸ˜‚','ðŸ˜','ðŸ˜­','ðŸ‘','ðŸ‘‹','ðŸ”¥','â¤ï¸','ðŸŽ‰','ðŸ¤”'].forEach(e => {
             const s = document.createElement('span'); s.className = 'emoji-item'; s.innerText = e;
             s.onclick = () => messageInput.value += e;
             content.appendChild(s);
         });
      }
  };
  window.changeFont = () => document.documentElement.style.setProperty('--chat-font', document.getElementById('fontSelect').value);
</script>
</body>
</html>
