<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary: #0080FF;
    --primary-dark: #0066CC;
    --accent: #00C6FF;
    --success: #10B981;
    --error: #EF4444;
    --bg-color: #f0f2f5;
    --card-bg: #fff;
    --text-color: #111;
    --secondary-text: #65676b;
    --border-color: #dddfe2;
    --online: #10B981;
    --offline: #EF4444;
    --radius: 12px;
    --shadow: 0 2px 8px rgba(0,0,0,0.1);
    /* Dynamic Viewport Height for Mobile */
    --app-height: 100dvh; 
  }

  body.dark-mode {
    --bg-color: #18191a;
    --card-bg: #242526;
    --text-color: #e4e6eb;
    --secondary-text: #b0b3b8;
    --border-color: #3e4042;
    --shadow: 0 2px 8px rgba(0,0,0,0.3);
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }

  html, body {
    height: 100%;
    overflow: hidden; /* Prevent body scroll, handle inside containers */
    font-size: 16px;
  }

  body {
    font-family: 'Poppins', sans-serif;
    background: var(--bg-color);
    color: var(--text-color);
    transition: all 0.3s ease;
  }

  .app-container {
    display: flex;
    height: var(--app-height);
    position: relative;
    overflow: hidden;
  }

  /* Sidebar */
  .sidebar {
    height: 100%;
    width: 280px;
    background: linear-gradient(180deg, #0080FF 0%, #00C6FF 100%);
    border-right: 1px solid var(--border-color);
    overflow-y: auto;
    z-index: 100;
    padding: 20px;
    color: white;
    flex-shrink: 0;
  }

  .sidebar-header {
    padding: 10px 0 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    margin-bottom: 20px;
  }

  .sidebar-menu {
    list-style: none;
  }

  .sidebar-menu li {
    margin-bottom: 8px;
  }

  .sidebar-menu a {
    display: flex;
    align-items: center;
    padding: 12px;
    text-decoration: none;
    color: white;
    border-radius: 8px;
    transition: background 0.3s;
    font-size: 16px;
  }

  .sidebar-menu a:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .sidebar-menu i {
    margin-right: 12px;
    font-size: 18px;
  }

  /* Main Content */
  .main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
    padding: 20px;
  }

  /* Navbar */
  .navbar {
    background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);
    padding: 15px 20px;
    border-radius: 12px;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow);
    color: white;
    flex-shrink: 0;
  }

  .navbar h2 {
    font-size: 20px;
    font-weight: 700;
  }

  .nav-controls {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .search-bar {
    display: flex;
    align-items: center;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    padding: 8px 15px;
    margin-right: 15px;
  }

  .search-bar input {
    background: transparent;
    border: none;
    color: white;
    outline: none;
    width: 200px;
    font-size: 14px;
  }

  .search-bar input::placeholder {
    color: rgba(255, 255, 255, 0.7);
  }

  .user-profile-nav {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 5px 10px;
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.2);
    cursor: pointer;
  }

  .user-avatar {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background: var(--primary);
    object-fit: cover;
    border: 2px solid white;
  }

  .btn {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Chat Container */
  .chat-container {
    flex: 1;
    background: var(--card-bg);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    display: flex;
    /* Crucial for chat stability */
    min-height: 0; 
  }

  /* Conversations Sidebar */
  .conversations-sidebar {
    width: 320px;
    background: var(--card-bg);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .chat-header {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
  }

  .new-chat-btn {
    background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);
    color: white;
    border: none;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .chat-search {
    padding: 10px 15px;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
  }

  .chat-search input {
    width: 100%;
    padding: 10px 15px;
    border-radius: 20px;
    border: 1px solid var(--border-color);
    background: var(--bg-color);
    font-size: 14px;
    outline: none;
  }

  .conversations-list {
    flex: 1;
    overflow-y: auto;
  }

  .conversation-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 15px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
    transition: background 0.2s;
  }

  .conversation-item:hover, .conversation-item.active {
    background: rgba(0,128,255,0.05);
  }

  .conversation-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    object-fit: cover;
  }

  .conversation-info {
    flex: 1;
    min-width: 0;
  }

  .conversation-name {
    font-weight: 600;
    font-size: 15px;
    display: flex;
    justify-content: space-between;
  }

  .conversation-preview {
    font-size: 13px;
    color: var(--secondary-text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Chat Area */
  .chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
    background: var(--bg-color);
    position: relative;
  }

  .chat-area-header {
    padding: 10px 15px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--card-bg);
    flex-shrink: 0;
    z-index: 10;
  }

  .chat-actions {
    display: flex;
    gap: 15px;
    align-items: center;
  }
  
  .chat-action-btn {
    background: none;
    border: none;
    color: var(--primary);
    font-size: 18px;
    cursor: pointer;
  }

  .messages-container {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    background-size: cover;
    background-position: center;
  }

  .message {
    display: flex;
    gap: 8px;
    max-width: 75%;
    position: relative;
    margin-bottom: 5px;
  }

  .message.sent {
    align-self: flex-end;
    flex-direction: row-reverse;
  }

  .message-bubble {
    padding: 10px 14px;
    border-radius: 16px;
    position: relative;
    word-wrap: break-word;
    font-size: 14px;
    line-height: 1.4;
  }

  .received .message-bubble {
    background: var(--card-bg);
    border-bottom-left-radius: 4px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }

  .sent .message-bubble {
    background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);
    color: white;
    border-bottom-right-radius: 4px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }

  .message-time {
    font-size: 10px;
    opacity: 0.7;
    margin-top: 4px;
    text-align: right;
  }

  /* Input Area */
  .message-input-container {
    padding: 10px;
    border-top: 1px solid var(--border-color);
    background: var(--card-bg);
    flex-shrink: 0;
  }

  .message-input-wrapper {
    display: flex;
    align-items: flex-end;
    gap: 8px;
  }

  .message-input {
    flex: 1;
    padding: 10px 15px;
    border-radius: 20px;
    border: 1px solid var(--border-color);
    background: var(--bg-color);
    resize: none;
    font-family: inherit;
    font-size: 15px;
    max-height: 100px;
    outline: none;
  }

  .message-input:focus {
    border-color: var(--primary);
  }

  .send-button {
    background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);
    color: white;
    border: 0;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  /* Icons and Actions near input */
  .message-input-actions {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .input-action {
    background: transparent;
    border: none;
    color: var(--secondary-text);
    cursor: pointer;
    font-size: 20px;
    padding: 8px;
    border-radius: 50%;
  }

  .input-action:hover {
    color: var(--primary);
    background: rgba(0,0,0,0.05);
  }

  /* AI Switch (Bottom) */
  .ai-control {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-right: 5px;
  }
  
  .ai-label { font-size: 8px; font-weight: bold; color: var(--primary); margin-bottom: 2px;}

  .ai-switch {
    position: relative;
    display: inline-block;
    width: 36px;
    height: 20px;
  }
  
  .ai-switch input { opacity: 0; width: 0; height: 0; }
  
  .ai-slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 20px;
  }
  
  .ai-slider:before {
    position: absolute;
    content: "";
    height: 14px;
    width: 14px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }
  
  input:checked + .ai-slider { background-color: #0080FF; }
  input:checked + .ai-slider:before { transform: translateX(16px); }

  /* WhatsApp Style Emoji Picker */
  .emoji-picker {
    display: none;
    position: absolute;
    bottom: 70px;
    left: 10px;
    width: 300px;
    height: 250px;
    background: var(--card-bg);
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 100;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .emoji-nav {
    display: flex;
    background: var(--bg-color);
    overflow-x: auto;
    padding: 5px;
  }

  .emoji-nav button {
    border: none;
    background: none;
    padding: 5px 10px;
    font-size: 18px;
    cursor: pointer;
    opacity: 0.6;
  }

  .emoji-nav button.active { opacity: 1; border-bottom: 2px solid var(--primary); }

  .emoji-content {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 5px;
  }

  .emoji-item {
    font-size: 24px;
    cursor: pointer;
    text-align: center;
    padding: 5px;
    border-radius: 4px;
  }

  .emoji-item:hover { background: var(--bg-color); }

  /* Wallpaper Modal */
  .wallpaper-modal {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 2000;
    padding: 20px;
  }
  
  .wallpaper-content {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 20px;
    max-width: 800px;
    height: 90vh;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
  }

  .wallpaper-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
    overflow-y: auto;
    padding-top: 15px;
  }

  .wallpaper-thumb {
    aspect-ratio: 9/16;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
  }

  .wallpaper-thumb:hover { border-color: var(--primary); transform: scale(1.02); }
  .wallpaper-thumb img, .wallpaper-thumb video { width: 100%; height: 100%; object-fit: cover; }

  /* Back Button */
  .back-button {
    display: none;
    background: none;
    border: none;
    font-size: 20px;
    color: var(--text-color);
    padding: 5px;
    cursor: pointer;
  }

  /* User Search Overlay */
  .user-search-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: none;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }
  
  .user-search-modal {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 25px;
    width: 100%;
    max-width: 450px;
  }
  
  .search-results { max-height: 250px; overflow-y: auto; margin-top: 10px; }
  .search-result-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; }

  /* --- MOBILE RESPONSIVENESS FIXES --- */
  @media (max-width: 768px) {
    .sidebar { width: 70px; padding: 10px 5px; }
    .sidebar-header h2, .sidebar-menu span { display: none; }
    .sidebar-menu a { justify-content: center; padding: 15px 5px; }
    .sidebar-menu i { margin: 0; font-size: 24px; }
    
    .main-content { padding: 0; }
    .navbar { border-radius: 0; margin: 0; padding: 10px; }
    .navbar h2 { font-size: 16px; }
    .search-bar, .user-profile-nav span { display: none; }
    .btn span { display: none; }

    .chat-container {
      border-radius: 0;
      box-shadow: none;
      height: 100%; /* Important for fit */
    }

    .conversations-sidebar { width: 100%; position: absolute; z-index: 50; }
    .chat-area { width: 100%; position: absolute; z-index: 60; transform: translateX(100%); transition: transform 0.3s ease; }
    .chat-area.active { transform: translateX(0); }
    .back-button { display: block; }

    .ai-control { margin-right: 2px; }
    .ai-switch { width: 30px; height: 16px; }
    .ai-slider:before { width: 12px; height: 12px; left: 2px; bottom: 2px; }
    input:checked + .ai-slider:before { transform: translateX(14px); }
    
    /* Emoji picker mobile adjustment */
    .emoji-picker { width: 95%; left: 2.5%; bottom: 60px; }
  }
</style>
</head>
<body>

<div class="app-container">
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>MEET</h2>
    </div>
    <ul class="sidebar-menu">
      <li><a href="feed.html"><i class="fas fa-home"></i> <span>Feed</span></a></li>
      <li><a href="profile.html"><i class="fas fa-user"></i> <span>Profile</span></a></li>
      <li><a href="chat.html" class="active"><i class="fas fa-comment"></i> <span>Chat</span></a></li>
      <li><a href="conference.html"><i class="fas fa-video"></i> <span>Conference</span></a></li>
      <li><a href="meetrader.html"><i class="fas fa-store"></i> <span>Meetrader</span></a></li>
      <li><a href="meetversity.html"><i class="fas fa-graduation-cap"></i> <span>Meetversity</span></a></li>
      <li><a href="organization.html"><i class="fas fa-sitemap"></i> <span>Organization</span></a></li>
    </ul>
  </div>

  <div class="main-content">
    <div class="navbar">
      <h2>Chat</h2>
      <div style="display: flex; gap: 10px;">
        <button class="btn" id="nightToggleBtn"><i class="fas fa-moon"></i> <span>Night</span></button>
        <button class="btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></button>
      </div>
    </div>

    <div class="chat-container">
      <div class="conversations-sidebar" id="conversationsSidebar">
        <div class="chat-header">
          <h3>Messages</h3>
          <button class="new-chat-btn" onclick="openUserSearchOverlay()"><i class="fas fa-plus"></i></button>
        </div>
        <div class="chat-search">
          <input type="text" placeholder="Search chats..." id="chatSearch">
        </div>
        <div class="conversations-list" id="conversationsList">
          </div>
      </div>

      <div class="chat-area" id="chatArea">
        
        <div id="emptyChat" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:var(--secondary-text);">
          <i class="fas fa-comments" style="font-size:60px; opacity:0.5; margin-bottom:20px;"></i>
          <h3>Select a conversation</h3>
        </div>

        <div class="chat-area-header" id="chatHeader" style="display: none;">
          <button class="back-button" id="backButton"><i class="fas fa-arrow-left"></i></button>
          <img src="" id="currentChatAvatar" class="conversation-avatar">
          <div style="flex:1; margin-left:10px;">
            <div style="font-weight:700;" id="chatUserName">User</div>
            <div style="font-size:12px; color:var(--secondary-text);" id="currentChatStatus">Offline</div>
          </div>
          <div class="chat-actions">
            <button class="chat-action-btn" title="Voice Call" onclick="startVoiceCall()"><i class="fas fa-phone-alt"></i></button>
            <button class="chat-action-btn" title="Video Call" onclick="startVideoCall()"><i class="fas fa-video"></i></button>
            <button class="chat-action-btn" title="Wallpaper" onclick="openWallpaperModal()"><i class="fas fa-image"></i></button>
          </div>
        </div>

        <div class="messages-container" id="messagesContainer" style="display: none;"></div>

        <div class="message-input-container" id="messageInputContainer" style="display: none;">
          <div class="message-input-wrapper">
            
            <div class="message-input-actions">
               <div class="ai-control">
                <span class="ai-label">AI</span>
                <label class="ai-switch">
                  <input type="checkbox" id="aiToggle">
                  <span class="ai-slider"></span>
                </label>
              </div>

              <button class="input-action" onclick="toggleEmojiPicker()"><i class="far fa-smile"></i></button>
              <button class="input-action" onclick="attachFile()"><i class="fas fa-paperclip"></i></button>
              <button class="input-action" onclick="startVoiceNote()"><i class="fas fa-microphone"></i></button>
            </div>

            <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
            
            <button class="send-button" id="sendButton"><i class="fas fa-paper-plane"></i></button>
          </div>
          
          <div class="emoji-picker" id="emojiPicker" style="display: none;">
             <div class="emoji-nav" id="emojiNav"></div>
             <div class="emoji-content" id="emojiContent"></div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<div class="user-search-overlay" id="userSearchOverlay">
  <div class="user-search-modal">
    <h3>Start Chat</h3>
    <input type="text" id="userSearchInput" placeholder="Search users by name/email..." style="width:100%; padding:10px; margin:10px 0; border:1px solid #ddd; border-radius:8px;">
    <div class="search-results" id="userSearchResults"></div>
    <button onclick="closeUserSearchOverlay()" class="btn" style="background:var(--error); margin-top:10px; width:100%; justify-content:center;">Cancel</button>
  </div>
</div>

<div class="wallpaper-modal" id="wallpaperModal">
  <div class="wallpaper-content">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
      <h3>Choose Wallpaper</h3>
      <button onclick="closeWallpaperModal()" style="background:none; border:none; font-size:20px; cursor:pointer;"><i class="fas fa-times"></i></button>
    </div>
    <div class="wallpaper-grid" id="wallpaperGrid"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getFirestore, collection, addDoc, updateDoc, doc, getDoc, getDocs, onSnapshot, serverTimestamp, query, orderBy, where, setDoc, limit } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM", 
    authDomain: "meet-6e159.firebaseapp.com",
    projectId: "meet-6e159",
    storageBucket: "meet-6e159.firebasestorage.app",
    messagingSenderId: "252353608421",
    appId: "1:252353608421:web:6706056048e9a8f12db20c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // State
  let currentUser = null;
  let currentChatId = null;
  let currentChatUser = null;
  let isMobile = window.innerWidth <= 768;
  let aiEnabled = false;

  // DOM Elements
  const chatArea = document.getElementById('chatArea');
  const conversationsSidebar = document.getElementById('conversationsSidebar');
  const messagesContainer = document.getElementById('messagesContainer');
  const messageInput = document.getElementById('messageInput');
  const aiToggle = document.getElementById('aiToggle');
  const emojiPicker = document.getElementById('emojiPicker');

  // --- 1. WALLPAPER LOGIC (30 Images, 10 Videos) ---
  const wallpapers = [];
  
  // Generating 30 Themed Image URLs
  const themes = ['nature', 'city', 'tech', 'abstract', 'space', 'ocean', 'forest', 'mountain', 'sunset', 'night'];
  for(let i=0; i<30; i++) {
     const theme = themes[i % themes.length];
     wallpapers.push({ 
       type: 'image', 
       src: `https://source.unsplash.com/random/400x800?${theme}&sig=${i}`,
       thumb: `https://source.unsplash.com/random/100x100?${theme}&sig=${i}` 
     });
  }

  // Generating 10 Video Placeholders (Using standard sample clips)
  const videoSamples = [
      "https://assets.mixkit.co/videos/preview/mixkit-white-sand-beach-background-1564-large.mp4",
      "https://assets.mixkit.co/videos/preview/mixkit-stars-in-space-1610-large.mp4",
      "https://assets.mixkit.co/videos/preview/mixkit-abstract-video-of-a-man-with-heads-like-a-fan-32630-large.mp4",
      "https://assets.mixkit.co/videos/preview/mixkit-forest-stream-in-the-sunlight-529-large.mp4",
      "https://assets.mixkit.co/videos/preview/mixkit-bubbles-of-water-rising-to-the-surface-186-large.mp4",
      "https://assets.mixkit.co/videos/preview/mixkit-ink-swirling-in-water-189-large.mp4",
      "https://assets.mixkit.co/videos/preview/mixkit-red-lights-in-darkness-1383-large.mp4",
      "https://assets.mixkit.co/videos/preview/mixkit-view-of-the-sun-from-space-1608-large.mp4",
      "https://assets.mixkit.co/videos/preview/mixkit-digital-animation-of-blue-and-pink-squares-956-large.mp4",
      "https://assets.mixkit.co/videos/preview/mixkit-texture-of-a-rock-surface-1054-large.mp4"
  ];
  
  videoSamples.forEach(vid => {
      wallpapers.push({ type: 'video', src: vid });
  });

  window.openWallpaperModal = () => {
    document.getElementById('wallpaperModal').style.display = 'block';
    const grid = document.getElementById('wallpaperGrid');
    grid.innerHTML = '';
    
    wallpapers.forEach(wp => {
      const div = document.createElement('div');
      div.className = 'wallpaper-thumb';
      if(wp.type === 'image') {
        div.innerHTML = `<img src="${wp.src}" loading="lazy">`;
      } else {
        div.innerHTML = `<video src="${wp.src}" muted></video>`;
      }
      div.onclick = () => setWallpaper(wp);
      grid.appendChild(div);
    });
  };

  window.closeWallpaperModal = () => document.getElementById('wallpaperModal').style.display = 'none';

  function setWallpaper(wp) {
    if(wp.type === 'image') {
       messagesContainer.style.backgroundImage = `url(${wp.src})`;
       messagesContainer.innerHTML = ''; // Clear video if exists
       loadMessages(currentChatId); // Reload messages
    } else {
       messagesContainer.style.backgroundImage = 'none';
       // Create background video element
       const vid = document.createElement('video');
       vid.src = wp.src;
       vid.autoplay = true;
       vid.loop = true;
       vid.muted = true;
       vid.style.cssText = "position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:-1; opacity:0.6;";
       messagesContainer.prepend(vid);
    }
    closeWallpaperModal();
  }

  // --- 2. EXTENDED EMOJI PICKER (WhatsApp Style) ---
  const emojis = {
    "ðŸ˜€": ["ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ˜†","ðŸ˜…","ðŸ˜‚","ðŸ¤£","ðŸ¥²","â˜ºï¸","ðŸ˜Š","ðŸ˜‡","ðŸ™‚","ðŸ™ƒ","ðŸ˜‰","ðŸ˜Œ","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ˜—","ðŸ˜™","ðŸ˜š","ðŸ˜‹","ðŸ˜›","ðŸ˜","ðŸ˜œ","ðŸ¤ª","ðŸ¤¨","ðŸ§","ðŸ¤“","ðŸ˜Ž","ðŸ¥¸","ðŸ¤©","ðŸ¥³","ðŸ˜","ðŸ˜’","ðŸ˜ž","ðŸ˜”","ðŸ˜Ÿ","ðŸ˜•","ðŸ™","â˜¹ï¸","ðŸ˜£","ðŸ˜–","ðŸ˜«","ðŸ˜©","ðŸ¥º","ðŸ˜¢","ðŸ˜­","ðŸ˜¤","ðŸ˜ ","ðŸ˜¡","ðŸ¤¬","ðŸ¤¯","ðŸ˜³","ðŸ¥µ","ðŸ¥¶","ðŸ˜±","ðŸ˜¨","ðŸ˜°","ðŸ˜¥","ðŸ˜“","ðŸ¤—","ðŸ¤”","ðŸ¤­","ðŸ¤«","ðŸ¤¥","ðŸ˜¶","ðŸ˜","ðŸ˜‘","ðŸ˜¬","ðŸ™„","ðŸ˜¯","ðŸ˜¦","ðŸ˜§","ðŸ˜®","ðŸ˜²","ðŸ¥±","ðŸ˜´","ðŸ¤¤","ðŸ˜ª","ðŸ˜µ","ðŸ¤","ðŸ¥´","ðŸ¤¢","ðŸ¤®","ðŸ¤§","ðŸ˜·","ðŸ¤’","ðŸ¤•"],
    "ðŸµ": ["ðŸ¶","ðŸ±","ðŸ­","ðŸ¹","ðŸ°","ðŸ¦Š","ðŸ»","ðŸ¼","ðŸ»â€â„ï¸","ðŸ¨","ðŸ¯","ðŸ¦","ðŸ®","ðŸ·","ðŸ½","ðŸ¸","ðŸµ","ðŸ™ˆ","ðŸ™‰","ðŸ™Š","ðŸ’","ðŸ”","ðŸ§","ðŸ¦","ðŸ¤","ðŸ£","ðŸ¥","ðŸ¦†","ðŸ¦…","ðŸ¦‰","ðŸ¦‡","ðŸº","ðŸ—","ðŸ´","ðŸ¦„","ðŸ","ðŸª±","ðŸ›","ðŸ¦‹","ðŸŒ","ðŸž","ðŸœ","ðŸª°","ðŸª²","ðŸª³","ðŸ¦Ÿ","ðŸ¦—","ðŸ•·","ðŸ•¸","ðŸ¦‚","ðŸ¢","ðŸ","ðŸ¦Ž","ðŸ¦–","ðŸ¦•","ðŸ™","ðŸ¦‘","ðŸ¦","ðŸ¦ž","ðŸ¦€","ðŸ¡","ðŸ ","ðŸŸ","dolphin","ðŸ³","ðŸ‹","ðŸ¦ˆ","ðŸŠ","ðŸ…","ðŸ†","ðŸ¦“","ðŸ¦","ðŸ¦§","ðŸ¦£","ðŸ˜","ðŸ¦›","ðŸ¦","ðŸª","ðŸ«","ðŸ¦’","ðŸ¦˜","ðŸ¦¬","ðŸƒ","ðŸ‚","ðŸ„","ðŸŽ","ðŸ–","ðŸ","ðŸ‘","ðŸ¦™","ðŸ","ðŸ¦Œ","ðŸ•","ðŸ©","ðŸ¦®","ðŸ•â€ðŸ¦º","ðŸˆ","ðŸˆâ€â¬›","ðŸ“","ðŸ¦ƒ","ðŸ¦š","ðŸ¦œ","ðŸ¦¢","ðŸ¦©","ðŸ•Š","ðŸ‡","ðŸ¦","ðŸ¦¨","ðŸ¦¡","ðŸ¦«","ðŸ¦¦","ðŸ¦¥","ðŸ","ðŸ€","ðŸ¿","ðŸ¦”"],
    "ðŸŽ": ["ðŸ","ðŸŽ","ðŸ","ðŸŠ","ðŸ‹","ðŸŒ","ðŸ‰","ðŸ‡","ðŸ“","ðŸ«","ðŸˆ","ðŸ’","ðŸ‘","ðŸ¥­","ðŸ","ðŸ¥¥","ðŸ¥","ðŸ…","ðŸ†","ðŸ¥‘","ðŸ¥¦","ðŸ¥¬","ðŸ¥’","ðŸŒ¶","ðŸ«‘","ðŸŒ½","ðŸ¥•","ðŸ«’","ðŸ§„","ðŸ§…","ðŸ¥”","ðŸ ","ðŸ¥","ðŸ¥¯","ðŸž","ðŸ¥–","ðŸ¥¨","ðŸ§€","ðŸ¥š","ðŸ³","ðŸ§ˆ","ðŸ¥ž","ðŸ§‡","ðŸ¥“","ðŸ¥©","ðŸ—","ðŸ–","ðŸ¦´","ðŸŒ­","ðŸ”","ðŸŸ","ðŸ•","ðŸ«“","ðŸ¥ª","ðŸ¥™","ðŸ§†","ðŸŒ®","ðŸŒ¯","ðŸ«”","ðŸ¥—","ðŸ¥˜","ðŸ«•","ðŸ¥«","ðŸ","ðŸœ","ðŸ²","ðŸ›","ðŸ£","ðŸ±","ðŸ¥Ÿ","ðŸ¦ª","ðŸ¤","ðŸ™","ðŸš","ðŸ˜","ðŸ¥","ðŸ¥ ","ðŸ¥®","ðŸ¢","ðŸ¡","ðŸ§","ðŸ¨","ðŸ¦","ðŸ¥§","ðŸ§","ðŸ°","ðŸŽ‚","ðŸ®","ðŸ­","ðŸ¬","ðŸ«","ðŸ¿","ðŸ©","ðŸª","ðŸŒ°","ðŸ¥œ","ðŸ¯","ðŸ¥›","ðŸ¼","â˜•ï¸","ðŸ«–","ðŸµ","ðŸ§ƒ","ðŸ¥¤","ðŸ§‹","ðŸ¶","ðŸº","ðŸ»","ðŸ¥‚","ðŸ·","ðŸ¥ƒ","ðŸ¸","ðŸ¹","ðŸ§‰","ðŸ¾","ðŸ§Š","ðŸ¥„","ðŸ´","ðŸ½","ðŸ¥£","ðŸ¥¡","ðŸ¥¢","ðŸ§‚"],
    "âš½": ["âš½ï¸","ðŸ€","ðŸˆ","âš¾ï¸","ðŸ¥Ž","ðŸŽ¾","ðŸ","ðŸ‰","ðŸ¥","ðŸŽ±","ðŸª€","ðŸ“","ðŸ¸","ðŸ’","ðŸ‘","ðŸ¥","ðŸ","ðŸªƒ","ðŸ¥…","â›³ï¸","ðŸª","ðŸ¹","ðŸŽ£","ðŸ¤¿","ðŸ¥Š","ðŸ¥‹","ðŸŽ½","ðŸ›¹","ðŸ›¼","ðŸ›·","â›¸","ðŸ¥Œ","ðŸŽ¿","â›·","ðŸ‚","ðŸª‚","ðŸ‹ï¸â€â™€ï¸","ðŸ‹ï¸","ðŸ‹ï¸â€â™‚ï¸","ðŸ¤¼â€â™€ï¸","ðŸ¤¼","ðŸ¤¼â€â™‚ï¸","ðŸ¤¸â€â™€ï¸","ðŸ¤¸","ðŸ¤¸â€â™‚ï¸","â›¹ï¸â€â™€ï¸","â›¹ï¸","â›¹ï¸â€â™‚ï¸","ðŸ¤º","ðŸ¤¾â€â™€ï¸","ðŸ¤¾","ðŸ¤¾â€â™‚ï¸","ðŸŒï¸â€â™€ï¸","ðŸŒï¸","ðŸŒï¸â€â™‚ï¸","ðŸ‡","ðŸ§˜â€â™€ï¸","ðŸ§˜","ðŸ§˜â€â™‚ï¸","ðŸ„â€â™€ï¸","ðŸ„","ðŸ„â€â™‚ï¸","ðŸŠâ€â™€ï¸","ðŸŠ","ðŸŠâ€â™‚ï¸","ðŸ¤½â€â™€ï¸","ðŸ¤½","ðŸ¤½â€â™‚ï¸","ðŸš£â€â™€ï¸","ðŸš£","ðŸš£â€â™‚ï¸","ðŸ§—â€â™€ï¸","ðŸ§—","ðŸ§—â€â™‚ï¸","ðŸšµâ€â™€ï¸","ðŸšµ","ðŸšµâ€â™‚ï¸","ðŸš´â€â™€ï¸","ðŸš´","ðŸš´â€â™‚ï¸","ðŸ†","ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰","ðŸ…","ðŸŽ–","ðŸµ","ðŸŽ—","ðŸŽ«","ðŸŽŸ","ðŸŽª","ðŸ¤¹","ðŸ¤¹â€â™‚ï¸","ðŸ¤¹â€â™€ï¸","ðŸŽ­","ðŸ©°","ðŸŽ¨","ðŸŽ¬","ðŸŽ¤","ðŸŽ§","ðŸŽ¼","ðŸŽ¹","ðŸ¥","ðŸª˜","ðŸŽ·","ðŸŽº","ðŸª—","ðŸŽ¸","ðŸª•","ðŸŽ»","ðŸŽ²","â™Ÿ","ðŸŽ¯","ðŸŽ³","ðŸŽ®","ðŸŽ°","ðŸ§©"]
  };

  function initEmojiPicker() {
    const nav = document.getElementById('emojiNav');
    const content = document.getElementById('emojiContent');
    let first = true;

    for (const [key, list] of Object.entries(emojis)) {
      const btn = document.createElement('button');
      btn.innerText = key;
      btn.onclick = () => showEmojiCategory(key);
      if(first) { btn.classList.add('active'); showEmojiCategory(key); first=false; }
      nav.appendChild(btn);
    }
  }

  function showEmojiCategory(cat) {
    const content = document.getElementById('emojiContent');
    content.innerHTML = '';
    // Active class logic
    document.querySelectorAll('.emoji-nav button').forEach(b => {
      b.classList.toggle('active', b.innerText === cat);
    });

    emojis[cat].forEach(e => {
      const span = document.createElement('span');
      span.className = 'emoji-item';
      span.innerText = e;
      span.onclick = () => {
        messageInput.value += e;
        emojiPicker.style.display = 'none';
        messageInput.focus();
      };
      content.appendChild(span);
    });
  }

  window.toggleEmojiPicker = () => {
    emojiPicker.style.display = emojiPicker.style.display === 'flex' ? 'none' : 'flex';
  };

  // --- 3. CORE CHAT LOGIC ---

  onAuthStateChanged(auth, user => {
    if (!user) {
      window.location.href = 'login.html'; // Assuming login page exists
    } else {
      currentUser = user;
      document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
      loadConversations();
      initEmojiPicker();
    }
  });

  // Load Conversations
  function loadConversations() {
    const q = query(collection(db, "conversations"), where("participants", "array-contains", currentUser.uid));
    onSnapshot(q, (snapshot) => {
      const list = document.getElementById('conversationsList');
      list.innerHTML = '';
      const convs = [];
      snapshot.forEach(doc => convs.push({id: doc.id, ...doc.data()}));
      
      // Sort manually by updatedAt desc
      convs.sort((a,b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));

      convs.forEach(conv => {
         const otherId = conv.participants.find(p => p !== currentUser.uid);
         const name = conv.participantNames?.[otherId] || 'User';
         const avatar = conv.participantAvatars?.[otherId] || `https://ui-avatars.com/api/?name=${name}&background=random`;
         
         const div = document.createElement('div');
         div.className = `conversation-item ${currentChatId === conv.id ? 'active' : ''}`;
         div.innerHTML = `
           <img src="${avatar}" class="conversation-avatar">
           <div class="conversation-info">
             <div class="conversation-name">${name}</div>
             <div class="conversation-preview">${conv.lastMessage || 'No messages'}</div>
           </div>
         `;
         div.onclick = () => openChat(conv.id, otherId, name, avatar);
         list.appendChild(div);
      });
    });
  }

  // Open Chat
  async function openChat(chatId, otherUserId, name, avatar) {
    currentChatId = chatId;
    currentChatUser = otherUserId;
    
    // UI Updates
    document.getElementById('emptyChat').style.display = 'none';
    document.getElementById('chatHeader').style.display = 'flex';
    document.getElementById('messagesContainer').style.display = 'flex';
    document.getElementById('messageInputContainer').style.display = 'block';
    
    document.getElementById('chatUserName').innerText = name;
    document.getElementById('currentChatAvatar').src = avatar;

    // Mobile Transition
    if(window.innerWidth <= 768) {
      conversationsSidebar.style.zIndex = '10'; // Move back
      chatArea.classList.add('active');
    }

    loadMessages(chatId);
  }

  // Load Messages (Optimized to reduce fluctuation)
  let unsubscribeMessages;
  function loadMessages(chatId) {
    if(unsubscribeMessages) unsubscribeMessages();
    
    const q = query(collection(db, "conversations", chatId, "messages"), orderBy("timestamp", "asc"));
    
    unsubscribeMessages = onSnapshot(q, (snapshot) => {
      const container = document.getElementById('messagesContainer');
      container.innerHTML = ''; // In a production app, append only new ones. keeping simple here.
      
      snapshot.forEach(doc => {
        const msg = doc.data();
        const div = document.createElement('div');
        div.className = `message ${msg.senderId === currentUser.uid ? 'sent' : 'received'}`;
        div.innerHTML = `
           <div class="message-bubble">
             ${msg.text}
             <div class="message-time">${msg.timestamp ? new Date(msg.timestamp.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...'}</div>
           </div>
        `;
        container.appendChild(div);
      });
      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    });
  }

  // Send Message
  document.getElementById('sendButton').addEventListener('click', sendMessage);
  
  async function sendMessage() {
    const text = messageInput.value.trim();
    if(!text || !currentChatId) return;

    let finalBody = text;
    if(document.getElementById('aiToggle').checked) {
       finalBody += " ... (AI Generated)";
    }

    messageInput.value = '';

    await addDoc(collection(db, "conversations", currentChatId, "messages"), {
      text: finalBody,
      senderId: currentUser.uid,
      timestamp: serverTimestamp()
    });

    await updateDoc(doc(db, "conversations", currentChatId), {
      lastMessage: finalBody,
      updatedAt: serverTimestamp()
    });
  }

  // Search User Functions (Left untouched in logic, just connected to UI)
  window.openUserSearchOverlay = () => {
    document.getElementById('userSearchOverlay').style.display = 'flex';
  }
  
  window.closeUserSearchOverlay = () => {
    document.getElementById('userSearchOverlay').style.display = 'none';
  }

  document.getElementById('userSearchInput').addEventListener('input', async (e) => {
    const term = e.target.value.toLowerCase();
    if(term.length < 3) return;
    
    const resultsDiv = document.getElementById('userSearchResults');
    resultsDiv.innerHTML = 'Searching...';
    
    // Simple query
    const q = query(collection(db, "users"), where("email", ">=", term), where("email", "<=", term + '\uf8ff'), limit(5));
    const snapshot = await getDocs(q);
    
    resultsDiv.innerHTML = '';
    snapshot.forEach(doc => {
       if(doc.id === currentUser.uid) return;
       const data = doc.data();
       const div = document.createElement('div');
       div.className = 'search-result-item';
       div.innerHTML = `<div>${data.name || data.email}</div>`;
       div.onclick = () => startNewChat(doc.id, data);
       resultsDiv.appendChild(div);
    });
  });

  async function startNewChat(otherId, otherData) {
    // Generate chat ID (alphabetic sort of UIDs)
    const participants = [currentUser.uid, otherId].sort();
    const chatId = participants.join('_');
    
    await setDoc(doc(db, "conversations", chatId), {
      participants: participants,
      participantNames: { [currentUser.uid]: currentUser.displayName || 'Me', [otherId]: otherData.name || 'User' },
      updatedAt: serverTimestamp(),
      lastMessage: ''
    }, {merge: true}); // Merge prevents overwriting existing chat

    closeUserSearchOverlay();
    openChat(chatId, otherId, otherData.name || 'User', otherData.photoURL || 'https://via.placeholder.com/50');
  }

  // --- 4. EXTRAS ---
  document.getElementById('backButton').addEventListener('click', () => {
    chatArea.classList.remove('active');
  });

  document.getElementById('nightToggleBtn').addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
  });

  // Placeholder Actions
  window.startVoiceCall = () => alert('Starting Voice Call...');
  window.startVideoCall = () => alert('Starting Video Call...');
  window.attachFile = () => alert('File picker would open here.');
  window.startVoiceNote = () => alert('Recording audio...');

</script>
</body>
</html>
