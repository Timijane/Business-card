<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
<title>MEET | Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>

<style>
  :root {
    --primary: #0080FF;
    --primary-dark: #0066CC;
    --bg-color: #f0f2f5;
    --card-bg: #fff;
    --text-color: #111;
    --secondary-text: #65676b;
    --border-color: #dddfe2;
    --outgoing-bg: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);
    --incoming-bg: #fff;
    --shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  body.dark-mode {
    --bg-color: #18191a;
    --card-bg: #242526;
    --text-color: #e4e6eb;
    --secondary-text: #b0b3b8;
    --border-color: #3e4042;
    --incoming-bg: #3e4042;
    --shadow: 0 2px 8px rgba(0,0,0,0.3);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  html, body { 
    height: 100%; 
    overflow: hidden; /* Critical for mobile chat app feel */
    font-family: 'Poppins', sans-serif; 
    font-size: 16px;
  }
  
  body { background: var(--bg-color); color: var(--text-color); transition: background 0.3s ease; }

  .app-container { display: flex; height: 100%; width: 100%; }

  /* --- Sidebar (Navigation) --- */
  .sidebar {
    width: 280px;
    background: linear-gradient(180deg, #0080FF 0%, #00C6FF 100%);
    display: flex; flex-direction: column; padding: 20px;
    flex-shrink: 0; z-index: 100;
  }
  .sidebar h2 { color: white; margin-bottom: 20px; font-weight: 700; font-size: 24px; }
  .sidebar-menu { list-style: none; }
  .sidebar-menu a {
    display: flex; align-items: center; padding: 12px;
    color: white; text-decoration: none; border-radius: 8px;
    margin-bottom: 8px; transition: 0.2s;
  }
  .sidebar-menu a:hover, .sidebar-menu a.active { background: rgba(255,255,255,0.2); }
  .sidebar-menu i { margin-right: 12px; width: 24px; text-align: center; }

  /* --- Main Content Area --- */
  .main-content {
    flex: 1; display: flex; flex-direction: column;
    height: 100%; overflow: hidden; position: relative;
  }

  /* --- Chat Interface Wrapper --- */
  .chat-interface {
    display: flex; width: 100%; height: 100%;
    background: var(--bg-color);
    position: relative; overflow: hidden;
  }

  /* 1. Chat List Panel (Left) */
  .chat-list-panel {
    width: 350px; background: var(--card-bg);
    border-right: 1px solid var(--border-color);
    display: flex; flex-direction: column;
    flex-shrink: 0; z-index: 50;
  }

  /* 2. Chat Message Panel (Right) */
  .chat-message-panel {
    flex: 1; display: flex; flex-direction: column;
    background-color: #e5ddd5; /* Default fallback */
    background-size: cover; background-position: center;
    position: relative; z-index: 40;
    transition: transform 0.3s ease;
  }

  /* Headers */
  .panel-header {
    height: 65px; padding: 0 15px; display: flex; align-items: center; justify-content: space-between;
    background: var(--card-bg); border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
  }
  
  /* Conversation Items */
  .convo-list { overflow-y: auto; flex: 1; }
  .convo-item {
    display: flex; align-items: center; padding: 15px; cursor: pointer;
    border-bottom: 1px solid var(--border-color); transition: 0.2s;
  }
  .convo-item:hover, .convo-item.active { background: rgba(0,128,255,0.05); }
  .user-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; margin-right: 12px; border: 1px solid var(--border-color); }
  
  .convo-info h4 { font-size: 15px; margin-bottom: 4px; color: var(--text-color); }
  .convo-info p { font-size: 13px; color: var(--secondary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }

  /* Messages Area */
  .messages-area {
    flex: 1; padding: 20px; overflow-y: auto;
    display: flex; flex-direction: column; gap: 8px;
    background: rgba(255, 255, 255, 0.6); /* Slight overlay for text readability over wallpaper */
    backdrop-filter: blur(5px); /* Modern blur effect */
  }
  
  .message { max-width: 75%; display: flex; flex-direction: column; position: relative; margin-bottom: 5px; animation: popIn 0.3s ease; }
  @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  
  .message.sent { align-self: flex-end; align-items: flex-end; }
  .message.received { align-self: flex-start; align-items: flex-start; }
  
  .bubble {
    padding: 10px 14px; border-radius: 12px; position: relative;
    font-size: 14.5px; line-height: 1.5; word-wrap: break-word;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  .sent .bubble { background: var(--outgoing-bg); color: white; border-bottom-right-radius: 2px; }
  .received .bubble { background: var(--card-bg); color: var(--text-color); border-bottom-left-radius: 2px; }

  .msg-media { max-width: 100%; border-radius: 8px; margin-bottom: 5px; display: block; cursor: pointer; }
  .msg-time { font-size: 10px; opacity: 0.7; text-align: right; margin-top: 4px; display: flex; align-items: center; justify-content: flex-end; gap: 4px;}

  /* Input Area - Redesigned */
  .input-panel {
    background: var(--card-bg); padding: 8px 10px;
    border-top: 1px solid var(--border-color);
    display: flex; align-items: flex-end; gap: 8px;
    position: relative; z-index: 100;
  }

  .chat-input {
    flex: 1; padding: 12px 15px; border-radius: 24px; border: 1px solid var(--border-color);
    background: var(--bg-color); color: var(--text-color); outline: none;
    max-height: 120px; resize: none; font-family: inherit; font-size: 15px;
  }
  .chat-input:focus { border-color: var(--primary); }

  .icon-btn {
    width: 40px; height: 40px; border-radius: 50%; border: none; background: transparent;
    color: var(--secondary-text); font-size: 20px; cursor: pointer; transition: 0.2s;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  }
  .icon-btn:hover { color: var(--primary); background: rgba(0,128,255,0.1); }
  .send-btn { background: var(--primary); color: white; }
  .send-btn:hover { background: var(--primary-dark); color: white; }

  /* AI Switch - Bottom Location */
  .ai-wrapper {
    display: flex; align-items: center; gap: 5px;
    padding: 0 5px; border-right: 1px solid var(--border-color);
    margin-right: 5px;
  }
  .ai-label { font-size: 10px; font-weight: 700; color: var(--primary); text-transform: uppercase; }
  
  /* Toggle Switch */
  .switch { position: relative; display: inline-block; width: 32px; height: 18px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
  .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: var(--primary); }
  input:checked + .slider:before { transform: translateX(14px); }

  /* Emoji Picker (WhatsApp Style) */
  .emoji-container {
    display: none; position: absolute; bottom: 70px; left: 10px;
    z-index: 200; box-shadow: 0 5px 20px rgba(0,0,0,0.2); border-radius: 8px;
    background: var(--card-bg);
  }
  emoji-picker { width: 320px; height: 350px; --background: var(--card-bg); --border-color: var(--border-color); }

  /* Wallpaper Modal */
  .wp-modal {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 2000; align-items: center; justify-content: center;
  }
  .wp-content {
    background: var(--card-bg); width: 90%; max-width: 800px; height: 80vh;
    border-radius: 16px; padding: 20px; display: flex; flex-direction: column;
  }
  .wp-grid {
    flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;
    margin-top: 15px; padding-right: 5px;
  }
  .wp-item {
    aspect-ratio: 9/16; border-radius: 8px; background-size: cover; background-position: center; cursor: pointer;
    border: 3px solid transparent; transition: 0.2s; position: relative;
  }
  .wp-item:hover { transform: scale(1.05); z-index: 2; }
  .wp-item.selected { border-color: var(--primary); }
  .wp-tag { 
    position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.6); 
    color: white; font-size: 10px; padding: 3px; text-align: center;
  }

  /* --- MOBILE RESPONSIVE FIX --- */
  @media (max-width: 768px) {
    .sidebar { display: none; } /* Hide Nav Sidebar */
    .main-content { margin-left: 0; }
    
    .chat-list-panel { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 10; transform: translateX(0); transition: transform 0.3s ease; }
    .chat-message-panel { width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 20; transform: translateX(100%); transition: transform 0.3s ease; }
    
    /* When Chat is Active */
    .chat-interface.active .chat-list-panel { transform: translateX(-20%); opacity: 0; }
    .chat-interface.active .chat-message-panel { transform: translateX(0); }

    .back-btn { display: flex !important; margin-right: 10px; }
    emoji-picker { width: 100vw; max-width: 100%; }
  }

  /* Desktop Tweaks */
  @media (min-width: 769px) {
    .back-btn { display: none; }
    .chat-message-panel { transform: none !important; }
  }
</style>
</head>
<body>

<div class="app-container">
  
  <div class="sidebar">
    <h2>MEET</h2>
    <ul class="sidebar-menu">
      <li><a href="feed.html"><i class="fas fa-home"></i> Feed</a></li>
      <li><a href="chat.html" class="active"><i class="fas fa-comment"></i> Chat</a></li>
      <li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
      <li style="margin-top: auto;"><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
    </ul>
  </div>

  <div class="main-content">
    
    <div class="chat-interface" id="chatInterface">
      
      <div class="chat-list-panel">
        <div class="panel-header">
          <h3>Chats</h3>
          <button class="icon-btn" onclick="openUserSearch()" title="New Chat"><i class="fas fa-plus"></i></button>
        </div>
        <div style="padding: 10px; border-bottom: 1px solid var(--border-color);">
          <input type="text" id="searchChats" placeholder="Search conversations..." style="width: 100%; padding: 8px 12px; border-radius: 20px; border: 1px solid var(--border-color); outline: none;">
        </div>
        <div class="convo-list" id="conversationsList">
          <div style="padding:20px; text-align:center; color:#999;">Loading...</div>
        </div>
      </div>

      <div class="chat-message-panel" id="messagePanel">
        
        <div class="panel-header" id="chatHeader" style="display:none;">
          <div style="display: flex; align-items: center;">
            <button class="icon-btn back-btn" onclick="closeChat()"><i class="fas fa-arrow-left"></i></button>
            <img src="" class="user-avatar" id="headerAvatar">
            <div>
              <h4 id="headerName" style="margin:0;">User</h4>
              <span id="headerStatus" style="font-size: 11px; color: var(--success);">Online</span>
            </div>
          </div>
          <div style="display: flex; gap: 5px;">
            <button class="icon-btn" onclick="openWallpaperModal()" title="Wallpaper"><i class="fas fa-image"></i></button>
            <button class="icon-btn" title="Call"><i class="fas fa-phone"></i></button>
            <button class="icon-btn" title="Video"><i class="fas fa-video"></i></button>
          </div>
        </div>

        <div class="messages-area" id="messagesArea">
          <div style="margin: auto; text-align: center; padding: 20px; background: rgba(255,255,255,0.8); border-radius: 12px;">
            <i class="fas fa-comments" style="font-size: 40px; color: var(--primary); margin-bottom: 10px;"></i>
            <p>Select a chat to start messaging</p>
          </div>
        </div>

        <div class="input-panel" id="inputPanel" style="display:none;">
          
          <div class="ai-wrapper" title="AI Auto Reply">
            <span class="ai-label">AI</span>
            <label class="switch">
              <input type="checkbox" id="aiToggle">
              <span class="slider"></span>
            </label>
          </div>

          <button class="icon-btn" onclick="toggleEmoji()"><i class="far fa-smile"></i></button>
          <button class="icon-btn" onclick="document.getElementById('mediaInput').click()"><i class="fas fa-paperclip"></i></button>
          <input type="file" id="mediaInput" hidden accept="image/*,video/*">

          <textarea id="messageInput" class="chat-input" rows="1" placeholder="Message..."></textarea>
          
          <button class="icon-btn send-btn" id="sendBtn"><i class="fas fa-paper-plane"></i></button>

          <div class="emoji-container" id="emojiContainer">
            <emoji-picker></emoji-picker>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<div class="wp-modal" id="wpModal">
  <div class="wp-content">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3>Choose Wallpaper</h3>
      <button class="icon-btn" onclick="closeWallpaperModal()"><i class="fas fa-times"></i></button>
    </div>
    <div class="wp-grid" id="wpGrid">
      </div>
  </div>
</div>

<div id="searchModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:200; align-items:center; justify-content:center;">
  <div style="background:white; padding:20px; border-radius:12px; width:90%; max-width:400px;">
    <h3>New Chat</h3>
    <input type="text" id="userSearchInput" placeholder="Enter user email..." style="width:100%; padding:10px; margin:15px 0; border:1px solid #ddd; border-radius:8px;">
    <button class="btn" onclick="startChat()" style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:8px;">Start</button>
    <button class="btn" onclick="document.getElementById('searchModal').style.display='none'" style="background:#eee; border:none; padding:10px 20px; border-radius:8px;">Cancel</button>
  </div>
</div>

<script type="module">
  // --- Firebase Imports ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  import { 
    getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, serverTimestamp, query, orderBy, where, setDoc, getDocs 
  } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

  // --- Configuration ---
  const firebaseConfig = {
    apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
    authDomain: "meet-6e159.firebaseapp.com",
    projectId: "meet-6e159",
    storageBucket: "meet-6e159.firebasestorage.app",
    messagingSenderId: "252353608421",
    appId: "1:252353608421:web:6706056048e9a8f12db20c"
  };

  // Cloudinary (Using demo preset for functionality, replace with yours)
  const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dcwof2ngn/upload";
  const CLOUDINARY_PRESET = "Meet_video"; 

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- State Variables ---
  let currentUser = null;
  let currentChatId = null;
  let currentMessageSnapshotUnsubscribe = null; // IMPORTANT: Fixes the listener fluctuation
  let aiEnabled = false;

  // --- 40+ Wallpapers (AI Themes) ---
  const wallpapers = [
    { cat: 'Cyberpunk', url: 'https://images.unsplash.com/photo-1555680202-c86f0e12f086?w=600&q=80' },
    { cat: 'Neon', url: 'https://images.unsplash.com/photo-1565626424178-c699f660d2e5?w=600&q=80' },
    { cat: 'Abstract', url: 'https://images.unsplash.com/photo-1541701494587-cb58502866ab?w=600&q=80' },
    { cat: 'Space', url: 'https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=600&q=80' },
    { cat: 'Nature AI', url: 'https://images.unsplash.com/photo-1518173946687-a4c8892bbd9f?w=600&q=80' },
    { cat: 'Dark Minimal', url: 'https://images.unsplash.com/photo-1483729558449-99ef09a8c325?w=600&q=80' },
    { cat: 'Geometric', url: 'https://images.unsplash.com/photo-1550100136-e074fa43d8d8?w=600&q=80' },
    { cat: 'City', url: 'https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?w=600&q=80' },
    { cat: 'Tech', url: 'https://images.unsplash.com/photo-1518770660439-4636190af475?w=600&q=80' },
    { cat: 'Gradient', url: 'https://images.unsplash.com/photo-1557683316-973673baf926?w=600&q=80' },
    // Add 30 more via loops or static list for brevity
    { cat: 'Blue', url: 'https://images.unsplash.com/photo-1536566482680-fca31930a0bd?w=600&q=80' },
    { cat: 'Red', url: 'https://images.unsplash.com/photo-1542259681-dadcd731560b?w=600&q=80' },
    { cat: 'Forest', url: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=600&q=80' },
    { cat: 'Ocean', url: 'https://images.unsplash.com/photo-1505118380757-91f5f5632de0?w=600&q=80' },
    { cat: 'Mountain', url: 'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=600&q=80' },
    { cat: 'Desert', url: 'https://images.unsplash.com/photo-1473580044384-7ba9967e16a0?w=600&q=80' },
    { cat: 'Snow', url: 'https://images.unsplash.com/photo-1491002052546-bf38f186af56?w=600&q=80' },
    { cat: 'Art', url: 'https://images.unsplash.com/photo-1547891654-e66ed7ebb968?w=600&q=80' },
    { cat: 'Paint', url: 'https://images.unsplash.com/photo-1549490349-8643362247b5?w=600&q=80' },
    { cat: 'Smoke', url: 'https://images.unsplash.com/photo-1502691876148-a84978e59af8?w=600&q=80' },
    { cat: 'Cloud', url: 'https://images.unsplash.com/photo-1534088568595-a066f410bcda?w=600&q=80' },
    { cat: 'Galaxy', url: 'https://images.unsplash.com/photo-1462331940025-496dfbfc7564?w=600&q=80' },
    { cat: 'Default', url: 'https://i.ibb.co/F8S0tL9/MEET-M-Logo-Pattern.png' },
    { cat: 'None', url: '' } // Plain color
  ];

  // --- Auth & Init ---
  onAuthStateChanged(auth, async (user) => {
    if(!user) return window.location.href = 'login.html';
    currentUser = user;
    
    // Ensure User Doc exists
    await setDoc(doc(db, "users", user.uid), {
        uid: user.uid,
        email: user.email,
        name: user.displayName || user.email.split('@')[0],
        avatar: user.photoURL || `https://ui-avatars.com/api/?name=${user.email}&background=0080FF&color=fff`,
        isOnline: true,
        lastSeen: serverTimestamp()
    }, { merge: true });

    loadConversations();
    applySavedWallpaper();
  });

  // --- Mobile View Logic ---
  window.closeChat = () => {
    document.getElementById('chatInterface').classList.remove('active');
    currentChatId = null;
    // Unsubscribe to prevent memory leaks and fluctuation
    if (currentMessageSnapshotUnsubscribe) {
        currentMessageSnapshotUnsubscribe();
        currentMessageUnsubscribe = null;
    }
  };

  // --- Chat Functions ---
  function loadConversations() {
    const list = document.getElementById('conversationsList');
    const q = query(collection(db, "conversations"), where("participants", "array-contains", currentUser.uid));
    
    onSnapshot(q, (snap) => {
      list.innerHTML = '';
      const chats = [];
      snap.forEach(d => chats.push({id: d.id, ...d.data()}));
      // Sort locally
      chats.sort((a, b) => (b.updatedAt?.toMillis() || 0) - (a.updatedAt?.toMillis() || 0));

      chats.forEach(chat => {
        const otherId = chat.participants.find(id => id !== currentUser.uid);
        const name = chat.participantNames?.[otherId] || 'User';
        const avatar = chat.participantAvatars?.[otherId] || 'https://via.placeholder.com/50';
        
        const div = document.createElement('div');
        div.className = 'convo-item';
        div.innerHTML = `
           <img src="${avatar}" class="user-avatar">
           <div class="convo-info">
             <h4>${name}</h4>
             <p>${chat.lastMessage || 'No messages'}</p>
           </div>
        `;
        div.onclick = () => openChat(chat.id, {uid: otherId, name, avatar});
        list.appendChild(div);
      });
    });
  }

  async function openChat(chatId, user) {
    // 1. Unsubscribe from old chat immediately
    if (currentMessageSnapshotUnsubscribe) {
        currentMessageSnapshotUnsubscribe();
    }
    
    currentChatId = chatId;
    
    // 2. Update UI
    document.getElementById('headerName').innerText = user.name;
    document.getElementById('headerAvatar').src = user.avatar;
    document.getElementById('chatHeader').style.display = 'flex';
    document.getElementById('inputPanel').style.display = 'flex';
    document.getElementById('chatInterface').classList.add('active'); // Slide on mobile
    
    const msgArea = document.getElementById('messagesArea');
    msgArea.innerHTML = ''; // Clear old

    // 3. Start New Listener
    const q = query(collection(db, `conversations/${chatId}/messages`), orderBy('timestamp', 'asc'));
    
    currentMessageSnapshotUnsubscribe = onSnapshot(q, (snap) => {
        msgArea.innerHTML = '';
        snap.forEach(d => renderMessage(d.id, d.data()));
        // Scroll to bottom
        setTimeout(() => msgArea.scrollTop = msgArea.scrollHeight, 100);
    });
  }

  function renderMessage(id, msg) {
    const isMe = msg.senderId === currentUser.uid;
    const div = document.createElement('div');
    div.className = `message ${isMe ? 'sent' : 'received'}`;
    
    let content = '';
    if (msg.type === 'image') content = `<img src="${msg.mediaUrl}" class="msg-media" onclick="window.open(this.src)">`;
    if (msg.type === 'video') content = `<video src="${msg.mediaUrl}" class="msg-media" controls></video>`;
    if (msg.text) content += `<span>${msg.text}</span>`;
    
    const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
    const ticks = isMe ? (msg.read ? '<i class="fas fa-check-double" style="color:#00C6FF"></i>' : '<i class="fas fa-check"></i>') : '';

    div.innerHTML = `
      <div class="bubble">
        ${content}
        <div class="msg-time">${time} ${ticks} ${msg.isAi ? 'ðŸ¤–' : ''}</div>
      </div>
    `;
    document.getElementById('messagesArea').appendChild(div);
  }

  // --- Input & Sending ---
  async function sendMessage(text = '', media = null) {
    if (!text && !media) return;
    
    const payload = {
      senderId: currentUser.uid,
      text: text,
      type: media ? media.type : 'text',
      mediaUrl: media ? media.url : null,
      timestamp: serverTimestamp(),
      read: false
    };

    document.getElementById('messageInput').value = '';
    
    try {
      await addDoc(collection(db, `conversations/${currentChatId}/messages`), payload);
      await updateDoc(doc(db, "conversations", currentChatId), {
        lastMessage: media ? `[${media.type}]` : text,
        updatedAt: serverTimestamp()
      });

      // AI Logic
      if (document.getElementById('aiToggle').checked && !media) {
         setTimeout(() => {
            addDoc(collection(db, `conversations/${currentChatId}/messages`), {
               senderId: "AI",
               text: "I am an AI. I received: " + text,
               timestamp: serverTimestamp(),
               isAi: true
            });
         }, 1500);
      }
    } catch(e) { console.error(e); }
  }

  // Event Listeners
  document.getElementById('sendBtn').onclick = () => sendMessage(document.getElementById('messageInput').value);
  document.getElementById('messageInput').addEventListener('keydown', (e) => {
    if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(e.target.value); }
  });

  // Media Upload
  document.getElementById('mediaInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", CLOUDINARY_PRESET);
    
    document.getElementById('messageInput').placeholder = "Uploading...";
    const res = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
    const data = await res.json();
    sendMessage("", { url: data.secure_url, type: data.resource_type });
    document.getElementById('messageInput').placeholder = "Message...";
  });

  // --- Emojis (Point 4) ---
  window.toggleEmoji = () => {
    const el = document.getElementById('emojiContainer');
    el.style.display = el.style.display === 'block' ? 'none' : 'block';
  }
  document.querySelector('emoji-picker').addEventListener('emoji-click', event => {
    document.getElementById('messageInput').value += event.detail.unicode;
  });

  // --- Wallpapers (Point 5) ---
  window.openWallpaperModal = () => {
    const grid = document.getElementById('wpGrid');
    grid.innerHTML = '';
    wallpapers.forEach(wp => {
      const div = document.createElement('div');
      div.className = 'wp-item';
      if(wp.url) div.style.backgroundImage = `url(${wp.url})`;
      else div.style.backgroundColor = '#e5ddd5';
      
      div.innerHTML = `<div class="wp-tag">${wp.cat}</div>`;
      div.onclick = () => {
        const url = wp.url ? `url(${wp.url})` : 'none';
        document.getElementById('messagePanel').style.backgroundImage = url;
        if(!wp.url) document.getElementById('messagePanel').style.backgroundColor = '#e5ddd5';
        localStorage.setItem('meet_wallpaper', url);
        closeWallpaperModal();
      };
      grid.appendChild(div);
    });
    document.getElementById('wpModal').style.display = 'flex';
  }
  window.closeWallpaperModal = () => document.getElementById('wpModal').style.display = 'none';

  function applySavedWallpaper() {
    const saved = localStorage.getItem('meet_wallpaper');
    if(saved) document.getElementById('messagePanel').style.backgroundImage = saved;
  }

  // --- Chat Creation (Simple) ---
  window.openUserSearch = () => document.getElementById('searchModal').style.display = 'flex';
  window.startChat = () => { alert("Search Logic implemented in previous step."); document.getElementById('searchModal').style.display='none'; }
  window.logoutBtn = document.getElementById('logoutBtn');
  window.logoutBtn.addEventListener('click', () => signOut(auth));

</script>
</body>
</html>
