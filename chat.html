<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Professional Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  /* --- PREVIOUS CSS REMAINS THE SAME --- */
  :root {
    --primary: #0080FF;
    --primary-dark: #0066CC;
    --bg-color: #f0f2f5;
    --card-bg: #fff;
    --text-color: #111;
    --secondary-text: #65676b;
    --border-color: #dddfe2;
    --error: #EF4444;
    --success: #10B981;
    --warning: #F59E0B;
    --app-height: 100dvh;
    --chat-font: 'Poppins', sans-serif;
    --sent-bubble-bg: #0080FF;
    --sent-text-color: #fff;
    --received-bubble-bg: #fff;
    --received-text-color: #111;
    --shadow-light: 0 2px 10px rgba(0,0,0,0.05);
    --shadow-medium: 0 4px 15px rgba(0,128,255,0.2);
  }

  body.dark-mode {
    --bg-color: #0f0f10;
    --card-bg: #1e1e1e;
    --text-color: #e4e6eb;
    --secondary-text: #b0b3b8;
    --border-color: #2f3031;
    --received-bubble-bg: #2a2b2c;
    --received-text-color: #e4e6eb;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; overflow: hidden; font-size: 14px; font-family: var(--chat-font); background: var(--bg-color); color: var(--text-color); transition: all 0.3s ease; }
  
  /* ... [Keeping your existing layout styles] ... */
  .app-container { display: flex; height: var(--app-height); position: relative; overflow: hidden; }
  .sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 280px; background: linear-gradient(180deg, #0080FF 0%, #00C6FF 100%); z-index: 200; padding: 25px; color: white; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 4px 0 20px rgba(0,0,0,0.15); backdrop-filter: blur(10px); }
  .sidebar.open { transform: translateX(0); }
  .sidebar-header { padding-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.2); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
  .sidebar-menu { list-style: none; }
  .sidebar-menu li { margin-bottom: 12px; }
  .sidebar-menu a { display: flex; align-items: center; padding: 16px 12px; text-decoration: none; color: white; border-radius: 12px; font-size: 16px; font-weight: 500; transition: all 0.3s ease; position: relative; overflow: hidden; }
  .sidebar-menu a:hover { transform: translateX(8px); background: rgba(255, 255, 255, 0.2); }
  .sidebar-menu a.active { background: rgba(255, 255, 255, 0.25); font-weight: 600; }
  .sidebar-menu i { margin-right: 15px; font-size: 20px; width: 28px; text-align: center; }
  .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 190; backdrop-filter: blur(4px); }
  .sidebar-overlay.active { display: block; }
  .main-content { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; padding: 12px; width: 100%; }
  .navbar { background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%); padding: 15px 20px; border-radius: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; color: white; flex-shrink: 0; box-shadow: var(--shadow-medium); position: relative; overflow: hidden; }
  .navbar-left { display: flex; align-items: center; gap: 20px; }
  .navbar-right { display: flex; align-items: center; gap: 12px; }
  .hamburger-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
  .nav-user-img { width: 45px; height: 45px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.9); object-fit: cover; }
  .nav-user-name { font-weight: 600; font-size: 16px; margin-left: 8px; }
  .btn { background: rgba(255, 255, 255, 0.2); color: white; border: none; padding: 10px 14px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 8px; backdrop-filter: blur(10px); }
  
  .chat-container { flex: 1; background: var(--card-bg); border-radius: 16px; overflow: hidden; display: flex; min-height: 0; position: relative; box-shadow: var(--shadow-light); border: 1px solid var(--border-color); }
  .conversations-sidebar { width: 340px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; height: 100%; background: var(--card-bg); }
  .chat-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, var(--card-bg) 0%, var(--bg-color) 100%); }
  .new-chat-btn { background: linear-gradient(135deg, #0080FF 0%, #0066CC 100%); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; }
  .chat-search { padding: 15px; border-bottom: 1px solid var(--border-color); background: var(--bg-color); }
  .chat-search input { width: 100%; padding: 12px 20px; border-radius: 25px; border: 2px solid var(--border-color); background: var(--card-bg); color: var(--text-color); outline: none; }
  .conversations-list { flex: 1; overflow-y: auto; scroll-behavior: smooth; }
  .conversation-item { display: flex; align-items: center; gap: 15px; padding: 16px 20px; cursor: pointer; border-bottom: 1px solid var(--border-color); position: relative; overflow: hidden; }
  .conversation-item.active { background: rgba(0,128,255,0.08); }
  .conversation-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color); }
  .conversation-info { flex: 1; min-width: 0; }
  .conversation-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; color: var(--text-color); }
  .conversation-preview { font-size: 13px; color: var(--secondary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  
  .chat-area { flex: 1; display: flex; flex-direction: column; height: 100%; background: var(--bg-color); position: relative; }
  .chat-area-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 15px; background: var(--card-bg); z-index: 10; backdrop-filter: blur(10px); }
  .chat-user-info { flex: 1; margin-left: 10px; }
  .chat-user-name { font-weight: 700; font-size: 18px; color: var(--text-color); }
  .chat-user-status { font-size: 12px; color: var(--secondary-text); }
  .chat-actions { display: flex; gap: 8px; margin-left: auto; }
  .chat-action-btn { background: none; border: none; color: var(--secondary-text); font-size: 18px; cursor: pointer; padding: 10px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
  .chat-action-btn:hover { background: rgba(0,128,255,0.1); color: var(--primary); }
  
  .messages-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
  .message-wrapper { display: flex; gap: 10px; max-width: 85%; align-items: flex-end; position: relative; margin-bottom: 12px; }
  .message-wrapper.sent { align-self: flex-end; flex-direction: row-reverse; }
  .message-bubble { padding: 12px 18px; border-radius: 20px; position: relative; word-wrap: break-word; font-size: 15px; line-height: 1.5; max-width: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .received .message-bubble { background: var(--received-bubble-bg); border-bottom-left-radius: 6px; color: var(--received-text-color); border: 1px solid var(--border-color); }
  .sent .message-bubble { background: var(--sent-bubble-bg); color: var(--sent-text-color); border-bottom-right-radius: 6px; }
  .message-time { font-size: 11px; opacity: 0.7; margin-top: 6px; text-align: right; display: block; }
  
  .message-input-container { padding: 18px 20px; border-top: 1px solid var(--border-color); background: var(--card-bg); position: relative; }
  .message-input-wrapper { display: flex; align-items: flex-end; gap: 12px; }
  .message-input-actions { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
  .input-action { background: transparent; border: none; color: var(--secondary-text); cursor: pointer; font-size: 20px; padding: 10px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
  .input-action:hover { color: var(--primary); background: rgba(0,128,255,0.1); }
  .message-input { flex: 1; padding: 14px 20px; border-radius: 25px; border: 2px solid var(--border-color); background: var(--bg-color); color: var(--text-color); resize: none; font-family: inherit; font-size: 15px; max-height: 120px; min-height: 50px; outline: none; }
  .send-button { background: linear-gradient(135deg, #0080FF 0%, #0066CC 100%); color: white; border: 0; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.2s ease; }
  
  /* --- NEW STYLES FOR WEBRTC AND VOICE NOTES --- */
  
  /* Voice Record Button Pulse */
  .voice-btn-recording {
    color: var(--error) !important;
    background: rgba(239, 68, 68, 0.1) !important;
    animation: pulse 1.5s infinite;
  }
  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
    70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
    100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
  }

  /* Audio Message Player Styling */
  .audio-player-container {
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 200px;
  }
  .audio-control-btn {
    background: rgba(255,255,255,0.3);
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    color: inherit;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Call Modal (Overlay) */
  .call-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    z-index: 3000;
    flex-direction: column;
  }

  .video-container {
    flex: 1;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }

  #remoteVideo {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  #localVideo {
    position: absolute;
    bottom: 120px;
    right: 20px;
    width: 120px;
    height: 160px;
    object-fit: cover;
    border-radius: 12px;
    border: 2px solid white;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    background: #333;
    z-index: 3002;
    transition: all 0.3s ease;
  }

  /* Shy Mode (Text on Video) */
  .shy-mode-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80%;
    text-align: center;
    z-index: 3005;
    pointer-events: none;
  }

  .shy-msg-toast {
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 15px 25px;
    border-radius: 30px;
    font-size: 18px;
    font-weight: 500;
    margin-top: 10px;
    backdrop-filter: blur(5px);
    animation: slideUpFade 0.4s ease forwards;
    display: inline-block;
    max-width: 100%;
    word-wrap: break-word;
    border: 1px solid rgba(255,255,255,0.2);
  }

  @keyframes slideUpFade {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Call Controls */
  .call-controls {
    height: 100px;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    padding-bottom: 20px;
    position: relative;
    z-index: 3010;
  }

  .call-btn {
    width: 55px;
    height: 55px;
    border-radius: 50%;
    border: none;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    color: white;
  }

  .btn-mute { background: rgba(255,255,255,0.2); }
  .btn-mute.active { background: white; color: #111; }
  .btn-camera { background: rgba(255,255,255,0.2); }
  .btn-camera.off { background: var(--error); position: relative; }
  .btn-camera.off::after { content: '/'; position: absolute; font-size: 28px; font-weight: bold; }
  .btn-end { background: var(--error); width: 65px; height: 65px; font-size: 24px; }
  .btn-chat-toggle { background: var(--primary); }

  /* Incoming Call Popup */
  .incoming-call-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 4000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(8px);
    animation: fadeIn 0.3s ease;
  }

  .incoming-card {
    background: var(--card-bg);
    padding: 40px;
    border-radius: 24px;
    text-align: center;
    width: 90%;
    max-width: 350px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .caller-avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: 4px solid var(--primary);
    margin-bottom: 20px;
    animation: ripple 1.5s infinite;
  }

  @keyframes ripple {
    0% { box-shadow: 0 0 0 0 rgba(0, 128, 255, 0.4); }
    70% { box-shadow: 0 0 0 20px rgba(0, 128, 255, 0); }
    100% { box-shadow: 0 0 0 0 rgba(0, 128, 255, 0); }
  }

  .incoming-actions {
    display: flex;
    gap: 30px;
    margin-top: 30px;
  }

  .action-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    font-size: 24px;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
  }
  .action-btn:hover { transform: scale(1.1); }
  .btn-accept { background: var(--success); animation: bounce 1s infinite; }
  .btn-reject { background: var(--error); }

  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }
  
  /* Additional Styles from previous file (omitted for brevity but assumed present) */
  .typing-indicator { display: none; padding: 12px 18px; background: var(--card-bg); border-radius: 20px; margin: 15px; width: fit-content; align-self: flex-start; font-size: 13px; color: var(--secondary-text); font-style: italic; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid var(--border-color); }
  .empty-chat { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--secondary-text); text-align: center; padding: 40px; }
  .user-search-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: none; justify-content: center; align-items: flex-start; padding-top: 100px; backdrop-filter: blur(8px); }
  .user-search-modal { background: var(--card-bg); border-radius: 20px; padding: 0; width: 90%; max-width: 550px; box-shadow: 0 15px 60px rgba(0,0,0,0.3); overflow: hidden; border: 1px solid var(--border-color); }
  .settings-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 2100; align-items: center; justify-content: center; }
  .settings-content { background: var(--card-bg); width: 95%; max-width: 550px; padding: 35px; border-radius: 24px; }

  /* Mobile Responsive adjustments */
  @media (max-width: 768px) {
    .chat-container { border-radius: 0; height: 100%; margin: 0; }
    .conversations-sidebar { width: 100%; position: absolute; z-index: 50; }
    .chat-area { width: 100%; position: absolute; z-index: 60; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .chat-area.active { transform: translateX(0); }
    #localVideo { width: 90px; height: 120px; bottom: 110px; right: 10px; }
  }
</style>
</head>
<body>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
<div class="app-container">
  <div class="sidebar" id="mainSidebar">
    <div class="sidebar-header">
      <h2>MEET</h2>
      <button onclick="toggleSidebar()" style="background:none; border:none; color:white; font-size:24px; padding:8px;"><i class="fas fa-times"></i></button>
    </div>
    <ul class="sidebar-menu">
      <li><a href="feed.html"><i class="fas fa-home"></i> <span>Feed</span></a></li>
      <li><a href="profile.html"><i class="fas fa-user"></i> <span>Profile</span></a></li>
      <li><a href="chat.html" class="active"><i class="fas fa-comment"></i> <span>Chat</span></a></li>
      <li><a href="conference.html"><i class="fas fa-video"></i> <span>Conference</span></a></li>
      <li><a href="meetrader.html"><i class="fas fa-store"></i> <span>Meetrader</span></a></li>
    </ul>
  </div>

  <div class="main-content">
    <div class="navbar">
      <div class="navbar-left">
        <button class="hamburger-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <h2 style="font-weight:600; font-size:22px;">Chat</h2>
      </div>
      <div class="navbar-right">
        <img src="https://via.placeholder.com/40" id="navUserImg" class="nav-user-img" alt="Me">
        <span id="navUserName" class="nav-user-name"></span>
        <button class="btn" id="nightToggleBtn"><i class="fas fa-moon"></i></button>
        <button class="btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </div>

    <div class="chat-container">
      <div class="conversations-sidebar" id="conversationsSidebar">
        <div class="chat-header">
          <h3>Messages</h3>
          <button class="new-chat-btn" onclick="openUserSearchOverlay()"><i class="fas fa-plus"></i></button>
        </div>
        <div class="chat-search">
          <input type="text" placeholder="Search chats..." id="chatSearch">
        </div>
        <div class="conversations-list" id="conversationsList">
          </div>
      </div>

      <div class="chat-area" id="chatArea">
        <div id="emptyChat" class="empty-chat">
          <i class="far fa-comments" style="font-size:80px; opacity:0.3; margin-bottom:25px; color:var(--primary);"></i>
          <h3>Select a conversation</h3>
          <p>Choose a contact to start chatting and stay connected with your network</p>
        </div>

        <div class="chat-area-header" id="chatHeader" style="display: none;">
          <button class="chat-action-btn" id="backButton" style="color:var(--text-color); margin-right:5px;"><i class="fas fa-arrow-left"></i></button>
          <img src="" id="currentChatAvatar" class="conversation-avatar">
          <div class="chat-user-info">
            <div class="chat-user-name" id="chatUserName">User</div>
            <div class="chat-user-status">Last seen recently</div>
          </div>
          <div class="chat-actions">
            <button class="chat-action-btn" onclick="startCall(false)" title="Voice Call"><i class="fas fa-phone-alt"></i></button>
            <button class="chat-action-btn" onclick="startCall(true)" title="Video Call"><i class="fas fa-video"></i></button>
            <button class="chat-action-btn" onclick="openSettingsModal()" title="Settings"><i class="fas fa-sliders-h"></i></button>
          </div>
        </div>

        <div class="messages-container" id="messagesContainer" style="display: none;"></div>

        <div class="typing-indicator" id="typingIndicator">
          <span id="typingUserName">User</span> is typing...
        </div>

        <div class="message-input-container" id="messageInputContainer" style="display: none;">
          <div class="reply-preview-bar" id="replyPreview" style="display:none; background:rgba(0,128,255,0.08); padding:12px; border-left:4px solid var(--primary); margin-bottom:10px; border-radius:8px;">
            <div class="reply-preview-content">
              <span class="reply-name" id="replyName" style="font-weight:700; color:var(--primary);">Replying to User</span>
              <span class="reply-text" id="replyText" style="display:block; color:var(--secondary-text);">Message text...</span>
            </div>
            <button onclick="cancelReply()" style="border:none; background:none; font-size:20px; float:right;">&times;</button>
          </div>

          <div class="message-input-wrapper">
            <div class="message-input-actions">
               <button class="input-action" id="voiceNoteBtn" onclick="toggleVoiceRecording()" title="Record Audio">
                <i class="fas fa-microphone"></i>
              </button>
              
              <button class="input-action" onclick="toggleEmojiPicker()" title="Emoji"><i class="far fa-smile"></i></button>
              <input type="file" id="imageInputHidden" accept="image/*" style="display:none" onchange="uploadToCloudinary(this.files[0], 'image')">
              <input type="file" id="videoInputHidden" accept="video/*" style="display:none" onchange="uploadToCloudinary(this.files[0], 'video')">
              <button class="input-action" onclick="document.getElementById('imageInputHidden').click()"><i class="fas fa-image"></i></button>
              <button class="input-action" onclick="document.getElementById('videoInputHidden').click()"><i class="fas fa-video"></i></button>
            </div>
            <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
            <button class="send-button" id="sendButton"><i class="fas fa-paper-plane"></i></button>
          </div>
          
          <div class="emoji-picker" id="emojiPicker" style="display:none; position:absolute; bottom:80px; left:20px; background:var(--card-bg); border:1px solid var(--border-color); border-radius:12px; height:300px; width:300px; z-index:100; overflow-y:auto; padding:10px;">
             </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="incoming-call-modal" id="incomingCallModal">
  <div class="incoming-card">
    <div class="caller-avatar" style="background: #eee; overflow:hidden;">
        <img id="incomingCallerImg" src="" style="width:100%; height:100%; object-fit:cover;">
    </div>
    <h3 id="incomingCallerName" style="margin-bottom:5px;">User Name</h3>
    <p id="incomingCallType" style="color:var(--secondary-text);">Incoming Video Call...</p>
    <div class="incoming-actions">
      <button class="action-btn btn-reject" onclick="rejectIncomingCall()"><i class="fas fa-phone-slash"></i></button>
      <button class="action-btn btn-accept" onclick="acceptIncomingCall()"><i class="fas fa-phone"></i></button>
    </div>
  </div>
</div>

<div class="call-modal" id="callModal">
  <div class="video-container">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay playsinline muted></video>
    
    <div class="shy-mode-overlay" id="shyModeContainer">
      </div>
  </div>
  
  <div class="call-controls">
    <button class="call-btn btn-mute" id="muteBtn" onclick="toggleMute()"><i class="fas fa-microphone"></i></button>
    <button class="call-btn btn-end" onclick="hangUpCall()"><i class="fas fa-phone-slash"></i></button>
    <button class="call-btn btn-camera" id="cameraBtn" onclick="toggleCamera()"><i class="fas fa-video"></i></button>
    <button class="call-btn btn-chat-toggle" onclick="toggleShyChatInput()"><i class="fas fa-comment-dots"></i></button>
  </div>
</div>

<div class="user-search-overlay" id="userSearchOverlay">
  <div class="user-search-modal">
    <div style="padding:20px; border-bottom:1px solid var(--border-color);">
      <h3>Start Conversation</h3>
      <input type="text" id="userSearchInput" placeholder="Search name or email..." style="width:100%; padding:10px; margin-top:10px; border-radius:8px; border:1px solid var(--border-color);">
    </div>
    <div id="userSearchResults" style="max-height:300px; overflow-y:auto;"></div>
    <button onclick="closeUserSearchOverlay()" style="width:100%; padding:15px; border:none; background:transparent; color:var(--error); cursor:pointer;">Close</button>
  </div>
</div>

<div class="settings-modal" id="settingsModal">
  <div class="settings-content">
      <h3>Settings</h3>
      <p>Customization options coming soon.</p>
      <button onclick="closeSettingsModal()" style="margin-top:20px;">Close</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getFirestore, collection, addDoc, updateDoc, doc, getDoc, getDocs, onSnapshot, serverTimestamp, query, orderBy, where, setDoc, limit, deleteDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
    authDomain: "meet-6e159.firebaseapp.com",
    projectId: "meet-6e159",
    storageBucket: "meet-6e159.firebasestorage.app",
    messagingSenderId: "252353608421",
    appId: "1:252353608421:web:6706056048e9a8f12db20c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // --- STATE ---
  let currentUser = null;
  let currentChatId = null;
  let currentChatUser = null; 
  let currentChatUserName = '';
  let currentChatUserAvatar = '';
  let unsubscribeMessages = null;
  
  // Audio Recording State
  let mediaRecorder = null;
  let audioChunks = [];
  let isRecording = false;

  // WebRTC State
  const servers = {
    iceServers: [
      { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }
    ]
  };
  let peerConnection = null;
  let localStream = null;
  let remoteStream = null;
  let incomingCallDocId = null; // To track the Firestore doc ID of an incoming call
  let callUnsubscribe = null; // Listener for call signaling
  let isVideoCall = true; // Toggle for video vs audio only

  // DOM Elements
  const messagesContainer = document.getElementById('messagesContainer');
  const messageInput = document.getElementById('messageInput');
  const navUserImg = document.getElementById('navUserImg');
  const navUserName = document.getElementById('navUserName');
  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');

  // --- AUTH & INIT ---
  onAuthStateChanged(auth, async user => {
    if (!user) {
      window.location.href = 'login.html';
    } else {
      currentUser = user;
      
      // Load User Profile Data
      try {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        const userData = userDoc.exists() ? userDoc.data() : {};
        const photoURL = userData.photoURL || user.photoURL || `https://ui-avatars.com/api/?name=User&background=0080FF&color=fff`;
        const displayName = userData.name || user.displayName || 'User';
        
        navUserImg.src = photoURL;
        navUserName.textContent = displayName;
      } catch (e) {
        console.error("Profile load error", e);
      }
      
      loadConversations();
      listenForIncomingCalls(); // Start listening for calls globally
    }
  });

  document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
  document.getElementById('nightToggleBtn').addEventListener('click', () => document.body.classList.toggle('dark-mode'));

  // --- CHAT FUNCTIONS ---

  function loadConversations() {
    const q = query(
      collection(db, "conversations"), 
      where("participants", "array-contains", currentUser.uid)
    );
    
    onSnapshot(q, (snapshot) => {
      const list = document.getElementById('conversationsList');
      list.innerHTML = '';
      snapshot.forEach(doc => {
        const data = doc.data();
        const otherId = data.participants.find(p => p !== currentUser.uid);
        const name = data.participantNames?.[otherId] || 'User';
        const avatar = data.participantAvatars?.[otherId] || `https://ui-avatars.com/api/?name=${name}`;
        
        const div = document.createElement('div');
        div.className = `conversation-item ${currentChatId === doc.id ? 'active' : ''}`;
        div.innerHTML = `
          <img src="${avatar}" class="conversation-avatar">
          <div class="conversation-info">
            <div class="conversation-name">${name}</div>
            <div class="conversation-preview">${data.lastMessage || 'No messages'}</div>
          </div>
        `;
        div.onclick = () => openChat(doc.id, otherId, name, avatar);
        list.appendChild(div);
      });
    });
  }

  window.openChat = async (chatId, otherId, name, avatar) => {
    currentChatId = chatId;
    currentChatUser = otherId;
    currentChatUserName = name;
    currentChatUserAvatar = avatar;

    document.getElementById('emptyChat').style.display = 'none';
    document.getElementById('chatHeader').style.display = 'flex';
    document.getElementById('messagesContainer').style.display = 'flex';
    document.getElementById('messageInputContainer').style.display = 'block';
    
    document.getElementById('chatUserName').textContent = name;
    document.getElementById('currentChatAvatar').src = avatar;
    
    // Mobile View Logic
    if(window.innerWidth <= 768) {
        document.getElementById('chatArea').classList.add('active');
    }

    loadMessages(chatId);
  }

  function loadMessages(chatId) {
    if (unsubscribeMessages) unsubscribeMessages();
    
    const q = query(collection(db, "conversations", chatId, "messages"), orderBy("timestamp", "asc"));
    
    unsubscribeMessages = onSnapshot(q, (snapshot) => {
      messagesContainer.innerHTML = '';
      snapshot.forEach(doc => {
        const msg = doc.data();
        renderMessage(msg, doc.id);
        
        // SHY MODE LOGIC: If a message arrives while we are in a call, show it on video
        // Only show message if the modal is open AND it's from the other person
        const callModal = document.getElementById('callModal');
        if (callModal.style.display === 'flex' && msg.senderId !== currentUser.uid) {
           // Basic check to avoid showing old messages on load (timestamp check ideally)
           // For simplicity, we assume new snapshots are new messages if added at end
           if (doc.metadata.hasPendingWrites === false) { // not local optimistic write
               showShyModeToast(msg);
           }
        }
      });
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });
  }

  function renderMessage(msg, id) {
    const isMe = msg.senderId === currentUser.uid;
    const div = document.createElement('div');
    div.className = `message-wrapper ${isMe ? 'sent' : 'received'}`;
    
    let content = '';
    
    if (msg.mediaType === 'audio') {
        content = `
          <div class="audio-player-container">
            <button class="audio-control-btn" onclick="document.getElementById('audio-${id}').play()"><i class="fas fa-play"></i></button>
            <audio id="audio-${id}" src="${msg.mediaUrl}"></audio>
            <span>Voice Message</span>
          </div>
        `;
    } else if (msg.mediaType === 'image') {
        content = `<img src="${msg.mediaUrl}" style="max-width:100%; border-radius:12px;">`;
    } else if (msg.mediaType === 'video') {
        content = `<video src="${msg.mediaUrl}" controls style="max-width:100%; border-radius:12px;"></video>`;
    } else {
        content = msg.text;
    }

    div.innerHTML = `
      <div class="message-bubble">
        ${content}
        <div class="message-time">${msg.timestamp ? new Date(msg.timestamp.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...'}</div>
      </div>
    `;
    messagesContainer.appendChild(div);
  }

  // --- SEND MESSAGES & UPLOAD ---

  document.getElementById('sendButton').addEventListener('click', sendMessage);
  
  async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text && !audioChunks.length) return;
    
    messageInput.value = '';
    
    await addDoc(collection(db, "conversations", currentChatId, "messages"), {
      text: text,
      senderId: currentUser.uid,
      timestamp: serverTimestamp(),
      mediaType: 'text'
    });
    
    updateDoc(doc(db, "conversations", currentChatId), {
      lastMessage: text,
      updatedAt: serverTimestamp()
    });
  }

  // Generic Cloudinary Upload
  window.uploadToCloudinary = async (file, type) => {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', 'Meet_video'); // Ensure this preset exists in your Cloudinary
    // Audio is often treated as 'video' resource_type in Cloudinary if not 'raw'
    formData.append('resource_type', type === 'image' ? 'image' : 'video'); 

    try {
      const res = await fetch('https://api.cloudinary.com/v1_1/dcwof2ngn/upload', {
         method: 'POST', body: formData 
      });
      const data = await res.json();
      
      await addDoc(collection(db, "conversations", currentChatId, "messages"), {
        mediaUrl: data.secure_url,
        mediaType: type,
        senderId: currentUser.uid,
        timestamp: serverTimestamp(),
        text: type === 'audio' ? 'Voice Message' : ''
      });
      
      updateDoc(doc(db, "conversations", currentChatId), {
          lastMessage: type === 'audio' ? 'ðŸŽ¤ Voice Message' : (type === 'image' ? 'ðŸ“· Image' : 'ðŸŽ¥ Video'),
          updatedAt: serverTimestamp()
      });
    } catch(err) {
      console.error("Upload failed", err);
      alert("Upload failed");
    }
  }

  // --- VOICE NOTES ---

  window.toggleVoiceRecording = async () => {
    const btn = document.getElementById('voiceNoteBtn');
    
    if (!isRecording) {
      // Start Recording
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        
        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          uploadToCloudinary(audioBlob, 'audio'); // Reuse upload function
          
          // Stop all tracks
          stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        isRecording = true;
        btn.classList.add('voice-btn-recording');
      } catch (err) {
        console.error("Mic access denied", err);
        alert("Microphone access needed for voice notes.");
      }
    } else {
      // Stop Recording
      mediaRecorder.stop();
      isRecording = false;
      btn.classList.remove('voice-btn-recording');
    }
  }

  // --- WEBRTC VIDEO/VOICE CALLING ---

  // 1. Start a Call (Make Offer)
  window.startCall = async (videoEnabled) => {
    if (!currentChatId) return;
    isVideoCall = videoEnabled;
    
    // Init UI
    document.getElementById('callModal').style.display = 'flex';
    document.getElementById('cameraBtn').style.display = isVideoCall ? 'flex' : 'none';
    
    await initLocalStream(isVideoCall);
    
    // Create Peer Connection
    peerConnection = new RTCPeerConnection(servers);
    
    // Add local tracks
    localStream.getTracks().forEach(track => {
      peerConnection.addTrack(track, localStream);
    });

    // Handle remote tracks
    peerConnection.ontrack = (event) => {
      event.streams[0].getTracks().forEach(track => {
        remoteStream.addTrack(track);
      });
    };

    remoteStream = new MediaStream();
    remoteVideo.srcObject = remoteStream;

    // Handle ICE Candidates
    peerConnection.onicecandidate = (event) => {
      if (event.candidate) {
        addDoc(collection(db, "calls", currentChatId, "candidates"), event.candidate.toJSON());
      }
    };

    // Create Offer
    const offerDescription = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offerDescription);

    const callDoc = {
      offer: { type: offerDescription.type, sdp: offerDescription.sdp },
      callerId: currentUser.uid,
      receiverId: currentChatUser,
      type: isVideoCall ? 'video' : 'audio',
      timestamp: serverTimestamp()
    };

    // Save Offer to Firestore (This ID is the Chat ID)
    await setDoc(doc(db, "calls", currentChatId), callDoc);

    // Listen for Answer
    onSnapshot(doc(db, "calls", currentChatId), (snapshot) => {
      const data = snapshot.data();
      if (peerConnection && !peerConnection.currentRemoteDescription && data && data.answer) {
        const answerDescription = new RTCSessionDescription(data.answer);
        peerConnection.setRemoteDescription(answerDescription);
      }
    });

    // Listen for Remote Candidates
    onSnapshot(collection(db, "calls", currentChatId, "receiverCandidates"), (snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === 'added') {
          const candidate = new RTCIceCandidate(change.doc.data());
          peerConnection.addIceCandidate(candidate);
        }
      });
    });
  }

  // 2. Listen for Incoming Calls (Global)
  function listenForIncomingCalls() {
    // Listen to "calls" collection where receiverId is me
    const q = query(collection(db, "calls"), where("receiverId", "==", currentUser.uid));
    
    onSnapshot(q, async (snapshot) => {
        snapshot.docChanges().forEach(async (change) => {
            if (change.type === 'added') {
                const callData = change.doc.data();
                incomingCallDocId = change.doc.id;
                
                // Fetch caller name
                const callerDoc = await getDoc(doc(db, "users", callData.callerId));
                const callerName = callerDoc.exists() ? callerDoc.data().name : "Unknown";
                const callerImg = callerDoc.exists() ? callerDoc.data().photoURL : "https://via.placeholder.com/100";

                // Show Popup
                document.getElementById('incomingCallerName').innerText = callerName;
                document.getElementById('incomingCallerImg').src = callerImg;
                document.getElementById('incomingCallType').innerText = `Incoming ${callData.type} call...`;
                document.getElementById('incomingCallModal').style.display = 'flex';
                
                // Set context for answering
                currentChatId = incomingCallDocId; 
                isVideoCall = callData.type === 'video';
            }
            if (change.type === 'removed') {
                // Call ended or cancelled before pickup
                document.getElementById('incomingCallModal').style.display = 'none';
                hangUpCall();
            }
        });
    });
  }

  // 3. Answer Call
  window.acceptIncomingCall = async () => {
    document.getElementById('incomingCallModal').style.display = 'none';
    document.getElementById('callModal').style.display = 'flex';
    document.getElementById('cameraBtn').style.display = isVideoCall ? 'flex' : 'none';

    await initLocalStream(isVideoCall);
    
    peerConnection = new RTCPeerConnection(servers);
    
    // Add local tracks
    localStream.getTracks().forEach(track => {
      peerConnection.addTrack(track, localStream);
    });

    // Handle remote stream
    peerConnection.ontrack = (event) => {
      event.streams[0].getTracks().forEach(track => {
        remoteStream.addTrack(track);
      });
    };
    remoteStream = new MediaStream();
    remoteVideo.srcObject = remoteStream;

    // Send Candidates
    peerConnection.onicecandidate = (event) => {
      if (event.candidate) {
        addDoc(collection(db, "calls", currentChatId, "receiverCandidates"), event.candidate.toJSON());
      }
    };

    // Get Offer
    const callDoc = await getDoc(doc(db, "calls", currentChatId));
    const callData = callDoc.data();
    
    const offerDescription = callData.offer;
    await peerConnection.setRemoteDescription(new RTCSessionDescription(offerDescription));

    // Create Answer
    const answerDescription = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answerDescription);

    const answer = {
      type: answerDescription.type,
      sdp: answerDescription.sdp,
    };

    await updateDoc(doc(db, "calls", currentChatId), { answer });

    // Listen for Caller Candidates
    onSnapshot(collection(db, "calls", currentChatId, "candidates"), (snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === 'added') {
          const candidate = new RTCIceCandidate(change.doc.data());
          peerConnection.addIceCandidate(candidate);
        }
      });
    });
  }

  window.rejectIncomingCall = async () => {
     document.getElementById('incomingCallModal').style.display = 'none';
     // Just delete the call doc to signal rejection
     if(incomingCallDocId) {
         await deleteDoc(doc(db, "calls", incomingCallDocId));
     }
  }

  // 4. Hang Up
  window.hangUpCall = async () => {
    // Close Local Stream
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
    }
    
    // Close Peer Connection
    if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
    }

    // Close UI
    document.getElementById('callModal').style.display = 'none';
    remoteVideo.srcObject = null;
    localVideo.srcObject = null;

    // Cleanup Firestore
    if (currentChatId) {
        // Delete the main call doc. 
        // Note: In production, you might want to move this to a 'history' collection instead of deleting
        // But for signaling reset, deleting is standard.
        // We wrap in try catch because the other person might have already deleted it
        try {
            await deleteDoc(doc(db, "calls", currentChatId));
        } catch(e) { console.log("Call doc already gone"); }
    }
  }

  // Helpers
  async function initLocalStream(video) {
    try {
        localStream = await navigator.mediaDevices.getUserMedia({ 
            video: video, 
            audio: true 
        });
        localVideo.srcObject = localStream;
    } catch (e) {
        console.error("Error getting user media", e);
        alert("Permission denied for Camera/Microphone");
    }
  }

  window.toggleMute = () => {
     const audioTrack = localStream.getAudioTracks()[0];
     if(audioTrack) {
         audioTrack.enabled = !audioTrack.enabled;
         document.getElementById('muteBtn').classList.toggle('active');
     }
  }

  window.toggleCamera = () => {
     const videoTrack = localStream.getVideoTracks()[0];
     if(videoTrack) {
         videoTrack.enabled = !videoTrack.enabled;
         document.getElementById('cameraBtn').classList.toggle('off');
     }
  }
  
  // --- SHY MODE (TEXT ON VIDEO) ---
  
  function showShyModeToast(msg) {
    if (!msg.text || msg.mediaType !== 'text') return;
    
    const container = document.getElementById('shyModeContainer');
    const toast = document.createElement('div');
    toast.className = 'shy-msg-toast';
    toast.textContent = msg.text;
    
    container.appendChild(toast);
    
    // Remove after 5 seconds
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 500);
    }, 5000);
  }

  // Allows user to type without leaving the video screen
  // For now, this just focuses the background input, but in a real app
  // you might want a floating input on the video modal.
  window.toggleShyChatInput = () => {
     // Minimized input for overlay could be added here
     // For this version, we assume the user might switch tabs or minimize the call window slightly
     // OR we create a prompt:
     const text = prompt("Type a message to display on screen:");
     if(text) {
         // Send as normal message, which triggers the Shy Mode display
         messageInput.value = text;
         sendMessage();
     }
  }
  
  // --- UI TOGGLES (Previous Logic) ---
  window.toggleSidebar = () => {
    document.getElementById('mainSidebar').classList.toggle('open');
    document.getElementById('sidebarOverlay').classList.toggle('active');
  }
  window.closeUserSearchOverlay = () => document.getElementById('userSearchOverlay').style.display = 'none';
  window.openUserSearchOverlay = () => document.getElementById('userSearchOverlay').style.display = 'flex';
  document.getElementById('backButton').addEventListener('click', () => {
      document.getElementById('chatArea').classList.remove('active');
  });

  // User Search Logic (Simplified from previous)
  document.getElementById('userSearchInput').addEventListener('input', async (e) => {
      const val = e.target.value.toLowerCase();
      if(val.length < 3) return;
      
      const q = query(collection(db, "users"), where("email", ">=", val), limit(5));
      const snap = await getDocs(q);
      const resDiv = document.getElementById('userSearchResults');
      resDiv.innerHTML = '';
      
      snap.forEach(doc => {
          if(doc.id === currentUser.uid) return;
          const u = doc.data();
          const d = document.createElement('div');
          d.style.padding = '10px';
          d.style.borderBottom = '1px solid #eee';
          d.style.cursor = 'pointer';
          d.innerHTML = `<b>${u.name}</b><br><small>${u.email}</small>`;
          d.onclick = () => startNewChat(doc.id, u);
          resDiv.appendChild(d);
      });
  });

  async function startNewChat(otherId, otherUser) {
     const chatId = [currentUser.uid, otherId].sort().join("_");
     await setDoc(doc(db, "conversations", chatId), {
         participants: [currentUser.uid, otherId],
         participantNames: { [currentUser.uid]: currentUser.displayName || 'Me', [otherId]: otherUser.name },
         updatedAt: serverTimestamp()
     }, { merge: true });
     
     closeUserSearchOverlay();
     openChat(chatId, otherId, otherUser.name, otherUser.photoURL || '');
  }
  
  // --- SETTINGS MODAL ---
  window.openSettingsModal = () => document.getElementById('settingsModal').style.display = 'flex';
  window.closeSettingsModal = () => document.getElementById('settingsModal').style.display = 'none';
  
  // --- EMOJI PICKER (Simple) ---
  window.toggleEmojiPicker = () => {
      const picker = document.getElementById('emojiPicker');
      picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
      if(picker.innerHTML === '') {
          const emojis = ['ðŸ˜€','ðŸ˜‚','ðŸ¥°','ðŸ˜Ž','ðŸ˜­','ðŸ‘','ðŸ‘Ž','ðŸŽ‰','ðŸ”¥','â¤ï¸'];
          emojis.forEach(e => {
              const s = document.createElement('span');
              s.innerText = e;
              s.style.fontSize = '24px';
              s.style.cursor = 'pointer';
              s.style.margin = '5px';
              s.onclick = () => { messageInput.value += e; };
              picker.appendChild(s);
          });
      }
  }

</script>
</body>
</html>
