<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Chat Professional</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  /* All existing CSS remains the same, just adding new styles for delete functionality */
  
  /* Delete conversation button styles */
  .conversation-actions {
    display: none;
    position: absolute;
    right: 10px;
    gap: 5px;
  }
  
  .conversation-item {
    position: relative;
  }
  
  .conversation-item:hover .conversation-actions {
    display: flex;
  }
  
  .delete-conversation-btn {
    background: var(--error);
    color: white;
    border: none;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    transition: transform 0.2s;
  }
  
  .delete-conversation-btn:hover {
    transform: scale(1.1);
  }
</style>
</head>
<body>
<!-- All existing HTML remains the same -->

<script type="module">
  // All existing imports and firebase config remain the same
  
  // Add this function to handle conversation deletion
  async function deleteConversation(chatId, event) {
    event.stopPropagation(); // Prevent opening the chat
    
    if (!confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
      return;
    }
    
    try {
      // Delete all messages in the conversation first
      const messagesQuery = query(collection(db, "conversations", chatId, "messages"));
      const messagesSnapshot = await getDocs(messagesQuery);
      
      const deletePromises = [];
      messagesSnapshot.forEach((doc) => {
        deletePromises.push(deleteDoc(doc.ref));
      });
      
      await Promise.all(deletePromises);
      
      // Delete the conversation document
      await deleteDoc(doc(db, "conversations", chatId));
      
      // Clear current chat if it was the deleted one
      if (currentChatId === chatId) {
        currentChatId = null;
        document.getElementById('emptyChat').style.display = 'flex';
        document.getElementById('chatHeader').style.display = 'none';
        document.getElementById('messagesContainer').style.display = 'none';
        document.getElementById('messageInputContainer').style.display = 'none';
        
        // Remove wallpaper
        messagesContainer.style.backgroundImage = 'none';
        const existingVid = messagesContainer.querySelector('.bg-video-layer');
        if (existingVid) existingVid.remove();
      }
      
      // Remove from localStorage
      localStorage.removeItem('last_active_chat');
      localStorage.removeItem('meet_wallpaper_' + chatId);
      
    } catch (error) {
      console.error("Error deleting conversation:", error);
      alert("Failed to delete conversation. Please try again.");
    }
  }

  // Update the loadConversations function to include delete button
  function loadConversations() {
    const q = query(collection(db, "conversations"), where("participants", "array-contains", currentUser.uid));
    onSnapshot(q, (snapshot) => {
      const list = document.getElementById('conversationsList');
      list.innerHTML = '';
      const convs = [];
      snapshot.forEach(doc => convs.push({id: doc.id, ...doc.data()}));
      convs.sort((a,b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));
        
      convs.forEach(conv => {
         const otherId = conv.participants.find(p => p !== currentUser.uid);
         const name = conv.participantNames?.[otherId] || 'User';
         const avatar = conv.participantAvatars?.[otherId] || `https://ui-avatars.com/api/?name=${name}`;
         const div = document.createElement('div');
         div.className = `conversation-item ${currentChatId === conv.id ? 'active' : ''}`;
         div.setAttribute('data-chat-id', conv.id);
         div.innerHTML = `
           <img src="${avatar}" class="conversation-avatar">
           <div class="conversation-info">
             <div class="conversation-name">${name}</div>
             <div class="conversation-preview">${conv.lastMessage || 'No messages'}</div>
           </div>
           <div class="conversation-actions">
             <button class="delete-conversation-btn" onclick="deleteConversation('${conv.id}', event)">
               <i class="fas fa-trash"></i>
             </button>
           </div>
         `;
         div.onclick = () => {
           localStorage.setItem('last_active_chat', conv.id);
           openChat(conv.id, otherId, name, avatar);
         };
         list.appendChild(div);
      });
    });
  }

  // Update the openChat function with better error handling
  async function openChat(chatId, otherUserId, name, avatar) {
    try {
      // Verify the conversation exists before opening
      const chatDoc = await getDoc(doc(db, "conversations", chatId));
      if (!chatDoc.exists()) {
        throw new Error("Conversation not found");
      }

      currentChatId = chatId;
      currentChatUser = otherUserId;
      currentChatUserAvatar = avatar;

      // PERSISTENCE: Save ID so it stays on refresh
      localStorage.setItem('last_active_chat', chatId);

      // Wallpaper
      const savedWp = localStorage.getItem('meet_wallpaper_' + chatId);
      if(savedWp) applyWallpaper(JSON.parse(savedWp));
      else { 
        messagesContainer.style.backgroundImage = 'none'; 
        const existingVid = messagesContainer.querySelector('.bg-video-layer');
        if(existingVid) existingVid.remove(); 
      }
        
      document.getElementById('emptyChat').style.display = 'none';
      document.getElementById('chatHeader').style.display = 'flex';
      document.getElementById('messagesContainer').style.display = 'flex';
      document.getElementById('messageInputContainer').style.display = 'block';
      document.getElementById('chatUserName').innerText = name;
      document.getElementById('currentChatAvatar').src = avatar;
        
      // Update active class
      const allItems = document.querySelectorAll('.conversation-item');
      allItems.forEach(el => el.classList.remove('active'));
      const activeItem = document.querySelector(`[data-chat-id="${chatId}"]`);
      if (activeItem) activeItem.classList.add('active');

      if(window.innerWidth <= 768) { 
        document.getElementById('conversationsSidebar').style.zIndex = '10'; 
        document.getElementById('chatArea').classList.add('active'); 
      }
        
      loadMessages(chatId);
    } catch (error) {
      console.error("Error opening chat:", error);
      alert("Failed to open conversation. It may have been deleted.");
      // Remove from localStorage and reload conversations
      localStorage.removeItem('last_active_chat');
      loadConversations();
    }
  }

  // Update the message sending to remove optimistic message display
  document.getElementById('sendButton').addEventListener('click', async () => {
    const text = messageInput.value.trim();
    if(!text || !currentChatId) return;
      
    // EDIT
    if(editingMsgId) {
        await updateDoc(doc(db, "conversations", currentChatId, "messages", editingMsgId), { text: text, isEdited: true });
        cancelReply();
        return;
    }

    // 1. CLEAR UI IMMEDIATELY (but don't show optimistic message)
    messageInput.value = '';
    messageInput.style.height = '48px';

    const msgPayload = {
        text: text, 
        senderId: currentUser.uid, 
        timestamp: serverTimestamp(),
        replyTo: replyToMsg ? { id: replyToMsg.id, user: replyToMsg.user, text: replyToMsg.text } : null
    };

    // 2. SEND TO FIREBASE (Non-blocking) - No optimistic message
    cancelReply(); // Close reply bar immediately
      
    try {
        await addDoc(collection(db, "conversations", currentChatId, "messages"), msgPayload);
        await updateDoc(doc(db, "conversations", currentChatId), { 
          lastMessage: text, 
          updatedAt: serverTimestamp() 
        });
    } catch(e) { 
        console.error("Send error:", e);
        alert("Failed to send message. Please try again.");
    }
  });

  // Make deleteConversation available globally
  window.deleteConversation = deleteConversation;

  // All other existing JavaScript code remains the same...
</script>
</body>
</html>
