<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary: #0080FF;
    --primary-dark: #0066CC;
    --bg-color: #f0f2f5;
    --card-bg: #fff;
    --text-color: #111;
    --secondary-text: #65676b;
    --border-color: #dddfe2;
    --error: #EF4444;
    --app-height: 100dvh; 
  }

  body.dark-mode {
    --bg-color: #18191a;
    --card-bg: #242526;
    --text-color: #e4e6eb;
    --secondary-text: #b0b3b8;
    --border-color: #3e4042;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  html, body { height: 100%; overflow: hidden; font-size: 16px; font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-color); }

  .app-container { display: flex; height: var(--app-height); position: relative; overflow: hidden; }

  /* --- Sidebar / Hamburger Logic --- */
  .sidebar {
    position: fixed;
    top: 0; left: 0; height: 100%; width: 260px;
    background: linear-gradient(180deg, #0080FF 0%, #00C6FF 100%);
    z-index: 200;
    padding: 20px;
    color: white;
    transform: translateX(-100%); /* Hidden by default */
    transition: transform 0.3s ease;
  }

  .sidebar.open { transform: translateX(0); }

  .sidebar-header { padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.2); margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center;}
  .sidebar-menu { list-style: none; }
  .sidebar-menu li { margin-bottom: 8px; }
  .sidebar-menu a { display: flex; align-items: center; padding: 12px; text-decoration: none; color: white; border-radius: 8px; font-size: 16px; }
  .sidebar-menu a:hover { background: rgba(255, 255, 255, 0.2); }
  .sidebar-menu i { margin-right: 12px; font-size: 18px; }

  /* Overlay for sidebar */
  .sidebar-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); z-index: 190;
  }
  .sidebar-overlay.active { display: block; }

  /* Main Content */
  .main-content { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; padding: 10px; width: 100%; }

  /* Navbar */
  .navbar {
    background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);
    padding: 10px 15px; border-radius: 12px; margin-bottom: 10px;
    display: flex; justify-content: space-between; align-items: center;
    color: white; flex-shrink: 0;
  }

  .navbar-left { display: flex; align-items: center; gap: 15px; }
  .hamburger-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }

  .btn { background: rgba(255, 255, 255, 0.2); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 8px; }

  /* Chat Container */
  .chat-container { flex: 1; background: var(--card-bg); border-radius: 12px; overflow: hidden; display: flex; min-height: 0; position: relative; }

  /* Conversations List */
  .conversations-sidebar { width: 320px; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; height: 100%; background: var(--card-bg); }
  .chat-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
  .new-chat-btn { background: #0080FF; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  .chat-search { padding: 10px; border-bottom: 1px solid var(--border-color); }
  .chat-search input { width: 100%; padding: 8px 15px; border-radius: 20px; border: 1px solid var(--border-color); background: var(--bg-color); outline: none; }
  .conversations-list { flex: 1; overflow-y: auto; }
  
  .conversation-item { display: flex; align-items: center; gap: 10px; padding: 12px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
  .conversation-item:hover { background: rgba(0,128,255,0.05); }
  .conversation-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; }
  .conversation-info { flex: 1; min-width: 0; }
  .conversation-name { font-weight: 600; font-size: 15px; }
  .conversation-preview { font-size: 13px; color: var(--secondary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* Chat Area */
  .chat-area { flex: 1; display: flex; flex-direction: column; height: 100%; background: var(--bg-color); position: relative; }
  
  .chat-area-header { padding: 10px 15px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px; background: var(--card-bg); z-index: 10; }
  .chat-actions { display: flex; gap: 15px; margin-left: auto; }
  .chat-action-btn { background: none; border: none; color: #0080FF; font-size: 18px; cursor: pointer; }

  .messages-container { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background-size: cover; background-position: center; }

  .message { display: flex; gap: 8px; max-width: 75%; margin-bottom: 5px; }
  .message.sent { align-self: flex-end; flex-direction: row-reverse; }
  
  .message-bubble { padding: 10px 14px; border-radius: 16px; position: relative; word-wrap: break-word; font-size: 14px; line-height: 1.4; max-width: 100%; }
  .received .message-bubble { background: var(--card-bg); border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
  .sent .message-bubble { background: #0080FF; color: white; border-bottom-right-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
  
  .message-img { max-width: 100%; border-radius: 8px; margin-top: 5px; display: block; }
  .message-video { max-width: 100%; border-radius: 8px; margin-top: 5px; display: block; }

  /* Input Area */
  .message-input-container { padding: 10px; border-top: 1px solid var(--border-color); background: var(--card-bg); }
  .message-input-wrapper { display: flex; align-items: flex-end; gap: 8px; }
  .message-input-actions { display: flex; align-items: center; gap: 5px; }
  .input-action { background: transparent; border: none; color: var(--secondary-text); cursor: pointer; font-size: 20px; padding: 8px; border-radius: 50%; }
  .message-input { flex: 1; padding: 10px 15px; border-radius: 20px; border: 1px solid var(--border-color); background: var(--bg-color); resize: none; font-family: inherit; font-size: 15px; max-height: 100px; outline: none; }
  .send-button { background: #0080FF; color: white; border: 0; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

  /* AI Switch */
  .ai-control { display: flex; flex-direction: column; align-items: center; justify-content: center; margin-right: 5px; }
  .ai-label { font-size: 8px; font-weight: bold; color: #0080FF; margin-bottom: 2px;}
  .ai-switch { position: relative; display: inline-block; width: 36px; height: 20px; }
  .ai-switch input { opacity: 0; width: 0; height: 0; }
  .ai-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
  .ai-slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .ai-slider { background-color: #0080FF; }
  input:checked + .ai-slider:before { transform: translateX(16px); }

  /* Emoji Picker */
  .emoji-picker { display: none; position: absolute; bottom: 70px; left: 10px; width: 300px; height: 250px; background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 100; overflow: hidden; flex-direction: column; }
  .emoji-nav { display: flex; background: var(--bg-color); overflow-x: auto; padding: 5px; }
  .emoji-nav button { border: none; background: none; padding: 5px 10px; font-size: 18px; cursor: pointer; opacity: 0.6; }
  .emoji-nav button.active { opacity: 1; border-bottom: 2px solid #0080FF; }
  .emoji-content { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; }
  .emoji-item { font-size: 24px; cursor: pointer; text-align: center; }

  /* Wallpapers Modal */
  .wallpaper-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; padding: 20px; }
  .wallpaper-content { background: var(--card-bg); border-radius: 12px; padding: 20px; max-width: 800px; height: 90vh; margin: 0 auto; display: flex; flex-direction: column; }
  .wallpaper-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; overflow-y: auto; padding-top: 15px; }
  .wallpaper-thumb { aspect-ratio: 9/16; border-radius: 8px; overflow: hidden; cursor: pointer; border: 2px solid transparent; }
  .wallpaper-thumb:hover { border-color: #0080FF; transform: scale(1.02); }
  .wallpaper-thumb img, .wallpaper-thumb video { width: 100%; height: 100%; object-fit: cover; }

  /* User Search Overlay */
  .user-search-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; padding: 20px; }
  .user-search-modal { background: var(--card-bg); border-radius: 12px; padding: 25px; width: 100%; max-width: 450px; }
  .search-results { max-height: 250px; overflow-y: auto; margin-top: 10px; }
  .search-result-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
  .search-result-item:hover { background: rgba(0,0,0,0.05); }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .chat-container { border-radius: 0; height: 100%; }
    .conversations-sidebar { width: 100%; position: absolute; z-index: 50; }
    .chat-area { width: 100%; position: absolute; z-index: 60; transform: translateX(100%); transition: transform 0.3s ease; }
    .chat-area.active { transform: translateX(0); }
    .navbar h2 { font-size: 16px; }
  }
</style>
</head>
<body>

<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<div class="app-container">
  <div class="sidebar" id="mainSidebar">
    <div class="sidebar-header">
      <h2>MEET</h2>
      <button onclick="toggleSidebar()" style="background:none; border:none; color:white; font-size:20px;"><i class="fas fa-times"></i></button>
    </div>
    <ul class="sidebar-menu">
      <li><a href="feed.html"><i class="fas fa-home"></i> <span>Feed</span></a></li>
      <li><a href="profile.html"><i class="fas fa-user"></i> <span>Profile</span></a></li>
      <li><a href="chat.html" class="active"><i class="fas fa-comment"></i> <span>Chat</span></a></li>
      <li><a href="conference.html"><i class="fas fa-video"></i> <span>Conference</span></a></li>
      <li><a href="meetrader.html"><i class="fas fa-store"></i> <span>Meetrader</span></a></li>
      <li><a href="meetversity.html"><i class="fas fa-graduation-cap"></i> <span>Meetversity</span></a></li>
      <li><a href="organization.html"><i class="fas fa-sitemap"></i> <span>Organization</span></a></li>
    </ul>
  </div>

  <div class="main-content">
    <div class="navbar">
      <div class="navbar-left">
        <button class="hamburger-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <h2>Chat</h2>
      </div>
      <div style="display: flex; gap: 10px;">
        <button class="btn" id="nightToggleBtn"><i class="fas fa-moon"></i></button>
        <button class="btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </div>

    <div class="chat-container">
      <div class="conversations-sidebar" id="conversationsSidebar">
        <div class="chat-header">
          <h3>Messages</h3>
          <button class="new-chat-btn" onclick="openUserSearchOverlay()"><i class="fas fa-plus"></i></button>
        </div>
        <div class="chat-search">
          <input type="text" placeholder="Search chats..." id="chatSearch">
        </div>
        <div class="conversations-list" id="conversationsList"></div>
      </div>

      <div class="chat-area" id="chatArea">
        
        <div id="emptyChat" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:var(--secondary-text);">
          <i class="fas fa-comments" style="font-size:60px; opacity:0.5; margin-bottom:20px;"></i>
          <h3>Select a conversation</h3>
        </div>

        <div class="chat-area-header" id="chatHeader" style="display: none;">
          <button class="chat-action-btn" id="backButton" style="color:var(--text-color); margin-right:10px;"><i class="fas fa-arrow-left"></i></button>
          <img src="" id="currentChatAvatar" class="conversation-avatar">
          <div style="flex:1; margin-left:10px;">
            <div style="font-weight:700;" id="chatUserName">User</div>
          </div>
          <div class="chat-actions">
            <button class="chat-action-btn" onclick="startVoiceCall()"><i class="fas fa-phone-alt"></i></button>
            <button class="chat-action-btn" onclick="startVideoCall()"><i class="fas fa-video"></i></button>
            <button class="chat-action-btn" onclick="openWallpaperModal()"><i class="fas fa-image"></i></button>
          </div>
        </div>

        <div class="messages-container" id="messagesContainer" style="display: none;"></div>

        <div class="message-input-container" id="messageInputContainer" style="display: none;">
          <div class="message-input-wrapper">
            
            <div class="message-input-actions">
               <div class="ai-control">
                <span class="ai-label">AI</span>
                <label class="ai-switch">
                  <input type="checkbox" id="aiToggle">
                  <span class="ai-slider"></span>
                </label>
              </div>

              <button class="input-action" onclick="toggleEmojiPicker()"><i class="far fa-smile"></i></button>
              
              <input type="file" id="imageInputHidden" accept="image/*" style="display:none" onchange="uploadToCloudinary(this.files[0], 'image')">
              <input type="file" id="videoInputHidden" accept="video/*" style="display:none" onchange="uploadToCloudinary(this.files[0], 'video')">
              
              <button class="input-action" onclick="document.getElementById('imageInputHidden').click()"><i class="fas fa-image"></i></button>
              <button class="input-action" onclick="document.getElementById('videoInputHidden').click()"><i class="fas fa-video"></i></button>
              <button class="input-action" onclick="alert('Recording...')"><i class="fas fa-microphone"></i></button>
            </div>

            <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1"></textarea>
            
            <button class="send-button" id="sendButton"><i class="fas fa-paper-plane"></i></button>
          </div>
          
          <div class="emoji-picker" id="emojiPicker">
             <div class="emoji-nav" id="emojiNav"></div>
             <div class="emoji-content" id="emojiContent"></div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<div class="user-search-overlay" id="userSearchOverlay">
  <div class="user-search-modal">
    <h3>Start Chat</h3>
    <input type="text" id="userSearchInput" placeholder="Search users by name/email..." style="width:100%; padding:10px; margin:10px 0; border:1px solid #ddd; border-radius:8px;">
    <div class="search-results" id="userSearchResults"></div>
    <button onclick="closeUserSearchOverlay()" class="btn" style="background:var(--error); margin-top:10px; width:100%; justify-content:center;">Cancel</button>
  </div>
</div>

<div class="wallpaper-modal" id="wallpaperModal">
  <div class="wallpaper-content">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
      <h3>Choose Wallpaper</h3>
      <button onclick="closeWallpaperModal()" style="background:none; border:none; font-size:20px; cursor:pointer;"><i class="fas fa-times"></i></button>
    </div>
    <div class="wallpaper-grid" id="wallpaperGrid"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getFirestore, collection, addDoc, updateDoc, doc, getDoc, getDocs, onSnapshot, serverTimestamp, query, orderBy, where, setDoc, limit } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM", 
    authDomain: "meet-6e159.firebaseapp.com",
    projectId: "meet-6e159",
    storageBucket: "meet-6e159.firebasestorage.app",
    messagingSenderId: "252353608421",
    appId: "1:252353608421:web:6706056048e9a8f12db20c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let currentUser = null;
  let currentChatId = null;
  let currentChatUser = null;

  // DOM Elements
  const chatArea = document.getElementById('chatArea');
  const conversationsSidebar = document.getElementById('conversationsSidebar');
  const messagesContainer = document.getElementById('messagesContainer');
  const messageInput = document.getElementById('messageInput');
  const emojiPicker = document.getElementById('emojiPicker');
  const sidebar = document.getElementById('mainSidebar');
  const sidebarOverlay = document.getElementById('sidebarOverlay');

  window.toggleSidebar = () => {
    sidebar.classList.toggle('open');
    sidebarOverlay.classList.toggle('active');
  };

  // --- WALLPAPERS (Reliable Source) ---
  const wallpapers = [
    // 30 Images (Using Picsum)
    { type: 'image', src: 'https://picsum.photos/id/10/800/1200' }, { type: 'image', src: 'https://picsum.photos/id/11/800/1200' },
    { type: 'image', src: 'https://picsum.photos/id/12/800/1200' }, { type: 'image', src: 'https://picsum.photos/id/13/800/1200' },
    { type: 'image', src: 'https://picsum.photos/id/14/800/1200' }, { type: 'image', src: 'https://picsum.photos/id/15/800/1200' },
    { type: 'image', src: 'https://picsum.photos/id/16/800/1200' }, { type: 'image', src: 'https://picsum.photos/id/17/800/1200' },
    { type: 'image', src: 'https://picsum.photos/id/18/800/1200' }, { type: 'image', src: 'https://picsum.photos/id/19/800/1200' },
    { type: 'image', src: 'https://picsum.photos/id/20/800/1200' }, { type: 'image', src: 'https://picsum.photos/id/21/800/1200' },
    { type: 'image', src: 'https://picsum.photos/id/22/800/1200' }, { type: 'image', src: 'https://picsum.photos/id/23/800/1200' },
    { type: 'image', src: 'https://picsum.photos/id/24/800/1200' }, { type: 'image', src: 'https://picsum.photos/id/25/800/1200' },
    { type: 'image', src: 'https://picsum.photos/id/26/800/1200' }, { type: 'image', src: 'https://picsum.photos/id/27/800/1200' },
    { type: 'image', src: 'https://picsum.photos/id/28/800/1200' }, { type: 'image', src: 'https://picsum.photos/id/29/800/1200' },
    { type: 'image', src: 'https://picsum.photos/id/30/800/1200' }, { type: 'image', src: 'https://picsum.photos/id/31/800/1200' },
    { type: 'image', src: 'https://picsum.photos/id/32/800/1200' }, { type: 'image', src: 'https://picsum.photos/id/33/800/1200' },
    { type: 'image', src: 'https://picsum.photos/id/34/800/1200' }, { type: 'image', src: 'https://picsum.photos/id/35/800/1200' },
    { type: 'image', src: 'https://picsum.photos/id/36/800/1200' }, { type: 'image', src: 'https://picsum.photos/id/37/800/1200' },
    { type: 'image', src: 'https://picsum.photos/id/38/800/1200' }, { type: 'image', src: 'https://picsum.photos/id/39/800/1200' },
    // 10 Videos
    { type: 'video', src: 'https://assets.mixkit.co/videos/preview/mixkit-white-sand-beach-background-1564-large.mp4' },
    { type: 'video', src: 'https://assets.mixkit.co/videos/preview/mixkit-stars-in-space-1610-large.mp4' },
    { type: 'video', src: 'https://assets.mixkit.co/videos/preview/mixkit-forest-stream-in-the-sunlight-529-large.mp4' },
    { type: 'video', src: 'https://assets.mixkit.co/videos/preview/mixkit-ink-swirling-in-water-189-large.mp4' },
    { type: 'video', src: 'https://assets.mixkit.co/videos/preview/mixkit-red-lights-in-darkness-1383-large.mp4' },
    { type: 'video', src: 'https://assets.mixkit.co/videos/preview/mixkit-view-of-the-sun-from-space-1608-large.mp4' },
    { type: 'video', src: 'https://assets.mixkit.co/videos/preview/mixkit-texture-of-a-rock-surface-1054-large.mp4' },
    { type: 'video', src: 'https://assets.mixkit.co/videos/preview/mixkit-abstract-video-of-a-man-with-heads-like-a-fan-32630-large.mp4' },
    { type: 'video', src: 'https://assets.mixkit.co/videos/preview/mixkit-bubbles-of-water-rising-to-the-surface-186-large.mp4' },
    { type: 'video', src: 'https://assets.mixkit.co/videos/preview/mixkit-digital-animation-of-blue-and-pink-squares-956-large.mp4' }
  ];

  window.openWallpaperModal = () => {
    document.getElementById('wallpaperModal').style.display = 'block';
    const grid = document.getElementById('wallpaperGrid');
    grid.innerHTML = '';
    wallpapers.forEach(wp => {
      const div = document.createElement('div');
      div.className = 'wallpaper-thumb';
      if(wp.type === 'image') {
        div.innerHTML = `<img src="${wp.src}" loading="lazy">`;
      } else {
        div.innerHTML = `<video src="${wp.src}" muted></video>`;
      }
      div.onclick = () => setWallpaper(wp);
      grid.appendChild(div);
    });
  };

  window.closeWallpaperModal = () => document.getElementById('wallpaperModal').style.display = 'none';

  function setWallpaper(wp) {
    if(wp.type === 'image') {
       messagesContainer.style.backgroundImage = `url(${wp.src})`;
       const existingVid = messagesContainer.querySelector('.bg-video-layer');
       if(existingVid) existingVid.remove();
    } else {
       messagesContainer.style.backgroundImage = 'none';
       const existingVid = messagesContainer.querySelector('.bg-video-layer');
       if(existingVid) existingVid.remove();

       const vid = document.createElement('video');
       vid.className = 'bg-video-layer';
       vid.src = wp.src;
       vid.autoplay = true; vid.loop = true; vid.muted = true;
       vid.style.cssText = "position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:-1; opacity:0.6;";
       messagesContainer.prepend(vid);
    }
    closeWallpaperModal();
  }

  // --- YOUR CLOUDINARY UPLOAD LOGIC ---
  window.uploadToCloudinary = async (file, type) => {
    if(!file || !currentChatId) return;
    
    // HARDCODED CREDENTIALS AS REQUESTED
    const cloudName = "dcwof2ngn"; 
    const uploadPreset = "Meet_video"; 

    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', uploadPreset);
    formData.append('resource_type', type === 'video' ? 'video' : 'image');

    const buttonIcon = type === 'image' ? 'fa-image' : 'fa-video';
    const btn = document.querySelector(`.input-action .${buttonIcon}`).parentElement;
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 

    try {
      const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/${type === 'video' ? 'video' : 'image'}/upload`, {
        method: 'POST',
        body: formData
      });
      const data = await response.json();
      
      if(data.secure_url) {
        await addDoc(collection(db, "conversations", currentChatId, "messages"), {
          mediaUrl: data.secure_url,
          mediaType: type,
          text: "",
          senderId: currentUser.uid,
          timestamp: serverTimestamp()
        });
        await updateDoc(doc(db, "conversations", currentChatId), {
          lastMessage: type === 'video' ? 'Sent a video' : 'Sent a photo',
          updatedAt: serverTimestamp()
        });
      } else {
        alert("Upload failed. Please check your internet connection.");
        console.error(data);
      }
    } catch (err) {
      console.error("Cloudinary Error:", err);
      alert("Error uploading file.");
    } finally {
      btn.innerHTML = originalContent;
    }
  };


  // --- EMOJI PICKER ---
  const emojis = { "ðŸ˜€": ["ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ˜†"], "â¤ï¸": ["â¤ï¸","ðŸ’”","ðŸ’•","ðŸ’–"], "ðŸ¶": ["ðŸ¶","ðŸ±","ðŸ­"] };
  function initEmojiPicker() {
    const nav = document.getElementById('emojiNav');
    const content = document.getElementById('emojiContent');
    let first = true;
    for (const [key, list] of Object.entries(emojis)) {
      const btn = document.createElement('button');
      btn.innerText = key;
      btn.onclick = () => {
         content.innerHTML = '';
         list.forEach(e => {
            const s = document.createElement('span'); s.className = 'emoji-item'; s.innerText = e;
            s.onclick = () => { messageInput.value += e; };
            content.appendChild(s);
         });
      };
      nav.appendChild(btn);
      if(first) { btn.click(); first = false; }
    }
  }
  window.toggleEmojiPicker = () => { emojiPicker.style.display = emojiPicker.style.display === 'flex' ? 'none' : 'flex'; };

  // --- CORE LOGIC ---
  onAuthStateChanged(auth, user => {
    if (!user) { window.location.href = 'login.html'; } 
    else {
      currentUser = user;
      document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
      loadConversations();
      initEmojiPicker();
    }
  });

  function loadConversations() {
    const q = query(collection(db, "conversations"), where("participants", "array-contains", currentUser.uid));
    onSnapshot(q, (snapshot) => {
      const list = document.getElementById('conversationsList');
      list.innerHTML = '';
      const convs = [];
      snapshot.forEach(doc => convs.push({id: doc.id, ...doc.data()}));
      convs.sort((a,b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));

      convs.forEach(conv => {
         const otherId = conv.participants.find(p => p !== currentUser.uid);
         const name = conv.participantNames?.[otherId] || 'User';
         const avatar = conv.participantAvatars?.[otherId] || `https://ui-avatars.com/api/?name=${name}&background=random`;
         
         const div = document.createElement('div');
         div.className = `conversation-item ${currentChatId === conv.id ? 'active' : ''}`;
         div.innerHTML = `
           <img src="${avatar}" class="conversation-avatar">
           <div class="conversation-info">
             <div class="conversation-name">${name}</div>
             <div class="conversation-preview">${conv.lastMessage || 'No messages'}</div>
           </div>
         `;
         div.onclick = () => openChat(conv.id, otherId, name, avatar);
         list.appendChild(div);
      });
    });
  }

  async function openChat(chatId, otherUserId, name, avatar) {
    currentChatId = chatId;
    currentChatUser = otherUserId;
    document.getElementById('emptyChat').style.display = 'none';
    document.getElementById('chatHeader').style.display = 'flex';
    document.getElementById('messagesContainer').style.display = 'flex';
    document.getElementById('messageInputContainer').style.display = 'block';
    document.getElementById('chatUserName').innerText = name;
    document.getElementById('currentChatAvatar').src = avatar;

    if(window.innerWidth <= 768) {
      conversationsSidebar.style.zIndex = '10';
      chatArea.classList.add('active');
    }
    loadMessages(chatId);
  }

  let unsubscribeMessages;
  function loadMessages(chatId) {
    if(unsubscribeMessages) unsubscribeMessages();
    
    const q = query(collection(db, "conversations", chatId, "messages"), orderBy("timestamp", "asc"));
    
    unsubscribeMessages = onSnapshot(q, (snapshot) => {
      const container = document.getElementById('messagesContainer');
      const isAiOn = document.getElementById('aiToggle').checked;

      snapshot.docChanges().forEach((change) => {
        if (change.type === "added") {
          const msg = change.doc.data();
          const id = change.doc.id;
          
          const div = document.createElement('div');
          div.className = `message ${msg.senderId === currentUser.uid ? 'sent' : 'received'}`;
          
          let content = "";
          if(msg.mediaType === 'image') content += `<img src="${msg.mediaUrl}" class="message-img">`;
          else if(msg.mediaType === 'video') content += `<video src="${msg.mediaUrl}" controls class="message-video"></video>`;
          if(msg.text) content += `<div>${msg.text}</div>`;

          div.innerHTML = `
             <div class="message-bubble">
               ${content}
               <div class="message-time">${msg.timestamp ? new Date(msg.timestamp.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...'}</div>
             </div>
          `;
          container.appendChild(div);
          container.scrollTop = container.scrollHeight;

          // --- AI AUTO REPLY (Reply on RECEIVE) ---
          // If message is from someone else, AI is ON, and message is new (<5s)
          if(msg.senderId !== currentUser.uid && isAiOn && msg.timestamp) {
            const now = new Date().getTime();
            const msgTime = msg.timestamp.toMillis();
            if (now - msgTime < 5000) { 
                setTimeout(async () => {
                    await addDoc(collection(db, "conversations", chatId, "messages"), {
                        text: "I am currently away, but my AI assistant received your message.",
                        senderId: currentUser.uid, 
                        timestamp: serverTimestamp()
                    });
                }, 3000); 
            }
          }
        }
      });
    });
  }

  document.getElementById('sendButton').addEventListener('click', async () => {
    const text = messageInput.value.trim();
    if(!text || !currentChatId) return;
    messageInput.value = '';
    await addDoc(collection(db, "conversations", currentChatId, "messages"), {
      text: text, senderId: currentUser.uid, timestamp: serverTimestamp()
    });
    await updateDoc(doc(db, "conversations", currentChatId), { lastMessage: text, updatedAt: serverTimestamp() });
  });

  // Search Logic
  window.openUserSearchOverlay = () => document.getElementById('userSearchOverlay').style.display = 'flex';
  window.closeUserSearchOverlay = () => document.getElementById('userSearchOverlay').style.display = 'none';

  document.getElementById('userSearchInput').addEventListener('input', async (e) => {
    const term = e.target.value.toLowerCase();
    if(term.length < 3) return;
    const resDiv = document.getElementById('userSearchResults');
    resDiv.innerHTML = 'Searching...';
    
    const q = query(collection(db, "users"), where("email", ">=", term), where("email", "<=", term + '\uf8ff'), limit(5));
    const snap = await getDocs(q);
    resDiv.innerHTML = '';
    snap.forEach(doc => {
       if(doc.id === currentUser.uid) return;
       const d = doc.data();
       const div = document.createElement('div');
       div.className = 'search-result-item';
       div.innerHTML = `<div>${d.name || d.email}</div>`;
       // CLICK TO START CHAT FIX
       div.onclick = () => startNewChat(doc.id, d);
       resDiv.appendChild(div);
    });
  });

  async function startNewChat(otherId, otherData) {
    const participants = [currentUser.uid, otherId].sort();
    const chatId = participants.join('_');
    await setDoc(doc(db, "conversations", chatId), {
      participants: participants,
      participantNames: { [currentUser.uid]: currentUser.displayName || 'Me', [otherId]: otherData.name || 'User' },
      updatedAt: serverTimestamp(),
      lastMessage: ''
    }, {merge: true});
    closeUserSearchOverlay();
    openChat(chatId, otherId, otherData.name || 'User', otherData.photoURL || 'https://via.placeholder.com/50');
  }

  document.getElementById('backButton').addEventListener('click', () => { chatArea.classList.remove('active'); });
  document.getElementById('nightToggleBtn').addEventListener('click', () => { document.body.classList.toggle('dark-mode'); });
</script>
</body>
</html>
