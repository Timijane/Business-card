<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/picmo@latest/dist/umd/index.js"></script>
<style>
  :root {
    --primary: #0080FF;
    --primary-dark: #0066CC;
    --bg-color: #f0f2f5;
    --card-bg: #fff;
    --text-color: #111;
    --secondary-text: #65676b;
    --border-color: #dddfe2;
    --online: #10B981;
    --offline: #EF4444;
    --ai-color: #8A2BE2;
    --read-color: #0095f6; /* Blue for read receipts */
  }

  body.dark-mode {
    --bg-color: #18191a;
    --card-bg: #242526;
    --text-color: #e4e6eb;
    --secondary-text: #b0b3b8;
    --border-color: #3e4042;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-color); height: 100dvh; overflow: hidden; }

  .app-container { display: flex; height: 100%; }

  /* 1. SIDEBAR (MENU BAR) */
  .sidebar {
    width: 250px; background: linear-gradient(180deg, #0080FF 0%, #00C6FF 100%);
    display: flex; flex-direction: column; padding: 20px; color: white; flex-shrink: 0;
    transition: transform 0.3s ease-in-out; /* Added for mobile transition */
  }
  .sidebar h2 { margin-bottom: 30px; font-size: 24px; font-weight: 700; }
  .sidebar ul { list-style: none; }
  .sidebar li { margin-bottom: 10px; }
  .sidebar a {
    display: flex; align-items: center; color: white; text-decoration: none;
    padding: 10px; border-radius: 8px; transition: background 0.2s; font-size: 16px; position: relative;
  }
  .sidebar a:hover, .sidebar a.active { background: rgba(255,255,255,0.2); }
  .sidebar i { width: 25px; margin-right: 10px; text-align: center; }

  /* 5. NOTIFICATION BADGE ON SIDEBAR ICON */
  .nav-badge {
      position: absolute; right: 10px; top: 10px; width: 10px; height: 10px;
      background: #FF0000; border-radius: 50%; display: none; border: 1px solid white;
  }

  /* CHAT INTERFACE */
  .chat-interface { flex: 1; display: flex; overflow: hidden; background: var(--bg-color); }

  .conversations-sidebar {
    width: 320px; background: var(--card-bg); border-right: 1px solid var(--border-color);
    display: flex; flex-direction: column; flex-shrink: 0;
  }
  .search-container { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; } /* Adjusted for menu btn */
  .search-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .menu-btn-mobile { display: none; background: none; border: none; font-size: 24px; color: var(--text-color); cursor: pointer; }

  .search-input {
    width: 100%; padding: 10px; border-radius: 20px; border: 1px solid var(--border-color);
    background: var(--bg-color); color: var(--text-color); outline: none;
  }
  .new-chat-btn {
    background: var(--primary); color: white; border: none;
    width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
  }
  .conversations-list { flex: 1; overflow-y: auto; }
  
  .conversation-item {
    display: flex; align-items: center; padding: 15px; cursor: pointer;
    border-bottom: 1px solid var(--border-color); position: relative;
  }
  .conversation-item:hover, .conversation-item.active { background: rgba(0,128,255,0.05); }
  
  .avatar-container { position: relative; margin-right: 12px; }
  .conv-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; }
  
  /* 2. REAL TIME STATUS COLORS */
  .status-dot {
    position: absolute; bottom: 0; right: 0; width: 12px; height: 12px;
    border-radius: 50%; border: 2px solid var(--card-bg);
  }
  /* Explicit colors for requirements */
  .is-online { background-color: #10B981 !important; /* Green */ }
  .is-offline { background-color: #EF4444 !important; /* Red */ }

  .conv-info { flex: 1; min-width: 0; }
  .conv-name { font-weight: 600; font-size: 15px; }
  .conv-preview { font-size: 13px; color: var(--secondary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; justify-content: space-between;}
  
  .chat-area {
    flex: 1; display: flex; flex-direction: column; position: relative; background-size: cover; background-position: center;
    background-color: var(--bg-color);
  }

  .chat-header {
    height: 60px; background: var(--card-bg); border-bottom: 1px solid var(--border-color);
    display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0;
  }
  .chat-header-user { display: flex; align-items: center; gap: 10px; }
  .header-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
  .header-info { display: flex; flex-direction: column; }
  
  .typing-status { font-size: 11px; color: var(--primary); font-weight: 600; display: none; }
  
  .header-actions button {
    background: none; border: none; color: var(--primary); font-size: 18px;
    margin-left: 15px; cursor: pointer; padding: 5px;
  }

  .messages-wrapper { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
  
  .message { display: flex; gap: 10px; max-width: 70%; position: relative; min-width: 200px; }
  .message.sent { align-self: flex-end; flex-direction: row-reverse; }
  
  /* 1. SENDER/RECEIVER PICTURES FIXED */
  .msg-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; align-self: flex-end; flex-shrink: 0; }
  
  .message-bubble {
    padding: 10px 14px; border-radius: 18px; font-size: 14px; position: relative;
    word-wrap: break-word; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  .received .message-bubble { background: var(--card-bg); border-bottom-left-radius: 4px; }
  .sent .message-bubble { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
  
  .msg-media { max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; } /* Handles both image/video */

  /* Read Receipt Ticks */
  .msg-meta {
      display: flex; justify-content: flex-end; align-items: center; gap: 4px; margin-top: 2px;
      font-size: 10px; opacity: 0.8;
  }
  .ticks { font-size: 10px; letter-spacing: -2px; }
  .tick-sent { color: rgba(255,255,255,0.7); } /* 1 tick */
  .tick-delivered { color: rgba(255,255,255,0.9); } /* 2 ticks */
  .tick-read { color: #00ffff; text-shadow: 0 0 5px rgba(0,0,255,0.5); } /* 3 ticks / Blueish */
  .received .ticks { display: none; } /* Only show ticks on sent messages */

  /* Actions Menu */
  .message:hover .msg-actions { opacity: 1; pointer-events: auto; }
  .msg-actions {
    position: absolute; top: -25px; right: 0; opacity: 0; transition: opacity 0.2s;
    background: var(--card-bg); padding: 4px 8px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    z-index: 10; display: flex; gap: 8px;
  }
  .sent .msg-actions { left: 0; right: auto; }
  .msg-actions i { font-size: 12px; cursor: pointer; color: var(--secondary-text); }
  .msg-actions i:hover { color: var(--primary); }

  .reply-preview { font-size: 11px; background: rgba(0,0,0,0.1); padding: 4px; border-left: 3px solid var(--secondary-text); margin-bottom: 4px; border-radius: 4px; }
  .sent .reply-preview { background: rgba(255,255,255,0.2); border-left-color: white; }

  .input-area { padding: 10px 15px; background: var(--card-bg); border-top: 1px solid var(--border-color); }
  
  .input-controls { display: flex; align-items: center; gap: 10px; }
  
  /* 4. AI TOGGLE STYLING */
  .ai-switch-container { display: flex; align-items: center; gap: 5px; margin-right: 5px; }
  .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
  .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: var(--ai-color); }
  input:checked + .slider:before { transform: translateX(14px); }
  .ai-logo { font-weight: 900; color: var(--ai-color); font-size: 16px; font-family: sans-serif; }

  .input-icon-btn { background: none; border: none; font-size: 20px; color: var(--secondary-text); cursor: pointer; padding: 5px; }
  .input-icon-btn:hover { color: var(--primary); }

  .message-input {
    flex: 1; padding: 10px 15px; border-radius: 20px; border: 1px solid var(--border-color);
    background: var(--bg-color); outline: none; margin: 0 10px; resize: none; height: 44px; color: var(--text-color);
  }
  
  .send-btn { background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }

  /* 3. WALLPAPER GRID */
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
  .modal-content { background: var(--card-bg); padding: 20px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
  .wallpaper-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
  .wallpaper-option {
    height: 80px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;
    display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; text-shadow: 1px 1px 3px black; background-size: cover; background-position: center; font-size: 10px; text-align: center;
  }
  .wallpaper-option:hover { border-color: var(--primary); transform: scale(1.05); transition: 0.2s; }

  #emojiContainer { position: absolute; bottom: 70px; left: 60px; z-index: 100; display: none; }
  
  .edit-indicator { font-size: 10px; font-style: italic; opacity: 0.7; }

  /* --- MOBILE RESPONSIVENESS UPDATES --- */
  @media (max-width: 768px) {
    /* Menu visibility toggle */
    .sidebar { 
        width: 250px; 
        position: fixed; 
        top: 0; 
        left: 0; 
        height: 100%; 
        z-index: 3000; 
        transform: translateX(-250px);
    }
    .sidebar.sidebar-mobile-visible {
        transform: translateX(0);
    }
    
    .chat-interface {
        /* Prevents the chat list from shifting when the menu opens */
        position: relative; 
        width: 100%;
    }
    .conversations-sidebar { 
        width: 100%; 
    }
    
    /* Show Menu Button */
    .menu-btn-mobile { 
        display: block; 
    }
    
    .search-header { 
        justify-content: space-between; 
    }
    .search-header h3 {
        flex-grow: 1;
    }

    /* Chat Area Management */
    .chat-area { 
        display: none; 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        z-index: 1000; 
    }
    .chat-area.active { 
        display: flex; 
    }
    .back-btn { 
        display: inline-block !important; 
        margin-right: 10px; 
    }
    .wallpaper-grid { 
        grid-template-columns: repeat(2, 1fr); 
    }
  }
  .back-btn { display: none; background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-color); }
</style>
</head>
<body>

<div class="app-container">
  <div class="sidebar" id="appSidebar">
    <h2>MEET</h2>
    <ul>
      <li><a href="feed.html"><i class="fas fa-home"></i> Feed</a></li>
      <li>
          <a href="chat.html" class="active">
              <i class="fas fa-comment"></i> Chat
              <span class="nav-badge" id="sidebarBadge"></span> </a>
      </li>
      <li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
      <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
    </ul>
  </div>

  <div class="chat-interface">
    <div class="conversations-sidebar" id="convSidebar">
      <div class="search-container">
        <div class="search-header">
            <button class="menu-btn-mobile" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <h3>Messages</h3>
            <button class="new-chat-btn" onclick="openUserSearch()"><i class="fas fa-plus"></i></button>
        </div>
        <input type="text" class="search-input" id="chatSearch" placeholder="Search chats...">
      </div>
      <div class="conversations-list" id="conversationsList"></div>
    </div>

    <div class="chat-area" id="chatArea">
      <div id="emptyState" style="flex:1; display:flex; align-items:center; justify-content:center; color:#888;">
        <div>
          <i class="fas fa-comments" style="font-size:50px; display:block; text-align:center; margin-bottom:10px;"></i>
          <p>Select a chat to start messaging</p>
        </div>
      </div>

      <div class="chat-header" id="chatHeader" style="display:none;">
        <div class="chat-header-user">
          <button class="back-btn" onclick="closeChat()"><i class="fas fa-arrow-left"></i></button>
          <img src="" class="header-avatar" id="headerAvatar">
          <div class="header-info">
             <span style="font-weight:600;" id="headerName">User</span>
             <span class="typing-status" id="typingStatus">Typing...</span>
          </div>
        </div>
        <div class="header-actions">
          <button title="Voice Call"><i class="fas fa-phone"></i></button>
          <button title="Video Call"><i class="fas fa-video"></i></button>
          <button title="Wallpaper Settings" onclick="openWallpaperModal()"><i class="fas fa-cog"></i></button>
        </div>
      </div>

      <div class="messages-wrapper" id="messagesWrapper" style="display:none;"></div>

      <div id="emojiContainer"></div>

      <div class="input-area" id="inputArea" style="display:none;">
        <div id="contextPreview" style="display:none; background:#eee; padding:5px 10px; margin-bottom:5px; border-radius:5px; font-size:12px; justify-content:space-between;">
           <span id="contextText">Editing...</span> 
           <i class="fas fa-times" style="cursor:pointer;" onclick="cancelContext()"></i>
        </div>

        <div class="input-controls">
          <div class="ai-switch-container" title="AI Auto-Reply">
             <label class="switch">
               <input type="checkbox" id="aiToggle"> <span class="slider"></span>
             </label>
             <span class="ai-logo">M</span>
          </div>

          <button class="input-icon-btn" onclick="toggleEmoji()"><i class="far fa-smile"></i></button>
          <input type="file" id="imageInput" accept="image/*,video/*" style="display:none" onchange="handleImageUpload(this)"> <button class="input-icon-btn" onclick="document.getElementById('imageInput').click()"><i class="far fa-image"></i></button>
          <button class="input-icon-btn" title="Voice Note"><i class="fas fa-microphone"></i></button>

          <textarea class="message-input" id="messageInput" placeholder="Type a message..."></textarea>
          <button class="send-btn" id="sendBtn"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="wallpaperModal">
  <div class="modal-content">
    <h3>Chat Wallpaper</h3>
    <div class="wallpaper-grid" id="wallpaperGrid">
       </div>
    <button onclick="document.getElementById('wallpaperModal').style.display='none'" style="margin-top:15px; width:100%; padding:10px; background:var(--primary); color:white; border:none; border-radius:6px;">Close</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDoc, getDocs, onSnapshot, serverTimestamp, query, orderBy, where, setDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
    authDomain: "meet-6e159.firebaseapp.com",
    databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",
    projectId: "meet-6e159",
    storageBucket: "meet-6e159.firebasestorage.app",
    messagingSenderId: "252353608421",
    appId: "1:252353608421:web:6706056048e9a8f12db20c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  
  const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/dcwof2ngn/upload`;
  const CLOUDINARY_PRESET = 'Meet_video';

  let currentUser = null;
  let currentUserData = null; // Store full user profile
  let currentChatId = null;
  let editingMessageId = null;
  let replyToId = null;
  let picker = null;
  let typingTimeout = null;

  // Mobile Menu Toggle Function
  window.toggleSidebar = () => {
      document.getElementById('appSidebar').classList.toggle('sidebar-mobile-visible');
  }

  // 3. Wallpapers Data (50+ options expanded with AI themes)
  const wallpapers = [
      { name: "Default", val: "var(--bg-color)" },
      { name: "MEET 3D", val: "linear-gradient(135deg, #00C6FF, #0072ff)" },
      // --- Wallpaper Fix: Added background-repeat: no-repeat; to URL vals ---
      { name: "AI Cyberpunk", val: "url('https://source.unsplash.com/random/800x600/?cyberpunk,neon') no-repeat center center" },
      { name: "AI Abstract Art", val: "url('https://source.unsplash.com/random/800x600/?abstract,digital,art') no-repeat center center" },
      { name: "Love Heart", val: "url('https://source.unsplash.com/random/800x600/?love,heart') no-repeat center center" },
      { name: "War Zone", val: "url('https://source.unsplash.com/random/800x600/?war,city,destruction') no-repeat center center" },
      { name: "AI Minimalist", val: "url('https://source.unsplash.com/random/800x600/?minimal,pastel,geometric') no-repeat center center" },
      { name: "Dark Space", val: "#1a1a1a" },
      { name: "Sunset", val: "linear-gradient(to right, #ff7e5f, #feb47b)" },
      { name: "Ocean Wave", val: "linear-gradient(to right, #2b5876, #4e4376)" },
      { name: "Forest Nature", val: "url('https://source.unsplash.com/random/800x600/?forest,nature') no-repeat center center" },
      { name: "New York City", val: "url('https://source.unsplash.com/random/800x600/?newyork,city') no-repeat center center" },
      { name: "AI Sci-Fi", val: "url('https://source.unsplash.com/random/800x600/?sci-fi,future') no-repeat center center" },
      { name: "Purple Mist", val: "linear-gradient(to top, #30cfd0 0%, #330867 100%)" },
      { name: "Midnight Black", val: "#000000" },
      { name: "Clean White", val: "#ffffff" },
      { name: "Beige Tan", val: "#f5f5dc" },
      { name: "Deep Galaxy", val: "url('https://source.unsplash.com/random/800x600/?deep,galaxy') no-repeat center center" },
      { name: "Rain Drops", val: "url('https://source.unsplash.com/random/800x600/?rain,window') no-repeat center center" },
      { name: "Minimal Grey", val: "#e0e0e0" },
      { name: "Cyber Matrix", val: "linear-gradient(45deg, #ff00cc, #333399)" },
      { name: "AI Fantasy", val: "url('https://source.unsplash.com/random/800x600/?fantasy,medieval,magic') no-repeat center center" },
      { name: "AI Watercolor", val: "url('https://source.unsplash.com/random/800x600/?watercolor,painting') no-repeat center center" },
      { name: "AI Lava Flow", val: "url('https://source.unsplash.com/random/800x600/?lava,volcano') no-repeat center center" },
      { name: "AI Gold Marble", val: "url('https://source.unsplash.com/random/800x600/?gold,marble,texture') no-repeat center center" },
      { name: "AI Sketch", val: "url('https://source.unsplash.com/random/800x600/?pencil,sketch') no-repeat center center" },
      { name: "AI Retro Wave", val: "url('https://source.unsplash.com/random/800x600/?retrowave,80s') no-repeat center center" },
      { name: "AI Pastel Dreams", val: "url('https://source.unsplash.com/random/800x600/?pastel,clouds') no-repeat center center" },
      { name: "AI Geometric", val: "url('https://source.unsplash.com/random/800x600/?geometric,pattern') no-repeat center center" },
      { name: "AI Space Station", val: "url('https://source.unsplash.com/random/800x600/?space,station') no-repeat center center" },
      { name: "Crimson Red", val: "#dc143c" },
      { name: "Emerald Green", val: "#50c878" },
      { name: "Royal Blue", val: "#4169e1" },
      { name: "Golden Yellow", val: "#ffc300" },
      { name: "Silver", val: "#c0c0c0" },
      { name: "Bronze", val: "#cd7f32" },
      { name: "Gradient Pink", val: "linear-gradient(to right, #ff9a9e, #fad0c4)" },
      { name: "Gradient Ocean", val: "linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%)" },
      { name: "Gradient Sunset", val: "linear-gradient(to right, #f77062 0%, #fe5196 100%)" },
      { name: "Gradient Forest", val: "linear-gradient(to top, #00c6fb 0%, #005bea 100%)" },
      { name: "AI Bokeh", val: "url('https://source.unsplash.com/random/800x600/?bokeh,lights') no-repeat center center" },
      { name: "AI Abstract Paint", val: "url('https://source.unsplash.com/random/800x600/?abstract,oil,paint') no-repeat center center" },
      { name: "AI Dark Moody", val: "url('https://source.unsplash.com/random/800x600/?dark,moody') no-repeat center center" },
      { name: "AI Glitch", val: "url('https://source.unsplash.com/random/800x600/?glitch,broken,screen') no-repeat center center" },
      { name: "AI Vaporwave", val: "url('https://source.unsplash.com/random/800x600/?vaporwave,statue') no-repeat center center" },
      { name: "AI Isometric", val: "url('https://source.unsplash.com/random/800x600/?isometric,building') no-repeat center center" },
      { name: "AI Neon Animals", val: "url('https://source.unsplash.com/random/800x600/?neon,animal') no-repeat center center" },
      { name: "AI Mountain", val: "url('https://source.unsplash.com/random/800x600/?mountain,landscape') no-repeat center center" },
      { name: "AI Car Race", val: "url('https://source.unsplash.com/random/800x600/?race,car') no-repeat center center" },
      { name: "AI Flower Field", val: "url('https://source.unsplash.com/random/800x600/?flower,field') no-repeat center center" },
  ];

  // Init Emoji
  const emojiContainer = document.getElementById('emojiContainer');
  picker = picmo.createPicker({ rootElement: emojiContainer });
  picker.addEventListener('emoji:select', selection => {
    document.getElementById('messageInput').value += selection.emoji;
    emojiContainer.style.display = 'none';
  });
  window.toggleEmoji = () => {
      emojiContainer.style.display = emojiContainer.style.display === 'block' ? 'none' : 'block';
  }

  // Auth & Load
  onAuthStateChanged(auth, async user => {
    if(!user) window.location.href = 'login.html';
    else {
        currentUser = user;
        // Fetch full profile for Avatar
        const docSnap = await getDoc(doc(db, "users", user.uid));
        currentUserData = docSnap.exists() ? docSnap.data() : { photoURL: user.photoURL };
        
        loadConversations();
        updateUserStatus(true);
        initWallpapers();
        
        const savedWP = localStorage.getItem('meet_wallpaper');
        if(savedWP) {
            document.getElementById('chatArea').style.background = savedWP;
            document.getElementById('chatArea').style.backgroundSize = 'cover';
            document.getElementById('chatArea').style.backgroundPosition = 'center';
        }
    }
  });

  function initWallpapers() {
      const grid = document.getElementById('wallpaperGrid');
      grid.innerHTML = '';
      wallpapers.forEach(wp => {
          const div = document.createElement('div');
          div.className = 'wallpaper-option';
          div.innerText = wp.name;
          
          // Wallpaper Fix: Correctly apply background for both color/gradient and URL
          div.style.background = wp.val; 
          div.style.backgroundSize = 'cover';
          
          div.onclick = () => {
              const styleVal = div.style.background;
              document.getElementById('chatArea').style.background = styleVal;
              document.getElementById('chatArea').style.backgroundSize = 'cover';
              document.getElementById('chatArea').style.backgroundPosition = 'center';
              localStorage.setItem('meet_wallpaper', styleVal);
              document.getElementById('wallpaperModal').style.display = 'none';
          };
          grid.appendChild(div);
      });
  }

  function loadConversations() {
    const q = query(collection(db, "conversations"), where("participants", "array-contains", currentUser.uid));
    onSnapshot(q, snap => {
        const list = document.getElementById('conversationsList');
        list.innerHTML = '';
        let hasUnread = false; 

        snap.forEach(d => {
            const chat = { id: d.id, ...d.data() };
            const otherId = chat.participants.find(id => id !== currentUser.uid);
            const name = chat.participantNames?.[otherId] || 'User';
            const avatar = chat.participantAvatars?.[otherId] || 'https://via.placeholder.com/50';
            
            const status = chat.status?.[otherId];
            const isOnline = status?.isOnline || false;
            
            const isUnread = chat.lastMessageSender !== currentUser.uid && !chat.readBy?.[currentUser.uid];
            if(isUnread) hasUnread = true;

            const item = document.createElement('div');
            item.className = `conversation-item ${currentChatId === chat.id ? 'active' : ''}`;
            if(isUnread) item.style.fontWeight = 'bold';
            
            item.onclick = () => loadChat(chat.id, otherId, name, avatar);
            item.innerHTML = `
                <div class="avatar-container">
                    <img src="${avatar}" class="conv-avatar">
                    <div class="status-dot ${isOnline ? 'is-online' : 'is-offline'}"></div>
                </div>
                <div class="conv-info">
                    <div class="conv-name">${name}</div>
                    <div class="conv-preview">
                        <span>${chat.lastMessage || ''}</span>
                        ${isUnread ? '<i class="fas fa-circle" style="color:red; font-size:8px;"></i>' : ''}
                    </div>
                </div>
            `;
            list.appendChild(item);
        });
        
        document.getElementById('sidebarBadge').style.display = hasUnread ? 'block' : 'none';
    });
  }

  window.loadChat = async (chatId, userId, name, avatar) => {
      currentChatId = chatId;
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('chatHeader').style.display = 'flex';
      document.getElementById('messagesWrapper').style.display = 'flex';
      document.getElementById('inputArea').style.display = 'block';
      document.getElementById('chatArea').classList.add('active'); 
      document.getElementById('appSidebar').classList.remove('sidebar-mobile-visible'); // Hide menu on chat load (mobile)

      document.getElementById('headerAvatar').src = avatar;
      document.getElementById('headerName').innerText = name;

      // Mark as read
      await updateDoc(doc(db, "conversations", chatId), {
          [`readBy.${currentUser.uid}`]: true
      });

      loadMessages(chatId);
      watchTyping(chatId, userId);
  }
  
  // Storage for the last message ID to prevent AI re-replying on redraw
  let lastProcessedMessageId = null;

  function loadMessages(chatId) {
      const q = query(collection(db, "conversations", chatId, "messages"), orderBy("timestamp", "asc"));
      onSnapshot(q, snap => {
          const wrapper = document.getElementById('messagesWrapper');
          wrapper.innerHTML = '';
          snap.forEach(d => {
              const msg = { id: d.id, ...d.data() };
              const isMe = msg.senderId === currentUser.uid;
              
              const myAvatar = currentUserData.photoURL || `https://ui-avatars.com/api/?name=${currentUser.displayName}`;
              const otherAvatar = document.getElementById('headerAvatar').src;
              const avatarSrc = isMe ? myAvatar : otherAvatar;

              let ticksHtml = '';
              if(isMe) {
                  let tickClass = 'tick-sent'; 
                  let tickIcon = '<i class="fas fa-check"></i>';
                  
                  if(msg.read) { 
                      tickClass = 'tick-read'; 
                      tickIcon = '<i class="fas fa-check-double"></i> <i class="fas fa-check" style="margin-left:-8px"></i>'; 
                  } else if (msg.delivered) { 
                      tickClass = 'tick-delivered'; 
                      tickIcon = '<i class="fas fa-check-double"></i>';
                  }
                  ticksHtml = `<span class="ticks ${tickClass}">${tickIcon}</span>`;
              }

              const div = document.createElement('div');
              div.className = `message ${isMe ? 'sent' : 'received'}`;
              
              let actions = `
                  <div class="msg-actions">
                      <i class="fas fa-reply" onclick="startReply('${msg.id}', '${msg.text ? msg.text.replace(/'/g, "\\'") : "Media"}')"></i>
                      ${isMe ? `<i class="fas fa-edit" onclick="startEdit('${msg.id}', '${msg.text ? msg.text.replace(/'/g, "\\'") : ""}')"></i>
                                <i class="fas fa-trash" onclick="deleteMsg('${msg.id}')"></i>` : ''}
                  </div>`;

              let content = '';
              if(msg.replyTo) content += `<div class="reply-preview"><small>Replying to:</small> ${msg.replyTo}</div>`;
              
              if(msg.imageUrl) {
                  if (msg.mediaType === 'video') {
                      content += `<video src="${msg.imageUrl}" class="msg-media" controls></video>`;
                  } else {
                      content += `<img src="${msg.imageUrl}" class="msg-media" onclick="window.open(this.src)">`;
                  }
              }

              if(msg.text) content += `<span>${msg.text}</span>`;
              
              if(msg.isAI) content += `<br><br><em style="font-size:10px; color:${getComputedStyle(document.documentElement).getPropertyValue('--ai-color')};">......this message is written by ai</em>`;
              if(msg.edited) content += `<br><i class="edit-indicator">(edited)</i>`;

              div.innerHTML = `
                  <img src="${avatarSrc}" class="msg-avatar">
                  <div class="message-bubble">
                      ${content}
                      <div class="msg-meta">
                          <span class="message-time">${formatTime(msg.timestamp)}</span>
                          ${ticksHtml}
                      </div>
                      ${actions}
                  </div>
              `;
              wrapper.appendChild(div);
              
              // NEW AI LOGIC: Check for incoming messages
              if (!isMe && msg.id !== lastProcessedMessageId) {
                  if (document.getElementById('aiToggle').checked) {
                      // Trigger AI reply only if the toggle is on AND it's a new, incoming message
                      handleIncomingMessage(msg.text); 
                  }
                  lastProcessedMessageId = msg.id; // Mark as processed
              }
          });
          wrapper.scrollTop = wrapper.scrollHeight;
      });
  }

  // New function to handle AI replies based on incoming messages
  async function handleIncomingMessage(incomingText) {
      if (!currentChatId) return;

      // 4. AI REPLY LOGIC - only replies to incoming messages
      setTimeout(async () => {
          const reply = getSmartReply(incomingText);
          
          await addDoc(collection(db, "conversations", currentChatId, "messages"), {
               text: reply,
               senderId: currentUser.uid, // Sent *as* the user with AI flag
               timestamp: serverTimestamp(),
               isAI: true, // Flag it as an AI-generated message
               type: 'text',
               read: false
           });
           
           // Update Conversation Metadata
           await updateDoc(doc(db, "conversations", currentChatId), {
               lastMessage: reply,
               lastMessageSender: currentUser.uid, // This makes the AI message the "last message"
               updatedAt: serverTimestamp()
           });

      }, 3000); // 3 Seconds Delay
  }


  // Typing Indicator Listener
  function watchTyping(chatId, otherUserId) {
      onSnapshot(doc(db, "conversations", chatId), (doc) => {
          if(doc.exists()) {
              const data = doc.data();
              const isTyping = data.typing?.[otherUserId];
              const el = document.getElementById('typingStatus');
              el.style.display = isTyping ? 'inline' : 'none';
          }
      });
  }

  // Input Typing Trigger
  document.getElementById('messageInput').addEventListener('input', () => {
      if(!currentChatId) return;
      // Set typing true
      updateDoc(doc(db, "conversations", currentChatId), { [`typing.${currentUser.uid}`]: true });
      
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
          updateDoc(doc(db, "conversations", currentChatId), { [`typing.${currentUser.uid}`]: false });
      }, 1000);
  });

  // 4. SMART AI REPLY GENERATOR
  function getSmartReply(userText) {
      const lower = userText.toLowerCase();
      if(lower.includes('hello') || lower.includes('hi')) return "Hello there! I'm currently set to auto-reply. How can I assist you?";
      if(lower.includes('how are you')) return "I'm running smoothly, thanks for asking! What were you hoping to chat about?";
      if(lower.includes('price') || lower.includes('cost')) return "That sounds like a topic for a human associate. Can you rephrase or wait for a direct response?";
      if(lower.includes('meet') || lower.includes('platform')) return "MEET is the future of connections! Is there something specific about the platform I can clarify?";
      if(lower.includes('thanks') || lower.includes('thank you')) return "No problem at all! Happy to help with a quick auto-response.";
      if(lower.includes('help')) return "This is an automated reply. Please send a brief message, or wait for the user to disable the AI mode for a manual reply.";
      if(lower.includes('bye') || lower.includes('goodbye')) return "Auto-reply saying goodbye! Talk to you later (or wait for my human boss).";
      return "Received! The user has auto-reply activated and will likely see your message shortly. I'm just bridging the gap for now.";
  }

  document.getElementById('sendBtn').onclick = sendMessage;
  async function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      // NOTE: AI toggle status is now only used in handleIncomingMessage

      if(!text && !editingMessageId) return;

      if(editingMessageId) {
          // EDIT MESSAGE
          await updateDoc(doc(db, "conversations", currentChatId, "messages", editingMessageId), {
              text: text, edited: true
          });
          cancelContext();
      } else {
          // SEND NEW (always sent as user)
          let payload = {
              text: text,
              senderId: currentUser.uid,
              timestamp: serverTimestamp(),
              type: 'text',
              read: false
          };
          
          if(replyToId) {
              payload.replyTo = document.getElementById('contextText').innerText.replace('Replying to: ', '');
          }

          await addDoc(collection(db, "conversations", currentChatId, "messages"), payload);
          
          // Update Conversation Metadata
          await updateDoc(doc(db, "conversations", currentChatId), {
              lastMessage: text,
              lastMessageSender: currentUser.uid,
              [`readBy.${currentUser.uid}`]: true,
              updatedAt: serverTimestamp()
          });

          cancelContext();
          // NO AI REPLY HERE - AI only replies to incoming messages (handled in loadMessages)
      }
      input.value = '';
  }

  // ACTION HANDLERS
  window.startEdit = (id, text) => {
      editingMessageId = id;
      document.getElementById('messageInput').value = text;
      document.getElementById('contextPreview').style.display = 'flex';
      document.getElementById('contextText').innerText = "Editing message...";
      document.getElementById('messageInput').focus();
  }
  
  window.startReply = (id, text) => {
      replyToId = id;
      document.getElementById('contextPreview').style.display = 'flex';
      document.getElementById('contextText').innerText = "Replying to: " + text.substring(0, 30) + "...";
      document.getElementById('messageInput').focus();
  }

  window.cancelContext = () => {
      editingMessageId = null;
      replyToId = null;
      document.getElementById('messageInput').value = '';
      document.getElementById('contextPreview').style.display = 'none';
  }

  window.deleteMsg = async (id) => {
      if(confirm('Delete this message?')) await deleteDoc(doc(db, "conversations", currentChatId, "messages", id));
  }

  // 6. MEDIA UPLOAD (Image/Video)
  window.handleImageUpload = async (input) => {
      const file = input.files[0];
      if(!file) return;
      
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", CLOUDINARY_PRESET);
      
      const mediaType = file.type.startsWith('video') ? 'video' : 'image';
      
      try {
          document.getElementById('messageInput').placeholder = `Uploading ${mediaType}...`;
          
          // Cloudinary handles compression and URL generation for both
          const res = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
          const data = await res.json();
          
          await addDoc(collection(db, "conversations", currentChatId, "messages"), {
              imageUrl: data.secure_url,
              mediaType: mediaType,
              senderId: currentUser.uid,
              timestamp: serverTimestamp(),
              type: mediaType,
              read: false
          });
          
          // Update Conversation Metadata
          await updateDoc(doc(db, "conversations", currentChatId), {
              lastMessage: `[${mediaType.charAt(0).toUpperCase() + mediaType.slice(1)}]`,
              lastMessageSender: currentUser.uid,
              updatedAt: serverTimestamp()
          });

          document.getElementById('messageInput').placeholder = "Type a message...";
          input.value = ''; // Clear file input
      } catch(e) { 
          console.error(e); 
          document.getElementById('messageInput').placeholder = "Upload failed.";
      }
  }

  // Wallpapers
  window.openWallpaperModal = () => document.getElementById('wallpaperModal').style.display = 'flex';

  window.closeChat = () => document.getElementById('chatArea').classList.remove('active');
  document.getElementById('logoutBtn').onclick = () => signOut(auth);
  
  function formatTime(timestamp) {
      if(!timestamp) return '';
      const date = timestamp.toDate ? timestamp.toDate() : new Date();
      return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }

  async function updateUserStatus(isOnline) {
    if (!auth.currentUser) return;
    try {
        await updateDoc(doc(db, "users", auth.currentUser.uid), { isOnline: isOnline, lastActive: serverTimestamp() });
    } catch (e) {}
  }
</script>
</body>
</html>
