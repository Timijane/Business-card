<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Professional Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary: #0080FF;
    --primary-dark: #0066CC;
    --bg-color: #f0f2f5;
    --card-bg: #fff;
    --text-color: #111;
    --secondary-text: #65676b;
    --border-color: #dddfe2;
    --error: #EF4444;
    --success: #10B981;
    --warning: #F59E0B;
    --app-height: 100dvh;
    --chat-font: 'Poppins', sans-serif;
    --sent-bubble-bg: #0080FF;
    --sent-text-color: #fff;
    --received-bubble-bg: #fff;
    --received-text-color: #111;
    --shadow-light: 0 2px 10px rgba(0,0,0,0.05);
    --shadow-medium: 0 4px 15px rgba(0,128,255,0.2);
    --shadow-heavy: 0 10px 40px rgba(0,0,0,0.2);
    --chat-container-width: 100%;
  }

  @media (min-width: 1200px) {
    :root {
      --chat-container-width: 70%;
    }
  }

  body.dark-mode {
    --bg-color: #0f0f10;
    --card-bg: #1e1e1e;
    --text-color: #e4e6eb;
    --secondary-text: #b0b3b8;
    --border-color: #2f3031;
    --received-bubble-bg: #2a2b2c;
    --received-text-color: #e4e6eb;
  }

  * { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
    -webkit-tap-highlight-color: transparent; 
  }

  html, body { 
    height: 100%; 
    overflow: hidden; 
    font-size: 14px; 
    font-family: var(--chat-font); 
    background: var(--bg-color); 
    color: var(--text-color); 
    transition: all 0.3s ease;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .app-container { 
    display: flex; 
    height: var(--app-height); 
    position: relative; 
    overflow: hidden; 
  }

  .main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: hidden;
    padding: 12px;
    align-items: center;
  }

  .sidebar {
    position: fixed; 
    top: 0; 
    left: 0; 
    height: 100%; 
    width: 280px;
    background: linear-gradient(180deg, #0080FF 0%, #00C6FF 100%);
    z-index: 200; 
    padding: 25px; 
    color: white;
    transform: translateX(-100%); 
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 4px 0 20px rgba(0,0,0,0.15);
  }
  .sidebar.open { transform: translateX(0); }
  
  .sidebar-header { 
    padding-bottom: 25px; 
    border-bottom: 1px solid rgba(255,255,255,0.2); 
    margin-bottom: 25px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center;
  }
  
  .sidebar-header h2 {
    font-family: 'Montserrat', sans-serif;
    letter-spacing: 2px;
    font-weight: 700;
    font-size: 24px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  
  .sidebar-menu { list-style: none; }
  .sidebar-menu li { margin-bottom: 12px; position: relative; }
  
  .notification-badge {
    position: absolute;
    top: -5px;
    right: 10px;
    background: var(--error);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    display: none;
    align-items: center;
    justify-content: center;
    font-weight: 600;
  }
  
  .sidebar-menu a { 
    display: flex; 
    align-items: center; 
    padding: 16px 12px; 
    text-decoration: none; 
    color: white; 
    border-radius: 12px; 
    font-size: 16px; 
    font-weight: 500;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .sidebar-menu a::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 0;
    height: 100%;
    background: rgba(255, 255, 255, 0.2);
    transition: width 0.3s ease;
    z-index: -1;
  }
  
  .sidebar-menu a:hover::before { width: 100%; }
  .sidebar-menu a:hover { 
    transform: translateX(8px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }
  .sidebar-menu a.active {
    background: rgba(255, 255, 255, 0.25);
    font-weight: 600;
  }
  
  .sidebar-menu i { 
    margin-right: 15px; 
    font-size: 20px; 
    width: 28px; 
    text-align: center; 
  }
  
  .sidebar-overlay { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.6); 
    z-index: 190; 
    transition: all 0.3s ease;
  }
  .sidebar-overlay.active { display: block; }

  .navbar {
    background: linear-gradient(135deg, #0080FF 0%, #00C6FF 100%);
    padding: 12px 20px; /* Reduced padding */
    border-radius: 16px; 
    margin-bottom: 12px;
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    color: white; 
    flex-shrink: 0; 
    box-shadow: var(--shadow-medium);
    position: relative;
    overflow: hidden;
    width: var(--chat-container-width);
    max-width: 1200px;
  }
  
  .navbar::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(45deg, rgba(255,255,255,0.1), transparent);
    pointer-events: none;
  }
  
  .navbar-left { display: flex; align-items: center; gap: 20px; }
  .navbar-right { display: flex; align-items: center; gap: 12px; }
  
  .hamburger-btn { 
    background: none; 
    border: none; 
    color: white; 
    font-size: 24px; 
    cursor: pointer; 
    padding: 8px;
    border-radius: 8px;
    transition: all 0.2s ease;
  }
  .hamburger-btn:hover {
    background: rgba(255,255,255,0.2);
    transform: scale(1.1);
  }
  
  .nav-user-img { 
    width: 40px; /* Reduced size */
    height: 40px; /* Reduced size */
    border-radius: 50%; 
    border: 2px solid rgba(255,255,255,0.9); /* Reduced border */
    object-fit: cover;
    transition: all 0.2s ease;
  }
  .nav-user-img:hover {
    transform: scale(1.05);
    border-color: rgba(255,255,255,1);
  }
  
  .nav-user-name {
    font-weight: 600;
    font-size: 14px; /* Reduced font size */
    margin-left: 8px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }
  
  .btn { 
    background: rgba(255, 255, 255, 0.2); 
    color: white; 
    border: none; 
    padding: 8px 12px; /* Reduced padding */
    border-radius: 10px; 
    cursor: pointer; 
    font-size: 13px; /* Reduced font size */
    font-weight: 500;
    display: flex; 
    align-items: center; 
    gap: 6px; /* Reduced gap */
    transition: all 0.2s ease; 
  }
  .btn:hover { 
    background: rgba(255, 255, 255, 0.3); 
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  .chat-container { 
    flex: 1; 
    background: var(--card-bg); 
    border-radius: 16px; 
    overflow: hidden; 
    display: flex; 
    min-height: 0; 
    position: relative; 
    box-shadow: var(--shadow-light); 
    border: 1px solid var(--border-color);
    width: var(--chat-container-width);
    max-width: 1200px;
  }
  
  .conversations-sidebar { 
    width: 340px; 
    border-right: 1px solid var(--border-color); 
    display: flex; 
    flex-direction: column; 
    height: 100%; 
    background: var(--card-bg); 
  }
  
  .chat-header { 
    padding: 15px; /* Reduced padding */
    border-bottom: 1px solid var(--border-color); 
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    background: linear-gradient(135deg, var(--card-bg) 0%, var(--bg-color) 100%);
  }
  
  .chat-header h3 {
    font-size: 18px; /* Reduced font size */
    font-weight: 700;
    color: var(--text-color);
  }
  
  .new-chat-btn { 
    background: linear-gradient(135deg, #0080FF 0%, #0066CC 100%); 
    color: white; 
    border: none; 
    width: 36px; /* Reduced size */
    height: 36px; /* Reduced size */
    border-radius: 50%; 
    cursor: pointer; 
    transition: all 0.2s ease; 
    box-shadow: 0 4px 12px rgba(0,128,255,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px; /* Reduced font size */
  }
  .new-chat-btn:hover { 
    transform: scale(1.1) rotate(90deg); 
    box-shadow: 0 6px 20px rgba(0,128,255,0.6);
  }
  
  .chat-search { 
    padding: 12px; /* Reduced padding */
    border-bottom: 1px solid var(--border-color); 
    background: var(--bg-color);
  }
  .chat-search input { 
    width: 100%; 
    padding: 10px 16px; /* Reduced padding */
    border-radius: 25px; 
    border: 2px solid var(--border-color); 
    background: var(--card-bg); 
    color: var(--text-color); 
    outline: none; 
    transition: all 0.3s ease; 
    font-size: 14px; /* Reduced font size */
  }
  .chat-search input:focus { 
    border-color: var(--primary); 
    box-shadow: 0 0 0 3px rgba(0,128,255,0.1); 
    transform: translateY(-1px);
  }
  
  .conversations-list { 
    flex: 1; 
    overflow-y: auto; 
    scroll-behavior: smooth;
  }
  
  .conversation-item { 
    display: flex; 
    align-items: center; 
    gap: 12px; /* Reduced gap */
    padding: 14px 16px; /* Reduced padding */
    cursor: pointer; 
    border-bottom: 1px solid var(--border-color); 
    transition: all 0.3s ease; 
    position: relative;
    overflow: hidden;
  }
  
  .conversation-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    width: 0;
    height: 100%;
    background: linear-gradient(90deg, var(--primary), transparent);
    transition: width 0.3s ease;
    z-index: 1;
  }
  
  .conversation-item:hover::before,
  .conversation-item.active::before { 
    width: 4px;
  }
  
  .conversation-item:hover, 
  .conversation-item.active { 
    background: rgba(0,128,255,0.08); 
    transform: translateX(4px);
  }
  
  .conversation-avatar { 
    width: 45px; /* Reduced size */
    height: 45px; /* Reduced size */
    border-radius: 50%; 
    object-fit: cover; 
    border: 2px solid var(--border-color);
    transition: all 0.2s ease;
  }
  
  .conversation-item:hover .conversation-avatar {
    border-color: var(--primary);
    transform: scale(1.05);
  }
  
  .conversation-info { 
    flex: 1; 
    min-width: 0; 
    position: relative;
    z-index: 2;
  }
  
  .conversation-name { 
    font-weight: 600; 
    font-size: 14px; /* Reduced font size */
    margin-bottom: 3px; /* Reduced margin */
    color: var(--text-color);
  }
  
  .conversation-preview { 
    font-size: 12px; /* Reduced font size */
    color: var(--secondary-text); 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
    line-height: 1.3; /* Reduced line height */
  }

  .unread-count {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    background: var(--primary);
    color: white;
    border-radius: 10px; /* Reduced radius */
    min-width: 18px; /* Reduced size */
    height: 18px; /* Reduced size */
    font-size: 10px; /* Reduced font size */
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 5px; /* Reduced padding */
  }

  .chat-area { 
    flex: 1; 
    display: flex; 
    flex-direction: column; 
    height: 100%; 
    background: var(--bg-color); 
    position: relative; 
  }
  
  .chat-area-header { 
    padding: 10px 15px; /* Reduced padding */
    border-bottom: 1px solid var(--border-color); 
    display: flex; 
    align-items: center; 
    gap: 10px; /* Reduced gap */
    background: var(--card-bg); 
    z-index: 10; 
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    min-height: 60px; /* Reduced height */
  }
  
  .chat-user-info {
    flex: 1;
    margin-left: 8px; /* Reduced margin */
  }
  
  .chat-user-name {
    font-weight: 700;
    font-size: 16px; /* Reduced font size */
    color: var(--text-color);
    margin-bottom: 1px; /* Reduced margin */
  }
  
  .chat-user-status {
    font-size: 11px; /* Reduced font size */
    color: var(--secondary-text);
    opacity: 0.8;
  }
  
  .chat-actions { 
    display: flex; 
    gap: 6px; /* Reduced gap */
    margin-left: auto; 
  }
  
  .chat-action-btn { 
    background: none; 
    border: none; 
    color: var(--secondary-text); 
    font-size: 16px; /* Reduced font size */
    cursor: pointer; 
    transition: all 0.2s ease; 
    padding: 8px; /* Reduced padding */
    border-radius: 50%; 
    width: 36px; /* Reduced size */
    height: 36px; /* Reduced size */
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .chat-action-btn:hover { 
    background: rgba(0,128,255,0.1); 
    color: var(--primary);
    transform: scale(1.1);
  }

  .empty-chat {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--secondary-text);
    text-align: center;
    padding: 40px;
  }
  
  .empty-chat i {
    font-size: 80px;
    opacity: 0.3;
    margin-bottom: 25px;
    color: var(--primary);
  }
  
  .empty-chat h3 {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--text-color);
  }
  
  .empty-chat p {
    font-size: 16px;
    opacity: 0.7;
    max-width: 300px;
    line-height: 1.5;
  }

  .messages-container { 
    flex: 1; 
    padding: 15px; /* Reduced padding */
    overflow-y: auto; 
    display: flex; 
    flex-direction: column; 
    gap: 6px; /* Reduced gap */
    background-size: cover; 
    background-position: center; 
    transition: background 0.3s; 
    scroll-behavior: smooth;
    font-family: var(--chat-font);
    position: relative;
  }

  /* Scroll to bottom button */
  .scroll-to-bottom-btn {
    position: absolute;
    bottom: 20px;
    right: 20px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    border: none;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    box-shadow: var(--shadow-medium);
    z-index: 100;
    transition: all 0.3s ease;
  }
  
  .scroll-to-bottom-btn:hover {
    background: var(--primary-dark);
    transform: scale(1.1);
  }

  .date-divider { 
    text-align: center; 
    margin: 20px 0; /* Reduced margin */
    position: relative; 
    opacity: 0.9; 
  }
  
  .date-divider::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--border-color), transparent);
  }
  
  .date-divider span { 
    background: rgba(0,0,0,0.1); 
    color: white; 
    padding: 5px 12px; /* Reduced padding */
    border-radius: 16px; 
    font-size: 11px; /* Reduced font size */
    font-weight: 600; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    position: relative;
    z-index: 1;
  }

  .message-wrapper { 
    display: flex; 
    gap: 8px; /* Reduced gap */
    max-width: 85%; 
    align-items: flex-end; 
    position: relative; 
    margin-bottom: 8px; /* Reduced margin */
    animation: messageSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
  }
  
  @keyframes messageSlideIn { 
    from { 
      opacity: 0; 
      transform: translateY(10px) scale(0.95); /* Reduced animation */
    } 
    to { 
      opacity: 1; 
      transform: translateY(0) scale(1); 
    } 
  }
  
  .message-wrapper.sent { 
    align-self: flex-end; 
    flex-direction: row-reverse; 
    max-width: 80%; /* Added for better alignment */
  }
  
  .message-wrapper.received {
    align-self: flex-start;
    max-width: 80%; /* Added for better alignment */
  }
  
  .message-avatar-small { 
    width: 28px; /* Reduced size */
    height: 28px; /* Reduced size */
    border-radius: 50%; 
    object-fit: cover; 
    flex-shrink: 0; 
    margin-bottom: 3px; /* Reduced margin */
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    border: 2px solid var(--card-bg);
  }

  .message-bubble { 
    padding: 8px 12px; /* Reduced padding */
    border-radius: 18px; 
    position: relative; 
    word-break: break-word; /* Fix for word splitting */
    overflow-wrap: break-word; /* Fix for word splitting */
    font-size: 14px; /* Reduced font size */
    line-height: 1.4; 
    max-width: 100%; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
    font-family: var(--chat-font);
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
  }
  
  .message-bubble:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  .received .message-bubble { 
    background: var(--received-bubble-bg); 
    border-bottom-left-radius: 6px; 
    color: var(--received-text-color);
    border: 1px solid var(--border-color);
    margin-left: 0; /* Removed left margin */
  }
  
  .sent .message-bubble { 
    background: var(--sent-bubble-bg); 
    color: var(--sent-text-color); 
    border-bottom-right-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,128,255,0.3);
    margin-right: 0; /* Removed right margin */
  }

  .message-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    gap: 8px;
    max-width: 100%;
  }

  .message-text {
    flex: 1;
    word-break: break-word;
    overflow-wrap: break-word;
    line-height: 1.4;
    font-size: 13.5px; /* Reduced font size */
    max-width: calc(100% - 45px); /* Reduced max width */
    white-space: pre-wrap; /* Preserve line breaks */
  }

  .message-text img,
  .message-text video {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 3px; /* Reduced margin */
  }

  .msg-options-btn { 
    opacity: 0; 
    transition: all 0.2s ease; 
    background: var(--card-bg); 
    border: 1px solid var(--border-color); 
    color: var(--secondary-text); 
    cursor: pointer; 
    padding: 5px 7px; /* Reduced padding */
    border-radius: 50%; 
    font-size: 11px; /* Reduced font size */
    align-self: center; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
    margin: 0 6px; /* Reduced margin */
    width: 26px; /* Reduced size */
    height: 26px; /* Reduced size */
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .message-wrapper:hover .msg-options-btn { 
    opacity: 1; 
    transform: scale(1.1);
  }
  
  .msg-options-menu { 
    display: none; 
    position: absolute; 
    top: 100%; 
    right: 0; 
    background: var(--card-bg); 
    border-radius: 12px; 
    box-shadow: 0 8px 32px rgba(0,0,0,0.2); 
    z-index: 100; 
    min-width: 150px; /* Reduced width */
    overflow: hidden; 
    border: 1px solid var(--border-color); 
    animation: menuSlideIn 0.2s ease; 
  }
  
  @keyframes menuSlideIn { 
    from { 
      transform: scale(0.9) translateY(-10px); 
      opacity: 0; 
    } 
    to { 
      transform: scale(1) translateY(0); 
      opacity: 1; 
    } 
  }
  
  .msg-options-menu.active { display: block; }
  
  .msg-option-item { 
    padding: 10px 14px; /* Reduced padding */
    cursor: pointer; 
    font-size: 13px; /* Reduced font size */
    color: var(--text-color); 
    display: flex; 
    align-items: center; 
    gap: 10px; /* Reduced gap */
    transition: all 0.2s ease;
    font-weight: 500;
  }
  
  .msg-option-item:hover { 
    background: rgba(0,128,255,0.08); 
    color: var(--primary); 
  }
  
  .msg-option-item.delete { 
    color: var(--error) !important; 
  }
  
  .msg-option-item.delete:hover { 
    background: rgba(239, 68, 68, 0.1) !important; 
  }

  .reply-preview-bar { 
    display: none; 
    background: rgba(0,128,255,0.08); 
    padding: 10px 15px; /* Reduced padding */
    border-left: 4px solid var(--primary); 
    justify-content: space-between; 
    align-items: center; 
    font-size: 13px; /* Reduced font size */
    margin: 0 12px; /* Reduced margin */
    border-top-left-radius: 12px; 
    border-top-right-radius: 12px;
    animation: slideDown 0.3s ease;
  }
  
  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .reply-preview-content { 
    display: flex; 
    flex-direction: column; 
    gap: 3px; /* Reduced gap */
  }
  
  .reply-name { 
    font-weight: 700; 
    color: var(--primary); 
    font-size: 12px; /* Reduced font size */
  }
  
  .reply-text {
    color: var(--secondary-text);
    font-size: 12px; /* Reduced font size */
  }

  .message-img, .message-video { 
    max-width: 100%; 
    max-height: 250px; /* Reduced max height */
    border-radius: 12px; 
    margin-top: 6px; /* Reduced margin */
    display: block; 
    cursor: pointer; 
    transition: all 0.3s ease; 
  }
  
  .message-img:hover { 
    transform: scale(1.02); 
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
  }
  
  .message-time { 
    font-size: 10px; /* Reduced font size */
    opacity: 0.7; 
    text-align: right; 
    display: block; 
    font-weight: 500;
    white-space: nowrap;
    margin-top: 2px;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  
  /* Read receipt styles */
  .read-receipt {
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  .read-receipt.single-check {
    color: #999;
  }
  
  .read-receipt.double-check {
    color: var(--primary);
  }
  
  .read-receipt.blue-check {
    color: #0080FF;
  }
  
  .upload-overlay { 
    position: absolute; 
    inset: 0; 
    background: rgba(0,0,0,0.6); 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    border-radius: 8px; 
    color: white; 
    font-size: 20px; /* Reduced font size */
  }

  .typing-indicator { 
    display: none; 
    padding: 10px 15px; /* Reduced padding */
    background: var(--card-bg); 
    border-radius: 20px; 
    margin: 12px; /* Reduced margin */
    width: fit-content; 
    align-self: flex-start; 
    font-size: 12px; /* Reduced font size */
    color: var(--secondary-text); 
    font-style: italic; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid var(--border-color);
  }
  
  .typing-indicator span { 
    animation: typingBlink 1.4s infinite both; 
  }
  .typing-indicator span:nth-child(2) { animation-delay: .2s; }
  .typing-indicator span:nth-child(3) { animation-delay: .4s; }
  
  @keyframes typingBlink { 
    0%, 80%, 100% { opacity: .2; } 
    40% { opacity: 1; } 
  }

  .message-input-container { 
    padding: 10px 15px; /* Reduced padding */
    border-top: 1px solid var(--border-color); 
    background: var(--card-bg); 
    position: relative;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    flex-shrink: 0;
  }

  .writing-assist-bar { 
    display: none; 
    gap: 8px; /* Reduced gap */
    margin-bottom: 12px; /* Reduced margin */
    padding: 8px; 
    overflow-x: auto; 
  }
  
  .assist-chip { 
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
    color: white; 
    border: none; 
    padding: 7px 12px; /* Reduced padding */
    border-radius: 25px; 
    font-size: 11px; /* Reduced font size */
    font-weight: 500;
    cursor: pointer; 
    white-space: nowrap; 
    box-shadow: 0 3px 10px rgba(0,0,0,0.2); 
    transition: all 0.2s ease; 
    display: flex; 
    align-items: center; 
    gap: 5px; /* Reduced gap */
  }
  
  .assist-chip:hover { 
    transform: scale(1.05) translateY(-1px); 
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }

  .message-input-wrapper { 
    display: flex; 
    align-items: flex-end; 
    gap: 10px; /* Reduced gap */
  }
  
  .message-input-actions { 
    display: flex; 
    align-items: center; 
    gap: 6px; /* Reduced gap */
    margin-bottom: 6px; /* Reduced margin */
  }
  
  .input-action { 
    background: transparent; 
    border: none; 
    color: var(--secondary-text); 
    cursor: pointer; 
    font-size: 18px; /* Reduced font size */
    padding: 8px; /* Reduced padding */
    border-radius: 50%; 
    transition: all 0.2s ease;
    width: 36px; /* Reduced size */
    height: 36px; /* Reduced size */
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .input-action:hover { 
    color: var(--primary); 
    background: rgba(0,128,255,0.1); 
    transform: scale(1.1);
  }
  
  .input-action.magic-btn { 
    color: #8e2de2; 
  }
  
  .input-action.magic-btn:hover {
    color: #764ba2;
    background: rgba(118, 75, 162, 0.1);
  }

  .message-input { 
    flex: 1; 
    padding: 10px 14px; /* Reduced padding */
    border-radius: 25px; 
    border: 2px solid var(--border-color); 
    background: var(--bg-color); 
    color: var(--text-color); 
    resize: none; 
    font-family: var(--chat-font);
    font-size: 14px; /* Reduced font size */
    max-height: 120px; 
    min-height: 40px; /* Reduced height */
    height: 40px; 
    outline: none; 
    overflow-y: auto; 
    line-height: 1.5; 
    transition: all 0.3s ease;
    box-sizing: border-box;
  }
  
  .message-input:focus { 
    border-color: var(--primary); 
    box-shadow: 0 0 0 3px rgba(0,128,255,0.1); 
    background: var(--card-bg);
    transform: translateY(-1px);
  }
  
  .send-button { 
    background: linear-gradient(135deg, #0080FF 0%, #0066CC 100%); 
    color: white; 
    border: 0; 
    width: 42px; /* Reduced size */
    height: 42px; /* Reduced size */
    border-radius: 50%; 
    cursor: pointer; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    flex-shrink: 0; 
    box-shadow: 0 4px 15px rgba(0,128,255,0.4); 
    transition: all 0.2s ease;
    font-size: 14px; /* Reduced font size */
  }
  
  .send-button:hover { 
    transform: scale(1.05) translateY(-1px); 
    box-shadow: 0 6px 20px rgba(0,128,255,0.6);
  }
  
  .send-button:active {
    transform: scale(0.95);
  }

  .emoji-picker { 
    display: none; 
    position: absolute; 
    bottom: 75px; /* Adjusted position */
    left: 15px; 
    width: 320px; /* Reduced width */
    height: 350px; /* Reduced height */
    background: var(--card-bg); 
    border-radius: 16px; 
    box-shadow: 0 12px 50px rgba(0,0,0,0.25); 
    z-index: 100; 
    overflow: hidden; 
    flex-direction: column; 
    border: 1px solid var(--border-color);
    animation: emojiPickerSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  @keyframes emojiPickerSlideIn {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }
  
  .emoji-header { 
    padding: 10px; /* Reduced padding */
    background: var(--bg-color); 
    border-bottom: 1px solid var(--border-color); 
    display: flex; 
    gap: 6px; /* Reduced gap */
    overflow-x: auto;
  }
  
  .emoji-header button { 
    background: none; 
    border: none; 
    font-size: 18px; /* Reduced font size */
    cursor: pointer; 
    opacity: 0.6; 
    padding: 6px 10px; /* Reduced padding */
    border-radius: 8px;
    transition: all 0.2s ease;
    min-width: 40px; /* Reduced width */
  }
  
  .emoji-header button:hover {
    opacity: 0.8;
    background: rgba(0,128,255,0.1);
  }
  
  .emoji-header button.active { 
    opacity: 1; 
    background: var(--primary);
    color: white;
  }
  
  .emoji-content { 
    flex: 1; 
    overflow-y: auto; 
    padding: 10px; /* Reduced padding */
    display: grid; 
    grid-template-columns: repeat(8, 1fr); 
    gap: 6px; /* Reduced gap */
  }
  
  .emoji-item { 
    font-size: 22px; /* Reduced font size */
    cursor: pointer; 
    text-align: center; 
    border-radius: 8px; 
    transition: all 0.2s ease;
    padding: 6px; /* Reduced padding */
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .emoji-item:hover { 
    background: var(--bg-color); 
    transform: scale(1.2); 
  }

  .settings-modal { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.6); 
    z-index: 2100; 
    align-items: center; 
    justify-content: center; 
    opacity: 0; 
    animation: modalFadeIn 0.3s forwards; 
  }
  
  @keyframes modalFadeIn { 
    to { opacity: 1; } 
  }
  
  .settings-content { 
    background: var(--card-bg); 
    width: 95%; 
    max-width: 550px; 
    padding: 30px; /* Reduced padding */
    border-radius: 24px; 
    box-shadow: 0 25px 80px rgba(0,0,0,0.3); 
    border: 1px solid var(--border-color); 
    display: flex; 
    flex-direction: column; 
    gap: 20px; /* Reduced gap */
    max-height: 85vh; 
    overflow-y: auto;
    animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  @keyframes modalSlideIn {
    from {
      transform: translateY(-30px) scale(0.95);
      opacity: 0;
    }
    to {
      transform: translateY(0) scale(1);
      opacity: 1;
    }
  }

  .settings-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    padding-bottom: 15px; /* Reduced padding */
    border-bottom: 2px solid var(--border-color); 
  }
  
  .settings-header h3 { 
    font-size: 24px; /* Reduced font size */
    font-weight: 700; 
    background: linear-gradient(45deg, #0080FF, #a033ff); 
    -webkit-background-clip: text; 
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .settings-close { 
    background: none; 
    border: none; 
    font-size: 24px; /* Reduced font size */
    color: var(--secondary-text); 
    cursor: pointer; 
    padding: 5px;
    border-radius: 50%;
    transition: all 0.2s ease;
  }
  
  .settings-close:hover {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error);
    transform: scale(1.1);
  }

  .settings-section h4 { 
    margin-bottom: 12px; /* Reduced margin */
    color: var(--text-color); 
    font-size: 14px; /* Reduced font size */
    text-transform: uppercase; 
    letter-spacing: 1.5px; 
    opacity: 0.8; 
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px; /* Reduced gap */
  }

  .color-grid { 
    display: grid; 
    grid-template-columns: repeat(6, 1fr); 
    gap: 12px; /* Reduced gap */
  }
  
  .color-option { 
    width: 100%; 
    aspect-ratio: 1; 
    border-radius: 50%; 
    cursor: pointer; 
    border: 3px solid transparent; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
    transition: all 0.2s ease; 
  }
  
  .color-option:hover { 
    transform: scale(1.15); 
    box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  }
  
  .color-option.selected { 
    border-color: var(--text-color); 
    transform: scale(1.15); 
    box-shadow: 0 0 0 2px var(--card-bg), 0 0 0 4px var(--primary);
  }

  .font-select { 
    width: 100%; 
    padding: 12px 16px; /* Reduced padding */
    border-radius: 12px; 
    border: 2px solid var(--border-color); 
    background: var(--bg-color); 
    color: var(--text-color); 
    font-size: 14px; /* Reduced font size */
    outline: none; 
    appearance: none; 
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); 
    background-repeat: no-repeat; 
    background-position: right 1rem center; 
    background-size: 1em;
    transition: all 0.2s ease;
  }
  
  .font-select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(0,128,255,0.1);
  }

  .wallpaper-preview-overlay { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.9); 
    z-index: 2200; 
    align-items: center; 
    justify-content: center; 
  }
  
  .wallpaper-preview-card { 
    width: 90%; 
    max-width: 450px; 
    background: var(--card-bg); 
    border-radius: 24px; 
    overflow: hidden; 
    display: flex; 
    flex-direction: column; 
    box-shadow: 0 25px 80px rgba(0,0,0,0.6);
    animation: previewSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  @keyframes previewSlideIn {
    from {
      opacity: 0;
      transform: scale(0.8) translateY(30px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }
  
  .preview-visual { 
    height: 450px; 
    background: #eee; 
    position: relative; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    overflow: hidden; 
  }
  
  .preview-visual img, 
  .preview-visual video { 
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
  }
  
  .preview-actions { 
    padding: 20px; /* Reduced padding */
    display: flex; 
    gap: 12px; /* Reduced gap */
  }
  
  .preview-btn { 
    flex: 1; 
    padding: 12px; /* Reduced padding */
    border-radius: 12px; 
    border: none; 
    font-weight: 600; 
    cursor: pointer; 
    font-size: 14px; /* Reduced font size */
    transition: all 0.2s ease; 
  }
  
  .btn-confirm { 
    background: var(--primary); 
    color: white; 
  }
  
  .btn-confirm:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(0,128,255,0.4);
  }
  
  .btn-cancel { 
    background: var(--bg-color); 
    color: var(--text-color);
    border: 2px solid var(--border-color);
  }
  
  .btn-cancel:hover {
    background: var(--border-color);
  }

  .wallpaper-modal { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.8); 
    z-index: 2000; 
    padding: 20px; 
    align-items: center; 
    justify-content: center; 
  }
  
  .wallpaper-content { 
    background: var(--card-bg); 
    border-radius: 16px; 
    padding: 20px; /* Reduced padding */
    max-width: 900px; 
    width: 95%; 
    height: 90vh; 
    display: flex; 
    flex-direction: column; 
    overflow: hidden; 
  }
  
  .wallpaper-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 15px; /* Reduced margin */
    flex-shrink: 0; 
    padding-bottom: 12px; /* Reduced padding */
    border-bottom: 1px solid var(--border-color);
  }
  
  .wallpaper-header h3 {
    font-size: 20px; /* Reduced font size */
    font-weight: 700;
    color: var(--text-color);
  }
  
  .wallpaper-grid { 
    display: grid; 
    grid-template-columns: repeat(4, 1fr); 
    gap: 15px; /* Reduced gap */
    overflow-y: auto; 
    padding: 8px; 
    flex: 1; 
  }
  
  .wallpaper-upload-option {
    aspect-ratio: 9/16;
    border-radius: 12px;
    overflow: hidden;
    cursor: pointer;
    border: 3px dashed var(--border-color);
    transition: all 0.3s ease;
    background: var(--bg-color);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--secondary-text);
  }
  
  .wallpaper-upload-option:hover {
    border-color: var(--primary);
    transform: scale(1.03);
    box-shadow: 0 8px 25px rgba(0,128,255,0.3);
    color: var(--primary);
  }
  
  .wallpaper-upload-option i {
    font-size: 36px; /* Reduced font size */
    margin-bottom: 12px; /* Reduced margin */
  }
  
  .wallpaper-upload-option span {
    font-size: 13px; /* Reduced font size */
    font-weight: 600;
  }
  
  .wallpaper-thumb { 
    aspect-ratio: 9/16; 
    border-radius: 12px; 
    overflow: hidden; 
    cursor: pointer; 
    border: 3px solid transparent; 
    transition: all 0.3s ease; 
    background: #eee; 
    position: relative; 
  }
  
  .wallpaper-thumb:hover { 
    border-color: #0080FF; 
    transform: scale(1.03); 
    box-shadow: 0 8px 25px rgba(0,128,255,0.3);
  }
  
  .wallpaper-thumb img, 
  .wallpaper-thumb video { 
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
    display: block; 
  }
  
  .category-title { 
    font-size: 15px; /* Reduced font size */
    font-weight: 700; 
    margin: 25px 0 12px 0; /* Reduced margin */
    grid-column: 1 / -1; 
    color: var(--text-color); 
    text-transform: uppercase; 
    letter-spacing: 1.5px; 
    border-bottom: 2px solid var(--primary); 
    padding-bottom: 6px; /* Reduced padding */
    position: relative;
  }
  
  .category-title::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 60px;
    height: 2px;
    background: linear-gradient(90deg, var(--primary), transparent);
  }

  .wallpaper-category-section {
    margin-bottom: 25px; /* Reduced margin */
  }

  .wallpaper-grid-category {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px; /* Reduced gap */
    margin-bottom: 12px; /* Reduced margin */
  }

  .load-more-wallpapers {
    width: 100%;
    padding: 12px; /* Reduced padding */
    background: var(--bg-color);
    color: var(--text-color);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    cursor: pointer;
    font-size: 13px; /* Reduced font size */
    font-weight: 600;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px; /* Reduced gap */
  }

  .load-more-wallpapers:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(0,128,255,0.3);
  }

  .user-search-overlay { 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.7); 
    z-index: 1000; 
    display: none; 
    justify-content: center; 
    align-items: flex-start; 
    padding-top: 80px; /* Reduced padding */
  }
  
  .user-search-modal { 
    background: var(--card-bg); 
    border-radius: 20px; 
    padding: 0; 
    width: 90%; 
    max-width: 550px; 
    box-shadow: 0 15px 60px rgba(0,0,0,0.3); 
    overflow: hidden; 
    animation: searchModalSlideIn 0.3s ease;
    border: 1px solid var(--border-color);
  }
  
  @keyframes searchModalSlideIn { 
    from { 
      transform: translateY(-30px) scale(0.95); 
      opacity: 0; 
    } 
    to { 
      transform: translateY(0) scale(1); 
      opacity: 1; 
    } 
  }
  
  .search-modal-header { 
    padding: 20px; /* Reduced padding */
    background: var(--bg-color); 
    border-bottom: 1px solid var(--border-color); 
  }
  
  .search-modal-header h3 {
    font-size: 18px; /* Reduced font size */
    font-weight: 700;
    margin-bottom: 12px; /* Reduced margin */
    color: var(--text-color);
  }
  
  .search-input-group { 
    position: relative; 
  }
  
  .search-input-group i { 
    position: absolute; 
    left: 16px; /* Reduced position */
    top: 50%; 
    transform: translateY(-50%); 
    color: var(--secondary-text);
    font-size: 14px; /* Reduced font size */
  }
  
  .search-input-group input { 
    width: 100%; 
    padding: 12px 16px 12px 40px; /* Reduced padding */
    border-radius: 12px; 
    border: 2px solid var(--border-color); 
    font-size: 14px; /* Reduced font size */
    outline: none; 
    background: var(--card-bg); 
    color: var(--text-color);
    transition: all 0.2s ease;
  }
  
  .search-input-group input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(0,128,255,0.1);
  }
  
  .search-results { 
    max-height: 350px; 
    overflow-y: auto; 
  }
  
  .search-result-item { 
    display: flex; 
    align-items: center; 
    padding: 15px 20px; /* Reduced padding */
    border-bottom: 1px solid var(--border-color); 
    cursor: pointer; 
    transition: all 0.2s ease; 
  }
  
  .search-result-item:hover { 
    background: rgba(0,128,255,0.08); 
  }
  
  .search-result-info {
    flex: 1;
    margin-left: 12px; /* Reduced margin */
  }
  
  .search-result-name {
    font-weight: 600;
    font-size: 14px; /* Reduced font size */
    color: var(--text-color);
    margin-bottom: 3px; /* Reduced margin */
  }
  
  .search-result-email {
    font-size: 12px; /* Reduced font size */
    color: var(--secondary-text);
  }
  
  .search-close-btn { 
    width: 100%; 
    padding: 15px; /* Reduced padding */
    background: var(--card-bg); 
    border: none; 
    border-top: 1px solid var(--border-color); 
    color: var(--error); 
    font-weight: 600; 
    cursor: pointer;
    font-size: 14px; /* Reduced font size */
    transition: all 0.2s ease;
  }
  
  .search-close-btn:hover {
    background: rgba(239, 68, 68, 0.1);
  }

  .conversation-options-menu { 
    display: none; 
    position: absolute; 
    background: var(--card-bg); 
    border-radius: 12px; 
    box-shadow: 0 8px 32px rgba(0,0,0,0.2); 
    z-index: 100; 
    min-width: 180px; /* Reduced width */
    overflow: hidden; 
    border: 1px solid var(--border-color); 
    animation: menuSlideIn 0.2s ease; 
  }

  .loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border-color);
    border-top: 2px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .message-wrapper.deleting {
    opacity: 0.6;
    transition: opacity 0.3s ease;
  }

  .error-message {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error);
    padding: 10px 14px; /* Reduced padding */
    border-radius: 8px;
    border-left: 4px solid var(--error);
    margin: 8px; /* Reduced margin */
    font-size: 13px; /* Reduced font size */
    display: flex;
    align-items: center;
    gap: 8px; /* Reduced gap */
  }

  .retry-btn {
    background: var(--error);
    color: white;
    border: none;
    padding: 5px 10px; /* Reduced padding */
    border-radius: 6px;
    cursor: pointer;
    font-size: 11px; /* Reduced font size */
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .retry-btn:hover {
    background: #dc2626;
    transform: translateY(-1px);
  }

  /* Voice recording styles */
  .voice-record-container {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    background: rgba(0,128,255,0.1);
    border-radius: 20px;
    margin-right: 10px;
  }

  .voice-record-timer {
    font-size: 12px;
    font-weight: 600;
    color: var(--primary);
    min-width: 40px;
    text-align: center;
  }

  .voice-record-visualizer {
    flex: 1;
    height: 4px;
    background: rgba(0,128,255,0.2);
    border-radius: 2px;
    overflow: hidden;
    position: relative;
  }

  .voice-record-wave {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 0;
    background: var(--primary);
    animation: wave 1s infinite linear;
  }

  @keyframes wave {
    0% { width: 0; }
    50% { width: 100%; }
    100% { width: 0; }
  }

  .voice-record-cancel {
    background: none;
    border: none;
    color: var(--error);
    cursor: pointer;
    font-size: 14px;
    padding: 4px;
    border-radius: 50%;
    transition: all 0.2s ease;
  }

  .voice-record-cancel:hover {
    background: rgba(239, 68, 68, 0.1);
  }

  /* WhatsApp-style voice note player */
  .voice-note-player {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 18px;
    min-width: 150px;
    max-width: 250px;
  }

  .voice-note-player.sent {
    background: rgba(0, 128, 255, 0.1);
  }

  .voice-note-player.received {
    background: rgba(0, 0, 0, 0.05);
  }

  .voice-note-play-btn {
    background: var(--primary);
    color: white;
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .voice-note-play-btn:hover {
    background: var(--primary-dark);
    transform: scale(1.05);
  }

  .voice-note-waveform {
    flex: 1;
    height: 30px;
    position: relative;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 15px;
    overflow: hidden;
  }

  .voice-note-progress {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: var(--primary);
    width: 0%;
    transition: width 0.1s linear;
  }

  .voice-note-duration {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-color);
    min-width: 40px;
    text-align: right;
  }

  .voice-note-wave {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: repeating-linear-gradient(
      90deg,
      transparent,
      transparent 2px,
      rgba(255, 255, 255, 0.3) 2px,
      rgba(255, 255, 255, 0.3) 4px
    );
    opacity: 0.5;
  }

  @media (max-width: 768px) {
    .chat-container { 
      border-radius: 0; 
      height: 100%; 
      margin: 0;
      width: 100% !important;
      max-width: 100% !important;
    }
    
    .navbar {
      width: 100% !important;
      max-width: 100% !important;
      border-radius: 0;
      margin-bottom: 0;
      padding: 10px 15px; /* Reduced padding */
    }
    
    .main-content {
      padding: 0;
    }
    
    .conversations-sidebar { 
      width: 100%; 
      position: absolute; 
      z-index: 50; 
    }
    
    .chat-area { 
      width: 100%; 
      position: absolute; 
      z-index: 60; 
      transform: translateX(100%); 
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
    }
    
    .chat-area.active { 
      transform: translateX(0); 
    }
    
    .emoji-picker { 
      width: 95%; 
      left: 2.5%; 
      bottom: 70px; /* Adjusted position */
      height: 320px; /* Reduced height */
    }
    
    .wallpaper-grid { 
      grid-template-columns: repeat(3, 1fr);
      gap: 10px; /* Reduced gap */
    }
    
    .wallpaper-grid-category { 
      grid-template-columns: repeat(3, 1fr);
      gap: 10px; /* Reduced gap */
    }
    
    .wallpaper-preview-card {
      width: 95%;
      max-width: none;
      border-radius: 16px;
      height: 80vh;
    }
    
    .preview-visual {
      height: 60vh;
    }
    
    .preview-actions {
      padding: 15px; /* Reduced padding */
      flex-direction: column;
      gap: 10px; /* Reduced gap */
    }
    
    .wallpaper-thumb {
      aspect-ratio: 3/4;
      border-width: 2px;
    }
    
    .wallpaper-content {
      padding: 12px; /* Reduced padding */
      height: 85vh;
    }
    
    .color-grid {
      grid-template-columns: repeat(4, 1fr);
    }
    
    .emoji-content {
      grid-template-columns: repeat(6, 1fr);
    }
    
    .sidebar {
      width: 260px;
    }
    
    .message-wrapper {
      max-width: 90%;
    }
    
    .message-input-actions {
      flex-wrap: wrap;
      gap: 4px; /* Reduced gap */
    }
    
    .chat-user-name {
      font-size: 14px; /* Reduced font size */
    }
    
    .conversation-name {
      font-size: 13px; /* Reduced font size */
    }
    
    .category-title {
      font-size: 13px; /* Reduced font size */
      margin: 15px 0 8px 0; /* Reduced margin */
      padding-bottom: 5px; /* Reduced padding */
    }
    
    .chat-actions {
      gap: 3px; /* Reduced gap */
    }
    
    .chat-action-btn {
      width: 32px; /* Reduced size */
      height: 32px; /* Reduced size */
      padding: 6px; /* Reduced padding */
      font-size: 14px; /* Reduced font size */
    }
    
    .unread-count {
      font-size: 9px; /* Reduced font size */
      min-width: 14px; /* Reduced size */
      height: 14px; /* Reduced size */
      padding: 0 3px; /* Reduced padding */
    }

    .scroll-to-bottom-btn {
      width: 36px; /* Reduced size */
      height: 36px; /* Reduced size */
      font-size: 16px; /* Reduced font size */
      bottom: 15px; /* Adjusted position */
      right: 15px; /* Adjusted position */
    }
  }

  @media (max-width: 480px) {
    .navbar {
      padding: 8px 12px; /* Reduced padding */
    }
    
    .nav-user-img {
      width: 32px; /* Reduced size */
      height: 32px; /* Reduced size */
    }
    
    .nav-user-name {
      font-size: 12px; /* Reduced font size */
    }
    
    .message-input-container {
      padding: 8px; /* Reduced padding */
    }
    
    .settings-content {
      padding: 20px; /* Reduced padding */
    }
    
    .conversation-item {
      padding: 12px; /* Reduced padding */
    }
    
    .conversation-avatar {
      width: 40px; /* Reduced size */
      height: 40px; /* Reduced size */
    }
    
    .message-bubble {
      padding: 7px 10px; /* Reduced padding */
      font-size: 13px; /* Reduced font size */
    }
    
    .wallpaper-grid,
    .wallpaper-grid-category {
      grid-template-columns: repeat(2, 1fr);
      gap: 8px; /* Reduced gap */
    }
    
    .wallpaper-content {
      padding: 10px; /* Reduced padding */
    }
    
    .wallpaper-header h3 {
      font-size: 16px; /* Reduced font size */
    }
    
    .load-more-wallpapers {
      padding: 10px; /* Reduced padding */
      font-size: 12px; /* Reduced font size */
    }
  }

  body.dark-mode .sidebar {
    background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
  }
  
  body.dark-mode .navbar {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  }
  
  body.dark-mode .date-divider span {
    background: rgba(255,255,255,0.1);
    color: var(--text-color);
  }
  
  body.dark-mode .message-bubble {
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }
  
  body.dark-mode .sent .message-bubble {
    box-shadow: 0 2px 8px rgba(0,128,255,0.4);
  }
  
  body.dark-mode .wallpaper-upload-option {
    background: var(--card-bg);
    border-color: var(--border-color);
  }
</style>
</head>
<body>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
<div class="app-container">
  <div class="sidebar" id="mainSidebar">
    <div class="sidebar-header">
      <h2>MEET</h2>
      <button onclick="toggleSidebar()" style="background:none; border:none; color:white; font-size:24px; padding:8px; border-radius:50%; transition:all 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='none'"><i class="fas fa-times"></i></button>
    </div>
    <ul class="sidebar-menu">
      <li>
        <a href="feed.html" id="feedLink">
          <i class="fas fa-home"></i> <span>Feed</span>
          <span class="notification-badge" id="feedNotificationBadge">0</span>
        </a>
      </li>
      <li><a href="profile.html"><i class="fas fa-user"></i> <span>Profile</span></a></li>
      <li><a href="chat.html" class="active"><i class="fas fa-comment"></i> <span>Chat</span></a></li>
      <li><a href="conference.html"><i class="fas fa-video"></i> <span>Conference</span></a></li>
      <li><a href="meetrader.html"><i class="fas fa-store"></i> <span>Meetrader</span></a></li>
    </ul>
  </div>

  <div class="main-content">
    <div class="navbar">
      <div class="navbar-left">
        <button class="hamburger-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <h2 style="font-weight:600; font-size:20px;">Chat</h2>
      </div>
      <div class="navbar-right">
        <img src="https://via.placeholder.com/40" id="navUserImg" class="nav-user-img" alt="Me">
        <span id="navUserName" class="nav-user-name"></span>
        <button class="btn" id="nightToggleBtn"><i class="fas fa-moon"></i></button>
        <button class="btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </div>

    <div class="chat-container">
      <div class="conversations-sidebar" id="conversationsSidebar">
        <div class="chat-header">
          <h3>Messages</h3>
          <button class="new-chat-btn" onclick="openUserSearchOverlay()"><i class="fas fa-plus"></i></button>
        </div>
        <div class="chat-search">
          <input type="text" placeholder="Search chats..." id="chatSearch">
        </div>
        <div class="conversations-list" id="conversationsList">
          <!-- Conversations will be loaded here -->
        </div>
      </div>

      <div class="chat-area" id="chatArea">
        <div id="emptyChat" class="empty-chat">
          <i class="far fa-comments"></i>
          <h3>Select a conversation</h3>
          <p>Choose a contact to start chatting and stay connected with your network</p>
        </div>

        <div class="chat-area-header" id="chatHeader" style="display: none;">
          <button class="chat-action-btn" id="backButton" style="color:var(--text-color); margin-right:5px;"><i class="fas fa-arrow-left"></i></button>
          <img src="" id="currentChatAvatar" class="conversation-avatar">
          <div class="chat-user-info">
            <div class="chat-user-name" id="chatUserName">User</div>
            <div class="chat-user-status">Last seen recently</div>
          </div>
          <div class="chat-actions">
            <button class="chat-action-btn" onclick="openSettingsModal()" title="Chat Settings"><i class="fas fa-sliders-h"></i></button>
            <button class="chat-action-btn" onclick="startVoiceCall()" title="Voice Call"><i class="fas fa-phone-alt"></i></button>
            <button class="chat-action-btn" onclick="startVideoCall()" title="Video Call"><i class="fas fa-video"></i></button>
            <button class="chat-action-btn" onclick="openWallpaperModal()" title="Wallpaper"><i class="fas fa-image"></i></button>
          </div>
        </div>

        <div class="messages-container" id="messagesContainer" style="display: none;">
          <!-- Scroll to bottom button will be added here -->
        </div>

        <div class="typing-indicator" id="typingIndicator">
          <span id="typingUserName">User</span> is typing <span>.</span><span>.</span><span>.</span>
        </div>

        <div class="message-input-container" id="messageInputContainer" style="display: none;">
          <div class="reply-preview-bar" id="replyPreview">
            <div class="reply-preview-content">
              <span class="reply-name" id="replyName">Replying to User</span>
              <span class="reply-text" id="replyText">Message text...</span>
            </div>
            <button onclick="cancelReply()" style="background:none;border:none;cursor:pointer;font-size:20px;color:var(--secondary-text);padding:5px;border-radius:50%;transition:all 0.2s ease;" onmouseover="this.style.background='rgba(239,68,68,0.1)';this.style.color='var(--error)'" onmouseout="this.style.background='none';this.style.color='var(--secondary-text)'">&times;</button>
          </div>
            
          <div class="writing-assist-bar" id="assistBar">
            <button class="assist-chip" onclick="applyWritingAssist('fix')"><i class="fas fa-spell-check"></i> Fix Grammar</button>
            <button class="assist-chip" onclick="applyWritingAssist('formal')"><i class="fas fa-user-tie"></i> Make Formal</button>
            <button class="assist-chip" onclick="applyWritingAssist('expand')"><i class="fas fa-expand-alt"></i> Expand Text</button>
          </div>

          <div class="message-input-wrapper">
            <div class="message-input-actions">
              <button class="input-action magic-btn" onclick="toggleAssistBar()" title="Writing Assistant"><i class="fas fa-magic"></i></button>
              <button class="input-action" onclick="toggleEmojiPicker()" title="Emoji"><i class="far fa-smile"></i></button>
              
              <!-- Voice recording button -->
              <button class="input-action" id="voiceRecordBtn" title="Voice Note"><i class="fas fa-microphone"></i></button>
              
              <!-- Single file upload button for all types -->
              <input type="file" id="fileInputHidden" accept="image/*,video/*,audio/*,application/*,text/*,.pdf,.doc,.docx,.txt,.zip,.rar" 
                     style="display:none" multiple onchange="handleFileUpload(this.files)">
              <button class="input-action" onclick="document.getElementById('fileInputHidden').click()" title="Send File"><i class="fas fa-paperclip"></i></button>
            </div>
            
            <!-- Voice recording UI (hidden by default) -->
            <div id="voiceRecordingUI" style="display: none;" class="voice-record-container">
              <div class="voice-record-timer" id="voiceRecordTimer">0:00</div>
              <div class="voice-record-visualizer">
                <div class="voice-record-wave"></div>
              </div>
              <button class="voice-record-cancel" id="voiceRecordCancelBtn" title="Cancel Recording"><i class="fas fa-times"></i></button>
            </div>
            
            <textarea class="message-input" id="messageInput" placeholder="Type a message..." rows="1" spellcheck="true"></textarea>
            <button class="send-button" id="sendButton" title="Send Message"><i class="fas fa-paper-plane"></i></button>
          </div>
          
          <div class="emoji-picker" id="emojiPicker">
            <div class="emoji-header" id="emojiNav"></div>
            <div class="emoji-content" id="emojiContent"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<input type="file" id="wallpaperUploadInput" accept="image/*,video/*" style="display:none">

<!-- Conversation Context Menu -->
<div class="conversation-options-menu" id="conversationOptionsMenu">
  <div class="msg-option-item" onclick="deleteConversation()" style="color:var(--error);"><i class="fas fa-trash-alt"></i> Delete Conversation</div>
</div>

<!-- Settings Modal -->
<div class="settings-modal" id="settingsModal">
  <div class="settings-content">
    <div class="settings-header">
      <h3>Chat Personalization</h3>
      <button class="settings-close" onclick="closeSettingsModal()">&times;</button>
    </div>
    
    <div class="settings-section">
      <h4><i class="fas fa-font"></i> Typography</h4>
      <select id="fontSelect" class="font-select" onchange="changeFont()">
        <!-- Font options will be populated by JavaScript -->
      </select>
    </div>
      
    <div class="settings-section">
      <h4><i class="fas fa-palette"></i> Bubble Style</h4>
      <div class="color-grid" id="colorGrid">
        <!-- Color options will be populated by JavaScript -->
      </div>
    </div>

    <div class="settings-section">
      <h4><i class="fas fa-robot"></i> AI Features</h4>
      <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0;">
        <span style="font-weight:500;">Auto-Reply Suggestions</span>
        <input type="checkbox" id="aiToggle" style="transform:scale(1.5); accent-color:var(--primary);">
      </div>
    </div>
  </div>
</div>

<!-- User Search Modal -->
<div class="user-search-overlay" id="userSearchOverlay">
  <div class="user-search-modal">
    <div class="search-modal-header">
      <h3>Start a Conversation</h3>
      <div class="search-input-group">
        <i class="fas fa-search"></i>
        <input type="text" id="userSearchInput" placeholder="Search by name or email...">
      </div>
    </div>
    <div class="search-results" id="userSearchResults"></div>
    <button onclick="closeUserSearchOverlay()" class="search-close-btn">Close</button>
  </div>
</div>

<!-- Wallpaper Modal -->
<div class="wallpaper-modal" id="wallpaperModal">
  <div class="wallpaper-content">
    <div class="wallpaper-header">
      <h3>Choose Wallpaper</h3>
      <button onclick="closeWallpaperModal()" style="background:none; border:none; font-size:24px; cursor:pointer; padding:8px; border-radius:50%; color:var(--secondary-text); transition:all 0.2s ease;" onmouseover="this.style.background='rgba(239,68,68,0.1)';this.style.color='var(--error)'" onmouseout="this.style.background='none';this.style.color='var(--secondary-text)'"><i class="fas fa-times"></i></button>
    </div>
    <div class="wallpaper-grid" id="wallpaperGrid">
      <!-- Upload option will be added here -->
    </div>
  </div>
</div>

<!-- Wallpaper Preview Modal -->
<div class="wallpaper-preview-overlay" id="wpPreviewOverlay">
  <div class="wallpaper-preview-card">
    <div class="preview-visual" id="wpPreviewVisual"></div>
    <div class="preview-actions">
      <button class="preview-btn btn-cancel" onclick="closeWpPreview()">Cancel</button>
      <button class="preview-btn btn-confirm" id="wpConfirmBtn">Set Wallpaper</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getFirestore, collection, addDoc, updateDoc, doc, getDoc, getDocs, onSnapshot, serverTimestamp, query, orderBy, where, setDoc, limit, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
    authDomain: "meet-6e159.firebaseapp.com",
    projectId: "meet-6e159",
    storageBucket: "meet-6e159.firebasestorage.app",
    messagingSenderId: "252353608421",
    appId: "1:252353608421:web:6706056048e9a8f12db20c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Global state variables
  let currentUser = null;
  let currentChatId = null;
  let currentChatUser = null;
  let currentChatUserName = '';
  let currentChatUserAvatar = '';
  let unsubscribeMessages = null;
  let unsubscribeConversations = null;
  let unsubscribeUserProfiles = null;
  let unsubscribeFeedNotifications = null;
  
  // Message state
  let replyToMsg = null;
  let editingMsgId = null;
  
  // UI state
  let currentConversationContext = null;

  // Wallpaper state
  let currentWallpaperPage = {};
  const wallpapersPerPage = 10;
  const wallpaperCategories = ['Nature', 'Abstract', 'Tech', 'Minimal', 'City', 'Space', 'Dark'];
  let tempWallpaper = null;

  // Voice recording state
  let mediaRecorder = null;
  let audioChunks = [];
  let recordingTimer = null;
  let recordingStartTime = null;
  let isRecording = false;
  
  // Voice note playing state
  let currentlyPlayingAudio = null;
  let audioPlayingInterval = null;

  // Prevent duplicate message sending
  let isSendingMessage = false;

  // Scroll to bottom button
  let scrollToBottomBtn = null;

  // DOM elements
  const messagesContainer = document.getElementById('messagesContainer');
  const messageInput = document.getElementById('messageInput');
  const emojiPicker = document.getElementById('emojiPicker');
  const sidebar = document.getElementById('mainSidebar');
  const sidebarOverlay = document.getElementById('sidebarOverlay');
  const navUserImg = document.getElementById('navUserImg');
  const navUserName = document.getElementById('navUserName');
  const feedNotificationBadge = document.getElementById('feedNotificationBadge');
  const voiceRecordBtn = document.getElementById('voiceRecordBtn');
  const voiceRecordingUI = document.getElementById('voiceRecordingUI');
  const voiceRecordTimer = document.getElementById('voiceRecordTimer');
  const voiceRecordCancelBtn = document.getElementById('voiceRecordCancelBtn');

  // === UTILITY FUNCTIONS ===

  function showError(message, duration = 5000) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.innerHTML = `
      <i class="fas fa-exclamation-triangle"></i>
      <span>${message}</span>
    `;
    
    if (messagesContainer && messagesContainer.style.display !== 'none') {
      messagesContainer.insertBefore(errorDiv, messagesContainer.firstChild);
    } else {
      errorDiv.style.position = 'fixed';
      errorDiv.style.top = '20px';
      errorDiv.style.right = '20px';
      errorDiv.style.zIndex = '9999';
      errorDiv.style.maxWidth = '400px';
      document.body.appendChild(errorDiv);
    }
    
    setTimeout(() => {
      if (errorDiv.parentNode) {
        errorDiv.remove();
      }
    }, duration);
  }

  function showLoading(container, message = 'Loading...') {
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'loading-message';
    loadingDiv.innerHTML = `
      <div class="loading-spinner"></div>
      <span>${message}</span>
    `;
    loadingDiv.style.cssText = 'display:flex; align-items:center; justify-content:center; gap:10px; padding:20px; color:var(--secondary-text);';
    container.appendChild(loadingDiv);
    return loadingDiv;
  }

  function formatDateHeader(timestamp) {
    if (!timestamp) return null;
    
    const date = new Date(timestamp.seconds * 1000);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    if (date.toDateString() === today.toDateString()) return "Today";
    if (date.toDateString() === yesterday.toDateString()) return "Yesterday";
    
    const daysDiff = Math.floor((today - date) / (1000 * 60 * 60 * 24));
    if (daysDiff < 7) {
      return date.toLocaleDateString('en-US', { weekday: 'long' });
    }
    
    return date.toLocaleDateString('en-US', { 
      weekday: 'long', 
      day: 'numeric', 
      month: 'long', 
      year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined 
    });
  }

  async function getUserDisplayName(userId) {
    if (!userId) return 'Unknown User';
    
    try {
      const cachedName = window.userNameCache?.[userId];
      if (cachedName) return cachedName;
      
      const userDoc = await getDoc(doc(db, "users", userId));
      if (userDoc.exists()) {
        const userData = userDoc.data();
        const displayName = userData.name || userData.displayName || userData.firstName || 'User';
        
        if (!window.userNameCache) window.userNameCache = {};
        window.userNameCache[userId] = displayName;
        
        return displayName;
      }
      return 'User';
    } catch (error) {
      console.error("Error fetching user name:", error);
      return 'User';
    }
  }

  async function getUserProfilePicture(userId) {
    if (!userId) return `https://ui-avatars.com/api/?name=User&background=0080FF&color=fff`;
    
    try {
      const userDoc = await getDoc(doc(db, "users", userId));
      if (userDoc.exists()) {
        const userData = userDoc.data();
        return userData.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.name || 'User')}&background=0080FF&color=fff`;
      }
    } catch (error) {
      console.error("Error fetching user profile picture:", error);
    }
    
    return `https://ui-avatars.com/api/?name=User&background=0080FF&color=fff`;
  }

  async function updateConversationAvatars(userId, newAvatarUrl) {
    try {
      const conversationsQuery = query(
        collection(db, "conversations"), 
        where("participants", "array-contains", userId)
      );
      
      const conversationsSnapshot = await getDocs(conversationsQuery);
      const batch = writeBatch(db);
      
      conversationsSnapshot.docs.forEach(convDoc => {
        const convData = convDoc.data();
        const participantAvatars = convData.participantAvatars || {};
        
        if (participantAvatars[userId] !== newAvatarUrl) {
          participantAvatars[userId] = newAvatarUrl;
          batch.update(doc(db, "conversations", convDoc.id), {
            participantAvatars: participantAvatars,
            updatedAt: serverTimestamp()
          });
        }
      });
      
      await batch.commit();
    } catch (error) {
      console.error("Error updating conversation avatars:", error);
    }
  }

  // === MESSAGE RENDERING ===

  function renderMessageHTML(msg, isMe, id) {
    const avatarSrc = isMe ? navUserImg.src : currentChatUserAvatar;
    let content = "";
    
    if (msg.replyTo) {
      content += `
        <div style="background:rgba(0,128,255,0.1); padding:6px 10px; border-left:3px solid var(--primary); border-radius:8px; font-size:11px; margin-bottom:6px; opacity:0.9;">
          <div style="font-weight:600; color:var(--primary); margin-bottom:2px;">${msg.replyTo.user}</div>
          <div style="color:var(--secondary-text);">${msg.replyTo.text.substring(0,50)}${msg.replyTo.text.length > 50 ? '...' : ''}</div>
        </div>
      `;
    }

    let mediaContent = '';
    if (msg.mediaType === 'image') {
      mediaContent += `
        <div style="position:relative;">
          <img src="${msg.mediaUrl}" class="message-img" onerror="this.src='https://via.placeholder.com/200?text=Failed+to+load'" loading="lazy">
          ${msg.isUploading ? '<div class="upload-overlay"><div class="loading-spinner"></div></div>' : ''}
        </div>
      `;
    } else if (msg.mediaType === 'video') {
      mediaContent += `
        <div style="position:relative;">
          <video src="${msg.mediaUrl}" controls class="message-video" preload="metadata"></video>
          ${msg.isUploading ? '<div class="upload-overlay"><div class="loading-spinner"></div></div>' : ''}
        </div>
      `;
    } else if (msg.mediaType === 'audio') {
      // WhatsApp-style voice note player
      mediaContent += `
        <div class="voice-note-player ${isMe ? 'sent' : 'received'}" data-audio-id="${id}">
          <button class="voice-note-play-btn" onclick="toggleAudioPlayback('${id}', '${msg.mediaUrl}')">
            <i class="fas fa-play" id="play-icon-${id}"></i>
          </button>
          <div class="voice-note-waveform">
            <div class="voice-note-wave"></div>
            <div class="voice-note-progress" id="progress-${id}"></div>
          </div>
          <div class="voice-note-duration" id="duration-${id}">0:00</div>
        </div>
        ${msg.isUploading ? '<div class="upload-overlay"><div class="loading-spinner"></div></div>' : ''}
      `;
    } else if (msg.mediaType === 'file') {
      const fileName = msg.fileName || 'file';
      const fileSize = msg.fileSize ? `(${(msg.fileSize / 1024).toFixed(1)}KB)` : '';
      mediaContent += `
        <div style="position:relative; margin-top:6px; padding:10px; background:rgba(0,128,255,0.1); border-radius:8px; border:1px solid var(--border-color);">
          <div style="display:flex; align-items:center; gap:10px;">
            <i class="fas fa-file" style="font-size:24px; color:var(--primary);"></i>
            <div style="flex:1;">
              <div style="font-weight:600; font-size:12px; color:var(--text-color);">${fileName}</div>
              <div style="font-size:10px; color:var(--secondary-text);">${fileSize}</div>
            </div>
            <a href="${msg.mediaUrl}" download="${fileName}" style="color:var(--primary); font-size:18px;" title="Download"><i class="fas fa-download"></i></a>
          </div>
          ${msg.isUploading ? '<div class="upload-overlay"><div class="loading-spinner"></div></div>' : ''}
        </div>
      `;
    }
    
    let textContent = '';
    if (msg.text) {
      const formattedText = msg.text
        .replace(/\n/g, '<br>')
        .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:inherit; text-decoration:underline;">$1</a>');
      textContent += `<div style="word-break: break-word; overflow-wrap: break-word;">${formattedText}</div>`;
    }

    const div = document.createElement('div');
    div.className = `message-wrapper ${isMe ? 'sent' : 'received'} ${msg.isOptimistic ? 'optimistic-msg' : ''}`;
    div.id = id;
    
    const ts = msg.timestamp ? msg.timestamp.seconds : Date.now() / 1000;
    div.setAttribute('data-timestamp', ts);

    // Read receipt logic
    let readReceiptHtml = '';
    if (isMe && msg.timestamp) {
      // Simulate read receipts: single check for sent, double for delivered, blue for read
      const isRead = Math.random() > 0.3; // Simulate random read status
      const isDelivered = Math.random() > 0.1; // Simulate random delivery status
      
      if (isRead) {
        readReceiptHtml = '<span class="read-receipt blue-check"><i class="fas fa-check-double"></i></span>';
      } else if (isDelivered) {
        readReceiptHtml = '<span class="read-receipt double-check"><i class="fas fa-check-double"></i></span>';
      } else {
        readReceiptHtml = '<span class="read-receipt single-check"><i class="fas fa-check"></i></span>';
      }
    }

    const optionsHtml = `
      <button class="msg-options-btn" onclick="toggleMsgOptions('${id}')" title="Message options">
        <i class="fas fa-chevron-down"></i>
      </button>
      <div class="msg-options-menu" id="options-${id}">
        <div class="msg-option-item" onclick="handleReply('${id}', '${(msg.text || 'Media').replace(/'/g, "\\'")}', '${isMe ? 'You' : currentChatUserName}')">
          <i class="fas fa-reply"></i> Reply
        </div>
        <div class="msg-option-item" onclick="handleCopy('${(msg.text || '').replace(/'/g, "\\'")}')">
          <i class="fas fa-copy"></i> Copy Text
        </div>
        ${isMe ? `
          <div class="msg-option-item" onclick="handleEdit('${id}', '${(msg.text || '').replace(/'/g, "\\'")}')">
            <i class="fas fa-edit"></i> Edit
          </div>
        ` : ''}
        ${isMe ? `
          <div class="msg-option-item delete" onclick="handleDelete('${id}')">
            <i class="fas fa-trash-alt"></i> Delete
          </div>
        ` : ''}
      </div>
    `;

    let timeString = '';
    if (msg.timestamp) {
      const msgTime = new Date(msg.timestamp.seconds * 1000);
      timeString = msgTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    } else {
      timeString = '<i class="far fa-clock" title="Sending..."></i>';
    }

    div.innerHTML = `
      ${isMe ? optionsHtml : ''}
      <img src="${avatarSrc}" class="message-avatar-small" alt="${isMe ? 'You' : currentChatUserName}">
      <div class="message-bubble">
        ${content}
        ${mediaContent}
        <div class="message-content">
          <div class="message-text">
            ${textContent}
          </div>
          <div class="message-time">
            ${msg.isEdited ? '<i class="fas fa-pencil-alt" style="font-size:8px; margin-right:4px;" title="Edited"></i>' : ''}   
            ${timeString}
            ${readReceiptHtml}
          </div>
        </div>
      </div>
      ${!isMe ? optionsHtml : ''}
    `;
    
    return div;
  }

  // === AUDIO PLAYBACK FUNCTIONS ===
  window.toggleAudioPlayback = function(audioId, audioUrl) {
    const playIcon = document.getElementById(`play-icon-${audioId}`);
    const progressBar = document.getElementById(`progress-${audioId}`);
    const durationDisplay = document.getElementById(`duration-${audioId}`);
    
    if (currentlyPlayingAudio && currentlyPlayingAudio.id === audioId) {
      // Pause current audio
      if (currentlyPlayingAudio.audio.paused) {
        currentlyPlayingAudio.audio.play();
        playIcon.className = 'fas fa-pause';
        
        // Update progress bar
        audioPlayingInterval = setInterval(() => {
          const progress = (currentlyPlayingAudio.audio.currentTime / currentlyPlayingAudio.audio.duration) * 100;
          progressBar.style.width = `${progress}%`;
          
          // Update duration display
          const currentTime = Math.floor(currentlyPlayingAudio.audio.currentTime);
          const minutes = Math.floor(currentTime / 60);
          const seconds = currentTime % 60;
          durationDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }, 100);
      } else {
        currentlyPlayingAudio.audio.pause();
        playIcon.className = 'fas fa-play';
        clearInterval(audioPlayingInterval);
      }
    } else {
      // Stop any currently playing audio
      if (currentlyPlayingAudio) {
        currentlyPlayingAudio.audio.pause();
        const oldPlayIcon = document.getElementById(`play-icon-${currentlyPlayingAudio.id}`);
        if (oldPlayIcon) oldPlayIcon.className = 'fas fa-play';
        const oldProgressBar = document.getElementById(`progress-${currentlyPlayingAudio.id}`);
        if (oldProgressBar) oldProgressBar.style.width = '0%';
        clearInterval(audioPlayingInterval);
      }
      
      // Start new audio
      const audio = new Audio(audioUrl);
      currentlyPlayingAudio = { audio, id: audioId };
      
      audio.play();
      playIcon.className = 'fas fa-pause';
      
      // Set up progress tracking
      audio.addEventListener('loadedmetadata', () => {
        const duration = Math.floor(audio.duration);
        const minutes = Math.floor(duration / 60);
        const seconds = duration % 60;
        durationDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      });
      
      audioPlayingInterval = setInterval(() => {
        if (audio.duration) {
          const progress = (audio.currentTime / audio.duration) * 100;
          progressBar.style.width = `${progress}%`;
          
          // Update duration display
          const currentTime = Math.floor(audio.currentTime);
          const minutes = Math.floor(currentTime / 60);
          const seconds = currentTime % 60;
          durationDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
      }, 100);
      
      audio.addEventListener('ended', () => {
        playIcon.className = 'fas fa-play';
        progressBar.style.width = '0%';
        clearInterval(audioPlayingInterval);
        currentlyPlayingAudio = null;
        durationDisplay.textContent = '0:00';
      });
    }
  };

  // === SCROLL TO BOTTOM BUTTON ===
  function createScrollToBottomButton() {
    if (scrollToBottomBtn && scrollToBottomBtn.parentNode) {
      scrollToBottomBtn.remove();
    }
    
    scrollToBottomBtn = document.createElement('button');
    scrollToBottomBtn.className = 'scroll-to-bottom-btn';
    scrollToBottomBtn.innerHTML = '<i class="fas fa-chevron-down"></i>';
    scrollToBottomBtn.title = 'Scroll to latest messages';
    scrollToBottomBtn.onclick = () => {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    };
    
    messagesContainer.appendChild(scrollToBottomBtn);
    
    // Show/hide button based on scroll position
    messagesContainer.addEventListener('scroll', () => {
      const isNearBottom = messagesContainer.scrollHeight - messagesContainer.clientHeight - messagesContainer.scrollTop < 100;
      scrollToBottomBtn.style.display = isNearBottom ? 'none' : 'flex';
    });
    
    // Initial hide
    scrollToBottomBtn.style.display = 'none';
  }

  // === MESSAGE OPTIONS HANDLERS ===

  window.toggleMsgOptions = (id) => {
    document.querySelectorAll('.msg-options-menu').forEach(m => {
      if (m.id !== `options-${id}`) m.classList.remove('active');
    });
    
    const menu = document.getElementById(`options-${id}`);
    if (menu) menu.classList.toggle('active');
  };

  window.handleCopy = async (text) => {
    try {
      if (text) {
        await navigator.clipboard.writeText(text);
        const btn = event.target.closest('.msg-option-item');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        btn.style.color = 'var(--success)';
        
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.style.color = '';
        }, 2000);
      }
    } catch (error) {
      console.error('Copy failed:', error);
      showError('Failed to copy text');
    }
    
    document.querySelectorAll('.msg-options-menu').forEach(m => m.classList.remove('active'));
  };

  window.handleDelete = async (id) => {
    document.querySelectorAll('.msg-options-menu').forEach(m => m.classList.remove('active'));
    
    if (!currentChatId) return;
    
    if (confirm('Delete this message? This action cannot be undone.')) {
      try {
        const messageEl = document.getElementById(id);
        if (messageEl) {
          messageEl.classList.add('deleting');
        }
        
        await deleteDoc(doc(db, "conversations", currentChatId, "messages", id));
        
      } catch (error) {
        console.error("Delete error:", error);
        
        const messageEl = document.getElementById(id);
        if (messageEl) {
          messageEl.classList.remove('deleting');
        }
        
        showError("Failed to delete message. Please try again.");
      }
    }
  };

  window.handleEdit = (id, text) => {
    editingMsgId = id;
    messageInput.value = text;
    document.getElementById('sendButton').innerHTML = '<i class="fas fa-check"></i>';
    document.querySelectorAll('.msg-options-menu').forEach(m => m.classList.remove('active'));
    messageInput.focus();
    
    messageInput.style.height = 'auto';
    messageInput.style.height = messageInput.scrollHeight + 'px';
  };

  window.handleReply = (id, text, user) => {
    replyToMsg = { id, text, user };
    document.getElementById('replyName').innerText = `Replying to ${user}`;
    document.getElementById('replyText').innerText = text.substring(0, 80) + (text.length > 80 ? '...' : '');
    document.getElementById('replyPreview').style.display = 'flex';
    document.querySelectorAll('.msg-options-menu').forEach(m => m.classList.remove('active'));
    messageInput.focus();
  };

  window.cancelReply = () => {
    replyToMsg = null;
    editingMsgId = null;
    document.getElementById('replyPreview').style.display = 'none';
    document.getElementById('sendButton').innerHTML = '<i class="fas fa-paper-plane"></i>';
    messageInput.value = '';
    messageInput.style.height = '40px';
  };

  // === CONVERSATION MANAGEMENT ===

  window.deleteConversation = async function() {
    if (!currentConversationContext) return;
    
    if (confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
      try {
        const convItem = document.querySelector(`[data-chat-id="${currentConversationContext}"]`);
        if (convItem) {
          convItem.style.opacity = '0.5';
          convItem.style.pointerEvents = 'none';
        }
        
        await deleteDoc(doc(db, "conversations", currentConversationContext));
        
        const messagesQuery = query(collection(db, "conversations", currentConversationContext, "messages"));
        const messagesSnapshot = await getDocs(messagesQuery);
        
        const deletePromises = messagesSnapshot.docs.map(messageDoc => 
          deleteDoc(messageDoc.ref)
        );
        
        await Promise.all(deletePromises);
        
        if (currentChatId === currentConversationContext) {
          resetChatView();
        }
        
        document.getElementById('conversationOptionsMenu').style.display = 'none';
        currentConversationContext = null;
        
      } catch (error) {
        console.error("Error deleting conversation:", error);
        
        const convItem = document.querySelector(`[data-chat-id="${currentConversationContext}"]`);
        if (convItem) {
          convItem.style.opacity = '1';
          convItem.style.pointerEvents = 'auto';
        }
        
        showError("Failed to delete conversation. Please try again.");
      }
    }
  };

  function resetChatView() {
    document.getElementById('emptyChat').style.display = 'flex';
    document.getElementById('chatHeader').style.display = 'none';
    document.getElementById('messagesContainer').style.display = 'none';
    document.getElementById('messageInputContainer').style.display = 'none';
    
    currentChatId = null;
    currentChatUser = null;
    currentChatUserName = '';
    currentChatUserAvatar = '';
    
    if (unsubscribeMessages) {
      unsubscribeMessages();
      unsubscribeMessages = null;
    }
    
    cancelReply();
    localStorage.removeItem('last_active_chat');
    
    document.querySelectorAll('.conversation-item').forEach(el => el.classList.remove('active'));
  }

  function setupConversationLongPress() {
    let pressTimer;
    const conversationItems = document.querySelectorAll('.conversation-item');
    
    conversationItems.forEach(item => {
      item.removeEventListener('touchstart', handleTouchStart);
      item.removeEventListener('touchend', handleTouchEnd);
      item.removeEventListener('touchmove', handleTouchMove);
      item.removeEventListener('contextmenu', handleContextMenu);
      
      item.addEventListener('touchstart', handleTouchStart);
      item.addEventListener('touchend', handleTouchEnd);
      item.addEventListener('touchmove', handleTouchMove);
      item.addEventListener('contextmenu', handleContextMenu);
      
      function handleTouchStart(e) {
        pressTimer = setTimeout(() => {
          showConversationOptions(e, item.getAttribute('data-chat-id'));
        }, 500);
      }
      
      function handleTouchEnd() {
        clearTimeout(pressTimer);
      }
      
      function handleTouchMove() {
        clearTimeout(pressTimer);
      }
      
      function handleContextMenu(e) {
        e.preventDefault();
        showConversationOptions(e, item.getAttribute('data-chat-id'));
      }
    });
  }

  function showConversationOptions(event, chatId) {
    currentConversationContext = chatId;
    const menu = document.getElementById('conversationOptionsMenu');
    
    const rect = event.target.closest('.conversation-item').getBoundingClientRect();
    menu.style.top = `${rect.bottom + 5}px`;
    menu.style.left = `${Math.min(rect.left, window.innerWidth - 220)}px`;
    menu.style.display = 'block';
    
    document.querySelectorAll('.msg-options-menu').forEach(m => m.classList.remove('active'));
  }

  // === SETTINGS & CUSTOMIZATION ===

  window.openSettingsModal = () => {
    document.getElementById('settingsModal').style.display = 'flex';
  };

  window.closeSettingsModal = () => {
    document.getElementById('settingsModal').style.display = 'none';
  };

  const fontList = [
    "Poppins", "Roboto", "Open Sans", "Lato", "Montserrat", "Nunito", "Raleway", 
    "Oswald", "Quicksand", "Work Sans", "Fira Sans", "Barlow", "Mukta", "Abel", 
    "Acme", "Anton", "Arvo", "Bitter", "Cabin", "Dosis", "Hind", "Inconsolata",
    "Lobster", "Lora", "Oxygen", "Pacifico", "Righteous", "Ubuntu", "Comfortaa", 
    "Indie Flower", "Playfair Display", "Merriweather", "Titillium Web", "Heebo", 
    "Bebas Neue", "Crimson Text", "Josefin Sans", "Architects Daughter", 
    "Shadows Into Light", "Dancing Script", "Amatic SC", "Orbitron", 
    "Permanent Marker", "Fredoka One", "Special Elite", "Teko", "Courgette", 
    "Satisfy", "Great Vibes", "Sacramento", "Cookie", "Parisienne"
  ];
  
  const loadedFonts = new Set(['Poppins']);
    
  function initializeFontSelector() {
    const fontSelect = document.getElementById('fontSelect');
    fontSelect.innerHTML = '';
    
    fontList.forEach(font => {
      const option = document.createElement('option');
      option.value = `'${font}', sans-serif`;
      option.text = font;
      option.style.fontFamily = font;
      fontSelect.appendChild(option);
    });
  }

  window.changeFont = () => {
    const font = document.getElementById('fontSelect').value;
    document.documentElement.style.setProperty('--chat-font', font);
    localStorage.setItem('meet_font', font);
    
    const fontName = font.split(',')[0].replace(/'/g, '').trim();
    
    if (!loadedFonts.has(fontName)) {
      loadedFonts.add(fontName);
      
      const link = document.createElement('link');
      link.href = `https://fonts.googleapis.com/css2?family=${fontName.replace(/ /g, '+')}:wght@300;400;500;600;700&display=swap`;
      link.rel = 'stylesheet';
      document.head.appendChild(link);
    }
  };

  const colors = [
    { bg: '#0080FF', tx: '#fff', name: 'Classic Blue' },
    { bg: '#00C6FF', tx: '#fff', name: 'Sky Blue' },
    { bg: '#FF0055', tx: '#fff', name: 'Hot Pink' },
    { bg: '#8000FF', tx: '#fff', name: 'Purple' },
    { bg: '#00BFA5', tx: '#fff', name: 'Teal' },
    { bg: '#FF9900', tx: '#fff', name: 'Orange' },
    { bg: '#111111', tx: '#fff', name: 'Black' },
    { bg: '#4CAF50', tx: '#fff', name: 'Green' },
    { bg: '#607D8B', tx: '#fff', name: 'Blue Grey' },
    { bg: '#E91E63', tx: '#fff', name: 'Pink' },
    { bg: '#9C27B0', tx: '#fff', name: 'Deep Purple' },
    { bg: '#3F51B5', tx: '#fff', name: 'Indigo' }
  ];
  
  function initializeColorSelector() {
    const colorGrid = document.getElementById('colorGrid');
    colorGrid.innerHTML = '';
    
    colors.forEach(color => {
      const div = document.createElement('div');
      div.className = 'color-option';
      div.style.backgroundColor = color.bg;
      div.title = color.name;
      div.onclick = () => {
        document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
        div.classList.add('selected');
        setChatColor(color.bg, color.tx);
      };
      colorGrid.appendChild(div);
    });
  }

  window.setChatColor = (bg, text) => {
    document.documentElement.style.setProperty('--sent-bubble-bg', bg);
    document.documentElement.style.setProperty('--sent-text-color', text);
    localStorage.setItem('meet_color_bg', bg);
    localStorage.setItem('meet_color_text', text);
  };

  function loadSettings() {
    const savedFont = localStorage.getItem('meet_font');
    if (savedFont) {
      document.documentElement.style.setProperty('--chat-font', savedFont);
      const fontSelect = document.getElementById('fontSelect');
      if (fontSelect) fontSelect.value = savedFont;
      
      const fontName = savedFont.split(',')[0].replace(/'/g, '').trim();
      if (!loadedFonts.has(fontName) && fontName !== 'Poppins') {
        loadedFonts.add(fontName);
        const link = document.createElement('link');
        link.href = `https://fonts.googleapis.com/css2?family=${fontName.replace(/ /g, '+')}:wght@300;400;500;600;700&display=swap`;
        link.rel = 'stylesheet';
        document.head.appendChild(link);
      }
    }
    
    const savedBg = localStorage.getItem('meet_color_bg');
    const savedText = localStorage.getItem('meet_color_text');
    if (savedBg && savedText) {
      document.documentElement.style.setProperty('--sent-bubble-bg', savedBg);
      document.documentElement.style.setProperty('--sent-text-color', savedText);
      
      const colorOption = Array.from(document.querySelectorAll('.color-option'))
        .find(el => el.style.backgroundColor === savedBg);
      if (colorOption) colorOption.classList.add('selected');
    }
    
    const isDarkMode = localStorage.getItem('meet_dark_mode') === 'true';
    if (isDarkMode) {
      document.body.classList.add('dark-mode');
    }
  }

  // === AI TEXT EDITOR FIX ===
  window.toggleAssistBar = () => {
    const bar = document.getElementById('assistBar');
    bar.style.display = bar.style.display === 'flex' ? 'none' : 'flex';
  };
    
  window.applyWritingAssist = (type) => {
    let text = messageInput.value;
    if (!text.trim()) return;
    
    switch (type) {
      case 'fix':
        text = text.charAt(0).toUpperCase() + text.slice(1);
        text = text.replace(/\bi\b/g, "I")
                   .replace(/\bim\b/gi, "I'm")
                   .replace(/\bur\b/gi, "your")
                   .replace(/\bu\b/gi, "you");
        if (!/[.!?]$/.test(text.trim())) text += ".";
        break;
        
      case 'formal':
        text = text.replace(/\bhey\b/gi, "Hello")
                   .replace(/\bthx\b/gi, "thank you")
                   .replace(/\bthanks\b/gi, "thank you")
                   .replace(/\bokay\b/gi, "alright")
                   .replace(/\bok\b/gi, "alright");
        break;
        
      case 'expand':
        if (!text.includes('please') && !text.includes('thank')) {
          text += " Please let me know if you need more details.";
        }
        break;
    }
    
    messageInput.value = text;
    messageInput.style.height = 'auto';
    messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
    messageInput.focus();
  };

  // === WALLPAPER MANAGEMENT ===

  window.openWallpaperModal = () => {
    const modal = document.getElementById('wallpaperModal');
    modal.style.display = 'flex';
    
    const grid = document.getElementById('wallpaperGrid');
    grid.innerHTML = '';
    
    const uploadOption = document.createElement('div');
    uploadOption.className = 'wallpaper-upload-option';
    uploadOption.innerHTML = `
      <i class="fas fa-upload"></i>
      <span>Upload from Gallery</span>
    `;
    uploadOption.onclick = () => {
      document.getElementById('wallpaperUploadInput').click();
    };
    grid.appendChild(uploadOption);
    
    currentWallpaperPage = {};
    
    wallpaperCategories.forEach(category => {
      loadWallpaperCategoryPage(category, 0, grid);
    });
  };

  function loadWallpaperCategoryPage(category, page, grid) {
    const startIndex = page * wallpapersPerPage;
    const endIndex = startIndex + wallpapersPerPage;
    
    let categorySection = document.getElementById(`wallpaper-cat-${category}`);
    if (!categorySection) {
      categorySection = document.createElement('div');
      categorySection.id = `wallpaper-cat-${category}`;
      categorySection.className = 'wallpaper-category-section';
      
      const title = document.createElement('div');
      title.className = 'category-title';
      title.innerText = category;
      categorySection.appendChild(title);
      
      const categoryGrid = document.createElement('div');
      categoryGrid.id = `wallpaper-grid-${category}`;
      categoryGrid.className = 'wallpaper-grid-category';
      categorySection.appendChild(categoryGrid);
      
      grid.appendChild(categorySection);
    }
    
    const categoryGrid = document.getElementById(`wallpaper-grid-${category}`);
    
    if (page === 0) {
      categoryGrid.innerHTML = '';
    }
    
    for (let i = startIndex; i < endIndex; i++) {
      const div = document.createElement('div');
      div.className = 'wallpaper-thumb';
      const imgUrl = `https://picsum.photos/seed/${category}${i + 1}/400/700`;
      div.innerHTML = `<img src="${imgUrl}" loading="lazy" alt="${category} wallpaper">`;
      div.onclick = () => showWpPreview({ type: 'image', src: imgUrl });
      categoryGrid.appendChild(div);
    }
    
    const totalWallpapers = 50;
    const hasMore = endIndex < totalWallpapers;
    
    const existingButton = document.getElementById(`load-more-${category}`);
    if (existingButton) {
      existingButton.remove();
    }
    
    if (hasMore) {
      const loadMoreBtn = document.createElement('button');
      loadMoreBtn.id = `load-more-${category}`;
      loadMoreBtn.className = 'load-more-wallpapers';
      loadMoreBtn.innerHTML = '<i class="fas fa-chevron-down"></i> View More';
      loadMoreBtn.onclick = () => loadWallpaperCategoryPage(category, page + 1, grid);
      categorySection.appendChild(loadMoreBtn);
    }
  }
    
  window.showWpPreview = (wp) => {
    tempWallpaper = wp;
    const overlay = document.getElementById('wpPreviewOverlay');
    const visual = document.getElementById('wpPreviewVisual');
    
    visual.innerHTML = '';
    if (wp.type === 'image') {
      visual.innerHTML = `<img src="${wp.src}" alt="Wallpaper preview">`;
    } else {
      visual.innerHTML = `<video src="${wp.src}" autoplay loop muted></video>`;
    }
    
    overlay.style.display = 'flex';
      
    document.getElementById('wpConfirmBtn').onclick = () => {
      if (currentChatId) {
        localStorage.setItem('meet_wallpaper_' + currentChatId, JSON.stringify(tempWallpaper));
        applyWallpaper(tempWallpaper);
      }
      closeWpPreview();
      closeWallpaperModal();
    };
  };

  window.closeWpPreview = () => {
    document.getElementById('wpPreviewOverlay').style.display = 'none';
    tempWallpaper = null;
  };

  window.closeWallpaperModal = () => {
    document.getElementById('wallpaperModal').style.display = 'none';
  };

  function applyWallpaper(wp) {
    messagesContainer.style.backgroundImage = 'none';
    const existingVid = messagesContainer.querySelector('.bg-video-layer');
    if (existingVid) existingVid.remove();
      
    if (!wp) return;

    if (wp.type === 'image') {
      messagesContainer.style.backgroundImage = `url(${wp.src})`;
      messagesContainer.style.backgroundSize = 'cover';
      messagesContainer.style.backgroundPosition = 'center';
      messagesContainer.style.backgroundAttachment = 'fixed';
    } else {
      const vid = document.createElement('video');
      vid.className = 'bg-video-layer';
      vid.src = wp.src;
      vid.autoplay = true;
      vid.loop = true;
      vid.muted = true;
      vid.style.cssText = "position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:-1; opacity:0.6;";
      messagesContainer.prepend(vid);
    }
  }

  function handleWallpaperUpload(file) {
    if (!file) return;
    
    const maxSize = 50 * 1024 * 1024;
    if (file.size > maxSize) {
      showError('File size too large. Maximum size is 50MB.');
      return;
    }
    
    const tempId = 'temp-wallpaper-' + Date.now();
    const optimisticWallpaper = {
      src: URL.createObjectURL(file),
      type: file.type.startsWith('video') ? 'video' : 'image'
    };
    
    showWpPreview(optimisticWallpaper);
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', 'Meet_video');
    formData.append('resource_type', file.type.startsWith('video') ? 'video' : 'image');

    fetch(`https://api.cloudinary.com/v1_1/dcwof2ngn/upload`, {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.secure_url) {
        tempWallpaper = {
          type: file.type.startsWith('video') ? 'video' : 'image',
          src: data.secure_url
        };
        
        const previewVisual = document.getElementById('wpPreviewVisual');
        previewVisual.innerHTML = '';
        if (tempWallpaper.type === 'image') {
          previewVisual.innerHTML = `<img src="${tempWallpaper.src}" alt="Wallpaper preview">`;
        } else {
          previewVisual.innerHTML = `<video src="${tempWallpaper.src}" autoplay loop muted></video>`;
        }
      }
    })
    .catch(error => {
      console.error('Wallpaper upload error:', error);
      showError('Failed to upload wallpaper. Please try again.');
    });
  }

  // === VOICE RECORDING FUNCTIONALITY ===

  async function startVoiceRecording() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
      audioChunks = [];
      
      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          audioChunks.push(event.data);
        }
      };
      
      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        handleAudioRecording(audioBlob);
        
        // Stop all tracks
        stream.getTracks().forEach(track => track.stop());
      };
      
      mediaRecorder.onerror = (event) => {
        console.error('MediaRecorder error:', event.error);
        stopVoiceRecording();
        showError('Recording failed. Please try again.');
      };
      
      // Start recording
      mediaRecorder.start(100); // Collect data every 100ms
      isRecording = true;
      
      // Show recording UI
      messageInput.style.display = 'none';
      voiceRecordingUI.style.display = 'flex';
      voiceRecordBtn.innerHTML = '<i class="fas fa-stop"></i>';
      voiceRecordBtn.style.color = 'var(--error)';
      
      // Start timer
      recordingStartTime = Date.now();
      updateRecordingTimer();
      recordingTimer = setInterval(updateRecordingTimer, 1000);
      
    } catch (error) {
      console.error('Error accessing microphone:', error);
      showError('Cannot access microphone. Please check permissions.');
    }
  }

  function stopVoiceRecording() {
    if (mediaRecorder && isRecording) {
      mediaRecorder.stop();
      isRecording = false;
      
      // Hide recording UI
      messageInput.style.display = 'block';
      voiceRecordingUI.style.display = 'none';
      voiceRecordBtn.innerHTML = '<i class="fas fa-microphone"></i>';
      voiceRecordBtn.style.color = '';
      
      // Clear timer
      if (recordingTimer) {
        clearInterval(recordingTimer);
        recordingTimer = null;
      }
    }
  }

  function updateRecordingTimer() {
    if (!recordingStartTime) return;
    
    const elapsed = Date.now() - recordingStartTime;
    const minutes = Math.floor(elapsed / 60000);
    const seconds = Math.floor((elapsed % 60000) / 1000);
    
    voiceRecordTimer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
  }

  async function handleAudioRecording(audioBlob) {
    if (!currentChatId || audioBlob.size === 0) return;
    
    // Create audio URL for preview
    const audioUrl = URL.createObjectURL(audioBlob);
    
    // Create optimistic message
    const tempId = 'temp-voice-' + Date.now();
    const optimisticMsg = {
      mediaUrl: audioUrl,
      mediaType: 'audio',
      text: '',
      senderId: currentUser.uid,
      timestamp: null,
      isUploading: true,
      isOptimistic: true
    };
    
    const msgElement = renderMessageHTML(optimisticMsg, true, tempId);
    messagesContainer.appendChild(msgElement);
    scrollToBottom();
    
    // Prepare form data for Cloudinary
    const formData = new FormData();
    formData.append('file', audioBlob, 'voice_note.webm');
    formData.append('upload_preset', 'Meet_video');
    formData.append('resource_type', 'video'); // Cloudinary treats audio as video
    
    try {
      const response = await fetch(`https://api.cloudinary.com/v1_1/dcwof2ngn/upload`, {
        method: 'POST',
        body: formData
      });
      
      if (!response.ok) {
        throw new Error('Upload failed');
      }
      
      const data = await response.json();
      
      if (data.secure_url) {
        // Remove optimistic message
        const tempElement = document.getElementById(tempId);
        if (tempElement) tempElement.remove();
        
        // Send actual message
        await addDoc(collection(db, "conversations", currentChatId, "messages"), {
          mediaUrl: data.secure_url,
          mediaType: 'audio',
          text: '',
          senderId: currentUser.uid,
          timestamp: serverTimestamp()
        });
        
        await updateDoc(doc(db, "conversations", currentChatId), {
          lastMessage: 'Voice message',
          updatedAt: serverTimestamp()
        });
        
        // Scroll to bottom
        scrollToBottom();
      }
    } catch (error) {
      console.error('Audio upload error:', error);
      
      // Remove optimistic message
      const tempElement = document.getElementById(tempId);
      if (tempElement) tempElement.remove();
      
      showError('Failed to send voice message. Please try again.');
    }
  }

  // Setup voice recording button
  voiceRecordBtn.addEventListener('click', () => {
    if (!isRecording) {
      startVoiceRecording();
    } else {
      stopVoiceRecording();
    }
  });

  voiceRecordCancelBtn.addEventListener('click', () => {
    stopVoiceRecording();
  });

  // === FILE UPLOAD MANAGEMENT ===

  window.handleFileUpload = async (files) => {
    if (!files || !currentChatId) return;
    
    for (const file of files) {
      const maxSize = 50 * 1024 * 1024; // 50MB limit
      if (file.size > maxSize) {
        showError(`File "${file.name}" is too large. Maximum size is 50MB.`);
        continue;
      }
      
      // Determine file type
      let mediaType = 'file';
      if (file.type.startsWith('image/')) {
        mediaType = 'image';
      } else if (file.type.startsWith('video/')) {
        mediaType = 'video';
      } else if (file.type.startsWith('audio/')) {
        mediaType = 'audio';
      }
      
      const tempId = 'temp-file-' + Date.now();
      const fileUrl = URL.createObjectURL(file);
      
      // Create optimistic message
      const optimisticMsg = {
        mediaUrl: fileUrl,
        mediaType: mediaType,
        text: '',
        senderId: currentUser.uid,
        timestamp: null,
        isUploading: true,
        isOptimistic: true,
        fileName: file.name,
        fileSize: file.size
      };
      
      if (mediaType === 'file') {
        optimisticMsg.text = `File: ${file.name}`;
      }
      
      const msgElement = renderMessageHTML(optimisticMsg, true, tempId);
      messagesContainer.appendChild(msgElement);
      scrollToBottom();
      
      // Upload to Cloudinary
      const formData = new FormData();
      formData.append('file', file);
      formData.append('upload_preset', 'Meet_video');
      
      let resourceType = 'raw';
      if (mediaType === 'image') resourceType = 'image';
      else if (mediaType === 'video' || mediaType === 'audio') resourceType = 'video';
      
      formData.append('resource_type', resourceType);
      
      try {
        const response = await fetch(`https://api.cloudinary.com/v1_1/dcwof2ngn/upload`, {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) throw new Error('Upload failed');
        
        const data = await response.json();
        
        if (data.secure_url) {
          // Remove optimistic message
          const tempElement = document.getElementById(tempId);
          if (tempElement) tempElement.remove();
          
          // Send actual message
          const msgData = {
            mediaUrl: data.secure_url,
            mediaType: mediaType,
            text: mediaType === 'file' ? `File: ${file.name}` : '',
            senderId: currentUser.uid,
            timestamp: serverTimestamp()
          };
          
          if (mediaType === 'file') {
            msgData.fileName = file.name;
            msgData.fileSize = file.size;
          }
          
          await addDoc(collection(db, "conversations", currentChatId, "messages"), msgData);
          
          // Update conversation
          const lastMessageText = mediaType === 'image' ? 'Image' : 
                                 mediaType === 'video' ? 'Video' : 
                                 mediaType === 'audio' ? 'Audio' : 
                                 `File: ${file.name}`;
          
          await updateDoc(doc(db, "conversations", currentChatId), {
            lastMessage: lastMessageText,
            updatedAt: serverTimestamp()
          });
          
          scrollToBottom();
        }
      } catch (error) {
        console.error('File upload error:', error);
        
        const tempElement = document.getElementById(tempId);
        if (tempElement) tempElement.remove();
        
        showError(`Failed to upload "${file.name}". Please try again.`);
      }
    }
  };

  // === EMOJI MANAGEMENT ===

  const emojis = {
    "Smileys": ["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""],
    "Gestures": ["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""],
    "People": ["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""],
    "Animals": ["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""],
    "Food": ["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""],
    "Activities": ["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""],
    "Objects": ["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""]
  };
    
  function initEmojiPicker() {
    const nav = document.getElementById('emojiNav');
    const content = document.getElementById('emojiContent');
    
    nav.innerHTML = '';
    content.innerHTML = '';
    
    Object.keys(emojis).forEach((category, index) => {
      const btn = document.createElement('button');
      btn.innerText = emojis[category][0];
      btn.title = category;
      btn.onclick = () => {
        Array.from(nav.children).forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        
        content.innerHTML = '';
        emojis[category].forEach(emoji => {
          const emojiDiv = document.createElement('div');
          emojiDiv.className = 'emoji-item';
          emojiDiv.innerText = emoji;
          emojiDiv.title = emoji;
          emojiDiv.onclick = () => {
            messageInput.value += emoji;
            messageInput.focus();
            
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
          };
          content.appendChild(emojiDiv);
        });
      };
      
      nav.appendChild(btn);
      if (index === 0) btn.click();
    });
  }

  window.toggleEmojiPicker = () => {
    emojiPicker.style.display = emojiPicker.style.display === 'flex' ? 'none' : 'flex';
  };

  // === CORE CHAT FUNCTIONALITY ===

  window.toggleSidebar = () => {
    sidebar.classList.toggle('open');
    sidebarOverlay.classList.toggle('active');
  };

  // Helper function to scroll to bottom
  function scrollToBottom() {
    setTimeout(() => {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }, 100);
  }

  // === AUTHENTICATION AND USER MANAGEMENT ===

  onAuthStateChanged(auth, async user => {
    if (!user) {
      window.location.href = 'login.html';
    } else {
      currentUser = user;
      
      document.getElementById('logoutBtn').addEventListener('click', () => {
        if (confirm('Are you sure you want to log out?')) {
          signOut(auth);
        }
      });
      
      document.getElementById('nightToggleBtn').addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('meet_dark_mode', document.body.classList.contains('dark-mode'));
      });
      
      try {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        let photoURL = user.photoURL;
        let displayName = user.displayName;
        
        if (userDoc.exists()) {
          const userData = userDoc.data();
          if (userData.photoURL) photoURL = userData.photoURL;
          if (userData.name) displayName = userData.name;
        }
        
        navUserImg.src = photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName || 'User')}&background=0080FF&color=fff`;
        navUserName.textContent = displayName || 'User';
        
        if (!window.userNameCache) window.userNameCache = {};
        window.userNameCache[user.uid] = displayName || 'User';
        
        setupUserProfileListener();
        setupFeedNotifications();
        
      } catch (error) {
        console.error("Error loading user data:", error);
        navUserImg.src = `https://ui-avatars.com/api/?name=User&background=0080FF&color=fff`;
        navUserName.textContent = 'User';
      }
      
      loadConversations();
      loadSettings();
      initEmojiPicker();
      initializeFontSelector();
      initializeColorSelector();
      
      const savedChatId = localStorage.getItem('last_active_chat');
      if (savedChatId) {
        setTimeout(() => {
          const convItem = document.querySelector(`[data-chat-id="${savedChatId}"]`);
          if (convItem) {
            convItem.click();
          }
        }, 1000);
      }
    }
  });

  function setupUserProfileListener() {
    if (!currentUser) return;
    
    unsubscribeUserProfiles = onSnapshot(doc(db, "users", currentUser.uid), async (doc) => {
      if (doc.exists()) {
        const userData = doc.data();
        const newPhotoURL = userData.photoURL;
        const newName = userData.name || userData.displayName;
        
        if (newPhotoURL && navUserImg.src !== newPhotoURL) {
          navUserImg.src = newPhotoURL;
          
          await updateConversationAvatars(currentUser.uid, newPhotoURL);
        }
        
        if (newName && navUserName.textContent !== newName) {
          navUserName.textContent = newName;
          window.userNameCache[currentUser.uid] = newName;
        }
      }
    });
  }

  function setupFeedNotifications() {
    if (!currentUser) return;
    
    const q = query(
      collectionGroup(db, "messages"),
      where("senderId", "!=", currentUser.uid)
    );
    
    unsubscribeFeedNotifications = onSnapshot(q, (snapshot) => {
      let unreadCount = 0;
      const unreadConvs = new Set();
      
      snapshot.docChanges().forEach(change => {
        if (change.type === "added") {
          const msg = change.doc.data();
          const conversationId = change.doc.ref.parent.parent?.id;
          
          if (conversationId && msg.senderId !== currentUser.uid) {
            unreadConvs.add(conversationId);
          }
        }
      });
      
      unreadConvs.forEach(convId => {
        const lastRead = localStorage.getItem(`meet_last_read_${convId}`);
        if (!lastRead) {
          unreadCount++;
        } else {
          const lastReadTime = parseInt(lastRead);
          const convDoc = snapshot.docs.find(doc => 
            doc.ref.parent.parent?.id === convId && 
            doc.data().timestamp?.seconds * 1000 > lastReadTime
          );
          if (convDoc) {
            unreadCount++;
          }
        }
      });
      
      updateFeedNotificationBadge(unreadCount);
    });
  }

  function updateFeedNotificationBadge(count) {
    const badge = document.getElementById('feedNotificationBadge');
    if (!badge) return;
    
    if (count > 0) {
      badge.textContent = count > 99 ? '99+' : count.toString();
      badge.style.display = 'flex';
    } else {
      badge.style.display = 'none';
    }
  }

  // Enhanced conversation loading with better performance
  function loadConversations() {
    const q = query(
      collection(db, "conversations"), 
      where("participants", "array-contains", currentUser.uid)
    );
    
    unsubscribeConversations = onSnapshot(q, async (snapshot) => {
      const list = document.getElementById('conversationsList');
      list.innerHTML = '';
      
      const convs = [];
      
      // Process conversations in parallel for better performance
      const promises = snapshot.docs.map(async (doc) => {
        const conv = { id: doc.id, ...doc.data() };
        const otherId = conv.participants.find(p => p !== currentUser.uid);
        
        if (otherId) {
          const realName = await getUserDisplayName(otherId);
          conv.realName = realName;
          convs.push(conv);
        }
      });
      
      await Promise.all(promises);
      
      convs.sort((a, b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));
      
      convs.forEach(conv => {
        const otherId = conv.participants.find(p => p !== currentUser.uid);
        const name = conv.realName || conv.participantNames?.[otherId] || 'User';
        const avatar = conv.participantAvatars?.[otherId] || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=0080FF&color=fff`;
        
        const div = document.createElement('div');
        div.className = `conversation-item ${currentChatId === conv.id ? 'active' : ''}`;
        div.setAttribute('data-chat-id', conv.id);
        
        const lastRead = localStorage.getItem(`meet_last_read_${conv.id}`);
        const hasUnread = !lastRead || (conv.updatedAt?.seconds * 1000 > parseInt(lastRead) && conv.lastMessageSender !== currentUser.uid);
        
        div.innerHTML = `
          <img src="${avatar}" class="conversation-avatar" alt="${name}">
          <div class="conversation-info">
            <div class="conversation-name">${name}</div>
            <div class="conversation-preview">${conv.lastMessage || 'No messages yet'}</div>
          </div>
          ${hasUnread ? `<span class="unread-count">1</span>` : ''}
        `;
        
        div.onclick = () => {
          localStorage.setItem('last_active_chat', conv.id);
          localStorage.setItem(`meet_last_read_${conv.id}`, Date.now());
          
          openChat(conv.id, otherId, name, avatar);
          
          const unreadIndicator = div.querySelector('.unread-count');
          if (unreadIndicator) {
            unreadIndicator.remove();
          }
        };
        
        list.appendChild(div);
      });
      
      setTimeout(setupConversationLongPress, 100);
      
    }, (error) => {
      console.error("Error loading conversations:", error);
      showError("Failed to load conversations. Please refresh the page.");
    });
  }

  // Optimized chat opening with faster loading
  async function openChat(chatId, otherUserId, name, avatar) {
    try {
      if (unsubscribeMessages) {
        unsubscribeMessages();
        unsubscribeMessages = null;
      }
      
      currentChatId = null;
      messagesContainer.innerHTML = '';
      
      // Create scroll to bottom button
      createScrollToBottomButton();
      
      const convDoc = await getDoc(doc(db, "conversations", chatId));
      if (!convDoc.exists()) {
        throw new Error("Conversation not found or has been deleted");
      }

      const convData = convDoc.data();
      if (!convData.participants || !convData.participants.includes(currentUser.uid)) {
        throw new Error("You don't have access to this conversation");
      }

      currentChatId = chatId;
      currentChatUser = otherUserId;
      currentChatUserName = name;
      currentChatUserAvatar = avatar;
      
      document.getElementById('emptyChat').style.display = 'none';
      document.getElementById('chatHeader').style.display = 'flex';
      document.getElementById('messagesContainer').style.display = 'flex';
      document.getElementById('messageInputContainer').style.display = 'block';
      document.getElementById('chatUserName').innerText = name;
      document.getElementById('currentChatAvatar').src = avatar;
      
      document.getElementById('typingUserName').textContent = name;
      
      document.querySelectorAll('.conversation-item').forEach(el => el.classList.remove('active'));
      const activeItem = document.querySelector(`[data-chat-id="${chatId}"]`);
      if (activeItem) activeItem.classList.add('active');

      if (window.innerWidth <= 768) {
        document.getElementById('conversationsSidebar').style.zIndex = '10';
        document.getElementById('chatArea').classList.add('active');
      }
      
      const savedWallpaper = localStorage.getItem('meet_wallpaper_' + chatId);
      if (savedWallpaper) {
        applyWallpaper(JSON.parse(savedWallpaper));
      } else {
        messagesContainer.style.backgroundImage = 'none';
      }
      
      await loadMessages(chatId);
      
    } catch (error) {
      console.error("Error opening chat:", error);
      
      resetChatView();
      
      const problematicItem = document.querySelector(`[data-chat-id="${chatId}"]`);
      if (problematicItem) {
        problematicItem.remove();
      }
      
      showError("This conversation is unavailable. It may have been deleted or you no longer have access.");
    }
  }

  // Optimized message loading with faster performance
  function loadMessages(chatId) {
    if (unsubscribeMessages) unsubscribeMessages();
    messagesContainer.innerHTML = '';
    
    const q = query(
      collection(db, "conversations", chatId, "messages"),
      orderBy("timestamp", "asc"),
      limit(100) // Load more messages initially for better UX
    );
    
    unsubscribeMessages = onSnapshot(q, (snapshot) => {
      let lastHeader = null;
      let hasMessages = false;
      
      const fragment = document.createDocumentFragment();
      
      snapshot.docs.forEach(doc => {
        hasMessages = true;
        const msg = { id: doc.id, ...doc.data() };
        const isMe = msg.senderId === currentUser.uid;
        const currentHeader = formatDateHeader(msg.timestamp);
        
        if (currentHeader && currentHeader !== lastHeader) {
          const div = document.createElement('div');
          div.className = 'date-divider';
          div.innerHTML = `<span>${currentHeader}</span>`;
          fragment.appendChild(div);
          lastHeader = currentHeader;
        }

        const div = renderMessageHTML(msg, isMe, msg.id);
        fragment.appendChild(div);
      });
      
      messagesContainer.appendChild(fragment);
      
      if (hasMessages) {
        setTimeout(() => {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
          scrollToBottomBtn.style.display = 'none';
        }, 50);
      }
      
    }, (error) => {
      console.error("Error loading messages:", error);
      
      messagesContainer.innerHTML = `
        <div class="error-message">
          <i class="fas fa-exclamation-triangle"></i>
          <span>Failed to load messages</span>
          <button class="retry-btn" onclick="loadMessages('${chatId}')">Retry</button>
        </div>
      `;
    });
  }

  // Enhanced message sending with duplicate prevention
  document.getElementById('sendButton').addEventListener('click', sendMessage);

  async function sendMessage() {
    if (isSendingMessage) return;
    
    const text = messageInput.value.trim();
    if ((!text && !isRecording) || !currentChatId) return;
    
    isSendingMessage = true;
    const sendButton = document.getElementById('sendButton');
    const originalButtonHTML = sendButton.innerHTML;
    sendButton.innerHTML = '<div class="loading-spinner" style="width:16px;height:16px;border-width:2px;"></div>';
    sendButton.disabled = true;
    
    if (editingMsgId) {
      try {
        await updateDoc(doc(db, "conversations", currentChatId, "messages", editingMsgId), {
          text: text,
          isEdited: true,
          editedAt: serverTimestamp()
        });
        cancelReply();
      } catch (error) {
        console.error("Error editing message:", error);
        showError("Failed to edit message. Please try again.");
      } finally {
        isSendingMessage = false;
        sendButton.innerHTML = originalButtonHTML;
        sendButton.disabled = false;
      }
      return;
    }

    const originalText = text;
    messageInput.value = '';
    messageInput.style.height = '40px';

    const msgPayload = {
      text: originalText,
      senderId: currentUser.uid,
      timestamp: serverTimestamp(),
      replyTo: replyToMsg ? {
        id: replyToMsg.id,
        user: replyToMsg.user,
        text: replyToMsg.text
      } : null
    };

    cancelReply();
    
    try {
      await addDoc(collection(db, "conversations", currentChatId, "messages"), msgPayload);
      
      await updateDoc(doc(db, "conversations", currentChatId), {
        lastMessage: originalText.length > 50 ? originalText.substring(0, 50) + '...' : originalText,
        lastMessageSender: currentUser.uid,
        updatedAt: serverTimestamp()
      });
      
    } catch (error) {
      console.error("Send error:", error);
      
      messageInput.value = originalText;
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
      
      showError("Failed to send message. Please check your connection and try again.");
    } finally {
      isSendingMessage = false;
      sendButton.innerHTML = originalButtonHTML;
      sendButton.disabled = false;
    }
  }

  // Message input handling
  messageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    const newHeight = Math.min(this.scrollHeight, 120);
    this.style.height = newHeight + 'px';
  });

  // Back button for mobile
  document.getElementById('backButton').addEventListener('click', () => {
    document.getElementById('chatArea').classList.remove('active');
  });

  // === USER SEARCH FUNCTIONALITY ===

  window.openUserSearchOverlay = () => {
    document.getElementById('userSearchOverlay').style.display = 'flex';
    document.getElementById('userSearchInput').focus();
  };

  window.closeUserSearchOverlay = () => {
    document.getElementById('userSearchOverlay').style.display = 'none';
    document.getElementById('userSearchInput').value = '';
    document.getElementById('userSearchResults').innerHTML = '';
  };

  document.getElementById('userSearchInput').addEventListener('input', async (e) => {
    const term = e.target.value.toLowerCase().trim();
    const resDiv = document.getElementById('userSearchResults');
    resDiv.innerHTML = '';
    
    if (term.length < 2) {
      resDiv.innerHTML = '<div style="padding:30px; text-align:center; color:var(--secondary-text);">Type at least 2 characters to search</div>';
      return;
    }
    
    try {
      const usersQuery = query(
        collection(db, "users"),
        where("email", ">=", term),
        limit(15)
      );
      
      const snap = await getDocs(usersQuery);
      let hasResults = false;
      
      if (snap.empty) {
        resDiv.innerHTML = '<div style="padding:30px; text-align:center; color:var(--secondary-text);">No users found</div>';
        return;
      }
      
      for (const doc of snap.docs) {
        if (doc.id === currentUser.uid) continue;
        
        const userData = doc.data();
        const userName = userData.name || userData.displayName || 'User';
        const userEmail = userData.email || '';
        
        if (userName.toLowerCase().includes(term) || userEmail.toLowerCase().includes(term)) {
          hasResults = true;
          const div = document.createElement('div');
          div.className = 'search-result-item';
          div.innerHTML = `
            <img src="${userData.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=0080FF&color=fff`}" 
                 class="conversation-avatar" alt="${userName}">
            <div class="search-result-info">
              <div class="search-result-name">${userName}</div>
              <div class="search-result-email">${userEmail}</div>
            </div>
          `;
          div.onclick = () => startNewChat(doc.id, userData);
          resDiv.appendChild(div);
        }
      }
      
      if (!hasResults) {
        resDiv.innerHTML = '<div style="padding:30px; text-align:center; color:var(--secondary-text);">No users found</div>';
      }
      
    } catch (error) {
      console.error("Search error:", error);
      resDiv.innerHTML = '<div style="padding:30px; text-align:center; color:var(--error);">Error searching users</div>';
    }
  });

  async function startNewChat(otherId, otherData) {
    const participants = [currentUser.uid, otherId].sort();
    const chatId = participants.join('_');
    
    try {
      const existingConv = await getDoc(doc(db, "conversations", chatId));
      
      if (existingConv.exists()) {
        const convData = existingConv.data();
        const otherUserId = convData.participants.find(p => p !== currentUser.uid);
        const realName = convData.participantNames?.[otherUserId] || await getUserDisplayName(otherUserId);
        const avatar = convData.participantAvatars?.[otherUserId] || otherData.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(realName)}&background=0080FF&color=fff`;
        
        openChat(chatId, otherId, realName, avatar);
      } else {
        const currentUserName = navUserName.textContent;
        const otherUserName = otherData.name || otherData.displayName || 'User';
        
        await setDoc(doc(db, "conversations", chatId), {
          participants,
          participantNames: {
            [currentUser.uid]: currentUserName,
            [otherId]: otherUserName
          },
          participantAvatars: {
            [currentUser.uid]: navUserImg.src,
            [otherId]: otherData.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(otherUserName)}&background=0080FF&color=fff`
          },
          updatedAt: serverTimestamp(),
          lastMessage: '',
          createdAt: serverTimestamp()
        }, { merge: true });
        
        openChat(chatId, otherId, otherUserName, otherData.photoURL);
      }
      
      closeUserSearchOverlay();
      
    } catch (error) {
      console.error("Error starting new chat:", error);
      showError("Failed to start conversation. Please try again.");
    }
  }

  // === EVENT LISTENERS FOR CLOSING MODALS ===

  document.addEventListener('click', (e) => {
    if (!emojiPicker.contains(e.target) && !e.target.closest('.input-action')) {
      emojiPicker.style.display = 'none';
    }
  });

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.msg-options-btn') && !e.target.closest('.msg-options-menu')) {
      document.querySelectorAll('.msg-options-menu').forEach(m => m.classList.remove('active'));
    }
  });

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.conversation-item') && !e.target.closest('#conversationOptionsMenu')) {
      document.getElementById('conversationOptionsMenu').style.display = 'none';
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (document.getElementById('settingsModal').style.display === 'flex') {
        closeSettingsModal();
      }
      if (document.getElementById('userSearchOverlay').style.display === 'flex') {
        closeUserSearchOverlay();
      }
      if (document.getElementById('wallpaperModal').style.display === 'flex') {
        closeWallpaperModal();
      }
      if (document.getElementById('wpPreviewOverlay').style.display === 'flex') {
        closeWpPreview();
      }
      if (emojiPicker.style.display === 'flex') {
        emojiPicker.style.display = 'none';
      }
      if (isRecording) {
        stopVoiceRecording();
      }
    }
  });

  // === PLACEHOLDER FUNCTIONS FOR FUTURE FEATURES ===

  window.startVoiceCall = () => {
    alert("Voice call feature will be implemented in a future update!");
  };

  window.startVideoCall = () => {
    alert("Video call feature will be implemented in a future update!");
  };

  // Handle wallpaper upload from gallery
  document.getElementById('wallpaperUploadInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      handleWallpaperUpload(file);
    }
    e.target.value = '';
  });

  // === INITIALIZATION ===

  document.addEventListener('DOMContentLoaded', () => {
    console.log("MEET Chat Application initialized with enhanced features");
    
    window.addEventListener('resize', () => {
      const chatContainer = document.querySelector('.chat-container');
      if (window.innerWidth >= 1200) {
        chatContainer.style.width = '70%';
        chatContainer.style.maxWidth = '1200px';
        chatContainer.style.margin = '0 auto';
      } else {
        chatContainer.style.width = '100%';
        chatContainer.style.maxWidth = '100%';
      }
    });
  });

  // Handle page visibility changes
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && currentChatId) {
      loadMessages(currentChatId);
    }
  });

  // Handle beforeunload to clean up listeners
  window.addEventListener('beforeunload', () => {
    if (unsubscribeMessages) {
      unsubscribeMessages();
    }
    if (unsubscribeConversations) {
      unsubscribeConversations();
    }
    if (unsubscribeUserProfiles) {
      unsubscribeUserProfiles();
    }
    if (unsubscribeFeedNotifications) {
      unsubscribeFeedNotifications();
    }
    if (isRecording) {
      stopVoiceRecording();
    }
    if (currentlyPlayingAudio) {
      currentlyPlayingAudio.audio.pause();
    }
    if (audioPlayingInterval) {
      clearInterval(audioPlayingInterval);
    }
  });

</script>
</body>
  </html>
