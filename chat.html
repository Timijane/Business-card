<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MEET Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body { font-family: 'Poppins', sans-serif; margin:0; padding:0; background:#f2f2f2; }
header { background:#4b7bec; color:white; padding:15px; text-align:center; font-size:1.3em; }
.container { display:flex; height:calc(100vh - 60px); }
.sidebar { width:300px; background:white; border-right:1px solid #ccc; display:flex; flex-direction:column; }
.search-box { padding:10px; border-bottom:1px solid #ccc; }
.search-box input { width:100%; padding:8px; border-radius:4px; border:1px solid #ccc; }
.user-list { flex:1; overflow-y:auto; }
.user-item { padding:10px; border-bottom:1px solid #eee; cursor:pointer; }
.user-item:hover { background:#f0f0f0; }
.chat-area { flex:1; display:flex; flex-direction:column; background:#f9f9f9; }
.chat-header { padding:10px; border-bottom:1px solid #ccc; font-weight:600; background:white; display:flex; justify-content:space-between; align-items:center; }
.chat-messages { flex:1; padding:10px; overflow-y:auto; }
.message { margin-bottom:10px; padding:8px 12px; border-radius:15px; max-width:70%; }
.message.self { background:#4b7bec; color:white; margin-left:auto; }
.message.other { background:#e0e0e0; color:black; margin-right:auto; }
.chat-input { display:flex; padding:10px; border-top:1px solid #ccc; background:white; }
.chat-input input { flex:1; padding:8px; border-radius:20px; border:1px solid #ccc; }
.chat-input button { margin-left:10px; padding:8px 16px; border:none; background:#4b7bec; color:white; border-radius:20px; cursor:pointer; }
.toggle-container { display:flex; align-items:center; gap:5px; font-size:0.9em; }
</style>
</head>
<body>

<header>MEET Chat</header>

<div class="container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="search-box">
      <input type="text" id="searchUser" placeholder="Search by name or email...">
    </div>
    <div class="user-list" id="userList"></div>
  </div>

  <!-- Chat Area -->
  <div class="chat-area">
    <div class="chat-header">
      <span id="chatWith">Select a user to chat</span>
      <div class="toggle-container">
        <label>AI Auto-Reply</label>
        <input type="checkbox" id="aiToggle">
      </div>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="Type a message...">
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script>
  // ================================
  // Firebase Config
  // ================================
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MSG_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUser = null;
  let currentChatId = null;
  let chatUnsubscribe = null;

  // ================================
  // AUTH (Simple Anonymous Login for Demo)
  // ================================
  auth.signInAnonymously().then(() => {
    currentUser = auth.currentUser;
    console.log("Signed in as:", currentUser.uid);
  });

  // ================================
  // SEARCH USERS
  // ================================
  const searchInput = document.getElementById('searchUser');
  const userList = document.getElementById('userList');

  searchInput.addEventListener('input', async () => {
    const query = searchInput.value.toLowerCase();
    userList.innerHTML = '';
    if(query.length < 1) return;

    const snapshot = await db.collection('users')
      .where('searchIndex', 'array-contains', query)
      .get();

    snapshot.forEach(doc => {
      if(doc.id === currentUser.uid) return; // skip self
      const user = doc.data();
      const div = document.createElement('div');
      div.className = 'user-item';
      div.textContent = user.name + ' (' + user.email + ')';
      div.dataset.uid = doc.id;
      div.addEventListener('click', () => openChat(doc.id, user.name));
      userList.appendChild(div);
    });
  });

  // ================================
  // OPEN OR CREATE CHAT
  // ================================
  async function openChat(otherUid, otherName){
    document.getElementById('chatWith').textContent = otherName;
    
    // deterministic chat ID: sorted uids joined by _
    const uids = [currentUser.uid, otherUid].sort();
    currentChatId = uids.join('_');

    const chatRef = db.collection('chats').doc(currentChatId);

    const chatDoc = await chatRef.get();
    if(!chatDoc.exists){
      // create chat if doesn't exist
      await chatRef.set({
        users: uids,
        lastMessage: '',
        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
        aiAutoReply: false
      });
    }

    // Unsubscribe previous listener if exists
    if(chatUnsubscribe) chatUnsubscribe();

    // Listen to messages in real-time
    chatUnsubscribe = chatRef.collection('messages').orderBy('timestamp')
      .onSnapshot(snapshot => {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = '';
        snapshot.forEach(doc => {
          const msg = doc.data();
          const div = document.createElement('div');
          div.className = 'message ' + (msg.senderId === currentUser.uid ? 'self':'other');
          div.textContent = msg.text;
          chatMessages.appendChild(div);
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
  }

  // ================================
  // SEND MESSAGE
  // ================================
  const sendBtn = document.getElementById('sendBtn');
  const messageInput = document.getElementById('messageInput');
  const aiToggle = document.getElementById('aiToggle');

  sendBtn.addEventListener('click', async () => {
    const text = messageInput.value.trim();
    if(!text || !currentChatId) return;
    
    const chatRef = db.collection('chats').doc(currentChatId);
    const msgData = {
      senderId: currentUser.uid,
      text: text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      status: 'sent'
    };
    await chatRef.collection('messages').add(msgData);

    // Update last message
    await chatRef.update({
      lastMessage: text,
      lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
      aiAutoReply: aiToggle.checked
    });

    messageInput.value = '';

    // AI Auto-Reply demo (if enabled)
    const chatDoc = await chatRef.get();
    if(chatDoc.data().aiAutoReply && Math.random() > 0.5){ // demo random reply
      setTimeout(async ()=>{
        await chatRef.collection('messages').add({
          senderId: 'system',
          text: "Hi! I'm AI auto-replying.",
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          status: 'sent'
        });
      }, 1000);
    }
  });
</script>
</body>
</html>
