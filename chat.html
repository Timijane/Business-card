<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MEET | Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://unpkg.com/picmo@latest/dist/umd/index.js"></script>
<style>
  :root {
    --primary: #0080FF;
    --primary-dark: #0066CC;
    --bg-color: #f0f2f5;
    --card-bg: #fff;
    --text-color: #111;
    --secondary-text: #65676b;
    --border-color: #dddfe2;
    --online: #10B981;
    --offline: #EF4444;
    --ai-color: #8A2BE2;
  }

  body.dark-mode {
    --bg-color: #18191a;
    --card-bg: #242526;
    --text-color: #e4e6eb;
    --secondary-text: #b0b3b8;
    --border-color: #3e4042;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { font-family: 'Poppins', sans-serif; background: var(--bg-color); color: var(--text-color); height: 100dvh; overflow: hidden; }

  .app-container { display: flex; height: 100%; }

  /* 1. RESTORED SIDEBAR MENU */
  .sidebar {
    width: 250px; background: linear-gradient(180deg, #0080FF 0%, #00C6FF 100%);
    display: flex; flex-direction: column; padding: 20px; color: white; flex-shrink: 0;
  }
  .sidebar h2 { margin-bottom: 30px; font-size: 24px; font-weight: 700; }
  .sidebar ul { list-style: none; }
  .sidebar li { margin-bottom: 10px; }
  .sidebar a {
    display: flex; align-items: center; color: white; text-decoration: none;
    padding: 10px; border-radius: 8px; transition: background 0.2s; font-size: 16px;
  }
  .sidebar a:hover, .sidebar a.active { background: rgba(255,255,255,0.2); }
  .sidebar i { width: 25px; margin-right: 10px; text-align: center; }

  /* MAIN CHAT LAYOUT */
  .chat-interface { flex: 1; display: flex; overflow: hidden; background: var(--bg-color); }

  /* CONVERSATIONS LIST */
  .conversations-sidebar {
    width: 320px; background: var(--card-bg); border-right: 1px solid var(--border-color);
    display: flex; flex-direction: column; flex-shrink: 0;
  }
  .search-container { padding: 15px; border-bottom: 1px solid var(--border-color); }
  .search-input {
    width: 100%; padding: 10px; border-radius: 20px; border: 1px solid var(--border-color);
    background: var(--bg-color); color: var(--text-color); outline: none;
  }
  .new-chat-btn {
    float: right; background: var(--primary); color: white; border: none;
    width: 30px; height: 30px; border-radius: 50%; cursor: pointer; margin-bottom: 10px;
  }
  .conversations-list { flex: 1; overflow-y: auto; }
  
  .conversation-item {
    display: flex; align-items: center; padding: 15px; cursor: pointer;
    border-bottom: 1px solid var(--border-color); position: relative;
  }
  .conversation-item:hover, .conversation-item.active { background: rgba(0,128,255,0.05); }
  
  .avatar-container { position: relative; margin-right: 12px; }
  .conv-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; }
  
  /* 8. REAL TIME ONLINE/OFFLINE STATUS */
  .status-dot {
    position: absolute; bottom: 0; right: 0; width: 12px; height: 12px;
    border-radius: 50%; border: 2px solid var(--card-bg);
  }
  .is-online { background-color: var(--online); }
  .is-offline { background-color: var(--offline); }

  .conv-info { flex: 1; min-width: 0; }
  .conv-name { font-weight: 600; font-size: 15px; }
  .conv-preview { font-size: 13px; color: var(--secondary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* CHAT AREA */
  .chat-area {
    flex: 1; display: flex; flex-direction: column; position: relative; background-size: cover; background-position: center;
    background-color: var(--bg-color); /* Fallback */
  }

  /* 2. HEADER RESTORATION */
  .chat-header {
    height: 60px; background: var(--card-bg); border-bottom: 1px solid var(--border-color);
    display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
    flex-shrink: 0;
  }
  .chat-header-user { display: flex; align-items: center; gap: 10px; }
  .header-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
  .header-actions button {
    background: none; border: none; color: var(--primary); font-size: 18px;
    margin-left: 15px; cursor: pointer; padding: 5px;
  }

  /* MESSAGES */
  .messages-wrapper { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
  
  .message { display: flex; gap: 10px; max-width: 70%; position: relative; }
  .message.sent { align-self: flex-end; flex-direction: row-reverse; }
  
  /* 6. SENDER/RECEIVER PICTURES */
  .msg-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; align-self: flex-end; }
  
  .message-bubble {
    padding: 10px 14px; border-radius: 18px; font-size: 14px; position: relative;
    word-wrap: break-word; line-height: 1.4;
  }
  .received .message-bubble { background: var(--card-bg); border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
  .sent .message-bubble { background: var(--primary); color: white; border-bottom-right-radius: 4px; }
  
  .msg-image { max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; }

  /* 3. EDIT MESSAGE ACTIONS */
  .message:hover .msg-actions { opacity: 1; }
  .msg-actions {
    position: absolute; top: -20px; right: 0; opacity: 0; transition: opacity 0.2s;
    background: var(--card-bg); padding: 2px 8px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  .sent .msg-actions { left: 0; right: auto; }
  .msg-actions i { font-size: 12px; margin: 0 5px; cursor: pointer; color: var(--secondary-text); }
  .msg-actions i:hover { color: var(--primary); }

  /* INPUT AREA */
  .input-area {
    padding: 10px 15px; background: var(--card-bg); border-top: 1px solid var(--border-color);
  }
  
  /* 2. AI SWITCH & 4. ICONS */
  .input-controls { display: flex; align-items: center; gap: 10px; }
  
  /* Toggle Switch Style */
  .ai-switch-container { display: flex; align-items: center; gap: 5px; margin-right: 5px; }
  .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: #ccc; transition: .4s; border-radius: 34px;
  }
  .slider:before {
    position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px;
    background-color: white; transition: .4s; border-radius: 50%;
  }
  input:checked + .slider { background-color: var(--ai-color); }
  input:checked + .slider:before { transform: translateX(14px); }
  
  .input-icon-btn { background: none; border: none; font-size: 20px; color: var(--secondary-text); cursor: pointer; padding: 5px; }
  .input-icon-btn:hover { color: var(--primary); }

  .message-input {
    flex: 1; padding: 10px 15px; border-radius: 20px; border: 1px solid var(--border-color);
    background: var(--bg-color); outline: none; margin: 0 10px; resize: none; height: 44px; color: var(--text-color);
  }
  
  .send-btn { background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }

  /* 7. WALLPAPER SETTINGS MODAL */
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
  .modal-content { background: var(--card-bg); padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; }
  .wallpaper-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
  .wallpaper-option {
    height: 80px; border-radius: 8px; cursor: pointer; border: 2px solid transparent;
    display: flex; align-items: center; justify-content: center; font-weight: bold; color: rgba(255,255,255,0.8); text-shadow: 1px 1px 2px black;
  }
  .wallpaper-option:hover { border-color: var(--primary); }

  #emojiContainer { position: absolute; bottom: 70px; left: 20px; z-index: 100; display: none; }
  
  .edit-indicator { font-size: 10px; font-style: italic; opacity: 0.7; display: block; text-align: right; }

  @media (max-width: 768px) {
    .sidebar { display: none; }
    .conversations-sidebar { width: 100%; }
    .chat-area { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; }
    .chat-area.active { display: flex; }
    .back-btn { display: inline-block !important; margin-right: 10px; }
  }
  .back-btn { display: none; background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-color); }
</style>
</head>
<body>

<div class="app-container">
  <div class="sidebar">
    <h2>MEET</h2>
    <ul>
      <li><a href="feed.html"><i class="fas fa-home"></i> Feed</a></li>
      <li><a href="chat.html" class="active"><i class="fas fa-comment"></i> Chat</a></li>
      <li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
      <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
    </ul>
  </div>

  <div class="chat-interface">
    <div class="conversations-sidebar" id="convSidebar">
      <div class="search-container">
        <button class="new-chat-btn" onclick="openUserSearch()"><i class="fas fa-plus"></i></button>
        <h3 style="margin-bottom:10px">Messages</h3>
        <input type="text" class="search-input" id="chatSearch" placeholder="Search chats...">
      </div>
      <div class="conversations-list" id="conversationsList">
        </div>
    </div>

    <div class="chat-area" id="chatArea">
      <div id="emptyState" style="flex:1; display:flex; align-items:center; justify-content:center; color:#888;">
        <div>
          <i class="fas fa-comments" style="font-size:50px; display:block; text-align:center; margin-bottom:10px;"></i>
          <p>Select a chat to start messaging</p>
        </div>
      </div>

      <div class="chat-header" id="chatHeader" style="display:none;">
        <div class="chat-header-user">
          <button class="back-btn" onclick="closeChat()"><i class="fas fa-arrow-left"></i></button>
          <img src="" class="header-avatar" id="headerAvatar">
          <span style="font-weight:600;" id="headerName">User</span>
        </div>
        <div class="header-actions">
          <button title="Voice Call"><i class="fas fa-phone"></i></button>
          <button title="Video Call"><i class="fas fa-video"></i></button>
          <button title="Wallpaper Settings" onclick="openWallpaperModal()"><i class="fas fa-cog"></i></button>
        </div>
      </div>

      <div class="messages-wrapper" id="messagesWrapper" style="display:none;"></div>

      <div id="emojiContainer"></div>

      <div class="input-area" id="inputArea" style="display:none;">
        <div id="editPreview" style="display:none; background:#eee; padding:5px 10px; margin-bottom:5px; border-radius:5px; font-size:12px; justify-content:space-between;">
           <span>Editing message...</span> <i class="fas fa-times" style="cursor:pointer;" onclick="cancelEdit()"></i>
        </div>

        <div class="input-controls">
          <div class="ai-switch-container" title="AI Auto-Reply">
             <label class="switch">
               <input type="checkbox" id="aiToggle">
               <span class="slider"></span>
             </label>
             <i class="fas fa-robot" style="font-size:14px; color:var(--ai-color);"></i>
          </div>

          <button class="input-icon-btn" onclick="toggleEmoji()"><i class="far fa-smile"></i></button>
          
          <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="handleImageUpload(this)">
          <button class="input-icon-btn" onclick="document.getElementById('imageInput').click()"><i class="far fa-image"></i></button>
          
          <button class="input-icon-btn" title="Voice Note"><i class="fas fa-microphone"></i></button>

          <textarea class="message-input" id="messageInput" placeholder="Type a message..."></textarea>
          <button class="send-btn" id="sendBtn"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="wallpaperModal">
  <div class="modal-content">
    <h3>Chat Wallpaper</h3>
    <div class="wallpaper-grid">
       <div class="wallpaper-option" style="background: linear-gradient(135deg, #0080FF, #00C6FF);" onclick="setWallpaper('linear-gradient(135deg, #0080FF, #00C6FF)')">MEET Blue</div>
       <div class="wallpaper-option" style="background: #242526;" onclick="setWallpaper('#242526')">Dark</div>
       <div class="wallpaper-option" style="background: #f0f2f5;" onclick="setWallpaper('#f0f2f5')">Light</div>
       <div class="wallpaper-option" style="background: radial-gradient(circle, #8A2BE2, #4B0082);" onclick="setWallpaper('radial-gradient(circle, #8A2BE2, #4B0082)')">MEET AI</div>
    </div>
    <button onclick="document.getElementById('wallpaperModal').style.display='none'" style="margin-top:15px; width:100%; padding:10px; background:var(--primary); color:white; border:none; border-radius:6px;">Close</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDoc, getDocs, onSnapshot, serverTimestamp, query, orderBy, where, setDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDtqM_pMGIYkUgy0OWGsQbfS9MtYQhrgZM",
    authDomain: "meet-6e159.firebaseapp.com",
    databaseURL: "https://meet-6e159-default-rtdb.firebaseio.com",
    projectId: "meet-6e159",
    storageBucket: "meet-6e159.firebasestorage.app",
    messagingSenderId: "252353608421",
    appId: "1:252353608421:web:6706056048e9a8f12db20c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  
  // Cloudinary Config
  const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/dcwof2ngn/upload`;
  const CLOUDINARY_PRESET = 'Meet_video';

  let currentUser = null;
  let currentChatId = null;
  let editingMessageId = null;
  let picker = null;

  // Init Emoji
  const emojiContainer = document.getElementById('emojiContainer');
  picker = picmo.createPicker({ rootElement: emojiContainer });
  picker.addEventListener('emoji:select', selection => {
    document.getElementById('messageInput').value += selection.emoji;
    emojiContainer.style.display = 'none';
  });
  window.toggleEmoji = () => {
      emojiContainer.style.display = emojiContainer.style.display === 'block' ? 'none' : 'block';
  }

  // Auth & Load
  onAuthStateChanged(auth, user => {
    if(!user) window.location.href = 'login.html';
    else {
        currentUser = user;
        loadConversations();
        updateUserStatus(true);
        // Load saved wallpaper
        const savedWP = localStorage.getItem('meet_wallpaper');
        if(savedWP) document.getElementById('chatArea').style.background = savedWP;
    }
  });

  // Load Conversations
  function loadConversations() {
    const q = query(collection(db, "conversations"), where("participants", "array-contains", currentUser.uid));
    onSnapshot(q, snap => {
        const list = document.getElementById('conversationsList');
        list.innerHTML = '';
        snap.forEach(d => {
            const chat = { id: d.id, ...d.data() };
            const otherId = chat.participants.find(id => id !== currentUser.uid);
            const name = chat.participantNames?.[otherId] || 'User';
            const avatar = chat.participantAvatars?.[otherId] || 'https://via.placeholder.com/50';
            
            // 8. ONLINE STATUS CHECK (Logic: < 2 mins inactive = online)
            const status = chat.status?.[otherId];
            let isOnline = false;
            if(status && status.lastActive) {
                const diff = (new Date() - status.lastActive.toDate()) / 1000;
                isOnline = diff < 120; // 2 mins
            }
            if(status?.isOnline) isOnline = true; // Realtime override

            const item = document.createElement('div');
            item.className = `conversation-item ${currentChatId === chat.id ? 'active' : ''}`;
            item.onclick = () => loadChat(chat.id, otherId, name, avatar);
            item.innerHTML = `
                <div class="avatar-container">
                    <img src="${avatar}" class="conv-avatar">
                    <div class="status-dot ${isOnline ? 'is-online' : 'is-offline'}"></div>
                </div>
                <div class="conv-info">
                    <div class="conv-name">${name}</div>
                    <div class="conv-preview">${chat.lastMessage || ''}</div>
                </div>
            `;
            list.appendChild(item);
        });
    });
  }

  // Load Chat
  window.loadChat = (chatId, userId, name, avatar) => {
      currentChatId = chatId;
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('chatHeader').style.display = 'flex';
      document.getElementById('messagesWrapper').style.display = 'flex';
      document.getElementById('inputArea').style.display = 'block';
      document.getElementById('chatArea').classList.add('active'); // Mobile

      document.getElementById('headerAvatar').src = avatar;
      document.getElementById('headerName').innerText = name;

      loadMessages(chatId);
  }

  function loadMessages(chatId) {
      const q = query(collection(db, "conversations", chatId, "messages"), orderBy("timestamp", "asc"));
      onSnapshot(q, snap => {
          const wrapper = document.getElementById('messagesWrapper');
          wrapper.innerHTML = '';
          snap.forEach(d => {
              const msg = { id: d.id, ...d.data() };
              const isMe = msg.senderId === currentUser.uid;
              
              // 6. AVATARS FOR BOTH SENDER & RECEIVER
              // Logic: If Me, use my auth photo. If them, use header photo.
              const avatarSrc = isMe ? (currentUser.photoURL || 'https://via.placeholder.com/50') : document.getElementById('headerAvatar').src;

              const div = document.createElement('div');
              div.className = `message ${isMe ? 'sent' : 'received'}`;
              
              // 3. EDIT ACTIONS
              let actions = '';
              if(isMe && msg.type === 'text') {
                  actions = `<div class="msg-actions">
                                <i class="fas fa-edit" onclick="startEdit('${msg.id}', '${msg.text.replace(/'/g, "\\'")}')"></i>
                                <i class="fas fa-trash" onclick="deleteMsg('${msg.id}')"></i>
                             </div>`;
              }

              let content = msg.text || '';
              if(msg.imageUrl) content = `<img src="${msg.imageUrl}" class="msg-image" onclick="window.open(this.src)">`;
              if(msg.isAI) content += `<br><small style="opacity:0.6; font-size:10px;">...written by AI</small>`;
              if(msg.edited) content += `<span class="edit-indicator">(edited)</span>`;

              div.innerHTML = `
                  <img src="${avatarSrc}" class="msg-avatar">
                  <div class="message-bubble">
                      ${content}
                      ${actions}
                  </div>
              `;
              wrapper.appendChild(div);
          });
          wrapper.scrollTop = wrapper.scrollHeight;
      });
  }

  // Send Message
  document.getElementById('sendBtn').onclick = sendMessage;
  async function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      const isAI = document.getElementById('aiToggle').checked;

      if(!text && !editingMessageId) return;

      if(editingMessageId) {
          // Update
          await updateDoc(doc(db, "conversations", currentChatId, "messages", editingMessageId), {
              text: text, edited: true
          });
          cancelEdit();
      } else {
          // New Message
          await addDoc(collection(db, "conversations", currentChatId, "messages"), {
              text: text,
              senderId: currentUser.uid,
              timestamp: serverTimestamp(),
              type: 'text'
          });
          
          await updateDoc(doc(db, "conversations", currentChatId), {
              lastMessage: text,
              updatedAt: serverTimestamp()
          });

          // AI Logic
          if(isAI) {
              setTimeout(async () => {
                 await addDoc(collection(db, "conversations", currentChatId, "messages"), {
                      text: "I am currently away, but I will get back to you soon!",
                      senderId: currentUser.uid,
                      timestamp: serverTimestamp(),
                      isAI: true,
                      type: 'text'
                  });
              }, 2000);
          }
      }
      input.value = '';
  }

  // 5. IMAGE UPLOAD
  window.handleImageUpload = async (input) => {
      const file = input.files[0];
      if(!file) return;
      
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", CLOUDINARY_PRESET);
      
      try {
          // Placeholder
          document.getElementById('messageInput').value = "Uploading image...";
          
          const res = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
          const data = await res.json();
          
          await addDoc(collection(db, "conversations", currentChatId, "messages"), {
              imageUrl: data.secure_url,
              senderId: currentUser.uid,
              timestamp: serverTimestamp(),
              type: 'image'
          });
          
          await updateDoc(doc(db, "conversations", currentChatId), {
              lastMessage: 'Sent an image',
              updatedAt: serverTimestamp()
          });
          
          document.getElementById('messageInput').value = "";
      } catch(e) { console.error(e); alert("Upload failed"); }
  }

  // 3. EDIT LOGIC
  window.startEdit = (id, text) => {
      editingMessageId = id;
      document.getElementById('messageInput').value = text;
      document.getElementById('editPreview').style.display = 'flex';
      document.getElementById('messageInput').focus();
  }
  window.cancelEdit = () => {
      editingMessageId = null;
      document.getElementById('messageInput').value = '';
      document.getElementById('editPreview').style.display = 'none';
  }
  window.deleteMsg = async (id) => {
      if(confirm('Delete message?')) await deleteDoc(doc(db, "conversations", currentChatId, "messages", id));
  }

  // 7. WALLPAPER SETTINGS
  window.openWallpaperModal = () => document.getElementById('wallpaperModal').style.display = 'flex';
  window.setWallpaper = (val) => {
      document.getElementById('chatArea').style.background = val;
      localStorage.setItem('meet_wallpaper', val);
      document.getElementById('wallpaperModal').style.display = 'none';
  }

  // Utils
  window.closeChat = () => document.getElementById('chatArea').classList.remove('active');
  document.getElementById('logoutBtn').onclick = () => signOut(auth);
  
  async function updateUserStatus(isOnline) {
    if (!auth.currentUser) return;
    try {
        await updateDoc(doc(db, "users", auth.currentUser.uid), { isOnline: isOnline, lastActive: serverTimestamp() });
    } catch (e) {}
  }
</script>
</body>
</html>
