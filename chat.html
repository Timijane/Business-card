<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MEET Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background: #f0f2f5; }
    .container { display: flex; height: 100vh; }
    .sidebar { width: 300px; background: #fff; border-right: 1px solid #ccc; display: flex; flex-direction: column; }
    .search-box { padding: 10px; }
    .search-box input { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
    .users-list { flex: 1; overflow-y: auto; }
    .user-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
    .user-item:hover { background: #f9f9f9; }
    .chat-area { flex: 1; display: flex; flex-direction: column; }
    .messages { flex: 1; padding: 10px; overflow-y: auto; }
    .message { margin-bottom: 10px; max-width: 60%; padding: 8px 12px; border-radius: 15px; }
    .message.sent { background: #dcf8c6; align-self: flex-end; }
    .message.received { background: #fff; align-self: flex-start; }
    .input-area { display: flex; padding: 10px; border-top: 1px solid #ccc; }
    .input-area input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ccc; }
    .input-area button { margin-left: 10px; padding: 10px 15px; border-radius: 50%; border: none; background: #007bff; color: #fff; cursor: pointer; }
  </style>
</head>
<body>
<div class="container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="search-box">
      <input type="text" id="searchUser" placeholder="Search by name or email">
    </div>
    <div class="users-list" id="usersList"></div>
  </div>

  <!-- Chat area -->
  <div class="chat-area">
    <div class="messages" id="messages"></div>
    <div class="input-area">
      <input type="text" id="messageInput" placeholder="Type a message">
      <button id="sendBtn">Send</button>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.2/firebase-app.js";
  import { getFirestore, collection, doc, setDoc, getDoc, addDoc, query, where, getDocs, onSnapshot, updateDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.6.2/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.6.2/firebase-auth.js";

  // ---------------------------
  // Firebase config
  // ---------------------------
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // ---------------------------
  // Global variables
  // ---------------------------
  let currentUser = null;
  let currentChatId = null;
  let chatUnsubscribe = null;
  let chatPartner = null;

  // ---------------------------
  // Authentication (demo login)
  // ---------------------------
  async function demoLogin() {
    // Replace with your own login method
    const email = prompt("Enter your email:");
    const password = prompt("Enter your password:");
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    currentUser = userCredential.user;
    console.log("Logged in as:", currentUser.uid);
  }

  await demoLogin();

  // ---------------------------
  // Search Users
  // ---------------------------
  const searchInput = document.getElementById("searchUser");
  const usersList = document.getElementById("usersList");

  searchInput.addEventListener("input", async () => {
    const searchText = searchInput.value.toLowerCase().trim();
    usersList.innerHTML = "";

    if(searchText.length === 0) return;

    const usersRef = collection(db, "users");
    const qName = query(usersRef, where("name_lower", ">=", searchText), where("name_lower", "<=", searchText + "\uf8ff"));
    const qEmail = query(usersRef, where("email_lower", ">=", searchText), where("email_lower", "<=", searchText + "\uf8ff"));

    const resultsName = await getDocs(qName);
    const resultsEmail = await getDocs(qEmail);

    const combinedResults = new Map();
    resultsName.forEach(doc => combinedResults.set(doc.id, doc.data()));
    resultsEmail.forEach(doc => combinedResults.set(doc.id, doc.data()));

    combinedResults.forEach((user, uid) => {
      if(uid !== currentUser.uid) {
        const div = document.createElement("div");
        div.className = "user-item";
        div.textContent = user.name + " (" + user.email + ")";
        div.onclick = () => openChat(uid, user);
        usersList.appendChild(div);
      }
    });
  });

  // ---------------------------
  // Open 1-to-1 chat
  // ---------------------------
  async function openChat(uid, user) {
    chatPartner = user;
    const ids = [currentUser.uid, uid].sort();
    currentChatId = ids.join("_");

    const chatDoc = doc(db, "chats", currentChatId);
    const chatSnap = await getDoc(chatDoc);

    if(!chatSnap.exists()) {
      await setDoc(chatDoc, {
        users: ids,
        createdAt: serverTimestamp()
      });
    }

    if(chatUnsubscribe) chatUnsubscribe(); // Unsubscribe previous listener
    loadMessages();
  }

  // ---------------------------
  // Load messages in real-time
  // ---------------------------
  const messagesDiv = document.getElementById("messages");

  function loadMessages() {
    const messagesRef = collection(db, "chats", currentChatId, "messages");
    chatUnsubscribe = onSnapshot(messagesRef, snapshot => {
      messagesDiv.innerHTML = "";
      snapshot.docs.sort((a,b) => a.data().timestamp?.toMillis() - b.data().timestamp?.toMillis())
        .forEach(doc => {
          const msg = doc.data();
          const div = document.createElement("div");
          div.className = "message " + (msg.senderId === currentUser.uid ? "sent" : "received");
          div.textContent = msg.text;
          messagesDiv.appendChild(div);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
    });
  }

  // ---------------------------
  // Send message
  // ---------------------------
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");

  sendBtn.addEventListener("click", async () => {
    const text = messageInput.value.trim();
    if(!text || !currentChatId) return;

    const messagesRef = collection(db, "chats", currentChatId, "messages");
    await addDoc(messagesRef, {
      senderId: currentUser.uid,
      text,
      status: "sent",
      timestamp: serverTimestamp()
    });

    messageInput.value = "";

    // AI Auto-reply (if partner offline)
    const partnerDoc = await getDoc(doc(db, "users", chatPartner.uid));
    if(partnerDoc.exists()) {
      const isOffline = !partnerDoc.data().online; // assuming online status in user doc
      const autoReplyEnabled = partnerDoc.data().aiAutoReply; // toggle switch in user doc
      if(isOffline && autoReplyEnabled) {
        await addDoc(messagesRef, {
          senderId: "system",
          text: "Hi! This is an AI auto-reply because the user is offline.",
          status: "sent",
          timestamp: serverTimestamp()
        });
      }
    }
  });

  messageInput.addEventListener("keyup", (e) => {
    if(e.key === "Enter") sendBtn.click();
  });

</script>
</body>
</html>
