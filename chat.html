<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MEET Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; margin: 0; padding: 0; background: #f0f2f5; }
.container { display: flex; height: 100vh; }
.sidebar { width: 320px; background: #fff; border-right: 1px solid #ccc; display: flex; flex-direction: column; }
.menu-bar { height: 60px; background: #007bff; color: #fff; display: flex; align-items: center; padding: 0 15px; font-weight: 600; justify-content: space-between; }
.menu-bar .profile { cursor: pointer; }
.search-box { padding: 10px; }
.search-box input { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
.users-list { flex: 1; overflow-y: auto; }
.user-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; display: flex; flex-direction: column; }
.user-item:hover { background: #f9f9f9; }
.user-item .name { font-weight: 600; }
.user-item .last-msg { font-size: 12px; color: #555; }
.user-item .timestamp { font-size: 10px; color: #999; align-self: flex-end; }
.chat-area { flex: 1; display: flex; flex-direction: column; background: #e5ddd5; }
.chat-header { height: 60px; background: #fff; display: flex; align-items: center; padding: 0 15px; border-bottom: 1px solid #ccc; font-weight: 600; }
.messages { flex: 1; padding: 10px; overflow-y: auto; display: flex; flex-direction: column; }
.message { margin-bottom: 10px; max-width: 60%; padding: 8px 12px; border-radius: 15px; position: relative; word-break: break-word; }
.message.sent { background: #dcf8c6; align-self: flex-end; }
.message.received { background: #fff; align-self: flex-start; }
.message .time { font-size: 10px; color: #555; position: absolute; bottom: 2px; right: 8px; }
.message.seen::after { content: '✓✓'; font-size: 10px; color: blue; margin-left: 3px; }
.input-area { display: flex; padding: 10px; border-top: 1px solid #ccc; background: #fff; }
.input-area input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ccc; }
.input-area button { margin-left: 10px; padding: 10px 15px; border-radius: 50%; border: none; background: #007bff; color: #fff; cursor: pointer; }
.typing-indicator { font-size: 12px; color: #555; padding-left: 10px; }
</style>
</head>
<body>

<div class="container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="menu-bar">
      <div class="profile">MEET</div>
      <div class="menu">☰</div>
    </div>
    <div class="search-box">
      <input type="text" id="searchUser" placeholder="Search by name or email">
    </div>
    <div class="users-list" id="usersList"></div>
  </div>

  <!-- Chat Area -->
  <div class="chat-area">
    <div class="chat-header" id="chatHeader">Select a user to chat</div>
    <div class="typing-indicator" id="typingIndicator"></div>
    <div class="messages" id="messages"></div>
    <div class="input-area">
      <input type="text" id="messageInput" placeholder="Type a message">
      <button id="sendBtn">➤</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.2/firebase-app.js";
import { getFirestore, collection, doc, setDoc, getDoc, addDoc, query, where, getDocs, onSnapshot, updateDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.6.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.6.2/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;
let currentChatId = null;
let chatUnsubscribe = null;
let chatPartner = null;

// Demo login (replace with your auth)
async function demoLogin() {
  const email = prompt("Enter email:");
  const password = prompt("Enter password:");
  const userCredential = await signInWithEmailAndPassword(auth, email, password);
  currentUser = userCredential.user;
  console.log("Logged in:", currentUser.uid);
}
await demoLogin();

// Elements
const searchInput = document.getElementById("searchUser");
const usersList = document.getElementById("usersList");
const messagesDiv = document.getElementById("messages");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const chatHeader = document.getElementById("chatHeader");
const typingIndicator = document.getElementById("typingIndicator");

// Search users
searchInput.addEventListener("input", async () => {
  const searchText = searchInput.value.toLowerCase().trim();
  usersList.innerHTML = "";
  if(!searchText) return;

  const usersRef = collection(db, "users");

  // Search by name or email
  const qName = query(usersRef, where("name_lower", ">=", searchText), where("name_lower", "<=", searchText+"\uf8ff"));
  const qEmail = query(usersRef, where("email_lower", ">=", searchText), where("email_lower", "<=", searchText+"\uf8ff"));

  const resultsName = await getDocs(qName);
  const resultsEmail = await getDocs(qEmail);

  const combined = new Map();
  resultsName.forEach(doc => combined.set(doc.id, doc.data()));
  resultsEmail.forEach(doc => combined.set(doc.id, doc.data()));

  combined.forEach((user, uid) => {
    if(uid !== currentUser.uid) {
      const div = document.createElement("div");
      div.className = "user-item";
      div.innerHTML = `<span class="name">${user.name}</span>
                       <span class="last-msg">${user.lastMessage || ''}</span>
                       <span class="timestamp">${user.lastMessageTime ? new Date(user.lastMessageTime.seconds*1000).toLocaleTimeString() : ''}</span>`;
      div.onclick = () => openChat(uid, user);
      usersList.appendChild(div);
    }
  });
});

// Open chat
async function openChat(uid, user) {
  chatPartner = user;
  chatHeader.textContent = user.name;
  const ids = [currentUser.uid, uid].sort();
  currentChatId = ids.join("_");

  const chatDoc = doc(db, "chats", currentChatId);
  const chatSnap = await getDoc(chatDoc);
  if(!chatSnap.exists()) {
    await setDoc(chatDoc, { users: ids, createdAt: serverTimestamp(), lastMessage: "", lastMessageTime: null });
  }

  if(chatUnsubscribe) chatUnsubscribe();
  loadMessages();
}

// Load messages
function loadMessages() {
  const messagesRef = collection(db, "chats", currentChatId, "messages");
  chatUnsubscribe = onSnapshot(query(messagesRef, orderBy("timestamp")), snapshot => {
    messagesDiv.innerHTML = "";
    snapshot.docs.forEach(doc => {
      const msg = doc.data();
      const div = document.createElement("div");
      div.className = "message " + (msg.senderId === currentUser.uid ? "sent" : "received");
      div.textContent = msg.text;
      const time = document.createElement("span");
      time.className = "time";
      time.textContent = msg.timestamp ? new Date(msg.timestamp.seconds*1000).toLocaleTimeString() : '';
      div.appendChild(time);
      if(msg.status === "seen") div.classList.add("seen");
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  });
}

// Send message
sendBtn.addEventListener("click", async () => {
  const text = messageInput.value.trim();
  if(!text || !currentChatId) return;

  const messagesRef = collection(db, "chats", currentChatId, "messages");
  await addDoc(messagesRef, { senderId: currentUser.uid, text, status: "sent", timestamp: serverTimestamp() });
  await updateLastMessage(text);
  messageInput.value = "";

  // AI Auto-reply if offline
  const partnerDoc = await getDoc(doc(db, "users", chatPartner.uid));
  if(partnerDoc.exists()) {
    const isOffline = !partnerDoc.data().online;
    const autoReplyEnabled = partnerDoc.data().aiAutoReply;
    if(isOffline && autoReplyEnabled) {
      await addDoc(messagesRef, {
        senderId: "system",
        text: "Hi! This is an AI auto-reply because the user is offline.",
        status: "sent",
        timestamp: serverTimestamp()
      });
    }
  }
});

messageInput.addEventListener("keyup", (e) => { if(e.key==="Enter") sendBtn.click(); });

// Update last message
async function updateLastMessage(text) {
  const chatDoc = doc(db, "chats", currentChatId);
  await updateDoc(chatDoc, {
    lastMessage: text,
    lastMessageTime: serverTimestamp()
  });
}

</script>
</body>
</html>
